<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18826 Exposing Curve Output Types for Better Trait Accessibility in Bevy Math
        
    </title><meta content="#18826 Exposing Curve Output Types for Better Trait Accessibility in Bevy Math" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-04/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-04-14</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-04/pr-18826-zh-cn-20250414>中文</a></div></div><div class=pr-content><h1 id=title-exposing-curve-output-types-for-better-trait-accessibility-in-bevy-math>Title: Exposing Curve Output Types for Better Trait Accessibility in Bevy Math</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Expose the output curve type in with_derivative<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18826<li><strong>Author</strong>: mweatherley<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, D-Trivial, C-Usability, S-Ready-For-Final-Review, A-Math<li><strong>Created</strong>: 2025-04-13T00:52:45Z<li><strong>Merged</strong>: 2025-04-14T20:40:45Z<li><strong>Merged By</strong>: cart</ul><h2 id=description-translation>Description Translation</h2><p><strong>Objective</strong><br> I was wrong about how RPITIT works when I wrote this stuff initially, and in order to actually give people access to all the traits implemented by the output (e.g. Debug and so on) it’s important to expose the real output type, even if it makes the trait uglier and less comprehensible. (☹️)<p><strong>Solution</strong><br> Expose the curve output type of the <code>CurveWithDerivative</code> trait and its double-derivative companion. I also added a bunch of trait derives to <code>WithDerivative&LTT></code>, since I think that was just an oversight.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=the-problem-and-context>The Problem and Context</h3><p>The core issue stemmed from limitations in Rust’s Return Position Impl Trait In Traits (RPITIT) handling. The original implementation of <code>CurveWithDerivative</code> used an opaque associated type that prevented users from accessing important trait implementations (like Debug, Clone, and PartialEq) on the returned curve objects. This oversight made the API less usable than intended, as developers couldn’t perform basic operations on curve derivatives that required these common traits.<h3 id=the-solution-approach>The Solution Approach</h3><p>The author addressed this by:<ol><li>Making the output type explicit and public in trait definitions<li>Adding missing trait derivations to the <code>WithDerivative&LTT></code> type<li>Strengthening trait relationships between core curve types</ol><p>This approach prioritizes API usability over trait signature cleanliness, recognizing that practical developer needs outweigh aesthetic concerns in this case.<h3 id=the-implementation>The Implementation</h3><p>The key changes appear in two files:<p><strong>1. <code>derivatives/mod.rs</code></strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub trait </span><span style=color:#399ee6>CurveWithDerivative</span><span>: Curve {
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Output</span><span style=color:#61676ccc>: </span><span>Curve&LTPoint = </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Point></span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>with_derivative</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Output</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub trait </span><span style=color:#399ee6>CurveWithDerivative</span><span>: Curve {
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Output</span><span style=color:#61676ccc>: </span><span>Curve&LTPoint = </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Point></span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>with_derivative</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Output</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#fa6e32>pub type </span><span style=color:#399ee6>WithDerivative</span><span style=color:#ed9366><</span><span>T</span><span style=color:#ed9366>> = </span><span>&LTT </span><span style=color:#ed9366>as</span><span> CurveWithDerivative></span><span style=color:#ed9366>::</span><span>Output</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Added derivations:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Clone</span><span style=color:#61676ccc>,</span><span> Debug</span><span style=color:#61676ccc>,</span><span> PartialEq)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>WithDerivative</span><span>&LTT</span><span style=color:#61676ccc>:</span><span> Curve>(pub </span><span style=color:#fa6e32>T</span><span style=color:#ed9366>::</span><span>Derivative)</span><span style=color:#61676ccc>;
</span></code></pre><p>The explicit type alias and public exposure allow direct access to the output type’s traits. The new derivations enable standard operations on curve derivatives.<p><strong>2. <code>common_traits.rs</code></strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added trait bound:
</span><span style=color:#fa6e32>pub trait </span><span style=color:#399ee6>Curve</span><span>: CurveWithDerivative + Sized {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... existing methods ...
</span><span>}
</span></code></pre><p>This change ensures all Curve implementations must also satisfy CurveWithDerivative requirements, enforcing consistency across the API.<h3 id=technical-insights>Technical Insights</h3><p>The implementation demonstrates two important Rust patterns:<ol><li><strong>Type Erasure Prevention</strong>: By exposing the concrete <code>WithDerivative&LTT></code> type instead of using an opaque associated type, users gain access to all implemented traits<li><strong>Trait Composition</strong>: The modified trait hierarchy (Curve requiring CurveWithDerivative) creates a more robust API contract</ol><p>The decision to use <code>pub type</code> rather than expose the associated type directly provides better documentation and type ergonomics for consumers of the API.<h3 id=the-impact>The Impact</h3><p>These changes immediately improve developer experience by:<ul><li>Enabling debug printing of curve derivatives<li>Allowing comparison of derivative objects<li>Supporting cloning operations on derivatives<li>Providing clearer compiler error messages through explicit type relationships</ul><p>The PR also fixes an inconsistency in the trait hierarchy that could lead to maintenance issues. While the trait signatures become slightly more complex, the practical benefits for API consumers justify this tradeoff.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    Curve[Curve Trait] -->|requires| CurveWithDerivative[CurveWithDerivative Trait]
</span><span>    CurveWithDerivative -->|produces| WithDerivative[WithDerivative Type]
</span><span>    WithDerivative -.->|implements| Traits[Debug, Clone, PartialEq]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>1. <code>crates/bevy_math/src/curve/derivatives/mod.rs</code></strong><ul><li>Added public type alias for Output<li>Implemented missing trait derivations<li>Related to core PR objective of exposing implementation details</ul><p><strong>Before:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub trait </span><span style=color:#399ee6>CurveWithDerivative</span><span>: Curve {
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Output</span><span style=color:#61676ccc>: </span><span>Curve&LTPoint = </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Point></span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>with_derivative</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Output</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p><strong>After:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub trait </span><span style=color:#399ee6>CurveWithDerivative</span><span>: Curve {
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Output</span><span style=color:#61676ccc>: </span><span>Curve&LTPoint = </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Point></span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>with_derivative</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Output</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Clone</span><span style=color:#61676ccc>,</span><span> Debug</span><span style=color:#61676ccc>,</span><span> PartialEq)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>WithDerivative</span><span>&LTT</span><span style=color:#61676ccc>:</span><span> Curve>(pub </span><span style=color:#fa6e32>T</span><span style=color:#ed9366>::</span><span>Derivative)</span><span style=color:#61676ccc>;
</span></code></pre><p><strong>2. <code>crates/bevy_math/src/common_traits.rs</code></strong><ul><li>Enforced trait hierarchy consistency<li>Ensured all Curves implement derivative functionality</ul><p><strong>Added:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub trait </span><span style=color:#399ee6>Curve</span><span>: CurveWithDerivative + Sized {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... existing methods ...
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://rust-lang.github.io/rfcs/3425-return-position-impl-trait-in-traits.html target=_blank>Rust RFC 3425 - Return Position Impl Trait In Traits</a><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/rust-by-example/trait/derive.html target=_blank>Rust Documentation on Trait Derivation</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/introduction/ target=_blank>Bevy Engine ECS Documentation</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-04/pr_18826.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>