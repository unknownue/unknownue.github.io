<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18712 Fix motion blur on skinned meshes
        
    </title><meta content="#18712 Fix motion blur on skinned meshes" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-04/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-04-04</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-04/pr-18712-zh-cn-20250404>中文</a></div></div><div class=pr-content><h1 id=18712-fix-motion-blur-on-skinned-meshes>#18712 Fix motion blur on skinned meshes</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix motion blur on skinned meshes<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18712<li><strong>Author</strong>: greeble-dev<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: <code>C-Bug</code>, <code>A-Rendering</code><li><strong>Created</strong>: 2025-04-04T06:35:10Z<li><strong>Merged</strong>: 2025-04-05T14:22:31Z<li><strong>Merged By</strong>: cart</ul><h2 id=description-translation>Description Translation</h2><p><strong>Objective</strong><br> Fix motion blur not working on skinned meshes.<p><strong>Solution</strong><br> <code>set_mesh_motion_vector_flags</code> can set <code>RenderMeshInstanceFlags::HAS_PREVIOUS_SKIN</code> after specialization has already cached the material. This can lead to <code>MeshPipelineKey::HAS_PREVIOUS_SKIN</code> never getting set, disabling motion blur.<p>The fix is to make sure <code>set_mesh_motion_vector_flags</code> happens before specialization.<p>Note that the bug is fixed in a different way by #18074, which includes other fixes but is a much larger change.<p><strong>Testing</strong><br> Open the <code>animated_mesh</code> example and add these components to the <code>Camera3d</code> entity:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>MotionBlur {
</span><span>    shutter_angle</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>5.0</span><span style=color:#61676ccc>,
</span><span>    samples</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>2</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(</span><span style=color:#f29718>all</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"webgl2"</span><span style=color:#61676ccc>,</span><span> target_arch </span><span style=color:#ed9366>= </span><span style=color:#86b300>"wasm32"</span><span style=color:#61676ccc>, </span><span style=color:#f29718>not</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"webgpu"</span><span>)))]
</span><span>    _webgl2_padding</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Default</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>,
</span><span>}</span><span style=color:#61676ccc>,
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(</span><span style=color:#f29718>all</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"webgl2"</span><span style=color:#61676ccc>,</span><span> target_arch </span><span style=color:#ed9366>= </span><span style=color:#86b300>"wasm32"</span><span style=color:#61676ccc>, </span><span style=color:#f29718>not</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"webgpu"</span><span>)))]
</span><span>Msaa</span><span style=color:#ed9366>::</span><span>Off</span><span style=color:#61676ccc>,
</span></code></pre><p>Tested on <code>animated_mesh</code>, <code>many_foxes</code>, <code>custom_skinned_mesh</code>, Win10/Nvidia with Vulkan, WebGL/Chrome, WebGPU/Chrome. Note that testing <code>many_foxes</code> WebGL requires #18715.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The problem stemmed from an ordering issue in Bevy’s render pipeline. Skinned meshes requiring motion blur were missing critical pipeline flags due to system execution order. The motion blur effect relies on <code>MeshPipelineKey::HAS_PREVIOUS_SKIN</code> being set to include previous frame skinning data in shaders. However, the flag-setting logic in <code>set_mesh_motion_vector_flags</code> was running after material specialization, which caches pipeline state based on current flags.<p>The core issue manifested as:<ol><li>Material specialization occurs first, caching pipeline state without <code>HAS_PREVIOUS_SKIN</code><li><code>set_mesh_motion_vector_flags</code> later adds <code>RenderMeshInstanceFlags::HAS_PREVIOUS_SKIN</code><li>Subsequent frames use the cached pipeline state missing the required flag<li>Shaders don’t receive previous skin data, breaking motion blur</ol><p>The solution required reordering systems to ensure flag setting precedes specialization. This involved modifying system schedules in multiple PBR modules to enforce correct execution order:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before (problematic order):
</span><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(ExtractSchedule</span><span style=color:#61676ccc>, </span><span>(
</span><span>    queue_material_meshes</span><span style=color:#ed9366>::</span><span>&LTM></span><span style=color:#61676ccc>,
</span><span>    set_mesh_motion_vector_flags</span><span style=color:#61676ccc>,
</span><span>))</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After (fixed order):
</span><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(ExtractSchedule</span><span style=color:#61676ccc>, </span><span>(
</span><span>    set_mesh_motion_vector_flags</span><span style=color:#61676ccc>,
</span><span>    queue_material_meshes</span><span style=color:#ed9366>::</span><span>&LTM></span><span style=color:#61676ccc>,
</span><span>))</span><span style=color:#61676ccc>;
</span></code></pre><p>This simple but crucial ordering change ensures that when materials are queued for rendering:<ol><li>Motion vector flags are already set<li>Specialization incorporates <code>HAS_PREVIOUS_SKIN</code> into pipeline keys<li>Shaders properly receive previous frame skin matrices<li>Motion blur calculations use correct historical data</ol><p>The implementation required coordinated changes across three key areas of the rendering pipeline to maintain consistency in system ordering. While the code changes were small (+10/-8 lines total), they addressed a fundamental sequencing issue in the render graph.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[set_mesh_motion_vector_flags] --> B[Specialization]
</span><span>    B --> C[Pipeline Key Creation]
</span><span>    C --> D[Shader Configuration]
</span><span>    D --> E[Motion Blur Rendering]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-pbr-src-prepass-mod-rs-7-6><code>crates/bevy_pbr/src/prepass/mod.rs</code> (+7/-6)</h3><p><strong>Purpose</strong>: Ensure motion vector flags are set before queuing prepass materials<br> Key change:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(ExtractSchedule</span><span style=color:#61676ccc>, </span><span>(
</span><span>    queue_material_meshes</span><span style=color:#ed9366>::</span><span>&LTM></span><span style=color:#61676ccc>,
</span><span>    set_mesh_motion_vector_flags</span><span style=color:#61676ccc>,
</span><span>))</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(ExtractSchedule</span><span style=color:#61676ccc>, </span><span>(
</span><span>    set_mesh_motion_vector_flags</span><span style=color:#61676ccc>,
</span><span>    queue_material_meshes</span><span style=color:#ed9366>::</span><span>&LTM></span><span style=color:#61676ccc>,
</span><span>))</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-pbr-src-material-rs-2-1><code>crates/bevy_pbr/src/material.rs</code> (+2/-1)</h3><p><strong>Purpose</strong>: Synchronize main pass system ordering with prepass changes<br> Key change:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>    ))</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(ExtractSchedule</span><span style=color:#61676ccc>, </span><span>(
</span><span>        queue_material_meshes</span><span style=color:#ed9366>::</span><span>&LTM></span><span style=color:#61676ccc>,
</span><span>        set_mesh_motion_vector_flags</span><span style=color:#61676ccc>,
</span><span>    ))</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>    ))</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(ExtractSchedule</span><span style=color:#61676ccc>, </span><span>(
</span><span>        set_mesh_motion_vector_flags</span><span style=color:#61676ccc>,
</span><span>        queue_material_meshes</span><span style=color:#ed9366>::</span><span>&LTM></span><span style=color:#61676ccc>,
</span><span>    ))</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-pbr-src-render-mesh-rs-1-1><code>crates/bevy_pbr/src/render/mesh.rs</code> (+1/-1)</h3><p><strong>Purpose</strong>: Align mesh rendering system order with other changes<br> Key change:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(ExtractSchedule</span><span style=color:#61676ccc>,</span><span> extract_skins</span><span style=color:#ed9366>.</span><span style=color:#f07171>after</span><span>(set_mesh_motion_vector_flags))
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(ExtractSchedule</span><span style=color:#61676ccc>,</span><span> extract_skins</span><span style=color:#ed9366>.</span><span style=color:#f07171>before</span><span>(set_mesh_motion_vector_flags))
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/getting-started/systems/ target=_blank>Bevy System Scheduling Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://developer.nvidia.com/gpugems/gpugems3/part-iv-image-effects/chapter-27-motion-blur-post-processing-effect target=_blank>GPU Skinning Techniques</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/examples/3d-rendering/material-specialization/ target=_blank>Material Specialization in Bevy</a><li><a rel="noopener nofollow noreferrer" href=https://www.advances.realtimerendering.com/s2021/jeschke_rt_motionblur_slides.pdf target=_blank>Motion Blur Implementation Patterns</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-04/pr_18712.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>