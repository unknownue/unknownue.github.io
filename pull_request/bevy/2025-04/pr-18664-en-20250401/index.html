<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18664 Remove the `visited` local system param from `update_ui_context_system`.
        
    </title><meta content="#18664 Remove the `visited` local system param from `update_ui_context_system`." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-04/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-04-01</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-04/pr-18664-zh-cn-20250401>中文</a></div></div><div class=pr-content><h1 id=18664-remove-the-visited-local-system-param-from-update-ui-context-system>#18664 Remove the <code>visited</code> local system param from <code>update_ui_context_system</code>.</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Remove the <code>visited</code> local system param from <code>update_ui_context_system</code>.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18664<li><strong>Author</strong>: ickshonpe<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: <code>C-Bug</code>, <code>A-Rendering</code>, <code>A-UI</code>, <code>S-Ready-For-Final-Review</code><li><strong>Created</strong>: 2025-04-01T15:55:54Z<li><strong>Merged</strong>: Not merged<li><strong>Merged By</strong>: N/A</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>The <code>visited: Local&LTHashSet&LTEntity>></code> system param is meant to track which entities <code>update_contexts_recursively</code> has visited and updated but when the reparent_nodes_query isn’t ordered descending from parent to child nodes can get marked as visited even though their camera target is unset and if the camera target is unset then the node won’t be rendered.<p>Fixes #18616<h2 id=solution>Solution</h2><p>Remove the <code>visited</code> system param from <code>update_ui_context_system</code> and the associated visited check from <code>update_contexts_recursively</code>. It was redundant anyway since the set_if_neq check is sufficient to track already updated nodes.<h2 id=testing>Testing</h2><p>The example from #18616 can be used for testing.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The PR addresses a critical rendering bug in Bevy’s UI system where reparented nodes could become invisible. The root cause was an overeager optimization using a <code>visited</code> tracking system that prematurely marked nodes as processed.<p>In the original implementation, <code>update_ui_context_system</code> used a <code>Local&LTHashSet&LTEntity>></code> to track visited nodes during UI hierarchy updates. This collection was meant to prevent redundant processing of nodes. However, when dealing with reparented nodes (nodes moved to new positions in the UI hierarchy), the query order could mark child nodes as visited before their parent’s camera target was properly set. This left children with unconfigured camera targets, making them invisible despite being valid UI elements.<p>The key insight came from recognizing that the existing <code>set_if_neq</code> check in <code>update_contexts_recursively</code> already provided sufficient protection against redundant updates. The <code>visited</code> HashSet was not only redundant but actively harmful in certain hierarchy traversal scenarios. By removing this tracking mechanism, the system could:<ol><li>Avoid false-positive “visited” markings<li>Eliminate ordering dependencies in hierarchy processing<li>Simplify the control flow</ol><p>The implementation changes are surgical but impactful. In <code>update.rs</code>, the removal of 17 lines related to visited tracking versus adding 3 lines of cleanup demonstrates how a small change can resolve a significant behavioral bug. The core fix involves:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>update_contexts_recursively</span><span>(
</span><span>    </span><span style=color:#ff8f40>visited</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span>HashSet&LTEntity>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>if</span><span> visited</span><span style=color:#ed9366>.</span><span style=color:#f07171>contains</span><span>(</span><span style=color:#ed9366>&</span><span>entity) {
</span><span>        </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>    visited</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(entity)</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>update_contexts_recursively</span><span>(
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// No visited parameter
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Direct processing without checks
</span><span>}
</span></code></pre><p>This change leverages Bevy’s existing change detection via <code>DetectChangesMut</code> and <code>set_if_neq</code>, which already prevents unnecessary component updates. The removed visited checks were essentially duplicating functionality that the ECS change detection system already handles more reliably.<p>The solution demonstrates an important principle in ECS architecture: leveraging built-in change detection mechanisms is often safer and more efficient than custom tracking systems. This approach avoids synchronization issues between custom tracking and the ECS’s internal state management.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[UI Node Hierarchy] --> B[update_ui_context_system]
</span><span>    B --> C{Has ComputedNodeTarget?}
</span><span>    C -->|Yes| D[Process Node]
</span><span>    C -->|No| E[Skip Processing]
</span><span>    D --> F[Update Children Recursively]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ui-src-update-rs-3-17><code>crates/bevy_ui/src/update.rs</code> (+3/-17)</h3><ol><li><strong>System Parameter Removal</strong>:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>update_ui_context_system</span><span>(
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>visited</span><span style=color:#61676ccc>: </span><span>Local&LTHashSet&LTEntity>>,
</span><span>)
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>update_ui_context_system</span><span>(
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... (no visited parameter)
</span><span>)
</span></code></pre><ol start=2><li><strong>Recursive Function Simplification</strong>:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>update_contexts_recursively</span><span>(
</span><span>    </span><span style=color:#ff8f40>visited</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span>HashSet&LTEntity>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>if</span><span> visited</span><span style=color:#ed9366>.</span><span style=color:#f07171>contains</span><span>(</span><span style=color:#ed9366>&</span><span>entity) {
</span><span>        </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>    visited</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(entity)</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>update_contexts_recursively</span><span>(
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... (no visited parameter)
</span><span>) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Direct processing without tracking
</span><span>}
</span></code></pre><p>These changes eliminate the error-prone visited tracking while maintaining correct behavior through Bevy’s built-in change detection.<h2 id=further-reading>Further Reading</h2><ul><li>Bevy ECS Change Detection: https://bevyengine.org/learn/book/ECS/change-detection/<li>UI Rendering Fundamentals: https://bevyengine.org/learn/book/UI/rendering/<li>System Local Resources: https://bevyengine.org/learn/book/ECS/system-params/#local</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-04/pr_18664.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>