<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18870 Removed Double Offset in Picking Ray Calculation
        
    </title><meta content="#18870 Removed Double Offset in Picking Ray Calculation" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-04/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-04-27</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-04/pr-18870-zh-cn-20250427>中文</a></div></div><div class=pr-content><h1 id=title-removed-double-offset-in-picking-ray-calculation>Title: Removed Double Offset in Picking Ray Calculation</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Removed conversion from pointer physical coordinates to viewport local coordinates in bevy_picking make_ray function<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18870<li><strong>Author</strong>: KrzysztofZywiecki<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Picking<li><strong>Created</strong>: 2025-04-17T15:38:31Z<li><strong>Merged</strong>: 2025-04-27T14:19:34Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Fixes #18856.</ul><h2 id=solution>Solution</h2><p>After PR #17633, <code>Camera::viewport_to_world</code> method corrects <code>viewport_position</code> passed in that input so that it’s offset by camera’s viewport. <code>Camera::viewport_to_world</code> is used by <code>make_ray</code> function which in turn also offsets pointer position by viewport position, which causes picking objects to be shifted by viewport position, and it wasn’t removed in the aforementioned PR. This second offsetting in <code>make_ray</code> was removed.<h2 id=testing>Testing</h2><ul><li>I tested simple_picking example by applying some horizontal offset to camera’s viewport.<li>I tested my application that displayed a single rectangle with picking on two cameras arranged in a row. When using local bevy with this fix, both cameras can be used for picking correctly.<li>I modified split_screen example: I added observer to ground plane that changes color on hover, and removed UI as it interfered with picking both on master and my branch. On master, only top left camera was triggering the observer, and on my branch all cameras could change plane’s color on hover.<li>I added viewport offset to mesh_picking, with my changes it works correctly, while on master picking ray is shifted.<li>Sprite picking with viewport offset doesn’t work both on master and on this branch.</ul><p>These are the only scenarios I tested. I think other picking functions that use this function should be tested but I couldn’t track more uses of it.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The core issue stemmed from a double coordinate conversion in Bevy’s picking system. After PR #17633 updated <code>Camera::viewport_to_world</code> to handle viewport offsets internally, the <code>make_ray</code> function in <code>bevy_picking</code> became redundant in its coordinate adjustments. This redundancy caused picking rays to be incorrectly offset when cameras used viewports, manifesting as misaligned object selection in split-screen setups and other multi-viewport scenarios.<p>The root problem was identified in the coordinate transformation pipeline. The <code>make_ray</code> function originally performed these steps:<ol><li>Convert pointer position to viewport-local coordinates<li>Pass these coordinates to <code>viewport_to_world</code>, which then applied the same viewport offset again</ol><p>This resulted in a double subtraction of the viewport position, effectively shifting the picking ray by twice the intended offset. The fix required removing the redundant coordinate adjustment in <code>make_ray</code> while preserving the existing logic in <code>viewport_to_world</code>.<p>The key code change simplifies the coordinate handling:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before
</span><span style=color:#fa6e32>let mut</span><span> viewport_pos </span><span style=color:#ed9366>=</span><span> pointer_loc</span><span style=color:#ed9366>.</span><span>position</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(viewport) </span><span style=color:#ed9366>= &</span><span>camera</span><span style=color:#ed9366>.</span><span>viewport {
</span><span>    </span><span style=color:#fa6e32>let</span><span> viewport_logical </span><span style=color:#ed9366>=</span><span> camera</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_logical</span><span>(viewport</span><span style=color:#ed9366>.</span><span>physical_position)</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span><span>    viewport_pos </span><span style=color:#ed9366>-=</span><span> viewport_logical</span><span style=color:#61676ccc>;
</span><span>}
</span><span>camera</span><span style=color:#ed9366>.</span><span style=color:#f07171>viewport_to_world</span><span>(camera_tfm</span><span style=color:#61676ccc>,</span><span> viewport_pos)</span><span style=color:#ed9366>.</span><span style=color:#f07171>ok</span><span>()
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After
</span><span>camera
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>viewport_to_world</span><span>(camera_tfm</span><span style=color:#61676ccc>,</span><span> pointer_loc</span><span style=color:#ed9366>.</span><span>position)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>ok</span><span>()
</span></code></pre><p>By eliminating the manual viewport offset calculation, the code now relies solely on <code>viewport_to_world</code> to handle coordinate transformations correctly. This aligns with the updated behavior introduced in #17633, where <code>viewport_to_world</code> was modified to accept viewport-relative coordinates directly.<p>The implementation required careful validation across multiple scenarios:<ol><li>Split-screen configurations where multiple viewports coexist<li>Single-viewport setups with non-zero offsets<li>Different renderable types (meshes vs sprites)</ol><p>Testing revealed that while mesh picking now works correctly with viewports, sprite picking remains unaffected by this fix - indicating a separate issue in the sprite rendering/picking pipeline that requires independent investigation.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Pointer Position] --> B[make_ray]
</span><span>    B --> C{Viewport Active?}
</span><span>    C -->|Yes| D[viewport_to_world]
</span><span>    C -->|No| D
</span><span>    D --> E[World-space Ray]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>crates/bevy_picking/src/backend.rs</strong> (+3/-6)<ol><li><p><strong>Change Summary</strong>:</p> <ul><li>Removed redundant viewport offset calculation in ray creation<li>Simplified coordinate passing to <code>viewport_to_world</code></ul><li><p><strong>Code Comparison</strong>:</p></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let mut</span><span> viewport_pos </span><span style=color:#ed9366>=</span><span> pointer_loc</span><span style=color:#ed9366>.</span><span>position</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(viewport) </span><span style=color:#ed9366>= &</span><span>camera</span><span style=color:#ed9366>.</span><span>viewport {
</span><span>    </span><span style=color:#fa6e32>let</span><span> viewport_logical </span><span style=color:#ed9366>=</span><span> camera</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_logical</span><span>(viewport</span><span style=color:#ed9366>.</span><span>physical_position)</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span><span>    viewport_pos </span><span style=color:#ed9366>-=</span><span> viewport_logical</span><span style=color:#61676ccc>;
</span><span>}
</span><span>camera</span><span style=color:#ed9366>.</span><span style=color:#f07171>viewport_to_world</span><span>(camera_tfm</span><span style=color:#61676ccc>,</span><span> viewport_pos)</span><span style=color:#ed9366>.</span><span style=color:#f07171>ok</span><span>()
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>camera
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>viewport_to_world</span><span>(camera_tfm</span><span style=color:#61676ccc>,</span><span> pointer_loc</span><span style=color:#ed9366>.</span><span>position)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>ok</span><span>()
</span></code></pre><ol start=3><li><strong>Impact</strong>: <ul><li>Fixes picking accuracy for viewport-enabled cameras<li>Aligns with updated camera behavior from #17633<li>Reduces transformation steps in picking pipeline</ul></ol><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/render/camera/struct.Camera.html#method.viewport_to_world target=_blank>Camera Viewport Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/features/coords.html target=_blank>Coordinate Systems in Bevy</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/pull/17633 target=_blank>PR #17633: Camera Viewport Fixes</a></ol><h1 id=full-code-diff>Full Code Diff</h1><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_picking/src/backend.rs b/crates/bevy_picking/src/backend.rs
</span><span>index 8c781d54e32f4..fb2f9d7d7aafd 100644
</span><span style=color:#c594c5>--- a/crates/bevy_picking/src/backend.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_picking/src/backend.rs
</span><span style=color:#c594c5>@@ -229,11 +229,8 @@ </span><span style=color:#399ee6>pub mod ray {
</span><span>         if !pointer_loc.is_in_viewport(camera, primary_window_entity) {
</span><span>             return None;
</span><span>         }
</span><span style=color:#f07171>-        let mut viewport_pos = pointer_loc.position;
</span><span style=color:#f07171>-        if let Some(viewport) = &camera.viewport {
</span><span style=color:#f07171>-            let viewport_logical = camera.to_logical(viewport.physical_position)?;
</span><span style=color:#f07171>-            viewport_pos -= viewport_logical;
</span><span style=color:#f07171>-        }
</span><span style=color:#f07171>-        camera.viewport_to_world(camera_tfm, viewport_pos).ok()
</span><span style=color:#86b300>+        camera
</span><span style=color:#86b300>+            .viewport_to_world(camera_tfm, pointer_loc.position)
</span><span style=color:#86b300>+            .ok()
</span><span>     }
</span><span> }
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-04/pr_18870.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>