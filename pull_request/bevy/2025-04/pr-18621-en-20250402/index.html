<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18621 Code quality cleanup pass for #[require]
        
    </title><meta content="#18621 Code quality cleanup pass for #[require]" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-04/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-04-02</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-04/pr-18621-zh-cn-20250402>中文</a></div></div><div class=pr-content><h1 id=18621-code-quality-cleanup-pass-for-require>#18621 Code quality cleanup pass for #[require]</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Code quality cleanup pass for #[require]<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18621<li><strong>Author</strong>: Bleachfuel<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: <code>A-ECS</code>, <code>C-Code-Quality</code>, <code>C-Usability</code>, <code>S-Ready-For-Final-Review</code>, <code>D-Straightforward</code>, <code>D-Macros</code><li><strong>Created</strong>: 2025-03-30T14:54:29Z<li><strong>Merged</strong>: Not merged<li><strong>Merged By</strong>: N/A</ul><h2 id=description-translation>Description Translation</h2><p>#18555 improved syntax for required components.<p>However some code was a bit redundant after the new parsing and struct initializing would not give proper errors. This PR fixes that.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses technical debt that emerged from a previous implementation of the <code>#[require]</code> attribute for Bevy’s ECS component macros. The original implementation (#18555) introduced new syntax for specifying required components but left some code quality issues that needed resolution.<p>The core problem stemmed from two main issues:<ol><li>Redundant code patterns in attribute parsing<li>Inadequate error reporting during struct initialization validation</ol><p>In the macro implementation, the attribute parsing logic contained duplicated error checking code. This redundancy made the implementation harder to maintain and increased the risk of inconsistent error handling. Additionally, when users made mistakes in their component definitions (like missing required fields), the error messages weren’t properly spanned to highlight the exact location of the issue.<p>The solution focused on two key improvements:<ol><li>Consolidating error handling using <code>syn::Result</code> pattern<li>Enhancing error spans for better developer feedback</ol><p>A critical technical decision was to refactor the attribute parsing logic to use Rust’s <code>Result</code> pattern more consistently. This allowed combining multiple error checks into streamlined control flows. The implementation also needed to ensure proper span information was carried through to error messages, making it easier for developers to locate issues in their code.<p>Key changes in the implementation include:<ol><li><strong>Error handling unification</strong>:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Multiple error checks with manual handling
</span><span style=color:#fa6e32>let</span><span> attrs </span><span style=color:#ed9366>= </span><span style=color:#f07171>parse_component_attr</span><span>(</span><span style=color:#ed9366>&</span><span>ast)</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(e) </span><span style=color:#ed9366>=</span><span> attrs {
</span><span>    </span><span style=color:#fa6e32>return</span><span> e</span><span style=color:#ed9366>.</span><span style=color:#f07171>into_compile_error</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()</span><span style=color:#61676ccc>;
</span><span>}
</span><span style=color:#fa6e32>let</span><span> attrs </span><span style=color:#ed9366>=</span><span> attrs</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Using ? operator with syn::Result
</span><span style=color:#fa6e32>let</span><span> attrs </span><span style=color:#ed9366>= </span><span style=color:#f07171>parse_component_attr</span><span>(</span><span style=color:#ed9366>&</span><span>ast)</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span></code></pre><ol start=2><li><strong>Span preservation</strong>:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Generic error without specific span
</span><span style=color:#fa6e32>return </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(Error</span><span style=color:#ed9366>::</span><span>new(
</span><span>    attr</span><span style=color:#ed9366>.</span><span style=color:#f07171>span</span><span>()</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#86b300>"expected parentheses after require"</span><span style=color:#61676ccc>,
</span><span>))</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Detailed span information
</span><span style=color:#fa6e32>let</span><span> content</span><span style=color:#61676ccc>;
</span><span style=color:#f07171>parenthesized!</span><span>(content </span><span style=color:#ed9366>in</span><span> attr)</span><span style=color:#61676ccc>;
</span></code></pre><p>These changes improve maintainability by reducing code duplication and make error messages more actionable by preserving source location information. The refactoring affected several aspects of the macro’s parsing logic while maintaining the same external functionality.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Component Derive Macro] --> B[Attribute Parser]
</span><span>    B --> C[Error Handling]
</span><span>    B --> D[Validation Logic]
</span><span>    D --> E[Required Components Check]
</span><span>    C --> F[Span-Preserving Errors]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=file-crates-bevy-ecs-macros-src-component-rs-8-15>File: <code>crates/bevy_ecs/macros/src/component.rs</code> (+8/-15)</h3><p><strong>Changes</strong>:<ol><li>Streamlined error handling flow in component attribute parsing<li>Removed redundant error checking code<li>Improved span information for validation errors</ol><p><strong>Key Code Modifications</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Manual error handling
</span><span style=color:#fa6e32>let</span><span> relationship </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>match </span><span style=color:#f07171>derive_relationship</span><span>(</span><span style=color:#ed9366>&</span><span>ast</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>attrs) {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(r) </span><span style=color:#ed9366>=></span><span> r</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(e) </span><span style=color:#ed9366>=> </span><span style=color:#fa6e32>return</span><span> e</span><span style=color:#ed9366>.</span><span style=color:#f07171>into_compile_error</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()</span><span style=color:#61676ccc>,
</span><span>}</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Using ? operator with syn::Result
</span><span style=color:#fa6e32>let</span><span> relationship </span><span style=color:#ed9366>= </span><span style=color:#f07171>derive_relationship</span><span>(</span><span style=color:#ed9366>&</span><span>ast</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>attrs)</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span></code></pre><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Basic error reporting
</span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span style=color:#f07171>matches!</span><span>(attr_vis</span><span style=color:#61676ccc>, </span><span>Visibility</span><span style=color:#ed9366>::</span><span>Inherited) {
</span><span>    </span><span style=color:#fa6e32>return </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(Error</span><span style=color:#ed9366>::</span><span>new(
</span><span>        attr_vis</span><span style=color:#ed9366>.</span><span style=color:#f07171>span</span><span>()</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#86b300>"expected no visibility qualifier"</span><span style=color:#61676ccc>,
</span><span>    ))</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Detailed span tracking
</span><span style=color:#fa6e32>let</span><span> content</span><span style=color:#61676ccc>;
</span><span style=color:#f07171>parenthesized!</span><span>(content </span><span style=color:#ed9366>in</span><span> attr)</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> component </span><span style=color:#ed9366>=</span><span> content</span><span style=color:#ed9366>.</span><span>parse</span><span style=color:#ed9366>::</span><span>&LTExpr>()</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span></code></pre><p>These changes eliminate redundant error checking patterns and ensure error messages point directly to the problematic code locations. The refactoring makes the macro implementation more maintainable while preserving existing functionality.<h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/reference/procedural-macros.html target=_blank>Rust Procedural Macros Guide</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/syn/latest/syn/ target=_blank>syn crate documentation</a> for parsing Rust syntax<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/ecs/components/ target=_blank>Bevy ECS Components Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/pull/18555 target=_blank>Previous PR #18555</a> for context on the original implementation<li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/proc-macro/guide.html#error-reporting target=_blank>Rust Error Handling in Macros</a> best practices</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-04/pr_18621.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>