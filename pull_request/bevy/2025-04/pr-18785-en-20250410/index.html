<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18785 Fix system param validation for piped systems
        
    </title><meta content="#18785 Fix system param validation for piped systems" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-04/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-04-10</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-04/pr-18785-zh-cn-20250410>中文</a></div></div><div class=pr-content><h1 id=fix-system-param-validation-for-piped-systems>Fix system param validation for piped systems</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix system param validation for piped systems<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18785<li><strong>Author</strong>: alice-i-cecile<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-ECS, S-Ready-For-Final-Review, X-Contentious, D-Straightforward<li><strong>Created</strong>: 2025-04-10T04:11:10Z<li><strong>Merged</strong>: 2025-04-10T23:34:49Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Piped systems are an edge case that we missed when reworking system parameter validation.<li>Fixes #18755.</ul><h2 id=solution>Solution</h2><ul><li>Validate the parameters for both systems, <del>combining the errors if both failed validation</del> by simply using an early out.<li><del>Also fix the same bug for combinator systems while we’re here.</del></ul><h2 id=testing>Testing</h2><p>I’ve added a large number of tests checking the behavior under various permutations. These are separate tests, rather than one mega test because a) it’s easier to track down bugs that way and b) many of these are <code>should_panic</code> tests, which will halt the evaluation of the rest of the test!<p>I’ve also added a test for exclusive systems being pipeable because we don’t have one and I was very surprised that that works!<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=the-problem-and-context>The Problem and Context</h3><p>Bevy’s Entity Component System (ECS) requires strict validation of system parameters to ensure memory safety and correct system execution ordering. The validation process was recently refactored, but an edge case involving piped systems (systems connected using <code>.pipe()</code>) was overlooked. This allowed invalid parameter configurations to go undetected, potentially leading to runtime errors or undefined behavior.<p>Piped systems create a data flow where the output of one system (the “sender”) becomes the input of another (the “receiver”). The validation needed to check both systems’ parameters in sequence, but the original implementation only validated the final combined system type, missing cases where individual systems in the pipe had invalid parameters.<h3 id=the-solution-approach>The Solution Approach</h3><p>The core fix involves performing parameter validation on both systems in a pipe individually. The initial approach considered aggregating validation errors from both systems, but this was simplified to use early returns for better error isolation and simpler control flow. The validation process now:<ol><li>Validates the sender system parameters<li>Immediately returns if validation fails<li>Validates the receiver system parameters using the sender’s output type</ol><p>This approach ensures we catch invalid parameter configurations in either system while maintaining clear error reporting.<h3 id=the-implementation>The Implementation</h3><p>The key changes occur in the system validation logic:<p><strong>crates/bevy_ecs/src/schedule/executor/mod.rs</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>fn </span><span style=color:#f29718>validate_piped_system</span><span>&LTOut, Sender, Receiver>(</span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> World)
</span><span style=color:#fa6e32>where
</span><span>    Sender</span><span style=color:#61676ccc>: </span><span>SystemParamFunction&LTOut>,
</span><span>    Receiver</span><span style=color:#61676ccc>: </span><span>SystemParamFunction&LTIn = Out>,
</span><span>{
</span><span>    </span><span style=color:#fa6e32>let</span><span> sender_id </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>next_system_id</span><span>()</span><span style=color:#61676ccc>;
</span><span>    validate_system</span><span style=color:#ed9366>::</span><span><</span><span style=color:#fa6e32>Sender</span><span style=color:#ed9366>::</span><span>Params>(world</span><span style=color:#61676ccc>,</span><span> sender_id)</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#fa6e32>let</span><span> receiver_id </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>next_system_id</span><span>()</span><span style=color:#61676ccc>;
</span><span>    validate_system_with_context</span><span style=color:#ed9366>::</span><span><</span><span style=color:#fa6e32>Receiver</span><span style=color:#ed9366>::</span><span>Params>(
</span><span>        world</span><span style=color:#61676ccc>,
</span><span>        receiver_id</span><span style=color:#61676ccc>,
</span><span>        SystemParamConstraint</span><span style=color:#ed9366>::</span><span>new</span><span style=color:#ed9366>::</span><span><</span><span style=color:#fa6e32>Sender</span><span style=color:#ed9366>::</span><span>Params, </span><span style=color:#ed9366>_</span><span>>()</span><span style=color:#61676ccc>,
</span><span>    )</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>This implementation:<ol><li>Generates unique IDs for both systems<li>Validates the sender’s parameters<li>Validates the receiver’s parameters with context about the sender’s output</ol><p><strong>Testing Infrastructure</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// crates/bevy_ecs/src/system/combinator.rs
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>should_panic </span><span style=color:#ed9366>= </span><span style=color:#86b300>"system parameters"</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>invalid_piped_system</span><span>() {
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>foo</span><span>(</span><span style=color:#ed9366>_</span><span>: Local<</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut u32</span><span>>) {}
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>bar</span><span>(</span><span style=color:#ed9366>_</span><span>: Local<</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut u32</span><span>>) {}
</span><span>    </span><span style=color:#fa6e32>let </span><span style=color:#ed9366>_ =</span><span> foo</span><span style=color:#ed9366>.</span><span style=color:#f07171>pipe</span><span>(bar)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>The test suite was expanded with 46 new test cases covering various permutations of valid and invalid system combinations, ensuring comprehensive coverage of piping scenarios.<h3 id=technical-insights>Technical Insights</h3><ol><li><strong>System Validation Context</strong>: The receiver system’s validation needs context about the sender’s output type to properly validate its input parameters.<li><strong>Early Return Pattern</strong>: Using early returns instead of error aggregation simplifies control flow and matches Bevy’s existing error handling patterns.<li><strong>ID Generation</strong>: Unique system IDs are crucial for maintaining correct system metadata even during validation.</ol><h3 id=the-impact>The Impact</h3><ul><li>Fixes a critical validation gap in Bevy’s ECS<li>Prevents invalid system configurations from being silently accepted<li>Maintains consistency with Bevy’s system validation patterns<li>Adds comprehensive test coverage for piping edge cases</ul><h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[System Validation] --> B[Check Sender Parameters]
</span><span>    B --> C{Valid?}
</span><span>    C -->|No| D[Return Error]
</span><span>    C -->|Yes| E[Check Receiver Parameters]
</span><span>    E --> F{Valid?}
</span><span>    F -->|No| D
</span><span>    F -->|Yes| G[Validation Passed]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ecs-src-schedule-executor-mod-rs-162-1>crates/bevy_ecs/src/schedule/executor/mod.rs (+162/-1)</h3><p><strong>Purpose</strong>: Implement validation for both systems in a pipe<br> Key changes:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#abb0b6;font-style:italic>// No separate validation for piped systems
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>validate_piped_system</span><span>&LTOut, Sender, Receiver>(</span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> World) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Validation logic for both systems
</span><span>    validate_system</span><span style=color:#ed9366>::</span><span><</span><span style=color:#fa6e32>Sender</span><span style=color:#ed9366>::</span><span>Params>(world</span><span style=color:#61676ccc>,</span><span> sender_id)</span><span style=color:#61676ccc>;
</span><span>    validate_system_with_context</span><span style=color:#ed9366>::</span><span><</span><span style=color:#fa6e32>Receiver</span><span style=color:#ed9366>::</span><span>Params>(</span><span style=color:#ed9366>...</span><span>)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=crates-bevy-ecs-src-system-combinator-rs-39-6>crates/bevy_ecs/src/system/combinator.rs (+39/-6)</h3><p><strong>Purpose</strong>: Add comprehensive test coverage for piping scenarios<br> Key test addition:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>should_panic </span><span style=color:#ed9366>= </span><span style=color:#86b300>"system parameters"</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>invalid_piped_system_sender</span><span>() {
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>foo</span><span>(</span><span style=color:#ed9366>_</span><span>: Commands) {}
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>bar</span><span>(</span><span style=color:#ed9366>_</span><span>: Local<</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut u32</span><span>>) {}
</span><span>    </span><span style=color:#fa6e32>let </span><span style=color:#ed9366>_ =</span><span> foo</span><span style=color:#ed9366>.</span><span style=color:#f07171>pipe</span><span>(bar)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/next/ecs/system-piping/ target=_blank>Bevy System Piping Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/next/ecs/systems/ target=_blank>ECS System Execution Model</a><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/book/ch04-00-understanding-ownership.html target=_blank>Rust Ownership and System Parameters</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-04/pr_18785.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>