<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18845 Revert attempt to fix memory leak
        
    </title><meta content="#18845 Revert attempt to fix memory leak" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-04/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-04-15</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-04/pr-18845-zh-cn-20250415>中文</a></div></div><div class=pr-content><h1 id=title-revert-attempt-to-fix-memory-leak>Title: Revert attempt to fix memory leak</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Revert attempt to fix memory leak<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18845<li><strong>Author</strong>: tychedelia<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, S-Needs-Review<li><strong>Created</strong>: 2025-04-15T01:22:08Z<li><strong>Merged</strong>: 2025-04-15T02:18:23Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><p>This reverts commit a9b0b4e7f7a51db77df0ca75c7029d7b60daa369.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The PR addresses a regression introduced by a previous memory leak fix (commit a9b0b4e). The original commit attempted to resolve memory management issues in Bevy’s render asset system but inadvertently caused new problems in production scenarios. This revert demonstrates the challenges of managing GPU resource lifetimes in complex ECS systems.<p>The core issue stemmed from how <code>RenderAsset</code> implementations interact with Bevy’s entity component system. The original fix introduced a <code>HashMap&LTAssetId&LTA>, PreparedAsset&LTA>></code> to track prepared assets, attempting to prevent duplicate preparations. However, this approach led to premature asset disposal in certain entity relationship scenarios, particularly when dealing with nested assets or complex spawn/despawn patterns.<p>Key changes in the revert focus on restoring the previous asset preparation logic while maintaining thread safety:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before revert (problematic code):
</span><span style=color:#fa6e32>let</span><span> prepared_asset </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(prepared_asset) </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>prepared_assets</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(id) {
</span><span>    prepared_asset</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()
</span><span>} </span><span style=color:#fa6e32>else </span><span>{
</span><span>    </span><span style=color:#fa6e32>let</span><span> prepared_asset </span><span style=color:#ed9366>= </span><span style=color:#f07171>prepare_asset</span><span>(asset)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>prepared_assets</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(</span><span style=color:#ed9366>*</span><span>id</span><span style=color:#61676ccc>,</span><span> prepared_asset</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>())</span><span style=color:#61676ccc>;
</span><span>    prepared_asset
</span><span>}</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After revert (restored logic):
</span><span style=color:#fa6e32>let</span><span> prepared_asset </span><span style=color:#ed9366>= </span><span style=color:#f07171>prepare_asset</span><span>(asset)</span><span style=color:#61676ccc>;
</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>prepared_assets</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(</span><span style=color:#ed9366>*</span><span>id</span><span style=color:#61676ccc>,</span><span> prepared_asset</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>())</span><span style=color:#61676ccc>;
</span></code></pre><p>The reverted code shows three critical adjustments:<ol><li>Removed conditional check for existing prepared assets<li>Eliminated premature asset insertion before preparation<li>Restored direct preparation flow without caching</ol><p>This revert prioritizes deterministic asset lifecycle management over potential performance optimizations. The original caching mechanism, while theoretically reducing redundant preparations, introduced subtle bugs when assets were modified or removed between frames. By reverting to immediate preparation and insertion, the system regains predictable behavior at the cost of potentially increased CPU workload during asset processing.<p>The technical trade-off here centers around the difficulty of maintaining accurate asset state across Bevy’s ECS boundaries. The render asset system must balance:<ul><li>Thread safety across parallel systems<li>Frame coherence for rendering resources<li>Efficient memory reuse<li>Clear ownership semantics</ul><p>This revert serves as a valuable case study in GPU resource management, demonstrating that premature optimization of asset preparation can lead to subtle memory management bugs. The team likely concluded that a more fundamental redesign of the asset management system would be required to address the memory leaks without introducing new issues.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[RenderAsset::prepare_asset] --> B[Asset Preparation Logic]
</span><span>    B --> C[GPU Resource Allocation]
</span><span>    B --> D[Asset Tracking]
</span><span>    D --> E[Memory Leak Risk]
</span><span>    C --> F[Frame Rendering]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>File</strong>: <code>crates/bevy_render/src/render_asset.rs</code><p>Key modifications restore the original asset preparation flow:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before revert:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>prepare_asset</span><span><</span><span style=color:#fa6e32>'a</span><span>>(
</span><span>    </span><span style=color:#ff8f40>render_device</span><span style=color:#61676ccc>: </span><span>Res&LTRenderDevice>,
</span><span>    </span><span style=color:#ff8f40>render_queue</span><span style=color:#61676ccc>: </span><span>Res&LTRenderQueue>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>prepare_system</span><span style=color:#61676ccc>: </span><span>ResMut<</span><span style=color:#fa6e32>Self</span><span>>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>events</span><span style=color:#61676ccc>: </span><span>EventReader&LTAssetEvent&LTA>>,
</span><span>) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Complex caching logic with HashMap tracking
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After revert:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>prepare_asset</span><span><</span><span style=color:#fa6e32>'a</span><span>>(
</span><span>    </span><span style=color:#ff8f40>render_device</span><span style=color:#61676ccc>: </span><span>Res&LTRenderDevice>,
</span><span>    </span><span style=color:#ff8f40>render_queue</span><span style=color:#61676ccc>: </span><span>Res&LTRenderQueue>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>prepare_system</span><span style=color:#61676ccc>: </span><span>ResMut<</span><span style=color:#fa6e32>Self</span><span>>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>events</span><span style=color:#61676ccc>: </span><span>EventReader&LTAssetEvent&LTA>>,
</span><span>) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Simplified direct preparation path
</span><span>    </span><span style=color:#fa6e32>let</span><span> prepared_asset </span><span style=color:#ed9366>= </span><span>A</span><span style=color:#ed9366>::</span><span>prepare_asset(asset</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>render_device</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>render_queue)</span><span style=color:#61676ccc>;
</span><span>    prepare_system</span><span style=color:#ed9366>.</span><span>prepared_assets</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(</span><span style=color:#ed9366>*</span><span>id</span><span style=color:#61676ccc>,</span><span> prepared_asset)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>The changes remove approximately 14 lines of conditional caching logic while restoring 7 lines of straightforward preparation code. This directly addresses the regression by eliminating the problematic caching layer that caused premature asset disposal.<h2 id=further-reading>Further Reading</h2><ol><li>Bevy Render Asset Documentation:<br> https://docs.rs/bevy_render/latest/bevy_render/render_asset/trait.RenderAsset.html<li>Rust Ownership and Memory Management:<br> https://doc.rust-lang.org/book/ch04-00-understanding-ownership.html<li>GPU Resource Lifetime Management in ECS:<br> https://github.com/bevyengine/bevy/discussions/3972<li>Original Memory Leak Issue:<br> https://github.com/bevyengine/bevy/issues/18822</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-04/pr_18845.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>