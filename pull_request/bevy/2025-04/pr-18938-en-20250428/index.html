<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18938 Fully qualify crate paths in `BevyManifest`
        
    </title><meta content="#18938 Fully qualify crate paths in `BevyManifest`" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-04/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-04-28</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-04/pr-18938-zh-cn-20250428>中文</a></div></div><div class=pr-content><h1 id=title-fully-qualify-crate-paths-in-bevymanifest>Title: Fully qualify crate paths in <code>BevyManifest</code></h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fully qualify crate paths in <code>BevyManifest</code><li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18938<li><strong>Author</strong>: jnhyatt<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, S-Ready-For-Final-Review, A-Utils<li><strong>Created</strong>: 2025-04-25T20:35:43Z<li><strong>Merged</strong>: 2025-04-28T22:04:16Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Subtle, very minor issue. The following code fails to compile on main:<pre class=language-rs data-lang=rs style=color:#61676c;background-color:#fafafa><code class=language-rs data-lang=rs><span style=color:#fa6e32>struct </span><span style=color:#399ee6>bevy</span><span style=color:#61676ccc>;
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(::bevy::ecs::component::Component)]
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>MyComponent</span><span style=color:#61676ccc>;
</span></code></pre><p>The derive proc macro is pasting in essentially:<pre class=language-rs data-lang=rs style=color:#61676c;background-color:#fafafa><code class=language-rs data-lang=rs><span style=color:#fa6e32>impl </span><span>bevy</span><span style=color:#ed9366>::</span><span>ecs</span><span style=color:#ed9366>::</span><span>component</span><span style=color:#ed9366>::</span><span>Component </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>MyComponent
</span></code></pre><p>…which normally works, but I’ve added <code>struct bevy</code>, which makes the proc macro spit out incorrect code.<p>Very cursed, but to my knowledge has never been encountered in practice. All the same, it’s technically incorrect and should be fixed.<h2 id=solution>Solution</h2><p>The solution is simply to prepend <code>::</code> to crate names. Specifically, all (all?) Bevy’s derive macros determine the root crate name using <code>BevyManifest</code>, which does some toml-parsing witchcraft to figure out whether to qualify names using the umbrella <code>bevy</code> crate or individual <code>bevy_xxx</code> crates. I just added a <code>::</code> to the spot where we parse the <code>syn::Path</code>. The above example compiles properly after that.<h2 id=testing>Testing</h2><ul><li>CI should catch any errors since this change should cause compile errors if for some reason they’re being used in a cursed way somewhere that would make this break something.</ul><h2 id=note>Note</h2><p>If this does break something for someone, this <em>really</em> needs a comment in <code>BevyManifest::maybe_get_path</code> explaining why we can’t make this change.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The PR addresses a subtle namespace collision issue in Bevy’s derive macro implementation. The core problem emerged when a user-defined type named <code>bevy</code> would conflict with Bevy’s proc macro-generated code paths. While rare in practice, this edge case exposed a technical flaw in how the framework resolved crate paths during macro expansion.<p>Bevy’s derive macros use the <code>BevyManifest</code> utility to determine correct crate paths. The original implementation constructed paths using relative identifiers, which worked under normal circumstances but failed when local symbols shadowed crate names. The key issue manifested in code generation where <code>impl bevy::ecs...</code> would incorrectly reference a local <code>bevy</code> struct instead of the actual Bevy crate.<p>The solution focused on making path resolution unambiguous through absolute crate paths. By modifying the path construction in <code>BevyManifest</code> to prefix crate names with <code>::</code>, the macro-generated code now explicitly references the root-level crate. This change required precisely one character addition in the path formatting logic but fundamentally altered the path resolution semantics.<p>The implementation change demonstrates several important Rust concepts:<ol><li><strong>Absolute vs Relative Paths</strong>: The <code>::</code> prefix ensures path resolution starts from the crate root<li><strong>Macro Hygiene</strong>: While procedural macros can’t be fully hygienic, this change improves resilience against local symbol collisions<li><strong>Crate Resolution</strong>: Highlights how Bevy’s modular architecture handles umbrella crate vs individual subcrate usage</ol><p>The primary code modification occurs in <code>bevy_manifest.rs</code> where the crate path generation now includes an absolute path qualifier. This change propagates through all Bevy’s derive macros (Component, Resource, etc.), making their generated code more robust against namespace collisions.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Derive Macro] --> B[BevyManifest]
</span><span>    B --> C[Path Resolution]
</span><span>    C --> D{Local Scope}
</span><span>    D -->|With :: prefix| E[Correct Crate Reference]
</span><span>    D -->|Without :: prefix| F[Potential Local Conflict]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ul><li><code>crates/bevy_macro_utils/src/bevy_manifest.rs</code> (+1/-1)</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let mut</span><span> path </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>parse_str</span><span style=color:#ed9366>::</span><span>&LTsyn</span><span style=color:#ed9366>::</span><span>Path>(package)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let mut</span><span> path </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>parse_str</span><span style=color:#ed9366>::</span><span>&LTsyn</span><span style=color:#ed9366>::</span><span>Path>(</span><span style=color:#ed9366>&</span><span style=color:#f07171>format!</span><span>(</span><span style=color:#86b300>"::</span><span style=color:#ff8f40>{}</span><span style=color:#86b300>"</span><span style=color:#61676ccc>,</span><span> package))</span><span style=color:#61676ccc>;
</span></code></pre><p>This change modifies how Bevy’s macro system constructs crate paths. By formatting the package name with a leading <code>::</code>, the generated paths become absolute rather than relative. This prevents namespace collisions with locally defined items that might shadow crate names.<h2 id=further-reading>Further Reading</h2><ol><li>Rust Reference on Paths: https://doc.rust-lang.org/reference/paths.html<li>Bevy’s Macro Utilities Documentation: https://docs.rs/bevy_macro_utils/latest/bevy_macro_utils/<li>Rust Proc Macro Workshop: https://github.com/dtolnay/proc-macro-workshop<li>Bevy Engine Architecture Guide: https://bevyengine.org/learn/book/introduction/architecture/</ol><h1 id=full-code-diff>Full Code Diff</h1><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_macro_utils/src/bevy_manifest.rs b/crates/bevy_macro_utils/src/bevy_manifest.rs
</span><span>index b0d321ba2215c..8d327810695a9 100644
</span><span style=color:#c594c5>--- a/crates/bevy_macro_utils/src/bevy_manifest.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_macro_utils/src/bevy_manifest.rs
</span><span style=color:#c594c5>@@ -95,7 +95,7 @@ </span><span style=color:#399ee6>impl BevyManifest {
</span><span>                 return None;
</span><span>             };
</span><span> 
</span><span style=color:#f07171>-            let mut path = Self::parse_str::&LTsyn::Path>(package);
</span><span style=color:#86b300>+            let mut path = Self::parse_str::&LTsyn::Path>(&format!("::{}", package));
</span><span>             if let Some(module) = name.strip_prefix("bevy_") {
</span><span>                 path.segments.push(Self::parse_str(module));
</span><span>             }
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-04/pr_18938.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>