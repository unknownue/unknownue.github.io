<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18907 Add a method to clear all related entity to `EntityCommands` and friends
        
    </title><meta content="#18907 Add a method to clear all related entity to `EntityCommands` and friends" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-04/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-04-30</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-04/pr-18907-zh-cn-20250430>中文</a></div></div><div class=pr-content><h1 id=add-a-method-to-clear-all-related-entity-to-entitycommands-and-friends>Add a method to clear all related entity to <code>EntityCommands</code> and friends</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Add a method to clear all related entity to <code>EntityCommands</code> and friends<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18907<li><strong>Author</strong>: Brezak<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-ECS, C-Usability, S-Ready-For-Final-Review, X-Uncontroversial, D-Straightforward<li><strong>Created</strong>: 2025-04-23T16:33:24Z<li><strong>Merged</strong>: 2025-04-30T21:20:49Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>We have methods to:<ul><li>Add related entities<li>Replace related entities<li>Remove specific related entities</ul><p>We don’t have a method the remove all related entities so.<h2 id=solution>Solution</h2><p>Add a method to remove all related entities.<h2 id=testing>Testing</h2><p>A new test case.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The PR addresses a gap in Bevy’s Entity Component System (ECS) API for managing entity relationships. While existing methods allowed adding, replacing, and removing specific related entities, there was no straightforward way to clear all relationships at once. This missing functionality forced developers to manually track and remove individual relationships, creating potential for errors and inefficiency in systems managing complex entity hierarchies.<p>The solution introduces a <code>clear_related</code> method that works with Bevy’s relationship system through two primary components:<ol><li><strong>Core Implementation</strong> in <code>related_methods.rs</code>:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// EntityWorldMut implementation
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>clear_related</span><span>&LTR</span><span style=color:#61676ccc>:</span><span> Relationship>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut Self </span><span>{
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>remove</span><span style=color:#ed9366>::</span><span><</span><span style=color:#fa6e32>R</span><span style=color:#ed9366>::</span><span>RelationshipTarget>()
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// EntityCommands implementation
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>clear_related</span><span>&LTR</span><span style=color:#61676ccc>:</span><span> Relationship>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut Self </span><span>{
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>queue</span><span>(|</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>entity</span><span style=color:#61676ccc>:</span><span> EntityWorldMut| {
</span><span>        entity</span><span style=color:#ed9366>.</span><span>clear_related</span><span style=color:#ed9366>::</span><span>&LTR>()</span><span style=color:#61676ccc>;
</span><span>    })
</span><span>}
</span></code></pre><p>This generic approach removes the relationship target component entirely, effectively clearing all related entities in one operation. The implementation follows Bevy’s established pattern for relationship management, ensuring consistency with existing APIs.<ol start=2><li><strong>Hierarchy Specialization</strong> in <code>hierarchy.rs</code>:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added to both EntityWorldMut and EntityCommands
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>clear_children</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut Self </span><span>{
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>clear_related</span><span style=color:#ed9366>::</span><span>&LTChildOf>()
</span><span>}
</span></code></pre><p>This child-specific method provides a more discoverable API for common parent-child relationships while leveraging the underlying generic implementation.<p>The test case verifies the complete removal of relationship components:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>remove_all_related</span><span>() {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> world </span><span style=color:#ed9366>= </span><span>World</span><span style=color:#ed9366>::</span><span>new()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> a </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn_empty</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>id</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> b </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>(ChildOf(a))</span><span style=color:#ed9366>.</span><span style=color:#f07171>id</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> c </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>(ChildOf(a))</span><span style=color:#ed9366>.</span><span style=color:#f07171>id</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span>    world</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity_mut</span><span>(a)</span><span style=color:#ed9366>.</span><span>clear_related</span><span style=color:#ed9366>::</span><span>&LTChildOf>()</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#f07171>assert_eq!</span><span>(world</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(a)</span><span style=color:#ed9366>.</span><span>get</span><span style=color:#ed9366>::</span><span>&LTChildren>()</span><span style=color:#61676ccc>, </span><span style=color:#55b4d4;font-style:italic>None</span><span>)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#f07171>assert_eq!</span><span>(world</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(b)</span><span style=color:#ed9366>.</span><span>get</span><span style=color:#ed9366>::</span><span>&LTChildOf>()</span><span style=color:#61676ccc>, </span><span style=color:#55b4d4;font-style:italic>None</span><span>)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#f07171>assert_eq!</span><span>(world</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(c)</span><span style=color:#ed9366>.</span><span>get</span><span style=color:#ed9366>::</span><span>&LTChildOf>()</span><span style=color:#61676ccc>, </span><span style=color:#55b4d4;font-style:italic>None</span><span>)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>This test confirms that clearing relationships removes both the parent’s <code>Children</code> component and the children’s <code>ChildOf</code> components, ensuring complete relationship dissolution.<p>The implementation maintains Bevy’s ECS performance characteristics by using component removal rather than iterative deletion. This approach leverages the engine’s existing infrastructure for bulk component operations, making it efficient even for entities with large numbers of relationships.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[EntityCommands] --> B[clear_related]
</span><span>    A --> C[clear_children]
</span><span>    B --> D[EntityWorldMut.clear_related]
</span><span>    C --> D
</span><span>    D --> E[Remove RelationshipTarget component]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ol><li><strong>crates/bevy_ecs/src/relationship/related_methods.rs</strong> (+27/-0)</ol><ul><li>Added <code>clear_related</code> method to both <code>EntityWorldMut</code> and <code>EntityCommands</code><li>Implements core relationship clearing logic through component removal<li>Follows existing pattern from other relationship methods</ul><ol start=2><li><strong>crates/bevy_ecs/src/hierarchy.rs</strong> (+12/-0)</ol><ul><li>Added <code>clear_children</code> convenience methods<li>Specializes the generic <code>clear_related</code> for parent-child relationships<li>Maintains API consistency with existing hierarchy methods</ul><h2 id=further-reading>Further Reading</h2><ul><li>Bevy ECS Relationships Guide: [https://bevyengine.org/learn/book/ecs-relationships/]<li>Component Removal Documentation: <code>bevy_ecs::world::EntityMut::remove</code><li>EntityCommands Pattern: <code>bevy_ecs::system::EntityCommands</code></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-04/pr_18907.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>