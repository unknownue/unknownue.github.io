<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18836 Make sure the mesh actually exists before we try to specialize
        
    </title><meta content="#18836 Make sure the mesh actually exists before we try to specialize" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-04/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-04-14</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-04/pr-18836-zh-cn-20250414>中文</a></div></div><div class=pr-content><h1 id=title-make-sure-the-mesh-actually-exists-before-we-try-to-specialize>Title: Make sure the mesh actually exists before we try to specialize</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Make sure the mesh actually exists before we try to specialize.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18836<li><strong>Author</strong>: tychedelia<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-04-13T22:47:03Z<li><strong>Merged</strong>: 2025-04-14T19:26:38Z<li><strong>Merged By</strong>: superdump</ul><h2 id=description-translation>Description Translation</h2><p>Fixes #18809 Fixes #18823<p>Meshes despawned in <code>Last</code> can still be in visible entities if they were visible as of <code>PostUpdate</code>. Sanity check that the mesh actually exists before we specialize. We still want to unconditionally assume that the entity is in <code>EntitySpecializationTicks</code> as its absence from that cache would likely suggest another bug.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=the-problem-and-context>The Problem and Context</h3><p>The rendering system faced race conditions when handling mesh assets that were scheduled for removal. Entities marked as visible during <code>PostUpdate</code> could still reference meshes that were despawned in the <code>Last</code> schedule. This led to panics when specialization systems attempted to process non-existent meshes, as seen in issues #18809 and #18823.<p>The core challenge stemmed from the temporal gap between visibility determination and mesh specialization. Visibility states from <code>PostUpdate</code> could reference meshes that were removed before rendering commands were prepared, creating a window where invalid mesh handles could be processed.<h3 id=the-solution-approach>The Solution Approach</h3><p>The fix introduces a defensive check before mesh specialization. Rather than assuming mesh existence based on visibility state alone, the implementation now verifies actual mesh availability through the asset system. This approach maintains the existing specialization tick checks while adding a crucial existence verification layer.<p>Key engineering decisions:<ol><li>Perform asset existence check after tick comparison to maintain optimization<li>Preserve original error handling for missing specialization data<li>Apply consistent pattern across all material specialization systems</ol><h3 id=the-implementation>The Implementation</h3><p>The solution modifies mesh specialization flows across multiple rendering systems. Each affected system now follows this pattern:<ol><li>Retrieve mesh handle from entity<li>Check if mesh exists in asset system<li>Only proceed with specialization if mesh is available</ol><p>Example from <code>light.rs</code>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> mesh_handle </span><span style=color:#ed9366>=</span><span> mesh_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(item</span><span style=color:#ed9366>.</span><span>entity)</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(mesh) </span><span style=color:#ed9366>=</span><span> render_meshes</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(mesh_handle) </span><span style=color:#fa6e32>else </span><span>{
</span><span>    </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>}</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(mesh_handle) </span><span style=color:#ed9366>=</span><span> mesh_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(item</span><span style=color:#ed9366>.</span><span>entity) </span><span style=color:#fa6e32>else </span><span>{
</span><span>    </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>}</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(mesh) </span><span style=color:#ed9366>=</span><span> render_meshes</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(mesh_handle) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Specialization logic remains here
</span><span>}
</span></code></pre><p>This change appears consistently across:<ul><li>PBR material handling<li>Light systems<li>Prepass pipelines<li>Wireframe rendering<li>2D sprite materials</ul><h3 id=technical-insights>Technical Insights</h3><p>The implementation leverages Bevy’s asset system as a source of truth for resource availability. Key technical points:<ol><li><strong>Asset Validation</strong>: Uses <code>Assets::get</code> check for mesh existence<li><strong>Error Handling</strong>: Maintains <code>continue</code> pattern for early exit<li><strong>System Ordering</strong>: Respects Bevy’s schedule ordering where: <ul><li>Visibility runs in <code>PostUpdate</code><li>Mesh removal happens in <code>Last</code><li>Rendering systems run in <code>Render</code> schedule</ul></ol><p>The check acts as a guard clause against stale visibility state references, preventing attempts to specialize using destroyed mesh assets.<h3 id=the-impact>The Impact</h3><p>These changes:<ol><li>Prevent crashes from null mesh references<li>Maintain rendering system stability during asset hot-reloading<li>Add minimal performance overhead (single hashmap lookup)<li>Fix race conditions between asset removal and rendering prep</ol><p>The solution demonstrates effective defensive programming in ECS systems, particularly important when dealing with frame-delayed visibility states and asset lifecycle management.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[PostUpdate Visibility Determination] --> B[Last Schedule Mesh Despawn]
</span><span>    B --> C[Render Schedule Processing]
</span><span>    C --> D{Mesh Exists?}
</span><span>    D -->|Yes| E[Specialize Mesh]
</span><span>    D -->|No| F[Skip Entity]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ol><li><strong>crates/bevy_pbr/src/render/light.rs</strong> (+5/-5)</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Key change:
</span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(mesh) </span><span style=color:#ed9366>=</span><span> meshes</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(mesh_handle) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Specialization logic moved inside this block
</span><span>}
</span></code></pre><p>Adds mesh existence check before light mesh specialization<ol start=2><li><strong>crates/bevy_pbr/src/material.rs</strong> (+4/-4)</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(mesh_handle) </span><span style=color:#ed9366>=</span><span> mesh_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(entity) </span><span style=color:#fa6e32>else </span><span>{ </span><span style=color:#fa6e32>continue </span><span>}</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(mesh) </span><span style=color:#ed9366>=</span><span> render_meshes</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(mesh_handle) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Moved material specialization inside
</span><span>}
</span></code></pre><p>Guards PBR material specialization with mesh check<ol start=3><li><strong>crates/bevy_pbr/src/prepass/mod.rs</strong> (+4/-4)</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(mesh_handle) </span><span style=color:#ed9366>=</span><span> mesh_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(entity) </span><span style=color:#fa6e32>else </span><span>{ </span><span style=color:#fa6e32>continue </span><span>}</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(mesh) </span><span style=color:#ed9366>=</span><span> render_meshes</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(mesh_handle) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Prepass specialization now nested
</span><span>}
</span></code></pre><p>Applies same pattern to prepass rendering<ol start=4><li><strong>crates/bevy_sprite/src/mesh2d/material.rs</strong> (+3/-3)</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(mesh_handle) </span><span style=color:#ed9366>=</span><span> mesh_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(entity) </span><span style=color:#fa6e32>else </span><span>{ </span><span style=color:#fa6e32>continue </span><span>}</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(mesh) </span><span style=color:#ed9366>=</span><span> meshes</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(mesh_handle) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 2D material specialization protected
</span><span>}
</span></code></pre><p>Extends fix to 2D rendering systems<h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/getting-started/ecs/#system-schedule target=_blank>Bevy ECS Schedules</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/assets/ target=_blank>Asset Handling in Bevy</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/crates/bevy_pbr/src/render/mod.rs#L49-L67 target=_blank>Render Preparation Architecture</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-04/pr_18836.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>