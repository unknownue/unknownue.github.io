<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18769 Allowlist mali drivers for gpu preprocessing support
        
    </title><meta content="#18769 Allowlist mali drivers for gpu preprocessing support" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-04/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-04-11</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-04/pr-18769-zh-cn-20250411>中文</a></div></div><div class=pr-content><h1 id=allowlist-mali-drivers-for-gpu-preprocessing-support>Allowlist mali drivers for gpu preprocessing support</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Allowlist mali drivers for gpu preprocessing support<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18769<li><strong>Author</strong>: tychedelia<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, O-Android, S-Needs-Review<li><strong>Created</strong>: 2025-04-08T20:55:51Z<li><strong>Merged</strong>: 2025-04-11T00:22:43Z<li><strong>Merged By</strong>: superdump</ul><h2 id=description-translation>Description Translation</h2><p>Fixes #17591<p>Looking at the arm downloads page, “r48p0” is a version number that increments, where rXX is the major version and pX seems to be a patch version. Take the conservative approach here that we know gpu preprocessing is working on at least version 48 and presumably higher. The assumption here is that the driver_info string will be reported similarly on non-pixel devices.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=the-problem-and-context>The Problem and Context</h3><p>Android devices using Mali GPUs experienced crashes when enabling GPU preprocessing features like mipmap generation. The root cause was Bevy’s graphics pipeline attempting to use preprocessing capabilities on Mali drivers that didn’t properly support the required features. This particularly affected newer Android devices where preprocessing could provide significant performance benefits if properly supported.<h3 id=the-solution-approach>The Solution Approach</h3><p>The implementation strategy focused on:<ol><li>Creating precise driver version detection for Mali GPUs<li>Establishing a minimum supported version (r48p0) based on ARM’s release documentation<li>Integrating version checks into existing feature enablement logic</ol><p>The team chose conservative version checking rather than blanket enablement for all Mali drivers, prioritizing stability over potential false positives.<h3 id=the-implementation>The Implementation</h3><p>The core changes occurred in driver detection and feature gating:<p><strong>Driver Version Parsing (bevy_render/src/batching/gpu_preprocessing.rs)</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>fn </span><span style=color:#f29718>mali_version_supported</span><span>(</span><span style=color:#ff8f40>driver_info</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>str</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>bool </span><span>{
</span><span>    </span><span style=color:#fa6e32>let</span><span> regex </span><span style=color:#ed9366>= </span><span>Regex</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#fa6e32>r</span><span style=color:#86b300>"r(\d+)p"</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span><span>    regex</span><span style=color:#ed9366>.</span><span style=color:#f07171>captures</span><span>(driver_info)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>and_then</span><span>(|</span><span style=color:#ff8f40>captures</span><span>| captures</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#ff8f40>1</span><span>))
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>and_then</span><span>(|</span><span style=color:#ff8f40>major</span><span>| major</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_str</span><span>()</span><span style=color:#ed9366>.</span><span>parse</span><span style=color:#ed9366>::</span><span><</span><span style=color:#fa6e32>u32</span><span>>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>ok</span><span>())
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|</span><span style=color:#ff8f40>major</span><span>| major </span><span style=color:#ed9366>>= </span><span style=color:#ff8f40>48</span><span>)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_or</span><span>(</span><span style=color:#ff8f40>false</span><span>)
</span><span>}
</span></code></pre><p>This regex-based parser extracts the major version from Mali driver strings like “Mali-G710 r47p0”. The version comparison ensures we only enable features on drivers >= r48.<p><strong>Feature Gating (bevy_core_pipeline/src/experimental/mip_generation/mod.rs)</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let</span><span> supports_mip_generation </span><span style=color:#ed9366>=</span><span> render_device
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>features</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>contains</span><span>(WgpuFeatures</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>MIP_MAP_GENERATION</span><span>)
</span><span>    </span><span style=color:#ed9366>|| </span><span>(</span><span style=color:#f07171>cfg!</span><span>(</span><span style=color:#f07171>all</span><span>(target_os </span><span style=color:#ed9366>= </span><span style=color:#86b300>"android"</span><span style=color:#61676ccc>,</span><span> target_arch </span><span style=color:#ed9366>= </span><span style=color:#86b300>"aarch64"</span><span>))
</span><span>        </span><span style=color:#ed9366>&& </span><span style=color:#f07171>is_mali</span><span>(render_device</span><span style=color:#ed9366>.</span><span style=color:#f07171>vendor</span><span>()</span><span style=color:#61676ccc>,</span><span> render_device</span><span style=color:#ed9366>.</span><span style=color:#f07171>driver_info</span><span>())
</span><span>        </span><span style=color:#ed9366>&& </span><span style=color:#f07171>mali_version_supported</span><span>(render_device</span><span style=color:#ed9366>.</span><span style=color:#f07171>driver_info</span><span>())</span><span style=color:#61676ccc>;
</span></code></pre><p>The updated logic adds explicit Mali version checking alongside existing feature detection, creating three enablement criteria:<ol><li>Native WGPU feature support<li>ARM64 Android platform<li>Supported Mali driver version</ol><h3 id=technical-insights>Technical Insights</h3><p>Key implementation details:<ul><li><strong>Version String Analysis</strong>: Mali drivers use format “rXXpY” where XX=major version<li><strong>Defensive Parsing</strong>: The regex captures only major version to avoid parse failures<li><strong>Platform Targeting</strong>: Specific to Android ARM64 devices where Mali GPUs are common<li><strong>Fallback Behavior</strong>: Unparseable versions default to unsupported status</ul><p>Testing considerations:<ul><li>Physical device testing impractical due to Android hardware diversity<li>Reliance on ARM’s versioning documentation for cutoff determination<li>Conservative version selection to minimize regression risk</ul><h3 id=the-impact>The Impact</h3><p>These changes:<ul><li>Enable GPU preprocessing on supported Mali devices<li>Prevent crashes on older Mali drivers<li>Maintain feature availability on other compatible hardware<li>Add structured driver version parsing for future maintenance</ul><p>Mobile developers using Bevy with Mali GPUs now get automatic performance improvements where supported, while avoiding instability on older drivers.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[GPU Preprocessing System] --> B{Check Device Support}
</span><span>    B --> C[WGPU Features]
</span><span>    B --> D[Android Platform Check]
</span><span>    B --> E[Mali Driver Check]
</span><span>    E --> F[Version >= r48]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ol><li><strong>crates/bevy_render/src/batching/gpu_preprocessing.rs</strong> (+20/-6)</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added Mali version check
</span><span style=color:#ed9366>+</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>mali_version_supported</span><span>(</span><span style=color:#ff8f40>driver_info</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>str</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>bool </span><span>{
</span><span style=color:#ed9366>+    </span><span style=color:#fa6e32>let</span><span> regex </span><span style=color:#ed9366>= </span><span>Regex</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#fa6e32>r</span><span style=color:#86b300>"r(\d+)p"</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#ed9366>+</span><span>    regex</span><span style=color:#ed9366>.</span><span style=color:#f07171>captures</span><span>(driver_info)
</span><span style=color:#ed9366>+        .</span><span style=color:#f07171>and_then</span><span>(|</span><span style=color:#ff8f40>captures</span><span>| captures</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#ff8f40>1</span><span>))
</span><span style=color:#ed9366>+        </span><span style=color:#abb0b6;font-style:italic>// ... version parsing logic
</span><span style=color:#ed9366>+</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Updated feature check
</span><span style=color:#ed9366>-</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>needs_gpu_preprocessing</span><span>(...) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>bool </span><span>{
</span><span style=color:#ed9366>+</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>needs_gpu_preprocessing</span><span>(..., </span><span style=color:#ff8f40>driver_info</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>str</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>bool </span><span>{
</span><span>     </span><span style=color:#abb0b6;font-style:italic>// Added Mali check
</span><span style=color:#ed9366>+    </span><span style=color:#f07171>is_mali</span><span>(vendor</span><span style=color:#61676ccc>,</span><span> driver_info) </span><span style=color:#ed9366>&& </span><span style=color:#f07171>mali_version_supported</span><span>(driver_info)
</span></code></pre><ol start=2><li><strong>crates/bevy_core_pipeline/src/experimental/mip_generation/mod.rs</strong> (+12/-24)</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Simplified mip generation check
</span><span style=color:#ed9366>-</span><span style=color:#fa6e32>let </span><span>(supports_mip_generation</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>..</span><span>) </span><span style=color:#ed9366>= ...
</span><span style=color:#ed9366>+</span><span style=color:#fa6e32>let</span><span> supports_mip_generation </span><span style=color:#ed9366>= </span><span style=color:#abb0b6;font-style:italic>/* integrated Mali check */</span><span style=color:#61676ccc>;
</span></code></pre><ol start=3><li><strong>crates/bevy_render/src/lib.rs</strong> (+23/-0)</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added driver info module
</span><span style=color:#ed9366>+</span><span style=color:#fa6e32>pub mod </span><span style=color:#399ee6>driver_info </span><span>{
</span><span style=color:#ed9366>+    </span><span style=color:#abb0b6;font-style:italic>// Contains shared driver detection utilities
</span><span style=color:#ed9366>+    </span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>is_mali</span><span>(</span><span style=color:#ff8f40>vendor</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u32</span><span>, </span><span style=color:#ff8f40>driver_info</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>str</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>bool </span><span>{
</span><span style=color:#ed9366>+</span><span>        vendor </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0x13B5 </span><span style=color:#abb0b6;font-style:italic>/* ARM PCI ID */ </span><span style=color:#ed9366>|| 
</span><span style=color:#ed9366>+</span><span>        driver_info</span><span style=color:#ed9366>.</span><span style=color:#f07171>contains</span><span>(</span><span style=color:#86b300>"Mali"</span><span>)
</span><span style=color:#ed9366>+    </span><span>}
</span><span style=color:#ed9366>+</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://developer.arm.com/documentation/ka005184/latest target=_blank>ARM Mali Driver Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://wgpu.rs/features.html target=_blank>WGpu Features Matrix</a><li><a rel="noopener nofollow noreferrer" href=https://registry.khronos.org/OpenGL/xml/gl.xml target=_blank>Android GPU Vendor IDs</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-04/pr_18769.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>