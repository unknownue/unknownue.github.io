<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18814 Mark render assets as modified when removed from the asset server
        
    </title><meta content="#18814 Mark render assets as modified when removed from the asset server" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-04/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-04-12</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-04/pr-18814-zh-cn-20250411>中文</a></div></div><div class=pr-content><h1 id=mark-render-assets-as-modified-when-removed-from-the-asset-server>Mark render assets as modified when removed from the asset server</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Mark render assets as modified when removed from the asset server<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18814<li><strong>Author</strong>: tychedelia<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, S-Needs-Review<li><strong>Created</strong>: 2025-04-11T19:39:07Z<li><strong>Merged</strong>: 2025-04-11T23:35:39Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Fixes #18808<h2 id=solution>Solution</h2><p>When an asset emits a removed event, mark it as modified in the render world to ensure any appropriate bookkeeping runs as necessary.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The PR addresses a subtle bug in Bevy’s render asset management where removing assets didn’t trigger necessary updates in the render world. This could leave dangling references or prevent proper resource cleanup. The core issue stemmed from how asset removal events were handled differently from modification events in the rendering pipeline.<p>In Bevy’s ECS architecture, render assets maintain three tracking sets:<ol><li><code>added</code> - Newly created assets<li><code>modified</code> - Changed assets needing updates<li><code>removed</code> - Assets scheduled for deletion</ol><p>The existing implementation in <code>render_asset.rs</code> only populated the <code>modified</code> set when assets were added or changed, but not when they were removed. This meant systems relying on <code>modified</code> to trigger cleanup operations wouldn’t execute when assets were removed.<p>The solution modifies the event handling logic to treat removed assets as modified. This ensures existing systems that process modified assets will handle removal cleanup without requiring separate removal handling. The key change occurs in the <code>track_asset_events</code> function:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before
</span><span style=color:#fa6e32>for</span><span> event </span><span style=color:#ed9366>in</span><span> events</span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>() {
</span><span>    </span><span style=color:#fa6e32>match</span><span> event {
</span><span>        AssetEvent</span><span style=color:#ed9366>::</span><span>Added { id } </span><span style=color:#ed9366>=> </span><span>{
</span><span>            added</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(</span><span style=color:#ed9366>*</span><span>id)</span><span style=color:#61676ccc>;
</span><span>            modified</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(</span><span style=color:#ed9366>*</span><span>id)</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>        AssetEvent</span><span style=color:#ed9366>::</span><span>Modified { id } </span><span style=color:#ed9366>=> </span><span>{
</span><span>            modified</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(</span><span style=color:#ed9366>*</span><span>id)</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>        AssetEvent</span><span style=color:#ed9366>::</span><span>Removed { id } </span><span style=color:#ed9366>=> </span><span>{
</span><span>            removed</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(</span><span style=color:#ed9366>*</span><span>id)</span><span style=color:#61676ccc>;
</span><span>            </span><span style=color:#abb0b6;font-style:italic>// Missing modified.insert(*id)
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After
</span><span>AssetEvent</span><span style=color:#ed9366>::</span><span>Removed { id } </span><span style=color:#ed9366>=> </span><span>{
</span><span>    removed</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(</span><span style=color:#ed9366>*</span><span>id)</span><span style=color:#61676ccc>;
</span><span>    modified</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(</span><span style=color:#ed9366>*</span><span>id)</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// Added line
</span><span>}
</span></code></pre><p>By adding the <code>modified.insert(*id)</code> call for removed assets, the implementation leverages existing modification handling pathways to process removals. This approach maintains the system’s efficiency while fixing the cleanup issue with minimal code changes.<p>The technical insight here is that render asset cleanup often needs similar operations to modification handling (e.g., releasing GPU resources). Treating removals as modifications allows reuse of existing update logic rather than creating parallel removal-handling systems. This decision keeps the codebase maintainable while ensuring consistent resource management.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[AssetEvent::Removed] --> B[track_asset_events]
</span><span>    B --> C[modified.insert(id)]
</span><span>    C --> D[Render Asset Systems]
</span><span>    D --> E[Cleanup Operations]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-render-src-render-asset-rs-14-7><code>crates/bevy_render/src/render_asset.rs</code> (+14/-7)</h3><p><strong>Purpose</strong>: Fix asset removal handling in render world<p>Key modification in <code>track_asset_events</code> function:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before handling of Removed event:
</span><span>AssetEvent</span><span style=color:#ed9366>::</span><span>Removed { id } </span><span style=color:#ed9366>=> </span><span>{
</span><span>    removed</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(</span><span style=color:#ed9366>*</span><span>id)</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Updated implementation:
</span><span>AssetEvent</span><span style=color:#ed9366>::</span><span>Removed { id } </span><span style=color:#ed9366>=> </span><span>{
</span><span>    removed</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(</span><span style=color:#ed9366>*</span><span>id)</span><span style=color:#61676ccc>;
</span><span>    modified</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(</span><span style=color:#ed9366>*</span><span>id)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>This change ensures removed assets are marked as modified, triggering necessary cleanup in systems that process modified assets.<h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/assets/ target=_blank>Bevy Asset System Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/programming/events.html target=_blank>ECS Event Handling Patterns</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/rendering/assets/ target=_blank>Render Asset Management Guide</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-04/pr_18814.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>