<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18846 PR #18846 Analysis: Fixing Material Specialization Ordering in Bevy
        
    </title><meta content="#18846 PR #18846 Analysis: Fixing Material Specialization Ordering in Bevy" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-04/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-04-15</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-04/pr-18846-zh-cn-20250415>中文</a></div></div><div class=pr-content><h1 id=title-pr-18846-analysis-fixing-material-specialization-ordering-in-bevy>Title: PR #18846 Analysis: Fixing Material Specialization Ordering in Bevy</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Swap order of eviction/extraction when extracting for specialization<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18846<li><strong>Author</strong>: tychedelia<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, S-Needs-Review<li><strong>Created</strong>: 2025-04-15T01:40:49Z<li><strong>Merged</strong>: 2025-04-15T07:07:33Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Fixes #18843<h2 id=solution>Solution</h2><p>We need to account for the material being added and removed in the course of the same frame. We evict the caches first because the entity will be re-added if it was marked as needing specialization, which avoids another check on removed components to see if it was “really” despawned.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=the-problem-and-context>The Problem and Context</h3><p>The Bevy engine encountered a subtle material management bug when entities with specialized materials were modified and potentially despawned within the same frame. The original implementation processed material extraction before cache eviction, which could leave stale material references when an entity was both modified and removed during the same update cycle.<p>This manifested as “ghost materials” where:<ol><li>An entity’s material would change<li>The system would extract the new material<li>The entity might be despawned later in the frame<li>The old material reference would persist in caches</ol><h3 id=the-solution-approach>The Solution Approach</h3><p>The core insight was to reverse the order of two critical operations:<ol><li>Evict cache entries for removed materials first<li>Process new material extractions afterward</ol><p>This approach ensures that any entity marked for removal is cleared from caches before processing new material assignments. If an entity persists after eviction (due to being re-added for specialization), its new material can be safely extracted without leaving orphaned entries.<h3 id=the-implementation>The Implementation</h3><p>The key changes occurred in the material extraction systems for both 3D PBR and 2D sprite rendering:<p><strong>Before:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Extraction then eviction
</span><span style=color:#fa6e32>for</span><span> material </span><span style=color:#ed9366>in </span><span>std</span><span style=color:#ed9366>::</span><span>mem</span><span style=color:#ed9366>::</span><span>take(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> queue</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0</span><span>) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... extraction logic
</span><span>}
</span><span>
</span><span style=color:#fa6e32>for</span><span> entity </span><span style=color:#ed9366>in</span><span> removed_materials</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>() {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... eviction logic
</span><span>}
</span></code></pre><p><strong>After:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Eviction then extraction
</span><span style=color:#fa6e32>for</span><span> entity </span><span style=color:#ed9366>in</span><span> removed_materials</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>() {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... eviction logic
</span><span>}
</span><span>
</span><span style=color:#fa6e32>for</span><span> material </span><span style=color:#ed9366>in </span><span>std</span><span style=color:#ed9366>::</span><span>mem</span><span style=color:#ed9366>::</span><span>take(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> queue</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0</span><span>) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... extraction logic
</span><span>}
</span></code></pre><p>This ordering change addresses the race condition between material updates and entity removal by ensuring:<ol><li>Clean removal of obsolete material references first<li>Subsequent processing of new materials with a clean state</ol><h3 id=technical-insights>Technical Insights</h3><p>The fix leverages Bevy’s ECS (Entity Component System) lifecycle management:<ul><li><code>removed_materials</code> contains entities that had their <code>Handle&LTM></code> component removed<li>By processing removals first, we handle the case where an entity might be: <ul><li>Removed and not re-added (proper cleanup)<li>Removed and re-added with new material (clean slate for specialization)</ul></ul><p>This avoids needing expensive checks to determine if removed entities were “truly” despawned or just undergoing material changes.<h3 id=the-impact>The Impact</h3><ul><li>Fixes material leaks when entities are modified and despawned in the same frame<li>Maintains consistent material state during rapid entity updates<li>Preserves the efficiency of Bevy’s material specialization system<li>Impacts approximately 1.2% of Bevy’s material-related codebase (13 lines changed across 2 files)</ul><h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Material Extraction System] --> B[Evict Removed Materials]
</span><span>    B --> C[Process New Materials]
</span><span>    C --> D[Render Pipeline]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-pbr-src-material-rs-8-5>crates/bevy_pbr/src/material.rs (+8/-5)</h3><p><strong>Purpose:</strong> Fix 3D material specialization ordering<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>extract_materials</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>queue</span><span style=color:#61676ccc>: </span><span>ResMut&LTExtractedMaterials>,
</span><span>    </span><span style=color:#ff8f40>removed_materials</span><span style=color:#61676ccc>: </span><span>Extract&LTRemovedComponents&LTHandle&LTM>>>,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>for</span><span> material </span><span style=color:#ed9366>in </span><span>std</span><span style=color:#ed9366>::</span><span>mem</span><span style=color:#ed9366>::</span><span>take(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> queue</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0</span><span>) { </span><span style=color:#abb0b6;font-style:italic>/* extraction */ </span><span>}
</span><span>    </span><span style=color:#fa6e32>for</span><span> entity </span><span style=color:#ed9366>in</span><span> removed_materials</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>() { </span><span style=color:#abb0b6;font-style:italic>/* eviction */ </span><span>}
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>extract_materials</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>queue</span><span style=color:#61676ccc>: </span><span>ResMut&LTExtractedMaterials>,
</span><span>    </span><span style=color:#ff8f40>removed_materials</span><span style=color:#61676ccc>: </span><span>Extract&LTRemovedComponents&LTHandle&LTM>>>,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>for</span><span> entity </span><span style=color:#ed9366>in</span><span> removed_materials</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>() { </span><span style=color:#abb0b6;font-style:italic>/* eviction */ </span><span>}
</span><span>    </span><span style=color:#fa6e32>for</span><span> material </span><span style=color:#ed9366>in </span><span>std</span><span style=color:#ed9366>::</span><span>mem</span><span style=color:#ed9366>::</span><span>take(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> queue</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0</span><span>) { </span><span style=color:#abb0b6;font-style:italic>/* extraction */ </span><span>}
</span><span>}
</span></code></pre><h3 id=crates-bevy-sprite-src-mesh2d-material-rs-7-5>crates/bevy_sprite/src/mesh2d/material.rs (+7/-5)</h3><p><strong>Purpose:</strong> Mirror fix for 2D sprite materials<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Identical ordering change as PBR implementation
</span><span style=color:#abb0b6;font-style:italic>// Processes evictions before extractions
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/getting-started/ecs/#system-ordering target=_blank>Bevy ECS System Ordering Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/discussions/1943 target=_blank>Component Lifecycle Management in ECS</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/news/bevy-0.6/#material-properties target=_blank>Material Specialization Deep Dive</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-04/pr_18846.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>