<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20911 Run condition error tracks system
        
    </title><meta content="#20911 Run condition error tracks system" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-09/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-09-11</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-09/pr-20911-zh-cn-20250911>中文</a></div></div><div class=pr-content><h1 id=run-condition-error-tracks-system>Run condition error tracks system</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Run condition error tracks system<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20911<li><strong>Author</strong>: janis-bhm<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-ECS, C-Usability, S-Ready-For-Final-Review, X-Uncontroversial, D-Straightforward<li><strong>Created</strong>: 2025-09-06T22:58:34Z<li><strong>Merged</strong>: 2025-09-11T20:17:12Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>fixes #20235<h2 id=solution>Solution</h2><p>add <code>system</code> and <code>on_set</code> fields to RunCondition error context<h2 id=testing>Testing</h2><p>I’ve added a test that checks the correct system is referenced, and whether or not the condition was on a set containing the system. I don’t believe there is a good way of tracking the set itself because sets don’t have names, only type paths, which would also be harder to access where conditions are run.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a debugging issue in Bevy’s ECS system where run condition errors lacked sufficient context. When a run condition failed, the error message only indicated which condition failed, but didn’t specify which system or system set the condition was associated with. This made debugging complex schedules difficult, especially when the same condition was used across multiple systems or sets.<p>The core problem was in the error context structure for run conditions. The original <code>ErrorContext::RunCondition</code> variant only contained the condition name and last run tick:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before
</span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>RunCondition { name</span><span style=color:#61676ccc>,</span><span> last_run } </span><span style=color:#ed9366>=> </span><span>{
</span><span>    </span><span style=color:#f07171>write!</span><span>(f, </span><span style=color:#86b300>"Run condition `</span><span style=color:#ff8f40>{name}</span><span style=color:#86b300>` failed"</span><span>)
</span><span>}
</span></code></pre><p>The solution adds two critical pieces of information to the error context: the system name the condition is attached to, and whether the condition was applied to a system set. This required changes across multiple components of the ECS scheduling system.<p>The implementation follows a consistent pattern across all three executor types (simple, single-threaded, and multi-threaded). Each executor’s condition evaluation function now receives additional parameters:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// After in all executors
</span><span style=color:#fa6e32>unsafe fn </span><span style=color:#f29718>evaluate_and_fold_conditions</span><span>(
</span><span>    </span><span style=color:#ff8f40>conditions</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> [ConditionWithAccess],
</span><span>    </span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>:</span><span> UnsafeWorldCell,
</span><span>    </span><span style=color:#ff8f40>error_handler</span><span style=color:#61676ccc>:</span><span> ErrorHandler,
</span><span>    </span><span style=color:#ff8f40>for_system</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>ScheduleSystem,  </span><span style=color:#abb0b6;font-style:italic>// New parameter
</span><span>    </span><span style=color:#ff8f40>on_set</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>bool</span><span>,                 </span><span style=color:#abb0b6;font-style:italic>// New parameter
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>bool
</span></code></pre><p>When a condition evaluation fails, the error handler now receives the complete context:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Updated error context
</span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>RunCondition {
</span><span>    name</span><span style=color:#61676ccc>,
</span><span>    system</span><span style=color:#61676ccc>,  </span><span style=color:#abb0b6;font-style:italic>// New field
</span><span>    on_set</span><span style=color:#61676ccc>,  </span><span style=color:#abb0b6;font-style:italic>// New field
</span><span>    </span><span style=color:#ed9366>..
</span><span>} </span><span style=color:#ed9366>=> </span><span>{
</span><span>    </span><span style=color:#f07171>write!</span><span>(
</span><span>        f,
</span><span>        </span><span style=color:#86b300>"Run condition `</span><span style=color:#ff8f40>{name}</span><span style=color:#86b300>` failed for</span><span style=color:#ff8f40>{}</span><span style=color:#86b300> system `</span><span style=color:#ff8f40>{system}</span><span style=color:#86b300>`"</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#fa6e32>if </span><span style=color:#ed9366>*</span><span>on_set { </span><span style=color:#86b300>" set containing" </span><span>} </span><span style=color:#fa6e32>else </span><span>{ </span><span style=color:#86b300>"" </span><span>}
</span><span>    )
</span><span>}
</span></code></pre><p>The changes maintain backward compatibility while significantly improving debugging capabilities. The error messages now clearly indicate whether a condition failed on a specific system or on a set containing that system.<p>The testing approach demonstrates practical validation of the feature. The test creates two different scenarios - one with a condition on a system, and another with a condition on a set - and verifies that the error context contains the correct system reference and set flag.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>run_if_error_contains_system</span><span>() {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Test setup with custom error handler
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>my_error_handler</span><span>(</span><span style=color:#ed9366>_</span><span>: BevyError, </span><span style=color:#ff8f40>ctx</span><span style=color:#61676ccc>:</span><span> ErrorContext) {
</span><span>        </span><span style=color:#fa6e32>let</span><span> a </span><span style=color:#ed9366>= </span><span>IntoSystem</span><span style=color:#ed9366>::</span><span>into_system(system_a)</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#fa6e32>let</span><span> b </span><span style=color:#ed9366>= </span><span>IntoSystem</span><span style=color:#ed9366>::</span><span>into_system(system_b)</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#f07171>assert!</span><span>(
</span><span>            </span><span style=color:#f07171>matches!</span><span>(ctx</span><span style=color:#61676ccc>, </span><span>ErrorContext</span><span style=color:#ed9366>::</span><span>RunCondition { system</span><span style=color:#61676ccc>,</span><span> on_set</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>.. </span><span>} 
</span><span>                </span><span style=color:#fa6e32>if </span><span>(on_set </span><span style=color:#ed9366>&&</span><span> system </span><span style=color:#ed9366>==</span><span> b</span><span style=color:#ed9366>.</span><span style=color:#f07171>name</span><span>()) </span><span style=color:#ed9366>|| </span><span>(</span><span style=color:#ed9366>!</span><span>on_set </span><span style=color:#ed9366>&&</span><span> system </span><span style=color:#ed9366>==</span><span> a</span><span style=color:#ed9366>.</span><span style=color:#f07171>name</span><span>()))
</span><span>        )</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><p>This implementation represents a pragmatic solution to the debugging problem. While it doesn’t track the specific set (which would require more complex changes due to sets being identified by type paths rather than names), it provides the essential information needed to pinpoint where a run condition failure occurred.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Run Condition Error] --> B[Error Context]
</span><span>    B --> C[Condition Name]
</span><span>    B --> D[Last Run Tick]
</span><span>    B --> E[System Name]
</span><span>    B --> F[On Set Flag]
</span><span>    
</span><span>    G[Executor] --> H[Simple Executor]
</span><span>    G --> I[Single Threaded Executor]
</span><span>    G --> J[Multi Threaded Executor]
</span><span>    
</span><span>    H --> K[Condition Evaluation]
</span><span>    I --> K
</span><span>    J --> K
</span><span>    
</span><span>    K --> B
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ecs-src-error-handler-rs-15-2><code>crates/bevy_ecs/src/error/handler.rs</code> (+15/-2)</h3><p>This file defines the error context structure. The changes add two new fields to the RunCondition variant and update the display formatting to include the system context.<p><strong>Before:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub enum </span><span style=color:#399ee6>ErrorContext </span><span>{
</span><span>    RunCondition {
</span><span>        name</span><span style=color:#61676ccc>:</span><span> DebugName</span><span style=color:#61676ccc>,
</span><span>        last_run</span><span style=color:#61676ccc>:</span><span> Tick</span><span style=color:#61676ccc>,
</span><span>    }</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other variants
</span><span>}
</span></code></pre><p><strong>After:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub enum </span><span style=color:#399ee6>ErrorContext </span><span>{
</span><span>    RunCondition {
</span><span>        name</span><span style=color:#61676ccc>:</span><span> DebugName</span><span style=color:#61676ccc>,
</span><span>        last_run</span><span style=color:#61676ccc>:</span><span> Tick</span><span style=color:#61676ccc>,
</span><span>        system</span><span style=color:#61676ccc>:</span><span> DebugName</span><span style=color:#61676ccc>,  </span><span style=color:#abb0b6;font-style:italic>// Added
</span><span>        on_set</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>bool</span><span style=color:#61676ccc>,       </span><span style=color:#abb0b6;font-style:italic>// Added
</span><span>    }</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other variants
</span><span>}
</span></code></pre><h3 id=crates-bevy-ecs-src-schedule-executor-multi-threaded-rs-8-0><code>crates/bevy_ecs/src/schedule/executor/multi_threaded.rs</code> (+8/-0)</h3><p><strong>Changes:</strong> Added parameters to condition evaluation function calls to pass system context and set information.<p><strong>Key modification:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// In condition evaluation calls
</span><span style=color:#f07171>evaluate_and_fold_conditions</span><span>(
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> conditions</span><span style=color:#ed9366>.</span><span>set_conditions[set_idx]</span><span style=color:#61676ccc>,
</span><span>    world</span><span style=color:#61676ccc>,
</span><span>    error_handler</span><span style=color:#61676ccc>,
</span><span>    system</span><span style=color:#61676ccc>,    </span><span style=color:#abb0b6;font-style:italic>// Added
</span><span>    </span><span style=color:#ff8f40>true</span><span style=color:#61676ccc>,      </span><span style=color:#abb0b6;font-style:italic>// Added - indicates this is for a set
</span><span>)
</span></code></pre><h3 id=crates-bevy-ecs-src-schedule-executor-simple-rs-12-4><code>crates/bevy_ecs/src/schedule/executor/simple.rs</code> (+12/-4)</h3><p><strong>Changes:</strong> Similar to multi-threaded executor, plus reordering to get system reference before condition evaluation.<p><strong>Key modification:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// System reference moved before condition evaluation
</span><span style=color:#fa6e32>let</span><span> system </span><span style=color:#ed9366>= &</span><span style=color:#fa6e32>mut</span><span> schedule</span><span style=color:#ed9366>.</span><span>systems[system_index]</span><span style=color:#ed9366>.</span><span>system</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Condition evaluation now includes system context
</span><span style=color:#f07171>evaluate_and_fold_conditions</span><span>(
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> schedule</span><span style=color:#ed9366>.</span><span>system_conditions[system_index]</span><span style=color:#61676ccc>,
</span><span>    world</span><span style=color:#61676ccc>,
</span><span>    error_handler</span><span style=color:#61676ccc>,
</span><span>    system</span><span style=color:#61676ccc>,  </span><span style=color:#abb0b6;font-style:italic>// Added
</span><span>    </span><span style=color:#ff8f40>false</span><span style=color:#61676ccc>,   </span><span style=color:#abb0b6;font-style:italic>// Added - indicates this is for a system
</span><span>)
</span></code></pre><h3 id=crates-bevy-ecs-src-schedule-executor-single-threaded-rs-12-4><code>crates/bevy_ecs/src/schedule/executor/single_threaded.rs</code> (+12/-4)</h3><p><strong>Changes:</strong> Same pattern as simple executor - system reference extraction and additional parameters to condition evaluation.<h3 id=crates-bevy-ecs-src-schedule-condition-rs-40-2><code>crates/bevy_ecs/src/schedule/condition.rs</code> (+40/-2)</h3><p><strong>Changes:</strong> Added comprehensive test to verify the error context contains correct system information for both system-level and set-level conditions.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/books/ecs-scheduling/ target=_blank>Bevy ECS Scheduling Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/books/ecs-run-conditions/ target=_blank>Run Conditions in Bevy</a><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/book/ch09-00-error-handling.html target=_blank>Error Handling in Rust</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-09/pr_20911.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>