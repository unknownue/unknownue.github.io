<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21234 add methods to *EntityMut to UnsafeEntityCell as an escape hatch
        
    </title><meta content="#21234 add methods to *EntityMut to UnsafeEntityCell as an escape hatch" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-09/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-09-26</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-09/pr-21234-zh-cn-20250926>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: add methods to *EntityMut to UnsafeEntityCell as an escape hatch<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21234<li><strong>Author</strong>: hymm<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-ECS, C-Usability, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-09-26T20:53:29Z<li><strong>Merged</strong>: 2025-09-26T22:03:17Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Sometimes you want to break mutability rules to get multiple mutable components off of an entity.</ul><h2 id=solution>Solution</h2><ul><li>Allow converting the EntityMut, FilteredEntityMut, and EntityMutExcept into an UnsafeEntityCell. https://docs.rs/bevy/latest/bevy/ecs/world/unsafe_world_cell/struct.UnsafeEntityCell.html</ul><h2 id=testing>Testing</h2><ul><li>haven’t really tested, but changes are straightforward</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a specific but important use case in Bevy’s ECS (Entity Component System) where developers occasionally need to bypass Rust’s standard borrowing rules to access multiple mutable components from the same entity simultaneously. The core issue stems from Rust’s ownership system, which normally prevents having multiple mutable references to the same data.<p>The problem occurs when working with complex entity relationships where multiple systems might need mutable access to different components of the same entity. While Bevy’s ECS is designed to work within Rust’s safety guarantees, there are legitimate scenarios where developers need an escape hatch for advanced use cases.<p>The solution implemented is straightforward but powerful: provide conversion methods from various entity mutability wrapper types (<code>EntityMut</code>, <code>FilteredEntityMut</code>, and <code>EntityMutExcept</code>) to <code>UnsafeEntityCell</code>. The <code>UnsafeEntityCell</code> type serves as Bevy’s official escape hatch for these situations, allowing developers to explicitly opt into unsafe operations when they have confidence in their ability to maintain memory safety.<p>The implementation follows a consistent pattern across all three entity wrapper types. Each gains a new method <code>as_unsafe_entity_cell()</code> that returns an <code>UnsafeEntityCell</code> reference. This approach maintains the existing safety guarantees by requiring an explicit conversion step, making it clear when developers are stepping outside the normal safety boundaries.<p>From a technical perspective, this change is minimal but significant. It doesn’t alter the existing safe APIs but extends them with an escape route for advanced use cases. The implementation leverages the fact that these entity wrapper types already contain an <code>UnsafeEntityCell</code> internally, so the conversion is essentially just exposing that internal representation.<p>The impact of this change is primarily on developer ergonomics and flexibility. It provides a clean, documented way to perform operations that were previously difficult or required workarounds. By making this functionality part of the official API, it reduces the need for developers to resort to more dangerous techniques or internal hacks.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[EntityMut] --> D[as_unsafe_entity_cell]
</span><span>    B[FilteredEntityMut] --> D
</span><span>    C[EntityMutExcept] --> D
</span><span>    D --> E[UnsafeEntityCell]
</span><span>    E --> F[Multiple Mutable Components]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ecs-src-world-entity-ref-rs-15-0><code>crates/bevy_ecs/src/world/entity_ref.rs</code> (+15/-0)</h3><p>This file contains the core ECS entity reference implementations. The changes add conversion methods to three different entity wrapper types, allowing them to be converted to <code>UnsafeEntityCell</code> for advanced use cases.<p><strong>Key modifications:</strong><ol><li><strong>EntityMut struct</strong>: Added method to access underlying UnsafeEntityCell</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>/// Get access to the underlying [`UnsafeEntityCell`]
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>as_unsafe_entity_cell</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span>UnsafeEntityCell<'</span><span style=color:#ed9366>_</span><span>> {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>cell
</span><span>}
</span></code></pre><ol start=2><li><strong>FilteredEntityMut struct</strong>: Added identical method</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>/// Get access to the underlying [`UnsafeEntityCell`]
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>as_unsafe_entity_cell</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span>UnsafeEntityCell<'</span><span style=color:#ed9366>_</span><span>> {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>entity
</span><span>}
</span></code></pre><ol start=3><li><strong>EntityMutExcept struct</strong>: Added the same conversion method</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>/// Get access to the underlying [`UnsafeEntityCell`]
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>as_unsafe_entity_cell</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span>UnsafeEntityCell<'</span><span style=color:#ed9366>_</span><span>> {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>entity
</span><span>}
</span></code></pre><p>These changes provide a consistent API across all three mutable entity wrapper types, allowing developers to convert any of them to an <code>UnsafeEntityCell</code> when they need to bypass normal borrowing restrictions.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_ecs/latest/bevy_ecs/ target=_blank>Bevy ECS Documentation</a> - Comprehensive guide to Bevy’s Entity Component System<li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/ecs/world/unsafe_world_cell/struct.UnsafeEntityCell.html target=_blank>UnsafeEntityCell API Documentation</a> - Detailed information about the escape hatch API<li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/nomicon/ target=_blank>Rust Unsafe Code Guidelines</a> - Understanding when and how to use unsafe code properly<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/getting-started/ecs/ target=_blank>Bevy ECS System Parallellism</a> - How Bevy’s ECS handles parallel system execution</ul><h1 id=full-code-diff>Full Code Diff</h1><pre style=color:#61676c;background-color:#fafafa><code><span>diff --git a/crates/bevy_ecs/src/world/entity_ref.rs b/crates/bevy_ecs/src/world/entity_ref.rs
</span><span>index 15b61afb7ee49..f19a587d07d9b 100644
</span><span>--- a/crates/bevy_ecs/src/world/entity_ref.rs
</span><span>+++ b/crates/bevy_ecs/src/world/entity_ref.rs
</span><span>@@ -479,6 +479,11 @@ impl<'w> EntityMut<'w> {
</span><span>         EntityRef::from(self)
</span><span>     }
</span><span> 
</span><span>+    /// Get access to the underlying [`UnsafeEntityCell`]
</span><span>+    pub fn as_unsafe_entity_cell(&mut self) -> UnsafeEntityCell<'_> {
</span><span>+        self.cell
</span><span>+    }
</span><span>+
</span><span>     /// Returns the [ID](Entity) of the current entity.
</span><span>     #[inline]
</span><span>     #[must_use = "Omit the .id() call if you do not need to store the `Entity` identifier."]
</span><span>@@ -3873,6 +3878,11 @@ impl<'w, 's> FilteredEntityMut<'w, 's> {
</span><span>         FilteredEntityRef::from(self)
</span><span>     }
</span><span> 
</span><span>+    /// Get access to the underlying [`UnsafeEntityCell`]
</span><span>+    pub fn as_unsafe_entity_cell(&mut self) -> UnsafeEntityCell<'_> {
</span><span>+        self.entity
</span><span>+    }
</span><span>+
</span><span>     /// Returns the [ID](Entity) of the current entity.
</span><span>     #[inline]
</span><span>     #[must_use = "Omit the .id() call if you do not need to store the `Entity` identifier."]
</span><span>@@ -4446,6 +4456,11 @@ where
</span><span>         EntityRefExcept::from(self)
</span><span>     }
</span><span> 
</span><span>+    /// Get access to the underlying [`UnsafeEntityCell`]
</span><span>+    pub fn as_unsafe_entity_cell(&mut self) -> UnsafeEntityCell<'_> {
</span><span>+        self.entity
</span><span>+    }
</span><span>+
</span><span>     /// Gets access to the component of type `C` for the current entity. Returns
</span><span>     /// `None` if the component doesn't have a component of that type or if the
</span><span>     /// type is one of the excluded components.
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-09/pr_21234.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>