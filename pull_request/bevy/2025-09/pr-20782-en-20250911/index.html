<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20782 Compute light probe matrix earlier and cache in LightProbeInfo #20738
        
    </title><meta content="#20782 Compute light probe matrix earlier and cache in LightProbeInfo #20738" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-09/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-09-11</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-09/pr-20782-zh-cn-20250911>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>Compute light probe matrix earlier and cache in LightProbeInfo #20782<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Compute light probe matrix earlier and cache in LightProbeInfo #20738<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20782<li><strong>Author</strong>: jz009<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, C-Performance, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-08-28T02:54:36Z<li><strong>Merged</strong>: 2025-09-11T19:40:28Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Closes #20738<li>Avoid multiple computations of the same matrix transpose</ul><h2 id=solution>Solution</h2><ul><li>Compute the transpose when LightProbeInfo is created and reference it from there</ul><h2 id=testing>Testing</h2><p>cargo run -p ci<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The PR addresses a performance optimization in Bevy’s light probe system. Light probes require transformation matrices to convert between world space and light probe space. The original implementation was computing the same matrix transpose operation multiple times, which is computationally expensive.<p>The core issue was in the light probe gathering process. When creating <code>RenderLightProbe</code> data for the GPU, the system was repeatedly computing the transpose of the inverse transform matrix. This happened for every light probe in every frame, resulting in unnecessary computational overhead.<p>The solution moves this expensive matrix operation earlier in the pipeline. Instead of computing the transpose during the render preparation phase, it’s now computed once when the <code>LightProbeInfo</code> is created. The transposed matrix is stored directly in the <code>LightProbeInfo</code> struct, ready for reuse during rendering.<p>This change demonstrates a common optimization pattern: moving expensive computations from hot loops to initialization phases. By caching the result of the matrix operation, the system avoids redundant calculations while maintaining the same functional behavior.<p>The implementation required changing the data type of <code>light_from_world</code> from <code>Affine3A</code> to <code>[Vec4; 3]</code> to store the precomputed transpose. This aligns with how the data is ultimately used on the GPU side, where the matrix is stored in a compressed format using only three <code>Vec4</code> components instead of four.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[LightProbe Creation] --> B[Compute Matrix Transpose]
</span><span>    B --> C[Store in LightProbeInfo]
</span><span>    C --> D[Render Preparation]
</span><span>    D --> E[Reuse Precomputed Matrix]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>File: <code>crates/bevy_pbr/src/light_probe/mod.rs</code></strong><p>The main change involves restructuring how the light probe transformation matrix is handled:<ol><li><strong>Modified LightProbeInfo struct</strong> - Changed <code>light_from_world</code> from <code>Affine3A</code> to <code>[Vec4; 3]</code> to store the precomputed transpose:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>light_from_world</span><span style=color:#61676ccc>:</span><span> Affine3A</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>light_from_world</span><span style=color:#61676ccc>: </span><span>[Vec4</span><span style=color:#61676ccc>; </span><span style=color:#ff8f40>3</span><span>]</span><span style=color:#61676ccc>,
</span></code></pre><ol start=2><li><strong>Updated LightProbeInfo creation</strong> - Compute the transpose during initialization:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>light_from_world</span><span style=color:#61676ccc>:</span><span> light_probe_transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>affine</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>inverse</span><span>()</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> light_from_world_transposed </span><span style=color:#ed9366>=
</span><span>    Mat4</span><span style=color:#ed9366>::</span><span>from(light_probe_transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>affine</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>inverse</span><span>())</span><span style=color:#ed9366>.</span><span style=color:#f07171>transpose</span><span>()</span><span style=color:#61676ccc>;
</span><span>light_from_world</span><span style=color:#61676ccc>: </span><span>[
</span><span>    light_from_world_transposed</span><span style=color:#ed9366>.</span><span>x_axis</span><span style=color:#61676ccc>,
</span><span>    light_from_world_transposed</span><span style=color:#ed9366>.</span><span>y_axis</span><span style=color:#61676ccc>,
</span><span>    light_from_world_transposed</span><span style=color:#ed9366>.</span><span>z_axis</span><span style=color:#61676ccc>,
</span><span>]</span><span style=color:#61676ccc>,
</span></code></pre><ol start=3><li><strong>Simplified render preparation</strong> - Reuse the precomputed matrix instead of recalculating:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> light_from_world_transposed </span><span style=color:#ed9366>= </span><span>Mat4</span><span style=color:#ed9366>::</span><span>from(light_probe</span><span style=color:#ed9366>.</span><span>light_from_world)</span><span style=color:#ed9366>.</span><span style=color:#f07171>transpose</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>render_light_probes</span><span style=color:#ed9366>.</span><span style=color:#f07171>push</span><span>(RenderLightProbe {
</span><span>    light_from_world_transposed</span><span style=color:#61676ccc>: </span><span>[
</span><span>        light_from_world_transposed</span><span style=color:#ed9366>.</span><span>x_axis</span><span style=color:#61676ccc>,
</span><span>        light_from_world_transposed</span><span style=color:#ed9366>.</span><span>y_axis</span><span style=color:#61676ccc>,
</span><span>        light_from_world_transposed</span><span style=color:#ed9366>.</span><span>z_axis</span><span style=color:#61676ccc>,
</span><span>    ]</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>})</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>render_light_probes</span><span style=color:#ed9366>.</span><span style=color:#f07171>push</span><span>(RenderLightProbe {
</span><span>    light_from_world_transposed</span><span style=color:#61676ccc>:</span><span> light_probe</span><span style=color:#ed9366>.</span><span>light_from_world</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>})</span><span style=color:#61676ccc>;
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/books/rendering/lighting/light-probes target=_blank>Bevy Light Probes Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Transpose target=_blank>Matrix Transpose Optimization Techniques</a><li><a rel="noopener nofollow noreferrer" href=https://learnopengl.com/Getting-started/Transformations target=_blank>Computer Graphics Transformation Matrices</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-09/pr_20782.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>