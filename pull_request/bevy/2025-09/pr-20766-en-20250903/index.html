<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20766 Raymarched rendering for atmosphere and spherical coordinates
        
    </title><meta content="#20766 Raymarched rendering for atmosphere and spherical coordinates" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-09/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-09-03</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-09/pr-20766-zh-cn-20250903>中文</a></div></div><div class=pr-content><h1 id=raymarched-rendering-for-atmosphere-and-spherical-coordinates>Raymarched rendering for atmosphere and spherical coordinates</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Raymarched rendering for atmosphere and spherical coordinates<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20766<li><strong>Author</strong>: mate-h<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Feature, A-Rendering, S-Ready-For-Final-Review, M-Needs-Release-Note<li><strong>Created</strong>: 2025-08-26T17:01:29Z<li><strong>Merged</strong>: 2025-09-03T21:30:19Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Support space views for the atmosphere<li>Add more accurate lighting to the atmosphere with ray marching<li>Enable future support for sharp volumetric shadows through the atmosphere<li>Tracking overall progress in #20374</ul><h2 id=solution>Solution</h2><ul><li>Added spherical coordinate system alongside the sky-view lut parameterization<li>Added ray-marched rendering method to support space views and accurate lighting<li>This is setting the stage for PBR integration, volumetric shadows<li>Could maybe re-use the ray-marching function in the aerial view LUT as well, but I didn’t bother for this PR (future improvement)</ul><h2 id=testing>Testing</h2><ul><li>Ran the atmosphere example to ensure it still works fine with both rendering methods<li>Created a freecam version of the atmosphere example and put the camera in space, below ground.</ul><hr><h2 id=showcase>Showcase</h2><p>https://github.com/user-attachments/assets/e9cf0d91-8e34-435c-834e-02602a9496a2<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a fundamental limitation in Bevy’s atmospheric rendering system. The original implementation used a lookup table (LUT) approach that worked well for ground-level views but broke down when the camera moved to space or extreme positions. The problem was that the LUT parameterization assumed a locally flat world, which became inaccurate at large distances from the planet surface.<p>The solution introduces a new ray marching rendering path alongside the existing LUT approach. The developer implemented a spherical coordinate system that properly handles space views and extreme camera positions. This required significant changes to the shader codebase, including:<ol><li>A new <code>raymarch_atmosphere</code> function that numerically integrates light scattering through the atmosphere<li>Proper handling of camera position using spherical coordinates instead of assuming a flat world<li>A configurable rendering mode system that lets users choose between performance (LUT) and accuracy (ray marching)</ol><p>The implementation follows sound computer graphics principles for volumetric rendering. The ray marching algorithm samples the atmosphere at multiple points along each view ray, accumulating inscattering and transmittance values. For each sample point, it calculates local atmospheric properties and evaluates light scattering contributions.<p>Key technical decisions included:<ul><li>Maintaining backward compatibility by keeping the LUT method as default<li>Using a flexible sample count system that balances quality and performance<li>Implementing proper ray-sphere intersection mathematics for accurate atmospheric boundaries<li>Adding ground reflection support for realistic planetary surfaces</ul><p>The changes affect multiple rendering passes and coordinate systems. The developer had to refactor several utility functions to work in both Cartesian and spherical coordinate systems, ensuring consistency across different rendering paths.<p>Performance considerations were important throughout. The ray marching approach is more computationally intensive but provides significantly better results for space views and enables future volumetric shadow effects. The implementation includes early termination optimizations to reduce unnecessary computations when transmittance becomes negligible.<p>This work sets the stage for future PBR integration and volumetric shadows by providing a more physically accurate foundation for atmospheric rendering. The spherical coordinate system and ray marching approach will enable more advanced effects that were previously impossible with the LUT-only implementation.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Camera] --> B{AtmosphereMode}
</span><span>    B --> C[LookupTexture]
</span><span>    B --> D[Raymarched]
</span><span>    C --> E[SkyView LUT]
</span><span>    C --> F[AerialView LUT]
</span><span>    D --> G[Raymarch Function]
</span><span>    E --> H[Final Rendering]
</span><span>    F --> H
</span><span>    G --> H
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ol><li><p><strong><code>crates/bevy_pbr/src/atmosphere/functions.wgsl</code></strong> (+160/-13):</p> <ul><li>Added comprehensive ray marching implementation with proper spherical coordinate handling<li>Implemented <code>raymarch_atmosphere</code> function with configurable sample count<li>Added <code>get_raymarch_segment</code> for calculating atmospheric intersection points<li>Updated coordinate transformation functions for spherical support</ul> <p>Key additions:</p> <pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>fn raymarch_atmosphere(
</span><span>    pos: vec3&LTf32>,
</span><span>    ray_dir: vec3&LTf32>,
</span><span>    t_max: f32,
</span><span>    max_samples: u32,
</span><span>    uv: vec2&LTf32>,
</span><span>    ground: bool
</span><span>) -> RaymarchResult {
</span><span>    // Implementation details...
</span><span>}
</span></code></pre><li><p><strong><code>crates/bevy_pbr/src/atmosphere/mod.rs</code></strong> (+79/-6):</p> <ul><li>Added <code>AtmosphereMode</code> enum with <code>LookupTexture</code> and <code>Raymarched</code> variants<li>Created <code>GpuAtmosphereSettings</code> struct to handle GPU-bound settings<li>Added configuration options for sample counts and rendering method</ul> <p>Key additions:</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub enum </span><span style=color:#399ee6>AtmosphereMode </span><span>{
</span><span>    LookupTexture </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>,
</span><span>    Raymarched </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>,
</span><span>}
</span></code></pre><li><p><strong><code>release-content/release-notes/raymarched-atmosphere-space-views.md</code></strong> (+55/-0):</p> <ul><li>Comprehensive release notes explaining the new feature<li>Usage guidelines and performance considerations</ul><li><p><strong><code>crates/bevy_pbr/src/atmosphere/sky_view_lut.wgsl</code></strong> (+10/-38):</p> <ul><li>Simplified LUT generation using the new ray marching function<li>Replaced complex manual sampling with unified ray marching approach</ul> <p>Key change:</p> <pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>let result = raymarch_atmosphere(world_pos, ray_dir_ws, t_max, settings.sky_view_lut_samples, uv, true);
</span><span>textureStore(sky_view_lut_out, idx.xy, vec4(result.inscattering, 1.0));
</span></code></pre><li><p><strong><code>crates/bevy_pbr/src/atmosphere/render_sky.wgsl</code></strong> (+23/-7):</p> <ul><li>Added conditional rendering path selection based on atmosphere mode<li>Integrated ray marching into the main sky rendering pipeline</ul> <p>Key addition:</p> <pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>if should_raymarch {
</span><span>    let result = raymarch_atmosphere(world_pos, ray_dir_ws, t_max, max_samples, in.uv, true);
</span><span>    inscattering = result.inscattering;
</span><span>    transmittance = result.transmittance;
</span><span>}
</span></code></pre></ol><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://www.alexandre-pestana.com/physically-based-atmospheric-scattering/ target=_blank>Physically Based Atmospheric Scattering</a> - Comprehensive explanation of atmospheric rendering techniques<li>[Ray Marching and Volume Rendering](https://iquilezles.org/articles/ray marching/) - In-depth technical discussion of ray marching algorithms<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/books/rendering/ target=_blank>Bevy Rendering Documentation</a> - Official Bevy rendering guide for context on the existing system</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-09/pr_20766.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>