<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20916 Use DespawnOnExit instead of generic cleanup system
        
    </title><meta content="#20916 Use DespawnOnExit instead of generic cleanup system" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-09/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-09-07</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-09/pr-20916-zh-cn-20250907>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>Use DespawnOnExit instead of generic cleanup system<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Use DespawnOnExit instead of generic cleanup system<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20916<li><strong>Author</strong>: Fodesu<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Examples, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-09-07T05:51:28Z<li><strong>Merged</strong>: 2025-09-07T16:54:06Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Fixes #20900<h2 id=solution>Solution</h2><p>Add DespawnOnExit to the entity that is expected to be despawned.<h2 id=testing>Testing</h2><p>I test in my linux. I get the #[allow(clippy::uninlined_format_args)] clippy error, is this my oversight?<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a cleanup pattern in Bevy’s game menu example where entities were being manually despawned using a generic cleanup system. The problem was that the example used a custom <code>despawn_screen</code> function that queried for entities with specific marker components and despawned them when exiting application states. While functional, this approach required boilerplate code and manual system registration for each state transition.<p>The solution replaces this manual cleanup approach with Bevy’s built-in <code>DespawnOnExit</code> component. This component automatically handles entity cleanup when exiting the specified state, eliminating the need for custom cleanup systems. The implementation involved:<ol><li>Removing the generic <code>despawn_screen</code> function and its associated system registrations<li>Adding <code>DespawnOnExit</code> components to entities that need cleanup<li>Removing the marker components that were previously used for manual cleanup</ol><p>The key technical insight here is leveraging Bevy’s state-driven entity management system. <code>DespawnOnExit</code> is a more declarative approach that integrates directly with Bevy’s state management, reducing code complexity and potential errors from manual cleanup systems.<p>The changes affect the game menu example across multiple states: splash screen, game screen, and various menu states (main, settings, display settings, sound settings). Each entity that needs cleanup now carries a <code>DespawnOnExit</code> component specifying which state transition should trigger its despawn.<p>This approach demonstrates Bevy’s built-in capabilities for state-based entity management and serves as a better example for developers learning the engine. It reduces code size by 17 lines while maintaining identical functionality.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[GameState] --> B[Splash State]
</span><span>    A --> C[Game State]
</span><span>    A --> D[Menu State]
</span><span>    
</span><span>    D --> E[Main Menu]
</span><span>    D --> F[Settings Menu]
</span><span>    F --> G[Display Settings]
</span><span>    F --> H[Sound Settings]
</span><span>    
</span><span>    I[DespawnOnExit] -.-> B
</span><span>    I -.-> C
</span><span>    I -.-> E
</span><span>    I -.-> F
</span><span>    I -.-> G
</span><span>    I -.-> H
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ul><li><code>examples/games/game_menu.rs</code> (+12/-29)</ul><p>The main changes involve replacing the manual cleanup system with <code>DespawnOnExit</code> components:<ol><li><strong>Removed the generic cleanup system</strong>:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>despawn_screen</span><span>&LTT</span><span style=color:#61676ccc>:</span><span> Component>(</span><span style=color:#ff8f40>to_despawn</span><span style=color:#61676ccc>: </span><span>Query&LTEntity, With&LTT>>, </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands) {
</span><span>    </span><span style=color:#fa6e32>for</span><span> entity </span><span style=color:#ed9366>in &</span><span>to_despawn {
</span><span>        commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(entity)</span><span style=color:#ed9366>.</span><span style=color:#f07171>despawn</span><span>()</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><ol start=2><li><strong>Added DespawnOnExit to entities</strong> across all game states:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// After (typical pattern):
</span><span>commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((
</span><span>    DespawnOnExit(GameState</span><span style=color:#ed9366>::</span><span>Splash)</span><span style=color:#61676ccc>, </span><span style=color:#abb0b6;font-style:italic>// Added this component
</span><span>    Node {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ... existing components
</span><span>    }</span><span style=color:#61676ccc>,
</span><span>    OnSplashScreen</span><span style=color:#61676ccc>,
</span><span>))</span><span style=color:#61676ccc>;
</span></code></pre><ol start=3><li><strong>Removed manual cleanup system registrations</strong> from all state transitions:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(OnExit(GameState</span><span style=color:#ed9366>::</span><span>Splash)</span><span style=color:#61676ccc>, </span><span>despawn_screen</span><span style=color:#ed9366>::</span><span>&LTOnSplashScreen>)
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#abb0b6;font-style:italic>// System registration removed entirely
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/ecs/schedule/state/trait.State.html target=_blank>Bevy States Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/prelude/struct.DespawnOnExit.html target=_blank>Bevy DespawnOnExit Component</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/tree/main/examples/ecs/state target=_blank>Bevy State Transition Examples</a></ul><h1 id=full-code-diff>Full Code Diff</h1><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/examples/games/game_menu.rs b/examples/games/game_menu.rs
</span><span>index e8f58bfca91a0..ac2a834908cf8 100644
</span><span style=color:#c594c5>--- a/examples/games/game_menu.rs
</span><span style=color:#c594c5>+++ b/examples/games/game_menu.rs
</span><span style=color:#c594c5>@@ -3,7 +3,6 @@
</span><span> //! settings for 5 seconds before going back to the menu.
</span><span> 
</span><span> use bevy::prelude::*;
</span><span style=color:#f07171>-
</span><span> const TEXT_COLOR: Color = Color::srgb(0.9, 0.9, 0.9);
</span><span> 
</span><span> // Enum that will be used as a global state for the game
</span><span style=color:#c594c5>@@ -48,7 +47,7 @@ </span><span style=color:#399ee6>fn setup(mut commands: Commands) {
</span><span> mod splash {
</span><span>     use bevy::prelude::*;
</span><span> 
</span><span style=color:#f07171>-    use super::{despawn_screen, GameState};
</span><span style=color:#86b300>+    use super::GameState;
</span><span> 
</span><span>     // This plugin will display a splash screen with Bevy logo for 1 second before switching to the menu
</span><span>     pub fn splash_plugin(app: &mut App) {
</span><span style=color:#c594c5>@@ -57,9 +56,7 @@ </span><span style=color:#399ee6>mod splash {
</span><span>             // When entering the state, spawn everything needed for this screen
</span><span>             .add_systems(OnEnter(GameState::Splash), splash_setup)
</span><span>             // While in this state, run the `countdown` system
</span><span style=color:#f07171>-            .add_systems(Update, countdown.run_if(in_state(GameState::Splash)))
</span><span style=color:#f07171>-            // When exiting the state, despawn everything that was spawned for this screen
</span><span style=color:#f07171>-            .add_systems(OnExit(GameState::Splash), despawn_screen::&LTOnSplashScreen>);
</span><span style=color:#86b300>+            .add_systems(Update, countdown.run_if(in_state(GameState::Splash)));
</span><span>     }
</span><span> 
</span><span>     // Tag component used to tag entities added on the splash screen
</span><span style=color:#c594c5>@@ -74,6 +71,8 @@ </span><span style=color:#399ee6>mod splash {
</span><span>         let icon = asset_server.load("branding/icon.png");
</span><span>         // Display the logo
</span><span>         commands.spawn((
</span><span style=color:#86b300>+            // This entity will be despawned when exiting the state
</span><span style=color:#86b300>+            DespawnOnExit(GameState::Splash),
</span><span>             Node {
</span><span>                 align_items: AlignItems::Center,
</span><span>                 justify_content: JustifyContent::Center,
</span><span style=color:#c594c5>@@ -113,14 +112,13 @@ </span><span style=color:#399ee6>mod game {
</span><span>         prelude::*,
</span><span>     };
</span><span> 
</span><span style=color:#f07171>-    use super::{despawn_screen, DisplayQuality, GameState, Volume, TEXT_COLOR};
</span><span style=color:#86b300>+    use super::{DisplayQuality, GameState, Volume, TEXT_COLOR};
</span><span> 
</span><span>     // This plugin will contain the game. In this case, it's just be a screen that will
</span><span>     // display the current settings for 5 seconds before returning to the menu
</span><span>     pub fn game_plugin(app: &mut App) {
</span><span>         app.add_systems(OnEnter(GameState::Game), game_setup)
</span><span style=color:#f07171>-            .add_systems(Update, game.run_if(in_state(GameState::Game)))
</span><span style=color:#f07171>-            .add_systems(OnExit(GameState::Game), despawn_screen::&LTOnGameScreen>);
</span><span style=color:#86b300>+            .add_systems(Update, game.run_if(in_state(GameState::Game)));
</span><span>     }
</span><span> 
</span><span>     // Tag component used to tag entities added on the game screen
</span><span style=color:#c594c5>@@ -136,6 +134,7 @@ </span><span style=color:#399ee6>mod game {
</span><span>         volume: Res&LTVolume>,
</span><span>     ) {
</span><span>         commands.spawn((
</span><span style=color:#86b300>+            DespawnOnExit(GameState::Game),
</span><span>             Node {
</span><span>                 width: percent(100),
</span><span>                 height: percent(100),
</span><span style=color:#c594c5>@@ -229,7 +228,7 @@ </span><span style=color:#399ee6>mod menu {
</span><span>         prelude::*,
</span><span>     };
</span><span> 
</span><span style=color:#f07171>-    use super::{despawn_screen, DisplayQuality, GameState, Volume, TEXT_COLOR};
</span><span style=color:#86b300>+    use super::{DisplayQuality, GameState, Volume, TEXT_COLOR};
</span><span> 
</span><span>     // This plugin manages the menu, with 5 different screens:
</span><span>     // - a main menu with "New Game", "Settings", "Quit"
</span><span style=color:#c594c5>@@ -244,13 +243,8 @@ </span><span style=color:#399ee6>mod menu {
</span><span>             .add_systems(OnEnter(GameState::Menu), menu_setup)
</span><span>             // Systems to handle the main menu screen
</span><span>             .add_systems(OnEnter(MenuState::Main), main_menu_setup)
</span><span style=color:#f07171>-            .add_systems(OnExit(MenuState::Main), despawn_screen::&LTOnMainMenuScreen>)
</span><span>             // Systems to handle the settings menu screen
</span><span>             .add_systems(OnEnter(MenuState::Settings), settings_menu_setup)
</span><span style=color:#f07171>-            .add_systems(
</span><span style=color:#f07171>-                OnExit(MenuState::Settings),
</span><span style=color:#f07171>-                despawn_screen::&LTOnSettingsMenuScreen>,
</span><span style=color:#f07171>-            )
</span><span>             // Systems to handle the display settings screen
</span><span>             .add_systems(
</span><span>                 OnEnter(MenuState::SettingsDisplay),
</span><span style=color:#c594c5>@@ -260,20 +254,12 @@ </span><span style=color:#399ee6>mod menu {
</span><span>                 Update,
</span><span>                 (setting_button::&LTDisplayQuality>.run_if(in_state(MenuState::SettingsDisplay)),),
</span><span>             )
</span><span style=color:#f07171>-            .add_systems(
</span><span style=color:#f07171>-                OnExit(MenuState::SettingsDisplay),
</span><span style=color:#f07171>-                despawn_screen::&LTOnDisplaySettingsMenuScreen>,
</span><span style=color:#f07171>-            )
</span><span>             // Systems to handle the sound settings screen
</span><span>             .add_systems(OnEnter(MenuState::SettingsSound), sound_settings_menu_setup)
</span><span>             .add_systems(
</span><span>                 Update,
</span><span>                 setting_button::&LTVolume>.run_if(in_state(MenuState::SettingsSound)),
</span><span>             )
</span><span style=color:#f07171>-            .add_systems(
</span><span style=color:#f07171>-                OnExit(MenuState::SettingsSound),
</span><span style=color:#f07171>-                despawn_screen::&LTOnSoundSettingsMenuScreen>,
</span><span style=color:#f07171>-            )
</span><span>             // Common systems to all screens that handles buttons behavior
</span><span>             .add_systems(
</span><span>                 Update,
</span><span style=color:#c594c5>@@ -397,6 +383,7 @@ </span><span style=color:#399ee6>mod menu {
</span><span>         let exit_icon = asset_server.load("textures/Game Icons/exitRight.png");
</span><span> 
</span><span>         commands.spawn((
</span><span style=color:#86b300>+            DespawnOnExit(MenuState::Main),
</span><span>             Node {
</span><span>                 width: percent(100),
</span><span>                 height: percent(100),
</span><span style=color:#c594c5>@@ -492,6 +479,7 @@ </span><span style=color:#399ee6>mod menu {
</span><span>         );
</span><span> 
</span><span>         commands.spawn((
</span><span style=color:#86b300>+            DespawnOnExit(MenuState::Settings),
</span><span>             Node {
</span><span>                 width: percent(100),
</span><span>                 height: percent(100),
</span><span style=color:#c594c5>@@ -551,6 +539,7 @@ </span><span style=color:#399ee6>mod menu {
</span><span> 
</span><span>         let display_quality = *display_quality;
</span><span>         commands.spawn((
</span><span style=color:#86b300>+            DespawnOnExit(MenuState::SettingsDisplay),
</span><span>             Node {
</span><span>                 width: percent(100),
</span><span>                 height: percent(100),
</span><span style=color:#c594c5>@@ -638,6 +627,7 @@ </span><span style=color:#399ee6>mod menu {
</span><span>         let volume = *volume;
</span><span>         let button_node_clone = button_node.clone();
</span><span>         commands.spawn((
</span><span style=color:#86b300>+            DespawnOnExit(MenuState::SettingsSound),
</span><span>             Node {
</span><span>                 width: percent(100),
</span><span>                 height: percent(100),
</span><span style=color:#c594c5>@@ -728,10 +718,3 @@ </span><span style=color:#399ee6>mod menu {
</span><span>         }
</span><span>     }
</span><span> }
</span><span style=color:#f07171>-
</span><span style=color:#f07171>-// Generic system that takes a component as a parameter, and will despawn all entities with that component
</span><span style=color:#f07171>-fn despawn_screen&LTT: Component>(to_despawn: Query&LTEntity, With&LTT>>, mut commands: Commands) {
</span><span style=color:#f07171>-    for entity in &to_despawn {
</span><span style=color:#f07171>-        commands.entity(entity).despawn();
</span><span style=color:#f07171>-    }
</span><span style=color:#f07171>-}
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-09/pr_20916.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>