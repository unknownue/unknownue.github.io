<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20855 added anti-aliasing support for Custom Projection
        
    </title><meta content="#20855 added anti-aliasing support for Custom Projection" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-09/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-09-05</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-09/pr-20855-zh-cn-20250905>中文</a></div></div><div class=pr-content><h1 id=added-anti-aliasing-support-for-custom-projection>added anti-aliasing support for Custom Projection</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: added anti-aliasing support for Custom Projection<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20855<li><strong>Author</strong>: diyu-motif<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Feature, A-Rendering, S-Ready-For-Final-Review, D-Straightforward<li><strong>Created</strong>: 2025-09-03T20:11:13Z<li><strong>Merged</strong>: 2025-09-05T00:38:12Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Support anti-aliasing for Custom Projection.<h2 id=solution>Solution</h2><p>function is_perspective() is added to Projection, it checks the matrix to determine if the Custom Projection is perspective.<h2 id=testing>Testing</h2><ul><li><p>Did you test these changes? If so, how? yes, we have an internal project that uses Custom Projection, I tested taa, but not the dlss, but the logic is the same.</p><li><p>Are there any parts that need more testing? N/A</p><li><p>How can other people (reviewers) test your changes? Is there anything specific they need to know? here is the detail: https://metashapes.com/blog/opengl-metal-projection-matrix-problem/</p><li><p>If relevant, what platforms did you test these changes on, and are there any important ones you can’t test? N/A</p></ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The problem started with Bevy’s anti-aliasing systems (TAA and DLSS) only working with standard perspective projections. When developers used Custom Projection, these anti-aliasing features would fail to activate because the systems were checking for the <code>Projection::Perspective</code> variant specifically, ignoring custom projection matrices that might actually represent perspective transformations.<p>The core issue was that anti-aliasing algorithms like TAA and DLSS require perspective projection matrices to function correctly, but the existing code used pattern matching that couldn’t recognize perspective projections when they were wrapped in the <code>Projection::Custom</code> variant.<p>The solution approach was straightforward: instead of checking the enum variant, we needed to examine the actual projection matrix to determine if it represents a perspective transformation. The developer implemented a new method <code>is_perspective()</code> on the <code>Projection</code> enum that could handle all three variants (Perspective, Orthographic, and Custom).<p>For the implementation, the key insight was that perspective projection matrices have a specific characteristic in their fourth row: the w-component of the w-axis is 0.0. This mathematical property distinguishes perspective from orthographic projections, regardless of how the projection matrix was created.<p>The changes were minimal but effective:<ol><li>Added the <code>is_perspective()</code> method to the Projection enum<li>Updated both TAA and DLSS systems to use this new method instead of pattern matching</ol><p>This approach maintains backward compatibility while extending functionality to custom projections. The solution is robust because it works with any perspective matrix, whether created through Bevy’s standard perspective projection or through custom mathematical operations.<p>The impact is significant for users who need custom projection matrices but still want access to Bevy’s advanced anti-aliasing features. This change bridges the gap between custom rendering requirements and built-in post-processing effects.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Projection Enum] --> B[is_perspective method]
</span><span>    B --> C[Perspective Projection]
</span><span>    B --> D[Orthographic Projection]
</span><span>    B --> E[Custom Projection]
</span><span>    F[TAA System] --> B
</span><span>    G[DLSS System] --> B
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-camera-src-projection-rs-10-0><code>crates/bevy_camera/src/projection.rs</code> (+10/-0)</h3><p>Added the <code>is_perspective()</code> method to the Projection enum to determine if any projection (including custom) represents a perspective transformation.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// File: crates/bevy_camera/src/projection.rs
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#abb0b6;font-style:italic>/// Check if the projection is perspective.
</span><span style=color:#abb0b6;font-style:italic>/// For [`CustomProjection`], this checks if the projection matrix's w-axis's w is 0.0.
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>is_perspective</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>bool </span><span>{
</span><span>    </span><span style=color:#fa6e32>match </span><span style=color:#55b4d4;font-style:italic>self </span><span>{
</span><span>        Projection</span><span style=color:#ed9366>::</span><span>Perspective(</span><span style=color:#ed9366>_</span><span>) </span><span style=color:#ed9366>=> </span><span style=color:#ff8f40>true</span><span style=color:#61676ccc>,
</span><span>        Projection</span><span style=color:#ed9366>::</span><span>Orthographic(</span><span style=color:#ed9366>_</span><span>) </span><span style=color:#ed9366>=> </span><span style=color:#ff8f40>false</span><span style=color:#61676ccc>,
</span><span>        Projection</span><span style=color:#ed9366>::</span><span>Custom(projection) </span><span style=color:#ed9366>=></span><span> projection</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_clip_from_view</span><span>()</span><span style=color:#ed9366>.</span><span>w_axis</span><span style=color:#ed9366>.</span><span>w </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0.0</span><span style=color:#61676ccc>,
</span><span>    }
</span><span>}
</span></code></pre><h3 id=crates-bevy-anti-alias-src-dlss-extract-rs-1-2><code>crates/bevy_anti_alias/src/dlss/extract.rs</code> (+1/-2)</h3><p>Updated DLSS extraction to use the new <code>is_perspective()</code> method instead of pattern matching.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// File: crates/bevy_anti_alias/src/dlss/extract.rs
</span><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> has_perspective_projection </span><span style=color:#ed9366>= </span><span style=color:#f07171>matches!</span><span>(camera_projection</span><span style=color:#61676ccc>, </span><span>Projection</span><span style=color:#ed9366>::</span><span>Perspective(</span><span style=color:#ed9366>_</span><span>))</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// ... other code
</span><span style=color:#fa6e32>if</span><span> dlss</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_some</span><span>() </span><span style=color:#ed9366>&&</span><span> camera</span><span style=color:#ed9366>.</span><span>is_active </span><span style=color:#ed9366>&&</span><span> has_perspective_projection {
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>if</span><span> dlss</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_some</span><span>() </span><span style=color:#ed9366>&&</span><span> camera</span><span style=color:#ed9366>.</span><span>is_active </span><span style=color:#ed9366>&&</span><span> camera_projection</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_perspective</span><span>() {
</span></code></pre><h3 id=crates-bevy-anti-alias-src-taa-mod-rs-1-2><code>crates/bevy_anti_alias/src/taa/mod.rs</code> (+1/-2)</h3><p>Similarly updated TAA system to use the new method.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// File: crates/bevy_anti_alias/src/taa/mod.rs
</span><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> has_perspective_projection </span><span style=color:#ed9366>= </span><span style=color:#f07171>matches!</span><span>(camera_projection</span><span style=color:#61676ccc>, </span><span>Projection</span><span style=color:#ed9366>::</span><span>Perspective(</span><span style=color:#ed9366>_</span><span>))</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// ... other code
</span><span style=color:#ed9366>&&</span><span> has_perspective_projection
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#ed9366>&&</span><span> camera_projection</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_perspective</span><span>()
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://metashapes.com/blog/opengl-metal-projection-matrix-problem/ target=_blank>OpenGL/Metal Projection Matrix Problem</a> - Explains the mathematical details of projection matrices<li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/camera/projection/enum.Projection.html target=_blank>Bevy Camera Projection Documentation</a> - Official Bevy documentation on projection types<li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Temporal_anti-aliasing target=_blank>Temporal Anti-Aliasing Explained</a> - Background on TAA technique<li><a rel="noopener nofollow noreferrer" href=https://www.nvidia.com/en-us/geforce/technologies/dlss/ target=_blank>DLSS Technology Overview</a> - NVIDIA’s explanation of DLSS</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-09/pr_20855.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>