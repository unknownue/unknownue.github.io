<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18204 move utilities from bevy_reflect/derive to bevy_macro_utils
        
    </title><meta content="#18204 move utilities from bevy_reflect/derive to bevy_macro_utils" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-09/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-09-11</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-09/pr-18204-zh-cn-20250911>中文</a></div></div><div class=pr-content><h1 id=move-utilities-from-bevy-reflect-derive-to-bevy-macro-utils>move utilities from bevy_reflect/derive to bevy_macro_utils</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: move utilities from bevy_reflect/derive to bevy_macro_utils<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18204<li><strong>Author</strong>: Bleachfuel<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Code-Quality, S-Ready-For-Final-Review, A-Utils, D-Straightforward<li><strong>Created</strong>: 2025-03-09T01:09:54Z<li><strong>Merged</strong>: 2025-09-11T19:44:08Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>Some things in bevy_reflect/derive are better of in bevy_macro_utils, as every macro can use these.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a code organization issue in Bevy’s macro infrastructure. The problem was that several utility modules in <code>bevy_reflect/derive</code> contained functionality that could be useful to other macros throughout the codebase, but they were only accessible within the reflection derive context.<p>The developer identified two key utility modules that had broader applicability:<ol><li><code>attribute_parser.rs</code> - containing a terminated parser function<li><code>result_sifter.rs</code> - containing a result aggregation helper</ol><p>The solution approach was straightforward: move these utilities to <code>bevy_macro_utils</code>, a shared crate designed specifically for macro utilities. This involved:<ul><li>Physically moving the files to the new location<li>Changing their visibility from <code>pub(crate)</code> to <code>pub</code> to make them accessible to other crates<li>Updating all references in the reflection derive code to use the new location<li>Adding the modules to <code>bevy_macro_utils</code>’s public exports</ul><p>The implementation required careful attention to import statements and visibility modifiers. In <code>container_attributes.rs</code> and <code>field_attributes.rs</code>, the <code>terminated_parser</code> import was updated from the local crate to <code>bevy_macro_utils</code>. Similarly, <code>derive_data.rs</code> was updated to import <code>ResultSifter</code> from the shared utils crate instead of locally.<p>This change demonstrates good software engineering practices by promoting code reuse and reducing duplication. The utilities are now available to any macro in the Bevy ecosystem, not just reflection macros. The impact is improved maintainability - future changes to these utilities only need to be made in one place, and other macro crates can leverage these well-tested components without reinventing them.<p>From a technical perspective, this change highlights the importance of proper crate organization in large Rust projects. The <code>bevy_macro_utils</code> crate serves as a central repository for shared macro functionality, following the principle of separation of concerns. The change also shows how visibility modifiers (<code>pub</code> vs <code>pub(crate)</code>) control access to functionality across crate boundaries.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[bevy_reflect/derive] --> B[attribute_parser.rs]
</span><span>    A --> C[result_sifter.rs]
</span><span>    D[bevy_macro_utils] --> B
</span><span>    D --> C
</span><span>    E[Other Macros] --> D
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-macro-utils-src-lib-rs><code>crates/bevy_macro_utils/src/lib.rs</code></h3><p>Added exports for the new parser and result_sifter modules:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added these modules to the crate
</span><span style=color:#fa6e32>mod </span><span style=color:#399ee6>parser</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>mod </span><span style=color:#399ee6>result_sifter</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Added these to the public exports
</span><span style=color:#fa6e32>pub use </span><span>parser</span><span style=color:#ed9366>::*</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>pub use </span><span>result_sifter</span><span style=color:#ed9366>::*</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-macro-utils-src-parser-rs-renamed-from-attribute-parser-rs><code>crates/bevy_macro_utils/src/parser.rs</code> (renamed from attribute_parser.rs)</h3><p>Changed function visibility from crate-private to public:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>terminated_parser</span><span>&LTT, P, F</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>FnMut</span><span>(ParseStream) </span><span style=color:#61676ccc>-> </span><span>syn</span><span style=color:#ed9366>::</span><span style=color:#55b4d4;font-style:italic>Result</span><span>&LTT>>(
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>pub fn terminated_parser&LTT, P, F</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>FnMut</span><span>(ParseStream) </span><span style=color:#61676ccc>-> </span><span>syn</span><span style=color:#ed9366>::</span><span style=color:#55b4d4;font-style:italic>Result</span><span>&LTT>>(
</span></code></pre><h3 id=crates-bevy-macro-utils-src-result-sifter-rs><code>crates/bevy_macro_utils/src/result_sifter.rs</code></h3><p>Changed struct visibility from crate-private to public:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>ResultSifter</span><span>&LTT> {
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub</span><span> struct ResultSifter&LTT> {
</span></code></pre><h3 id=crates-bevy-reflect-derive-src-container-attributes-rs><code>crates/bevy_reflect/derive/src/container_attributes.rs</code></h3><p>Updated imports to use the moved utilities:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>use crate</span><span style=color:#61676ccc>::</span><span>{
</span><span>    attribute_parser</span><span style=color:#ed9366>::</span><span>terminated_parser</span><span style=color:#61676ccc>, </span><span>custom_attributes</span><span style=color:#ed9366>::</span><span>CustomAttributes</span><span style=color:#61676ccc>,
</span><span>    derive_data</span><span style=color:#ed9366>::</span><span>ReflectTraitToImpl</span><span style=color:#61676ccc>,
</span><span>}</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>use </span><span>bevy_macro_utils</span><span style=color:#ed9366>::</span><span>fq_std</span><span style=color:#ed9366>::</span><span>{FQAny</span><span style=color:#61676ccc>,</span><span> FQClone</span><span style=color:#61676ccc>,</span><span> FQOption</span><span style=color:#61676ccc>,</span><span> FQResult}</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>use crate</span><span style=color:#61676ccc>::</span><span>{custom_attributes</span><span style=color:#ed9366>::</span><span>CustomAttributes</span><span style=color:#61676ccc>, </span><span>derive_data</span><span style=color:#ed9366>::</span><span>ReflectTraitToImpl}</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>use </span><span>bevy_macro_utils</span><span style=color:#ed9366>::</span><span>{
</span><span>    fq_std</span><span style=color:#ed9366>::</span><span>{FQAny</span><span style=color:#61676ccc>,</span><span> FQClone</span><span style=color:#61676ccc>,</span><span> FQOption</span><span style=color:#61676ccc>,</span><span> FQResult}</span><span style=color:#61676ccc>,
</span><span>    terminated_parser</span><span style=color:#61676ccc>,
</span><span>}</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-reflect-derive-src-field-attributes-rs><code>crates/bevy_reflect/derive/src/field_attributes.rs</code></h3><p>Updated imports to use the moved utility:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>use crate</span><span style=color:#61676ccc>::</span><span>{
</span><span>    attribute_parser</span><span style=color:#ed9366>::</span><span>terminated_parser</span><span style=color:#61676ccc>, </span><span>custom_attributes</span><span style=color:#ed9366>::</span><span>CustomAttributes</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#ff8f40>REFLECT_ATTRIBUTE_NAME</span><span style=color:#61676ccc>,
</span><span>}</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>use crate</span><span style=color:#61676ccc>::</span><span>{custom_attributes</span><span style=color:#ed9366>::</span><span>CustomAttributes</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>REFLECT_ATTRIBUTE_NAME</span><span>}</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>use </span><span>bevy_macro_utils</span><span style=color:#ed9366>::</span><span>terminated_parser</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-reflect-derive-src-derive-data-rs><code>crates/bevy_reflect/derive/src/derive_data.rs</code></h3><p>Updated imports to use the moved utility:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>use crate</span><span style=color:#61676ccc>::</span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other imports ...
</span><span>    result_sifter</span><span style=color:#ed9366>::</span><span>ResultSifter</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other imports ...
</span><span>}</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>use crate</span><span style=color:#61676ccc>::</span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other imports ...
</span><span>}</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>use </span><span>bevy_macro_utils</span><span style=color:#ed9366>::</span><span>ResultSifter</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-reflect-derive-src-lib-rs><code>crates/bevy_reflect/derive/src/lib.rs</code></h3><p>Removed the moved modules from the reflection derive crate:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// These modules were removed:
</span><span style=color:#abb0b6;font-style:italic>// mod attribute_parser;
</span><span style=color:#abb0b6;font-style:italic>// mod result_sifter;
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/book/ch07-02-defining-modules-to-control-scope-and-privacy.html target=_blank>Rust Modules and Visibility</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/tree/main/crates/bevy_macro_utils target=_blank>Bevy Engine Macro Utilities</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/syn/latest/syn/ target=_blank>Syn crate for procedural macros</a><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/reference/procedural-macros.html target=_blank>Rust Procedural Macros Guide</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-09/pr_18204.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>