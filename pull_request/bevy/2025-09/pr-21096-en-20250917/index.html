<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21096 Fix tasks on wasm
        
    </title><meta content="#21096 Fix tasks on wasm" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-09/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-09-17</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-09/pr-21096-zh-cn-20250917>中文</a></div></div><div class=pr-content><h1 id=fix-tasks-on-wasm>Fix tasks on wasm</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix tasks on wasm<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21096<li><strong>Author</strong>: NthTensor<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, D-Trivial, P-Crash, O-Web, S-Ready-For-Review, A-Tasks, D-Async<li><strong>Created</strong>: 2025-09-16T21:17:48Z<li><strong>Merged</strong>: 2025-09-16T23:43:03Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p><strong>Objective</strong><p>Fix #21079. This was caused by incorrectly dropping a future.<p><strong>Solution</strong><p>Await the future instead of dropping it.<p><strong>Testing</strong><p>See https://github.com/bevyengine/bevy/issues/21079#issuecomment-3295174637. @rparrett has indicated this resolves the issue. I have not personally tested it.<p>We need to figure out a better solution to unit test the web. This would be very easy to test, except that it requires <code>web_bindgen_futures</code> and has to run in a browser environment.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a critical issue with task execution in WebAssembly (wasm) environments. The problem originated from improper future handling in Bevy’s task system, where a future was being dropped prematurely instead of being properly awaited. This caused crashes and unexpected behavior in wasm targets, which are particularly sensitive to async task management due to their single-threaded nature and different concurrency model compared to native platforms.<p>The issue was identified in the web-specific implementation of task spawning within <code>bevy_tasks</code>. The code was setting up a channel to communicate task results but was using a synchronous send operation that could drop the value if the channel was full. In wasm environments, this led to the future being dropped incorrectly, causing the observed crashes.<p>The solution was straightforward but critical: replace the synchronous <code>send</code> operation with an asynchronous <code>send().await</code>. This ensures that the send operation properly yields execution until the channel has capacity, preventing the future from being dropped and ensuring the task result is properly communicated.<p>The implementation change is minimal but impactful. In the web-specific code path, the line:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let </span><span style=color:#ed9366>_ =</span><span> sender</span><span style=color:#ed9366>.</span><span style=color:#f07171>send</span><span>(value)</span><span style=color:#61676ccc>;
</span></code></pre><p>was changed to:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let </span><span style=color:#ed9366>_ =</span><span> sender</span><span style=color:#ed9366>.</span><span style=color:#f07171>send</span><span>(value)</span><span style=color:#ed9366>.</span><span>await</span><span style=color:#61676ccc>;
</span></code></pre><p>This change ensures that the send operation is properly awaited, allowing the async runtime to manage the task execution correctly in wasm environments. The fix is surgical and targeted, affecting only the web implementation while leaving native platforms unchanged.<p>From a technical perspective, this highlights the importance of proper async/await patterns in cross-platform game engines. Wasm environments require careful attention to future handling since they operate in a browser context with different concurrency constraints than native systems. The fix demonstrates how subtle differences in async handling can have significant impacts across different target platforms.<p>The impact of this change is substantial for web-based Bevy applications. It resolves crash conditions and ensures that tasks execute reliably in wasm targets. This is particularly important for web games and applications built with Bevy that rely on async task processing.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Task Execution] --> B{Platform Check}
</span><span>    B -->|Web| C[Async Send with await]
</span><span>    B -->|Native| D[Standard Send]
</span><span>    C --> E[Proper Future Completion]
</span><span>    D --> E
</span><span>    E --> F[Stable Task Execution]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>File: crates/bevy_tasks/src/task.rs</strong><p>This file contains the core task implementation for Bevy’s async task system. The change was made in the web-specific implementation section to fix improper future handling.<p><strong>Code Change:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> value </span><span style=color:#ed9366>=</span><span> CatchUnwind(AssertUnwindSafe(future))</span><span style=color:#ed9366>.</span><span>await</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let </span><span style=color:#ed9366>_ =</span><span> sender</span><span style=color:#ed9366>.</span><span style=color:#f07171>send</span><span>(value)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> value </span><span style=color:#ed9366>=</span><span> CatchUnwind(AssertUnwindSafe(future))</span><span style=color:#ed9366>.</span><span>await</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let </span><span style=color:#ed9366>_ =</span><span> sender</span><span style=color:#ed9366>.</span><span style=color:#f07171>send</span><span>(value)</span><span style=color:#ed9366>.</span><span>await</span><span style=color:#61676ccc>;
</span></code></pre><p>The change ensures that the send operation is properly awaited in web environments, preventing premature future dropping and ensuring reliable task execution in wasm targets.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://rust-lang.github.io/async-book/ target=_blank>Async/Await in Rust</a><li><a rel="noopener nofollow noreferrer" href=https://rustwasm.github.io/docs/wasm-bindgen/reference/js-promises-and-rust-futures.html target=_blank>WebAssembly and Async Rust</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_tasks/latest/bevy_tasks/ target=_blank>Bevy Tasks Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/futures/0.3/futures/channel/mpsc/struct.Sender.html#method.send target=_blank>futures::channel::mpsc Documentation</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-09/pr_21096.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>