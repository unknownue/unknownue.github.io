<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20805 Implement `VisitAssetDependencies` for Arrays
        
    </title><meta content="#20805 Implement `VisitAssetDependencies` for Arrays" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-09/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-09-02</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-09/pr-20805-zh-cn-20250902>中文</a></div></div><div class=pr-content><h1 id=implement-visitassetdependencies-for-arrays>Implement <code>VisitAssetDependencies</code> for Arrays</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Implement <code>VisitAssetDependencies</code> for Arrays<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20805<li><strong>Author</strong>: Glory2Antares<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Assets, S-Ready-For-Final-Review, X-Uncontroversial, D-Straightforward<li><strong>Created</strong>: 2025-08-31T00:05:31Z<li><strong>Merged</strong>: 2025-09-02T22:43:46Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Since <code>Vec&LTHandle&LTA>></code> and <code>Vec&LTUntypedHandle></code> implement <code>VisitAssetDependencies</code> users might expect <code>[Handle&LTA>; N]</code> and <code>[UntypedHandle; N]</code> to also implement <code>VisitAssetDependencies</code>, but this is currently not the case.<li>The <code>#[dependency]</code> attribute from the <code>Asset</code> derive macro should work with an implementation.</ul><h2 id=solution>Solution</h2><p>Implement <code>VisitAssetDependencies</code> for <code>[Handle&LTA>; N]</code> and <code>[UntypedHandle; N]</code>. The implementations are based on the corresponding ones for Vec.<h2 id=testing>Testing</h2><p>A test for compatibility with the derive macros was added for <code>[Handle&LTA>; N]</code> and <code>[UntypedHandle; N]</code>.<hr><h2 id=showcase>Showcase</h2><p>Before:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Can't use the Asset macro with a custom VisitAssetDependencies impl 
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(TypePath)]
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>MyAsset </span><span>{
</span><span>    images</span><span style=color:#61676ccc>:</span><span> [Handle&LTImage>; 5],
</span><span>}
</span><span>
</span><span style=color:#fa6e32>impl </span><span>VisitAssetDependencies </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>MyAsset </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>visit_dependencies</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>visit</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> impl FnMut(</span><span style=color:#ff8f40>UntypedAssetId</span><span>)) {
</span><span>        </span><span style=color:#fa6e32>for</span><span> image </span><span style=color:#ed9366>in &</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>images {
</span><span>            </span><span style=color:#f07171>visit</span><span>(image</span><span style=color:#ed9366>.</span><span style=color:#f07171>id</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>untyped</span><span>())</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#fa6e32>impl </span><span>Asset </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>MyAsset </span><span>{}
</span></code></pre><p>After:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Asset</span><span style=color:#61676ccc>,</span><span> TypePath)]
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>MyAsset </span><span>{
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>dependency</span><span>]
</span><span>    images</span><span style=color:#61676ccc>:</span><span> [Handle&LTImage>; 5],
</span><span>}
</span></code></pre><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a consistency gap in Bevy’s asset dependency tracking system. The core issue was that while <code>Vec&LTHandle&LTA>></code> and <code>Vec&LTUntypedHandle></code> implemented the <code>VisitAssetDependencies</code> trait, fixed-size arrays (<code>[Handle&LTA>; N]</code> and <code>[UntypedHandle; N]</code>) did not. This created an inconsistency where developers couldn’t use the <code>#[dependency]</code> attribute with array fields in their asset structs, forcing them to write manual implementations.<p>The solution was straightforward: implement <code>VisitAssetDependencies</code> for both typed and untyped handle arrays, following the same pattern already established for vectors. The implementation simply iterates through each element in the array and calls the visitor function with the appropriate asset ID.<p>The changes maintain consistency with existing patterns while extending functionality to cover array types. This is particularly useful for assets that need a fixed number of dependencies, such as texture atlases with predetermined sprite counts or materials with a set number of texture slots.<p>Testing was added to ensure the derive macro works correctly with array types, verifying that the <code>#[dependency]</code> attribute properly handles both <code>[Handle&LTA>; N]</code> and <code>[UntypedHandle; N]</code> fields.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[VisitAssetDependencies Trait] --> B[Vec&LTHandle&LTA>>]
</span><span>    A --> C[Vec&LTUntypedHandle>]
</span><span>    A --> D[Option&LTHandle&LTA>>]
</span><span>    A --> E[Option&LTUntypedHandle>]
</span><span>    A --> F[[Handle&LTA>; N]]
</span><span>    A --> G[[UntypedHandle; N]]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-asset-src-lib-rs-21-0><code>crates/bevy_asset/src/lib.rs</code> (+21/-0)</h3><p>This file received two new trait implementations and corresponding test coverage:<ol><li>Added <code>VisitAssetDependencies</code> implementation for typed handle arrays:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>impl</span><span>&LTA</span><span style=color:#61676ccc>:</span><span> Asset, </span><span style=color:#fa6e32>const</span><span> N</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize</span><span>> VisitAssetDependencies </span><span style=color:#fa6e32>for</span><span> [</span><span style=color:#399ee6>Handle</span><span>&LTA>; </span><span style=color:#399ee6>N</span><span>] {
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>visit_dependencies</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>visit</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> impl FnMut(</span><span style=color:#ff8f40>UntypedAssetId</span><span>)) {
</span><span>        </span><span style=color:#fa6e32>for</span><span> dependency </span><span style=color:#ed9366>in </span><span style=color:#55b4d4;font-style:italic>self </span><span>{
</span><span>            </span><span style=color:#f07171>visit</span><span>(dependency</span><span style=color:#ed9366>.</span><span style=color:#f07171>id</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>untyped</span><span>())</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre><ol start=2><li>Added <code>VisitAssetDependencies</code> implementation for untyped handle arrays:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>impl</span><span><</span><span style=color:#fa6e32>const</span><span> N</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize</span><span>> VisitAssetDependencies </span><span style=color:#fa6e32>for</span><span> [</span><span style=color:#399ee6>UntypedHandle</span><span>; </span><span style=color:#399ee6>N</span><span>] {
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>visit_dependencies</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>visit</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> impl FnMut(</span><span style=color:#ff8f40>UntypedAssetId</span><span>)) {
</span><span>        </span><span style=color:#fa6e32>for</span><span> dependency </span><span style=color:#ed9366>in </span><span style=color:#55b4d4;font-style:italic>self </span><span>{
</span><span>            </span><span style=color:#f07171>visit</span><span>(dependency</span><span style=color:#ed9366>.</span><span style=color:#f07171>id</span><span>())</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre><ol start=3><li>Added test coverage with a new struct that includes array dependencies:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>struct </span><span style=color:#399ee6>TestAssetWithArrays </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other fields
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>dependency</span><span>]
</span><span>    array_handles</span><span style=color:#61676ccc>:</span><span> [Handle&LTTestAsset>; 5],
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>dependency</span><span>]
</span><span>    untyped_array_handles</span><span style=color:#61676ccc>:</span><span> [UntypedHandle; 5],
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/books/the-assets-system/ target=_blank>Bevy Assets Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/book/ch03-02-data-types.html#the-array-type target=_blank>Rust Arrays vs Vectors</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/crates/bevy_asset/src/dependency.rs target=_blank>Bevy Dependency Tracking</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-09/pr_20805.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>