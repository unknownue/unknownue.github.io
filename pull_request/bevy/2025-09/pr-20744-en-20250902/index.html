<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20744 Cleanup bevy_tasks::future module
        
    </title><meta content="#20744 Cleanup bevy_tasks::future module" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-09/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-09-02</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-09/pr-20744-zh-cn-20250902>中文</a></div></div><div class=pr-content><h1 id=cleanup-bevy-tasks-future-module>Cleanup bevy_tasks::future module</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Cleanup bevy_tasks::future module<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20744<li><strong>Author</strong>: james7132<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: D-Trivial, C-Code-Quality, S-Ready-For-Final-Review, A-Tasks<li><strong>Created</strong>: 2025-08-25T06:56:38Z<li><strong>Merged</strong>: 2025-09-01T23:33:14Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p><code>Waker::noop</code> was stabilized in Rust 1.85, and we have a vendored version in tree.<h2 id=solution>Solution</h2><p>Remove it and clean up related code.<h2 id=testing>Testing</h2><p>CI<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a straightforward but important maintenance task: removing custom implementations of functionality that has been stabilized in the Rust standard library. The core issue was that Bevy maintained a vendored implementation of a no-op waker (<code>noop_waker</code>) because <code>Waker::noop</code> wasn’t stable in previous Rust versions. With Rust 1.85 stabilizing this functionality, the custom implementation became redundant technical debt.<p>The solution approach was direct: replace all uses of the custom <code>noop_waker</code> with the standard <code>Waker::noop()</code> and remove the now-unnecessary implementation code. This cleanup also revealed an opportunity to simplify the <code>check_ready</code> function, which was essentially doing the same thing as <code>now_or_never</code> but with slightly different pinning semantics.<p>In the implementation, the <code>now_or_never</code> function was significantly simplified. Previously, it manually created a no-op waker using unsafe code and raw waker operations:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>now_or_never</span><span>&LTF</span><span style=color:#61676ccc>:</span><span> Future>(</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>future</span><span style=color:#61676ccc>:</span><span> F) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#fa6e32>F</span><span style=color:#ed9366>::</span><span>Output> {
</span><span>    </span><span style=color:#fa6e32>let</span><span> noop_waker </span><span style=color:#ed9366>= </span><span style=color:#f07171>noop_waker</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> cx </span><span style=color:#ed9366>= </span><span>Context</span><span style=color:#ed9366>::</span><span>from_waker(</span><span style=color:#ed9366>&</span><span>noop_waker)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> future </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>unsafe </span><span>{ Pin</span><span style=color:#ed9366>::</span><span>new_unchecked(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> future) }</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>match</span><span> future</span><span style=color:#ed9366>.</span><span style=color:#f07171>poll</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> cx) {
</span><span>        Poll</span><span style=color:#ed9366>::</span><span>Ready(x) </span><span style=color:#ed9366>=> </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(x)</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#ed9366>_ => </span><span style=color:#55b4d4;font-style:italic>None</span><span style=color:#61676ccc>,
</span><span>    }
</span><span>}
</span></code></pre><p>The updated version uses the standard <code>Waker::noop()</code> and the safe <code>pin!</code> macro:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// After
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>now_or_never</span><span>&LTF</span><span style=color:#61676ccc>:</span><span> Future>(</span><span style=color:#ff8f40>future</span><span style=color:#61676ccc>:</span><span> F) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#fa6e32>F</span><span style=color:#ed9366>::</span><span>Output> {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> cx </span><span style=color:#ed9366>= </span><span>Context</span><span style=color:#ed9366>::</span><span>from_waker(Waker</span><span style=color:#ed9366>::</span><span>noop())</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>match </span><span style=color:#f07171>pin!</span><span>(future)</span><span style=color:#ed9366>.</span><span style=color:#f07171>poll</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> cx) {
</span><span>        Poll</span><span style=color:#ed9366>::</span><span>Ready(x) </span><span style=color:#ed9366>=> </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(x)</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#ed9366>_ => </span><span style=color:#55b4d4;font-style:italic>None</span><span style=color:#61676ccc>,
</span><span>    }
</span><span>}
</span></code></pre><p>This change eliminates unsafe code and makes the function more readable. The <code>check_ready</code> function was then simplified to just call <code>now_or_never</code>, removing code duplication.<p>The technical insights here are about leveraging language stabilizations to reduce maintenance burden and improve code safety. The switch from unsafe manual waker creation to the standard library’s safe implementation reduces the potential for bugs and makes the code more accessible to developers unfamiliar with the intricacies of waker implementation.<p>The impact of these changes is primarily in code quality and maintainability:<ul><li>Removal of 32 lines of custom waker implementation code<li>Elimination of unsafe code in the future utilities<li>More idiomatic Rust using standard library functionality<li>Reduced cognitive load for developers working with this code</ul><h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Custom noop_waker] --> B[Remove custom implementation]
</span><span>    C[Rust 1.85 Waker::noop] --> D[Use standard library]
</span><span>    B --> E[Cleaner codebase]
</span><span>    D --> E
</span><span>    E --> F[Reduced maintenance burden]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-tasks-src-futures-rs-6-38><code>crates/bevy_tasks/src/futures.rs</code> (+6/-38)</h3><p>This file contained the custom no-op waker implementation and future utility functions. The changes removed the custom waker implementation and simplified the future polling functions.<p><strong>Key changes:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Custom no-op waker implementation
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>noop_clone</span><span>(</span><span style=color:#ff8f40>_data</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>*const </span><span>()) </span><span style=color:#61676ccc>-></span><span> RawWaker {
</span><span>    </span><span style=color:#f07171>noop_raw_waker</span><span>()
</span><span>}
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>noop</span><span>(</span><span style=color:#ff8f40>_data</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>*const </span><span>()) {}
</span><span>
</span><span style=color:#fa6e32>const </span><span style=color:#ff8f40>NOOP_WAKER_VTABLE</span><span style=color:#61676ccc>:</span><span> RawWakerVTable </span><span style=color:#ed9366>= </span><span>RawWakerVTable</span><span style=color:#ed9366>::</span><span>new(noop_clone</span><span style=color:#61676ccc>,</span><span> noop</span><span style=color:#61676ccc>,</span><span> noop</span><span style=color:#61676ccc>,</span><span> noop)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>noop_raw_waker</span><span>() </span><span style=color:#61676ccc>-></span><span> RawWaker {
</span><span>    RawWaker</span><span style=color:#ed9366>::</span><span>new(core</span><span style=color:#ed9366>::</span><span>ptr</span><span style=color:#ed9366>::</span><span>null()</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span style=color:#ff8f40>NOOP_WAKER_VTABLE</span><span>)
</span><span>}
</span><span>
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>noop_waker</span><span>() </span><span style=color:#61676ccc>-></span><span> Waker {
</span><span>    </span><span style=color:#fa6e32>unsafe </span><span>{ Waker</span><span style=color:#ed9366>::</span><span>from_raw(</span><span style=color:#f07171>noop_raw_waker</span><span>()) }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Removed entirely, using Waker::noop() instead
</span></code></pre><h3 id=crates-bevy-tasks-src-lib-rs-1-2><code>crates/bevy_tasks/src/lib.rs</code> (+1/-2)</h3><p>This file contained one usage of the custom <code>noop_waker</code> function in the <code>block_on</code> implementation.<p><strong>Key changes:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> waker </span><span style=color:#ed9366>= </span><span>futures</span><span style=color:#ed9366>::</span><span>noop_waker()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> cx </span><span style=color:#ed9366>= &</span><span style=color:#fa6e32>mut </span><span>Context</span><span style=color:#ed9366>::</span><span>from_waker(</span><span style=color:#ed9366>&</span><span>waker)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> cx </span><span style=color:#ed9366>= &</span><span style=color:#fa6e32>mut </span><span>Context</span><span style=color:#ed9366>::</span><span>from_waker(core</span><span style=color:#ed9366>::</span><span>task</span><span style=color:#ed9366>::</span><span>Waker</span><span style=color:#ed9366>::</span><span>noop())</span><span style=color:#61676ccc>;
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://blog.rust-lang.org/2025/01/30/Rust-1.85.0.html target=_blank>Rust 1.85.0 Release Notes</a> - Details about Waker::noop stabilization<li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/std/task/struct.Waker.html#method.noop target=_blank>Rust Standard Library Waker Documentation</a> - Official documentation for Waker::noop<li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/std/pin/index.html target=_blank>Rust Pin API Guide</a> - Understanding pinning and why it’s necessary for futures</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-09/pr_20744.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>