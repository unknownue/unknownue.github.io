<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21189 Print `Name` in `validate_parent_has_component`
        
    </title><meta content="#21189 Print `Name` in `validate_parent_has_component`" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-09/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-09-25</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-09/pr-21189-zh-cn-20250925>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Print <code>Name</code> in <code>validate_parent_has_component</code><li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21189<li><strong>Author</strong>: Zeophlite<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-ECS, S-Ready-For-Final-Review, D-Straightforward<li><strong>Created</strong>: 2025-09-24T09:12:22Z<li><strong>Merged</strong>: 2025-09-25T17:12:32Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li><code>validate_parent_has_component</code> has a TODO to print the <code>Name</code> when available</ul><h2 id=solution>Solution</h2><ul><li>Print <code>Name</code></ul><h2 id=testing>Testing</h2><ul><li>CI, local testing in my repo</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a straightforward but important improvement to Bevy’s Entity Component System (ECS) hierarchy validation. The core issue was in the <code>validate_parent_has_component</code> function, which performs critical validation checks when entities have parent-child relationships with specific component requirements.<p>The problem was that when this validation failed, the error messages were not as helpful as they could be. The original implementation had a TODO comment indicating that the function should print entity names when available, but this functionality wasn’t implemented. Instead, the error messages only showed raw entity IDs, which are difficult for developers to correlate with their actual game objects during debugging.<p>The solution approach was direct: leverage the existing <code>Name</code> component that had since been moved into <code>bevy_ecs</code> (making it available for use in this context). The implementation required updating the error message formatting to extract and display entity names when they exist, while falling back to entity IDs when names aren’t available.<p>The key technical insight here is about improving developer experience through better error messages. When working with complex entity hierarchies, being able to quickly identify which specific entities are causing validation issues significantly reduces debugging time. The changes follow Rust’s common pattern of using <code>map_or_else</code> to handle optional values gracefully.<p>The implementation refactors the validation logic slightly for clarity. Instead of using <code>is_ok_and</code>, it now uses an <code>if let</code> pattern that makes the control flow more explicit. This change also allows for cleaner extraction of both the child and parent entity names within the same conditional block.<p>The impact of this change is purely positive - it enhances debugging capabilities without affecting performance or functionality. Developers now get immediately actionable information when hierarchy validation fails, showing exactly which named entities are involved in the problem.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[validate_parent_has_component] --> B[Entity World Access]
</span><span>    B --> C[Name Component Check]
</span><span>    C --> D[Error Message Generation]
</span><span>    D --> E[Debug Output]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ecs-src-hierarchy-rs-13-5><code>crates/bevy_ecs/src/hierarchy.rs</code> (+13/-5)</h3><p>This file contains the core hierarchy validation logic for Bevy’s ECS system. The changes improve the error messaging in the <code>validate_parent_has_component</code> function.<p><strong>Key Changes:</strong><ol><li><strong>Import Addition</strong>: Added <code>Name</code> component import to make it available for use<li><strong>Logic Refactoring</strong>: Changed from <code>is_ok_and</code> to explicit <code>if let</code> pattern for better readability<li><strong>Error Message Enhancement</strong>: Added entity name extraction and formatting</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>world</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_entity</span><span>(parent)</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_ok_and</span><span>(|</span><span style=color:#ff8f40>e</span><span>| e</span><span style=color:#ed9366>.</span><span>contains</span><span style=color:#ed9366>::</span><span>&LTC>()) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// TODO: print name here once Name lives in bevy_ecs
</span><span>    </span><span style=color:#fa6e32>let</span><span> name</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#55b4d4;font-style:italic>String</span><span>> </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>None</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> debug_name </span><span style=color:#ed9366>= </span><span>DebugName</span><span style=color:#ed9366>::</span><span>type_name</span><span style=color:#ed9366>::</span><span>&LTC>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#f07171>warn!</span><span>(
</span><span>        </span><span style=color:#86b300>"warning[B0004]: {}{name} with the {ty_name} component has a parent ({parent}) without {ty_name}.</span><span style=color:#4cbf99>\n</span><span style=color:#61676ccc>\
</span><span style=color:#86b300>        This will cause inconsistent behaviors! See: https://bevy.org/learn/errors/b0004"</span><span style=color:#61676ccc>,
</span><span>        caller</span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|</span><span style=color:#ff8f40>c</span><span>| </span><span style=color:#f07171>format!</span><span>(</span><span style=color:#86b300>"</span><span style=color:#ff8f40>{c}</span><span style=color:#86b300>: "</span><span>))</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_or_default</span><span>()</span><span style=color:#61676ccc>,
</span><span>        ty_name </span><span style=color:#ed9366>=</span><span> debug_name</span><span style=color:#ed9366>.</span><span style=color:#f07171>shortname</span><span>()</span><span style=color:#61676ccc>,
</span><span>        name </span><span style=color:#ed9366>=</span><span> name</span><span style=color:#ed9366>.</span><span style=color:#f07171>map_or_else</span><span>(
</span><span>            || </span><span style=color:#f07171>format!</span><span>(</span><span style=color:#86b300>"Entity </span><span style=color:#ff8f40>{entity}</span><span style=color:#86b300>"</span><span>)</span><span style=color:#61676ccc>,
</span><span>            |</span><span style=color:#ff8f40>s</span><span>| </span><span style=color:#f07171>format!</span><span>(</span><span style=color:#86b300>"The </span><span style=color:#ff8f40>{s}</span><span style=color:#86b300> entity"</span><span>)
</span><span>        )</span><span style=color:#61676ccc>,
</span><span>    )</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> maybe_parent_ref </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_entity</span><span>(parent)</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(parent_ref) </span><span style=color:#ed9366>=</span><span> maybe_parent_ref
</span><span>    </span><span style=color:#ed9366>&& !</span><span>parent_ref</span><span style=color:#ed9366>.</span><span>contains</span><span style=color:#ed9366>::</span><span>&LTC>()
</span><span>{
</span><span>    </span><span style=color:#fa6e32>let</span><span> name </span><span style=color:#ed9366>=</span><span> entity_ref</span><span style=color:#ed9366>.</span><span>get</span><span style=color:#ed9366>::</span><span>&LTName>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> debug_name </span><span style=color:#ed9366>= </span><span>DebugName</span><span style=color:#ed9366>::</span><span>type_name</span><span style=color:#ed9366>::</span><span>&LTC>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> parent_name </span><span style=color:#ed9366>=</span><span> parent_ref</span><span style=color:#ed9366>.</span><span>get</span><span style=color:#ed9366>::</span><span>&LTName>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#f07171>warn!</span><span>(
</span><span>        </span><span style=color:#86b300>"warning[B0004]: {}{name} with the {ty_name} component has a parent ({parent_name}) without {ty_name}.</span><span style=color:#4cbf99>\n</span><span style=color:#61676ccc>\
</span><span style=color:#86b300>        This will cause inconsistent behaviors! See: https://bevy.org/learn/errors/b0004"</span><span style=color:#61676ccc>,
</span><span>        caller</span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|</span><span style=color:#ff8f40>c</span><span>| </span><span style=color:#f07171>format!</span><span>(</span><span style=color:#86b300>"</span><span style=color:#ff8f40>{c}</span><span style=color:#86b300>: "</span><span>))</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_or_default</span><span>()</span><span style=color:#61676ccc>,
</span><span>        ty_name </span><span style=color:#ed9366>=</span><span> debug_name</span><span style=color:#ed9366>.</span><span style=color:#f07171>shortname</span><span>()</span><span style=color:#61676ccc>,
</span><span>        name </span><span style=color:#ed9366>=</span><span> name</span><span style=color:#ed9366>.</span><span style=color:#f07171>map_or_else</span><span>(
</span><span>            || </span><span style=color:#f07171>format!</span><span>(</span><span style=color:#86b300>"Entity </span><span style=color:#ff8f40>{entity}</span><span style=color:#86b300>"</span><span>)</span><span style=color:#61676ccc>,
</span><span>            |</span><span style=color:#ff8f40>s</span><span>| </span><span style=color:#f07171>format!</span><span>(</span><span style=color:#86b300>"The </span><span style=color:#ff8f40>{s}</span><span style=color:#86b300> entity"</span><span>)
</span><span>        )</span><span style=color:#61676ccc>,
</span><span>        parent_name </span><span style=color:#ed9366>=</span><span> parent_name</span><span style=color:#ed9366>.</span><span style=color:#f07171>map_or_else</span><span>(
</span><span>            || </span><span style=color:#f07171>format!</span><span>(</span><span style=color:#86b300>"</span><span style=color:#ff8f40>{parent}</span><span style=color:#86b300> entity"</span><span>)</span><span style=color:#61676ccc>,
</span><span>            |</span><span style=color:#ff8f40>s</span><span>| </span><span style=color:#f07171>format!</span><span>(</span><span style=color:#86b300>"the </span><span style=color:#ff8f40>{s}</span><span style=color:#86b300> entity"</span><span>)
</span><span>        )</span><span style=color:#61676ccc>,
</span><span>    )</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>The changes relate directly to the PR’s purpose by implementing the previously noted TODO comment and making error messages more developer-friendly.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_ecs/latest/bevy_ecs/ target=_blank>Bevy ECS Documentation</a> - Comprehensive guide to Bevy’s Entity Component System<li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/std/option/enum.Option.html target=_blank>Rust Option Type Documentation</a> - Understanding how <code>map_or_else</code> works with optional values<li><a rel="noopener nofollow noreferrer" href=https://bevy.org/learn/errors/b0004 target=_blank>Bevy Error B0004</a> - Official documentation for the specific error being improved</ul><h1 id=full-code-diff>Full Code Diff</h1><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_ecs/src/hierarchy.rs b/crates/bevy_ecs/src/hierarchy.rs
</span><span>index ad390db97bf72..83419c70eb964 100644
</span><span style=color:#c594c5>--- a/crates/bevy_ecs/src/hierarchy.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_ecs/src/hierarchy.rs
</span><span style=color:#c594c5>@@ -13,11 +13,12 @@ </span><span style=color:#399ee6>use crate::{
</span><span>     component::Component,
</span><span>     entity::Entity,
</span><span>     lifecycle::HookContext,
</span><span style=color:#86b300>+    name::Name,
</span><span>     relationship::{RelatedSpawner, RelatedSpawnerCommands},
</span><span>     system::EntityCommands,
</span><span>     world::{DeferredWorld, EntityWorldMut, FromWorld, World},
</span><span> };
</span><span style=color:#f07171>-use alloc::{format, string::String, vec::Vec};
</span><span style=color:#86b300>+use alloc::{format, vec::Vec};
</span><span> #[cfg(feature = "bevy_reflect")]
</span><span> use bevy_reflect::std_traits::ReflectDefault;
</span><span> #[cfg(all(feature = "serialize", feature = "bevy_reflect"))]
</span><span style=color:#c594c5>@@ -456,12 +457,15 @@ </span><span style=color:#399ee6>pub fn validate_parent_has_component&LTC: Component>(
</span><span>         return;
</span><span>     };
</span><span>     let parent = child_of.parent();
</span><span style=color:#f07171>-    if !world.get_entity(parent).is_ok_and(|e| e.contains::&LTC>()) {
</span><span style=color:#f07171>-        // TODO: print name here once Name lives in bevy_ecs
</span><span style=color:#f07171>-        let name: Option&LTString> = None;
</span><span style=color:#86b300>+    let maybe_parent_ref = world.get_entity(parent);
</span><span style=color:#86b300>+    if let Ok(parent_ref) = maybe_parent_ref
</span><span style=color:#86b300>+        && !parent_ref.contains::&LTC>()
</span><span style=color:#86b300>+    {
</span><span style=color:#86b300>+        let name = entity_ref.get::&LTName>();
</span><span>         let debug_name = DebugName::type_name::&LTC>();
</span><span style=color:#86b300>+        let parent_name = parent_ref.get::&LTName>();
</span><span>         warn!(
</span><span style=color:#f07171>-            "warning[B0004]: {}{name} with the {ty_name} component has a parent ({parent}) without {ty_name}.\n\
</span><span style=color:#86b300>+            "warning[B0004]: {}{name} with the {ty_name} component has a parent ({parent_name}) without {ty_name}.\n\
</span><span>             This will cause inconsistent behaviors! See: https://bevy.org/learn/errors/b0004",
</span><span>             caller.map(|c| format!("{c}: ")).unwrap_or_default(),
</span><span>             ty_name = debug_name.shortname(),
</span><span style=color:#c594c5>@@ -469,6 +473,10 @@ </span><span style=color:#399ee6>pub fn validate_parent_has_component&LTC: Component>(
</span><span>                 || format!("Entity {entity}"),
</span><span>                 |s| format!("The {s} entity")
</span><span>             ),
</span><span style=color:#86b300>+            parent_name = parent_name.map_or_else(
</span><span style=color:#86b300>+                || format!("{parent} entity"),
</span><span style=color:#86b300>+                |s| format!("the {s} entity")
</span><span style=color:#86b300>+            ),
</span><span>         );
</span><span>     }
</span><span> }
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-09/pr_21189.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>