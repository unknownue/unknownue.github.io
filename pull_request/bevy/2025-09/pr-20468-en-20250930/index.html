<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20468 Remove `offset` argument from `TrackedRenderPass::set_index_buffer`
        
    </title><meta content="#20468 Remove `offset` argument from `TrackedRenderPass::set_index_buffer`" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-09/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-09-30</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-09/pr-20468-zh-cn-20250930>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>Remove <code>offset</code> argument from <code>TrackedRenderPass::set_index_buffer</code><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Remove <code>offset</code> argument from <code>TrackedRenderPass::set_index_buffer</code><li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20468<li><strong>Author</strong>: akimakinai<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: D-Trivial, A-Rendering, C-Code-Quality, C-Usability, M-Needs-Migration-Guide<li><strong>Created</strong>: 2025-08-09T03:05:09Z<li><strong>Merged</strong>: 2025-09-30T03:20:20Z<li><strong>Merged By</strong>: james7132</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li><code>offset</code> argument is misleading as the argument is not actually passed to wgpu (used only for memoization and logging). <code>BufferSlice</code> already contains an offset. <ul><li>wgpu’s <code>set_index_buffer</code> <a rel="noopener nofollow noreferrer" href=https://github.com/gfx-rs/wgpu/blob/e990388af98e4b4dff9f7fcc09a4eb5d2f71d227/wgpu/src/api/render_pass.rs#L98-L105 target=_blank>sets the offset according to BufferSlice::offset</a></ul><li><code>TrackedRenderPass::set_vertex_buffer</code> was made aware of slice size (#14916) but missed <code>set_index_buffer</code> counterpart</ul><h2 id=solution>Solution</h2><ul><li>Removed <code>offset</code> argument from <code>TrackedRenderPass::set_index_buffer</code><li>Apply fix from #14916 to <code>TrackedRenderPass::is_index_buffer_set</code><li><del>Cleanup code by using the newly added <code>BufferSlice</code> getters</del> split out to https://github.com/bevyengine/bevy/pull/21289</ul><h2 id=testing>Testing</h2><ul><li>Ran a few examples</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a consistency issue in Bevy’s rendering API where the <code>set_index_buffer</code> method had a redundant <code>offset</code> parameter. The core problem was that the API design didn’t align with how the underlying graphics API actually worked.<p>The issue stemmed from how <code>BufferSlice</code> objects already contain offset information internally. When you create a buffer slice using methods like <code>buffer.slice(1..)</code>, the slice tracks its starting position within the original buffer. However, the <code>TrackedRenderPass::set_index_buffer</code> method was asking for this offset twice - once implicitly through the <code>BufferSlice</code> and once explicitly as a separate <code>offset</code> parameter.<p>Looking at the underlying wgpu implementation, it became clear that only the offset from the <code>BufferSlice</code> was actually being used when setting the index buffer on the GPU. The explicit <code>offset</code> parameter in Bevy’s API was only used for internal state tracking and logging purposes, creating a misleading API that suggested both offsets were meaningful.<p>The fix was straightforward: remove the redundant <code>offset</code> parameter and update the internal state tracking to properly use the offset information from the <code>BufferSlice</code>. This brought <code>set_index_buffer</code> in line with <code>set_vertex_buffer</code>, which had already received similar treatment in PR #14916.<p>The implementation involved modifying the <code>DrawState</code> struct to track index buffers using a <code>BufferSliceKey</code> (a tuple of buffer ID, offset, and size) instead of just the buffer ID and explicit offset. This ensured that the state tracking would correctly identify when the same buffer was being used with different slice ranges.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>set_index_buffer</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>buffer</span><span style=color:#61676ccc>:</span><span> BufferId, </span><span style=color:#ff8f40>offset</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u64</span><span>, </span><span style=color:#ff8f40>index_format</span><span style=color:#61676ccc>:</span><span> IndexFormat) {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>index_buffer </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>Some</span><span>((buffer</span><span style=color:#61676ccc>,</span><span> offset</span><span style=color:#61676ccc>,</span><span> index_format))</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>set_index_buffer</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>buffer_slice</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>BufferSlice, </span><span style=color:#ff8f40>index_format</span><span style=color:#61676ccc>:</span><span> IndexFormat) {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>index_buffer </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>Some</span><span>((</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>buffer_slice_key</span><span>(buffer_slice)</span><span style=color:#61676ccc>,</span><span> index_format))</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>The changes propagated throughout the codebase, requiring updates to all call sites. In practice, most calls were already passing <code>0</code> as the offset since developers were using <code>BufferSlice</code> to specify the desired range, making the migration straightforward.<p>The PR also included comprehensive updates to the debugging and tracing output, ensuring that when the “detailed_trace” feature is enabled, the logs would show both the offset and size information from the actual <code>BufferSlice</code> being used.<p>This change improves API consistency and eliminates potential confusion where developers might think they need to specify the offset in two different places. It also ensures that the internal state tracking correctly handles cases where the same buffer is used with different slice ranges.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[TrackedRenderPass] --> B[set_index_buffer]
</span><span>    B --> C[DrawState Tracking]
</span><span>    C --> D[BufferSlice Analysis]
</span><span>    D --> E[wgpu RenderPass]
</span><span>    B --> E
</span><span>    
</span><span>    F[BufferSlice] --> D
</span><span>    G[IndexFormat] --> B
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>crates/bevy_render/src/render_phase/draw_state.rs</strong> (+21/-35)<ul><li>Core changes to state tracking for index buffers<li>Introduced <code>BufferSliceKey</code> type alias for consistent buffer tracking<li>Updated <code>set_index_buffer</code> and <code>is_index_buffer_set</code> to use <code>BufferSlice</code> information</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>set_index_buffer</span><span>(
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>,
</span><span>    </span><span style=color:#ff8f40>buffer_slice</span><span style=color:#61676ccc>: </span><span>BufferSlice<</span><span style=color:#fa6e32>'a</span><span>>,
</span><span>    </span><span style=color:#ff8f40>offset</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u64</span><span>,
</span><span>    </span><span style=color:#ff8f40>index_format</span><span style=color:#61676ccc>:</span><span> IndexFormat,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>if </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>state</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_index_buffer_set</span><span>(buffer_slice</span><span style=color:#ed9366>.</span><span style=color:#f07171>id</span><span>()</span><span style=color:#61676ccc>,</span><span> offset</span><span style=color:#61676ccc>,</span><span> index_format) {
</span><span>        </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>pass</span><span style=color:#ed9366>.</span><span style=color:#f07171>set_index_buffer</span><span>(</span><span style=color:#ed9366>*</span><span>buffer_slice</span><span style=color:#61676ccc>,</span><span> index_format)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>state</span><span style=color:#ed9366>.</span><span style=color:#f07171>set_index_buffer</span><span>(buffer_slice</span><span style=color:#ed9366>.</span><span style=color:#f07171>id</span><span>()</span><span style=color:#61676ccc>,</span><span> offset</span><span style=color:#61676ccc>,</span><span> index_format)</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>set_index_buffer</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>buffer_slice</span><span style=color:#61676ccc>: </span><span>BufferSlice<</span><span style=color:#fa6e32>'a</span><span>>, </span><span style=color:#ff8f40>index_format</span><span style=color:#61676ccc>:</span><span> IndexFormat) {
</span><span>    </span><span style=color:#fa6e32>let</span><span> already_set </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>state</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_index_buffer_set</span><span>(</span><span style=color:#ed9366>&</span><span>buffer_slice</span><span style=color:#61676ccc>,</span><span> index_format)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>if</span><span> already_set {
</span><span>        </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>pass</span><span style=color:#ed9366>.</span><span style=color:#f07171>set_index_buffer</span><span>(</span><span style=color:#ed9366>*</span><span>buffer_slice</span><span style=color:#61676ccc>,</span><span> index_format)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>state</span><span style=color:#ed9366>.</span><span style=color:#f07171>set_index_buffer</span><span>(</span><span style=color:#ed9366>&</span><span>buffer_slice</span><span style=color:#61676ccc>,</span><span> index_format)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p><strong>release-content/migration-guides/set_index_buffer.md</strong> (+13/-0)<ul><li>New migration guide explaining the API change<li>Clear before/after examples showing how to update code</ul><p><strong>crates/bevy_pbr/src/render/mesh.rs</strong> (+1/-1)<ul><li>Updated mesh rendering to use new API signature</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>pass</span><span style=color:#ed9366>.</span><span style=color:#f07171>set_index_buffer</span><span>(index_buffer_slice</span><span style=color:#ed9366>.</span><span>buffer</span><span style=color:#ed9366>.</span><span style=color:#f07171>slice</span><span>(</span><span style=color:#ed9366>..</span><span>)</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>*</span><span>index_format)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>pass</span><span style=color:#ed9366>.</span><span style=color:#f07171>set_index_buffer</span><span>(index_buffer_slice</span><span style=color:#ed9366>.</span><span>buffer</span><span style=color:#ed9366>.</span><span style=color:#f07171>slice</span><span>(</span><span style=color:#ed9366>..</span><span>)</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>*</span><span>index_format)</span><span style=color:#61676ccc>;
</span></code></pre><p><strong>crates/bevy_sprite_render/src/mesh2d/mesh.rs</strong> (+1/-1)<ul><li>Updated 2D mesh rendering with new API</ul><p><strong>crates/bevy_ui_render/src/box_shadow.rs</strong> (+1/-1)<ul><li>Updated UI box shadow rendering</ul><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/wgpu/latest/wgpu/struct.RenderPass.html#method.set_index_buffer target=_blank>wgpu RenderPass::set_index_buffer documentation</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_render/latest/bevy_render/render_resource/struct.BufferSlice.html target=_blank>Bevy BufferSlice documentation</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/pull/14916 target=_blank>PR #14916: Vertex buffer tracking improvements</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-09/pr_20468.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>