<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20902 Constify math
        
    </title><meta content="#20902 Constify math" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-09/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-09-06</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-09/pr-20902-zh-cn-20250906>中文</a></div></div><div class=pr-content><h1 id=constify-math>Constify math</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Constify math<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20902<li><strong>Author</strong>: exoego<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Usability, S-Ready-For-Final-Review, A-Math, D-Straightforward<li><strong>Created</strong>: 2025-09-06T10:07:29Z<li><strong>Merged</strong>: 2025-09-06T21:53:38Z<li><strong>Merged By</strong>: james7132</ul><h2 id=description-translation>Description Translation</h2><p>The original description is in English, so it’s included as-is:<h1 id=objective>Objective</h1><p>Part of https://github.com/bevyengine/bevy/issues/16124<h2 id=solution>Solution</h2><p>Constify where seems legit and easy to maintain<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a straightforward but important need in the Bevy math library: making functions const where possible. The work is part of a larger initiative (issue #16124) to increase const usage throughout the Bevy codebase.<p>The core problem was that many math functions that could be evaluated at compile-time were instead only available as runtime functions. This limited their usability in const contexts and missed optimization opportunities. The developer approached this systematically by identifying functions that met two criteria: they were “legit” candidates for constification (meaning they performed operations that are const-safe) and were “easy to maintain” (meaning the changes wouldn’t introduce complexity or maintenance burden).<p>The implementation involved adding the <code>const</code> keyword to numerous functions across the math module. Most changes were straightforward additions of the <code>const</code> modifier, but one case required special attention. In <code>Cuboid::from_size</code>, the original implementation used vector division (<code>size / 2.0</code>), but since the vector division operator isn’t const, the implementation had to be rewritten using component-wise operations:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>from_size</span><span>(</span><span style=color:#ff8f40>size</span><span style=color:#61676ccc>:</span><span> Vec3) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>    </span><span style=color:#fa6e32>Self </span><span>{
</span><span>        half_size</span><span style=color:#61676ccc>:</span><span> size </span><span style=color:#ed9366>/ </span><span style=color:#ff8f40>2.0</span><span style=color:#61676ccc>,
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub const fn </span><span style=color:#f29718>from_size</span><span>(</span><span style=color:#ff8f40>size</span><span style=color:#61676ccc>:</span><span> Vec3) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>    </span><span style=color:#fa6e32>Self </span><span>{
</span><span>        half_size</span><span style=color:#61676ccc>: </span><span>Vec3</span><span style=color:#ed9366>::</span><span>new(size</span><span style=color:#ed9366>.</span><span>x </span><span style=color:#ed9366>/ </span><span style=color:#ff8f40>2.0</span><span style=color:#61676ccc>,</span><span> size</span><span style=color:#ed9366>.</span><span>y </span><span style=color:#ed9366>/ </span><span style=color:#ff8f40>2.0</span><span style=color:#61676ccc>,</span><span> size</span><span style=color:#ed9366>.</span><span>z </span><span style=color:#ed9366>/ </span><span style=color:#ff8f40>2.0</span><span>)</span><span style=color:#61676ccc>,
</span><span>    }
</span><span>}
</span></code></pre><p>This change demonstrates an important technical insight: when making functions const, sometimes we need to rewrite operations using const-safe alternatives, even if they’re mathematically equivalent.<p>The impact of these changes is significant for compile-time evaluation. Developers can now use these math functions in const contexts, enabling more compile-time computations and potentially better performance through constant propagation. The changes maintain full backward compatibility while extending functionality.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TB
</span><span>    AM[Aspect Ratio] -->|const| AMF[Functions]
</span><span>    CI[Curve/Interval] -->|const| CIF[Functions]
</span><span>    ISO[Isometry] -->|const| ISOF[Functions]
</span><span>    PM3[Primitives 3D] -->|const| PM3F[Functions]
</span><span>    PP[Polygon Primitives] -->|const| PPF[Functions]
</span><span>    R2[Rotation 2D] -->|const| R2F[Functions]
</span><span>    
</span><span>    AMF --> CE[Const Enablement]
</span><span>    CIF --> CE
</span><span>    ISOF --> CE
</span><span>    PM3F --> CE
</span><span>    PPF --> CE
</span><span>    R2F --> CE
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-math-src-aspect-ratio-rs><code>crates/bevy_math/src/aspect_ratio.rs</code></h3><p>Added <code>const</code> to aspect ratio construction functions:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>try_new</span><span>(</span><span style=color:#ff8f40>width</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>, </span><span style=color:#ff8f40>height</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><</span><span style=color:#fa6e32>Self</span><span>, AspectRatioError>
</span><span>pub fn try_from_pixels(x: </span><span style=color:#fa6e32>u32</span><span>, y: </span><span style=color:#fa6e32>u32</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><</span><span style=color:#fa6e32>Self</span><span>, AspectRatioError>
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub const fn </span><span style=color:#f29718>try_new</span><span>(</span><span style=color:#ff8f40>width</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>, </span><span style=color:#ff8f40>height</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><</span><span style=color:#fa6e32>Self</span><span>, AspectRatioError>
</span><span>pub </span><span style=color:#fa6e32>const</span><span> fn try_from_pixels(x: </span><span style=color:#fa6e32>u32</span><span>, y: </span><span style=color:#fa6e32>u32</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><</span><span style=color:#fa6e32>Self</span><span>, AspectRatioError>
</span></code></pre><h3 id=crates-bevy-math-src-curve-interval-rs><code>crates/bevy_math/src/curve/interval.rs</code></h3><p>Made interval operations const:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>new</span><span>(</span><span style=color:#ff8f40>start</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>, </span><span style=color:#ff8f40>end</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><</span><span style=color:#fa6e32>Self</span><span>, InvalidIntervalError>
</span><span>pub fn length(self) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>f32
</span><span style=color:#abb0b6;font-style:italic>// ... and several others
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub const fn </span><span style=color:#f29718>new</span><span>(</span><span style=color:#ff8f40>start</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>, </span><span style=color:#ff8f40>end</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><</span><span style=color:#fa6e32>Self</span><span>, InvalidIntervalError>
</span><span>pub </span><span style=color:#fa6e32>const</span><span> fn length(self) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>f32
</span><span style=color:#abb0b6;font-style:italic>// ... with const added to all applicable functions
</span></code></pre><h3 id=crates-bevy-math-src-isometry-rs><code>crates/bevy_math/src/isometry.rs</code></h3><p>Added const to isometry constructors:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>new</span><span>(</span><span style=color:#ff8f40>translation</span><span style=color:#61676ccc>:</span><span> Vec2, </span><span style=color:#ff8f40>rotation</span><span style=color:#61676ccc>:</span><span> Rot2) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self
</span><span>pub fn from_rotation(rotation: Rot2) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self
</span><span style=color:#abb0b6;font-style:italic>// ... and several others
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub const fn </span><span style=color:#f29718>new</span><span>(</span><span style=color:#ff8f40>translation</span><span style=color:#61676ccc>:</span><span> Vec2, </span><span style=color:#ff8f40>rotation</span><span style=color:#61676ccc>:</span><span> Rot2) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self
</span><span>pub </span><span style=color:#fa6e32>const</span><span> fn from_rotation(rotation: Rot2) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self
</span><span style=color:#abb0b6;font-style:italic>// ... with const added to all applicable functions
</span></code></pre><h3 id=crates-bevy-math-src-primitives-dim3-rs><code>crates/bevy_math/src/primitives/dim3.rs</code></h3><p>Made 3D primitive methods const, including the notable change to <code>Cuboid::from_size</code>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>from_size</span><span>(</span><span style=color:#ff8f40>size</span><span style=color:#61676ccc>:</span><span> Vec3) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>    </span><span style=color:#fa6e32>Self </span><span>{
</span><span>        half_size</span><span style=color:#61676ccc>:</span><span> size </span><span style=color:#ed9366>/ </span><span style=color:#ff8f40>2.0</span><span style=color:#61676ccc>,
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub const fn </span><span style=color:#f29718>from_size</span><span>(</span><span style=color:#ff8f40>size</span><span style=color:#61676ccc>:</span><span> Vec3) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>    </span><span style=color:#fa6e32>Self </span><span>{
</span><span>        half_size</span><span style=color:#61676ccc>: </span><span>Vec3</span><span style=color:#ed9366>::</span><span>new(size</span><span style=color:#ed9366>.</span><span>x </span><span style=color:#ed9366>/ </span><span style=color:#ff8f40>2.0</span><span style=color:#61676ccc>,</span><span> size</span><span style=color:#ed9366>.</span><span>y </span><span style=color:#ed9366>/ </span><span style=color:#ff8f40>2.0</span><span style=color:#61676ccc>,</span><span> size</span><span style=color:#ed9366>.</span><span>z </span><span style=color:#ed9366>/ </span><span style=color:#ff8f40>2.0</span><span>)</span><span style=color:#61676ccc>,
</span><span>    }
</span><span>}
</span></code></pre><h3 id=crates-bevy-math-src-primitives-polygon-rs><code>crates/bevy_math/src/primitives/polygon.rs</code></h3><p>Made polygon utility functions const:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>point_side</span><span>(</span><span style=color:#ff8f40>p1</span><span style=color:#61676ccc>:</span><span> Vec2, </span><span style=color:#ff8f40>p2</span><span style=color:#61676ccc>:</span><span> Vec2, </span><span style=color:#ff8f40>q</span><span style=color:#61676ccc>:</span><span> Vec2) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>f32
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>const fn </span><span style=color:#f29718>point_side</span><span>(</span><span style=color:#ff8f40>p1</span><span style=color:#61676ccc>:</span><span> Vec2, </span><span style=color:#ff8f40>p2</span><span style=color:#61676ccc>:</span><span> Vec2, </span><span style=color:#ff8f40>q</span><span style=color:#61676ccc>:</span><span> Vec2) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>f32
</span></code></pre><h3 id=crates-bevy-math-src-rotation2d-rs><code>crates/bevy_math/src/rotation2d.rs</code></h3><p>Added const to rotation validation methods:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>is_finite</span><span>(</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>bool
</span><span>pub fn is_nan(self) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>bool
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub const fn </span><span style=color:#f29718>is_finite</span><span>(</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>bool
</span><span>pub </span><span style=color:#fa6e32>const</span><span> fn is_nan(self) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>bool
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/reference/const_eval.html#const-functions target=_blank>Rust Reference: Const Functions</a><li><a rel="noopener nofollow noreferrer" href=https://blog.rust-lang.org/2021/02/26/const-generics-mvp-beta.html target=_blank>Rust Blog: Const Generics</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/issues/16124 target=_blank>Bevy Issue #16124: More const fn</a></ul><h2 id=full-code-diff>Full Code Diff</h2><p>The complete code diff is provided in the original query.</div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-09/pr_20902.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>