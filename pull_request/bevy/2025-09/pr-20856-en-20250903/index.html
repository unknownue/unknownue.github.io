<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20856 another text color fix
        
    </title><meta content="#20856 another text color fix" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-09/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-09-03</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-09/pr-20856-zh-cn-20250903>中文</a></div></div><div class=pr-content><h1 id=another-text-color-fix>another text color fix</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: another text color fix<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20856<li><strong>Author</strong>: ickshonpe<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, S-Ready-For-Final-Review, A-Text, M-Deliberate-Rendering-Change<li><strong>Created</strong>: 2025-09-03T20:30:44Z<li><strong>Merged</strong>: 2025-09-03T21:18:44Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description>Description</h2><h1 id=objective>Objective</h1><p>Fixes #20854<h2 id=solution>Solution</h2><p>Query for the next color on span changes before queuing the next glyph.<h2 id=testing>Testing</h2><p>Added two more cases to <code>testbed_ui</code>’s text example, the three lines of coloured text should all look identical:<p><code>cargo run --example testbed_ui</code></p><img alt=text-color height=234 src=https://github.com/user-attachments/assets/78d10141-9b2f-4a57-9b64-eda62da46db5 width=487><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a text rendering bug where colors weren’t updating correctly when transitioning between text spans with different colors. The issue occurred in Bevy’s UI text rendering system when processing glyphs from multiple text spans with varying color styles.<p>The core problem was in the <code>extract_text_sections</code> function in <code>bevy_ui_render</code>. The original implementation attempted to update the color for the next span after processing the current glyph, but this approach had two key issues:<ol><li>It only checked for span changes when the next glyph was from a different texture<li>It looked ahead to the next span index rather than properly tracking the current span</ol><p>The solution involved restructuring the color handling logic to track span changes proactively rather than reactively. Here’s how the fix works:<p>First, we introduce a <code>current_span_index</code> variable to track which span we’re currently processing. For each glyph, we check if we’ve moved to a new span. If we have, we immediately query the text style for that span entity and update the current color:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let mut</span><span> current_span_index </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>for </span><span>(i</span><span style=color:#61676ccc>,</span><span> PositionedGlyph { position</span><span style=color:#61676ccc>,</span><span> atlas_info</span><span style=color:#61676ccc>,</span><span> span_index</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>.. </span><span>}) </span><span style=color:#ed9366>in</span><span> text_layout_info</span><span style=color:#ed9366>.</span><span>glyphs</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>enumerate</span><span>() {
</span><span>    </span><span style=color:#fa6e32>if</span><span> current_span_index </span><span style=color:#ed9366>!= *</span><span>span_index
</span><span>        </span><span style=color:#ed9366>&& </span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(span_entity) </span><span style=color:#ed9366>=</span><span> computed_block</span><span style=color:#ed9366>.</span><span style=color:#f07171>entities</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#ed9366>*</span><span>span_index)</span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|</span><span style=color:#ff8f40>t</span><span>| t</span><span style=color:#ed9366>.</span><span>entity)
</span><span>    {
</span><span>        color </span><span style=color:#ed9366>=</span><span> text_styles
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(span_entity)
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|</span><span style=color:#ff8f40>text_color</span><span>| LinearRgba</span><span style=color:#ed9366>::</span><span>from(text_color</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0</span><span>))
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_or_default</span><span>()</span><span style=color:#61676ccc>;
</span><span>        current_span_index </span><span style=color:#ed9366>= *</span><span>span_index</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... rest of glyph processing
</span><span>}
</span></code></pre><p>This ensures that color changes are applied at the beginning of each new span, rather than at the end of the previous span. The color is now correctly set before any glyphs from the new span are processed.<p>Additionally, the condition for creating new <code>ExtractedUiNode</code> instances was simplified. The original code checked for both span changes and texture changes:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>if</span><span> text_layout_info</span><span style=color:#ed9366>.</span><span>glyphs</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(i </span><span style=color:#ed9366>+ </span><span style=color:#ff8f40>1</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_none_or</span><span>(|</span><span style=color:#ff8f40>info</span><span>| {
</span><span>    info</span><span style=color:#ed9366>.</span><span>span_index </span><span style=color:#ed9366>!= *</span><span>span_index </span><span style=color:#ed9366>||</span><span> info</span><span style=color:#ed9366>.</span><span>atlas_info</span><span style=color:#ed9366>.</span><span>texture </span><span style=color:#ed9366>!=</span><span> atlas_info</span><span style=color:#ed9366>.</span><span>texture
</span><span>}) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Create new node
</span><span>}
</span></code></pre><p>This was simplified to only check for texture changes, since span-based color handling is now managed separately:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>if</span><span> text_layout_info
</span><span>    </span><span style=color:#ed9366>.</span><span>glyphs
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(i </span><span style=color:#ed9366>+ </span><span style=color:#ff8f40>1</span><span>)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>is_none_or</span><span>(|</span><span style=color:#ff8f40>info</span><span>| info</span><span style=color:#ed9366>.</span><span>atlas_info</span><span style=color:#ed9366>.</span><span>texture </span><span style=color:#ed9366>!=</span><span> atlas_info</span><span style=color:#ed9366>.</span><span>texture)
</span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Create new node
</span><span>}
</span></code></pre><p>The PR also adds comprehensive test cases to verify the fix works correctly. Two new text examples were added to the testbed UI that demonstrate multi-color text rendering with various span configurations, including empty spans and multiple consecutive color changes.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Process Glyph] --> B{Span Changed?}
</span><span>    B -->|Yes| C[Query New Span Color]
</span><span>    B -->|No| D[Use Current Color]
</span><span>    C --> E[Update Current Span Index]
</span><span>    E --> F[Process Glyph with New Color]
</span><span>    D --> F
</span><span>    F --> G{Texture Changed?}
</span><span>    G -->|Yes| H[Create New Render Node]
</span><span>    G -->|No| I[Continue Current Batch]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ui-render-src-lib-rs><code>crates/bevy_ui_render/src/lib.rs</code></h3><p>This file contains the core text rendering logic. The changes fix how text colors are handled when processing multiple spans.<p><strong>Key changes:</strong><ul><li>Added span tracking with <code>current_span_index</code> variable<li>Moved color query to beginning of glyph processing loop<li>Simplified node creation condition to only consider texture changes</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>if</span><span> text_layout_info</span><span style=color:#ed9366>.</span><span>glyphs</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(i </span><span style=color:#ed9366>+ </span><span style=color:#ff8f40>1</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_none_or</span><span>(|</span><span style=color:#ff8f40>info</span><span>| {
</span><span>    info</span><span style=color:#ed9366>.</span><span>span_index </span><span style=color:#ed9366>!= *</span><span>span_index </span><span style=color:#ed9366>||</span><span> info</span><span style=color:#ed9366>.</span><span>atlas_info</span><span style=color:#ed9366>.</span><span>texture </span><span style=color:#ed9366>!=</span><span> atlas_info</span><span style=color:#ed9366>.</span><span>texture
</span><span>}) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Color update logic here
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>if</span><span> current_span_index </span><span style=color:#ed9366>!= *</span><span>span_index
</span><span>    </span><span style=color:#ed9366>&& </span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(span_entity) </span><span style=color:#ed9366>=</span><span> computed_block</span><span style=color:#ed9366>.</span><span style=color:#f07171>entities</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#ed9366>*</span><span>span_index)</span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|</span><span style=color:#ff8f40>t</span><span>| t</span><span style=color:#ed9366>.</span><span>entity)
</span><span>{
</span><span>    color </span><span style=color:#ed9366>=</span><span> text_styles
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(span_entity)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|</span><span style=color:#ff8f40>text_color</span><span>| LinearRgba</span><span style=color:#ed9366>::</span><span>from(text_color</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0</span><span>))
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_or_default</span><span>()</span><span style=color:#61676ccc>;
</span><span>    current_span_index </span><span style=color:#ed9366>= *</span><span>span_index</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#fa6e32>if</span><span> text_layout_info
</span><span>    </span><span style=color:#ed9366>.</span><span>glyphs
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(i </span><span style=color:#ed9366>+ </span><span style=color:#ff8f40>1</span><span>)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>is_none_or</span><span>(|</span><span style=color:#ff8f40>info</span><span>| info</span><span style=color:#ed9366>.</span><span>atlas_info</span><span style=color:#ed9366>.</span><span>texture </span><span style=color:#ed9366>!=</span><span> atlas_info</span><span style=color:#ed9366>.</span><span>texture)
</span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Node creation logic (no color update)
</span><span>}
</span></code></pre><h3 id=examples-testbed-ui-rs><code>examples/testbed/ui.rs</code></h3><p>This file contains UI test examples. Two new test cases were added to verify the color fix works correctly.<p><strong>Key changes:</strong><ul><li>Added two multi-color text examples with different span configurations<li>Includes cases with empty spans and multiple color changes<li>Provides regression tests for the fixed behavior</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// First test case - basic multi-color text
</span><span style=color:#f07171>children!</span><span>[
</span><span>    (TextSpan</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#86b300>"white "</span><span>)</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>...</span><span>)</span><span style=color:#61676ccc>,
</span><span>    (TextSpan</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#86b300>"red "</span><span>)</span><span style=color:#61676ccc>,</span><span> TextColor(</span><span style=color:#ff8f40>RED</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()))</span><span style=color:#61676ccc>,
</span><span>    (TextSpan</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#86b300>"green "</span><span>)</span><span style=color:#61676ccc>,</span><span> TextColor(</span><span style=color:#ff8f40>GREEN</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()))</span><span style=color:#61676ccc>,
</span><span>    (TextSpan</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#86b300>"blue "</span><span>)</span><span style=color:#61676ccc>,</span><span> TextColor(</span><span style=color:#ff8f40>BLUE</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()))</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>]
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Second test case - complex with empty spans
</span><span style=color:#f07171>children!</span><span>[
</span><span>    (TextSpan</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#86b300>""</span><span>)</span><span style=color:#61676ccc>,</span><span> TextColor(</span><span style=color:#ff8f40>YELLOW</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()))</span><span style=color:#61676ccc>,
</span><span>    TextSpan</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#86b300>""</span><span>)</span><span style=color:#61676ccc>,
</span><span>    (TextSpan</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#86b300>"white "</span><span>)</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>...</span><span>)</span><span style=color:#61676ccc>,
</span><span>    TextSpan</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#86b300>""</span><span>)</span><span style=color:#61676ccc>,
</span><span>    (TextSpan</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#86b300>"red "</span><span>)</span><span style=color:#61676ccc>,</span><span> TextColor(</span><span style=color:#ff8f40>RED</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()))</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>]
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li>Bevy Text Rendering Documentation: https://bevyengine.org/learn/books/introduction/2d-rendering/ui<li>PR #20854: The original issue this PR fixes<li>Bevy UI System Overview: https://github.com/bevyengine/bevy/blob/main/crates/bevy_ui/README.md<li>Text and Font Handling in Bevy: https://github.com/bevyengine/bevy/blob/main/crates/bevy_text/README.md</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-09/pr_20856.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>