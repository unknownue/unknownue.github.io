<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21202 Fix chrome rendering bug
        
    </title><meta content="#21202 Fix chrome rendering bug" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-09/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-09-26</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2025-09/pr-21202-en-20250926>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=fix-chrome-rendering-bug>Fix chrome rendering bug</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix chrome rendering bug<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21202<li><strong>Author</strong>: atlv24<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, S-Ready-For-Final-Review, P-Regression<li><strong>Created</strong>: 2025-09-24T23:47:25Z<li><strong>Merged</strong>: 2025-09-26T04:09:10Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>修复 Chrome 渲染 bug： <img alt=image height=985 src=https://github.com/user-attachments/assets/6293a960-b8fa-460e-9d71-e7f2a9fb2d20 width=1755></ul><h2 id=solution>Solution</h2><ul><li>回滚 #20313 的部分更改<li>我不清楚为什么这能修复问题，但 #20960 也遇到了同样的问题</ul><h2 id=testing>Testing</h2><ul><li></ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>这是一个典型的回归修复案例，展示了在图形编程中，看似简单的代码重构可能带来意想不到的兼容性问题。<p><strong>问题的发现</strong><p>开发者发现 Bevy 引擎在 Chrome 浏览器中出现了渲染异常。从提供的截图可以看到，渲染结果存在明显的视觉瑕疵。这个问题被标记为回归（P-Regression），意味着它是在之前的某个更改中引入的，而不是一直存在的缺陷。<p><strong>根本原因调查</strong><p>通过分析，开发者确定问题源于 PR #20313 的更改。该 PR 原本旨在重构坐标变换函数，将这些函数从 <code>view_transformations.wgsl</code> 移动到共享模块 <code>bevy_render::view</code> 中，以实现代码复用和一致性。<p>然而，这种重构在 Chrome 的 WebGPU 实现中导致了兼容性问题。虽然开发者明确表示不清楚具体的技术原因，但注意到 PR #20960 也遇到了相同的问题，这表明这是一个可复现的浏览器特定问题。<p><strong>解决方案：策略性回滚</strong><p>面对这种浏览器兼容性问题，开发者采取了最直接有效的解决方案：回滚有问题的更改。具体来说，他们：<ol><li>移除了对 <code>bevy_render::view</code> 模块的导入<li>恢复了所有坐标变换函数的原始实现<li>移除了之前添加的 DEPRECATED 注释</ol><p>这种回滚不是简单的整体撤销，而是有针对性的恢复。所有函数都回到了直接使用矩阵乘法进行坐标变换的实现方式，而不是通过共享模块的抽象层。<p><strong>技术实现细节</strong><p>回滚后的函数实现更加直接和自包含。例如，<code>position_view_to_world</code> 函数从：<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>fn position_view_to_world(view_pos: vec3&LTf32>) -> vec3&LTf32> {
</span><span>    return view::position_view_to_world(view_pos, view_bindings::view.world_from_view);
</span><span>}
</span></code></pre><p>恢复为：<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>fn position_view_to_world(view_pos: vec3&LTf32>) -> vec3&LTf32> {
</span><span>    let world_pos = view_bindings::view.world_from_view * vec4(view_pos, 1.0);
</span><span>    return world_pos.xyz;
</span><span>}
</span></code></pre><p>这种实现虽然代码重复度更高，但避免了模块导入可能带来的兼容性问题。<p><strong>工程权衡</strong><p>这个 PR 体现了软件工程中常见的权衡：代码复用性 vs 运行兼容性。虽然共享模块的抽象在理论上是更好的设计，但在实际的跨平台/跨浏览器环境中，有时需要优先保证功能的正确性。<p><strong>经验教训</strong><p>这个案例提醒我们：<ol><li>图形编程中的浏览器兼容性问题可能很微妙<li>即使逻辑上正确的重构也可能引入运行时问题<li>回归测试和跨浏览器测试的重要性<li>有时候需要为了兼容性牺牲一些代码优雅性</ol><h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[Chrome 渲染异常] --> B[问题定位到 PR #20313]
</span><span>    B --> C[回滚坐标变换函数实现]
</span><span>    C --> D[移除模块导入依赖]
</span><span>    D --> E[恢复直接矩阵运算]
</span><span>    E --> F[Chrome 渲染正常]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-pbr-src-render-view-transformations-wgsl-70-55><code>crates/bevy_pbr/src/render/view_transformations.wgsl</code> (+70/-55)</h3><p>这个文件包含了所有坐标空间变换的 WGSL 函数。主要更改包括：<ol><li><strong>移除模块导入</strong></ol><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// 移除的行
</span><span>#import bevy_render::view
</span></code></pre><ol start=2><li><strong>恢复函数直接实现</strong></ol><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// 之前（使用共享模块）：
</span><span>fn position_view_to_world(view_pos: vec3&LTf32>) -> vec3&LTf32> {
</span><span>    return view::position_view_to_world(view_pos, view_bindings::view.world_from_view);
</span><span>}
</span><span>
</span><span>// 之后（直接实现）：
</span><span>fn position_view_to_world(view_pos: vec3&LTf32>) -> vec3&LTf32> {
</span><span>    let world_pos = view_bindings::view.world_from_view * vec4(view_pos, 1.0);
</span><span>    return world_pos.xyz;
</span><span>}
</span></code></pre><ol start=3><li><strong>移除弃用注释</strong> 所有 <code>DEPRECATED: use bevy_render::view::...</code> 注释都被移除，因为这些函数不再被弃用。</ol><p>这些更改确保了坐标变换函数在 Chrome 的 WebGPU 实现中能够正常工作，虽然牺牲了代码的抽象层次，但解决了实际的渲染问题。<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://www.w3.org/TR/webgpu/ target=_blank>WebGPU 规范</a> - 了解 WebGPU 的技术细节<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/ target=_blank>Bevy 引擎文档</a> - Bevy 游戏引擎的官方文档<li><a rel="noopener nofollow noreferrer" href=https://www.w3.org/TR/WGSL/ target=_blank>WGSL 语言规范</a> - WebGPU Shading Language 的详细说明<li><a rel="noopener nofollow noreferrer" href=https://learnopengl.com/Getting-started/Coordinate-Systems target=_blank>图形编程中的坐标变换</a> - 理解不同的坐标空间和变换</ul><h1 id=full-code-diff>Full Code Diff</h1><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_pbr/src/render/view_transformations.wgsl b/crates/bevy_pbr/src/render/view_transformations.wgsl
</span><span>index 4fe44d48dbd21..dfb4d6e96d03c 100644
</span><span style=color:#c594c5>--- a/crates/bevy_pbr/src/render/view_transformations.wgsl
</span><span style=color:#c594c5>+++ b/crates/bevy_pbr/src/render/view_transformations.wgsl
</span><span style=color:#c594c5>@@ -2,7 +2,6 @@
</span><span> 
</span><span> #import bevy_pbr::mesh_view_bindings as view_bindings
</span><span> #import bevy_pbr::prepass_bindings
</span><span style=color:#f07171>-#import bevy_render::view
</span><span> 
</span><span> /// World space:
</span><span> /// +y is up
</span><span style=color:#c594c5>@@ -36,33 +35,33 @@
</span><span> // -----------------
</span><span> 
</span><span> /// Convert a view space position to world space
</span><span style=color:#f07171>-/// DEPRECATED: use bevy_render::view::position_view_to_world instead
</span><span> fn position_view_to_world(view_pos: vec3&LTf32>) -> vec3&LTf32> {
</span><span style=color:#f07171>-    return view::position_view_to_world(view_pos, view_bindings::view.world_from_view);
</span><span style=color:#86b300>+    let world_pos = view_bindings::view.world_from_view * vec4(view_pos, 1.0);
</span><span style=color:#86b300>+    return world_pos.xyz;
</span><span> }
</span><span> 
</span><span> /// Convert a clip space position to world space
</span><span style=color:#f07171>-/// DEPRECATED: use bevy_render::view::position_clip_to_world instead
</span><span> fn position_clip_to_world(clip_pos: vec4&LTf32>) -> vec3&LTf32> {
</span><span style=color:#f07171>-    return view::position_clip_to_world(clip_pos, view_bindings::view.world_from_clip);
</span><span style=color:#86b300>+    let world_pos = view_bindings::view.world_from_clip * clip_pos;
</span><span style=color:#86b300>+    return world_pos.xyz;
</span><span> }
</span><span> 
</span><span> /// Convert a ndc space position to world space
</span><span style=color:#f07171>-/// DEPRECATED: use bevy_render::view::position_ndc_to_world instead
</span><span> fn position_ndc_to_world(ndc_pos: vec3&LTf32>) -> vec3&LTf32> {
</span><span style=color:#f07171>-    return view::position_ndc_to_world(ndc_pos, view_bindings::view.world_from_clip);
</span><span style=color:#86b300>+    let world_pos = view_bindings::view.world_from_clip * vec4(ndc_pos, 1.0);
</span><span style=color:#86b300>+    return world_pos.xyz / world_pos.w;
</span><span> }
</span><span> 
</span><span> /// Convert a view space direction to world space
</span><span style=color:#f07171>-/// DEPRECATED: use bevy_render::view::direction_view_to_world instead
</span><span> fn direction_view_to_world(view_dir: vec3&LTf32>) -> vec3&LTf32> {
</span><span style=color:#f07171>-    return view::direction_view_to_world(view_dir, view_bindings::view.world_from_view);
</span><span style=color:#86b300>+    let world_dir = view_bindings::view.world_from_view * vec4(view_dir, 0.0);
</span><span style=color:#86b300>+    return world_dir.xyz;
</span><span> }
</span><span> 
</span><span> /// Convert a clip space direction to world space
</span><span style=color:#f07171>-/// DEPRECATED: use bevy_render::view::direction_clip_to_world instead
</span><span> fn direction_clip_to_world(clip_dir: vec4&LTf32>) -> vec3&LTf32> {
</span><span style=color:#f07171>-    return view::direction_clip_to_world(clip_dir, view_bindings::view.world_from_clip);
</span><span style=color:#86b300>+    let world_dir = view_bindings::view.world_from_clip * clip_dir;
</span><span style=color:#86b300>+    return world_dir.xyz;
</span><span> }
</span><span> 
</span><span> // -----------------
</span><span style=color:#c594c5>@@ -70,47 +69,49 @@ </span><span style=color:#399ee6>fn direction_clip_to_world(clip_dir: vec4&LTf32>) -> vec3&LTf32> {
</span><span> // -----------------
</span><span> 
</span><span> /// Convert a world space position to view space
</span><span style=color:#f07171>-/// DEPRECATED: use bevy_render::view::position_world_to_view instead
</span><span> fn position_world_to_view(world_pos: vec3&LTf32>) -> vec3&LTf32> {
</span><span style=color:#f07171>-    return view::position_world_to_view(world_pos, view_bindings::view.view_from_world);
</span><span style=color:#86b300>+    let view_pos = view_bindings::view.view_from_world * vec4(world_pos, 1.0);
</span><span style=color:#86b300>+    return view_pos.xyz;
</span><span> }
</span><span> 
</span><span> /// Convert a clip space position to view space
</span><span style=color:#f07171>-/// DEPRECATED: use bevy_render::view::position_clip_to_view instead
</span><span> fn position_clip_to_view(clip_pos: vec4&LTf32>) -> vec3&LTf32> {
</span><span style=color:#f07171>-    return view::position_clip_to_view(clip_pos, view_bindings::view.view_from_clip);
</span><span style=color:#86b300>+    let view_pos = view_bindings::view.view_from_clip * clip_pos;
</span><span style=color:#86b300>+    return view_pos.xyz;
</span><span> }
</span><span> 
</span><span> /// Convert a ndc space position to view space
</span><span style=color:#f07171>-/// DEPRECATED: use bevy_render::view::position_ndc_to_view instead
</span><span> fn position_ndc_to_view(ndc_pos: vec3&LTf32>) -> vec3&LTf32> {
</span><span style=color:#f07171>-    return view::position_ndc_to_view(ndc_pos, view_bindings::view.view_from_clip);
</span><span style=color:#86b300>+    let view_pos = view_bindings::view.view_from_clip * vec4(ndc_pos, 1.0);
</span><span style=color:#86b300>+    return view_pos.xyz / view_pos.w;
</span><span> }
</span><span> 
</span><span> /// Convert a world space direction to view space
</span><span style=color:#f07171>-/// DEPRECATED: use bevy_render::view::direction_world_to_view instead
</span><span> fn direction_world_to_view(world_dir: vec3&LTf32>) -> vec3&LTf32> {
</span><span style=color:#f07171>-    return view::direction_world_to_view(world_dir, view_bindings::view.view_from_world);
</span><span style=color:#86b300>+    let view_dir = view_bindings::view.view_from_world * vec4(world_dir, 0.0);
</span><span style=color:#86b300>+    return view_dir.xyz;
</span><span> }
</span><span> 
</span><span> /// Convert a clip space direction to view space
</span><span style=color:#f07171>-/// DEPRECATED: use bevy_render::view::direction_clip_to_view instead
</span><span> fn direction_clip_to_view(clip_dir: vec4&LTf32>) -> vec3&LTf32> {
</span><span style=color:#f07171>-    return view::direction_clip_to_view(clip_dir, view_bindings::view.view_from_clip);
</span><span style=color:#86b300>+    let view_dir = view_bindings::view.view_from_clip * clip_dir;
</span><span style=color:#86b300>+    return view_dir.xyz;
</span><span> }
</span><span> 
</span><span> // -----------------
</span><span> // TO PREV. VIEW ---
</span><span> // -----------------
</span><span> 
</span><span style=color:#f07171>-/// DEPRECATED: use bevy_render::view::position_world_to_view instead
</span><span> fn position_world_to_prev_view(world_pos: vec3&LTf32>) -> vec3&LTf32> {
</span><span style=color:#f07171>-    return view::position_world_to_view(world_pos, prepass_bindings::previous_view_uniforms.view_from_world);
</span><span style=color:#86b300>+    let view_pos = prepass_bindings::previous_view_uniforms.view_from_world *
</span><span style=color:#86b300>+        vec4(world_pos, 1.0);
</span><span style=color:#86b300>+    return view_pos.xyz;
</span><span> }
</span><span> 
</span><span style=color:#f07171>-/// DEPRECATED: use bevy_render::view::position_world_to_ndc instead
</span><span> fn position_world_to_prev_ndc(world_pos: vec3&LTf32>) -> vec3&LTf32> {
</span><span style=color:#f07171>-    return view::position_world_to_ndc(world_pos, prepass_bindings::previous_view_uniforms.clip_from_world);
</span><span style=color:#86b300>+    let ndc_pos = prepass_bindings::previous_view_uniforms.clip_from_world *
</span><span style=color:#86b300>+        vec4(world_pos, 1.0);
</span><span style=color:#86b300>+    return ndc_pos.xyz / ndc_pos.w;
</span><span> }
</span><span> 
</span><span> // -----------------
</span><span style=color:#c594c5>@@ -118,27 +119,27 @@ </span><span style=color:#399ee6>fn position_world_to_prev_ndc(world_pos: vec3&LTf32>) -> vec3&LTf32> {
</span><span> // -----------------
</span><span> 
</span><span> /// Convert a world space position to clip space
</span><span style=color:#f07171>-/// DEPRECATED: use bevy_render::view::position_world_to_clip instead
</span><span> fn position_world_to_clip(world_pos: vec3&LTf32>) -> vec4&LTf32> {
</span><span style=color:#f07171>-    return view::position_world_to_clip(world_pos, view_bindings::view.clip_from_world);
</span><span style=color:#86b300>+    let clip_pos = view_bindings::view.clip_from_world * vec4(world_pos, 1.0);
</span><span style=color:#86b300>+    return clip_pos;
</span><span> }
</span><span> 
</span><span> /// Convert a view space position to clip space
</span><span style=color:#f07171>-/// DEPRECATED: use bevy_render::view::position_view_to_clip instead
</span><span> fn position_view_to_clip(view_pos: vec3&LTf32>) -> vec4&LTf32> {
</span><span style=color:#f07171>-    return view::position_view_to_clip(view_pos, view_bindings::view.clip_from_view);
</span><span style=color:#86b300>+    let clip_pos = view_bindings::view.clip_from_view * vec4(view_pos, 1.0);
</span><span style=color:#86b300>+    return clip_pos;
</span><span> }
</span><span> 
</span><span> /// Convert a world space direction to clip space
</span><span style=color:#f07171>-/// DEPRECATED: use bevy_render::view::direction_world_to_clip instead
</span><span> fn direction_world_to_clip(world_dir: vec3&LTf32>) -> vec4&LTf32> {
</span><span style=color:#f07171>-    return view::direction_world_to_clip(world_dir, view_bindings::view.clip_from_world);
</span><span style=color:#86b300>+    let clip_dir = view_bindings::view.clip_from_world * vec4(world_dir, 0.0);
</span><span style=color:#86b300>+    return clip_dir;
</span><span> }
</span><span> 
</span><span> /// Convert a view space direction to clip space
</span><span style=color:#f07171>-/// DEPRECATED: use bevy_render::view::direction_view_to_clip instead
</span><span> fn direction_view_to_clip(view_dir: vec3&LTf32>) -> vec4&LTf32> {
</span><span style=color:#f07171>-    return view::direction_view_to_clip(view_dir, view_bindings::view.clip_from_view);
</span><span style=color:#86b300>+    let clip_dir = view_bindings::view.clip_from_view * vec4(view_dir, 0.0);
</span><span style=color:#86b300>+    return clip_dir;
</span><span> }
</span><span> 
</span><span> // -----------------
</span><span style=color:#c594c5>@@ -146,15 +147,15 @@ </span><span style=color:#399ee6>fn direction_view_to_clip(view_dir: vec3&LTf32>) -> vec4&LTf32> {
</span><span> // -----------------
</span><span> 
</span><span> /// Convert a world space position to ndc space
</span><span style=color:#f07171>-/// DEPRECATED: use bevy_render::view::position_world_to_ndc instead
</span><span> fn position_world_to_ndc(world_pos: vec3&LTf32>) -> vec3&LTf32> {
</span><span style=color:#f07171>-    return view::position_world_to_ndc(world_pos, view_bindings::view.clip_from_world);
</span><span style=color:#86b300>+    let ndc_pos = view_bindings::view.clip_from_world * vec4(world_pos, 1.0);
</span><span style=color:#86b300>+    return ndc_pos.xyz / ndc_pos.w;
</span><span> }
</span><span> 
</span><span> /// Convert a view space position to ndc space
</span><span style=color:#f07171>-/// DEPRECATED: use bevy_render::view::position_view_to_ndc instead
</span><span> fn position_view_to_ndc(view_pos: vec3&LTf32>) -> vec3&LTf32> {
</span><span style=color:#f07171>-    return view::position_view_to_ndc(view_pos, view_bindings::view.clip_from_view);
</span><span style=color:#86b300>+    let ndc_pos = view_bindings::view.clip_from_view * vec4(view_pos, 1.0);
</span><span style=color:#86b300>+    return ndc_pos.xyz / ndc_pos.w;
</span><span> }
</span><span> 
</span><span> // -----------------
</span><span style=color:#c594c5>@@ -162,28 +163,47 @@ </span><span style=color:#399ee6>fn position_view_to_ndc(view_pos: vec3&LTf32>) -> vec3&LTf32> {
</span><span> // -----------------
</span><span> 
</span><span> /// Retrieve the perspective camera near clipping plane
</span><span style=color:#f07171>-/// DEPRECATED: use bevy_render::view::perspective_camera_near instead
</span><span> fn perspective_camera_near() -> f32 {
</span><span style=color:#f07171>-    return view::perspective_camera_near(view_bindings::view.clip_from_view);
</span><span style=color:#86b300>+    return view_bindings::view.clip_from_view[3][2];
</span><span> }
</span><span> 
</span><span> /// Convert ndc depth to linear view z. 
</span><span> /// Note: Depth values in front of the camera will be negative as -z is forward
</span><span style=color:#f07171>-/// DEPRECATED: use bevy_render::view::depth_ndc_to_view_z instead
</span><span> fn depth_ndc_to_view_z(ndc_depth: f32) -> f32 {
</span><span style=color:#f07171>-    return view::depth_ndc_to_view_z(ndc_depth, view_bindings::view.clip_from_view, view_bindings::view.view_from_clip);
</span><span style=color:#86b300>+#ifdef VIEW_PROJECTION_PERSPECTIVE
</span><span style=color:#86b300>+    return -perspective_camera_near() / ndc_depth;
</span><span style=color:#86b300>+#else ifdef VIEW_PROJECTION_ORTHOGRAPHIC
</span><span style=color:#86b300>+    return -(view_bindings::view.clip_from_view[3][2] - ndc_depth) / view_bindings::view.clip_from_view[2][2];
</span><span style=color:#86b300>+#else
</span><span style=color:#86b300>+    let view_pos = view_bindings::view.view_from_clip * vec4(0.0, 0.0, ndc_depth, 1.0);
</span><span style=color:#86b300>+    return view_pos.z / view_pos.w;
</span><span style=color:#86b300>+#endif
</span><span> }
</span><span> 
</span><span> /// Convert linear view z to ndc depth. 
</span><span> /// Note: View z input should be negative for values in front of the camera as -z is forward
</span><span style=color:#f07171>-/// DEPRECATED: use bevy_render::view::view_z_to_depth_ndc instead
</span><span> fn view_z_to_depth_ndc(view_z: f32) -> f32 {
</span><span style=color:#f07171>-    return view::view_z_to_depth_ndc(view_z, view_bindings::view.clip_from_view);
</span><span style=color:#86b300>+#ifdef VIEW_PROJECTION_PERSPECTIVE
</span><span style=color:#86b300>+    return -perspective_camera_near() / view_z;
</span><span style=color:#86b300>+#else ifdef VIEW_PROJECTION_ORTHOGRAPHIC
</span><span style=color:#86b300>+    return view_bindings::view.clip_from_view[3][2] + view_z * view_bindings::view.clip_from_view[2][2];
</span><span style=color:#86b300>+#else
</span><span style=color:#86b300>+    let ndc_pos = view_bindings::view.clip_from_view * vec4(0.0, 0.0, view_z, 1.0);
</span><span style=color:#86b300>+    return ndc_pos.z / ndc_pos.w;
</span><span style=color:#86b300>+#endif
</span><span> }
</span><span> 
</span><span style=color:#f07171>-/// DEPRECATED: use bevy_render::view::prev_view_z_to_depth_ndc instead
</span><span> fn prev_view_z_to_depth_ndc(view_z: f32) -> f32 {
</span><span style=color:#f07171>-    return view::view_z_to_depth_ndc(view_z, prepass_bindings::previous_view_uniforms.clip_from_view);
</span><span style=color:#86b300>+#ifdef VIEW_PROJECTION_PERSPECTIVE
</span><span style=color:#86b300>+    return -perspective_camera_near() / view_z;
</span><span style=color:#86b300>+#else ifdef VIEW_PROJECTION_ORTHOGRAPHIC
</span><span style=color:#86b300>+    return prepass_bindings::previous_view_uniforms.clip_from_view[3][2] +
</span><span style=color:#86b300>+        view_z * prepass_bindings::previous_view_uniforms.clip_from_view[2][2];
</span><span style=color:#86b300>+#else
</span><span style=color:#86b300>+    let ndc_pos = prepass_bindings::previous_view_uniforms.clip_from_view *
</span><span style=color:#86b300>+        vec4(0.0, 0.0, view_z, 1.0);
</span><span style=color:#86b300>+    return ndc_pos.z / ndc_pos.w;
</span><span style=color:#86b300>+#endif
</span><span> }
</span><span> 
</span><span> // -----------------
</span><span style=color:#c594c5>@@ -191,33 +211,28 @@ </span><span style=color:#399ee6>fn prev_view_z_to_depth_ndc(view_z: f32) -> f32 {
</span><span> // -----------------
</span><span> 
</span><span> /// Convert ndc space xy coordinate [-1.0 .. 1.0] to uv [0.0 .. 1.0]
</span><span style=color:#f07171>-/// DEPRECATED: use bevy_render::view::ndc_to_uv instead
</span><span> fn ndc_to_uv(ndc: vec2&LTf32>) -> vec2&LTf32> {
</span><span style=color:#f07171>-    return view::ndc_to_uv(ndc);
</span><span style=color:#86b300>+    return ndc * vec2(0.5, -0.5) + vec2(0.5);
</span><span> }
</span><span> 
</span><span> /// Convert uv [0.0 .. 1.0] coordinate to ndc space xy [-1.0 .. 1.0]
</span><span style=color:#f07171>-/// DEPRECATED: use bevy_render::view::uv_to_ndc instead
</span><span> fn uv_to_ndc(uv: vec2&LTf32>) -> vec2&LTf32> {
</span><span style=color:#f07171>-    return view::uv_to_ndc(uv);
</span><span style=color:#86b300>+    return uv * vec2(2.0, -2.0) + vec2(-1.0, 1.0);
</span><span> }
</span><span> 
</span><span> /// returns the (0.0, 0.0) .. (1.0, 1.0) position within the viewport for the current render target
</span><span> /// [0 .. render target viewport size] eg. [(0.0, 0.0) .. (1280.0, 720.0)] to [(0.0, 0.0) .. (1.0, 1.0)]
</span><span style=color:#f07171>-/// DEPRECATED: use bevy_render::view::frag_coord_to_uv instead
</span><span> fn frag_coord_to_uv(frag_coord: vec2&LTf32>) -> vec2&LTf32> {
</span><span style=color:#f07171>-    return view::frag_coord_to_uv(frag_coord, view_bindings::view.viewport);
</span><span style=color:#86b300>+    return (frag_coord - view_bindings::view.viewport.xy) / view_bindings::view.viewport.zw;
</span><span> }
</span><span> 
</span><span> /// Convert frag coord to ndc
</span><span style=color:#f07171>-/// DEPRECATED: use bevy_render::view::frag_coord_to_ndc instead
</span><span> fn frag_coord_to_ndc(frag_coord: vec4&LTf32>) -> vec3&LTf32> {
</span><span style=color:#f07171>-    return view::frag_coord_to_ndc(frag_coord, view_bindings::view.viewport);
</span><span style=color:#86b300>+    return vec3(uv_to_ndc(frag_coord_to_uv(frag_coord.xy)), frag_coord.z);
</span><span> }
</span><span> 
</span><span> /// Convert ndc space xy coordinate [-1.0 .. 1.0] to [0 .. render target
</span><span> /// viewport size]
</span><span style=color:#f07171>-/// DEPRECATED: use bevy_render::view::ndc_to_frag_coord instead
</span><span> fn ndc_to_frag_coord(ndc: vec2&LTf32>) -> vec2&LTf32> {
</span><span style=color:#f07171>-    return view::ndc_to_frag_coord(ndc, view_bindings::view.viewport);
</span><span style=color:#86b300>+    return ndc_to_uv(ndc) * view_bindings::view.viewport.zw;
</span><span> }
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-09/pr_21202.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>