<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20946 Add Image::clear()
        
    </title><meta content="#20946 Add Image::clear()" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-09/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-09-10</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-09/pr-20946-zh-cn-20250910>中文</a></div></div><div class=pr-content><h1 id=add-image-clear>Add Image::clear()</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Add Image::clear()<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20946<li><strong>Author</strong>: IceSentry<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: D-Trivial, A-Rendering, C-Usability, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-09-10T04:31:31Z<li><strong>Merged</strong>: 2025-09-10T16:48:10Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>When doing cpu drawing you sometimes need to clear the entire image. One option is to recreate a new image but this isn’t the most efficient.</ul><h2 id=solution>Solution</h2><ul><li>Add a utility function that clears the image using the provided pixel data. It does the exact same thing the <code>Image::new_fill()</code> does to fill the data buffer.</ul><h2 id=testing>Testing</h2><ul><li>I added a test that makes sure the clear fills the image with the expected data.</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a common performance optimization need in CPU-based image manipulation scenarios. When working with image data on the CPU, developers occasionally need to reset an entire image to a uniform color or pattern. The existing approach required creating a completely new Image instance, which incurred unnecessary allocation overhead and memory operations.<p>The solution implements a clear() method that operates directly on existing image data when available. The implementation follows the same pattern used by Image::new_fill() but applies it to an existing image buffer. This approach avoids the overhead of creating new allocations while providing identical functionality for clearing operations.<p>The implementation handles several edge cases gracefully:<ul><li>It returns early if the image format has a pixel size of zero or cannot be determined<li>It includes debug assertions to validate that the provided pixel data matches expected size requirements<li>It only operates when image data is already initialized (CPU-side), making it a no-op for GPU-only images</ul><p>The method works by calculating the total byte length needed based on the image dimensions and format, then iterating through the existing data buffer in chunks corresponding to pixel size, copying the provided pixel data into each position.<p>A comprehensive test was added to verify the functionality works correctly. The test creates an image filled with zeros, verifies the initial state, clears it with a different value (255), and confirms the entire image was updated appropriately.<p>This change provides a straightforward performance optimization for CPU image manipulation workflows while maintaining the existing API consistency and safety guarantees of the Image type.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[CPU Image Manipulation] --> B{Need to clear image?}
</span><span>    B -->|Yes| C[Use Image::clear()]
</span><span>    B -->|No| D[Continue normal operations]
</span><span>    C --> E[Efficient in-place update]
</span><span>    D --> F[Other image operations]
</span><span>    E --> F
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>File: crates/bevy_image/src/image.rs</strong><p>This file received two main additions:<ol><li>A new <code>clear()</code> method for the Image struct<li>A corresponding test function to verify the clear operation works correctly</ol><p><strong>Code Changes:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// New method added to Image implementation
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>clear</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>pixel</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>[</span><span style=color:#fa6e32>u8</span><span>]) {
</span><span>    </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(pixel_size) </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>texture_descriptor</span><span style=color:#ed9366>.</span><span>format</span><span style=color:#ed9366>.</span><span style=color:#f07171>pixel_size</span><span>()
</span><span>        </span><span style=color:#ed9366>&&</span><span> pixel_size </span><span style=color:#ed9366>> </span><span style=color:#ff8f40>0
</span><span>    {
</span><span>        </span><span style=color:#fa6e32>let</span><span> byte_len </span><span style=color:#ed9366>=</span><span> pixel_size </span><span style=color:#ed9366>* </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>texture_descriptor</span><span style=color:#ed9366>.</span><span>size</span><span style=color:#ed9366>.</span><span style=color:#f07171>volume</span><span>()</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#f07171>debug_assert_eq!</span><span>(
</span><span>            pixel</span><span style=color:#ed9366>.</span><span style=color:#f07171>len</span><span>() </span><span style=color:#ed9366>%</span><span> pixel_size</span><span style=color:#61676ccc>,
</span><span>            </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>,
</span><span>            </span><span style=color:#86b300>"Must not have incomplete pixel data (pixel size is {}B)."</span><span style=color:#61676ccc>,
</span><span>            pixel_size</span><span style=color:#61676ccc>,
</span><span>        )</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#f07171>debug_assert!</span><span>(
</span><span>            pixel</span><span style=color:#ed9366>.</span><span style=color:#f07171>len</span><span>() </span><span style=color:#ed9366><=</span><span> byte_len</span><span style=color:#61676ccc>,
</span><span>            </span><span style=color:#86b300>"Clear data must fit within pixel buffer (expected {byte_len}B)."</span><span style=color:#61676ccc>,
</span><span>        )</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(data) </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>data</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_mut</span><span>() {
</span><span>            </span><span style=color:#fa6e32>for</span><span> pixel_data </span><span style=color:#ed9366>in</span><span> data</span><span style=color:#ed9366>.</span><span style=color:#f07171>chunks_mut</span><span>(pixel_size) {
</span><span>                pixel_data</span><span style=color:#ed9366>.</span><span style=color:#f07171>copy_from_slice</span><span>(pixel)</span><span style=color:#61676ccc>;
</span><span>            }
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// New test added
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>image_clear</span><span>() {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> image </span><span style=color:#ed9366>= </span><span>Image</span><span style=color:#ed9366>::</span><span>new_fill(
</span><span>        Extent3d {
</span><span>            width</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>32</span><span style=color:#61676ccc>,
</span><span>            height</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>32</span><span style=color:#61676ccc>,
</span><span>            depth_or_array_layers</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>,
</span><span>        }</span><span style=color:#61676ccc>,
</span><span>        TextureDimension</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>D2</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#ed9366>&</span><span>[</span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>; </span><span style=color:#ff8f40>4</span><span>]</span><span style=color:#61676ccc>,
</span><span>        TextureFormat</span><span style=color:#ed9366>::</span><span>Rgba8Snorm</span><span style=color:#61676ccc>,
</span><span>        RenderAssetUsages</span><span style=color:#ed9366>::</span><span>all()</span><span style=color:#61676ccc>,
</span><span>    )</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#f07171>assert!</span><span>(image</span><span style=color:#ed9366>.</span><span>data</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_ref</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>all</span><span>(|</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>p</span><span>| p </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0</span><span>))</span><span style=color:#61676ccc>;
</span><span>
</span><span>    image</span><span style=color:#ed9366>.</span><span style=color:#f07171>clear</span><span>(</span><span style=color:#ed9366>&</span><span>[</span><span style=color:#ff8f40>255</span><span style=color:#61676ccc>; </span><span style=color:#ff8f40>4</span><span>])</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#f07171>assert!</span><span>(image</span><span style=color:#ed9366>.</span><span>data</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_ref</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>all</span><span>(|</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>p</span><span>| p </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>255</span><span>))</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li>Bevy Image Documentation: https://docs.rs/bevy/latest/bevy/render/texture/struct.Image.html<li>Texture Formats in Bevy: https://docs.rs/bevy/latest/bevy/render/texture/enum.TextureFormat.html<li>CPU Image Manipulation Patterns: https://github.com/bevyengine/bevy/discussions/20177</ul><h1 id=full-code-diff>Full Code Diff</h1><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_image/src/image.rs b/crates/bevy_image/src/image.rs
</span><span>index 9a6fcc63b8a7e..45e62ebe3c520 100644
</span><span style=color:#c594c5>--- a/crates/bevy_image/src/image.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_image/src/image.rs
</span><span style=color:#c594c5>@@ -1291,6 +1291,33 @@ </span><span style=color:#399ee6>impl Image {
</span><span>         offset.map(|start| &mut data[start..(start + len)])
</span><span>     }
</span><span> 
</span><span style=color:#86b300>+    /// Clears the content of the image with the given pixel. The image needs to be initialized on
</span><span style=color:#86b300>+    /// the cpu otherwise this is a noop.
</span><span style=color:#86b300>+    ///
</span><span style=color:#86b300>+    /// This does nothing if the image data is not already initialized
</span><span style=color:#86b300>+    pub fn clear(&mut self, pixel: &[u8]) {
</span><span style=color:#86b300>+        if let Ok(pixel_size) = self.texture_descriptor.format.pixel_size()
</span><span style=color:#86b300>+            && pixel_size > 0
</span><span style=color:#86b300>+        {
</span><span style=color:#86b300>+            let byte_len = pixel_size * self.texture_descriptor.size.volume();
</span><span style=color:#86b300>+            debug_assert_eq!(
</span><span style=color:#86b300>+                pixel.len() % pixel_size,
</span><span style=color:#86b300>+                0,
</span><span style=color:#86b300>+                "Must not have incomplete pixel data (pixel size is {}B).",
</span><span style=color:#86b300>+                pixel_size,
</span><span style=color:#86b300>+            );
</span><span style=color:#86b300>+            debug_assert!(
</span><span style=color:#86b300>+                pixel.len() <= byte_len,
</span><span style=color:#86b300>+                "Clear data must fit within pixel buffer (expected {byte_len}B).",
</span><span style=color:#86b300>+            );
</span><span style=color:#86b300>+            if let Some(data) = self.data.as_mut() {
</span><span style=color:#86b300>+                for pixel_data in data.chunks_mut(pixel_size) {
</span><span style=color:#86b300>+                    pixel_data.copy_from_slice(pixel);
</span><span style=color:#86b300>+                }
</span><span style=color:#86b300>+            }
</span><span style=color:#86b300>+        }
</span><span style=color:#86b300>+    }
</span><span style=color:#86b300>+
</span><span>     /// Read the color of a specific pixel (1D texture).
</span><span>     ///
</span><span>     /// See [`get_color_at`](Self::get_color_at) for more details.
</span><span style=color:#c594c5>@@ -2137,4 +2164,25 @@ </span><span style=color:#399ee6>mod test {
</span><span>             Ok(Color::LinearRgba(GROW_FILL))
</span><span>         ));
</span><span>     }
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+    #[test]
</span><span style=color:#86b300>+    fn image_clear() {
</span><span style=color:#86b300>+        let mut image = Image::new_fill(
</span><span style=color:#86b300>+            Extent3d {
</span><span style=color:#86b300>+                width: 32,
</span><span style=color:#86b300>+                height: 32,
</span><span style=color:#86b300>+                depth_or_array_layers: 1,
</span><span style=color:#86b300>+            },
</span><span style=color:#86b300>+            TextureDimension::D2,
</span><span style=color:#86b300>+            &[0; 4],
</span><span style=color:#86b300>+            TextureFormat::Rgba8Snorm,
</span><span style=color:#86b300>+            RenderAssetUsages::all(),
</span><span style=color:#86b300>+        );
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+        assert!(image.data.as_ref().unwrap().iter().all(|&p| p == 0));
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+        image.clear(&[255; 4]);
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+        assert!(image.data.as_ref().unwrap().iter().all(|&p| p == 255));
</span><span style=color:#86b300>+    }
</span><span> }
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-09/pr_20946.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>