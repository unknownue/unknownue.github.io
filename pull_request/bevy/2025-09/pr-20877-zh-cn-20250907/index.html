<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20877 Introduce MovingPtr as a safer alternative to moving typed values by raw pointer
        
    </title><meta content="#20877 Introduce MovingPtr as a safer alternative to moving typed values by raw pointer" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-09/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-09-07</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2025-09/pr-20877-en-20250907>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=introduce-movingptr-as-a-safer-alternative-to-moving-typed-values-by-raw-pointer>Introduce MovingPtr as a safer alternative to moving typed values by raw pointer</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Introduce MovingPtr as a safer alternative to moving typed values by raw pointer<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20877<li><strong>Author</strong>: james7132<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Usability, S-Ready-For-Final-Review, A-Pointers, D-Unsafe<li><strong>Created</strong>: 2025-09-05T02:55:01Z<li><strong>Merged</strong>: 2025-09-07T20:57:32Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>使移动潜在的大值（如 #20571 和 #20772 中看到的）更安全且更易于审查。<h2 id=solution>Solution</h2><p>引入 <code>MovingPtr<'a, T></code> 作为 <code>NonNull&LTT></code> 的包装器。该类型：<ul><li>包装指针，因此传递给函数的成本低廉。<li>类似于不拥有其指向分配的 <code>Box&LTT></code>。当被丢弃时，它将丢弃其指向的值，但不会在丢弃时释放分配。<li>类似于 <code>OwningPtr</code>，因为它拥有其指向的值并具有关联的生命周期，但它具有具体类型。<li>由于它拥有该值，因此不实现 <code>Clone</code> 或 <code>Copy</code>。<li>不支持除获取值字段的 <code>MovingPtr</code> 之外的任意指针算术。<li>不支持转换为 <code>ManuallyDrop&LTT></code> 和 <code>MaybeUninit&LTT></code> 以外的类型。<li>具有消耗 <code>MovingPtr</code> 的方法，这些方法将值复制到目标指针或将其读取到堆栈上。<li>提供不安全函数，用于部分移出值的成员，并返回 <code>MovingPtr<'a, MaybeUninit&LTT>></code> 作为替代。<li>可选地支持未对齐指针，如 <code>OwningPtr</code>，用于 #20593 等用例。<li>提供 <code>From</code> 实现，用于转换为 <code>OwningPtr</code> 以进行类型擦除，而不丢失生命周期或对齐要求。<li>提供 <code>TryFrom</code> 实现，尝试将未对齐实例转换为对齐实例。可与 <code>DebugCheckedUnwrap</code> 结合使用以断言转换是合理的。<li><code>deconstruct_moving_ptr</code> 提供了一种错误更少的方式将 <code>MovingPtr</code> 分解为其字段的单独 <code>MovingPtr</code>。</ul><p>该设计大致基于 <a rel="noopener nofollow noreferrer" href=https://github.com/rust-lang/lang-team/issues/336#issuecomment-3049593105 target=_blank>原地构造</a> 的 outptr 提案，但目前避开了对派生宏的要求。<h2 id=testing>Testing</h2><p>CI，新的文档测试通过。<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>在 Rust 中处理大型值时，直接通过值移动可能导致性能问题，因为涉及整个值的 memcpy。PR #20571 和 #20772 突出了对更安全、高效移动大型值方式的需求。现有的 <code>OwningPtr</code> 提供了一定帮助，但它是类型擦除的，缺乏类型安全的移动操作。<p>开发者引入了 <code>MovingPtr<'a, T></code>，这是一个围绕 <code>NonNull&LTT></code> 的包装器类型，设计用于安全地拥有和移动值而不拥有其分配。该类型的关键特性包括：<ol><li>拥有值但不拥有内存分配（类似于指向栈或 Vec 中元素的指针）<li>防止意外复制（不实现 Clone/Copy）<li>支持对齐和未对齐指针<li>提供安全的方法来读取值或将其写入新位置<li>支持部分移动和析构式移动</ol><p>实现的核心是扩展 <code>IsAligned</code> trait，为对齐和未对齐情况提供专门的 <code>read_ptr</code>、<code>copy_nonoverlapping</code> 和 <code>drop_in_place</code> 方法。<code>MovingPtr</code> 通过这些方法在不同对齐情况下正确操作。<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub trait </span><span style=color:#399ee6>IsAligned</span><span>: sealed::Sealed {
</span><span>    </span><span style=color:#fa6e32>unsafe fn </span><span style=color:#f29718>read_ptr</span><span>&LTT>(</span><span style=color:#ff8f40>ptr</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>*const</span><span> T) </span><span style=color:#61676ccc>-></span><span> T</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>unsafe fn </span><span style=color:#f29718>copy_nonoverlapping</span><span>&LTT>(</span><span style=color:#ff8f40>src</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>*const</span><span> T, </span><span style=color:#ff8f40>dst</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>*mut</span><span> T, </span><span style=color:#ff8f40>count</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize</span><span>)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>unsafe fn </span><span style=color:#f29718>drop_in_place</span><span>&LTT>(</span><span style=color:#ff8f40>ptr</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>*mut</span><span> T)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p><code>MovingPtr</code> 提供了几个关键方法：<ul><li><code>make</code>：安全地创建 MovingPtr 的构造函数<li><code>read</code>：将值读取出指针<li><code>write_to</code>/<code>assign_to</code>：将值写入新位置<li><code>move_field</code>：获取结构体字段的 MovingPtr</ul><p>还引入了 <code>deconstruct_moving_ptr!</code> 宏，用于安全地将结构体分解为其字段：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>bevy_ptr</span><span style=color:#ed9366>::</span><span>deconstruct_moving_ptr</span><span style=color:#ed9366>!</span><span>(parent_ptr</span><span style=color:#61676ccc>,</span><span> Parent {
</span><span>    field_a</span><span style=color:#61676ccc>:</span><span> FieldAType </span><span style=color:#ed9366>=> </span><span>{ field_a</span><span style=color:#ed9366>.</span><span style=color:#f07171>assign_to</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> target_a) }</span><span style=color:#61676ccc>,
</span><span>    field_b</span><span style=color:#61676ccc>:</span><span> FieldBType </span><span style=color:#ed9366>=> </span><span>{ field_b</span><span style=color:#ed9366>.</span><span style=color:#f07171>assign_to</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> target_b) }</span><span style=color:#61676ccc>,
</span><span>})</span><span style=color:#61676ccc>;
</span></code></pre><p>这些更改使 Bevy 能够更安全、高效地处理大型值的移动，减少了手动指针操作的风险，同时保持了灵活性。该实现考虑了各种边缘情况，如panic安全、对齐要求和部分移动，为处理复杂值移动提供了强大的基础。<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[MovingPtr] --> B[NonNull&LTT>]
</span><span>    A --> C[PhantomData]
</span><span>    A --> D[IsAligned]
</span><span>    D --> E[Aligned]
</span><span>    D --> F[Unaligned]
</span><span>    A --> G[Methods]
</span><span>    G --> H[read]
</span><span>    G --> I[write_to]
</span><span>    G --> J[assign_to]
</span><span>    G --> K[move_field]
</span><span>    A --> L[Conversions]
</span><span>    L --> M[OwningPtr]
</span><span>    L --> N[TryFrom aligned]
</span><span>    A --> O[Drop]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ptr-src-lib-rs-576-22><code>crates/bevy_ptr/src/lib.rs</code> (+576/-22)</h3><p>主要实现了 <code>MovingPtr</code> 类型和相关功能：<ol><li>扩展 <code>IsAligned</code> trait 及其实现<li>添加 <code>MovingPtr</code> 结构定义和方法<li>实现转换 trait（From/TryFrom）<li>实现 Drop trait<li>添加 <code>deconstruct_moving_ptr!</code> 宏</ol><p>关键代码片段：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// MovingPtr 结构定义
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>MovingPtr</span><span><</span><span style=color:#fa6e32>'a</span><span>, T, A</span><span style=color:#61676ccc>:</span><span> IsAligned = Aligned>(NonNull&LTT>, PhantomData<(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'a mut</span><span> T, A)</span><span style=color:#ed9366>></span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 核心方法：读取值
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>read</span><span>(</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-></span><span> T {
</span><span>    </span><span style=color:#fa6e32>let</span><span> value </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>unsafe </span><span>{ A</span><span style=color:#ed9366>::</span><span>read_ptr(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0.</span><span style=color:#f07171>as_ptr</span><span>()) }</span><span style=color:#61676ccc>;
</span><span>    mem</span><span style=color:#ed9366>::</span><span>forget(</span><span style=color:#55b4d4;font-style:italic>self</span><span>)</span><span style=color:#61676ccc>;
</span><span>    value
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 核心方法：移动字段
</span><span style=color:#fa6e32>pub unsafe fn </span><span style=color:#f29718>move_field</span><span>&LTU>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>byte_offset</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize</span><span>) </span><span style=color:#61676ccc>-> </span><span>MovingPtr<</span><span style=color:#fa6e32>'a</span><span>, U, Unaligned> {
</span><span>    MovingPtr(
</span><span>        </span><span style=color:#fa6e32>unsafe </span><span>{ </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0.</span><span style=color:#f07171>byte_add</span><span>(byte_offset) }</span><span style=color:#ed9366>.</span><span>cast</span><span style=color:#ed9366>::</span><span>&LTU>()</span><span style=color:#61676ccc>,
</span><span>        PhantomData</span><span style=color:#61676ccc>,
</span><span>    )
</span><span>}
</span></code></pre><h3 id=crates-bevy-ptr-readme-md-6-0><code>crates/bevy_ptr/README.md</code> (+6/-0)</h3><p>更新文档，添加 <code>MovingPtr</code> 到指针类型比较表并添加描述：<table><thead><tr><th>类型<th>拥有值<th>可变<th>类型已知<th>对齐<th>生命周期<th>可派生字段<th>可转换类型<tbody><tr><td><code>MovingPtr<'a, T></code><td>是<td>是<td>是<td>可能<td>是<td>是<td>是</table><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/nomicon/working-with-unsafe.html target=_blank>Rust Nomicon: Working with Unsafe</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/rust-lang/rfcs/issues/2626 target=_blank>Rust RFC: In-place constructors</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/ebook/introduction/ target=_blank>Bevy Engine: ECS Overview</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-09/pr_20877.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>