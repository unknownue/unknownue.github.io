<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21002 Mark meshes as changed *after* AssetEvents are processed.
        
    </title><meta content="#21002 Mark meshes as changed *after* AssetEvents are processed." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-09/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-09-13</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-09/pr-21002-zh-cn-20250913>中文</a></div></div><div class=pr-content><h1 id=mark-meshes-as-changed-after-assetevents-are-processed>Mark meshes as changed <em>after</em> AssetEvents are processed.</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Mark meshes as changed <em>after</em> AssetEvents are processed.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21002<li><strong>Author</strong>: mrtracy<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, A-Assets<li><strong>Created</strong>: 2025-09-13T06:09:23Z<li><strong>Merged</strong>: 2025-09-13T08:04:51Z<li><strong>Merged By</strong>: james7132</ul><h2 id=description-translation>Description Translation</h2><p>Whenever a Mesh asset is modified, bevy needs to mark entities which include a matching <code>Mesh3D</code> component as Changed. The need for this is explained on the comment for system <code>mark_3d_meshes_as_changed_if_their_assets_changed</code>, which performs this action:<blockquote><p>This is needed because the systems that extract meshes, such as <code>extract_meshes_for_gpu_building</code>, write some metadata about the mesh (like the location within each slab) into the GPU structures that they build that needs to be kept up to date if the contents of the mesh change.</blockquote><p>However, this system use EventReader&LTAssetEvent<mesh>> to detect this, but was scheduled <em>before</em> AssetEvents are processed for the frame. This created a one-frame delay in the update, which was causing the “mesh flickering” in #19409 - a result of using the previous model’s vertex and index offsets against the newly updated mesh buffers. <h1 id=objective>Objective</h1> <ul><li>Fixes #19409</ul> <h2 id=solution>Solution</h2> <ul><li>Fix is to schedule this system <em>after</em> AssetEvents are processed for the frame.</ul> <h2 id=testing>Testing</h2> <ul><li>Had a perfectly consistent graphical reproduction of the situation: Updating a mesh which is being displayed by an entity, and making it significantly <em>larger</em> in vertex count, triggers this reliably - the mesh will be significantly <em>underdrawn</em> for one frame.</ul> <h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2> <p>This PR addresses a synchronization issue in Bevy’s mesh asset handling system. The problem manifested as mesh flickering (#19409) when mesh assets were modified at runtime. The root cause was a timing mismatch between asset event processing and mesh change detection.</p> <p>The core issue was in the scheduling order of the <code>mark_3d_meshes_as_changed_if_their_assets_changed</code> system. This system uses <code>EventReader&LTAssetEvent&LTMesh>></code> to detect when mesh assets change and marks corresponding entities as changed. However, it was scheduled before the <code>AssetEventSystems</code>, which meant it was reading asset events from the previous frame while trying to process changes for the current frame.</p> <p>This created a one-frame delay where the mesh extraction systems would use outdated metadata (like vertex and index buffer offsets) with newly updated mesh data. The result was graphical artifacts where meshes would be underdrawn or incorrectly rendered for one frame before correcting themselves.</p> <p>The fix is straightforward but critical: reschedule the system to run after <code>AssetEventSystems</code>. This ensures that asset events for the current frame have been fully processed before the system attempts to detect mesh changes. The mesh extraction systems can then work with synchronized data, preventing the one-frame rendering artifacts.</p> <p>This change demonstrates the importance of precise system ordering in ECS architectures, particularly when dealing with asset pipelines where timing dependencies between asset loading, event processing, and rendering systems are crucial for correct behavior.</p> <h2 id=visual-representation>Visual Representation</h2> <pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Asset Event Processing] --> B[Mark Meshes as Changed]
</span><span>    B --> C[Mesh Extraction Systems]
</span><span>    C --> D[GPU Buffer Updates]
</span><span>    
</span><span>    style A fill:#e6f3ff
</span><span>    style B fill:#fff0e6
</span><span>    style C fill:#e6ffe6
</span><span>    style D fill:#f9e6ff
</span></code></pre> <h2 id=key-files-changed>Key Files Changed</h2> <h3 id=crates-bevy-mesh-src-lib-rs><code>crates/bevy_mesh/src/lib.rs</code></h3> <p>This file contains the plugin definition for Bevy’s mesh functionality. The change modifies the scheduling order of the mesh change detection system.</p> <p><strong>Before:</strong></p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(
</span><span>    PostUpdate</span><span style=color:#61676ccc>,
</span><span>    mark_3d_meshes_as_changed_if_their_assets_changed</span><span style=color:#ed9366>.</span><span style=color:#f07171>before</span><span>(AssetEventSystems)</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre> <p><strong>After:</strong></p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(
</span><span>    PostUpdate</span><span style=color:#61676ccc>,
</span><span>    mark_3d_meshes_as_changed_if_their_assets_changed</span><span style=color:#ed9366>.</span><span style=color:#f07171>after</span><span>(AssetEventSystems)</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre> <p>The change moves the system from running before asset event processing to after it, ensuring mesh changes are detected only after current frame asset events have been processed.</p> <h2 id=further-reading>Further Reading</h2> <ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/books/the-bevy-book/0.14/programming/ecs/system-order/ target=_blank>Bevy ECS System Ordering</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/books/the-bevy-book/0.14/assets/ target=_blank>Asset System Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/issues/19409 target=_blank>Original Issue #19409</a></ul>    <div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-09/pr_21002.patch id=patch-info style=display:none></div>  <div class=bottom-spacer></div> 