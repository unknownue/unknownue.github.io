<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20298 Remove systems from schedule
        
    </title><meta content="#20298 Remove systems from schedule" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-09/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-09-29</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-09/pr-20298-zh-cn-20250929>中文</a></div></div><div class=pr-content><h1 id=remove-systems-from-schedule>Remove systems from schedule</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Remove systems from schedule<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20298<li><strong>Author</strong>: hymm<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Feature, A-ECS, S-Ready-For-Final-Review, M-Needs-Release-Note, X-Contentious<li><strong>Created</strong>: 2025-07-26T20:21:00Z<li><strong>Merged</strong>: 2025-09-29T22:44:45Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Add ability to remove systems from a schedule.<li>Fixes #279.</ul><h2 id=solution>Solution</h2><ul><li>add <code>remove_systems_in_set</code> method which removes all the systems by their set name. In most cases systems are added to a schedule once, so just passing the system (which is an implicit set by it’s type name) will just remove the one system. If a system is added multiple times such as <code>apply_deferred</code>, then you may need to give the system a unique set, if you just want to remove just one system.<li>The method also tries to remove all the configuration for the set and the systems found.<li>We need to pass world to the method because user build passes are allowed to write to the world.</ul><h2 id=testing>Testing</h2><ul><li>Added some unit tests.</ul><h2 id=future-work>Future work</h2><ul><li>In the future of systems as entities this will probably look much different. We’d probably store all the edges as relationships, so hopefully cleanup would be easier.<li>It’d be better if remove_systems_in_set could take a tuple of system sets. I looked into using IntoScheduleConfigs, but that won’t work since the system set version of it errors if you try to pass a system type set. This would allow for less rebuilding of the schedule. The schedule needs to be rebuilt to each call to be able to find the system set.</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a long-standing gap in Bevy’s ECS scheduling system - the inability to remove systems from a schedule after they’ve been added. The problem was tracked in issue #279, which remained open for years, indicating both the complexity of the feature and its importance to the community.<p>The core challenge was that Bevy’s schedule system represents systems and their relationships as complex graph structures. Removing nodes from these graphs while maintaining correct ordering dependencies required careful engineering. Previously, developers had to use run conditions to skip systems, but this still incurred the overhead of condition checking every frame.<p>The solution centers around a new <code>remove_systems_in_set</code> method that operates on system sets. Since individual systems are implicitly placed in sets based on their type name, this approach can target both individual systems and groups of systems. The implementation needed to handle several technical challenges:<ol><li><strong>Graph Maintenance</strong>: When removing systems, the schedule’s dependency graph must be updated to preserve ordering constraints between remaining systems<li><strong>Multiple Removal Policies</strong>: Different use cases require different cleanup strategies, from simple removal to maintaining transitive dependencies<li><strong>API Design</strong>: The method needed to be accessible from multiple entry points (App, SubApp, Schedule) while maintaining consistency</ol><p>The implementation introduces a <code>ScheduleCleanupPolicy</code> enum with four variants that control how aggressively systems and sets are removed and whether transitive dependencies are maintained:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub enum </span><span style=color:#399ee6>ScheduleCleanupPolicy </span><span>{
</span><span>    RemoveSetAndSystems</span><span style=color:#61676ccc>,
</span><span>    RemoveSystemsOnly</span><span style=color:#61676ccc>,
</span><span>    RemoveSetAndSystemsAllowBreakages</span><span style=color:#61676ccc>,
</span><span>    RemoveSystemsOnlyAllowBreakages</span><span style=color:#61676ccc>,
</span><span>}
</span></code></pre><p>The most sophisticated part of the implementation is the graph manipulation logic in <code>add_edges_for_transitive_dependencies</code>. When removing a node (system or set), this method analyzes the incoming and outgoing edges and creates new direct edges between the predecessors and successors, effectively bypassing the removed node while preserving the overall ordering.<p>One key insight was that systems added multiple times (like <code>apply_deferred</code>) would need unique sets if developers want to remove individual instances. The implementation handles this by tracking systems in a <code>set_systems</code> HashMap that maps system set keys to their contained system keys.<p>The changes required modifications across multiple layers of the scheduling system, from high-level App methods down to low-level graph manipulation. Each layer needed to expose the removal functionality while properly handling errors and state changes.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TB
</span><span>    A[App.remove_systems_in_set] --> B[Schedules.remove_systems_in_set]
</span><span>    B --> C[Schedule.remove_systems_in_set]
</span><span>    C --> D[ScheduleGraph.remove_systems_in_set]
</span><span>    D --> E[ScheduleGraph.add_edges_for_transitive_dependencies]
</span><span>    D --> F[ScheduleGraph.remove_systems_by_keys]
</span><span>    D --> G[ScheduleGraph.remove_set_by_key]
</span><span>    
</span><span>    E --> H[Hierarchy Graph Updates]
</span><span>    E --> I[Dependency Graph Updates]
</span><span>    
</span><span>    F --> J[Systems Container Removal]
</span><span>    G --> K[SystemSets Container Removal]
</span><span>    
</span><span>    J --> L[Graph Node Cleanup]
</span><span>    K --> L
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ecs-src-schedule-schedule-rs-395-6><code>crates/bevy_ecs/src/schedule/schedule.rs</code> (+395/-6)</h3><p>This file contains the core implementation of system removal functionality. The key additions include:<ul><li><code>remove_systems_in_set</code> method for <code>Schedule</code> and <code>Schedules</code><li><code>systems_in_set</code> method to query systems belonging to a set<li><code>add_edges_for_transitive_dependencies</code> for graph maintenance<li><code>ScheduleCleanupPolicy</code> enum defining removal strategies</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Key addition: System removal with dependency preservation
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>remove_systems_in_set</span><span>&LTM>(
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>,
</span><span>    </span><span style=color:#ff8f40>set</span><span style=color:#61676ccc>:</span><span> impl IntoSystemSet&LTM>,
</span><span>    </span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> World,
</span><span>    </span><span style=color:#ff8f40>policy</span><span style=color:#61676ccc>:</span><span> ScheduleCleanupPolicy,
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><</span><span style=color:#fa6e32>usize</span><span>, ScheduleError> {
</span><span>    </span><span style=color:#fa6e32>if </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>graph</span><span style=color:#ed9366>.</span><span>changed {
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>initialize</span><span>(world)</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>graph</span><span style=color:#ed9366>.</span><span style=color:#f07171>remove_systems_in_set</span><span>(set</span><span style=color:#61676ccc>,</span><span> policy)
</span><span>}
</span></code></pre><h3 id=crates-bevy-ecs-src-schedule-node-rs-36-8><code>crates/bevy_ecs/src/schedule/node.rs</code> (+36/-8)</h3><p>This file manages the internal node storage for systems and system sets. Key changes include:<ul><li>Added removal methods for both systems and system sets<li>Modified <code>node_mut</code> to return <code>Option</code> instead of panicking<li>Added <code>get_key</code> method for system set lookup</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Panic on missing node
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>node_mut</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>key</span><span style=color:#61676ccc>:</span><span> SystemKey) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> SystemNode {
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>nodes[key]
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Safe lookup
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>node_mut</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>key</span><span style=color:#61676ccc>:</span><span> SystemKey) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> SystemNode> {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>nodes</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_mut</span><span>(key)
</span><span>}
</span></code></pre><h3 id=crates-bevy-app-src-app-rs-36-1><code>crates/bevy_app/src/app.rs</code> (+36/-1)</h3><p>This file adds the public API for system removal at the application level:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>remove_systems_in_set</span><span>&LTM>(
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>,
</span><span>    </span><span style=color:#ff8f40>schedule</span><span style=color:#61676ccc>:</span><span> impl ScheduleLabel,
</span><span>    </span><span style=color:#ff8f40>set</span><span style=color:#61676ccc>:</span><span> impl IntoSystemSet&LTM>,
</span><span>    </span><span style=color:#ff8f40>policy</span><span style=color:#61676ccc>:</span><span> ScheduleCleanupPolicy,
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><</span><span style=color:#fa6e32>usize</span><span>, ScheduleError> {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>main_mut</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>remove_systems_in_set</span><span>(schedule</span><span style=color:#61676ccc>,</span><span> set</span><span style=color:#61676ccc>,</span><span> policy)
</span><span>}
</span></code></pre><h3 id=crates-bevy-ecs-src-schedule-error-rs-23-0><code>crates/bevy_ecs/src/schedule/error.rs</code> (+23/-0)</h3><p>Added new error types for schedule operations:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub enum </span><span style=color:#399ee6>ScheduleError </span><span>{
</span><span>    Uninitialized</span><span style=color:#61676ccc>,
</span><span>    SetNotFound</span><span style=color:#61676ccc>,
</span><span>    ScheduleNotFound</span><span style=color:#61676ccc>,
</span><span>    ScheduleBuildError(ScheduleBuildError)</span><span style=color:#61676ccc>,
</span><span>}
</span></code></pre><h3 id=release-content-release-notes-remove-systems-md-22-0><code>release-content/release-notes/remove_systems.md</code> (+22/-0)</h3><p>Added documentation explaining the new feature and its usage patterns.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/ecs/schedules/ target=_blank>Bevy ECS Scheduling Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/ecs/system-sets/ target=_blank>System Sets in Bevy</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/issues/279 target=_blank>Original Issue #279</a></ul><h1 id=full-code-diff>Full Code Diff</h1><p><em>(Provided in the original request)</em></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-09/pr_20298.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>