<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21183 Fix assets not reloading on AddedAsset event
        
    </title><meta content="#21183 Fix assets not reloading on AddedAsset event" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-09/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-09-25</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-09/pr-21183-zh-cn-20250925>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix assets not reloading on AddedAsset event<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21183<li><strong>Author</strong>: dloukadakis<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Assets, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-09-23T15:50:31Z<li><strong>Merged</strong>: 2025-09-25T19:38:57Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Fix asset reloading not working caused by some software while saving creating an unamed temporary file with <code>open</code> using <code>O_TMPFILE</code>, then link it to the filesystem with <code>linkat</code> on a temporary file and replace the existing asset file with that file. This only triggers <code>AssetSourceEvent::AddedAsset</code> which causes the assets to not reload when its are overwritten.</ul><h2 id=solution>Solution</h2><ul><li>Reload files when <code>AssetSourceEvent::AddedAsset</code> is triggered.</ul><h2 id=testing>Testing</h2><ul><li><p>Did you test these changes? If so, how? I made a simple scene with a sprite then deleted the sprite image and recreated it. See also #21203</p><li><p>Are there any parts that need more testing? No</p><li><p>How can other people (reviewers) test your changes? Is there anything specific they need to know? See #21203</p><li><p>If relevant, what platforms did you test these changes on, and are there any important ones you can’t test? Linux</p></ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a specific edge case in Bevy’s asset hot-reloading system. The core issue stems from how certain Linux applications handle file saving operations. When applications like text editors use the <code>O_TMPFILE</code> flag with <code>open()</code> followed by <code>linkat()</code> to replace existing files, they trigger an <code>AddedAsset</code> event instead of a <code>ModifiedAsset</code> event in Bevy’s file watching system.<p>The problem was that Bevy’s asset server only handled reloading for <code>ModifiedAsset</code> and <code>ModifiedMeta</code> events, but ignored <code>AddedAsset</code> events. This meant that when files were replaced using this specific saving technique, the assets wouldn’t hot-reload as expected.<p>The solution approach was straightforward: treat <code>AddedAsset</code> events similarly to modification events when it comes to asset reloading. The implementation involved refactoring the event handling logic to consolidate common reloading behavior and ensure <code>AddedAsset</code> events trigger the same reloading pipeline.<p>The key insight here is that from Bevy’s perspective, a file replacement that triggers an “added” event is functionally equivalent to a modification - the asset content has changed and needs to be reloaded. The implementation maintains the existing behavior for other event types while extending the reloading logic to cover this previously missed case.<p>The changes are minimal and focused, affecting only the asset event handling logic. The refactoring also improves code organization by extracting common reloading behavior into a reusable closure, making the logic more maintainable.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[File System Events] --> B[AssetSourceEvent]
</span><span>    B --> C{Event Type}
</span><span>    C -->|AddedAsset| D[Reload Asset]
</span><span>    C -->|ModifiedAsset| D
</span><span>    C -->|ModifiedMeta| D
</span><span>    C -->|Other Events| E[Handle Normally]
</span><span>    D --> F[Asset Hot Reloading]
</span><span>    E --> F
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>File: <code>crates/bevy_asset/src/server/mod.rs</code></strong><p>This file contains the core asset server implementation and the event handling logic for asset hot-reloading. The changes focus on modifying how <code>AssetSourceEvent::AddedAsset</code> events are processed.<p><strong>Key Changes:</strong><ol><li><strong>Refactored <code>reload_parent_folders</code> function</strong>: Improved the implementation to use <code>path.ancestors().skip(1)</code> for cleaner folder traversal.</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let </span><span style=color:#f29718>reload_parent_folders </span><span style=color:#ed9366>= </span><span>|</span><span style=color:#ff8f40>path</span><span style=color:#61676ccc>:</span><span> PathBuf</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>source</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>AssetSourceId<</span><span style=color:#fa6e32>'static</span><span>>| {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> current_folder </span><span style=color:#ed9366>=</span><span> path</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>while let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(parent) </span><span style=color:#ed9366>=</span><span> current_folder</span><span style=color:#ed9366>.</span><span style=color:#f07171>parent</span><span>() {
</span><span>        current_folder </span><span style=color:#ed9366>=</span><span> parent</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_path_buf</span><span>()</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#fa6e32>let</span><span> parent_asset_path </span><span style=color:#ed9366>= 
</span><span>            AssetPath</span><span style=color:#ed9366>::</span><span>from(current_folder</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>())</span><span style=color:#ed9366>.</span><span style=color:#f07171>with_source</span><span>(source</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>())</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ... folder reloading logic
</span><span>    }
</span><span>}</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let </span><span style=color:#f29718>reload_parent_folders </span><span style=color:#ed9366>= </span><span>|</span><span style=color:#ff8f40>path</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>PathBuf</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>source</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>AssetSourceId<</span><span style=color:#fa6e32>'static</span><span>>| {
</span><span>    </span><span style=color:#fa6e32>for</span><span> parent </span><span style=color:#ed9366>in</span><span> path</span><span style=color:#ed9366>.</span><span style=color:#f07171>ancestors</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>skip</span><span>(</span><span style=color:#ff8f40>1</span><span>) {
</span><span>        </span><span style=color:#fa6e32>let</span><span> parent_asset_path </span><span style=color:#ed9366>= 
</span><span>            AssetPath</span><span style=color:#ed9366>::</span><span>from(parent</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_path_buf</span><span>())</span><span style=color:#ed9366>.</span><span style=color:#f07171>with_source</span><span>(source</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>())</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ... folder reloading logic
</span><span>    }
</span><span>}</span><span style=color:#61676ccc>;
</span></code></pre><ol start=2><li><strong>Added <code>reload_path</code> closure</strong>: Created a reusable function to handle the common reloading logic.</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let mut </span><span style=color:#f29718>reload_path </span><span style=color:#ed9366>= </span><span>|</span><span style=color:#ff8f40>path</span><span style=color:#61676ccc>:</span><span> PathBuf</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>source</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>AssetSourceId<</span><span style=color:#fa6e32>'static</span><span>>| {
</span><span>    </span><span style=color:#fa6e32>let</span><span> path </span><span style=color:#ed9366>= </span><span>AssetPath</span><span style=color:#ed9366>::</span><span>from(path)</span><span style=color:#ed9366>.</span><span style=color:#f07171>with_source</span><span>(source)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#f07171>queue_ancestors</span><span>(</span><span style=color:#ed9366>&</span><span>path</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>infos</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> paths_to_reload)</span><span style=color:#61676ccc>;
</span><span>    paths_to_reload</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(path)</span><span style=color:#61676ccc>;
</span><span>}</span><span style=color:#61676ccc>;
</span></code></pre><ol start=3><li><strong>Modified event handling</strong>: Updated the event handler to process <code>AddedAsset</code> events similarly to modification events.</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>AssetSourceEvent</span><span style=color:#ed9366>::</span><span>AddedAsset(path) </span><span style=color:#ed9366>=> </span><span>{
</span><span>    </span><span style=color:#f07171>reload_parent_folders</span><span>(path</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>source)</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>AssetSourceEvent</span><span style=color:#ed9366>::</span><span>AddedAsset(path) </span><span style=color:#ed9366>=> </span><span>{
</span><span>    </span><span style=color:#f07171>reload_parent_folders</span><span>(</span><span style=color:#ed9366>&</span><span>path</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>source)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#f07171>reload_path</span><span>(path</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>source)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>The changes ensure that <code>AddedAsset</code> events now trigger both parent folder reloading and individual asset reloading, matching the behavior of modification events.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/assets/ target=_blank>Bevy Asset System Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://man7.org/linux/man-pages/man2/open.2.html target=_blank>Linux O_TMPFILE flag documentation</a><li><a rel="noopener nofollow noreferrer" href=https://gamedev.stackexchange.com/questions/12018/how-do-game-engines-handle-asset-hot-reloading target=_blank>File watching and hot-reloading patterns in game engines</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-09/pr_21183.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>