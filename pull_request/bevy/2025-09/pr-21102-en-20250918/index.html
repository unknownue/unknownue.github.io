<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21102 Combine added and existing `ComponentId`s in a single allocation
        
    </title><meta content="#21102 Combine added and existing `ComponentId`s in a single allocation" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-09/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-09-18</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-09/pr-21102-zh-cn-20250918>中文</a></div></div><div class=pr-content><h1 id=combine-added-and-existing-componentids-in-a-single-allocation>Combine added and existing <code>ComponentId</code>s in a single allocation</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Combine added and existing <code>ComponentId</code>s in a single allocation<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21102<li><strong>Author</strong>: chescock<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-ECS, C-Performance, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-09-17T14:48:50Z<li><strong>Merged</strong>: 2025-09-18T04:27:30Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Further shrink <code>ArchetypeAfterBundleInsert</code>, following #20626.<p>Remove the need for a <code>collect()</code> when triggering <code>Insert</code> observers.<h2 id=solution>Solution</h2><p>Combine the <code>added</code> and <code>existing</code> component id lists into a single boxed slice. We need to store an additional length to recover the slices, but this means we store <strong>one</strong> pointer and two lengths instead of <strong>two</strong> pointers and two lengths, shrinking the size of <code>ArchetypeAfterBundleInsert</code> by one pointer.<p>This also means we have a slice available for the full list of <code>inserted</code> components without having to copy them into a new <code>Vec</code>.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a performance optimization in Bevy’s ECS (Entity Component System) by improving how component IDs are stored and accessed during bundle insertion operations. The changes focus on reducing memory usage and eliminating unnecessary allocations when triggering observers.<p>The core issue was that <code>ArchetypeAfterBundleInsert</code> stored two separate boxed slices for tracking component IDs: one for added components and another for existing components. This required two separate pointer allocations and made it inefficient to access the combined list of inserted components, which required collecting both slices into a new Vec.<p>The solution combines both component ID lists into a single contiguous allocation while maintaining the ability to access the added and existing subsets separately. This is achieved by storing:<ol><li>A single boxed slice containing all inserted component IDs (added components first, then existing ones)<li>A length value indicating where the added components end and existing components begin</ol><p>This approach reduces the memory footprint of <code>ArchetypeAfterBundleInsert</code> by eliminating one pointer (from two pointers to one), and provides direct access to the combined inserted components without requiring additional allocations.<p>The implementation required changes to both the data structure definition and its usage sites. The <code>ArchetypeAfterBundleInsert</code> struct was modified to replace the separate <code>added</code> and <code>existing</code> fields with a combined <code>inserted</code> field and an <code>added_len</code> field. New accessor methods (<code>inserted()</code>, <code>added()</code>, <code>existing()</code>) were added to provide safe access to the different subsets of components.<p>In the bundle insertion logic, the changes eliminate the need for collecting component IDs into a temporary Vec when triggering INSERT observers. Instead, the code can now directly use the pre-allocated slice, improving performance by avoiding this allocation and copy operation.<p>The changes maintain backward compatibility in the API while providing significant memory and performance improvements. The optimization is particularly valuable in scenarios with frequent bundle insertions and many component observers.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[ArchetypeAfterBundleInsert] --> B[inserted: Box<[ComponentId]>]
</span><span>    A --> C[added_len: usize]
</span><span>    B --> D[added components]
</span><span>    B --> E[existing components]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ecs-src-archetype-rs-23-15><code>crates/bevy_ecs/src/archetype.rs</code> (+23/-15)</h3><p>This file contains the core changes to the <code>ArchetypeAfterBundleInsert</code> data structure and its construction.<p><strong>Key changes:</strong><ol><li>Replaced separate <code>added</code> and <code>existing</code> fields with combined <code>inserted</code> storage<li>Added <code>added_len</code> field to track the boundary between added and existing components<li>Implemented new accessor methods for safe slicing<li>Updated the bundle insertion logic to build the combined storage</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>ArchetypeAfterBundleInsert </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) added</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Box</span><span><[ComponentId]>,
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) existing</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Box</span><span><[ComponentId]>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>ArchetypeAfterBundleInsert </span><span>{
</span><span>    inserted</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Box</span><span><[ComponentId]>,
</span><span>    added_len</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize</span><span>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// New accessor methods:
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>inserted</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span>[ComponentId] {
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>inserted
</span><span>}
</span><span>
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>added</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span>[ComponentId] {
</span><span>    </span><span style=color:#fa6e32>unsafe </span><span>{ </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>inserted</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#ed9366>..</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>added_len)</span><span style=color:#ed9366>.</span><span style=color:#f07171>debug_checked_unwrap</span><span>() }
</span><span>}
</span><span>
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>existing</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span>[ComponentId] {
</span><span>    </span><span style=color:#fa6e32>unsafe </span><span>{ </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>inserted</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>added_len</span><span style=color:#ed9366>..</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>debug_checked_unwrap</span><span>() }
</span><span>}
</span></code></pre><h3 id=crates-bevy-ecs-src-bundle-insert-rs-8-12><code>crates/bevy_ecs/src/bundle/insert.rs</code> (+8/-12)</h3><p>This file contains updates to the bundle insertion logic to use the new combined storage format.<p><strong>Key changes:</strong><ol><li>Updated observer triggering code to use the new accessor methods<li>Eliminated the need for collecting component IDs into a Vec for INSERT events<li>Maintained the same observer behavior with improved performance</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before (required collect()):
</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> EntityComponentsTrigger {
</span><span>    components</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>archetype_after_insert
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>iter_inserted</span><span>()
</span><span>        </span><span style=color:#ed9366>.</span><span>collect</span><span style=color:#ed9366>::</span><span><</span><span style=color:#55b4d4;font-style:italic>Vec</span><span><</span><span style=color:#ed9366>_</span><span>>>()</span><span style=color:#61676ccc>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After (direct slice access):
</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> EntityComponentsTrigger {
</span><span>    components</span><span style=color:#61676ccc>:</span><span> archetype_after_insert</span><span style=color:#ed9366>.</span><span style=color:#f07171>inserted</span><span>()</span><span style=color:#61676ccc>,
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/ecs/ target=_blank>Bevy ECS Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/book/ch04-03-slices.html target=_blank>Rust Slice Types</a><li><a rel="noopener nofollow noreferrer" href=https://rust-unofficial.github.io/patterns/patterns/performance/stack-allocated.html target=_blank>Memory Allocation Optimization Patterns</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/pull/20626 target=_blank>Previous PR #20626</a> - Previous optimization this builds upon</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-09/pr_21102.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>