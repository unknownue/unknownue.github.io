<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20890 Fix gizmo near plane clipping bug
        
    </title><meta content="#20890 Fix gizmo near plane clipping bug" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-09/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-09-05</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-09/pr-20890-zh-cn-20250905>中文</a></div></div><div class=pr-content><h1 id=fix-gizmo-near-plane-clipping-bug>Fix gizmo near plane clipping bug</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix gizmo near plane clipping bug<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20890<li><strong>Author</strong>: atlv24<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, S-Needs-Review<li><strong>Created</strong>: 2025-09-05T17:17:13Z<li><strong>Merged</strong>: 2025-09-05T20:33:36Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Fixes #19205</ul><h2 id=solution>Solution</h2><ul><li>so it turns out a wrong optimization got made at some point, where a division by w was avoided by multiplying both sides of an inequality by w. This is wrong, because w can be negative, which should flip the inequality.<li>So instead, we document what it should be doing, which is computing the depth values and comparing to near plane, and then avoid the divison in a sign-aware way using sign and abs.</ul><h2 id=testing>Testing</h2><ul><li>slightly tweaked repro by anthony in #20773<li>3d_gizmos works as expected</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a specific bug in Bevy’s gizmo rendering system where near plane clipping was incorrectly handled. The issue manifested when gizmos would disappear or render incorrectly when positioned near the camera’s near clipping plane.<p>The core problem was in the WGSL shader code for the <code>clip_near_plane</code> function. The original implementation attempted to optimize out division operations by multiplying both sides of an inequality by the w component. While mathematically sound for positive values, this approach fails when w is negative, as the inequality direction should flip in such cases but doesn’t.<p>The solution replaces the flawed optimization with a more robust approach that uses sign-aware comparisons. Instead of directly comparing <code>a.z > a.w</code>, the new implementation uses <code>a.z * sign(a.w) > abs(a.w)</code>, which correctly handles both positive and negative w values without requiring division operations. This maintains the performance benefit of avoiding division while ensuring mathematical correctness.<p>The fix is minimal and surgical - it only modifies the conditional check in the clipping function while preserving the actual interpolation logic, which was already correct. The updated code also includes better documentation explaining what the comparison is actually trying to achieve (checking if the depth value exceeds the near plane limit).<p>Testing confirmed the fix resolves the issue using a modified version of the original reproduction case, and the standard 3d_gizmos example continues to work as expected.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[Gizmo Vertex Shader] --> B[clip_near_plane function]
</span><span>    B --> C[Conditional Check]
</span><span>    C --> D[Correct Near Plane Clipping]
</span><span>    C --> E[Incorrect Clipping Behavior]
</span><span>    
</span><span>    style E fill:#f96
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>crates/bevy_gizmos/src/lines.wgsl</strong> (+3/-2)<p>This file contains the WGSL shader code for gizmo line rendering. The changes fix the mathematical error in the near plane clipping logic.<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>if a.z > a.w && b.z <= b.w {
</span><span>
</span><span>// After:
</span><span>// equivalent to `a.z / a.w > 1.0 && b.z / b.w <= 1.0` but avoids divs
</span><span>if a.z * sign(a.w) > abs(a.w) && b.z * sign(b.w) <= abs(b.w) {
</span></code></pre><p>The key change replaces the simple comparison with a sign-aware comparison that correctly handles negative w values while still avoiding division operations for performance.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://www.w3.org/TR/WGSL/ target=_blank>WGSL Language Specification</a> - Official WebGPU Shading Language documentation<li><a rel="noopener nofollow noreferrer" href=https://www.scratchapixel.com/lessons/3d-basic-rendering/perspective-and-orthographic-projection-matrix/ target=_blank>Perspective Projection and Homogeneous Coordinates</a> - Explanation of homogeneous coordinates and perspective division<li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/gizmos/ target=_blank>Bevy Gizmos Documentation</a> - Official Bevy gizmo system documentation</ul><h1 id=full-code-diff>Full Code Diff</h1><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_gizmos/src/lines.wgsl b/crates/bevy_gizmos/src/lines.wgsl
</span><span>index 1181e3f59cdb8..cf6d5c1db7b4d 100644
</span><span style=color:#c594c5>--- a/crates/bevy_gizmos/src/lines.wgsl
</span><span style=color:#c594c5>+++ b/crates/bevy_gizmos/src/lines.wgsl
</span><span style=color:#c594c5>@@ -136,8 +136,9 @@ </span><span style=color:#399ee6>fn vertex(vertex: VertexInput) -> VertexOutput {
</span><span> }
</span><span> 
</span><span> fn clip_near_plane(a: vec4&LTf32>, b: vec4&LTf32>) -> vec4&LTf32> {
</span><span style=color:#f07171>-    // Move a if a is behind the near plane and b is in front. 
</span><span style=color:#f07171>-    if a.z > a.w && b.z <= b.w {
</span><span style=color:#86b300>+    // Move a if a is behind the near plane and b is in front.
</span><span style=color:#86b300>+    // equivalent to `a.z / a.w > 1.0 && b.z / b.w <= 1.0` but avoids divs
</span><span style=color:#86b300>+    if a.z * sign(a.w) > abs(a.w) && b.z * sign(b.w) <= abs(b.w) {
</span><span>         // Interpolate a towards b until it's at the near plane.
</span><span>         let distance_a = a.z - a.w;
</span><span>         let distance_b = b.z - b.w;
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-09/pr_20890.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>