<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20689 Ensure systems passed to `Combine` cannot be called re-entrantly either
        
    </title><meta content="#20689 Ensure systems passed to `Combine` cannot be called re-entrantly either" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-09/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-09-01</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-09/pr-20689-zh-cn-20250901>中文</a></div></div><div class=pr-content><h1 id=ensure-systems-passed-to-combine-cannot-be-called-re-entrantly-either>Ensure systems passed to <code>Combine</code> cannot be called re-entrantly either</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Ensure systems passed to <code>Combine</code> cannot be called re-entrantly either<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20689<li><strong>Author</strong>: SkiFire13<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-ECS, S-Ready-For-Final-Review, D-Complex, P-Unsound, D-Unsafe<li><strong>Created</strong>: 2025-08-21T07:09:49Z<li><strong>Merged</strong>: 2025-09-01T23:15:13Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Fix #14709</ul><h2 id=solution>Solution</h2><ul><li>Add an extra parameter to <code>Combine::combine</code> of a generic type <code>T</code>, which ensures only one of the two closures can be called at any given time, including re-entrantly.</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a critical soundness issue in Bevy’s ECS system combinators. The problem was that systems using the <code>Combine</code> trait could potentially be called re-entrantly, leading to undefined behavior and memory safety violations.<p>The core issue was in the <code>Combine::combine</code> method signature, which accepted two closures that could theoretically be called multiple times or in overlapping ways. This created a potential scenario where systems could access world data in unsafe ways, violating Rust’s ownership rules.<p>The solution introduces a generic type parameter <code>T</code> to the <code>combine</code> method, which acts as a guard to prevent re-entrant calls. By requiring a mutable reference to this type, the compiler ensures that only one closure can be executed at a time, as Rust’s borrow checker prevents multiple mutable references to the same data.<p>The implementation modifies both the <code>Combine</code> trait definition and all its implementations in the condition system. Each implementation now accepts an additional <code>data: &mut T</code> parameter and passes it to the closure calls. This change maintains the same logical behavior while adding the necessary safety guarantees.<p>In the combinator implementation, a private type <code>PrivateUnsafeWorldCell</code> is used to ensure that the world cell cannot be accessed from outside the intended scope. This prevents malicious or accidental re-entrant calls by making it impossible to create another instance of the guard type.<p>The changes are minimal and focused, affecting only the necessary parts of the codebase while maintaining backward compatibility for users of the public API. The migration guide provides clear instructions for any custom implementations of the <code>Combine</code> trait.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Combine Trait] --> B[combine method]
</span><span>    B --> C[Closure A]
</span><span>    B --> D[Closure B]
</span><span>    C --> E[System Execution]
</span><span>    D --> E
</span><span>    F[Generic Type T] --> B
</span><span>    F --> C
</span><span>    F --> D
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ecs-src-system-combinator-rs-20-13><code>crates/bevy_ecs/src/system/combinator.rs</code> (+20/-13)</h3><p>This file contains the core <code>Combine</code> trait definition and its implementation for combined systems. The changes modify the trait method signature to include the generic guard type.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>combine</span><span>(
</span><span>    </span><span style=color:#ff8f40>input</span><span style=color:#61676ccc>: </span><span><</span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>In </span><span style=color:#ed9366>as</span><span> SystemInput></span><span style=color:#ed9366>::</span><span>Inner<'</span><span style=color:#ed9366>_</span><span>>,
</span><span>    </span><span style=color:#ff8f40>a</span><span style=color:#61676ccc>:</span><span> impl FnOnce(</span><span style=color:#ff8f40>SystemIn</span><span><'_</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>A</span><span>>) -> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><</span><span style=color:#fa6e32>A</span><span style=color:#ed9366>::</span><span>Out, RunSystemError>,
</span><span>    </span><span style=color:#ff8f40>b</span><span style=color:#61676ccc>:</span><span> impl FnOnce(</span><span style=color:#ff8f40>SystemIn</span><span><'_</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>B</span><span>>) -> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><</span><span style=color:#fa6e32>B</span><span style=color:#ed9366>::</span><span>Out, RunSystemError>,
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><</span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Out, RunSystemError></span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>combine</span><span>&LTT>(
</span><span>    </span><span style=color:#ff8f40>input</span><span style=color:#61676ccc>: </span><span><</span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>In </span><span style=color:#ed9366>as</span><span> SystemInput></span><span style=color:#ed9366>::</span><span>Inner<'</span><span style=color:#ed9366>_</span><span>>,
</span><span>    </span><span style=color:#ff8f40>data</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> T,
</span><span>    </span><span style=color:#ff8f40>a</span><span style=color:#61676ccc>:</span><span> impl FnOnce(</span><span style=color:#ff8f40>SystemIn</span><span><'_</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>A</span><span>></span><span style=color:#61676ccc>,</span><span> &</span><span style=color:#ff8f40>mut T</span><span>) -> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><</span><span style=color:#fa6e32>A</span><span style=color:#ed9366>::</span><span>Out, RunSystemError>,
</span><span>    </span><span style=color:#ff8f40>b</span><span style=color:#61676ccc>:</span><span> impl FnOnce(</span><span style=color:#ff8f40>SystemIn</span><span><'_</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>B</span><span>></span><span style=color:#61676ccc>,</span><span> &</span><span style=color:#ff8f40>mut T</span><span>) -> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><</span><span style=color:#fa6e32>B</span><span style=color:#ed9366>::</span><span>Out, RunSystemError>,
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><</span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Out, RunSystemError></span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-ecs-src-schedule-condition-rs-30-24><code>crates/bevy_ecs/src/schedule/condition.rs</code> (+30/-24)</h3><p>This file contains implementations of <code>Combine</code> for various logical operators (AND, OR, XOR, etc.). Each implementation was updated to include the new parameter and pass it to the closure calls.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Example for And combination:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>combine</span><span>&LTT>(
</span><span>    </span><span style=color:#ff8f40>input</span><span style=color:#61676ccc>: </span><span><</span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>In </span><span style=color:#ed9366>as</span><span> SystemInput></span><span style=color:#ed9366>::</span><span>Inner<'</span><span style=color:#ed9366>_</span><span>>,
</span><span>    </span><span style=color:#ff8f40>data</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> T,
</span><span>    </span><span style=color:#ff8f40>a</span><span style=color:#61676ccc>:</span><span> impl FnOnce(</span><span style=color:#ff8f40>SystemIn</span><span><'_</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>A</span><span>></span><span style=color:#61676ccc>,</span><span> &</span><span style=color:#ff8f40>mut T</span><span>) -> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><</span><span style=color:#fa6e32>A</span><span style=color:#ed9366>::</span><span>Out, RunSystemError>,
</span><span>    </span><span style=color:#ff8f40>b</span><span style=color:#61676ccc>:</span><span> impl FnOnce(</span><span style=color:#ff8f40>SystemIn</span><span><'_</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>A</span><span>></span><span style=color:#61676ccc>,</span><span> &</span><span style=color:#ff8f40>mut T</span><span>) -> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><</span><span style=color:#fa6e32>B</span><span style=color:#ed9366>::</span><span>Out, RunSystemError>,
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><</span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Out, RunSystemError> {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(</span><span style=color:#f07171>a</span><span>(input</span><span style=color:#61676ccc>,</span><span> data)</span><span style=color:#ed9366>? && </span><span style=color:#f07171>b</span><span>(input</span><span style=color:#61676ccc>,</span><span> data)</span><span style=color:#ed9366>?</span><span>)
</span><span>}
</span></code></pre><h3 id=release-content-migration-guides-combine-soundness-fix-md-6-0><code>release-content/migration-guides/combine_soundness_fix.md</code> (+6/-0)</h3><p>This new file provides migration guidance for the change, explaining that the <code>Combine::combine</code> method now takes an extra parameter that needs to be passed to the closures.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/book/ch04-00-understanding-ownership.html target=_blank>Rust Ownership and Borrowing</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/advanced-topics/system-combinators/ target=_blank>Bevy ECS System Combinators</a><li><a rel="noopener nofollow noreferrer" href=https://rust-lang.github.io/unsafe-code-guidelines/ target=_blank>Unsafe Code Guidelines</a></ul><h2 id=full-code-diff>Full Code Diff</h2><p>[See provided diff in original request]</div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-09/pr_20689.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>