<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21102 Combine added and existing `ComponentId`s in a single allocation
        
    </title><meta content="#21102 Combine added and existing `ComponentId`s in a single allocation" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-09/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-09-18</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2025-09/pr-21102-en-20250918>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=combine-added-and-existing-componentids-in-a-single-allocation>Combine added and existing <code>ComponentId</code>s in a single allocation</h1><h2 id=ji-ben-xin-xi>基本信息</h2><ul><li><strong>标题</strong>: Combine added and existing <code>ComponentId</code>s in a single allocation<li><strong>PR链接</strong>: https://github.com/bevyengine/bevy/pull/21102<li><strong>作者</strong>: chescock<li><strong>状态</strong>: 已合并<li><strong>标签</strong>: A-ECS, C-Performance, S-Ready-For-Final-Review<li><strong>创建时间</strong>: 2025-09-17T14:48:50Z<li><strong>合并时间</strong>: 2025-09-18T04:27:30Z<li><strong>合并者</strong>: alice-i-cecile</ul><h2 id=miao-shu-fan-yi>描述翻译</h2><h3 id=mu-biao>目标</h3><p>在 #20626 的基础上进一步缩小 <code>ArchetypeAfterBundleInsert</code> 的大小。<p>移除触发 <code>Insert</code> 观察器时对 <code>collect()</code> 的需求。<h3 id=jie-jue-fang-an>解决方案</h3><p>将 <code>added</code> 和 <code>existing</code> 组件ID列表合并为一个装箱的切片（boxed slice）。我们需要存储一个额外的长度来恢复切片，但这意味着我们存储<strong>一个</strong>指针和两个长度，而不是<strong>两个</strong>指针和两个长度，从而将 <code>ArchetypeAfterBundleInsert</code> 的大小缩小一个指针。<p>这也意味着我们有一个完整的 <code>inserted</code> 组件列表切片可用，无需将它们复制到新的 <code>Vec</code> 中。<h2 id=ben-ci-prde-gu-shi>本次PR的故事</h2><p>这个PR是在#20626基础上的进一步性能优化，主要针对ECS（Entity Component System）中的bundle插入操作。问题核心在于内存布局和访问效率的优化。<h3 id=wen-ti-bei-jing>问题背景</h3><p>在Bevy的ECS架构中，当插入一个bundle时，系统需要跟踪哪些组件是新添加的（added），哪些是已存在的（existing）。原来的实现使用了两个独立的<code>Box<[ComponentId]></code>来分别存储这两类组件ID：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) added</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Box</span><span><[ComponentId]></span><span style=color:#61676ccc>,
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) existing</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Box</span><span><[ComponentId]></span><span style=color:#61676ccc>,
</span></code></pre><p>这种设计存在两个问题：<ol><li>内存开销：每个<code>Box</code>都需要一个指针，总共两个指针的开销<li>性能开销：当需要访问所有插入的组件（包括新增和已存在的）时，需要执行<code>.chain()</code>操作，并且在某些情况下还需要<code>.collect()</code>到新的Vec中</ol><h3 id=jie-jue-fang-an-1>解决方案</h3><p>PR作者采用了内存优化的常见模式：将逻辑上相关的数据存储在连续的内存区域中，通过额外的元数据来区分不同部分。具体来说：<ol><li>将<code>added</code>和<code>existing</code>数组合并为一个<code>inserted</code>数组<li>添加<code>added_len</code>字段来记录added组件的数量<li>通过切片操作来访问added和existing部分</ol><h3 id=ju-ti-shi-xian>具体实现</h3><p>在<code>archetype.rs</code>中，关键的数据结构变更：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 之前：
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) added</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Box</span><span><[ComponentId]></span><span style=color:#61676ccc>,
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) existing</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Box</span><span><[ComponentId]></span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 之后：
</span><span>inserted</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Box</span><span><[ComponentId]></span><span style=color:#61676ccc>,
</span><span>added_len</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize</span><span style=color:#61676ccc>,
</span></code></pre><p>相应的访问方法也进行了重构：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>inserted</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span>[ComponentId] {
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>inserted
</span><span>}
</span><span>
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>added</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span>[ComponentId] {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// SAFETY: `added_len` is always in range `0..=inserted.len()`
</span><span>    </span><span style=color:#fa6e32>unsafe </span><span>{ </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>inserted</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#ed9366>..</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>added_len)</span><span style=color:#ed9366>.</span><span style=color:#f07171>debug_checked_unwrap</span><span>() }
</span><span>}
</span><span>
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>existing</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span>[ComponentId] {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// SAFETY: `added_len` is always in range `0..=inserted.len()`
</span><span>    </span><span style=color:#fa6e32>unsafe </span><span>{ </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>inserted</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>added_len</span><span style=color:#ed9366>..</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>debug_checked_unwrap</span><span>() }
</span><span>}
</span></code></pre><p>在<code>insert.rs</code>中的构建逻辑也相应调整：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 之前使用两个独立的Box
</span><span style=color:#fa6e32>let</span><span> added</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Box</span><span><[ComponentId]> </span><span style=color:#ed9366>= ...</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> existing</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Box</span><span><[ComponentId]> </span><span style=color:#ed9366>= ...</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 现在合并为一个
</span><span style=color:#fa6e32>let</span><span> added_len </span><span style=color:#ed9366>=</span><span> added</span><span style=color:#ed9366>.</span><span style=color:#f07171>len</span><span>()</span><span style=color:#61676ccc>;
</span><span>added</span><span style=color:#ed9366>.</span><span style=color:#f07171>reserve_exact</span><span>(existing</span><span style=color:#ed9366>.</span><span style=color:#f07171>len</span><span>())</span><span style=color:#61676ccc>;
</span><span>added</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend</span><span>(existing)</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> inserted </span><span style=color:#ed9366>=</span><span> added</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=ji-shu-xi-jie-yu-kao-liang>技术细节与考量</h3><ol><li><strong>内存布局优化</strong>：从两个指针减少到一个指针，在64位系统上节省了8字节内存<li><strong>访问性能</strong>：现在可以直接获取完整的inserted组件切片，无需链式迭代器或collect操作<li><strong>安全性</strong>：使用<code>debug_checked_unwrap</code>来确保切片访问的安全性，在debug构建中提供额外检查<li><strong>内存分配</strong>：通过<code>reserve_exact</code>确保不会分配多余内存，避免后续转换为Box时的重复分配</ol><h3 id=ying-xiang-yu-shou-yi>影响与收益</h3><p>这个优化带来了多重好处：<ol><li><strong>内存使用减少</strong>：每个ArchetypeAfterBundleInsert实例节省一个指针的大小<li><strong>性能提升</strong>：消除了触发Insert观察器时的collect操作<li><strong>代码简化</strong>：提供了更直接的API来访问不同类别的组件<li><strong>缓存友好</strong>：相关数据现在存储在连续内存中，提高了缓存局部性</ol><p>对于大规模实体系统，这些优化可以累积产生显著的性能提升，特别是在频繁进行bundle插入操作的场景中。<h2 id=ke-shi-hua-biao-shi>可视化表示</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[ArchetypeAfterBundleInsert] --> B[inserted: Box&LTComponentId>]
</span><span>    A --> C[added_len: usize]
</span><span>    B --> D[added组件部分]
</span><span>    B --> E[existing组件部分]
</span><span>    C -->|确定分界点| D
</span></code></pre><h2 id=guan-jian-wen-jian-bian-geng>关键文件变更</h2><h3 id=crates-bevy-ecs-src-archetype-rs-23-15><code>crates/bevy_ecs/src/archetype.rs</code> (+23/-15)</h3><p>这个文件包含了主要的架构变更，重新定义了<code>ArchetypeAfterBundleInsert</code>结构体的内存布局。<p><strong>关键变更：</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 之前：
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) added</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Box</span><span><[ComponentId]></span><span style=color:#61676ccc>,
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) existing</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Box</span><span><[ComponentId]></span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 之后：
</span><span>inserted</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Box</span><span><[ComponentId]></span><span style=color:#61676ccc>,
</span><span>added_len</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize</span><span style=color:#61676ccc>,
</span></code></pre><p>同时添加了新的访问方法：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>inserted</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span>[ComponentId] {
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>inserted
</span><span>}
</span><span>
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>added</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span>[ComponentId] {
</span><span>    </span><span style=color:#fa6e32>unsafe </span><span>{ </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>inserted</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#ed9366>..</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>added_len)</span><span style=color:#ed9366>.</span><span style=color:#f07171>debug_checked_unwrap</span><span>() }
</span><span>}
</span><span>
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>existing</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span>[ComponentId] {
</span><span>    </span><span style=color:#fa6e32>unsafe </span><span>{ </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>inserted</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>added_len</span><span style=color:#ed9366>..</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>debug_checked_unwrap</span><span>() }
</span><span>}
</span></code></pre><h3 id=crates-bevy-ecs-src-bundle-insert-rs-8-12><code>crates/bevy_ecs/src/bundle/insert.rs</code> (+8/-12)</h3><p>这个文件更新了bundle插入逻辑以适应新的数据结构。<p><strong>关键变更：</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 构建逻辑变更：
</span><span style=color:#fa6e32>let</span><span> added_len </span><span style=color:#ed9366>=</span><span> added</span><span style=color:#ed9366>.</span><span style=color:#f07171>len</span><span>()</span><span style=color:#61676ccc>;
</span><span>added</span><span style=color:#ed9366>.</span><span style=color:#f07171>reserve_exact</span><span>(existing</span><span style=color:#ed9366>.</span><span style=color:#f07171>len</span><span>())</span><span style=color:#61676ccc>;
</span><span>added</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend</span><span>(existing)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 使用新的访问方法：
</span><span>components</span><span style=color:#61676ccc>:</span><span> archetype_after_insert</span><span style=color:#ed9366>.</span><span style=color:#f07171>added</span><span>()</span><span style=color:#61676ccc>,
</span><span>components</span><span style=color:#61676ccc>:</span><span> archetype_after_insert</span><span style=color:#ed9366>.</span><span style=color:#f07171>existing</span><span>()</span><span style=color:#61676ccc>,
</span><span>components</span><span style=color:#61676ccc>:</span><span> archetype_after_insert</span><span style=color:#ed9366>.</span><span style=color:#f07171>inserted</span><span>()</span><span style=color:#61676ccc>,
</span></code></pre><p>移除了不必要的collect操作：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 之前需要collect：
</span><span>components</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>archetype_after_insert</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter_inserted</span><span>()</span><span style=color:#ed9366>.</span><span>collect</span><span style=color:#ed9366>::</span><span><</span><span style=color:#55b4d4;font-style:italic>Vec</span><span><</span><span style=color:#ed9366>_</span><span>>>()</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 现在直接访问：
</span><span>components</span><span style=color:#61676ccc>:</span><span> archetype_after_insert</span><span style=color:#ed9366>.</span><span style=color:#f07171>inserted</span><span>()</span><span style=color:#61676ccc>,
</span></code></pre><h2 id=kuo-zhan-yue-du>扩展阅读</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/ecs/ target=_blank>Bevy ECS官方文档</a> - 了解Bevy的ECS架构<li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/book/ch04-03-slices.html target=_blank>Rust切片操作指南</a> - 掌握Rust切片的高效使用<li><a rel="noopener nofollow noreferrer" href=https://rust-lang.github.io/rust-clippy/master/index.html#/ target=_blank>内存布局优化技巧</a> - Rust性能优化实践<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/pull/20626 target=_blank>PR #20626</a> - 本次优化所基于的前序工作</ol><h2 id=wan-zheng-dai-ma-chai-yi>完整代码差异</h2><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_ecs/src/archetype.rs b/crates/bevy_ecs/src/archetype.rs
</span><span>index c6fa3dc81dd53..e7eddb06e7e89 100644
</span><span style=color:#c594c5>--- a/crates/bevy_ecs/src/archetype.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_ecs/src/archetype.rs
</span><span style=color:#c594c5>@@ -25,6 +25,7 @@ </span><span style=color:#399ee6>use crate::{
</span><span>     entity::{Entity, EntityLocation},
</span><span>     event::Event,
</span><span>     observer::Observers,
</span><span style=color:#86b300>+    query::DebugCheckedUnwrap,
</span><span>     storage::{ImmutableSparseSet, SparseArray, SparseSet, TableId, TableRow},
</span><span> };
</span><span> use alloc::{boxed::Box, vec::Vec};
</span><span style=color:#c594c5>@@ -142,24 +143,27 @@ </span><span style=color:#399ee6>pub(crate) struct ArchetypeAfterBundleInsert {
</span><span>     ///
</span><span>     /// The initial values are determined based on the provided constructor, falling back to the `Default` trait if none is given.
</span><span>     pub required_components: Box<[RequiredComponentConstructor]>,
</span><span style=color:#f07171>-    /// The components added by this bundle. This includes any Required Components that are inserted when adding this bundle.
</span><span style=color:#f07171>-    pub(crate) added: Box<[ComponentId]>,
</span><span style=color:#f07171>-    /// The components that were explicitly contributed by this bundle, but already existed in the archetype. This _does not_ include any
</span><span style=color:#f07171>-    /// Required Components.
</span><span style=color:#f07171>-    pub(crate) existing: Box<[ComponentId]>,
</span><span style=color:#86b300>+    /// The components inserted by this bundle, with added components before existing ones.
</span><span style=color:#86b300>+    /// Added components includes any Required Components that are inserted when adding this bundle,
</span><span style=color:#86b300>+    /// but existing components only includes ones explicitly contributed by this bundle.
</span><span style=color:#86b300>+    inserted: Box<[ComponentId]>,
</span><span style=color:#86b300>+    /// The number of components added by this bundle, including Required Components.
</span><span style=color:#86b300>+    added_len: usize,
</span><span> }
</span><span> 
</span><span> impl ArchetypeAfterBundleInsert {
</span><span style=color:#f07171>-    pub(crate) fn iter_inserted(&self) -> impl Iterator&LTItem = ComponentId> + Clone + '_ {
</span><span style=color:#f07171>-        self.added.iter().chain(self.existing.iter()).copied()
</span><span style=color:#86b300>+    pub(crate) fn inserted(&self) -> &[ComponentId] {
</span><span style=color:#86b300>+        &self.inserted
</span><span>     }
</span><span> 
</span><span style=color:#f07171>-    pub(crate) fn iter_added(&self) -> impl Iterator&LTItem = ComponentId> + Clone + '_ {
</span><span style=color:#f07171>-        self.added.iter().copied()
</span><span style=color:#86b300>+    pub(crate) fn added(&self) -> &[ComponentId] {
</span><span style=color:#86b300>+        // SAFETY: `added_len` is always in range `0..=inserted.len()`
</span><span style=color:#86b300>+        unsafe { self.inserted.get(..self.added_len).debug_checked_unwrap() }
</span><span>     }
</span><span> 
</span><span style=color:#f07171>-    pub(crate) fn iter_existing(&self) -> impl Iterator&LTItem = ComponentId> + Clone + '_ {
</span><span style=color:#f07171>-        self.existing.iter().copied()
</span><span style=color:#86b300>+    pub(crate) fn existing(&self) -> &[ComponentId] {
</span><span style=color:#86b300>+        // SAFETY: `added_len` is always in range `0..=inserted.len()`
</span><span style=color:#86b300>+        unsafe { self.inserted.get(self.added_len..).debug_checked_unwrap() }
</span><span>     }
</span><span> }
</span><span> 
</span><span style=color:#c594c5>@@ -244,17 +248,21 @@ </span><span style=color:#399ee6>impl Edges {
</span><span>         archetype_id: ArchetypeId,
</span><span>         bundle_status: impl Into&LTBox<[ComponentStatus]>>,
</span><span>         required_components: impl Into&LTBox<[RequiredComponentConstructor]>>,
</span><span style=color:#f07171>-        added: impl Into&LTBox<[ComponentId]>>,
</span><span style=color:#f07171>-        existing: impl Into&LTBox<[ComponentId]>>,
</span><span style=color:#86b300>+        mut added: Vec&LTComponentId>,
</span><span style=color:#86b300>+        existing: Vec&LTComponentId>,
</span><span>     ) {
</span><span style=color:#86b300>+        let added_len = added.len();
</span><span style=color:#86b300>+        // Make sure `extend` doesn't over-reserve, since the conversion to `Box<[_]>` would reallocate to shrink.
</span><span style=color:#86b300>+        added.reserve_exact(existing.len());
</span><span style=color:#86b300>+        added.extend(existing);
</span><span>         self.insert_bundle.insert(
</span><span>             bundle_id,
</span><span>             ArchetypeAfterBundleInsert {
</span><span>                 archetype_id,
</span><span>                 bundle_status: bundle_status.into(),
</span><span>                 required_components: required_components.into(),
</span><span style=color:#f07171>-                added: added.into(),
</span><span style=color:#f07171>-                existing: existing.into(),
</span><span style=color:#86b300>+                added_len,
</span><span style=color:#86b300>+                inserted: added.into(),
</span><span>             },
</span><span>         );
</span><span>     }
</span><span>diff --git a/crates/bevy_ecs/src/bundle/insert.rs b/crates/bevy_ecs/src/bundle/insert.rs
</span><span>index 86a356291ce55..d305de386bf1d 100644
</span><span style=color:#c594c5>--- a/crates/bevy_ecs/src/bundle/insert.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_ecs/src/bundle/insert.rs
</span><span style=color:#c594c5>@@ -167,7 +167,7 @@ </span><span style=color:#399ee6>impl<'w> BundleInserter<'w> {
</span><span>                         REPLACE,
</span><span>                         &mut Replace { entity },
</span><span>                         &mut EntityComponentsTrigger {
</span><span style=color:#f07171>-                            components: &archetype_after_insert.existing,
</span><span style=color:#86b300>+                            components: archetype_after_insert.existing(),
</span><span>                         },
</span><span>                         caller,
</span><span>                     );
</span><span style=color:#c594c5>@@ -175,7 +175,7 @@ </span><span style=color:#399ee6>impl<'w> BundleInserter<'w> {
</span><span>                 deferred_world.trigger_on_replace(
</span><span>                     archetype,
</span><span>                     entity,
</span><span style=color:#f07171>-                    archetype_after_insert.iter_existing(),
</span><span style=color:#86b300>+                    archetype_after_insert.existing().iter().copied(),
</span><span>                     caller,
</span><span>                     relationship_hook_mode,
</span><span>                 );
</span><span style=color:#c594c5>@@ -346,7 +346,7 @@ </span><span style=color:#399ee6>impl<'w> BundleInserter<'w> {
</span><span>             deferred_world.trigger_on_add(
</span><span>                 new_archetype,
</span><span>                 entity,
</span><span style=color:#f07171>-                archetype_after_insert.iter_added(),
</span><span style=color:#86b300>+                archetype_after_insert.added().iter().copied(),
</span><span>                 caller,
</span><span>             );
</span><span>             if new_archetype.has_add_observer() {
</span><span style=color:#c594c5>@@ -355,7 +355,7 @@ </span><span style=color:#399ee6>impl<'w> BundleInserter<'w> {
</span><span>                     ADD,
</span><span>                     &mut Add { entity },
</span><span>                     &mut EntityComponentsTrigger {
</span><span style=color:#f07171>-                        components: &archetype_after_insert.added,
</span><span style=color:#86b300>+                        components: archetype_after_insert.added(),
</span><span>                     },
</span><span>                     caller,
</span><span>                 );
</span><span style=color:#c594c5>@@ -366,7 +366,7 @@ </span><span style=color:#399ee6>impl<'w> BundleInserter<'w> {
</span><span>                     deferred_world.trigger_on_insert(
</span><span>                         new_archetype,
</span><span>                         entity,
</span><span style=color:#f07171>-                        archetype_after_insert.iter_inserted(),
</span><span style=color:#86b300>+                        archetype_after_insert.inserted().iter().copied(),
</span><span>                         caller,
</span><span>                         relationship_hook_mode,
</span><span>                     );
</span><span style=color:#c594c5>@@ -375,12 +375,8 @@ </span><span style=color:#399ee6>impl<'w> BundleInserter<'w> {
</span><span>                         deferred_world.trigger_raw(
</span><span>                             INSERT,
</span><span>                             &mut Insert { entity },
</span><span style=color:#f07171>-                            // PERF: this is not a regression from what we were doing before, but ideally we don't
</span><span style=color:#f07171>-                            // need to collect here
</span><span>                             &mut EntityComponentsTrigger {
</span><span style=color:#f07171>-                                components: &archetype_after_insert
</span><span style=color:#f07171>-                                    .iter_inserted()
</span><span style=color:#f07171>-                                    .collect::&LTVec<_>>(),
</span><span style=color:#86b300>+                                components: archetype_after_insert.inserted(),
</span><span>                             },
</span><span>                             caller,
</span><span>                         );
</span><span style=color:#c594c5>@@ -392,7 +388,7 @@ </span><span style=color:#399ee6>impl<'w> BundleInserter<'w> {
</span><span>                     deferred_world.trigger_on_insert(
</span><span>                         new_archetype,
</span><span>                         entity,
</span><span style=color:#f07171>-                        archetype_after_insert.iter_added(),
</span><span style=color:#86b300>+                        archetype_after_insert.added().iter().copied(),
</span><span>                         caller,
</span><span>                         relationship_hook_mode,
</span><span>                     );
</span><span style=color:#c594c5>@@ -402,7 +398,7 @@ </span><span style=color:#399ee6>impl<'w> BundleInserter<'w> {
</span><span>                             INSERT,
</span><span>                             &mut Insert { entity },
</span><span>                             &mut EntityComponentsTrigger {
</span><span style=color:#f07171>-                                components: &archetype_after_insert.added,
</span><span style=color:#86b300>+                                components: archetype_after_insert.added(),
</span><span>                             },
</span><span>                             caller,
</span><span>                         );
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-09/pr_21102.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>