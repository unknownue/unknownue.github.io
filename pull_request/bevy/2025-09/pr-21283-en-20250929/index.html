<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21283 Fix https / http asset loader on WASM
        
    </title><meta content="#21283 Fix https / http asset loader on WASM" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-09/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-09-29</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-09/pr-21283-zh-cn-20250929>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix https / http asset loader on WASM<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21283<li><strong>Author</strong>: alice-i-cecile<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, C-Examples, A-Assets, D-Straightforward, S-Needs-Review<li><strong>Created</strong>: 2025-09-29T20:45:54Z<li><strong>Merged</strong>: 2025-09-29T21:53:12Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Our <code>web_asset</code> example does not build on Wasm. Ironic.<p>As reported in #21280, there are a few problems:<ol><li>Imports are broken: one hard error and a few warnings.<li><code>HttpWasmAssetReader</code> needs a <code>+ use<'></code> to conform to the Rust 2024 edition (unreported, but discovered)<li>We’re returning a reference to a temporary value, which is ultimately caused by 2</ol><h2 id=solution>Solution</h2><ol><li>Move the imports into the correct feature-gated block.<li>Slap some <code>+ use<'></code> on the function definition like the compiler told me to. This fixes the “returning a reference to a temporary value” problem, as we’re no longer implicitly capturing.</ol><p>Fixes #21280.<p>Special thanks to @kristoff3r for pointing out my mistake!<h2 id=testing>Testing</h2><p>I’ve tested this PR using <code>bevy run --features https --example web_asset web</code> via the bevy_cli. Because of changes to <code>getrandom</code>, this was non-trivial to build for web manually.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a critical build failure in Bevy’s WebAssembly (Wasm) asset loading system. The core issue was straightforward but had multiple facets: the <code>web_asset</code> example, which demonstrates HTTP asset loading in web environments, ironically couldn’t build for Wasm targets.<p>The problem manifested in three specific ways. First, import organization was incorrect, causing compilation errors and warnings due to unused imports in Wasm contexts. Second, the <code>HttpWasmAssetReader::fetch_bytes</code> method needed explicit lifetime capture annotations to comply with Rust 2024 edition requirements. Third, this missing annotation was causing a more subtle issue where the function was returning references to temporary values.<p>The solution involved two targeted fixes. For the import issues, the imports were moved into the appropriate conditional compilation blocks. The <code>ToOwned</code> import and <code>blocking::unblock</code> were only needed for non-Wasm targets, so they were relocated from the module’s top-level imports into the <code>#[cfg(not(target_arch = "wasm32"))]</code> block where they’re actually used.<p>The more interesting technical change was in the <code>fetch_bytes</code> method signature. The original implementation used <code>Result&LTimpl Reader, AssetReaderError></code> but needed to be updated to <code>Result&LTimpl Reader + use<>, AssetReaderError></code>. This <code>+ use<></code> syntax is a Rust 2024 edition feature that enables explicit lifetime capture in <code>impl Trait</code> return types. Without this annotation, the compiler was implicitly capturing lifetimes in a way that led to returning references to temporary values, which is undefined behavior.<p>The technical insight here is that Rust’s async functions that return <code>impl Trait</code> need to specify how they capture lifetimes from the function body. The <code>use<></code> annotation tells the compiler that the returned type may capture any lifetime from the function, preventing the implicit capture behavior that was causing the temporary reference issue. This is particularly important in async contexts where the returned future might need to capture references to function parameters or local variables.<p>The impact of these changes is immediate and practical: the <code>web_asset</code> example now builds successfully for Wasm targets, enabling developers to use HTTP/HTTPS asset loading in web deployments. The fixes are minimal and surgical, addressing the root causes without introducing unnecessary complexity or breaking changes.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[WebAsset Example] --> B[Build Failure on Wasm]
</span><span>    B --> C[Import Organization Issues]
</span><span>    B --> D[Missing use<> Annotation]
</span><span>    D --> E[Temporary Reference Bug]
</span><span>    
</span><span>    F[Solution] --> G[Move Imports to cfg blocks]
</span><span>    F --> H[Add + use<> to fetch_bytes]
</span><span>    H --> I[Fix Lifetime Capture]
</span><span>    
</span><span>    G & I --> J[Working Wasm Build]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-asset-src-io-wasm-rs-3-1><code>crates/bevy_asset/src/io/wasm.rs</code> (+3/-1)</h3><p>This file contains the core HTTP asset reading implementation for Wasm targets. The key change was adding the <code>+ use<></code> annotation to fix lifetime capture in async functions.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) async </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>fetch_bytes</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>path</span><span style=color:#61676ccc>:</span><span> PathBuf) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span>&LTimpl Reader, AssetReaderError> {
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) async </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>fetch_bytes</span><span>(
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>,
</span><span>    </span><span style=color:#ff8f40>path</span><span style=color:#61676ccc>:</span><span> PathBuf,
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span>&LTimpl Reader </span><span style=color:#ed9366>+ </span><span>use<>, AssetReaderError> {
</span></code></pre><p>The <code>+ use<></code> annotation enables explicit lifetime capture, preventing the function from returning references to temporary values.<h3 id=crates-bevy-asset-src-io-web-rs-3-3><code>crates/bevy_asset/src/io/web.rs</code> (+3/-3)</h3><p>This file handles web-specific asset loading. The changes focused on proper import organization through conditional compilation.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before (top-level imports):
</span><span style=color:#fa6e32>use </span><span>alloc</span><span style=color:#ed9366>::</span><span>{borrow</span><span style=color:#ed9366>::</span><span>ToOwned</span><span style=color:#61676ccc>, </span><span>boxed</span><span style=color:#ed9366>::</span><span>Box}</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>use </span><span>blocking</span><span style=color:#ed9366>::</span><span>unblock</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After (moved to conditional block):
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(</span><span style=color:#f29718>not</span><span>(target_arch </span><span style=color:#ed9366>= </span><span style=color:#86b300>"wasm32"</span><span>))]
</span><span>async </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>get</span><span>(</span><span style=color:#ff8f40>path</span><span style=color:#61676ccc>:</span><span> PathBuf) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><</span><span style=color:#55b4d4;font-style:italic>Box</span><span>&LTdyn Reader>, AssetReaderError> {
</span><span>    </span><span style=color:#fa6e32>use </span><span>alloc</span><span style=color:#ed9366>::</span><span>{borrow</span><span style=color:#ed9366>::</span><span>ToOwned</span><span style=color:#61676ccc>, </span><span>boxed</span><span style=color:#ed9366>::</span><span>Box</span><span style=color:#61676ccc>, </span><span>vec</span><span style=color:#ed9366>::</span><span>Vec}</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>use </span><span>blocking</span><span style=color:#ed9366>::</span><span>unblock</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... implementation
</span><span>}
</span></code></pre><p>The imports were moved into the <code>#[cfg(not(target_arch = "wasm32"))]</code> block because they’re only used in non-Wasm contexts, eliminating unused import warnings and errors when building for Wasm targets.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://blog.rust-lang.org/2023/12/28/impl-trait-in-type-alias.html target=_blank>Rust 2024 Edition: <code>use<></code> in return position</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/assets/ target=_blank>Bevy Asset System Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/platforms/wasm/ target=_blank>WebAssembly in Bevy</a><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/reference/conditional-compilation.html target=_blank>Rust Conditional Compilation</a></ul><h1 id=full-code-diff>Full Code Diff</h1><p>diff –git a/crates/bevy_asset/src/io/wasm.rs b/crates/bevy_asset/src/io/wasm.rs index 0dd0ca8e0899d..cd8f66bdf415e 100644 — a/crates/bevy_asset/src/io/wasm.rs +++ b/crates/bevy_asset/src/io/wasm.rs @@ -53,7 +53,10 @@ fn js_value_to_err(context: &str) -> impl FnOnce(JsValue) -> std::io::Error + ’_<p>impl HttpWasmAssetReader { // Also used by <a href=crate::web::WebAssetReader><code>WebAssetReader</code></a><ul><li>pub(crate) async fn fetch_bytes(&self, path: PathBuf) -> Result&LTimpl Reader, AssetReaderError> {</ul><ul><li>pub(crate) async fn fetch_bytes(<li><pre style=color:#61676c;background-color:#fafafa><code><span>   &self,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   path: PathBuf,
</span></code></pre><li>) -> Result&LTimpl Reader + use<>, AssetReaderError> { // The JS global scope includes a self-reference via a specializing name, which can be used to determine the type of global context available. let global: Global = js_sys::global().unchecked_into(); let promise = if !global.window().is_undefined() { diff –git a/crates/bevy_asset/src/io/web.rs b/crates/bevy_asset/src/io/web.rs index 50a261c8ce959..1b079d229a50f 100644 — a/crates/bevy_asset/src/io/web.rs +++ b/crates/bevy_asset/src/io/web.rs @@ -1,10 +1,9 @@ use crate::io::{AssetReader, AssetReaderError, Reader}; use crate::io::{AssetSource, PathStream}; use crate::{AssetApp, AssetPlugin}; -use alloc::{borrow::ToOwned, boxed::Box}; +use alloc::boxed::Box; use bevy_app::{App, Plugin}; use bevy_tasks::ConditionalSendFuture; -use blocking::unblock; use std::path::{Path, PathBuf}; use tracing::warn;</ul><p>@@ -124,8 +123,9 @@ async fn get<’a>(path: PathBuf) -> Result&LTBox<dyn reader>, AssetReaderError> { #[cfg(not(target_arch = “wasm32”))] async fn get(path: PathBuf) -> Result&LTBox<dyn reader>, AssetReaderError> { use crate::io::VecReader; <ul><li>use alloc::{boxed::Box, vec::Vec};</ul> <ul><li><p>use alloc::{borrow::ToOwned, boxed::Box, vec::Vec}; use bevy_platform::sync::LazyLock;</p><li><p>use blocking::unblock; use std::io::{self, BufReader, Read};</p> <p>let str_path = path.to_str().ok_or_else(|| {</p></ul>    <div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-09/pr_21283.patch id=patch-info style=display:none></div>  <div class=bottom-spacer></div> 