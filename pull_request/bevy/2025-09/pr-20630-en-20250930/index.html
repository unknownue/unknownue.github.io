<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20630 Remove parking_lot dependency
        
    </title><meta content="#20630 Remove parking_lot dependency" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-09/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-09-30</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-09/pr-20630-zh-cn-20250930>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>Remove parking_lot dependency<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Remove parking_lot dependency<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20630<li><strong>Author</strong>: james7132<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Assets, C-Dependencies, S-Ready-For-Final-Review, M-Needs-Migration-Guide, X-Uncontroversial, D-Straightforward, D-Macros<li><strong>Created</strong>: 2025-08-18T08:41:13Z<li><strong>Merged</strong>: 2025-09-30T06:49:47Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Spend less time compiling what is already in the standard library. Remove <code>parking_lot</code> from first party crate dependencies. Contribute to https://github.com/bevyengine/bevy/issues/18978. Supercedes #18996.<h2 id=solution>Solution</h2><p>Use <code>bevy_platform::sync</code> types wherever possible. <code>BevyManifest::shared</code> directly returned a mapped guard, but that could be circumvented by just using a scope-like API instead.<p>The crate is still in the dependency tree, transitively, through <code>wgpu</code>, but is now no longer required for any non-rendering crates.<h2 id=testing>Testing</h2><p>Ran tests locally.<p>Co-Authored-By: Zac Harrold <a href=mailto:zac@harrold.com.au>zac@harrold.com.au</a><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a common problem in large Rust projects: dependency bloat and compilation time. The <code>parking_lot</code> crate provides alternative implementations of synchronization primitives like <code>RwLock</code> and <code>Mutex</code>, but the Rust standard library already includes these types. By removing this dependency, the Bevy team aimed to reduce compilation times while maintaining the same functionality.<p>The core challenge was that <code>parking_lot</code> had been integrated throughout Bevy’s codebase, particularly in the asset system and macro utilities. The solution involved systematically replacing <code>parking_lot</code> types with their standard library equivalents, wrapped by Bevy’s <code>bevy_platform::sync</code> abstraction layer. This approach ensured that the code could continue using a unified interface while switching the underlying implementation.<p>One particularly interesting technical challenge was the <code>BevyManifest::shared</code> method, which previously returned a <code>MappedRwLockReadGuard</code> from <code>parking_lot</code>. This pattern couldn’t be directly replicated with the standard library’s <code>RwLock</code>, which doesn’t support mapped guards in the same way. The solution was to change the API to a scope-like pattern where a closure receives access to the manifest, eliminating the need to return a guard altogether.<p>The implementation required careful attention to error handling differences between <code>parking_lot</code> and the standard library. While <code>parking_lot</code> uses non-poisoning locks by default, the standard library’s locks can become poisoned when a thread panics while holding the lock. This necessitated adding explicit poison error handling throughout the codebase.<p>The changes affected multiple systems, but the asset system saw the most significant modifications due to its heavy use of synchronization primitives for managing asset loading and processing. The migration maintained the same performance characteristics while reducing the dependency footprint.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[parking_lot::RwLock] --> B[std::sync::RwLock]
</span><span>    C[parking_lot::Mutex] --> D[std::sync::Mutex]
</span><span>    E[BevyManifest::shared guard] --> F[BevyManifest::shared closure]
</span><span>    
</span><span>    B --> G[bevy_platform::sync::RwLock]
</span><span>    D --> H[bevy_platform::sync::Mutex]
</span><span>    
</span><span>    G --> I[Asset System]
</span><span>    H --> I
</span><span>    F --> J[Macro System]
</span><span>    
</span><span>    I --> K[Reduced Compile Time]
</span><span>    J --> K
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-asset-src-server-mod-rs-82-71><code>crates/bevy_asset/src/server/mod.rs</code> (+82/-71)</h3><p>This file contains the core asset server implementation and saw extensive changes to replace <code>parking_lot</code> locks with standard library equivalents.<p><strong>Key changes:</strong><ul><li>Added helper methods for lock access with poison error handling<li>Replaced direct <code>parking_lot::RwLock</code> access with new helper methods</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> infos </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>data</span><span style=color:#ed9366>.</span><span>infos</span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>read_infos</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span>RwLockReadGuard<'</span><span style=color:#ed9366>_</span><span>, AssetInfos> {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>data
</span><span>        </span><span style=color:#ed9366>.</span><span>infos
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_or_else</span><span>(PoisonError</span><span style=color:#ed9366>::</span><span>into_inner)
</span><span>}
</span><span>
</span><span style=color:#fa6e32>let</span><span> infos </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>read_infos</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-asset-src-io-memory-rs-61-25><code>crates/bevy_asset/src/io/memory.rs</code> (+61/-25)</h3><p>This file implements in-memory asset storage and required updates to its directory and file handling synchronization.<p><strong>Key changes:</strong><ul><li>Added poison error handling for all lock operations<li>Maintained the same logical structure while switching synchronization primitives</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>dir</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0.</span><span style=color:#f07171>write</span><span>()</span><span style=color:#ed9366>.</span><span>assets</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(key</span><span style=color:#61676ccc>,</span><span> data)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>dir</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>write</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_or_else</span><span>(PoisonError</span><span style=color:#ed9366>::</span><span>into_inner)
</span><span>    </span><span style=color:#ed9366>.</span><span>assets
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(key</span><span style=color:#61676ccc>,</span><span> data)</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-encase-derive-src-lib-rs-21-20><code>crates/bevy_encase_derive/src/lib.rs</code> (+21/-20)</h3><p>This derive macro crate updated its <code>BevyManifest</code> usage to the new closure-based API.<p><strong>Key changes:</strong><ul><li>Converted from guard-based to closure-based manifest access<li>Maintained the same path resolution logic</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>bevy_encase_path</span><span>() </span><span style=color:#61676ccc>-> </span><span>syn</span><span style=color:#ed9366>::</span><span>Path {
</span><span>    </span><span style=color:#fa6e32>let</span><span> bevy_manifest </span><span style=color:#ed9366>= </span><span>BevyManifest</span><span style=color:#ed9366>::</span><span>shared()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... path resolution logic
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>bevy_encase_path</span><span>() </span><span style=color:#61676ccc>-> </span><span>syn</span><span style=color:#ed9366>::</span><span>Path {
</span><span>    BevyManifest</span><span style=color:#ed9366>::</span><span>shared(|</span><span style=color:#ff8f40>bevy_manifest</span><span>| {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ... path resolution logic
</span><span>    })
</span><span>}
</span></code></pre><h3 id=crates-bevy-asset-src-processor-mod-rs-31-8><code>crates/bevy_asset/src/processor/mod.rs</code> (+31/-8)</h3><p>The asset processor required updates to its internal synchronization for managing asset processing state.<p><strong>Key changes:</strong><ul><li>Added poison error handling for processor registration and lookup<li>Maintained the same processor management logic</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let mut</span><span> process_plans </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>data</span><span style=color:#ed9366>.</span><span>processors</span><span style=color:#ed9366>.</span><span style=color:#f07171>write</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let mut</span><span> process_plans </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self
</span><span>    </span><span style=color:#ed9366>.</span><span>data
</span><span>    </span><span style=color:#ed9366>.</span><span>processors
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>write</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_or_else</span><span>(PoisonError</span><span style=color:#ed9366>::</span><span>into_inner)</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-macro-utils-src-bevy-manifest-rs-18-11><code>crates/bevy_macro_utils/src/bevy_manifest.rs</code> (+18/-11)</h3><p>This file implemented the most significant API change, converting <code>BevyManifest::shared</code> from a guard-returning function to a closure-based API.<p><strong>Key changes:</strong><ul><li>Complete redesign of the shared manifest access pattern<li>Elimination of mapped guard functionality</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>shared</span><span>() </span><span style=color:#61676ccc>-> </span><span>MappedRwLockReadGuard<</span><span style=color:#fa6e32>'static</span><span>, BevyManifest> {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... complex guard mapping logic
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>shared</span><span>&LTR>(</span><span style=color:#ff8f40>f</span><span style=color:#61676ccc>:</span><span> impl FnOnce(&</span><span style=color:#ff8f40>BevyManifest</span><span>) -> R) </span><span style=color:#61676ccc>-></span><span> R {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... closure-based access logic
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/std/sync/index.html target=_blank>Rust Standard Library Sync Primitives</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/parking_lot/latest/parking_lot/ target=_blank>parking_lot crate documentation</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/assets/ target=_blank>Bevy Engine Asset System</a><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/std/sync/struct.PoisonError.html target=_blank>Rust Lock Poisoning</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-09/pr_20630.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>