<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22922 Fix culling for negative sized UI elements
        
    </title><meta content="#22922 Fix culling for negative sized UI elements" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-17</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-02/pr-22922-zh-cn-20260217>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix culling for negative sized UI elements<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22922<li><strong>Author</strong>: GiantBlargg<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, A-UI, S-Ready-For-Final-Review, D-Straightforward<li><strong>Created</strong>: 2026-02-12T03:21:52Z<li><strong>Merged</strong>: 2026-02-17T01:47:20Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>The original description is in English, so it is included as-is:<h1 id=objective>Objective</h1><p>Fixes #22906<h2 id=solution>Solution</h2><p>A similar solution had already been implemented for glyphs so I just copied that.<h2 id=testing>Testing</h2><p>See #22906 for a reproduction of the bug. After applying this fix, the result matches the expected.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a culling bug that affected UI elements with negative scales. The issue was that when UI nodes were transformed with negative scaling values, their culling calculations incorrectly interpreted negative dimensions as being outside the visible area, causing valid elements to be incorrectly culled.<p>The root cause was in how transformed rectangle sizes were calculated for culling. When a UI element has a negative scale (e.g., <code>scale: Vec2::new(-1.0, 1.0)</code>), the transformation produces negative size components. The original culling logic didn’t account for this properly, treating negative dimensions as if they represented rectangles with no visible area.<p>The fix is straightforward: take the absolute value of transformed rectangle sizes before using them in culling calculations. This approach was already implemented for glyph rendering, so the solution simply extended this same pattern to other UI rendering components. The implementation demonstrates good engineering practice by identifying and reusing an existing proven solution rather than creating new approaches.<p>The changes affect multiple UI rendering pipelines:<ol><li>Standard UI nodes<li>Box shadows<li>Gradients<li>UI materials<li>Texture slices</ol><p>Each of these components uses similar culling logic, so the same fix needed to be applied consistently across the codebase. The implementation shows attention to consistency and thoroughness in addressing the issue across all affected systems.<p>From a technical perspective, the fix ensures that culling decisions are based on the absolute dimensions of transformed UI elements, regardless of whether the transformation includes negative scaling. This is mathematically correct because a rectangle with negative scale still occupies the same spatial extent as one with positive scale - the negative scale only affects the orientation or mirroring of the content, not whether it should be visible.<p>The impact of this fix is that UI elements with negative scales now render correctly instead of being incorrectly culled. This is important for various UI effects that might use negative scaling for visual transformations, such as mirroring or certain animation effects.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[UI Rendering System] --> B[prepare_uinodes]
</span><span>    A --> C[prepare_shadows]
</span><span>    A --> D[prepare_gradient]
</span><span>    A --> E[prepare_uimaterial_nodes]
</span><span>    A --> F[prepare_ui_slices]
</span><span>    
</span><span>    B --> G[transformed_rect_size.abs()]
</span><span>    C --> G
</span><span>    D --> G
</span><span>    E --> G
</span><span>    F --> G
</span><span>    
</span><span>    G --> H[Correct Culling]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ui-render-src-lib-rs-7-6><code>crates/bevy_ui_render/src/lib.rs</code> (+7/-6)</h3><p>This file contains the main UI node preparation logic. The changes fix culling calculations for standard UI nodes:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before (line 1571):
</span><span style=color:#fa6e32>let</span><span> transformed_rect_size </span><span style=color:#ed9366>=</span><span> transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>transform_vector2</span><span>(rect_size)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> transformed_rect_size </span><span style=color:#ed9366>=</span><span> transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>transform_vector2</span><span>(rect_size)</span><span style=color:#ed9366>.</span><span style=color:#f07171>abs</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before (lines 1714-1720):
</span><span style=color:#fa6e32>let</span><span> transformed_rect_size </span><span style=color:#ed9366>=
</span><span>    extracted_uinode</span><span style=color:#ed9366>.</span><span>transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>transform_vector2</span><span>(rect_size)</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>if</span><span> positions_diff[</span><span style=color:#ff8f40>0</span><span>]</span><span style=color:#ed9366>.</span><span>x </span><span style=color:#ed9366>-</span><span> positions_diff[</span><span style=color:#ff8f40>1</span><span>]</span><span style=color:#ed9366>.</span><span>x
</span><span>    </span><span style=color:#ed9366>>=</span><span> transformed_rect_size</span><span style=color:#ed9366>.</span><span>x</span><span style=color:#ed9366>.</span><span style=color:#f07171>abs</span><span>()
</span><span>    </span><span style=color:#ed9366>||</span><span> positions_diff[</span><span style=color:#ff8f40>1</span><span>]</span><span style=color:#ed9366>.</span><span>y </span><span style=color:#ed9366>-</span><span> positions_diff[</span><span style=color:#ff8f40>2</span><span>]</span><span style=color:#ed9366>.</span><span>y
</span><span>        </span><span style=color:#ed9366>>=</span><span> transformed_rect_size</span><span style=color:#ed9366>.</span><span>y</span><span style=color:#ed9366>.</span><span style=color:#f07171>abs</span><span>()
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> transformed_rect_size </span><span style=color:#ed9366>=</span><span> extracted_uinode
</span><span>    </span><span style=color:#ed9366>.</span><span>transform
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>transform_vector2</span><span>(rect_size)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>abs</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>if</span><span> positions_diff[</span><span style=color:#ff8f40>0</span><span>]</span><span style=color:#ed9366>.</span><span>x </span><span style=color:#ed9366>-</span><span> positions_diff[</span><span style=color:#ff8f40>1</span><span>]</span><span style=color:#ed9366>.</span><span>x </span><span style=color:#ed9366>>=</span><span> transformed_rect_size</span><span style=color:#ed9366>.</span><span>x
</span><span>    </span><span style=color:#ed9366>||</span><span> positions_diff[</span><span style=color:#ff8f40>1</span><span>]</span><span style=color:#ed9366>.</span><span>y </span><span style=color:#ed9366>-</span><span> positions_diff[</span><span style=color:#ff8f40>2</span><span>]</span><span style=color:#ed9366>.</span><span>y
</span><span>        </span><span style=color:#ed9366>>=</span><span> transformed_rect_size</span><span style=color:#ed9366>.</span><span>y
</span></code></pre><p>The first change ensures the transformed size is always positive. The second change simplifies the culling condition by using the already-absolute value instead of calling <code>.abs()</code> inline.<h3 id=crates-bevy-ui-render-src-box-shadow-rs-1-1><code>crates/bevy_ui_render/src/box_shadow.rs</code> (+1/-1)</h3><p>Fixes culling for box shadow elements:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> transformed_rect_size </span><span style=color:#ed9366>=</span><span> box_shadow</span><span style=color:#ed9366>.</span><span>transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>transform_vector2</span><span>(rect_size)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> transformed_rect_size </span><span style=color:#ed9366>=</span><span> box_shadow</span><span style=color:#ed9366>.</span><span>transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>transform_vector2</span><span>(rect_size)</span><span style=color:#ed9366>.</span><span style=color:#f07171>abs</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-ui-render-src-gradient-rs-2-1><code>crates/bevy_ui_render/src/gradient.rs</code> (+2/-1)</h3><p>Fixes culling for gradient elements:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> transformed_rect_size </span><span style=color:#ed9366>=</span><span> gradient</span><span style=color:#ed9366>.</span><span>transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>transform_vector2</span><span>(rect_size)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> transformed_rect_size </span><span style=color:#ed9366>=
</span><span>    gradient</span><span style=color:#ed9366>.</span><span>transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>transform_vector2</span><span>(rect_size)</span><span style=color:#ed9366>.</span><span style=color:#f07171>abs</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-ui-render-src-ui-material-pipeline-rs-4-2><code>crates/bevy_ui_render/src/ui_material_pipeline.rs</code> (+4/-2)</h3><p>Fixes culling for UI material nodes:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> transformed_rect_size </span><span style=color:#ed9366>=
</span><span>    extracted_uinode</span><span style=color:#ed9366>.</span><span>transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>transform_vector2</span><span>(rect_size)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> transformed_rect_size </span><span style=color:#ed9366>=</span><span> extracted_uinode
</span><span>    </span><span style=color:#ed9366>.</span><span>transform
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>transform_vector2</span><span>(rect_size)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>abs</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-ui-render-src-ui-texture-slice-pipeline-rs-1-1><code>crates/bevy_ui_render/src/ui_texture_slice_pipeline.rs</code> (+1/-1)</h3><p>Fixes culling for UI texture slice elements:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> transformed_rect_size </span><span style=color:#ed9366>=
</span><span>    texture_slices</span><span style=color:#ed9366>.</span><span>transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>transform_vector2</span><span>(rect_size)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> transformed_rect_size </span><span style=color:#ed9366>=
</span><span>    texture_slices</span><span style=color:#ed9366>.</span><span>transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>transform_vector2</span><span>(rect_size)</span><span style=color:#ed9366>.</span><span style=color:#f07171>abs</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><p>Each change follows the same pattern: calling <code>.abs()</code> on the transformed rectangle size to ensure negative dimensions from negative scaling don’t cause incorrect culling.<h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_ui_render/latest/bevy_ui_render/ target=_blank>Bevy UI Rendering Documentation</a> - Official documentation for Bevy’s UI rendering system<li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Affine_transformation target=_blank>Affine Transformations in Computer Graphics</a> - Background on transformations including scaling<li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Viewing_frustum target=_blank>Frustum Culling Algorithms</a> - General concepts of culling in computer graphics<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/issues/22906 target=_blank>Issue #22906</a> - The original issue that reported the bug</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_22922.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>