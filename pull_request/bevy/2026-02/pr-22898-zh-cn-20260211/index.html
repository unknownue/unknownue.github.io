<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22898 fix error message when resmut conflict with query
        
    </title><meta content="#22898 fix error message when resmut conflict with query" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-11</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2026-02/pr-22898-en-20260211>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: fix error message when resmut conflict with query<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22898<li><strong>Author</strong>: mockersf<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-ECS, C-Usability, S-Ready-For-Final-Review<li><strong>Created</strong>: 2026-02-11T02:40:16Z<li><strong>Merged</strong>: 2026-02-11T05:03:50Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h3 id=mu-biao>目标</h3><ul><li>自从 #20934 之后，res/resmut 可能会与查询（queries）发生冲突<li>resmut 的错误信息中提到了 res</ul><h3 id=jie-jue-fang-an>解决方案</h3><ul><li>修复它</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>这个PR的故事始于一个看似微小的、但却影响开发者体验的细节：一个误导性的错误信息。在Bevy的ECS（Entity Component System）中，系统(System)通过系统参数(SystemParam)来声明其需要访问的数据。常见的参数包括用于查询组件的<code>Query</code>，以及用于访问全局资源的<code>Res</code>（不可变借用）和<code>ResMut</code>（可变借用）。<p>问题出现在PR #20934合并之后。该PR引入的变更为<code>Res</code>和<code>ResMut</code>与<code>Query</code>之间的冲突检测带来了新的规则或场景。当系统参数之间存在访问冲突时（例如，一个系统试图同时以可变和不可变方式访问同一资源，或者访问规则违反了Bevy的安全保证），Bevy会在运行时进行断言(assert)，并抛出一个错误信息来帮助开发者定位问题。<p>然而，在冲突检测的断言逻辑中，有一个bug被引入了。具体来说，在<code>ResMut</code>这个系统参数的实现中，当它检测到与已有查询发生冲突时，它打印的错误信息模板字符串是错误的。它写道： <code>“error[B0002]: Res<{}> in system {} conflicts...”</code><p>这里的<code>Res<{}></code>是一个硬编码的字符串字面量，它错误地声称冲突来自一个<code>Res</code>（不可变资源引用），而实际上触发这个错误的是<code>ResMut</code>（可变资源引用）。对于正在调试冲突的开发者来说，这个错误信息具有直接的误导性。如果开发者看到信息中提及<code>Res</code>，他们可能会去检查代码中所有使用<code>Res</code>的地方，而完全忽略了真正的“元凶”——那个使用了<code>ResMut</code>的参数。这会不必要地延长调试时间，降低开发体验。<p>这个问题的根源在于错误信息字符串的编写不够通用。在实现<code>ResMut</code>的<code>SystemParam</code> trait时，开发者直接复制了<code>Res</code>实现中的断言逻辑，包括错误信息，但却忘记将信息中的类型名从<code>Res</code>更新为<code>ResMut</code>。这是一个典型的复制-粘贴错误，在需要区分相似但不同组件的场景下很容易发生。<p>解决方案非常直接且聚焦：修复错误信息字符串。开发者<code>mockersf</code>提交的更改只包含一行代码。他将断言宏中的格式字符串从指向<code>Res</code>改为指向<code>ResMut</code>： <code>“error[B0002]: ResMut<{}> in system {} conflicts...”</code><p>这样，当<code>ResMut&LTT></code>与查询发生冲突时，错误信息将准确报告<code>ResMut&LTT></code>，立即引导开发者找到正确的代码位置。这个修复虽然从代码变更量上看极小（仅修改一个单词），但其价值在于维护了框架反馈的准确性和可信度。准确的错误信息对于任何框架的用户体验都至关重要，尤其是在处理并发访问和所有权规则这些Rust和ECS中的复杂概念时。<p>从技术洞察来看，这个PR凸显了几个要点：<ol><li><strong>错误信息的质量是API可用性的关键部分</strong>。一个误导性的错误信息可能比没有信息更糟。<li><strong>在复制相似组件的实现时需要格外小心</strong>，尤其是那些包含硬编码标识符（如类型名）的部分。<li><strong>测试应覆盖错误路径</strong>。理想情况下，应该有测试确保<code>ResMut</code>冲突时抛出的错误信息包含“ResMut”而不是“Res”。这属于针对错误信息的单元测试或集成测试。</ol><p>这个PR被迅速合并（在2个多小时内），并且被打上了<code>C-Usability</code>（可用性）和<code>A-ECS</code>的标签，这准确地反映了它的性质：一个针对ECS核心功能的、提升开发者可用性的小修复。它不改变任何功能逻辑，只修复了元数据（错误信息）的准确性，是框架成熟度过程中一次典型的“打磨”。<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    subgraph “SystemParam Trait 实现”
</span><span>        Res[Res&LTT>] --> |实现| Res_Impl
</span><span>        ResMut[ResMut&LTT>] --> |实现| ResMut_Impl
</span><span>    end
</span><span>
</span><span>    ResMut_Impl -->|包含| Assertion[冲突检测断言]
</span><span>    Assertion -->|之前打印| WrongMsg[“错误信息: Res&LTT>”]
</span><span>    Assertion -->|PR#22898修复后打印| CorrectMsg[“正确信息: ResMut&LTT>”]
</span><span>    
</span><span>    Conflict[查询冲突] -->|触发| Assertion
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>文件:</strong> <code>crates/bevy_ecs/src/system/system_param.rs</code><ol><li><strong>修改内容及原因</strong>：修改了<code>ResMut</code>系统参数实现中，运行时冲突检测断言所打印的错误信息。将信息中错误的类型名<code>Res</code>更正为<code>ResMut</code>，使错误信息准确反映引发冲突的实际参数类型。<li><strong>代码片段</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 文件: crates/bevy_ecs/src/system/system_param.rs
</span><span style=color:#abb0b6;font-style:italic>// 修改前（第881行附近）:
</span><span style=color:#f07171>assert!</span><span>(component_access_set
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>get_conflicts_single</span><span>(</span><span style=color:#ed9366>&</span><span>filter)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>is_empty</span><span>()</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#86b300>"error[B0002]: Res<{}> in system {} conflicts with a previous query. Consider removing the duplicate access. See: https://bevy.org/learn/errors/b0002"</span><span style=color:#61676ccc>,
</span><span>    DebugName</span><span style=color:#ed9366>::</span><span>type_name</span><span style=color:#ed9366>::</span><span>&LTT>()</span><span style=color:#61676ccc>,
</span><span>    system_meta</span><span style=color:#ed9366>.</span><span>name
</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 修改后:
</span><span style=color:#f07171>assert!</span><span>(component_access_set
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>get_conflicts_single</span><span>(</span><span style=color:#ed9366>&</span><span>filter)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>is_empty</span><span>()</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#86b300>"error[B0002]: ResMut<{}> in system {} conflicts with a previous query. Consider removing the duplicate access. See: https://bevy.org/learn/errors/b0002"</span><span style=color:#61676ccc>,
</span><span>    DebugName</span><span style=color:#ed9366>::</span><span>type_name</span><span style=color:#ed9366>::</span><span>&LTT>()</span><span style=color:#61676ccc>,
</span><span>    system_meta</span><span style=color:#ed9366>.</span><span>name
</span><span>)</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// ^--- 唯一变化：将“Res<{}>”改为“ResMut<{}>”
</span></code></pre><li><strong>与PR目标的关联</strong>：这行修改直接实现了PR的目标——修复<code>ResMut</code>冲突时错误信息错误地提及<code>Res</code>的问题。</ol><h2 id=further-reading>Further Reading</h2><ol><li><strong>Bevy 错误代码 B0002</strong>: https://bevy.org/learn/errors/b0002 - 官方文档详细解释了资源访问冲突的原因和解决方案。<li><strong>PR #20934</strong>: 引发<code>Res</code>/<code>ResMut</code>与查询新冲突场景的原始PR。理解其变更可以提供本修复的完整背景。<li><strong>Bevy ECS 系统参数(SystemParam)</strong>: Bevy官方手册中关于<code>SystemParam</code> trait和<code>Res</code>/<code>ResMut</code>/<code>Query</code>等内置参数的解释，有助于理解这些抽象是如何工作的。</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_22898.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>