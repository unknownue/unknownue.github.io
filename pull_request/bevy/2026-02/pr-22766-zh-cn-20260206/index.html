<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22766 Refactor extraction to bypass the orphan rules
        
    </title><meta content="#22766 Refactor extraction to bypass the orphan rules" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-06</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2026-02/pr-22766-en-20260206>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=refactor-extraction-to-bypass-the-orphan-rules>Refactor extraction to bypass the orphan rules</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>标题</strong>: Refactor extraction to bypass the orphan rules<li><strong>PR链接</strong>: https://github.com/bevyengine/bevy/pull/22766<li><strong>作者</strong>: kristoff3r<li><strong>状态</strong>: 已合并<li><strong>标签</strong>: C-Bug, A-Rendering, C-Usability, S-Ready-For-Final-Review, M-Migration-Guide<li><strong>创建时间</strong>: 2026-02-01T15:34:09Z<li><strong>合并时间</strong>: 2026-02-06T21:50:10Z<li><strong>合并者</strong>: alice-i-cecile</ul><h2 id=miao-shu-fan-yi>描述翻译</h2><p><strong>目标</strong><p>修复 #18722，并允许 <code>ExtractComponent</code> 用于外部类型。<p><strong>解决方案</strong><ul><li>将 <code>ExtractComponent</code> 中的 <code>Out</code> 类型拆分为一个独立的 <code>SyncComponent</code> 特质。这允许类型在不使用提取逻辑的情况下使用同步逻辑，并允许 <code>SyncComponentPlugin</code> 正确识别应删除哪些组件。<li>在 <code>SyncComponentPlugin</code>/<code>SyncWorldPlugin</code> 中不删除整个实体，只删除 <code>Out</code> 组件，从而修复 #18722。<li>为 <code>ExtractComponent</code> 和 <code>SyncComponent</code> 添加标记类型，允许在 <code>bevy_render</code> 之外为外部类型实现这些特质。（例如：<code>DirectionalLight</code> 定义在不依赖 <code>bevy_render</code> 的 <code>bevy_light</code> 中，并被 <code>bevy_pbr</code> 使用。没有标记的话，任何 crate 都不能实现该特质。）</ul><p>在早期由 @atlv24 进行的渲染 crate 重构中，一些 <code>ExtractComponent</code> 的使用被转换为手动实现。我尚未将这些改回来，这可以在后续的 PR 中完成。<p>作为后续工作，为 <code>SyncComponent</code> 制作一个派生宏，和/或更新 <code>ExtractComponent</code> 宏以能够自定义同步行为，可能会很有趣。<p><strong>测试</strong><p>运行了一堆示例。测试其他示例，特别是切换组件的示例，会很好。<p><del>测试用例在 #22758 中。如果那个先被合并，这个 PR 应该被更新以取消相关断言的注释。</del> 编辑：断言已被添加。<h2 id=ben-ci-pull-request-de-gu-shi>本次 Pull Request 的故事</h2><p>Bevy 引擎中的渲染系统采用双世界架构：一个主世界（app world）用于逻辑更新，一个渲染世界（render world）用于渲染操作。在这两个世界之间同步组件数据是一个核心需求，<code>ExtractComponent</code> 特质长期以来一直扮演着这个角色。然而，它面临两个关键的技术限制：Rust 的孤儿规则（orphan rules）限制了为外部类型实现该特质，以及删除组件时会错误地清除整个渲染实体。PR #22766 系统地解决了这些问题，并对提取系统进行了重构。<p><strong>问题与上下文</strong><p><code>ExtractComponent</code> 特质的设计将数据提取和组件同步两个关注点耦合在一起。每个实现必须定义三个关联类型：<code>QueryData</code>、<code>QueryFilter</code> 和 <code>Out</code>。这种设计在 Rust 的孤儿规则下产生了问题：由于 <code>ExtractComponent</code> 定义在 <code>bevy_render</code> crate 中，外部 crate 不能为它们自己的类型（如 <code>DirectionalLight</code>，定义在 <code>bevy_pbr</code>）实现该特质，因为 <code>bevy_pbr</code> 不依赖 <code>bevy_render</code>。这迫使开发者采用不理想的变通方案，如手动提取函数，破坏了系统的一致性。<p>更严重的是，<code>SyncComponentPlugin</code> 在处理组件删除时存在一个错误（#18722）。当某个组件从主世界实体中移除时，插件会删除整个对应的渲染世界实体，而不是只删除与移除的组件相关的 <code>Out</code> 组件。这会导致所有其他提取的组件也丢失，引起难以调试的渲染问题。<p><strong>解决方案方法</strong><p>开发者采用了分解（refactoring）的方法来解决这两个问题。核心洞察是：同步逻辑（识别哪些组件需要被删除）与提取逻辑（如何从主世界组件生成渲染世界组件）本质上是不同的关注点。因此，解决方案将原来的 <code>ExtractComponent::Out</code> 关联类型拆分到一个新的独立特质 <code>SyncComponent</code> 中。<code>SyncComponent</code> 只关心组件与渲染世界输出的映射关系，而 <code>ExtractComponent</code> 现在扩展（或依赖）<code>SyncComponent</code>，专注于提取过程本身。<p>为了绕过孤儿规则，两个特质都引入了可选的标记类型参数（marker type）。这利用了 Rust 的“本地特质“规则：即使特质和类型都定义在外部 crate，只要特质实现中涉及了本地类型（标记类型），就可以实现该特质。<p>对于组件删除问题，解决方案是修改 <code>SyncComponentPlugin</code> 的行为。它不再删除整个实体，而是根据 <code>SyncComponent::Out</code> 类型只移除相关的组件。这是通过向 <code>EntityRecord::ComponentRemoved</code> 变体添加一个闭包函数来实现的，该闭包知道如何删除特定组件的输出。<p><strong>实现详情</strong><p>这次重构触及了多个 crate，但核心变化集中在 <code>bevy_render</code> 中。新的 <code>SyncComponent</code> 特质定义了 <code>Out</code> 关联类型，表示在渲染世界中应该被同步的组件或组件集合（bundle）。<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// crates/bevy_render/src/sync_component.rs
</span><span style=color:#fa6e32>pub trait </span><span style=color:#399ee6>SyncComponent</span><span>&LTMarker = ()>: Component {
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Out</span><span style=color:#61676ccc>: </span><span>Bundle&LTEffect</span><span style=color:#61676ccc>:</span><span> NoBundleEffect></span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p><code>ExtractComponent</code> 特质现在扩展了 <code>SyncComponent</code>，不再定义自己的 <code>Out</code> 类型：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// crates/bevy_render/src/extract_component.rs
</span><span style=color:#fa6e32>pub trait </span><span style=color:#399ee6>ExtractComponent</span><span>&LTMarker = ()>: SyncComponent {
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>QueryData</span><span style=color:#61676ccc>:</span><span> ReadOnlyQueryData</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>QueryFilter</span><span style=color:#61676ccc>:</span><span> QueryFilter</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>extract_component</span><span>(</span><span style=color:#ff8f40>item</span><span style=color:#61676ccc>: </span><span>QueryItem<'</span><span style=color:#ed9366>_</span><span>, '</span><span style=color:#ed9366>_</span><span>, </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>QueryData>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Out></span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>关键的变化发生在 <code>SyncComponentPlugin</code> 的组件移除处理中。之前，当组件被移除时，它会记录 <code>EntityRecord::ComponentRemoved(context.entity)</code>，导致整个实体被删除。现在，它记录一个包含删除函数的变体：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// crates/bevy_render/src/sync_component.rs
</span><span style=color:#f07171>on_remove</span><span>(|</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>context</span><span>| {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> pending </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span>resource_mut</span><span style=color:#ed9366>::</span><span>&LTPendingSyncEntity>()</span><span style=color:#61676ccc>;
</span><span>    pending</span><span style=color:#ed9366>.</span><span style=color:#f07171>push</span><span>(EntityRecord</span><span style=color:#ed9366>::</span><span>ComponentRemoved(
</span><span>        context</span><span style=color:#ed9366>.</span><span>entity</span><span style=color:#61676ccc>,
</span><span>        |</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>entity</span><span>| {
</span><span>            entity</span><span style=color:#ed9366>.</span><span>remove</span><span style=color:#ed9366>::</span><span><</span><span style=color:#fa6e32>C</span><span style=color:#ed9366>::</span><span>Out>()</span><span style=color:#61676ccc>;
</span><span>        }</span><span style=color:#61676ccc>,
</span><span>    ))</span><span style=color:#61676ccc>;
</span><span>})</span><span style=color:#61676ccc>;
</span></code></pre><p>这个闭包在同步系统（<code>entity_sync_system</code>）中被调用，精确地移除 <code>Out</code> 组件，而不是整个实体。<p>为了保持向后兼容性，<code>ExtractComponentPlugin</code> 自动注册 <code>SyncComponentPlugin</code>，确保同步逻辑被启用。此外，<code>bevy_render</code> 的 <code>derive_extract_component</code> 宏被更新，自动为结构体生成 <code>SyncComponent</code> 实现。<p><strong>技术洞察</strong><p>这次重构展示了几个重要的 Rust 设计模式：<ol><li><strong>关注点分离</strong>：将同步映射（<code>SyncComponent</code>）与提取逻辑（<code>ExtractComponent</code>）分离，使得每个特质更单一、更可重用。<li><strong>孤儿规则规避</strong>：使用标记类型参数是 Rust 中绕过孤儿规则的常见技术。通过要求实现者指定一个本地类型作为标记，我们创建了一个“本地上下文“，允许为外部类型实现外部特质。<li><strong>闭包驱动的清理</strong>：将清理逻辑封装在闭包中，允许类型安全的组件删除，无需动态类型检查或反射。</ol><p>性能方面，这个变化应该是中性的或略有正面影响，因为减少了不必要的实体删除和重新创建。架构上，它为未来的扩展奠定了基础，比如为 <code>SyncComponent</code> 创建派生宏，或者为 <code>ExtractComponent</code> 添加更复杂的同步行为定制。<p><strong>影响</strong><p>这次重构解决了两个长期存在的问题：<ol><li><strong>外部类型支持</strong>：现在，像 <code>DirectionalLight</code> 这样的类型可以在 <code>bevy_pbr</code> 中直接实现 <code>ExtractComponent</code>，无需手动提取函数。<li><strong>正确的组件删除</strong>：当组件被移除时，只有相关的渲染组件被删除，其他提取的组件保持不变。</ol><p>迁移相对简单：对于现有的 <code>ExtractComponent</code> 实现，只需将 <code>type Out</code> 移动到新的 <code>SyncComponent</code> 实现中。迁移指南（<code>extract_refactor.md</code>）提供了清晰的示例。<p>对于 Bevy 生态系统来说，这次变化提高了渲染系统的健壮性和可扩展性，减少了潜在的错误，并为更复杂的提取模式打开了大门。<h2 id=ke-shi-hua-biao-shi>可视化表示</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[主世界组件] -->|实现| B[SyncComponent]
</span><span>    B -->|定义| C[渲染世界输出]
</span><span>    A -->|实现| D[ExtractComponent]
</span><span>    D -->|依赖| B
</span><span>    D -->|使用| E[查询数据]
</span><span>    D -->|使用| F[查询过滤器]
</span><span>    G[SyncComponentPlugin] -->|注册| B
</span><span>    H[ExtractComponentPlugin] -->|注册| D
</span><span>    H -->|自动注册| G
</span><span>    
</span><span>    I[主世界实体] -->|组件移除| G
</span><span>    G -->|记录闭包| J[同步系统]
</span><span>    J -->|执行闭包| K[移除指定组件]
</span><span>    K -->|保留| L[其他渲染组件]
</span></code></pre><h2 id=guan-jian-wen-jian-geng-gai>关键文件更改</h2><p><strong><code>crates/bevy_render/src/extract_component.rs</code> (+21/-30)</strong> 这个文件包含了 <code>ExtractComponent</code> 特质的重定义。主要变化是移除了 <code>Out</code> 关联类型，并使其扩展新的 <code>SyncComponent</code> 特质。<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub trait </span><span style=color:#399ee6>ExtractComponent</span><span>: Component {
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>QueryData</span><span style=color:#61676ccc>:</span><span> ReadOnlyQueryData</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>QueryFilter</span><span style=color:#61676ccc>:</span><span> QueryFilter</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Out</span><span style=color:#61676ccc>: </span><span>Bundle&LTEffect</span><span style=color:#61676ccc>:</span><span> NoBundleEffect></span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>extract_component</span><span>(</span><span style=color:#ff8f40>item</span><span style=color:#61676ccc>: </span><span>QueryItem<'</span><span style=color:#ed9366>_</span><span>, '</span><span style=color:#ed9366>_</span><span>, </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>QueryData>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Out></span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub trait </span><span style=color:#399ee6>ExtractComponent</span><span>&LTMarker = ()>: SyncComponent {
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>QueryData</span><span style=color:#61676ccc>:</span><span> ReadOnlyQueryData</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>QueryFilter</span><span style=color:#61676ccc>:</span><span> QueryFilter</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>extract_component</span><span>(</span><span style=color:#ff8f40>item</span><span style=color:#61676ccc>: </span><span>QueryItem<'</span><span style=color:#ed9366>_</span><span>, '</span><span style=color:#ed9366>_</span><span>, </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>QueryData>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Out></span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p><strong><code>crates/bevy_render/src/sync_component.rs</code> (+39/-9)</strong> 新文件定义了 <code>SyncComponent</code> 特质和相关的插件。关键部分是 <code>on_remove</code> 钩子中闭包的使用。<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 新增的trait定义
</span><span style=color:#fa6e32>pub trait </span><span style=color:#399ee6>SyncComponent</span><span>&LTMarker = ()>: Component {
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Out</span><span style=color:#61676ccc>: </span><span>Bundle&LTEffect</span><span style=color:#61676ccc>:</span><span> NoBundleEffect></span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 组件移除处理
</span><span style=color:#f07171>on_remove</span><span>(|</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>context</span><span>| {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> pending </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span>resource_mut</span><span style=color:#ed9366>::</span><span>&LTPendingSyncEntity>()</span><span style=color:#61676ccc>;
</span><span>    pending</span><span style=color:#ed9366>.</span><span style=color:#f07171>push</span><span>(EntityRecord</span><span style=color:#ed9366>::</span><span>ComponentRemoved(
</span><span>        context</span><span style=color:#ed9366>.</span><span>entity</span><span style=color:#61676ccc>,
</span><span>        |</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>entity</span><span>| {
</span><span>            entity</span><span style=color:#ed9366>.</span><span>remove</span><span style=color:#ed9366>::</span><span><</span><span style=color:#fa6e32>C</span><span style=color:#ed9366>::</span><span>Out>()</span><span style=color:#61676ccc>;  </span><span style=color:#abb0b6;font-style:italic>// 只删除相关组件
</span><span>        }</span><span style=color:#61676ccc>,
</span><span>    ))</span><span style=color:#61676ccc>;
</span><span>})</span><span style=color:#61676ccc>;
</span></code></pre><p><strong><code>release-content/migration-guides/extract_refactor.md</code> (+41/-0)</strong> 新增的迁移指南，展示了如何将现有的 <code>ExtractComponent</code> 实现迁移到新的结构。<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 迁移前:
</span><span style=color:#fa6e32>impl </span><span>ExtractComponent </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>MyComponent </span><span>{
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>QueryData </span><span style=color:#ed9366>= </span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>QueryFilter </span><span style=color:#ed9366>= </span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Out </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>Self</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>extract_component</span><span>(</span><span style=color:#ff8f40>item</span><span style=color:#61676ccc>: </span><span>QueryItem<'</span><span style=color:#ed9366>_</span><span>, '</span><span style=color:#ed9366>_</span><span>, </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>QueryData>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Out> {
</span><span>        </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#ed9366>*</span><span>item)
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 迁移后:
</span><span style=color:#fa6e32>impl </span><span>SyncComponent </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>MyComponent </span><span>{
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Out </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>Self</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#fa6e32>impl </span><span>ExtractComponent </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>MyComponent </span><span>{
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>QueryData </span><span style=color:#ed9366>= </span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>QueryFilter </span><span style=color:#ed9366>= </span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>extract_component</span><span>(</span><span style=color:#ff8f40>item</span><span style=color:#61676ccc>: </span><span>QueryItem<'</span><span style=color:#ed9366>_</span><span>, '</span><span style=color:#ed9366>_</span><span>, </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>QueryData>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Out> {
</span><span>        </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#ed9366>*</span><span>item)
</span><span>    }
</span><span>}
</span></code></pre><p><strong><code>crates/bevy_pbr/src/lib.rs</code> (+22/-5)</strong> 展示了如何使用标记类型为外部类型（如 <code>DirectionalLight</code>）实现 <code>SyncComponent</code>。通过使用 <code>PbrPlugin</code> 作为标记，<code>bevy_pbr</code> 可以为这些类型实现特质。<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>impl </span><span>SyncComponent&LTPbrPlugin> </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>DirectionalLight </span><span>{
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Out </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>Self</span><span style=color:#61676ccc>;
</span><span>}
</span><span style=color:#abb0b6;font-style:italic>// 类似的实现还有 PointLight, SpotLight, AmbientLight, ShadowFilteringMethod
</span></code></pre><p><strong><code>crates/bevy_post_process/src/dof/mod.rs</code> (+13/-10)</strong> 展示了如何利用新的 <code>SyncComponent::Out</code> 类型来简化组件清理代码。<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>entity_commands</span><span style=color:#ed9366>.</span><span>remove</span><span style=color:#ed9366>::</span><span><(
</span><span>    DepthOfField,
</span><span>    DepthOfFieldUniform,
</span><span>    DepthOfFieldPipelines,
</span><span>    AuxiliaryDepthOfFieldTexture,
</span><span>    ViewDepthOfFieldBindGroupLayouts,
</span><span>)>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>entity_commands</span><span style=color:#ed9366>.</span><span>remove</span><span style=color:#ed9366>::</span><span><&LTDepthOfField </span><span style=color:#ed9366>as</span><span> SyncComponent></span><span style=color:#ed9366>::</span><span>Out>()</span><span style=color:#61676ccc>;
</span></code></pre><h2 id=jin-yi-bu-yue-du>进一步阅读</h2><ol><li><p><strong>Rust 孤儿规则</strong>：</p> <ul><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/book/ch10-02-traits.html#implementing-a-trait-on-a-type target=_blank>The Rust Programming Language - Trait Implementation Rules</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/rust-lang/rfcs/blob/master/text/1023-rebalancing-coherence.md target=_blank>Rust RFC 1023 - Rebalancing Coherence</a></ul><li><p><strong>Bevy 提取系统</strong>：</p> <ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_render/latest/bevy_render/render_graph/index.html target=_blank>Bevy Render Graph Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/ecs-intro/#system-scheduling target=_blank>Bevy ECS System Scheduling</a></ul><li><p><strong>软件设计模式</strong>：</p> <ul><li>关注点分离（Separation of Concerns）<li>策略模式（Strategy Pattern）通过特质实现<li>依赖注入（Dependency Injection）在插件系统中的体现</ul><li><p><strong>相关 PR 和 Issues</strong>：</p> <ul><li>Issue #18722: 组件删除时错误地清除整个实体<li>早期渲染重构 PRs，展示了手动提取的演变过程</ul></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_22766.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>