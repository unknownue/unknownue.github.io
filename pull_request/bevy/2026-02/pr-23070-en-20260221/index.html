<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #23070 Restore shadow_maps_enabled check.
        
    </title><meta content="#23070 Restore shadow_maps_enabled check." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-21</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-02/pr-23070-zh-cn-20260221>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Restore shadow_maps_enabled check.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/23070<li><strong>Author</strong>: tychedelia<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, S-Ready-For-Final-Review<li><strong>Created</strong>: 2026-02-20T07:55:38Z<li><strong>Merged</strong>: 2026-02-21T00:55:39Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><p>Fixes <code>light_probe_blending</code> and <code>spherical_area_lights</code> examples.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=the-problem-and-context>The Problem and Context</h3><p>This PR addresses a regression in Bevy’s rendering system where lights with shadow maps disabled were still having shadow map entities created for them. The issue manifested as broken examples (<code>light_probe_blending</code> and <code>spherical_area_lights</code>) that rely on lights without shadow maps.<p>In Bevy’s Physically Based Rendering (PBR) system, when lights are prepared for rendering, the system processes visible lights and creates necessary shadow map entities for those that have shadows enabled. The <code>Light</code> component has a <code>shadow_maps_enabled</code> field that controls whether shadow maps should be generated for that light. However, a previous change removed the check for this flag during light preparation, causing the system to create shadow map entities for all lights regardless of their shadow configuration.<h3 id=the-solution-approach>The Solution Approach</h3><p>The fix restores a previously removed conditional check that skips shadow map creation for lights where <code>shadow_maps_enabled</code> is false. This is a straightforward regression fix that adds back the missing logic in exactly one location.<p>The solution is minimal and targeted: it adds a check early in the light preparation loop to skip processing for lights without shadow maps enabled. When such lights are encountered, any existing shadow map entities are cleaned up and the light is skipped for shadow map creation.<h3 id=the-implementation>The Implementation</h3><p>The implementation adds a simple conditional block in the <code>prepare_lights</code> function. Here’s the key addition:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>light</span><span style=color:#ed9366>.</span><span>shadow_maps_enabled {
</span><span>    </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(entities) </span><span style=color:#ed9366>=</span><span> light_view_entities</span><span style=color:#ed9366>.</span><span style=color:#f07171>remove</span><span>(</span><span style=color:#ed9366>&</span><span>entity) {
</span><span>        </span><span style=color:#f07171>despawn_entities</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> commands</span><span style=color:#61676ccc>,</span><span> entities)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>    </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>This code does three things:<ol><li>Checks if shadow maps are disabled for the current light<li>If shadow map entities already exist (from a previous frame or state), removes them from tracking and despawns them<li>Skips the rest of the shadow map preparation logic for this light</ol><p>The placement of this check is important - it comes after the light extraction but before any shadow map entity creation logic. This ensures that lights without shadow maps don’t consume unnecessary resources or cause rendering issues.<h3 id=technical-insights>Technical Insights</h3><p>The fix demonstrates an important pattern in graphics programming: early culling of unnecessary work. By checking <code>shadow_maps_enabled</code> at the beginning of the loop, we avoid:<ul><li>Unnecessary shadow map texture allocations<li>Extra draw calls for shadow map rendering<li>Potential GPU memory waste<li>Possible rendering artifacts from unexpected shadow maps</ul><p>The code also properly handles cleanup of existing entities through <code>light_view_entities.remove()</code> and <code>despawn_entities()</code>. This ensures that if a light’s shadow configuration changes from enabled to disabled between frames, the old shadow map entities are properly cleaned up.<h3 id=the-impact>The Impact</h3><p>This fix resolves immediate issues in the affected examples and restores correct behavior for all lights configured without shadow maps. The change is performance-positive since it prevents unnecessary shadow map creation and rendering work for lights that don’t need it.<p>From an architectural perspective, this reinforces the importance of respecting component configuration flags throughout the rendering pipeline. The <code>shadow_maps_enabled</code> flag exists for a reason - to give developers control over performance/quality tradeoffs - and the rendering system must honor these settings consistently.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[prepare_lights function] --> B{For each visible light}
</span><span>    B --> C{light.shadow_maps_enabled?}
</span><span>    C -->|No| D[Remove existing shadow entities]
</span><span>    D --> E[Skip to next light]
</span><span>    C -->|Yes| F[Continue shadow map creation]
</span><span>    F --> G[Create/update shadow map entities]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-pbr-src-render-light-rs-7-0><code>crates/bevy_pbr/src/render/light.rs</code> (+7/-0)</h3><p><strong>What changed</strong>: Added a check for <code>shadow_maps_enabled</code> in the <code>prepare_lights</code> function to skip shadow map creation for lights that don’t have shadows enabled.<p><strong>Key modifications</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// The added code block in the prepare_lights function:
</span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>light</span><span style=color:#ed9366>.</span><span>shadow_maps_enabled {
</span><span>    </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(entities) </span><span style=color:#ed9366>=</span><span> light_view_entities</span><span style=color:#ed9366>.</span><span style=color:#f07171>remove</span><span>(</span><span style=color:#ed9366>&</span><span>entity) {
</span><span>        </span><span style=color:#f07171>despawn_entities</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> commands</span><span style=color:#61676ccc>,</span><span> entities)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>    </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p><strong>How it relates to the PR purpose</strong>: This single conditional block fixes the regression by preventing shadow map entity creation for lights with <code>shadow_maps_enabled = false</code>. The cleanup of existing entities ensures proper state management when lights change their shadow configuration.<h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_pbr/latest/bevy_pbr/ target=_blank>Bevy Rendering Documentation</a> - For understanding Bevy’s PBR rendering pipeline<li><a rel="noopener nofollow noreferrer" href=https://learnopengl.com/Advanced-Lighting/Shadows/Shadow-Mapping target=_blank>Shadow Mapping Techniques</a> - Background on shadow mapping in computer graphics<li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/reflect/trait.Component.html target=_blank>Bevy Component Documentation</a> - Understanding how components work in Bevy’s ECS<li><a rel="noopener nofollow noreferrer" href=https://developer.nvidia.com/blog/opengl-rendering-pipeline-performance/ target=_blank>Graphics Performance Optimization</a> - Techniques for optimizing rendering pipelines</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_23070.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>