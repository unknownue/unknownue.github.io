<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #23024 Fix `WGPU_SETTINGS_PRIO="webgl2"` after atmosphere landed.
        
    </title><meta content='#23024 Fix `WGPU_SETTINGS_PRIO="webgl2"` after atmosphere landed.' property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-17</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-02/pr-23024-zh-cn-20260217>中文</a></div></div><div class=pr-content><h1 id=fix-wgpu-settings-prio-webgl2-after-atmosphere-landed>Fix <code>WGPU_SETTINGS_PRIO="webgl2"</code> after atmosphere landed</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix <code>WGPU_SETTINGS_PRIO="webgl2"</code> after atmosphere landed.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/23024<li><strong>Author</strong>: pcwalton<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: D-Trivial, A-Rendering, P-Crash, S-Ready-For-Final-Review, A-Diagnostics<li><strong>Created</strong>: 2026-02-17T22:39:23Z<li><strong>Merged</strong>: 2026-02-17T23:40:36Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>The atmosphere plugin only checks <code>RenderAdapter</code> to determine whether it’s safe to run, not <code>RenderDevice</code>. As PR #18113 discovered, this causes <code>WGPU_SETTINGS_PRIO="webgl2"</code> to fail, because that environment variable only affects <code>RenderDevice</code>, not <code>RenderAdapter</code>. Like that PR, this PR fixes atmosphere to check <code>RenderDevice</code> in addition to <code>RenderAdapter</code>.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a specific bug where the atmosphere plugin fails to load when the <code>WGPU_SETTINGS_PRIO="webgl2"</code> environment variable is set. The root cause stems from a discrepancy between how different parts of the rendering system check for GPU capabilities.<p>When the atmosphere plugin initializes, it performs a capability check to ensure the GPU supports required features. The original implementation only checked the <code>RenderAdapter</code>, which represents the physical GPU hardware and its capabilities. However, the <code>WGPU_SETTINGS_PRIO="webgl2"</code> environment variable affects the <code>RenderDevice</code> - the logical device interface to the GPU - by limiting its capabilities to WebGL2 compatibility levels. This creates a situation where the <code>RenderAdapter</code> reports support for certain features, but the <code>RenderDevice</code> (constrained by the environment variable) doesn’t actually provide them.<p>The issue manifests specifically with storage textures. The atmosphere plugin requires <code>max_storage_textures_per_shader_stage > 0</code>, but when <code>WGPU_SETTINGS_PRIO="webgl2"</code> is set, the device emulates WebGL2 constraints which typically don’t include storage texture support. The original check only looked at adapter capabilities, so it would incorrectly assume the feature was available and attempt to use it, causing a crash.<p>This is actually a recurrence of a problem that was previously discovered and fixed in PR #18113 for other parts of the codebase. The same pattern needed to be applied to the atmosphere plugin. The fix is straightforward: in addition to checking the <code>RenderAdapter</code>, the plugin now also checks the <code>RenderDevice</code>’s capabilities.<p>The implementation adds a new check in the atmosphere plugin’s <code>Plugin::build</code> method. After the existing adapter check, it retrieves the <code>RenderDevice</code> resource and checks if <code>max_storage_textures_per_shader_stage</code> is greater than 0. If not, it logs a warning and returns early without setting up the atmosphere rendering systems.<p>This approach ensures consistency with how other rendering features in Bevy handle capability checks. It’s a defensive check that prevents trying to use features the current device configuration doesn’t support, avoiding runtime crashes when the environment variable is set.<p>The fix is minimal and focused - it only adds the necessary device capability check without changing any other behavior. This maintains backward compatibility for all cases where the device actually supports the required features, while preventing crashes in the specific <code>WGPU_SETTINGS_PRIO="webgl2"</code> configuration.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[AtmospherePlugin] --> B{Check RenderAdapter}
</span><span>    B -->|Capabilities OK| C{Check RenderDevice}
</span><span>    B -->|Missing features| D[Early return - skip setup]
</span><span>    C -->|max_storage_textures_per_shader_stage > 0| E[Setup atmosphere systems]
</span><span>    C -->|No storage texture support| D
</span><span>    
</span><span>    F[WGPU_SETTINGS_PRIO="webgl2"] --> G[Affects RenderDevice limits]
</span><span>    G --> C
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-pbr-src-atmosphere-mod-rs-10-0><code>crates/bevy_pbr/src/atmosphere/mod.rs</code> (+10/-0)</h3><p>The change adds a capability check for the <code>RenderDevice</code> in addition to the existing <code>RenderAdapter</code> check. This ensures the atmosphere plugin properly respects the <code>WGPU_SETTINGS_PRIO="webgl2"</code> environment variable which affects device capabilities but not adapter capabilities.<p><strong>Key modifications:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added import for RenderDevice
</span><span style=color:#fa6e32>use </span><span>bevy_render</span><span style=color:#ed9366>::</span><span>{
</span><span>    extract_component</span><span style=color:#ed9366>::</span><span>UniformComponentPlugin</span><span style=color:#61676ccc>,
</span><span>    render_resource</span><span style=color:#ed9366>::</span><span>{DownlevelFlags</span><span style=color:#61676ccc>,</span><span> ShaderType</span><span style=color:#61676ccc>,</span><span> SpecializedRenderPipelines}</span><span style=color:#61676ccc>,
</span><span>    renderer</span><span style=color:#ed9366>::</span><span>RenderDevice</span><span style=color:#61676ccc>,  </span><span style=color:#abb0b6;font-style:italic>// &LT-- New import
</span><span>    sync_component</span><span style=color:#ed9366>::</span><span>SyncComponent</span><span style=color:#61676ccc>,
</span><span>    sync_world</span><span style=color:#ed9366>::</span><span>RenderEntity</span><span style=color:#61676ccc>,
</span><span>    Extract</span><span style=color:#61676ccc>,</span><span> ExtractSchedule</span><span style=color:#61676ccc>,</span><span> RenderStartup</span><span style=color:#61676ccc>,
</span><span>}</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Added check in Plugin::build method
</span><span style=color:#abb0b6;font-style:italic>// Check the `RenderDevice` in addition to the `RenderAdapter`. The
</span><span style=color:#abb0b6;font-style:italic>// former takes the `WGPU_SETTINGS_PRIO` environment variable into
</span><span style=color:#abb0b6;font-style:italic>// account, and the latter doesn't.
</span><span style=color:#fa6e32>let</span><span> render_device </span><span style=color:#ed9366>=</span><span> render_app</span><span style=color:#ed9366>.</span><span style=color:#f07171>world</span><span>()</span><span style=color:#ed9366>.</span><span>resource</span><span style=color:#ed9366>::</span><span>&LTRenderDevice>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>if</span><span> render_device</span><span style=color:#ed9366>.</span><span style=color:#f07171>limits</span><span>()</span><span style=color:#ed9366>.</span><span>max_storage_textures_per_shader_stage </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0 </span><span>{
</span><span>    </span><span style=color:#f07171>warn!</span><span>(</span><span style=color:#86b300>"AtmospherePlugin not loaded. GPU lacks support: `max_storage_textures_per_shader_stage` is 0"</span><span>)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>The change adds a second capability check that examines the <code>RenderDevice</code>’s limits after the existing <code>RenderAdapter</code> check. This ensures that if the device (influenced by environment variables) doesn’t support storage textures, the plugin will exit early with a warning instead of trying to use unsupported features.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://www.w3.org/TR/webgpu/#texture-format-capabilities target=_blank>WebGPU Specification - Storage Textures</a> - Details on storage texture capabilities in WebGPU<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/pull/18113 target=_blank>Bevy PR #18113</a> - The original fix for similar issues in other parts of the codebase<li><a rel="noopener nofollow noreferrer" href=https://docs.rs/wgpu/latest/wgpu/struct.Limits.html target=_blank>wgpu Documentation on Limits</a> - Information about device limits and capabilities<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/getting-started/rendering/ target=_blank>Bevy Rendering Architecture</a> - Overview of Bevy’s rendering system</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_23024.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>