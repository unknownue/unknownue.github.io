<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22836 Fix UV calculation for `SpriteMesh` when using a `TextureAtlasLayout`
        
    </title><meta content="#22836 Fix UV calculation for `SpriteMesh` when using a `TextureAtlasLayout`" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-07</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-02/pr-22836-zh-cn-20260207>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix UV calculation for <code>SpriteMesh</code> when using a <code>TextureAtlasLayout</code><li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22836<li><strong>Author</strong>: JayPavlina<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, D-Trivial, A-Rendering, S-Ready-For-Final-Review<li><strong>Created</strong>: 2026-02-06T23:31:36Z<li><strong>Merged</strong>: 2026-02-07T00:25:06Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Fixes #22835<h2 id=solution>Solution</h2><p>Divide the x min of the <code>Rect</code> by the width instead of the height<h2 id=testing>Testing</h2><p>I confirmed that all of the sprites in my game now look correct<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a specific bug in Bevy’s sprite rendering system where UV coordinates were calculated incorrectly when using a <code>TextureAtlasLayout</code> with <code>SpriteMesh</code>. The issue manifested as visual artifacts where sprites would display with incorrect texture mapping, showing the wrong portions of texture atlases.<p>The problem originated in the <code>SpriteMaterial</code> implementation, specifically in how UV transformations were calculated for texture atlas regions. When Bevy processes a texture atlas, it needs to map each sprite’s texture coordinates (UVs) to the correct sub-rectangle within the larger atlas texture. This requires calculating a transformation that scales and translates the UV coordinates appropriately.<p>The bug was straightforward: in the UV transformation matrix calculation, the x-coordinate translation was incorrectly using the rectangle’s height instead of its width. This is a classic case of a copy-paste error where the same denominator was used for both axes without considering that x-coordinates should be normalized by width and y-coordinates by height.<p>The fix changes just one character in the codebase - replacing <code>.y</code> with <code>.x</code> in a single line. This minimal change demonstrates how small errors can have significant visual consequences in graphics programming. The UV transformation works by first scaling the UV coordinates to match the aspect ratio of the sub-rectangle within the texture atlas, then translating them to the correct position within that atlas.<p>The impact of this fix is immediate and important for any project using texture atlases with <code>SpriteMesh</code>. Texture atlases are commonly used in games to reduce draw calls by packing multiple sprites into a single texture. Without correct UV mapping, sprites would show incorrect visual content, potentially breaking game mechanics that rely on specific sprite appearances.<p>The fix follows standard computer graphics conventions where texture coordinates are normalized between 0 and 1 across each axis. For a sub-rectangle within a texture atlas defined by <code>rect</code> (with coordinates in texture space), the correct transformation should translate by <code>rect.min.x / texture_width</code> and <code>rect.min.y / texture_height</code>, and scale by <code>rect.width / texture_width</code> and <code>rect.height / texture_height</code>.<p>This bug fix is a good example of how important attention to detail is in graphics programming, where a single incorrect value can cause visible artifacts. It also shows the value of having a simple, testable rendering pipeline where developers can verify that their sprites display correctly after changes.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[SpriteMaterial UV Calculation] --> B[Texture Atlas Layout]
</span><span>    B --> C[UV Transformation Matrix]
</span><span>    C --> D{Affine2 Transformation}
</span><span>    D --> E[Correct: x/width, y/height]
</span><span>    D --> F[Bug: x/height, y/height]
</span><span>    E --> G[Proper Sprite Display]
</span><span>    F --> H[Incorrect UV Mapping]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>File:</strong> <code>crates/bevy_sprite_render/src/sprite_mesh/sprite_material.rs</code><p>This file contains the <code>SpriteMaterial</code> implementation which handles material properties for sprite rendering. The change fixes a bug in the UV transformation calculation when using texture atlases.<p><strong>Key Change:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>uv_transform </span><span style=color:#ed9366>*= </span><span>Affine2</span><span style=color:#ed9366>::</span><span>from_translation(</span><span style=color:#f07171>vec2</span><span>(
</span><span>    rect</span><span style=color:#ed9366>.</span><span>min</span><span style=color:#ed9366>.</span><span>x </span><span style=color:#ed9366>/</span><span> rect</span><span style=color:#ed9366>.</span><span style=color:#f07171>size</span><span>()</span><span style=color:#ed9366>.</span><span>y</span><span style=color:#61676ccc>,  </span><span style=color:#abb0b6;font-style:italic>// Incorrect: dividing x by height
</span><span>    rect</span><span style=color:#ed9366>.</span><span>min</span><span style=color:#ed9366>.</span><span>y </span><span style=color:#ed9366>/</span><span> rect</span><span style=color:#ed9366>.</span><span style=color:#f07171>size</span><span>()</span><span style=color:#ed9366>.</span><span>y</span><span style=color:#61676ccc>,
</span><span>))</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>uv_transform </span><span style=color:#ed9366>*= </span><span>Affine2</span><span style=color:#ed9366>::</span><span>from_translation(</span><span style=color:#f07171>vec2</span><span>(
</span><span>    rect</span><span style=color:#ed9366>.</span><span>min</span><span style=color:#ed9366>.</span><span>x </span><span style=color:#ed9366>/</span><span> rect</span><span style=color:#ed9366>.</span><span style=color:#f07171>size</span><span>()</span><span style=color:#ed9366>.</span><span>x</span><span style=color:#61676ccc>,  </span><span style=color:#abb0b6;font-style:italic>// Correct: dividing x by width
</span><span>    rect</span><span style=color:#ed9366>.</span><span>min</span><span style=color:#ed9366>.</span><span>y </span><span style=color:#ed9366>/</span><span> rect</span><span style=color:#ed9366>.</span><span style=color:#f07171>size</span><span>()</span><span style=color:#ed9366>.</span><span>y</span><span style=color:#61676ccc>,
</span><span>))</span><span style=color:#61676ccc>;
</span></code></pre><p>The fix corrects the UV coordinate calculation by properly normalizing the x-coordinate offset by the rectangle’s width instead of its height. This ensures that when a sprite uses a sub-region of a texture atlas (defined by <code>rect</code>), the UV coordinates are correctly mapped to that specific region within the larger texture.<p>The <code>rect</code> represents the sub-region of the texture atlas that contains the sprite’s image, with coordinates typically in pixels. The division by <code>rect.size().x</code> and <code>rect.size().y</code> normalizes these pixel coordinates to the [0, 1] range expected for UV coordinates, relative to the size of the sub-rectangle rather than the entire texture.<h2 id=further-reading>Further Reading</h2><ol><li><strong>Bevy Sprite Documentation</strong>: The official Bevy documentation on sprites and sprite sheets provides context for how texture atlases work in the engine.<li><strong>Texture Atlas Optimization</strong>: Resources on texture atlasing techniques for game development explain why packing multiple sprites into a single texture improves rendering performance.<li><strong>UV Coordinate Systems</strong>: Computer graphics textbooks and tutorials on UV mapping explain how 2D coordinates map texture pixels to 3D (or 2D) geometry.<li><strong>Affine Transformations</strong>: Linear algebra resources covering affine transformations (translation, scaling, rotation) help understand the transformation matrix used in this fix.</ol><h1 id=full-code-diff>Full Code Diff</h1><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_sprite_render/src/sprite_mesh/sprite_material.rs b/crates/bevy_sprite_render/src/sprite_mesh/sprite_material.rs
</span><span>index f4cb84577b75c..70df39130b099 100644
</span><span style=color:#c594c5>--- a/crates/bevy_sprite_render/src/sprite_mesh/sprite_material.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_sprite_render/src/sprite_mesh/sprite_material.rs
</span><span style=color:#c594c5>@@ -140,7 +140,7 @@ </span><span style=color:#399ee6>impl AsBindGroupShaderType&LTSpriteMaterialUniform> for SpriteMaterial {
</span><span> 
</span><span>             uv_transform *= Affine2::from_scale(ratio);
</span><span>             uv_transform *= Affine2::from_translation(vec2(
</span><span style=color:#f07171>-                rect.min.x / rect.size().y,
</span><span style=color:#86b300>+                rect.min.x / rect.size().x,
</span><span>                 rect.min.y / rect.size().y,
</span><span>             ));
</span><span> 
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_22836.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>