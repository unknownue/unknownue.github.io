<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #23103 Parallelize `mark_meshes_as_changed_if_their_materials_changed`.
        
    </title><meta content="#23103 Parallelize `mark_meshes_as_changed_if_their_materials_changed`." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-24</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-02/pr-23103-zh-cn-20260224>中文</a></div></div><div class=pr-content><h1 id=parallelize-mark-meshes-as-changed-if-their-materials-changed>Parallelize <code>mark_meshes_as_changed_if_their_materials_changed</code></h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Parallelize <code>mark_meshes_as_changed_if_their_materials_changed</code>.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/23103<li><strong>Author</strong>: pcwalton<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: D-Trivial, A-Rendering, C-Performance, S-Ready-For-Final-Review<li><strong>Created</strong>: 2026-02-21T22:32:58Z<li><strong>Merged</strong>: 2026-02-24T02:35:54Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>This tiny system loops over all instances and can actually show up in the profile when the instance count reaches the millions. This PR fixes that. The <code>mark_meshes_as_changed_if_their_materials_changed</code> system in <code>many_cubes --no-cpu-culling --instance-count 3000000</code> (with PR #23101 applied) goes from 2.92 ms per frame to 0.669 ms per frame with this patch applied, a 4.4x speedup.<p>Before and after: <img alt="Screenshot 2026-02-21 143243" height=1800 src=https://github.com/user-attachments/assets/556b0ca2-28e8-4f01-960a-57690ab54fb4 width=2756><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a performance bottleneck in Bevy’s rendering system that becomes significant when working with large numbers of mesh instances. The issue was discovered during profiling of scenarios with millions of mesh instances, where a seemingly simple system was consuming noticeable frame time.<p>The problem centers around the <code>mark_meshes_as_changed_if_their_materials_changed</code> system, which runs in Bevy’s ECS (Entity Component System). This system is responsible for detecting when materials associated with meshes have changed and marking those meshes as changed so that the rendering system can properly update them. When material properties change (such as color, texture, or other material parameters), the system needs to notify the renderer that the affected meshes require re-rendering.<p>The original implementation used a sequential loop to iterate over all meshes with changed materials:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>for mut</span><span> mesh </span><span style=color:#ed9366>in &</span><span style=color:#fa6e32>mut</span><span> changed_meshes_query {
</span><span>    mesh</span><span style=color:#ed9366>.</span><span style=color:#f07171>set_changed</span><span>()</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>While this approach works correctly and is efficient for small numbers of meshes, it becomes a performance issue when dealing with millions of instances. The problem is that the loop processes each mesh sequentially on a single CPU core, which doesn’t take advantage of modern multi-core processors.<p>The solution implemented in this PR is straightforward: replace the sequential loop with a parallel iteration using Bevy’s parallel query API. The key insight is that marking meshes as changed is an embarrassingly parallel operation - each mesh can be processed independently without requiring synchronization with other meshes.<p>The implementation change is minimal but impactful:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>changed_meshes_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>par_iter_mut</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>for_each</span><span>(|</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>mesh</span><span>| {
</span><span>    mesh</span><span style=color:#ed9366>.</span><span style=color:#f07171>set_changed</span><span>()</span><span style=color:#61676ccc>;
</span><span>})</span><span style=color:#61676ccc>;
</span></code></pre><p>This change leverages Bevy’s built-in parallel iteration capabilities through the <code>par_iter_mut()</code> method, which automatically distributes the work across available CPU cores. The <code>for_each</code> method then applies the <code>set_changed()</code> operation to each mesh in parallel.<p>The performance improvement is substantial: in a benchmark with 3 million cube instances (using the <code>many_cubes</code> example with <code>--no-cpu-culling --instance-count 3000000</code>), the system’s execution time dropped from 2.92 ms to 0.669 ms per frame - a 4.4x speedup. This improvement directly translates to better frame rates and more CPU time available for other game logic and systems.<p>The change is particularly elegant because it maintains the same safety guarantees as the sequential version. Bevy’s parallel query system ensures thread safety by only allowing parallel iteration when the operations are safe to run concurrently. In this case, marking each mesh as changed doesn’t require synchronization between threads since each mesh is an independent entity.<p>This optimization demonstrates an important principle in game engine development: even small, simple systems can become performance bottlenecks at scale. What works efficiently for hundreds or thousands of entities may need reconsideration for millions of entities. The solution also shows the value of Bevy’s design, which makes parallel processing accessible through simple API changes rather than requiring complex manual thread management.<p>The PR is labeled as “trivial” (D-Trivial) because the code change is minimal and the concept is straightforward, but the performance impact is significant for large-scale scenarios. This makes it an excellent example of a high-leverage optimization - a small change with substantial benefits for specific use cases.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Material Change Detection System] --> B[Sequential Iteration]
</span><span>    A --> C[Parallel Iteration]
</span><span>    B --> D[Single-threaded processing]
</span><span>    C --> E[Multi-threaded processing]
</span><span>    D --> F[2.92 ms for 3M instances]
</span><span>    E --> G[0.669 ms for 3M instances]
</span><span>    F --> H[4.4x slower]
</span><span>    G --> I[4.4x faster]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-pbr-src-material-rs><code>crates/bevy_pbr/src/material.rs</code></h3><p>This file contains the material system implementation for Bevy’s PBR (Physically Based Rendering) pipeline. The change modifies a system function that handles material change detection for meshes.<p><strong>What changed and why</strong>: The system <code>mark_meshes_as_changed_if_their_materials_changed</code> was modified to use parallel iteration instead of sequential iteration when marking meshes as changed. This optimization provides significant performance improvements when processing large numbers of mesh instances.<p><strong>Code change</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>for mut</span><span> mesh </span><span style=color:#ed9366>in &</span><span style=color:#fa6e32>mut</span><span> changed_meshes_query {
</span><span>    mesh</span><span style=color:#ed9366>.</span><span style=color:#f07171>set_changed</span><span>()</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>changed_meshes_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>par_iter_mut</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>for_each</span><span>(|</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>mesh</span><span>| {
</span><span>    mesh</span><span style=color:#ed9366>.</span><span style=color:#f07171>set_changed</span><span>()</span><span style=color:#61676ccc>;
</span><span>})</span><span style=color:#61676ccc>;
</span></code></pre><p><strong>How it relates to the overall purpose</strong>: This change directly addresses the performance bottleneck described in the PR. By parallelizing the mesh marking operation, the system can process millions of instances much more efficiently, reducing frame time by 4.4x in the benchmark scenario.<h2 id=further-reading>Further Reading</h2><ol><li><p><strong>Bevy ECS Parallel Queries</strong>: The official Bevy documentation on parallel query iteration provides details on how to use <code>par_iter()</code> and <code>par_iter_mut()</code> for performance optimization.</p><li><p><strong>Embarrassingly Parallel Problems</strong>: This optimization is a classic example of an embarrassingly parallel problem where tasks can be executed independently with minimal synchronization.</p><li><p><strong>Bevy Performance Guidelines</strong>: The Bevy engine’s performance optimization patterns and best practices for writing efficient systems.</p><li><p><strong>CPU Parallelism in Game Engines</strong>: General techniques for leveraging multi-core processors in real-time systems like game engines.</p><li><p><strong>The <code>many_cubes</code> Benchmark</strong>: Understanding Bevy’s benchmarking examples and how to use them to identify performance bottlenecks.</p></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_23103.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>