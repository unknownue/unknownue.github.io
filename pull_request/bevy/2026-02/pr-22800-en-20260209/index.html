<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22800 Fix Gizmos not drawing `On<Pointer<Drag>>`, Observers generally, and Triggered Systems
        
    </title><meta content="#22800 Fix Gizmos not drawing `On<Pointer<Drag>>`, Observers generally, and Triggered Systems" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-09</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-02/pr-22800-zh-cn-20260209>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix Gizmos not drawing <code>On&LTPointer&LTDrag>></code>, Observers generally, and Triggered Systems<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22800<li><strong>Author</strong>: kfc35<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-ECS, S-Ready-For-Final-Review, A-Gizmos, D-Straightforward<li><strong>Created</strong>: 2026-02-04T02:42:02Z<li><strong>Merged</strong>: 2026-02-09T02:36:30Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Fixes #22485<li>Fixes #14566<li>Fixes #19119</ul><h2 id=solution>Solution</h2><ul><li>Implement <code>queue()</code> for the <code>Gizmos</code> <code>SystemParam</code>.<li>After much debugging, I discovered that the <code>Gizmos</code> system parameter never had <code>apply()</code> called on it when it was being used within an observer, which was why its internal <code>SystemBuffer</code> (<code>GizmoBuffer</code>) kept growing indefinitely. I saw that <code>SystemParam</code>’s also have a <code>queue()</code> function and was curious whether that was being called instead… and it was! So, I just implemented <code>queue()</code> in the same way that <code>apply()</code> was (after making sure it was OK to use a <code>DeferredWorld</code> in that way… and seems like it is OK?), and it solves the issue.<li>Edit: I guess this problem has been described before in #14597 , where the solution described there as well is to implement <code>apply()</code><li>Disclaimer: Not an ECS master, so someone with ECS mastery can make sure what I wrote makes sense.</ul><h2 id=testing>Testing</h2><p>The reproduction example in #22485 works now. A white square gizmo is drawn in the center if you drag inside the window. I also tested against the examples in #14566 (both of them) and #19119 and the missing gizmos are drawn.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This pull request addresses a subtle bug in Bevy’s ECS system where gizmos wouldn’t render correctly when used within observers, triggered systems, or specific event handlers like <code>On&LTPointer&LTDrag>></code>. The issue manifested as gizmos not appearing at all in these contexts, which frustrated developers trying to use Bevy’s debugging tools in reactive systems.<p>The root cause was discovered through systematic debugging: the <code>Gizmos</code> system parameter, which implements Bevy’s <code>SystemParam</code> trait, was missing a critical piece of functionality. In Bevy’s ECS architecture, system parameters have two main methods for managing their internal state: <code>apply()</code> and <code>queue()</code>. The <code>apply()</code> method is called in standard systems to flush buffered data to the world, while <code>queue()</code> serves a similar purpose but is specifically designed for use in observers and triggered systems where immediate world access isn’t available.<p>The developer discovered that when gizmos were used within observers, the <code>apply()</code> method was never being called. Instead, the ECS scheduler was calling the <code>queue()</code> method, but the <code>Gizmos</code> parameter hadn’t implemented it. This meant that the internal <code>GizmoBuffer</code> (a <code>SystemBuffer</code> that stores gizmo drawing commands) kept accumulating data without ever being flushed. The buffer would grow indefinitely, but the commands were never applied to the rendering system, resulting in invisible gizmos.<p>The solution was straightforward once the problem was understood: implement the missing <code>queue()</code> method. The implementation mirrors the existing <code>apply()</code> method but uses a <code>DeferredWorld</code> instead of direct world access. This is the standard pattern for system parameters that need to work in both regular systems and observers. The <code>queue()</code> method delegates to the underlying <code>GizmosState</code> type, which already had both <code>apply()</code> and <code>queue()</code> implementations available.<p>What’s interesting about this fix is that it reveals an important aspect of Bevy’s ECS design: system parameters must be carefully implemented to work across different execution contexts. The <code>SystemParam</code> trait provides both <code>apply()</code> and <code>queue()</code> methods for this reason, and parameters that don’t implement both will fail silently in certain contexts. This bug had been reported multiple times over several months (#14566, #19119, #22485), indicating it was a persistent pain point for developers.<p>The implementation itself is minimal - just four lines of code that add the missing method. However, the debugging process required to identify the issue was non-trivial. The developer had to understand Bevy’s ECS internals well enough to trace why gizmos weren’t rendering and recognize that the missing <code>queue()</code> method was the culprit. This highlights the importance of comprehensive trait implementations in systems programming, where missing a single method can lead to subtle, context-dependent bugs.<p>The fix ensures that gizmos work consistently across all system types in Bevy, making the debugging tools more reliable. This is particularly important for reactive programming patterns using observers, which are becoming increasingly common in Bevy applications for handling events and state changes.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Observer System] --> B[calls queue() method]
</span><span>    B --> C{Gizmos SystemParam}
</span><span>    C -->|Missing queue()| D[Buffer accumulates, never flushes]
</span><span>    C -->|With queue()| E[Buffer flushes correctly]
</span><span>    D --> F[Gizmos not drawn]
</span><span>    E --> G[Gizmos drawn correctly]
</span><span>    
</span><span>    H[Regular System] --> I[calls apply() method]
</span><span>    I --> C
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-gizmos-src-gizmos-rs-4-0><code>crates/bevy_gizmos/src/gizmos.rs</code> (+4/-0)</h3><p>This file contains the <code>Gizmos</code> system parameter implementation. The change adds the missing <code>queue()</code> method to ensure the parameter works correctly in observer contexts.<p><strong>Key Modification:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// File: crates/bevy_gizmos/src/gizmos.rs
</span><span style=color:#abb0b6;font-style:italic>// Before (relevant section):
</span><span style=color:#fa6e32>impl</span><span>&LTConfig</span><span style=color:#61676ccc>:</span><span> GizmoConfigGroup, Clear</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>'static </span><span style=color:#ed9366>+ </span><span style=color:#55b4d4;font-style:italic>Send </span><span style=color:#ed9366>+ </span><span style=color:#55b4d4;font-style:italic>Sync</span><span>> SystemParam </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>Gizmos</span><span><'</span><span style=color:#ed9366>_</span><span>, '</span><span style=color:#ed9366>_</span><span>, Config, Clear> {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... existing apply() method ...
</span><span>    
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Missing queue() method caused issues in observers
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>impl</span><span>&LTConfig</span><span style=color:#61676ccc>:</span><span> GizmoConfigGroup, Clear</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>'static </span><span style=color:#ed9366>+ </span><span style=color:#55b4d4;font-style:italic>Send </span><span style=color:#ed9366>+ </span><span style=color:#55b4d4;font-style:italic>Sync</span><span>> SystemParam </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>Gizmos</span><span><'</span><span style=color:#ed9366>_</span><span>, '</span><span style=color:#ed9366>_</span><span>, Config, Clear> {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... existing apply() method ...
</span><span>    
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Added queue() method for observer compatibility
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>queue</span><span>(</span><span style=color:#ff8f40>state</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut Self</span><span style=color:#ed9366>::</span><span>State, </span><span style=color:#ff8f40>system_meta</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>SystemMeta, </span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>:</span><span> DeferredWorld) {
</span><span>        GizmosState</span><span style=color:#ed9366>::</span><span>&LTConfig, Clear></span><span style=color:#ed9366>::</span><span>queue(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> state</span><span style=color:#ed9366>.</span><span>state</span><span style=color:#61676ccc>,</span><span> system_meta</span><span style=color:#61676ccc>,</span><span> world)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>    
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... rest of implementation ...
</span><span>}
</span></code></pre><p>The change adds the <code>queue()</code> method implementation that delegates to the underlying <code>GizmosState::queue()</code> method. This ensures that when gizmos are used within observers or triggered systems, their drawing commands are properly queued and eventually flushed to the rendering system.<h2 id=further-reading>Further Reading</h2><ol><li><strong>Bevy ECS SystemParam Documentation</strong>: Understanding the <code>SystemParam</code> trait and its methods (<code>apply()</code>, <code>queue()</code>, etc.) is essential for working with Bevy’s ECS system.<li><strong>Bevy Observers Guide</strong>: The official Bevy documentation on observers and event-driven programming patterns.<li><strong>System Buffers in ECS</strong>: How system buffers work and when they need to be flushed (related to <code>SystemBuffer</code> trait).<li><strong>Issue #14597</strong>: The previous issue that described a similar problem and mentioned implementing <code>apply()</code> as a solution, providing additional context about this class of bugs.<li><strong>DeferredWorld in Bevy</strong>: Understanding the <code>DeferredWorld</code> type and how it enables safe world access in specific ECS contexts.</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_22800.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>