<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22860
        
    </title><meta content=#22860 property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-07</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2026-02/pr-22860-en-20260207>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=title>Title</h1><p>Fix wrong component sync for GeneratedEnvironmentMapLight<h2 id=ji-ben-zi-xun>基本資訊</h2><ul><li><strong>標題</strong>: Fix wrong component sync for GeneratedEnvironmentMapLight<li><strong>PR連結</strong>: https://github.com/bevyengine/bevy/pull/22860<li><strong>作者</strong>: kristoff3r<li><strong>狀態</strong>: MERGED<li><strong>標籤</strong>: C-Bug, D-Trivial, A-Rendering, S-Ready-For-Final-Review<li><strong>創建時間</strong>: 2026-02-07T21:42:53Z<li><strong>合併時間</strong>: 2026-02-07T23:23:20Z<li><strong>合併者</strong>: alice-i-cecile</ul><h2 id=miao-shu-fan-yi>描述翻譯</h2><h3 id=objective>Objective</h3><p>修復由 #22766 引入的以下日誌垃圾訊息（以及錯誤的同步行為）：<pre style=color:#61676c;background-color:#fafafa><code><span>ERROR bevy_pbr::cluster: Clustered light or decal 5v0 had no assigned index!
</span></code></pre><h3 id=solution>Solution</h3><p>這裡的元件命名方式很有趣。我們有三個元件：<ul><li><code>EnvironmentMapLight</code><li><code>GeneratedEnvironmentMapLight</code><li><code>RenderEnvironmentMap</code></ul><p>當我添加 <code>SyncComponent</code> 的實作時，我使用模式匹配來檢查前兩個名稱，並假設 <code>EnvironmentMapLight</code> 是主世界元件，而 <code>GeneratedEnvironmentMapLight</code> 在渲染世界。<p>實際上，<code>GeneratedEnvironmentMapLight</code> 是一種生成 <code>EnvironmentMapLight</code> 的特定方式，而渲染世界中的實體叫做 <code>RenderEnvironmentMap</code>。修正 <code>SyncComponent</code> 的實作以反映這一點可以解決問題。<p>我仍然感覺在這次修復之後還有其他問題：<ul><li><code>GeneratedEnvironmentMapLight</code> 真的需要一個更好的名字（<code>GenerateEnvironmentMapLight</code>？ <code>RuntimeEnvironmentMapLight</code>？），以及更好的文件。<li>我認為它仍然缺少一些同步邏輯，就我所知，如果 <code>GeneratedEnvironmentMapLight</code> 被更新或刪除，沒有任何東西處理生成的 <code>EnvironmentMapLight</code>？我沒有深入研究，所以可能漏掉了什麼。</ul><h3 id=testing>Testing</h3><p>已使用 <code>light_probe_blending</code> 和 <code>reflection_probes</code> 範例進行測試。<h2 id=ben-prde-gu-shi>本PR的故事</h2><p>這個PR源自於一個由之前的改動（PR #22766）不小心引入的錯誤。錯誤表現為在日誌中重複出現的錯誤訊息 <code>ERROR bevy_pbr::cluster: Clustered light or decal 5v0 had no assigned index!</code>。這不只是日誌汙染，更意味著光照系統沒有正確處理特定的光探測元件，導致同步邏輯失效和潛在的渲染錯誤。<p>問題的核心在於對幾個相關但功能不同的元件產生了混淆。在Bevy的PBR渲染系統中，處理環境光貼圖（Environment Map）涉及三個關鍵的Component：<ol><li><code>EnvironmentMapLight</code>: 代表最終用於著色的環境光資料。<li><code>GeneratedEnvironmentMapLight</code>: 一個標記元件，指示系統需要為此實體<strong>生成</strong>一個<code>EnvironmentMapLight</code>。<li><code>RenderEnvironmentMap</code>: 在渲染世界（Render World）中存在的元件，負責持有渲染所需的GPU資源（如紋理）。</ol><p>這些元件橫跨了Bevy的應用世界（App World）與渲染世界這兩個隔離的ECS環境。為了讓資料能在兩個世界間傳遞，Bevy使用了<code>SyncComponent</code>機制。在問題發生前，開發者錯誤地將<code>SyncComponent</code>實作在了<code>EnvironmentMapLight</code>上，並指定其輸出為<code>GeneratedEnvironmentMapLight</code>。<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 錯誤的實作（修改前）
</span><span style=color:#fa6e32>impl </span><span>SyncComponent&LTEnvironmentMapGenerationPlugin> </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>EnvironmentMapLight </span><span>{
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Out </span><span style=color:#ed9366>=</span><span> GeneratedEnvironmentMapLight</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>這個實作基於一個錯誤的假設：以為<code>EnvironmentMapLight</code>是主世界的主要元件，需要同步到渲染世界成為<code>GeneratedEnvironmentMapLight</code>。但實際上，需要從主世界同步到渲染世界的邏輯是相反的：主世界的<code>GeneratedEnvironmentMapLight</code>（一個生成指令）需要被同步，並在渲染世界轉化為實際持有資源的<code>RenderEnvironmentMap</code>。<p>這個錯誤導致了連鎖反應：當系統試圖為一個標記了<code>GeneratedEnvironmentMapLight</code>的實體生成環境貼圖時，由於同步路徑錯誤，渲染世界可能沒有收到正確的指令或資料，最終導致該實體的光照資訊未被分配索引，觸發了日誌中的錯誤。<p>解決方案非常直接：修正<code>SyncComponent</code>的實作，讓它反映正確的同步方向。我們將同步的來源（主世界元件）從<code>EnvironmentMapLight</code>改為<code>GeneratedEnvironmentMapLight</code>，並將同步的目標（渲染世界元件）指定為<code>RenderEnvironmentMap</code>。<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 正確的實作（修改後）
</span><span style=color:#fa6e32>impl </span><span>SyncComponent&LTEnvironmentMapGenerationPlugin> </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>GeneratedEnvironmentMapLight </span><span>{
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Out </span><span style=color:#ed9366>=</span><span> RenderEnvironmentMap</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>與此同時，PR中還清理了兩個相關的查詢（Query），移除了多餘的<code>With&LTRenderEnvironmentMap></code>篩選條件，因為函式<code>prepare_generated_environment_map_bind_groups</code>本身就只查詢包含<code>RenderEnvironmentMap</code>的實體，這個篩選是冗餘的。<p>這個修復雖然很小，只涉及幾行程式碼，但精確地糾正了系統對元件角色和資料流的誤解。它確保了當開發者在主世界為一個實體添加<code>GeneratedEnvironmentMapLight</code>元件時，這個「生成環境貼圖」的指令能夠被可靠地傳遞到渲染世界，並轉化為具體的<code>RenderEnvironmentMap</code>資源準備工作。<p>PR作者在描述中也指出了潛在的改進空間。首先，元件的命名具有誤導性。<code>GeneratedEnvironmentMapLight</code>聽起來像是一個已經生成的、具體的物件，但實際上它是一個「請求生成」的標記或配置。像<code>EnvironmentMapLightGenerator</code>或<code>EnvironmentMapLightSource</code>這樣的命名可能更能反映其意圖。其次，目前可能缺乏當<code>GeneratedEnvironmentMapLight</code>元件被更新或移除時，對已生成的<code>EnvironmentMapLight</code>進行清理或更新的邏輯，這可能會導致資源洩漏或陳舊資料。不過，這屬於更進階的狀態管理問題，可以在後續的迭代中解決。<p>總的來說，這是一個典型的「小而重要」的修復。它不改變架構，但修正了一個關鍵的資料流斷點，確保了環境光貼圖生成系統的基礎功能正常運作，並消除了令人困惑的錯誤日誌。<h2 id=shi-jue-hua-biao-shi>視覺化表示</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[GeneratedEnvironmentMapLight&LTbr/>主世界/標記元件] -->|SyncComponent 同步| B[RenderEnvironmentMap&LTbr/>渲染世界/資源持有者]
</span><span>    B --> C[EnvironmentMapLight&LTbr/>最終光照資料]
</span></code></pre><p><em>圖解：修正後的元件同步關係。<code>GeneratedEnvironmentMapLight</code>作為指令從主世界同步到渲染世界，產生<code>RenderEnvironmentMap</code>，後者用於生成最終的<code>EnvironmentMapLight</code>。</em><h2 id=guan-jian-dang-an-geng-gai>關鍵檔案更改</h2><ul><li><code>crates/bevy_pbr/src/light_probe/generate.rs</code> (+5/-8)</ul><p>這是本次PR中唯一被修改的檔案，所有變更都圍繞著修正元件同步邏輯和清理冗餘程式碼。<ol><li><p><strong>修正 <code>SyncComponent</code> 實作</strong>：這是核心修復，確保了正確的元件從主世界同步到渲染世界。</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 檔案: crates/bevy_pbr/src/light_probe/generate.rs
</span><span style=color:#abb0b6;font-style:italic>// 修改前:
</span><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_plugins</span><span>(SyncComponentPlugin</span><span style=color:#ed9366>::</span><span>&LTEnvironmentMapLight, </span><span style=color:#fa6e32>Self</span><span>></span><span style=color:#ed9366>::</span><span>default())
</span><span style=color:#abb0b6;font-style:italic>// ...
</span><span style=color:#fa6e32>impl </span><span>SyncComponent&LTEnvironmentMapGenerationPlugin> </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>EnvironmentMapLight </span><span>{
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Out </span><span style=color:#ed9366>=</span><span> GeneratedEnvironmentMapLight</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 修改後:
</span><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_plugins</span><span>(SyncComponentPlugin</span><span style=color:#ed9366>::</span><span>&LTGeneratedEnvironmentMapLight, </span><span style=color:#fa6e32>Self</span><span>></span><span style=color:#ed9366>::</span><span>default())
</span><span style=color:#abb0b6;font-style:italic>// ...
</span><span style=color:#fa6e32>impl </span><span>SyncComponent&LTEnvironmentMapGenerationPlugin> </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>GeneratedEnvironmentMapLight </span><span>{
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Out </span><span style=color:#ed9366>=</span><span> RenderEnvironmentMap</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><li><p><strong>清理冗餘查詢篩選器</strong>：在函式 <code>prepare_generated_environment_map_bind_groups</code> 中，查詢語句移除了不必要的 <code>With&LTRenderEnvironmentMap></code> 篩選條件，因為查詢的型別已經包含了 <code>&RenderEnvironmentMap</code>，這使得篩選器變得多餘。同時，移除了不必要的 <code>use</code> 宣告。</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 檔案: crates/bevy_pbr/src/light_probe/generate.rs
</span><span style=color:#abb0b6;font-style:italic>// 修改前 (引入和查詢):
</span><span style=color:#fa6e32>use </span><span>bevy_ecs</span><span style=color:#ed9366>::</span><span>query</span><span style=color:#ed9366>::</span><span>{With</span><span style=color:#61676ccc>,</span><span> Without}</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// ...
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>prepare_generated_environment_map_bind_groups</span><span>(
</span><span>    </span><span style=color:#ff8f40>light_probes</span><span style=color:#61676ccc>: </span><span>Query<
</span><span>        (Entity, </span><span style=color:#ed9366>&</span><span>IntermediateTextures, </span><span style=color:#ed9366>&</span><span>RenderEnvironmentMap),
</span><span>        With&LTRenderEnvironmentMap>, </span><span style=color:#abb0b6;font-style:italic>// 冗餘的篩選器
</span><span>    >,
</span><span>    ...
</span><span>)
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 修改後:
</span><span style=color:#fa6e32>use </span><span>bevy_ecs</span><span style=color:#ed9366>::</span><span>query</span><span style=color:#ed9366>::</span><span>Without</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// 移除了 With
</span><span style=color:#abb0b6;font-style:italic>// ...
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>prepare_generated_environment_map_bind_groups</span><span>(
</span><span>    </span><span style=color:#ff8f40>light_probes</span><span style=color:#61676ccc>: </span><span>Query<(Entity, </span><span style=color:#ed9366>&</span><span>IntermediateTextures, </span><span style=color:#ed9366>&</span><span>RenderEnvironmentMap)>, </span><span style=color:#abb0b6;font-style:italic>// 移除了 With 篩選器
</span><span>    ...
</span><span>)
</span></code></pre></ol><h2 id=yan-shen-yue-du>延伸閱讀</h2><p>對於想深入了解此PR背後概念的讀者，可以參考以下資源：<ol><li><p><strong>Bevy 官方文件 - 渲染階段與子應用程式</strong>：</p> <ul><li>瞭解 Bevy 如何將應用邏輯（App World）與渲染邏輯（Render World）分離，這是理解 <code>SyncComponent</code> 機制的前提。<li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/ target=_blank>Bevy 官方手冊</a> 中關於「渲染」和「階段」的章節。</ul><li><p><strong>Bevy 原始碼中的 <code>bevy_render::renderer::render_resource</code></strong>：</p> <ul><li>研究 <code>SyncComponent</code> trait 及其相關的 <code>SyncComponentPlugin</code>，以理解元件跨世界同步的通用模式。<li>查看 <code>bevy_ecs::schedule::IntoSystemConfigs</code> 來了解系統如何被配置和排程到不同的 <code>Schedule</code> 和 <code>App</code> 中。</ul><li><p><strong>基於圖像的照明技術</strong>：</p> <ul><li>瞭解什麼是環境光貼圖，以及它在 PBR 渲染管線中的作用，有助於理解這些元件的業務目的。<li>搜尋「Image-based lighting」和「Environment Map」相關的圖形學資料。</ul></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_22860.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>