<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22926 Fix clippy issues with `bevy_platform::dirs` on Windows
        
    </title><meta content="#22926 Fix clippy issues with `bevy_platform::dirs` on Windows" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-12</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-02/pr-22926-zh-cn-20260212>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix clippy issues with <code>bevy_platform::dirs</code> on Windows<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22926<li><strong>Author</strong>: greeble-dev<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: D-Trivial, O-Windows, C-Code-Quality, S-Ready-For-Final-Review, A-Utils<li><strong>Created</strong>: 2026-02-12T11:22:48Z<li><strong>Merged</strong>: 2026-02-12T18:13:14Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><p>Fixes clippy issues that were introduced by #22891 and only occur on Windows.<p>Tested on Win10 by hacking the <code>hello_world</code> example to print <code>preferences_dir()</code>.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This pull request addresses a specific issue with Clippy lint warnings that emerged after a previous change to the Bevy engine’s platform abstraction layer. The problem was isolated to the Windows implementation and represented a straightforward fix that aligns with Rust best practices for unsafe code handling.<p>The context begins with PR #22891, which introduced changes to the <code>bevy_platform</code> crate. This crate serves as a platform abstraction layer, providing consistent APIs across different operating systems. During the development of that PR, the Windows-specific directory handling code was modified, and in doing so, it introduced two Clippy lint warnings that only manifested on Windows builds. These warnings weren’t breaking the compilation - the code was functionally correct - but they represented style and safety guideline violations that the Clippy tool rightfully flagged.<p>The specific warnings centered around two issues. First, the code was using <code>#[allow(unsafe_code)]</code> attribute, which is a blanket allowance for unsafe code in the function. Clippy recommends using the more specific <code>#[expect]</code> attribute when possible, which not only silences the warning but also documents why the unsafe code is necessary and tracks when the warning might become unnecessary in the future. Second, the code was importing and using <code>std::ffi::c_void</code> and <code>std::ptr::null_mut()</code> from the standard library when it should have been using their <code>core</code> equivalents. This is important because <code>bevy_platform</code> is a <code>no_std</code> crate, meaning it doesn’t have access to the full standard library - only the core library and alloc crate.<p>The developer approached this with a minimal, targeted fix. They updated the attribute from <code>#[allow(unsafe_code)]</code> to <code>#[expect(unsafe_code, reason = "Uses unsafe Windows API functions")]</code>. This change provides better documentation about why unsafe code is necessary in this context - specifically because the function calls Windows API functions that require unsafe blocks. The <code>expect</code> attribute tells Clippy that this unsafe code is expected and intentional, and includes a reason that helps other developers understand why the unsafe code exists.<p>The second part of the fix addressed the import issues. The code was updated to use <code>core::ffi::c_void</code> instead of <code>std::ffi::c_void</code>, and <code>core::ptr::null_mut()</code> instead of <code>std::ptr::null_mut()</code>. Additionally, <code>slice</code> was imported from <code>alloc::slice</code> instead of <code>std::slice</code>. These changes ensure compatibility with the <code>no_std</code> environment while maintaining identical functionality. The <code>alloc</code> crate provides allocation-related types and functions without the full standard library, making it appropriate for this context.<p>From a technical perspective, this fix demonstrates an important pattern in Rust development: properly handling the transition between <code>std</code> and <code>no_std</code> contexts. When working with platform-specific code that interacts with operating system APIs, developers must be careful about their dependencies. The Windows API bindings (<code>windows-sys</code> crate) are designed to work in <code>no_std</code> environments, so the surrounding code should also avoid <code>std</code> dependencies unless absolutely necessary.<p>The implementation is technically sound because:<ol><li><code>core::ffi::c_void</code> is identical to <code>std::ffi::c_void</code> in a <code>no_std</code> context<li><code>core::ptr::null_mut()</code> provides the same null pointer constant as <code>std::ptr::null_mut()</code><li><code>alloc::slice::from_raw_parts</code> functions identically to <code>std::slice::from_raw_parts</code><li>The <code>expect</code> attribute provides better documentation than <code>allow</code> while achieving the same suppression effect</ol><p>The impact of this change is primarily about code quality and maintainability. By fixing these Clippy warnings, the codebase maintains a cleaner lint profile, which makes it easier to spot actual problems in future development. The improved documentation through the <code>expect</code> attribute helps future maintainers understand why unsafe code is necessary in this location. The proper use of <code>core</code> and <code>alloc</code> instead of <code>std</code> ensures the crate remains properly <code>no_std</code> compatible, which is essential for its role as a platform abstraction layer.<p>One technical lesson from this PR is the importance of testing on all target platforms after making changes to platform-specific code. The original issue only manifested on Windows, so it could have been missed if testing was only done on other platforms. The author’s testing approach - modifying the <code>hello_world</code> example to print the <code>preferences_dir()</code> output - was a practical way to verify the fix worked correctly without breaking functionality.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[PR #22891 changes] --> B[Introduces Clippy warnings on Windows]
</span><span>    B --> C[Developer identifies two issues]
</span><span>    C --> D[Issue 1: #[allow] attribute]
</span><span>    C --> E[Issue 2: std vs core/alloc imports]
</span><span>    D --> F[Fix: Change to #[expect] with reason]
</span><span>    E --> G[Fix: Import from core and alloc instead of std]
</span><span>    F --> H[Cleaner code with better documentation]
</span><span>    G --> I[Proper no_std compatibility]
</span><span>    H --> J[Fixed Clippy issues on Windows]
</span><span>    I --> J
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-platform-src-dirs-windows-rs-6-5><code>crates/bevy_platform/src/dirs/windows.rs</code> (+6/-5)</h3><p>This file contains the Windows-specific implementation for retrieving application directory paths. The changes fix Clippy warnings by updating unsafe code attributes and standard library imports to be compatible with the crate’s <code>no_std</code> environment.<p><strong>Key modifications:</strong><ol><li><strong>Import updates for <code>no_std</code> compatibility</strong>:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>extern crate</span><span> windows_sys </span><span style=color:#ed9366>as</span><span> windows</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>use </span><span>std</span><span style=color:#ed9366>::</span><span>ffi</span><span style=color:#ed9366>::</span><span>{</span><span style=color:#fa6e32>c_void</span><span style=color:#61676ccc>,</span><span> OsString}</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>use </span><span>std</span><span style=color:#ed9366>::</span><span>os</span><span style=color:#ed9366>::</span><span>windows</span><span style=color:#ed9366>::</span><span>ffi</span><span style=color:#ed9366>::</span><span>OsStringExt</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>use </span><span>std</span><span style=color:#ed9366>::</span><span>path</span><span style=color:#ed9366>::</span><span>PathBuf</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>use </span><span>std</span><span style=color:#ed9366>::</span><span>slice</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>extern crate</span><span> windows_sys </span><span style=color:#ed9366>as</span><span> windows</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>use </span><span>alloc</span><span style=color:#ed9366>::</span><span>slice</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>use </span><span>core</span><span style=color:#ed9366>::</span><span>ffi</span><span style=color:#ed9366>::</span><span style=color:#fa6e32>c_void</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>use </span><span>std</span><span style=color:#ed9366>::</span><span>ffi</span><span style=color:#ed9366>::</span><span>OsString</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>use </span><span>std</span><span style=color:#ed9366>::</span><span>os</span><span style=color:#ed9366>::</span><span>windows</span><span style=color:#ed9366>::</span><span>ffi</span><span style=color:#ed9366>::</span><span>OsStringExt</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>use </span><span>std</span><span style=color:#ed9366>::</span><span>path</span><span style=color:#ed9366>::</span><span>PathBuf</span><span style=color:#61676ccc>;
</span></code></pre><ol start=2><li><strong>Improved unsafe code documentation</strong>:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>allow</span><span>(unsafe_code)]
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>expect</span><span>(unsafe_code</span><span style=color:#61676ccc>,</span><span> reason </span><span style=color:#ed9366>= </span><span style=color:#86b300>"Uses unsafe Windows API functions"</span><span>)]
</span></code></pre><ol start=3><li><strong>Core library usage instead of std</strong>:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let mut</span><span> path_ptr</span><span style=color:#61676ccc>: </span><span>windows</span><span style=color:#ed9366>::</span><span>core</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>PWSTR </span><span style=color:#ed9366>= </span><span>std</span><span style=color:#ed9366>::</span><span>ptr</span><span style=color:#ed9366>::</span><span>null_mut()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> result </span><span style=color:#ed9366>= </span><span>Shell</span><span style=color:#ed9366>::</span><span>SHGetKnownFolderPath(</span><span style=color:#ed9366>&</span><span>folder_id</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>, </span><span>std</span><span style=color:#ed9366>::</span><span>ptr</span><span style=color:#ed9366>::</span><span>null_mut()</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> path_ptr)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let mut</span><span> path_ptr</span><span style=color:#61676ccc>: </span><span>windows</span><span style=color:#ed9366>::</span><span>core</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>PWSTR </span><span style=color:#ed9366>= </span><span>core</span><span style=color:#ed9366>::</span><span>ptr</span><span style=color:#ed9366>::</span><span>null_mut()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> result </span><span style=color:#ed9366>= </span><span>Shell</span><span style=color:#ed9366>::</span><span>SHGetKnownFolderPath(</span><span style=color:#ed9366>&</span><span>folder_id</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>, </span><span>core</span><span style=color:#ed9366>::</span><span>ptr</span><span style=color:#ed9366>::</span><span>null_mut()</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> path_ptr)</span><span style=color:#61676ccc>;
</span></code></pre><p>The changes ensure that the Windows directory handling code properly uses <code>core</code> and <code>alloc</code> crates instead of <code>std</code>, maintaining compatibility with the <code>no_std</code> environment while fixing Clippy warnings.<h2 id=further-reading>Further Reading</h2><ol><li><p><strong>Rust <code>no_std</code> Programming</strong>: The Rust Embedded Working Group’s book on embedded Rust provides excellent coverage of <code>no_std</code> programming patterns: https://docs.rust-embedded.org/book/intro/no-std.html</p><li><p><strong>Clippy Lints</strong>: Official documentation for Rust’s Clippy linter, including the difference between <code>allow</code> and <code>expect</code> attributes: https://doc.rust-lang.org/clippy/</p><li><p><strong>Windows API in Rust</strong>: The <code>windows-sys</code> crate documentation for working with Windows APIs in Rust: https://docs.rs/windows-sys/latest/windows_sys/</p><li><p><strong>Unsafe Code Guidelines</strong>: Rust’s official unsafe code guidelines document: https://rust-lang.github.io/unsafe-code-guidelines/</p><li><p><strong>Bevy Platform Abstraction</strong>: Bevy’s architecture documentation on platform abstraction layers: https://bevyengine.org/learn/book/getting-started/ecs/</p></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_22926.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>