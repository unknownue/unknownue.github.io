<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22951 ignore ambiguities on MainWorld and caches
        
    </title><meta content="#22951 ignore ambiguities on MainWorld and caches" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-17</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-02/pr-22951-zh-cn-20260217>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>ignore ambiguities on MainWorld and caches<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: ignore ambiguities on MainWorld and caches<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22951<li><strong>Author</strong>: atlv24<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, S-Ready-For-Final-Review<li><strong>Created</strong>: 2026-02-14T07:28:54Z<li><strong>Merged</strong>: 2026-02-17T01:26:14Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>bring down the RenderApp ambiguity count by about ~1500</ul><h2 id=solution>Solution</h2><ul><li>ignore ambiguity on MainWorld in extract (this is fine, it doesnt/shouldnt matter what order we read MainWorld in, and mutating it in extract is cursed)<li>caches and other things of the form of HashSet&LTEntity, Thing> don’t care about write order</ul><h2 id=testing>Testing</h2><ul><li>this doesnt change behavior just ignores ambiguities that dont matter</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses system scheduling ambiguity warnings in Bevy’s renderer by explicitly marking certain resources as safe for parallel execution. The core issue was that Bevy’s scheduler was detecting potential data races on resources that were actually safe to access in parallel because their access patterns don’t depend on execution order.<p>The problem stems from Bevy’s scheduling system, which needs to ensure memory safety by preventing data races. When multiple systems access the same resource mutably, the scheduler typically treats this as an ambiguity - it can’t guarantee which system runs first, so it either runs them sequentially or warns the developer. However, there are cases where the order doesn’t matter because the operations are commutative or the data structure is designed to handle concurrent access safely.<p>In this case, the renderer had two main categories of resources that were safe for parallel access:<ol><li><p><strong>MainWorld in extract systems</strong>: The MainWorld is the primary game world that gets copied to the render world. In extract systems, we only read from MainWorld, and any mutation there would be problematic regardless of order. Since extract systems don’t mutate MainWorld, the order of reading doesn’t matter.</p><li><p><strong>Cache-like resources</strong>: Resources like TextureCache, RenderAssets, and various render phase collections are essentially caches or stores that are rebuilt each frame. These structures often use HashMap or HashSet internally, where insertion order doesn’t affect the final result. Multiple systems writing to these caches in parallel is safe because:</p> <ul><li>They operate on different keys (usually different entities or assets)<li>Even if they did operate on the same key, the last write would win, which is acceptable for cache behavior<li>The structures are cleared at the beginning of each frame and populated independently</ul></ol><p>The solution was to add <code>.allow_ambiguous_resource()</code> calls for these specific resources across multiple render plugins. This tells Bevy’s scheduler that it’s safe to run systems accessing these resources in parallel, reducing the ambiguity count by approximately 1500 warnings.<p>This optimization is particularly valuable because the renderer runs many systems in parallel, and these ambiguity warnings were creating noise that could obscure actual scheduling issues. By explicitly marking these safe resources, developers can more easily identify genuine problems in their scheduling.<p>The implementation required changes across 12 files because these cache resources are used throughout Bevy’s rendering pipeline - from texture management and material handling to mesh rendering and UI systems. Each plugin that creates one of these cache-like resources needed to explicitly mark it as allowing ambiguous access.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[ExtractPlugin] --> B[MainWorld]
</span><span>    A --> C[RenderAssets]
</span><span>    
</span><span>    D[Core2dPlugin] --> E[ViewSortedRenderPhases]
</span><span>    D --> F[ViewBinnedRenderPhases]
</span><span>    
</span><span>    G[PbrPlugin] --> H[RenderMaterialBindings]
</span><span>    G --> I[RenderMaterialInstances]
</span><span>    
</span><span>    J[MeshRenderPlugin] --> K[RenderMeshInstances]
</span><span>    J --> L[BatchedInstanceBuffer]
</span><span>    
</span><span>    M[BatchingPlugin] --> N[IndirectParametersBuffers]
</span><span>    
</span><span>    O[TexturePlugin] --> P[TextureCache]
</span><span>    
</span><span>    Q[Mesh2dRenderPlugin] --> R[RenderMesh2dInstances]
</span><span>    
</span><span>    S[UiRenderPlugin] --> T[ViewSortedRenderPhases]
</span><span>    
</span><span>    B --> U[Safe for parallel read]
</span><span>    C --> V[Cache - order independent]
</span><span>    E --> V
</span><span>    F --> V
</span><span>    H --> V
</span><span>    I --> V
</span><span>    K --> V
</span><span>    L --> V
</span><span>    N --> V
</span><span>    P --> V
</span><span>    R --> V
</span><span>    T --> V
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-render-src-extract-plugin-rs-13-11><code>crates/bevy_render/src/extract_plugin.rs</code> (+13/-11)</h3><p>This file sets up the extract schedule for copying data from the main world to the render world. The key change is adding <code>allow_ambiguous_resource::&LTMainWorld>()</code> to indicate that MainWorld can be safely read in parallel by extract systems.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// After:
</span><span>render_app
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>add_schedule</span><span>(Render</span><span style=color:#ed9366>::</span><span>base_schedule())
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>add_schedule</span><span>(extract_schedule)
</span><span>    </span><span style=color:#ed9366>.</span><span>allow_ambiguous_resource</span><span style=color:#ed9366>::</span><span>&LTMainWorld>()  </span><span style=color:#abb0b6;font-style:italic>// New line
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(
</span><span>        Render</span><span style=color:#61676ccc>,
</span><span>        (
</span><span>            apply_extract_commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>in_set</span><span>(RenderSystems</span><span style=color:#ed9366>::</span><span>ExtractCommands)</span><span style=color:#61676ccc>,
</span><span>            despawn_temporary_render_entities</span><span style=color:#ed9366>.</span><span style=color:#f07171>in_set</span><span>(RenderSystems</span><span style=color:#ed9366>::</span><span>PostCleanup)</span><span style=color:#61676ccc>,
</span><span>        )</span><span style=color:#61676ccc>,
</span><span>    )</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-render-src-texture-mod-rs-7-4><code>crates/bevy_render/src/texture/mod.rs</code> (+7/-4)</h3><p>This file manages the texture cache. The texture cache is a HashMap-based structure where insertion order doesn’t matter, so parallel writes are safe.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// After:
</span><span>render_app
</span><span>    </span><span style=color:#ed9366>.</span><span>init_resource</span><span style=color:#ed9366>::</span><span>&LTTextureCache>()
</span><span>    </span><span style=color:#ed9366>.</span><span>allow_ambiguous_resource</span><span style=color:#ed9366>::</span><span>&LTTextureCache>()  </span><span style=color:#abb0b6;font-style:italic>// New line
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(
</span><span>        Render</span><span style=color:#61676ccc>,
</span><span>        update_texture_cache_system</span><span style=color:#ed9366>.</span><span style=color:#f07171>in_set</span><span>(RenderSystems</span><span style=color:#ed9366>::</span><span>Cleanup)</span><span style=color:#61676ccc>,
</span><span>    )</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-pbr-src-render-mesh-rs-4-1><code>crates/bevy_pbr/src/render/mesh.rs</code> (+4/-1)</h3><p>This file handles mesh rendering for PBR materials. It manages instance buffers that are rebuilt each frame, so write order doesn’t matter.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> render_mesh_instances </span><span style=color:#ed9366>= </span><span>RenderMeshInstances</span><span style=color:#ed9366>::</span><span>new(use_gpu_instance_buffer_builder)</span><span style=color:#61676ccc>;
</span><span>render_app
</span><span>    </span><span style=color:#ed9366>.</span><span>allow_ambiguous_resource</span><span style=color:#ed9366>::</span><span>&LTno_gpu_preprocessing</span><span style=color:#ed9366>::</span><span style=color:#fa6e32>BatchedInstanceBuffer</span><span style=color:#ed9366>::</span><span>&LTMeshUniform>>()
</span><span>    </span><span style=color:#ed9366>.</span><span>allow_ambiguous_resource</span><span style=color:#ed9366>::</span><span>&LTgpu_preprocessing</span><span style=color:#ed9366>::</span><span>BatchedInstanceBuffers&LTMeshUniform, MeshInputUniform>>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_resource</span><span>(render_mesh_instances)</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-core-pipeline-src-core-2d-mod-rs-3-0><code>crates/bevy_core_pipeline/src/core_2d/mod.rs</code> (+3/-0)</h3><p>This plugin manages 2D rendering phases. The render phase collections are essentially caches that don’t care about write order.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#ed9366>.</span><span>init_resource</span><span style=color:#ed9366>::</span><span>&LTViewSortedRenderPhases&LTTransparent2d>>()
</span><span style=color:#ed9366>.</span><span>init_resource</span><span style=color:#ed9366>::</span><span>&LTViewBinnedRenderPhases&LTOpaque2d>>()
</span><span style=color:#ed9366>.</span><span>init_resource</span><span style=color:#ed9366>::</span><span>&LTViewBinnedRenderPhases&LTAlphaMask2d>>()
</span><span style=color:#ed9366>.</span><span>allow_ambiguous_resource</span><span style=color:#ed9366>::</span><span>&LTViewSortedRenderPhases&LTTransparent2d>>()  </span><span style=color:#abb0b6;font-style:italic>// New lines
</span><span style=color:#ed9366>.</span><span>allow_ambiguous_resource</span><span style=color:#ed9366>::</span><span>&LTViewBinnedRenderPhases&LTOpaque2d>>()
</span><span style=color:#ed9366>.</span><span>allow_ambiguous_resource</span><span style=color:#ed9366>::</span><span>&LTViewBinnedRenderPhases&LTAlphaMask2d>>()
</span></code></pre><h3 id=crates-bevy-pbr-src-lib-rs-2-1><code>crates/bevy_pbr/src/lib.rs</code> (+2/-1)</h3><p>The main PBR plugin marks RenderMaterialBindings as safe for parallel access since it’s a cache-like structure.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#ed9366>.</span><span>init_resource</span><span style=color:#ed9366>::</span><span>&LTLightMeta>()
</span><span style=color:#ed9366>.</span><span>init_resource</span><span style=color:#ed9366>::</span><span>&LTRenderMaterialBindings>()
</span><span style=color:#ed9366>.</span><span>allow_ambiguous_resource</span><span style=color:#ed9366>::</span><span>&LTRenderMaterialBindings>()</span><span style=color:#61676ccc>;  </span><span style=color:#abb0b6;font-style:italic>// New line
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><strong>Bevy Scheduling Documentation</strong>: For understanding system scheduling and ambiguity detection<li><strong>Entity Component System Pattern</strong>: To understand how Bevy manages data and systems<li><strong>Data Race Prevention in Game Engines</strong>: Background on why scheduling constraints are necessary<li><strong>Rust’s Ownership Model</strong>: How Bevy leverages Rust’s type system for memory safety without garbage collection</ol><h1 id=full-code-diff>Full Code Diff</h1><p><em>(Provided in the original request)</em></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_22951.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>