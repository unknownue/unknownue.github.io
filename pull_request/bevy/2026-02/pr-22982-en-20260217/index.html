<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22982 Loop seam fix for stroke text gizmos
        
    </title><meta content="#22982 Loop seam fix for stroke text gizmos" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-17</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-02/pr-22982-zh-cn-20260217>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>Loop seam fix for stroke text gizmos<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Loop seam fix for stroke text gizmos<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22982<li><strong>Author</strong>: ickshonpe<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: S-Ready-For-Final-Review, A-Gizmos, D-Straightforward, C-Refinement<li><strong>Created</strong>: 2026-02-16T16:26:47Z<li><strong>Merged</strong>: 2026-02-17T02:49:51Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>With text gizmos, loops leave a discontinuity at the seam:</p><img alt=seam height=519 src=https://github.com/user-attachments/assets/2d25e7a5-6ec7-4793-a42c-c58f578754fe width=405><h2 id=solution>Solution</h2><p>When a stroke forms a loop, queue an extra point to add a join at the seam:</p><img alt=seamless-O height=550 src=https://github.com/user-attachments/assets/47ebbe17-52af-48be-8e63-2677e850fdb4 width=460><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The issue was a visual artifact in Bevy’s text gizmo rendering system. When text characters contained closed loops in their stroke definitions, there would be a noticeable discontinuity or gap at the point where the stroke completed its loop. This problem was particularly visible in characters like “O” which have circular or oval shapes.<p>The root cause was in how stroke points were being processed. In the original implementation, when iterating through stroke points to render text gizmos, the system would process each stroke’s points exactly as defined in the font data. For closed loops, this meant the last point connected back to the first point, but without an explicit join operation at that seam, rendering engines could leave a small gap.<p>The solution modifies the stroke iterator to detect when a stroke forms a closed loop and adds an extra point at the seam. The key insight is that by duplicating the second point of the loop at the end of the stroke sequence, the rendering system will create a proper join between the end and beginning of the loop, eliminating the visual discontinuity.<p>Looking at the code changes, the implementation approach is straightforward. The original code had nested loops - an outer loop for characters and an inner loop for strokes within each character. The refactored code simplifies the control flow by removing one level of nesting and adding the loop detection logic.<p>The critical change is this check:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let</span><span> join </span><span style=color:#ed9366>= </span><span>(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>font</span><span style=color:#ed9366>.</span><span>positions[stroke</span><span style=color:#ed9366>.</span><span>start]
</span><span>    </span><span style=color:#ed9366>== </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>font</span><span style=color:#ed9366>.</span><span>positions[stroke</span><span style=color:#ed9366>.</span><span>end </span><span style=color:#ed9366>- </span><span style=color:#ff8f40>1</span><span>])
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>then_some</span><span>(stroke</span><span style=color:#ed9366>.</span><span>start </span><span style=color:#ed9366>+ </span><span style=color:#ff8f40>1</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><p>This checks if the first and last points of the stroke are at the same position (indicating a closed loop). If they are, it returns the index of the second point (stroke.start + 1) to be added to the stroke point sequence.<p>The implementation then uses <code>stroke.chain(join.into_iter())</code> to append this extra point to the stroke’s point iterator. This causes the stroke to have one additional point at the end that’s actually the second point of the original stroke, creating the necessary overlap for a seamless join.<p>From an architectural perspective, this change is minimal and focused. It doesn’t alter the overall structure of the text rendering system or add significant complexity. The solution is localized to the point iteration logic, making it easy to understand and maintain.<p>One interesting aspect is the use of Rust’s <code>then_some()</code> method with the <code>bool</code> type, which is a concise way to conditionally create an <code>Option</code> value. This is more readable than an explicit <code>if</code> statement for this particular pattern.<p>The impact of this change is purely visual - it fixes rendering artifacts in text gizmos without affecting performance in any meaningful way. The additional point per closed loop stroke adds negligible overhead while solving a clear visual defect.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Stroke Text Iterator] --> B{Stroke Processing}
</span><span>    B --> C[Check if stroke is closed loop]
</span><span>    C -->|Yes| D[Add extra point at seam]
</span><span>    C -->|No| E[Process normally]
</span><span>    D --> F[Generate point positions]
</span><span>    E --> F
</span><span>    F --> G[Return iterator]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-gizmos-src-stroke-text-rs-17-14><code>crates/bevy_gizmos/src/stroke_text.rs</code> (+17/-14)</h3><p>This file contains the <code>StrokeTextLayout</code> struct implementation. The changes modify the iterator that generates points for text strokes, specifically to handle closed loops properly.<p><strong>Key changes:</strong><ol><li><p><strong>Control flow simplification</strong>: The original nested loop structure was refactored to flatten the control flow, making the code more linear and easier to follow.</p><li><p><strong>Loop detection logic</strong>: Added logic to detect when a stroke forms a closed loop by comparing the first and last points.</p><li><p><strong>Extra point insertion</strong>: When a closed loop is detected, an extra point (the second point of the stroke) is appended to create a proper join at the seam.</p></ol><p><strong>Code diff highlights:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>current_strokes</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_empty</span><span>() {
</span><span>    </span><span style=color:#fa6e32>for</span><span> stroke_index </span><span style=color:#ed9366>in</span><span> current_strokes</span><span style=color:#ed9366>.</span><span style=color:#f07171>by_ref</span><span>() {
</span><span>        </span><span style=color:#fa6e32>let</span><span> stroke </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>font</span><span style=color:#ed9366>.</span><span>strokes[stroke_index]</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#fa6e32>if</span><span> stroke</span><span style=color:#ed9366>.</span><span style=color:#f07171>len</span><span>() </span><span style=color:#ed9366>< </span><span style=color:#ff8f40>2 </span><span>{
</span><span>            </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>
</span><span>        </span><span style=color:#fa6e32>return </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(stroke</span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(</span><span style=color:#fa6e32>move </span><span style=color:#ed9366>|</span><span>index</span><span style=color:#ed9366>| </span><span>{
</span><span>            </span><span style=color:#fa6e32>let </span><span>[p</span><span style=color:#61676ccc>,</span><span> q] </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>font</span><span style=color:#ed9366>.</span><span>positions[index]</span><span style=color:#61676ccc>;
</span><span>            Vec2</span><span style=color:#ed9366>::</span><span>new(
</span><span>                current_x </span><span style=color:#ed9366>+ </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>scale </span><span style=color:#ed9366>*</span><span> p </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32</span><span style=color:#61676ccc>,
</span><span>                y </span><span style=color:#ed9366>- </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>scale </span><span style=color:#ed9366>* </span><span>(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>font</span><span style=color:#ed9366>.</span><span>cap_height </span><span style=color:#ed9366>-</span><span> q </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32</span><span>)</span><span style=color:#61676ccc>,
</span><span>            )
</span><span>        }))</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>for</span><span> stroke_index </span><span style=color:#ed9366>in</span><span> current_strokes</span><span style=color:#ed9366>.</span><span style=color:#f07171>by_ref</span><span>() {
</span><span>    </span><span style=color:#fa6e32>let</span><span> stroke </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>font</span><span style=color:#ed9366>.</span><span>strokes[stroke_index]</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>if</span><span> stroke</span><span style=color:#ed9366>.</span><span style=color:#f07171>len</span><span>() </span><span style=color:#ed9366>< </span><span style=color:#ff8f40>2 </span><span>{
</span><span>        </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// If this stroke is a closed loop, append one extra point to add a join at the seam.
</span><span>    </span><span style=color:#fa6e32>let</span><span> join </span><span style=color:#ed9366>= </span><span>(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>font</span><span style=color:#ed9366>.</span><span>positions[stroke</span><span style=color:#ed9366>.</span><span>start]
</span><span>        </span><span style=color:#ed9366>== </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>font</span><span style=color:#ed9366>.</span><span>positions[stroke</span><span style=color:#ed9366>.</span><span>end </span><span style=color:#ed9366>- </span><span style=color:#ff8f40>1</span><span>])
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>then_some</span><span>(stroke</span><span style=color:#ed9366>.</span><span>start </span><span style=color:#ed9366>+ </span><span style=color:#ff8f40>1</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#fa6e32>return </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(stroke</span><span style=color:#ed9366>.</span><span style=color:#f07171>chain</span><span>(join</span><span style=color:#ed9366>.</span><span style=color:#f07171>into_iter</span><span>())</span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(</span><span style=color:#fa6e32>move </span><span style=color:#ed9366>|</span><span>index</span><span style=color:#ed9366>| </span><span>{
</span><span>        </span><span style=color:#fa6e32>let </span><span>[p</span><span style=color:#61676ccc>,</span><span> q] </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>font</span><span style=color:#ed9366>.</span><span>positions[index]</span><span style=color:#61676ccc>;
</span><span>        Vec2</span><span style=color:#ed9366>::</span><span>new(
</span><span>            current_x </span><span style=color:#ed9366>+ </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>scale </span><span style=color:#ed9366>*</span><span> p </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32</span><span style=color:#61676ccc>,
</span><span>            y </span><span style=color:#ed9366>- </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>scale </span><span style=color:#ed9366>* </span><span>(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>font</span><span style=color:#ed9366>.</span><span>cap_height </span><span style=color:#ed9366>-</span><span> q </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32</span><span>)</span><span style=color:#61676ccc>,
</span><span>        )
</span><span>    }))</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>The main differences are:<ul><li>Removal of the outer <code>if !current_strokes.is_empty()</code> check (the inner <code>for</code> loop handles emptiness)<li>Addition of the <code>join</code> variable that conditionally contains an extra point index for closed loops<li>Use of <code>stroke.chain(join.into_iter())</code> to append the extra point when needed</ul><h2 id=further-reading>Further Reading</h2><ol><li><strong>Bevy Gizmos Documentation</strong>: For understanding how gizmos work in Bevy’s rendering system<li><strong>Vector Graphics Stroke Joins</strong>: Information about stroke join types (miter, round, bevel) in vector graphics<li><strong>Rust Iterator Adapters</strong>: Documentation on <code>chain()</code>, <code>map()</code>, and other iterator methods used in this implementation<li><strong>Font Rendering Techniques</strong>: Background on how font outlines are converted to rendered strokes</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_22982.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>