<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #23106 Only copy the current transform to the previous transform component if the latter is out of date.
        
    </title><meta content="#23106 Only copy the current transform to the previous transform component if the latter is out of date." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-24</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-02/pr-23106-zh-cn-20260224>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Only copy the current transform to the previous transform component if the latter is out of date.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/23106<li><strong>Author</strong>: pcwalton<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, C-Performance, S-Ready-For-Final-Review, D-Modest<li><strong>Created</strong>: 2026-02-22T05:11:05Z<li><strong>Merged</strong>: 2026-02-24T17:43:57Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>The <code>update_mesh_previous_global_transforms</code> system currently loops through every mesh and copies the current transform to the previous transform component. This becomes a bottleneck when scaling to large numbers of static entities. This PR changes the logic to instead only copy if the change tick of the transform is newer than the change tick of the previous transform.<p>On <code>many_cubes</code>, this commit improves the time spent in <code>update_mesh_previous_global_transforms</code> from 615 μs to 58.0 μs, a 10.6x speedup of that system.</p><img alt="Screenshot 2026-02-21 210808" height=1800 src=https://github.com/user-attachments/assets/b1774ab7-73d9-4585-ac57-557f7e9627c9 width=2756><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a performance bottleneck in Bevy’s rendering pipeline specifically affecting scenes with large numbers of static entities. The issue was in the <code>update_mesh_previous_global_transforms</code> system, which is part of the pre-pass processing for motion vectors and temporal anti-aliasing.<p>The problem stemmed from how the system handled previous transform updates. For every mesh entity with a <code>GlobalTransform</code> component, the system would unconditionally copy the current transform to the <code>PreviousGlobalTransform</code> component each frame. This operation occurred regardless of whether the transform had actually changed since the last frame. For static entities that never move, this resulted in unnecessary memory writes and CPU cycles being wasted on data that wasn’t actually changing.<p>The original implementation used a simple approach: iterate through all qualifying meshes and update their previous transforms. This became problematic at scale because every static entity in the scene was processed every frame, even though their transforms remained constant. In large scenes with thousands of static objects, this system became a significant performance drain.<p>The solution leverages Bevy’s change detection system, which tracks when components are modified. By using <code>Ref&LTGlobalTransform></code> in the query instead of <code>&GlobalTransform</code>, we gain access to change tick information. The key insight is that we only need to update the previous transform when the current transform has actually changed since the previous frame.<p>The implementation introduces a conditional check based on change ticks. For each mesh, we compare:<ul><li>When the <code>GlobalTransform</code> was last changed<li>When the <code>PreviousGlobalTransform</code> was last changed<li>The current system change tick</ul><p>If the transform’s change tick is newer than the previous transform’s change tick (accounting for system execution order), we perform the update. Otherwise, we skip it.<p>This approach has several advantages. First, it dramatically reduces CPU overhead for static entities since they’re only processed once (when initially inserted) rather than every frame. Second, it maintains correctness for dynamic entities that actually need their previous transforms updated. Third, it integrates cleanly with Bevy’s existing change detection infrastructure.<p>The performance improvement is substantial: a 10.6x speedup in the <code>update_mesh_previous_global_transforms</code> system on the <code>many_cubes</code> benchmark, reducing execution time from 615 μs to 58.0 μs. This improvement scales with the number of static entities in a scene, making it particularly valuable for large, complex environments.<p>The implementation also simplifies the early exit condition by directly checking if any camera is active and returning early if not, removing the intermediate <code>should_run</code> variable.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[GlobalTransform Component] --> B{Has Transform Changed?}
</span><span>    B -->|Yes| C[Update PreviousGlobalTransform]
</span><span>    B -->|No| D[Skip Update]
</span><span>    E[SystemChangeTick] --> B
</span><span>    F[PreviousGlobalTransform.last_changed] --> B
</span><span>    G[GlobalTransform.last_changed] --> B
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-pbr-src-prepass-mod-rs-16-10><code>crates/bevy_pbr/src/prepass/mod.rs</code> (+16/-10)</h3><p>This file contains the <code>update_mesh_previous_global_transforms</code> system, which was modified to optimize previous transform updates. The changes implement conditional copying based on change detection ticks.<p><strong>Key modifications:</strong><ol><li><strong>Query signature change</strong>: The meshes query now uses <code>Ref&LTGlobalTransform></code> instead of <code>&GlobalTransform</code> to access change detection information.</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>mut</span><span> meshes</span><span style=color:#61676ccc>: </span><span>Query<(</span><span style=color:#ed9366>&</span><span>GlobalTransform, </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> PreviousGlobalTransform), PreviousMeshFilter></span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>mut</span><span> meshes</span><span style=color:#61676ccc>: </span><span>Query<(Ref&LTGlobalTransform>, </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> PreviousGlobalTransform), PreviousMeshFilter></span><span style=color:#61676ccc>,
</span></code></pre><ol start=2><li><strong>System parameter addition</strong>: Added <code>SystemChangeTick</code> parameter to get the current system execution tick for comparison.</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>update_mesh_previous_global_transforms</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands,
</span><span>    </span><span style=color:#ff8f40>views</span><span style=color:#61676ccc>: </span><span>Query<</span><span style=color:#ed9366>&</span><span>Camera, With&LTCamera3d>>,
</span><span>    </span><span style=color:#ff8f40>new_meshes</span><span style=color:#61676ccc>: </span><span>Query<
</span><span>        (Entity, </span><span style=color:#ed9366>&</span><span>GlobalTransform),
</span><span>        (PreviousMeshFilter, Without&LTPreviousGlobalTransform>),
</span><span>    >,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>meshes</span><span style=color:#61676ccc>: </span><span>Query<(</span><span style=color:#ed9366>&</span><span>GlobalTransform, </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> PreviousGlobalTransform), PreviousMeshFilter>,
</span><span>) {
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>update_mesh_previous_global_transforms</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands,
</span><span>    </span><span style=color:#ff8f40>views</span><span style=color:#61676ccc>: </span><span>Query<</span><span style=color:#ed9366>&</span><span>Camera, With&LTCamera3d>>,
</span><span>    </span><span style=color:#ff8f40>new_meshes</span><span style=color:#61676ccc>: </span><span>Query<
</span><span>        (Entity, </span><span style=color:#ed9366>&</span><span>GlobalTransform),
</span><span>        (PreviousMeshFilter, Without&LTPreviousGlobalTransform>),
</span><span>    >,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>meshes</span><span style=color:#61676ccc>: </span><span>Query<(Ref&LTGlobalTransform>, </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> PreviousGlobalTransform), PreviousMeshFilter>,
</span><span>    </span><span style=color:#ff8f40>system_change_tick</span><span style=color:#61676ccc>:</span><span> SystemChangeTick,
</span><span>) {
</span></code></pre><ol start=3><li><strong>Update logic change</strong>: Replaced unconditional updating with conditional updating based on change ticks.</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>meshes</span><span style=color:#ed9366>.</span><span style=color:#f07171>par_iter_mut</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>for_each</span><span>(|(</span><span style=color:#ff8f40>transform</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>mut previous</span><span>)| {
</span><span>    previous</span><span style=color:#ed9366>.</span><span style=color:#f07171>set_if_neq</span><span>(PreviousGlobalTransform(transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>affine</span><span>()))</span><span style=color:#61676ccc>;
</span><span>})</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>meshes</span><span style=color:#ed9366>.</span><span style=color:#f07171>par_iter_mut</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>for_each</span><span>(|(</span><span style=color:#ff8f40>transform</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>mut previous</span><span>)| {
</span><span>    </span><span style=color:#fa6e32>if</span><span> transform
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>last_changed</span><span>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>is_newer_than</span><span>(previous</span><span style=color:#ed9366>.</span><span style=color:#f07171>last_changed</span><span>()</span><span style=color:#61676ccc>,</span><span> system_change_tick</span><span style=color:#ed9366>.</span><span style=color:#f07171>this_run</span><span>())
</span><span>    {
</span><span>        </span><span style=color:#ed9366>*</span><span>previous </span><span style=color:#ed9366>=</span><span> PreviousGlobalTransform(transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>affine</span><span>())</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>})</span><span style=color:#61676ccc>;
</span></code></pre><ol start=4><li><strong>Early return simplification</strong>: Simplified the early exit condition when no camera is active.</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> should_run </span><span style=color:#ed9366>=</span><span> views</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>any</span><span>(|</span><span style=color:#ff8f40>camera</span><span>| camera</span><span style=color:#ed9366>.</span><span>is_active)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>if</span><span> should_run {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... rest of function
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>views</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>any</span><span>(|</span><span style=color:#ff8f40>camera</span><span>| camera</span><span style=color:#ed9366>.</span><span>is_active) {
</span><span>    </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span>}
</span><span style=color:#abb0b6;font-style:italic>// ... rest of function
</span></code></pre><p>These changes work together to significantly reduce CPU overhead by skipping unnecessary updates for static entities while maintaining correct behavior for dynamic ones.<h2 id=further-reading>Further Reading</h2><ol><li><strong>Bevy Change Detection Documentation</strong>: Understanding how Bevy tracks component changes is fundamental to this optimization.<li><strong>Bevy ECS System Scheduling</strong>: The relationship between system change ticks and component change tracking.<li><strong>Temporal Anti-Aliasing (TAA)</strong>: The rendering technique that uses previous frame data, which is why previous transforms are needed.<li><strong>Motion Vectors in Computer Graphics</strong>: How previous and current transforms are used to calculate per-pixel motion.<li><strong>Performance Optimization Patterns</strong>: The broader category of techniques for avoiding unnecessary work in game engines.</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_23106.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>