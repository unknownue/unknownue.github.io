<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18465 Restructure morph target pipeline to reduce crate dependencies
        
    </title><meta content="#18465 Restructure morph target pipeline to reduce crate dependencies" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-13</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-02/pr-18465-zh-cn-20260213>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Restructure morph target pipeline to reduce crate dependencies<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18465<li><strong>Author</strong>: greeble-dev<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, C-Code-Quality, S-Ready-For-Final-Review, A-Animation, M-Migration-Guide<li><strong>Created</strong>: 2025-03-21T16:01:40Z<li><strong>Merged</strong>: 2026-02-13T04:20:26Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>The PR description is already in English, so we include it as-is:<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This pull request addresses several interconnected problems in Bevy’s morph target animation system. At its core, the issue was an architectural design that created unnecessary dependencies between crates and introduced redundant data copying. The previous implementation required a specific system ordering between <code>bevy_animation</code>, <code>bevy_mesh</code>, and <code>bevy_render</code>, creating brittle cross-crate dependencies.<p>The problem manifested in three concrete ways. First, there was a system ordering dependency where <code>animate_targets</code> in <code>bevy_animation</code> had to run before <code>InheritWeightSystems</code> (defined in <code>bevy_mesh</code>), which contained <code>inherit_weights</code> from <code>bevy_render</code>. This created a fragile dependency chain across three separate crates.<p>Second, the data flow involved unnecessary copying. The weights went from <code>MorphWeights</code> → <code>MeshMorphWeights</code> → render buffers. The intermediate copy from <code>MorphWeights</code> to <code>MeshMorphWeights</code> was redundant since the render extraction would copy them again anyway. This wasted CPU cycles and memory bandwidth.<p>Third, the system imposed rigid entity relationships - <code>MeshMorphWeights</code> components had to be on child entities of the entity with <code>MorphWeights</code>. While this worked for glTF imports, it limited flexibility for custom use cases.<p>The solution was to restructure the <code>MeshMorphWeights</code> component itself. Instead of being a simple container for weight values, it became an enum that could either hold its own weights directly or reference another entity containing a <code>MorphWeights</code> component:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>MeshMorphWeights </span><span>{ weights</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Vec</span><span><</span><span style=color:#fa6e32>f32</span><span>> }
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>enum </span><span style=color:#399ee6>MeshMorphWeights </span><span>{
</span><span>    Value { weights</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Vec</span><span><</span><span style=color:#fa6e32>f32</span><span>> }</span><span style=color:#61676ccc>,
</span><span>    Reference(Entity)</span><span style=color:#61676ccc>,
</span><span>}
</span></code></pre><p>This seemingly simple change had profound architectural implications. By making <code>MeshMorphWeights</code> capable of referencing another entity, the entire <code>inherit_weights</code> system could be eliminated. The render extraction system (<code>extract_morphs</code> in <code>bevy_pbr</code>) now handles both cases: for <code>Value</code> variants, it uses the stored weights directly; for <code>Reference</code> variants, it looks up the referenced entity’s <code>MorphWeights</code> component.<p>The implementation required coordinated changes across multiple crates:<ol><li><p><strong>Removing system dependencies</strong>: In <code>bevy_animation</code>, the explicit ordering dependency was removed. In <code>bevy_mesh</code>, the <code>InheritWeightSystems</code> system set was eliminated entirely since no systems needed to run in that set anymore.</p><li><p><strong>Updating the GLTF loader</strong>: The loader needed to adapt to the new enum structure. When loading glTF files with morph targets, it now creates <code>MeshMorphWeights::Reference</code> components that point to the parent node’s entity, rather than copying weights into each mesh entity.</p><li><p><strong>Simplifying the render pipeline</strong>: The entire <code>MorphPlugin</code> and its <code>inherit_weights</code> system were removed from <code>bevy_render</code>, as they were no longer needed.</p><li><p><strong>Updating extraction logic</strong>: The <code>extract_morphs</code> system in <code>bevy_pbr</code> was updated to handle both variants of the enum, querying referenced entities when necessary.</p></ol><p>The performance impact was significant. On the <code>many_morph_targets</code> example, the <code>inherit_weights</code> system time dropped from 30.3μs to zero. Although <code>extract_morphs</code> increased slightly from 42.5μs to 48.9μs (due to the entity lookup for references), the overall throughput improved by 50% - from 14 to 21 meshes processed per microsecond.<p>Beyond performance, the new design offers greater flexibility. A <code>MeshMorphWeights</code> component can now reference any entity with a <code>MorphWeights</code> component, not just its parent. This opens up possibilities for more complex animation setups where multiple meshes share weight values from arbitrary entities in the scene hierarchy.<p>One important technical detail is how the system handles missing or mismatched references. The extraction code gracefully handles cases where a referenced entity doesn’t have <code>MorphWeights</code> by skipping that mesh. This provides robustness while maintaining performance.<p>The migration path for users is straightforward. Code that previously used <code>MeshMorphWeights::new()</code> needs to wrap weights in <code>MeshMorphWeights::Value</code>. Code that relied on the automatic parent-child copying needs to explicitly use <code>MeshMorphWeights::Reference</code> pointing to the appropriate entity.<p>This change demonstrates a common optimization pattern in ECS-based systems: reducing data movement and eliminating intermediate copies by using references or indices. It also shows how enum-based designs can provide flexibility while maintaining clear semantics - the <code>MeshMorphWeights</code> enum makes the two usage patterns explicit and type-safe.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[MorphWeights component] --> B{New MeshMorphWeights enum}
</span><span>    B -->|Value variant| C[Direct weight storage]
</span><span>    B -->|Reference variant| D[Entity reference]
</span><span>    C --> E[extract_morphs reads directly]
</span><span>    D --> F[extract_morphs queries referenced entity]
</span><span>    E --> G[Render buffers]
</span><span>    F --> G
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ol><li><p><strong><code>crates/bevy_mesh/src/morph.rs</code> (+42/-44)</strong></p> <ul><li><strong>What changed</strong>: The <code>MeshMorphWeights</code> struct was changed to an enum with <code>Value</code> and <code>Reference</code> variants. This is the core change that enables the new architecture.<li><strong>Why it matters</strong>: This change eliminates the need for the intermediate copy system while providing flexibility for both direct weight storage and entity references.</ul> <p><strong>Key code change:</strong></p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Reflect</span><span style=color:#61676ccc>,</span><span> Default</span><span style=color:#61676ccc>,</span><span> Debug</span><span style=color:#61676ccc>,</span><span> Clone</span><span style=color:#61676ccc>,</span><span> Component)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>MeshMorphWeights </span><span>{
</span><span>    weights</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Vec</span><span><</span><span style=color:#fa6e32>f32</span><span>>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Reflect</span><span style=color:#61676ccc>,</span><span> Debug</span><span style=color:#61676ccc>,</span><span> Clone</span><span style=color:#61676ccc>,</span><span> Component)]
</span><span style=color:#fa6e32>pub enum </span><span style=color:#399ee6>MeshMorphWeights </span><span>{
</span><span>    Value { weights</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Vec</span><span><</span><span style=color:#fa6e32>f32</span><span>> }</span><span style=color:#61676ccc>,
</span><span>    Reference(</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>entities</span><span>] Entity)</span><span style=color:#61676ccc>,
</span><span>}
</span></code></pre><li><p><strong><code>crates/bevy_gltf/src/loader/mod.rs</code> (+28/-25)</strong></p> <ul><li><strong>What changed</strong>: Updated GLTF loading to use the new <code>MeshMorphWeights::Reference</code> instead of copying weights to each mesh entity.<li><strong>Why it matters</strong>: This ensures imported glTF files work correctly with the new system, creating references to the parent node’s <code>MorphWeights</code> component.</ul> <p><strong>Key code change:</strong></p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Creating MeshMorphWeights with copied weights
</span><span>mesh_entity</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(MeshMorphWeights</span><span style=color:#ed9366>::</span><span>new(weights)</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>())</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Creating a reference to the parent entity
</span><span>mesh_entity</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(MeshMorphWeights</span><span style=color:#ed9366>::</span><span>Reference(parent_entity))</span><span style=color:#61676ccc>;
</span></code></pre><li><p><strong><code>release-content/migration-guides/mesh_morph_weights.md</code> (+53/-0)</strong></p> <ul><li><strong>What changed</strong>: Added a new migration guide explaining how to update code for the breaking changes.<li><strong>Why it matters</strong>: Provides clear guidance for users migrating from Bevy 0.18 to 0.19, explaining both the architectural changes and practical code updates.</ul><li><p><strong><code>crates/bevy_render/src/mesh/mod.rs</code> (+1/-35)</strong></p> <ul><li><strong>What changed</strong>: Removed the entire <code>MorphPlugin</code> and <code>inherit_weights</code> system.<li><strong>Why it matters</strong>: These systems were made obsolete by the new architecture where weights are either stored directly or referenced.</ul><li><p><strong><code>crates/bevy_pbr/src/render/morph.rs</code> (+11/-3)</strong></p> <ul><li><strong>What changed</strong>: Updated <code>extract_morphs</code> to handle both variants of <code>MeshMorphWeights</code>.<li><strong>Why it matters</strong>: This is where the new design actually gets used - the extraction system now queries referenced entities when needed.</ul> <p><strong>Key code change:</strong></p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Updated extraction logic:
</span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(weights) </span><span style=color:#ed9366>= </span><span>(</span><span style=color:#fa6e32>match</span><span> mesh_weights {
</span><span>    MeshMorphWeights</span><span style=color:#ed9366>::</span><span>Reference(entity) </span><span style=color:#ed9366>=> </span><span>{
</span><span>        weights_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#ed9366>*</span><span>entity)</span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(MorphWeights</span><span style=color:#ed9366>::</span><span>weights)
</span><span>    }
</span><span>    MeshMorphWeights</span><span style=color:#ed9366>::</span><span>Value { weights } </span><span style=color:#ed9366>=> </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(weights</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_slice</span><span>())</span><span style=color:#61676ccc>,
</span><span>}) </span><span style=color:#fa6e32>else </span><span>{
</span><span>    </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>}</span><span style=color:#61676ccc>;
</span></code></pre></ol><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/ecs/index.html target=_blank>Bevy’s ECS documentation</a> - Understanding Bevy’s Entity Component System<li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Morph_target_animation target=_blank>Morph target animation concepts</a> - Background on the animation technique<li><a rel="noopener nofollow noreferrer" href=https://registry.khronos.org/glTF/specs/2.0/glTF-2.0.html#morph-targets target=_blank>glTF morph targets specification</a> - How morph targets work in the glTF format<li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/programming/systems.html#system-ordering target=_blank>System ordering in Bevy</a> - Understanding system execution order<li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/book/ch06-00-enums.html target=_blank>Rust enum patterns</a> - How Rust enums enable type-safe state representation</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_18465.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>