<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22960 Fix render diagnostics
        
    </title><meta content="#22960 Fix render diagnostics" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-18</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-02/pr-22960-zh-cn-20260218>中文</a></div></div><div class=pr-content><h1 id=title-fix-render-diagnostics>Title: Fix render diagnostics</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix render diagnostics<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22960<li><strong>Author</strong>: IceSentry<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, C-Usability, S-Ready-For-Final-Review<li><strong>Created</strong>: 2026-02-14T19:21:11Z<li><strong>Merged</strong>: 2026-02-18T04:08:14Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description>Description</h2><h1 id=objective>Objective</h1><ul><li>Render diagnostics currently don’t work</ul><h2 id=solution>Solution</h2><ul><li>Use the new system sets from https://github.com/bevyengine/bevy/pull/22958 to resolve the encoder after render but before submit</ul><h2 id=testing>Testing</h2><ul><li>Tested with 3d_scene and solari</ul><h2 id=note>Note</h2><p><del>This is based on https://github.com/bevyengine/bevy/pull/22958 so need to merge that one first</del></p><img alt=tracy-profiler_JKTyPBD0Fo height=84 src=https://github.com/user-attachments/assets/dd82bf4a-1a02-4519-a1b9-4204b0d47c7e width=1107><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a bug where render diagnostics were broken in Bevy’s rendering system. The issue was related to the timing of when command encoders are resolved for diagnostics recording. Before this fix, the diagnostics system wasn’t functioning correctly because it wasn’t properly integrated into the render graph execution flow.<p>The core problem stemmed from the render diagnostics needing to capture GPU timing information, which requires creating and resolving command encoders at specific points in the render pipeline. The diagnostics system uses timestamp queries to measure GPU execution time for various render passes, but these queries need to be inserted into command buffers at the right time - after all render commands have been recorded but before the command buffers are submitted to the GPU.<p>The solution leverages new system sets introduced in PR #22958, which provide more granular control over the ordering of render graph systems. The key insight is that we need to resolve the diagnostics encoder in the gap between the render graph execution and command buffer submission. This timing ensures that all render commands have been encoded, but the command buffers haven’t yet been sent to the GPU, allowing us to insert the necessary timestamp queries.<p>The implementation adds three new systems to the render graph schedule:<ol><li><code>begin_diagnostics_frame</code> runs at the beginning of the frame to start diagnostics recording<li><code>resolve_encoder</code> runs after the main render graph systems but before submission, creating and resolving the command encoder for diagnostics<li><code>finish_diagnostics_frame</code> runs at the end to finalize the frame and sync diagnostics data back to the main world</ol><p>The most critical system is <code>resolve_encoder</code>, which creates a new command encoder specifically for diagnostics. This encoder captures the timestamp queries for all diagnostic spans that were recorded during frame execution. By pushing this encoder to the <code>PendingCommandBuffers</code>, it ensures the diagnostic commands are submitted along with the main render commands.<p>This approach demonstrates a common pattern in graphics programming where timing measurements require careful synchronization points in the command stream. The fix ensures that render diagnostics can accurately measure both CPU and GPU execution times for debugging and optimization purposes.<p>The testing with 3d_scene and solari confirms that the diagnostics are now working correctly, as evidenced by the Tracy profiler screenshot showing proper GPU timing measurements.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[RenderGraphSystems::Begin] --> B[begin_diagnostics_frame]
</span><span>    B --> C[RenderGraphSystems::Render]
</span><span>    C --> D[resolve_encoder]
</span><span>    D --> E[RenderGraphSystems::Submit]
</span><span>    E --> F[RenderGraphSystems::Finish]
</span><span>    F --> G[finish_diagnostics_frame]
</span><span>    
</span><span>    H[Create Command Encoder] --> D
</span><span>    D --> I[Push to PendingCommandBuffers]
</span><span>    J[DiagnosticsRecorder] -.-> D
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>File:</strong> <code>crates/bevy_render/src/diagnostic/mod.rs</code><p><strong>Changes:</strong> This file received the primary modifications to fix the render diagnostics. The changes include:<ol><li>Added necessary imports for the new systems and resources<li>Modified the <code>RenderDiagnosticsPlugin</code> to register three new systems in the render graph schedule<li>Implemented the three new systems that handle diagnostics frame lifecycle</ol><p><strong>Key code modifications:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Plugin implementation didn't register any systems
</span><span style=color:#fa6e32>impl </span><span>Plugin </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>RenderDiagnosticsPlugin </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>build</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>app</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> App) {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ... existing setup code ...
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Plugin now registers systems in the render graph
</span><span style=color:#fa6e32>impl </span><span>Plugin </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>RenderDiagnosticsPlugin </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>build</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>app</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> App) {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ... existing setup code ...
</span><span>        
</span><span>        render_app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(
</span><span>            RenderGraph</span><span style=color:#61676ccc>,
</span><span>            (
</span><span>                begin_diagnostics_frame</span><span style=color:#ed9366>.</span><span style=color:#f07171>in_set</span><span>(RenderGraphSystems</span><span style=color:#ed9366>::</span><span>Begin)</span><span style=color:#61676ccc>,
</span><span>                resolve_encoder
</span><span>                    </span><span style=color:#ed9366>.</span><span style=color:#f07171>after</span><span>(RenderGraphSystems</span><span style=color:#ed9366>::</span><span>Render)
</span><span>                    </span><span style=color:#ed9366>.</span><span style=color:#f07171>before</span><span>(RenderGraphSystems</span><span style=color:#ed9366>::</span><span>Submit)</span><span style=color:#61676ccc>,
</span><span>                finish_diagnostics_frame</span><span style=color:#ed9366>.</span><span style=color:#f07171>in_set</span><span>(RenderGraphSystems</span><span style=color:#ed9366>::</span><span>Finish)</span><span style=color:#61676ccc>,
</span><span>            )</span><span style=color:#61676ccc>,
</span><span>        )</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// New systems added:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>begin_diagnostics_frame</span><span>(</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>recorder</span><span style=color:#61676ccc>: </span><span>ResMut&LTDiagnosticsRecorder>) {
</span><span>    recorder</span><span style=color:#ed9366>.</span><span style=color:#f07171>begin_frame</span><span>()</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>resolve_encoder</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>recorder</span><span style=color:#61676ccc>: </span><span>ResMut&LTDiagnosticsRecorder>,
</span><span>    </span><span style=color:#ff8f40>render_device</span><span style=color:#61676ccc>: </span><span>Res&LTRenderDevice>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>pending_buffers</span><span style=color:#61676ccc>: </span><span>ResMut&LTPendingCommandBuffers>,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> encoder </span><span style=color:#ed9366>=
</span><span>        render_device</span><span style=color:#ed9366>.</span><span style=color:#f07171>create_command_encoder</span><span>(</span><span style=color:#ed9366>&</span><span>wgpu</span><span style=color:#ed9366>::</span><span>CommandEncoderDescriptor</span><span style=color:#ed9366>::</span><span>default())</span><span style=color:#61676ccc>;
</span><span>    recorder</span><span style=color:#ed9366>.</span><span style=color:#f07171>resolve</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> encoder)</span><span style=color:#61676ccc>;
</span><span>    pending_buffers</span><span style=color:#ed9366>.</span><span style=color:#f07171>push_encoder</span><span>(encoder)</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>finish_diagnostics_frame</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>recorder</span><span style=color:#61676ccc>: </span><span>ResMut&LTDiagnosticsRecorder>,
</span><span>    </span><span style=color:#ff8f40>render_device</span><span style=color:#61676ccc>: </span><span>Res&LTRenderDevice>,
</span><span>    </span><span style=color:#ff8f40>mutex</span><span style=color:#61676ccc>: </span><span>Res&LTRenderDiagnosticsMutex>,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>let</span><span> mutex </span><span style=color:#ed9366>=</span><span> mutex</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#61676ccc>;
</span><span>    recorder</span><span style=color:#ed9366>.</span><span style=color:#f07171>finish_frame</span><span>(</span><span style=color:#ed9366>&</span><span>render_device</span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>move </span><span style=color:#ed9366>|</span><span>diagnostics</span><span style=color:#ed9366>| </span><span>{
</span><span>        </span><span style=color:#ed9366>*</span><span>mutex</span><span style=color:#ed9366>.</span><span style=color:#f07171>lock</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>() </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(diagnostics)</span><span style=color:#61676ccc>;
</span><span>    })</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><p><strong>wgpu Command Encoders</strong>: Understanding how command encoders work in wgpu is essential for this fix. The <a rel="noopener nofollow noreferrer" href=https://docs.rs/wgpu/latest/wgpu/struct.CommandEncoder.html target=_blank>wgpu documentation on command encoders</a> provides details on recording and submitting commands.</p><li><p><strong>Render Graph Architecture</strong>: Bevy’s render graph system manages the ordering of render operations. The <a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/advanced-topics/rendering/render-graph/ target=_blank>Bevy Render Graph documentation</a> explains how systems are organized into phases.</p><li><p><strong>GPU Timestamp Queries</strong>: This fix relies on timestamp queries for GPU timing. The <a rel="noopener nofollow noreferrer" href=https://docs.rs/wgpu/latest/wgpu/struct.Features.html#associatedconstant.TIMESTAMP_QUERY target=_blank>wgpu timestamp queries documentation</a> covers the feature requirements and usage.</p><li><p><strong>System Sets in Bevy</strong>: PR #22958 introduced the new system sets used here. Understanding <a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/advanced-topics/scheduling/ target=_blank>Bevy’s system sets and scheduling</a> helps contextualize the timing improvements.</p><li><p><strong>Tracy Profiler Integration</strong>: The screenshot shows Tracy profiler output, which is a performance analysis tool. The <a rel="noopener nofollow noreferrer" href=https://github.com/wolfpld/tracy target=_blank>Tracy documentation</a> provides details on GPU profiling capabilities.</p></ol><h1 id=full-code-diff>Full Code Diff</h1><p>diff –git a/crates/bevy_render/src/diagnostic/mod.rs b/crates/bevy_render/src/diagnostic/mod.rs index 952e0eef3dd69..dc26752249d3a 100644 — a/crates/bevy_render/src/diagnostic/mod.rs +++ b/crates/bevy_render/src/diagnostic/mod.rs @@ -10,12 +10,19 @@ mod render_asset_diagnostic_plugin; mod tracy_gpu;<p>use alloc::{borrow::Cow, sync::Arc}; +use bevy_ecs::{<ul><li>schedule::IntoScheduleConfigs,<li>system::{Res, ResMut}, +}; use core::marker::PhantomData; use wgpu::{BufferSlice, CommandEncoder};</ul><p>use bevy_app::{App, Plugin, PreUpdate};<p>-use crate::{renderer::RenderAdapterInfo, RenderApp}; +use crate::{<ul><li>renderer::{PendingCommandBuffers, RenderAdapterInfo, RenderGraph, RenderGraphSystems},<li>RenderApp, +};</ul><p>use self::internal::{sync_diagnostics, Pass, RenderDiagnosticsMutex, WriteTimestamp}; pub use self::{ @@ -75,9 +82,49 @@ impl Plugin for RenderDiagnosticsPlugin { let device = render_app.world().resource::<renderdevice>(); let queue = render_app.world().resource::<renderqueue>(); render_app.insert_resource(DiagnosticsRecorder::new(adapter_info, device, queue)); + <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>   render_app.add_systems(
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       RenderGraph,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       (
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           begin_diagnostics_frame.in_set(RenderGraphSystems::Begin),
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           resolve_encoder
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>               .after(RenderGraphSystems::Render)
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>               .before(RenderGraphSystems::Submit),
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           finish_diagnostics_frame.in_set(RenderGraphSystems::Finish),
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       ),
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   );
</span></code></pre> } }</ul> <p>+/// Starts the diagnostics recorder for the frame. +pub fn begin_diagnostics_frame(mut recorder: ResMut<diagnosticsrecorder>) { <ul><li>recorder.begin_frame(); +}<li></ul> <p>+/// Resolves the encoder used for diagnostic recording +pub fn resolve_encoder(</p> <ul><li>mut recorder: ResMut<diagnosticsrecorder>, <li>render_device: Res<renderdevice>, <li>mut pending_buffers: ResMut<pendingcommandbuffers>, +) { <li>let mut encoder =</li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>   render_device.create_command_encoder(&wgpu::CommandEncoderDescriptor::default());
</span></code></pre></li> <li>recorder.resolve(&mut encoder);</li> <li>pending_buffers.push_encoder(encoder); +}</li> <li></li> <p>+/// Ends the current frame for the diagnostics recorder and syncs it with the main world. +fn finish_diagnostics_frame(</p> <ul><li>mut recorder: ResMut<diagnosticsrecorder>, <li>render_device: Res<renderdevice>, <li>mutex: Res<renderdiagnosticsmutex>, +) { <li>let mutex = mutex.0.clone();</li> <li>recorder.finish_frame(&render_device, move |diagnostics| {</li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>   *mutex.lock().unwrap() = Some(diagnostics);
</span></code></pre></li> <li>}); +}</li> <li></li> <p>/// Allows recording diagnostic spans. pub trait RecordDiagnostics: Send + Sync { /// Begin a time span, which will record elapsed CPU and GPU time.</p>    <div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_22960.patch id=patch-info style=display:none></div>  <div class=bottom-spacer></div> 