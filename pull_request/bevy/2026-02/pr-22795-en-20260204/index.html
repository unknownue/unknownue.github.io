<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22795 fix AssetChanged safety comment
        
    </title><meta content="#22795 fix AssetChanged safety comment" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-04</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-02/pr-22795-zh-cn-20260204>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: fix AssetChanged safety comment<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22795<li><strong>Author</strong>: ecoskey<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Docs, D-Trivial, A-ECS, S-Ready-For-For-Final-Review, D-Unsafe<li><strong>Created</strong>: 2026-02-03T17:26:22Z<li><strong>Merged</strong>: 2026-02-04T00:49:06Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Fix #22787</ul><h2 id=solution>Solution</h2><ul><li>Refer more directly to the actual safety requirements on <code>WorldQuery</code></ul><h2 id=testing>Testing</h2><ul><li>N/A</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This pull request addresses a documentation issue in the Bevy game engine’s asset system. The problem was related to a safety comment in the <code>AssetChanged</code> type’s implementation of the <code>WorldQuery</code> trait. Specifically, the existing safety comment in the <code>init_fetch</code> method was insufficiently detailed and didn’t properly reference the safety guarantees required by the <code>WorldQuery</code> trait.<p>The issue (#22787) pointed out that the safety comment needed clarification. In Rust, unsafe code blocks require explicit justification for why the code is safe, and these justifications must be accurate and complete. The previous comment mentioned that <code>AssetChanges</code> was private and only accessed mutably in the <code>AssetEventSystems</code> system set, but this wasn’t sufficiently precise about the actual safety invariants being upheld.<p>The solution involved updating the safety comment to more directly reference the actual safety requirements of the <code>WorldQuery</code> trait. The new comment explains two key points:<ol><li><p>The <code>resource_id</code> was obtained from <code>world.init_resource::&LTAssetChanges&LTA::Asset>>()</code>, which ensures that the untyped pointer returned by <code>get_resource_by_id</code> can be safely dereferenced into that specific type.</p><li><p>The <code>update_component_access</code> method declares a read on <code>state.resource_id</code>, which makes it safe to read that resource in <code>init_fetch</code>. This directly references the trait-level safety comments on <code>WorldQuery</code> regarding readonly resource access in <code>init_fetch</code>.</p></ol><p>This change doesn’t modify any runtime behavior - it’s purely a documentation fix. However, in Rust, safety documentation is critically important because it helps developers understand the invariants that must be maintained when working with unsafe code. Clear safety comments prevent misuse and make the codebase more maintainable.<p>The implementation is straightforward but addresses an important aspect of Rust development: when using unsafe blocks, the safety justifications must be precise and reference the actual safety requirements of the APIs being used. In this case, the previous comment was describing implementation details (privacy and system set restrictions) rather than the actual safety guarantees provided by the <code>WorldQuery</code> trait contract.<p>This PR serves as a good example of how safety documentation should reference the specific safety requirements of the traits and APIs being implemented, rather than relying on broader architectural patterns. It’s a small but important fix that improves the clarity and correctness of the codebase’s unsafe code documentation.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Issue #22787] --> B[Safety comment too vague]
</span><span>    B --> C[Update comment to reference WorldQuery requirements]
</span><span>    C --> D[Improved safety documentation]
</span><span>    D --> E[Better maintainability]
</span><span>    
</span><span>    F[AssetChanged&LTA>] --> G[WorldQuery implementation]
</span><span>    G --> H[init_fetch method]
</span><span>    H --> I[Requires proper safety justification]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>File:</strong> <code>crates/bevy_asset/src/asset_changed.rs</code><p><strong>Changes:</strong> Updated the safety comment in the <code>init_fetch</code> method of the <code>WorldQuery</code> implementation for <code>AssetChanged&LTA></code> to more accurately reference the safety requirements of the <code>WorldQuery</code> trait.<p><strong>Code Diff:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#abb0b6;font-style:italic>// SAFETY:
</span><span style=color:#abb0b6;font-style:italic>// - `AssetChanges` is private and only accessed mutably in the `AssetEventSystems` system set.
</span><span style=color:#abb0b6;font-style:italic>// - `resource_id` was obtained from the type ID of `AssetChanges&LTA::Asset>`.
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#abb0b6;font-style:italic>// SAFETY:
</span><span style=color:#abb0b6;font-style:italic>// - `state.resource_id` was obtained from `world.init_resource::&LTAssetChanges&LTA::Asset>>()`,
</span><span style=color:#abb0b6;font-style:italic>//   so the untyped pointer returned by `get_resource_by_id` can safely be dereferenced into that type.
</span><span style=color:#abb0b6;font-style:italic>// - `update_component_access` declares a read on `state.resource_id`, so it is safe to
</span><span style=color:#abb0b6;font-style:italic>//   read that resource here (see trait-level safety comments on `WorldQuery`, regarding
</span><span style=color:#abb0b6;font-style:italic>//   readonly resource access in `init_fetch`)
</span></code></pre><p><strong>Why these changes matter:</strong> The updated comment provides more precise safety justifications that directly reference the <code>WorldQuery</code> trait’s safety requirements. This makes the unsafe code more understandable and maintainable by clearly explaining which safety invariants are being upheld.<h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/nomicon/working-with-unsafe.html target=_blank>Rustonomicon - Working with Unsafe</a> - Comprehensive guide to unsafe Rust programming<li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/programming/ecs-intro.html target=_blank>Bevy ECS Documentation</a> - Introduction to Bevy’s Entity Component System<li><a rel="noopener nofollow noreferrer" href=https://rust-lang.github.io/rfcs/2585-ptr-meta.html target=_blank>Rust RFC 2585 - Safe Transmute</a> - Background on pointer safety in Rust<li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy-ecs/latest/bevy_ecs/query/trait.WorldQuery.html target=_blank>Bevy WorldQuery Trait Documentation</a> - Official docs for the <code>WorldQuery</code> trait</ol><h1 id=full-code-diff>Full Code Diff</h1><pre style=color:#61676c;background-color:#fafafa><code><span>diff --git a/crates/bevy_asset/src/asset_changed.rs b/crates/bevy_asset/src/asset_changed.rs
</span><span>index 31b00176c878a..32eb6f88c8ddc 100644
</span><span>--- a/crates/bevy_asset/src/asset_changed.rs
</span><span>+++ b/crates/bevy_asset/src/asset_changed.rs
</span><span>@@ -166,8 +166,11 @@ unsafe impl&LTA: AsAssetId> WorldQuery for AssetChanged&LTA> {
</span><span>         this_run: Tick,
</span><span>     ) -> Self::Fetch<'w> {
</span><span>         // SAFETY:
</span><span>-        // - `AssetChanges` is private and only accessed mutably in the `AssetEventSystems` system set.
</span><span>-        // - `resource_id` was obtained from the type ID of `AssetChanges&LTA::Asset>`.
</span><span>+        // - `state.resource_id` was obtained from `world.init_resource::&LTAssetChanges&LTA::Asset>>()`,
</span><span>+        //   so the untyped pointer returned by `get_resource_by_id` can safely be dereferenced into that type.
</span><span>+        // - `update_component_access` declares a read on `state.resource_id`, so it is safe to
</span><span>+        //   read that resource here (see trait-level safety comments on `WorldQuery`, regarding
</span><span>+        //   readonly resource access in `init_fetch`)
</span><span>         let Some(changes) = (unsafe {
</span><span>             world
</span><span>                 .get_resource_by_id(state.resource_id)
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_22795.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>