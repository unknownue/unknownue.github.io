<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22632 Don't require image/buffer to have COPY_DST to reuse if no data
        
    </title><meta content="#22632 Don't require image/buffer to have COPY_DST to reuse if no data" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-15</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-02/pr-22632-zh-cn-20260215>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Don’t require image/buffer to have COPY_DST to reuse if no data<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22632<li><strong>Author</strong>: beicause<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, C-Usability, D-Straightforward, S-Needs-Review<li><strong>Created</strong>: 2026-01-21T19:56:10Z<li><strong>Merged</strong>: 2026-02-15T14:31:43Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>If image/buffer don’t have data, we won’t call <code>write_texture</code>/<code>write_buffer</code> so we can reuse them even if they don’t have <code>COPY_DST</code> usage.<h2 id=solution>Solution</h2><p><code> (!had_data || usage contains COPY_DST)</code><h2 id=testing>Testing</h2><p>Manually tested.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a specific optimization opportunity in Bevy’s rendering system where GPU resource reuse was unnecessarily restricted. The problem emerged from how Bevy handles GPU resources like textures and buffers when they’re updated or reused between frames.<p>In Bevy’s rendering architecture, when a texture or buffer needs to be updated on the GPU, the system checks whether it can reuse an existing GPU resource. This check includes verifying that the resource has the <code>COPY_DST</code> usage flag, which is required for writing data to the resource via commands like <code>write_texture</code> or <code>write_buffer</code>. This requirement makes logical sense when there’s actual data to copy - without <code>COPY_DST</code>, the write operation would fail.<p>However, the implementation had a subtle oversight: it required <code>COPY_DST</code> even when there was <em>no data to write</em>. Consider a scenario where a texture or buffer is being updated, but the update doesn’t include any actual data payload (perhaps because it’s being cleared or initialized with default values). In such cases, the system wouldn’t call <code>write_texture</code> or <code>write_buffer</code> at all, so the <code>COPY_DST</code> requirement was unnecessary.<p>The fix is straightforward but important for resource optimization. By modifying the condition from:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#ed9366>&&</span><span> usage</span><span style=color:#ed9366>.</span><span style=color:#f07171>contains</span><span>(</span><span style=color:#ff8f40>COPY_DST</span><span>)
</span></code></pre><p>to:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#ed9366>&& </span><span>(</span><span style=color:#ed9366>!</span><span>had_data </span><span style=color:#ed9366>||</span><span> usage</span><span style=color:#ed9366>.</span><span style=color:#f07171>contains</span><span>(</span><span style=color:#ff8f40>COPY_DST</span><span>))
</span></code></pre><p>the system now allows resource reuse when either:<ol><li>There’s no data to write (so <code>COPY_DST</code> isn’t needed), OR<li>There is data to write AND the resource has <code>COPY_DST</code></ol><p>This change improves resource utilization by allowing more textures and buffers to be reused across frames. In scenarios where resources are frequently updated without data payloads (common in certain rendering techniques or when resources are used in multiple contexts), this can reduce GPU memory allocations and improve performance.<p>The implementation change is minimal but demonstrates careful attention to the actual usage patterns of GPU resources. It reflects an understanding that WebGPU and similar APIs enforce strict validation of resource usage flags, and we should only require those flags when they’re genuinely needed for the operations we perform.<p>From an architectural perspective, this change maintains the safety guarantees of the system while expanding its flexibility. Resources without <code>COPY_DST</code> that don’t need data writes can now participate in the reuse optimization, which is particularly valuable for resources that serve as render targets or that are populated via compute shaders rather than CPU data uploads.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[GPU Resource Update] --> B{Has data to write?}
</span><span>    B -->|No| C[Reuse allowed without COPY_DST]
</span><span>    B -->|Yes| D{Resource has COPY_DST?}
</span><span>    D -->|Yes| E[Reuse allowed with write operation]
</span><span>    D -->|No| F[Create new resource]
</span><span>    C --> G[Resource reused]
</span><span>    E --> G
</span><span>    F --> H[New resource created]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-render-src-storage-rs-5-4><code>crates/bevy_render/src/storage.rs</code> (+5/-4)</h3><p>This file handles GPU buffer storage. The change modifies the condition for reusing a GPU buffer when it’s being updated.<p><strong>Key change:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#ed9366>&&</span><span> source_asset
</span><span>    </span><span style=color:#ed9366>.</span><span>buffer_description
</span><span>    </span><span style=color:#ed9366>.</span><span>usage
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>contains</span><span>(BufferUsages</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>COPY_DST</span><span>)
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#ed9366>&& </span><span>(</span><span style=color:#ed9366>!</span><span>had_data
</span><span>    </span><span style=color:#ed9366>||</span><span> source_asset
</span><span>        </span><span style=color:#ed9366>.</span><span>buffer_description
</span><span>        </span><span style=color:#ed9366>.</span><span>usage
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>contains</span><span>(BufferUsages</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>COPY_DST</span><span>))
</span></code></pre><p>The logic now checks whether there’s data to write (<code>had_data</code>) before requiring the <code>COPY_DST</code> usage flag. If there’s no data, the buffer can be reused regardless of whether it has <code>COPY_DST</code>.<h3 id=crates-bevy-render-src-texture-gpu-image-rs-5-4><code>crates/bevy_render/src/texture/gpu_image.rs</code> (+5/-4)</h3><p>This file manages GPU image (texture) resources. The change applies the same logic to texture reuse.<p><strong>Key change:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#ed9366>&&</span><span> prev
</span><span>    </span><span style=color:#ed9366>.</span><span>texture_descriptor
</span><span>    </span><span style=color:#ed9366>.</span><span>usage
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>contains</span><span>(TextureUsages</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>COPY_DST</span><span>)
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#ed9366>&& </span><span>(</span><span style=color:#ed9366>!</span><span>had_data
</span><span>    </span><span style=color:#ed9366>||</span><span> prev
</span><span>        </span><span style=color:#ed9366>.</span><span>texture_descriptor
</span><span>        </span><span style=color:#ed9366>.</span><span>usage
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>contains</span><span>(TextureUsages</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>COPY_DST</span><span>))
</span></code></pre><p>The texture reuse logic now follows the same pattern as buffers: require <code>COPY_DST</code> only when there’s actual texture data to upload.<h2 id=further-reading>Further Reading</h2><ol><li><strong>WebGPU Specification - Buffer Usages</strong>: Understanding the different buffer usage flags including <code>COPY_DST</code>, <code>COPY_SRC</code>, <code>STORAGE</code>, etc.<li><strong>Bevy Render Asset System</strong>: Documentation on how Bevy manages GPU resources and the <code>RenderAsset</code> trait<li><strong>GPU Resource Reuse Patterns</strong>: Common techniques for efficient GPU memory management in game engines<li><strong>WebGPU Validation Rules</strong>: How graphics APIs validate resource usage to prevent errors</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_22632.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>