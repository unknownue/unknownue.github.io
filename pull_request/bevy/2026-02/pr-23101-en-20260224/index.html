<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #23101 Add the ability to set the number of cubes in `many_cubes`.
        
    </title><meta content="#23101 Add the ability to set the number of cubes in `many_cubes`." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-24</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-02/pr-23101-zh-cn-20260224>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>Add the ability to set the number of cubes in <code>many_cubes</code><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Add the ability to set the number of cubes in <code>many_cubes</code>.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/23101<li><strong>Author</strong>: pcwalton<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, C-Examples, S-Ready-For-Final-Review<li><strong>Created</strong>: 2026-02-21T22:05:05Z<li><strong>Merged</strong>: 2026-02-24T02:35:54Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>Surprisingly, despite the number of settings in <code>many_cubes</code>, it was missing the most obvious one: setting the number of cubes. This commit adds this feature. It’s a little more complicated than one might expect, because of the way the number of cubes is never actually set directly, as well as the fact that the demo supports three different patterns.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The <code>many_cubes</code> example in Bevy serves as a stress test for the rendering system, but it had a significant limitation: users couldn’t directly control the number of cubes rendered. While the example offered various configuration options like different layouts (Cube, Sphere, Dense) and material variations, the actual instance count was hardcoded and derived from <code>WIDTH</code> and <code>HEIGHT</code> constants.<p>The problem was that each of the three layout patterns used different calculations to determine instance counts. The Cube layout spawned approximately 0.81 × WIDTH × HEIGHT instances (after accounting for the moiré pattern skip), the Sphere layout used WIDTH × HEIGHT × 4 instances, and the Dense layout used WIDTH × HEIGHT × 2 instances. This inconsistency made it difficult to predict or control the actual number of cubes rendered.<p>The solution was to add an <code>instance_count</code> command-line argument that directly controls the number of cubes. However, implementing this required modifying each layout pattern to respect this parameter while maintaining their specific distribution characteristics.<p>For the Sphere layout, the implementation was straightforward since it uses a Fibonacci spiral distribution where each point corresponds to one cube. The code simply replaced the hardcoded <code>N_POINTS</code> calculation with the <code>instance_count</code> parameter.<p>For the Dense layout, which arranges cubes in a 3D grid, the implementation needed to calculate a grid dimension that would produce approximately the requested number of cubes. The code uses a cube root calculation to determine the size of the grid in each dimension.<p>The Cube layout presented the most complexity. This layout arranges cubes in a 2D grid with a moiré pattern that skips every 10th row and column, and it spawns 4 instances per grid cell. To achieve the target instance count, the code calculates a scaling factor that adjusts the grid dimensions while maintaining the same skip pattern and 4-instance-per-cell behavior.<p>The material initialization code also needed updating. When material data varies per instance, the code now uses <code>instance_count</code> directly to allocate the correct capacity for material handles, rather than using layout-specific calculations.<p>The implementation demonstrates several engineering considerations:<ol><li>Maintaining backward compatibility by providing sensible defaults<li>Handling floating-point calculations carefully to avoid precision issues<li>Ensuring each layout pattern maintains its intended visual characteristics while respecting the new instance count parameter<li>Using appropriate mathematical operations (sqrt, cbrt) for dimension calculations</ol><p>This change makes the <code>many_cubes</code> example more useful as a benchmark tool, allowing developers to precisely control the workload and better understand performance characteristics at different scales.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Command Line Arguments] --> B{instance_count parameter}
</span><span>    B --> C[Sphere Layout]
</span><span>    B --> D[Cube Layout]
</span><span>    B --> E[Dense Layout]
</span><span>    C --> F[Fibonacci Spiral Distribution]
</span><span>    D --> G[2D Grid with Moiré Pattern]
</span><span>    E --> H[3D Grid Distribution]
</span><span>    F --> I[Spawn instance_count cubes]
</span><span>    G --> J[Calculate grid dimensions&LTbr>to achieve instance_count]
</span><span>    H --> K[Calculate grid size via cube root]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=examples-stress-tests-many-cubes-rs-39-14><code>examples/stress_tests/many_cubes.rs</code> (+39/-14)</h3><p>This file contains the main implementation of the <code>many_cubes</code> example. The changes add a new command-line parameter to control the number of cubes and update all three layout patterns to respect this parameter.<p><strong>Key modifications:</strong><ol><li>Added <code>instance_count</code> parameter to the <code>Args</code> struct:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>/// the number of cubes
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>argh</span><span>(option</span><span style=color:#61676ccc>,</span><span> default </span><span style=color:#ed9366>= </span><span style=color:#86b300>"1600000"</span><span>)]
</span><span>instance_count</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize</span><span style=color:#61676ccc>,
</span></code></pre><ol start=2><li>Updated Sphere layout to use <code>instance_count</code>:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>const </span><span style=color:#ff8f40>N_POINTS</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>WIDTH </span><span style=color:#ed9366>* </span><span style=color:#ff8f40>HEIGHT </span><span style=color:#ed9366>* </span><span style=color:#ff8f40>4</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> n_points</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize </span><span style=color:#ed9366>=</span><span> args</span><span style=color:#ed9366>.</span><span>instance_count</span><span style=color:#61676ccc>;
</span></code></pre><ol start=3><li>Updated Cube layout with complex dimension calculation:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added math::ops::sqrt import
</span><span style=color:#fa6e32>use </span><span>math</span><span style=color:#ed9366>::</span><span>ops</span><span style=color:#ed9366>::</span><span>{cbrt</span><span style=color:#61676ccc>,</span><span> sqrt}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Complex calculation to determine grid dimensions
</span><span style=color:#fa6e32>let</span><span> factor </span><span style=color:#ed9366>= </span><span>(</span><span style=color:#ff8f40>5.0 </span><span style=color:#ed9366>/ </span><span style=color:#ff8f40>9.0</span><span>) </span><span style=color:#ed9366>* </span><span style=color:#f07171>sqrt</span><span>(args</span><span style=color:#ed9366>.</span><span>instance_count </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32</span><span>)
</span><span>    </span><span style=color:#ed9366>/ </span><span>(</span><span style=color:#f07171>sqrt</span><span>(</span><span style=color:#ff8f40>HEIGHT </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32</span><span>) </span><span style=color:#ed9366>* </span><span style=color:#f07171>sqrt</span><span>(</span><span style=color:#ff8f40>WIDTH </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32</span><span>))</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> dimensions </span><span style=color:#ed9366>= </span><span>(</span><span style=color:#f07171>vec2</span><span>(</span><span style=color:#ff8f40>WIDTH </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>HEIGHT </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32</span><span>) </span><span style=color:#ed9366>*</span><span> factor)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>ceil</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>as_uvec2</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><ol start=4><li>Updated Dense layout to use <code>instance_count</code>:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> count </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>WIDTH </span><span style=color:#ed9366>* </span><span style=color:#ff8f40>HEIGHT </span><span style=color:#ed9366>* </span><span style=color:#ff8f40>2</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> count </span><span style=color:#ed9366>=</span><span> args</span><span style=color:#ed9366>.</span><span>instance_count</span><span style=color:#61676ccc>;
</span></code></pre><ol start=5><li>Updated material initialization to use <code>instance_count</code>:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let</span><span> capacity </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>if</span><span> args</span><span style=color:#ed9366>.</span><span>vary_material_data_per_instance {
</span><span>    args</span><span style=color:#ed9366>.</span><span>instance_count  </span><span style=color:#abb0b6;font-style:italic>// Changed from layout-specific calculations
</span><span>} </span><span style=color:#fa6e32>else </span><span>{
</span><span>    args</span><span style=color:#ed9366>.</span><span>material_texture_count
</span><span>}
</span></code></pre><p>These changes ensure that all three layout patterns respect the <code>instance_count</code> parameter while maintaining their specific distribution patterns and visual characteristics.<h2 id=further-reading>Further Reading</h2><ol><li><strong>Bevy Examples Documentation</strong>: The <code>many_cubes</code> example is part of Bevy’s stress tests, which are designed to push the rendering system to its limits.<li><strong>Fibonacci Spiral Algorithm</strong>: The Sphere layout uses a Fibonacci spiral distribution for evenly distributing points on a sphere.<li><strong>Moiré Patterns</strong>: The Cube layout uses a skip pattern to avoid visual artifacts that occur with regular grid distributions.<li><strong>Bevy Command-Line Argument Parsing</strong>: The example uses the <code>argh</code> crate for command-line argument parsing, which is integrated into Bevy’s example framework.</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_23101.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>