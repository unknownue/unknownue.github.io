<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20989 Implements specialization keys `VIEW_PROJECTION_*` in depth prepass for shadow maps
        
    </title><meta content="#20989 Implements specialization keys `VIEW_PROJECTION_*` in depth prepass for shadow maps" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-09</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-02/pr-20989-zh-cn-20260209>中文</a></div></div><div class=pr-content><h1 id=implements-specialization-keys-view-projection-in-depth-prepass-for-shadow-maps>Implements specialization keys <code>VIEW_PROJECTION_*</code> in depth prepass for shadow maps</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Implements specialization keys <code>VIEW_PROJECTION_*</code> in depth prepass for shadow maps<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20989<li><strong>Author</strong>: Lichtso<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Feature, A-Rendering, X-Uncontroversial, D-Straightforward, S-Needs-Review<li><strong>Created</strong>: 2025-09-12T18:08:46Z<li><strong>Merged</strong>: 2026-02-09T07:25:18Z<li><strong>Merged By</strong>: superdump</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Fixes #20941<h2 id=solution>Solution</h2><p>Implemented the missing <code>MeshPipelineKey::VIEW_PROJECTION_*</code> in <code>check_views_lights_need_specialization()</code> and <code>PrepassPipeline::specialize()</code>.<h2 id=testing>Testing</h2><p>I implemented a <code>Material</code> with a custom shader pipeline which uses these keys and added light sources with <code>shadows_enabled</code>. Before this change the material only appeared in the normal forward pass, after it also appears in the shadows.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The issue was straightforward but had significant implications for rendering systems that rely on projection-type awareness in shaders. In Bevy’s rendering pipeline, shadow maps are generated using depth prepasses, and these prepasses need to correctly signal what type of projection is being used (orthographic or perspective) to shaders that might behave differently based on projection type.<p>The problem manifested in issue #20941 where custom materials using <code>VIEW_PROJECTION_*</code> shader specializations would only render correctly in the forward pass but not in shadow maps. This happened because two key locations in the codebase weren’t handling these specialization keys for shadow map generation.<p>Looking at the implementation, the fix needed to address two separate but related code paths. First, in the light processing system (<code>light.rs</code>), when determining which specialization keys to use for shadow map rendering, the code wasn’t setting the appropriate <code>VIEW_PROJECTION</code> flags. Directional lights use orthographic projection for their shadow maps, while point and spot lights use perspective projection.<p>The original code in <code>check_views_lights_need_specialization</code> only set the <code>UNCLIPPED_DEPTH_ORTHO</code> flag for directional lights:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let mut</span><span> light_key </span><span style=color:#ed9366>= </span><span>MeshPipelineKey</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>DEPTH_PREPASS</span><span style=color:#61676ccc>;
</span><span>light_key</span><span style=color:#ed9366>.</span><span style=color:#f07171>set</span><span>(MeshPipelineKey</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>UNCLIPPED_DEPTH_ORTHO</span><span style=color:#61676ccc>,</span><span> is_directional_light)</span><span style=color:#61676ccc>;
</span></code></pre><p>This was insufficient because it missed the <code>VIEW_PROJECTION</code> flags that shaders use to differentiate between projection types. The fix adds explicit handling for both projection types:<ul><li>Directional lights: <code>VIEW_PROJECTION_ORTHOGRAPHIC</code> and <code>UNCLIPPED_DEPTH_ORTHO</code><li>Non-directional lights: <code>VIEW_PROJECTION_PERSPECTIVE</code></ul><p>The second part of the fix is in the prepass pipeline specialization (<code>prepass/mod.rs</code>). The <code>PrepassPipeline::specialize</code> method needed to read these <code>VIEW_PROJECTION</code> flags from the <code>MeshPipelineKey</code> and translate them into shader definitions. This is crucial because shader compilation uses these definitions to conditionally compile different code paths.<p>The implementation follows a pattern already established in other parts of the codebase: it extracts the view projection bits from the mesh key using <code>intersection()</code> with <code>VIEW_PROJECTION_RESERVED_BITS</code>, then pushes the corresponding shader definitions (<code>VIEW_PROJECTION_NONSTANDARD</code>, <code>VIEW_PROJECTION_PERSPECTIVE</code>, or <code>VIEW_PROJECTION_ORTHOGRAPHIC</code>).<p>From an architectural perspective, this fix ensures consistency between different rendering passes. The specialization system in Bevy allows shaders to be optimized at compile time for specific scenarios, but only if all code paths that generate those scenarios properly signal their characteristics. Shadow map generation is a specialized rendering pass that wasn’t fully integrated into this system for projection types.<p>The engineering considerations here are minimal but important. The changes are additive and don’t break existing functionality. They follow established patterns in the codebase, making the implementation straightforward and maintainable. The bitmask approach (<code>VIEW_PROJECTION_RESERVED_BITS</code>) ensures that the projection type information is packed efficiently into the existing <code>MeshPipelineKey</code> structure.<p>The impact is significant for developers creating custom materials that need to behave differently based on projection type. Without this fix, such materials would render incorrectly in shadows, leading to visual artifacts or missing shadows entirely. The fix ensures that shadow map generation respects the same projection-aware specialization system as the main rendering passes.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Light Processing System] -->|Sets VIEW_PROJECTION flags| B[MeshPipelineKey]
</span><span>    B -->|Passed to| C[PrepassPipeline::specialize]
</span><span>    C -->|Reads VIEW_PROJECTION bits| D[Shader Definitions]
</span><span>    D -->|Influences| E[Shader Compilation]
</span><span>    E -->|Different code paths| F[Correct Shadow Rendering]
</span><span>    
</span><span>    G[Directional Light] -->|Orthographic| A
</span><span>    H[Point/Spot Light] -->|Perspective| A
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=1-crates-bevy-pbr-src-render-light-rs>1. <code>crates/bevy_pbr/src/render/light.rs</code></h3><p><strong>Change</strong>: Modified <code>check_views_lights_need_specialization</code> to properly set <code>VIEW_PROJECTION</code> flags for shadow map rendering.<p><strong>Why</strong>: This ensures that when generating shadow maps, the pipeline key correctly indicates whether the projection is orthographic (for directional lights) or perspective (for point/spot lights).<p><strong>Code Snippet</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let mut</span><span> light_key </span><span style=color:#ed9366>= </span><span>MeshPipelineKey</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>DEPTH_PREPASS</span><span style=color:#61676ccc>;
</span><span>light_key</span><span style=color:#ed9366>.</span><span style=color:#f07171>set</span><span>(MeshPipelineKey</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>UNCLIPPED_DEPTH_ORTHO</span><span style=color:#61676ccc>,</span><span> is_directional_light)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let mut</span><span> light_key </span><span style=color:#ed9366>= </span><span>MeshPipelineKey</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>DEPTH_PREPASS</span><span style=color:#61676ccc>;
</span><span>light_key</span><span style=color:#ed9366>.</span><span style=color:#f07171>set</span><span>(
</span><span>    MeshPipelineKey</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>VIEW_PROJECTION_ORTHOGRAPHIC
</span><span>        </span><span style=color:#ed9366>| </span><span>MeshPipelineKey</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>UNCLIPPED_DEPTH_ORTHO</span><span style=color:#61676ccc>,
</span><span>    is_directional_light</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span><span>light_key</span><span style=color:#ed9366>.</span><span style=color:#f07171>set</span><span>(
</span><span>    MeshPipelineKey</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>VIEW_PROJECTION_PERSPECTIVE</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#ed9366>!</span><span>is_directional_light</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=2-crates-bevy-pbr-src-prepass-mod-rs>2. <code>crates/bevy_pbr/src/prepass/mod.rs</code></h3><p><strong>Change</strong>: Modified <code>PrepassPipeline::specialize</code> to read <code>VIEW_PROJECTION</code> bits and push corresponding shader definitions.<p><strong>Why</strong>: This translates the projection type information from the pipeline key into shader definitions that can be used for conditional compilation.<p><strong>Code Snippet</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added after existing shader_defs.push("VERTEX_OUTPUT_INSTANCE_INDEX".into());
</span><span style=color:#fa6e32>let</span><span> view_projection </span><span style=color:#ed9366>=</span><span> mesh_key</span><span style=color:#ed9366>.</span><span style=color:#f07171>intersection</span><span>(MeshPipelineKey</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>VIEW_PROJECTION_RESERVED_BITS</span><span>)</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>if</span><span> view_projection </span><span style=color:#ed9366>== </span><span>MeshPipelineKey</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>VIEW_PROJECTION_NONSTANDARD </span><span>{
</span><span>    shader_defs</span><span style=color:#ed9366>.</span><span style=color:#f07171>push</span><span>(</span><span style=color:#86b300>"VIEW_PROJECTION_NONSTANDARD"</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>())</span><span style=color:#61676ccc>;
</span><span>} </span><span style=color:#fa6e32>else if</span><span> view_projection </span><span style=color:#ed9366>== </span><span>MeshPipelineKey</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>VIEW_PROJECTION_PERSPECTIVE </span><span>{
</span><span>    shader_defs</span><span style=color:#ed9366>.</span><span style=color:#f07171>push</span><span>(</span><span style=color:#86b300>"VIEW_PROJECTION_PERSPECTIVE"</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>())</span><span style=color:#61676ccc>;
</span><span>} </span><span style=color:#fa6e32>else if</span><span> view_projection </span><span style=color:#ed9366>== </span><span>MeshPipelineKey</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>VIEW_PROJECTION_ORTHOGRAPHIC </span><span>{
</span><span>    shader_defs</span><span style=color:#ed9366>.</span><span style=color:#f07171>push</span><span>(</span><span style=color:#86b300>"VIEW_PROJECTION_ORTHOGRAPHIC"</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>())</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/3d/rendering/ target=_blank>Bevy Rendering Pipeline Documentation</a> - For understanding Bevy’s rendering architecture<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/3d/shader-specialization/ target=_blank>Shader Specialization in Bevy</a> - For learning about how shader specialization works<li><a rel="noopener nofollow noreferrer" href=https://learnopengl.com/Advanced-Lighting/Shadows/Shadow-Mapping target=_blank>Shadow Mapping Techniques</a> - General concepts of shadow mapping in computer graphics<li><a rel="noopener nofollow noreferrer" href=https://www.scratchapixel.com/lessons/3d-basic-rendering/perspective-and-orthographic-projection-matrix target=_blank>Orthographic vs Perspective Projection</a> - Technical details about different projection types</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_20989.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>