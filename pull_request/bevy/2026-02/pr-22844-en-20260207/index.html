<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22844 remove Debug from material strings and add LoadContext to GltfExtensi…
        
    </title><meta content="#22844 remove Debug from material strings and add LoadContext to GltfExtensi…" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-07</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-02/pr-22844-zh-cn-20260207>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>remove Debug from material strings and add LoadContext to GltfExtensi…<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: remove Debug from material strings and add LoadContext to GltfExtensi…<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22844<li><strong>Author</strong>: ChristopherBiscardi<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, C-Examples, S-Ready-For-Final-Review, A-glTF<li><strong>Created</strong>: 2026-02-07T03:19:01Z<li><strong>Merged</strong>: 2026-02-07T05:51:47Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>https://github.com/bevyengine/bevy/pull/22569 included some regressions. At least some of them are due to the debug formatting in the asset names.<p>This results in asset names like: <code>"DefaultMaterial"#std</code>.<h2 id=solution>Solution</h2><p>Remove the debug formatting.<p>Additionally, enable the initialization of resources like the <code>StandardMaterial</code> built from a <code>GltfMaterial::default()</code> so that the asset loader will have access to them. Materials like this default material that don’t exist will not call the <code>on_material</code> hook, and thus not be initialized to be referenced later.<h2 id=testing>Testing</h2><p>multi_asset_sync and hot_reloading are fixed by this.</p><img alt="screenshot-2026-02-06-at-19 11 31@2x" height=2096 src=https://github.com/user-attachments/assets/07a31bf9-4013-4e80-a285-9b078eb28875 width=3776><img alt="screenshot-2026-02-06-at-19 16 42@2x" height=2096 src=https://github.com/user-attachments/assets/5f1c1848-9469-4108-9600-5115d71d7e4c width=3776><p>but anisotropy still looks wrong, so this is a fix for one issue and there appears to be more to do.</p><img alt="screenshot-2026-02-06-at-19 17 20@2x" height=2096 src=https://github.com/user-attachments/assets/70bd1fe2-39e4-439d-a88e-e34b39aa06a8 width=3776><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a regression introduced in a previous change (PR #22569) that affected how glTF materials are loaded and named. The core issue was that material asset names were being formatted using debug formatting (<code>{:?}</code>), which resulted in asset names containing quotation marks. For example, a material that should be named <code>DefaultMaterial#std</code> was instead being created as <code>"DefaultMaterial"#std</code>, breaking asset lookup and synchronization.<p>The problem manifested in two key scenarios: the <code>multi_asset_sync</code> example and hot reloading functionality. Both were failing because the asset system couldn’t find materials with the incorrectly formatted names. The developer traced this back to the debug formatting and implemented a straightforward fix by switching from <code>{:?}</code> to <code>{}</code> for string formatting.<p>However, during the investigation, a related issue was discovered. The glTF loader system uses extension handlers to process different aspects of glTF files. The <code>GltfExtensionHandlerPbr</code> extension, responsible for PBR materials, was only creating material assets when the <code>on_material</code> hook was called. This hook is triggered for materials explicitly defined in the glTF file. But glTF files can have meshes without explicit materials, which should use a default material. Since the default material isn’t explicitly defined in the file, the <code>on_material</code> hook wasn’t being called for it, leaving the default material uninitialized and unavailable.<p>To solve this, the developer needed to extend the extension handler system. They modified the <code>GltfExtensionHandler</code> trait to pass the <code>LoadContext</code> to the <code>on_root</code> method, allowing extension handlers to add assets during the initial loading phase. Then, in the <code>GltfExtensionHandlerPbr</code> implementation, they added an <code>on_root</code> method that creates and registers the default material asset, ensuring it’s available even when not explicitly defined in the glTF file.<p>The implementation changes are minimal but impactful. The string formatting fix is a one-character change in three places, replacing <code>{:?}</code> with <code>{}</code>. The addition of the <code>on_root</code> method with <code>LoadContext</code> required changes to the trait definition, its implementation in the glTF loader, and the addition of the method in the PBR extension handler.<p>The developer also simplified the code in the <code>on_material</code> method by switching from <code>labeled_asset_scope</code> to <code>add_labeled_asset</code>. This change is more direct and avoids the unnecessary complexity of the scope-based approach.<p>After these changes, the <code>multi_asset_sync</code> and hot reloading examples work correctly again, as shown in the provided screenshots. However, the developer notes that anisotropy still has issues, indicating that while this PR fixes the immediate problems, there may be additional regressions from PR #22569 that need to be addressed separately.<p>From an architectural perspective, this PR demonstrates the importance of consistent string formatting in asset systems and highlights how extension-based loading systems need to handle both explicit and implicit resources. The change to pass <code>LoadContext</code> to <code>on_root</code> gives extension handlers more flexibility during initialization, which could be useful for other extensions that need to create default resources.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[GltfLoader] --> B[LoadContext]
</span><span>    B --> C[GltfExtensionHandler trait]
</span><span>    C --> D[GltfExtensionHandlerPbr]
</span><span>    D --> E[on_root with LoadContext]
</span><span>    D --> F[on_material]
</span><span>    D --> G[on_spawn_mesh_and_material]
</span><span>    E --> H[Creates default StandardMaterial]
</span><span>    F --> I[Creates StandardMaterial from GltfMaterial]
</span><span>    G --> J[Assigns material to entity]
</span><span>    H --> K[Asset named "DefaultMaterial#std"]
</span><span>    I --> L[Asset named "{material_label}#std"]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-gltf-src-loader-extensions-mod-rs><code>crates/bevy_gltf/src/loader/extensions/mod.rs</code></h3><p><strong>Change</strong>: Added <code>LoadContext</code> parameter to the <code>on_root</code> method of the <code>GltfExtensionHandler</code> trait.<p><strong>Why</strong>: This allows extension handlers to access the <code>LoadContext</code> during the root processing phase, enabling them to add labeled assets like the default material.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>on_root</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>gltf</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>gltf</span><span style=color:#ed9366>::</span><span>Gltf) {}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>on_root</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>load_context</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span>LoadContext<'</span><span style=color:#ed9366>_</span><span>>, </span><span style=color:#ff8f40>gltf</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>gltf</span><span style=color:#ed9366>::</span><span>Gltf) {}
</span></code></pre><h3 id=crates-bevy-gltf-src-loader-mod-rs><code>crates/bevy_gltf/src/loader/mod.rs</code></h3><p><strong>Change</strong>: Updated the call to <code>extension.on_root</code> to pass the <code>load_context</code> parameter.<p><strong>Why</strong>: This ensures that the glTF loader provides the necessary <code>LoadContext</code> to extension handlers when calling their <code>on_root</code> method.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>for</span><span> extension </span><span style=color:#ed9366>in</span><span> extensions</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter_mut</span><span>() {
</span><span>    extension</span><span style=color:#ed9366>.</span><span style=color:#f07171>on_root</span><span>(</span><span style=color:#ed9366>&</span><span>gltf)</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>for</span><span> extension </span><span style=color:#ed9366>in</span><span> extensions</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter_mut</span><span>() {
</span><span>    extension</span><span style=color:#ed9366>.</span><span style=color:#f07171>on_root</span><span>(load_context</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>gltf)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=crates-bevy-pbr-src-lib-rs><code>crates/bevy_pbr/src/lib.rs</code></h3><p><strong>Change</strong>:<ol><li>Fixed string formatting by replacing <code>{:?}</code> with <code>{}</code> in material label creation<li>Added <code>on_root</code> method to create the default material<li>Simplified asset creation by using <code>add_labeled_asset</code> instead of <code>labeled_asset_scope</code></ol><p><strong>Why</strong>: These changes fix the asset naming issue and ensure the default material is always available, even when not explicitly defined in glTF files.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before (on_material method):
</span><span style=color:#fa6e32>let</span><span> std_label </span><span style=color:#ed9366>= </span><span style=color:#f07171>format!</span><span>(</span><span style=color:#86b300>"</span><span style=color:#ff8f40>{:?}</span><span style=color:#86b300>#std"</span><span style=color:#61676ccc>,</span><span> material_label)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>let</span><span> _t </span><span style=color:#ed9366>=</span><span> load_context</span><span style=color:#ed9366>.</span><span>labeled_asset_scope</span><span style=color:#ed9366>::</span><span><</span><span style=color:#ed9366>_</span><span>, ()>(std_label</span><span style=color:#61676ccc>, </span><span>|</span><span style=color:#ff8f40>_load_context</span><span>| {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(</span><span style=color:#f07171>standard_material_from_gltf_material</span><span>(material_asset))
</span><span>})</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After (on_material method):
</span><span style=color:#fa6e32>let</span><span> std_label </span><span style=color:#ed9366>= </span><span style=color:#f07171>format!</span><span>(</span><span style=color:#86b300>"</span><span style=color:#ff8f40>{}</span><span style=color:#86b300>#std"</span><span style=color:#61676ccc>,</span><span> material_label)</span><span style=color:#61676ccc>;
</span><span>
</span><span>load_context</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_labeled_asset</span><span>(
</span><span>    std_label</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#f07171>standard_material_from_gltf_material</span><span>(material_asset)</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// New on_root method:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>on_root</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>load_context</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span>LoadContext<'</span><span style=color:#ed9366>_</span><span>>, </span><span style=color:#ff8f40>_gltf</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>gltf</span><span style=color:#ed9366>::</span><span>Gltf) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// create the `StandardMaterial` for the glTF `DefaultMaterial` so
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// it can be accessed when meshes don't have materials.
</span><span>    </span><span style=color:#fa6e32>let</span><span> std_label </span><span style=color:#ed9366>= </span><span style=color:#f07171>format!</span><span>(</span><span style=color:#86b300>"</span><span style=color:#ff8f40>{}</span><span style=color:#86b300>#std"</span><span style=color:#61676ccc>, </span><span>GltfAssetLabel</span><span style=color:#ed9366>::</span><span>DefaultMaterial)</span><span style=color:#61676ccc>;
</span><span>
</span><span>    load_context</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_labeled_asset</span><span>(
</span><span>        std_label</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#f07171>standard_material_from_gltf_material</span><span>(</span><span style=color:#ed9366>&</span><span>GltfMaterial</span><span style=color:#ed9366>::</span><span>default())</span><span style=color:#61676ccc>,
</span><span>    )</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/std/fmt/index.html target=_blank>Rust Formatting Documentation</a> - Details on the difference between <code>{}</code> (Display) and <code>{:?}</code> (Debug) formatting<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/assets/ target=_blank>Bevy Asset System</a> - Overview of how assets are loaded and managed in Bevy<li><a rel="noopener nofollow noreferrer" href=https://www.khronos.org/gltf/ target=_blank>glTF Specification</a> - Official specification for the glTF file format<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/tree/main/crates/bevy_gltf target=_blank>Bevy glTF Loading</a> - Source code for Bevy’s glTF loader implementation</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_22844.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>