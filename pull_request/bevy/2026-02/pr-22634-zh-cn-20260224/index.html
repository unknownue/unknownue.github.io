<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22634 Overrides for no-path in autonavigation for `bevy_input_focus
        
    </title><meta content="#22634 Overrides for no-path in autonavigation for `bevy_input_focus" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-24</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2026-02/pr-22634-en-20260224>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=biao-ti-overrides-for-no-path-in-autonavigation-for-bevy-input-focus>标题: Overrides for no-path in autonavigation for <code>bevy_input_focus</code></h1><h2 id=ji-ben-xin-xi>基本信息</h2><ul><li><strong>标题</strong>: Overrides for no-path in autonavigation for <code>bevy_input_focus</code><li><strong>PR链接</strong>: https://github.com/bevyengine/bevy/pull/22634<li><strong>作者</strong>: kumaryash6352<li><strong>状态</strong>: 已合并<li><strong>标签</strong>: C-Feature, A-UI, S-Ready-For-Final-Review, D-Modest<li><strong>创建时间</strong>: 2026-01-21T20:43:59Z<li><strong>合并时间</strong>: 2026-02-24T03:08:28Z<li><strong>合并者</strong>: alice-i-cecile</ul><h2 id=miao-shu-fan-yi>描述翻译</h2><h3 id=mu-biao>目标</h3><ul><li>修复 #22378</ul><h3 id=jie-jue-fang-an>解决方案</h3><p>将 <code>NavNeighbors</code> 从存储 <code>Option&LTEntity></code> 数组改为存储 <code>NavNeighbor</code> 枚举数组。<code>NavNeighbor</code> 枚举包含3个值：<code>Unset</code>（此方向未明确设置任何内容）、<code>Blocked</code>（假设此方向没有可路径导航的目标）和 <code>Neighbor(Entity)</code>。<h3 id=ce-shi>测试</h3><p>使用新的测试 <code>test_respects_set_blocks</code> 和手动使用 <code>directional_navigation_override</code> 示例来测试更改。第二页的每个按钮都限制为左/右移动，因为上/下方向被阻止。<h3 id=zhan-shi>展示</h3><p>我不太确定如何展示这个功能，因为它是一个非常面向输入的功能，而且功能正常工作意味着什么都没有发生。<h2 id=zhe-ge-pull-requestde-gu-shi>这个Pull Request的故事</h2><p>这个Pull Request解决了一个特定的用户界面导航问题：开发者需要能够明确阻止特定方向的自动导航，而不仅仅是“未设置“状态。在原来的实现中，导航邻接关系使用 <code>Option&LTEntity></code> 表示，这只能区分“有邻居“和“无邻居“两种状态。但对于UI导航来说，有时需要明确表示“这个方向应该被阻止导航“，而不仅仅是“还没有找到邻居“。<p>问题的核心在于 #22378 中描述的场景：当使用方向键在UI元素间导航时，系统需要区分“此方向没有设置邻居（但可以自动查找）“和“此方向应该明确阻止导航”。原来的 <code>Option&LTEntity></code> 无法表达这种区别，因为 <code>None</code> 同时表示“未设置“和“没有邻居“。<p>开发者采用的解决方案是引入一个新的枚举类型 <code>NavNeighbor</code>，包含三种状态：<ul><li><code>Auto</code>: 未显式设置，允许自动查找邻居<li><code>Blocked</code>: 明确阻止在此方向导航<li><code>Set(Entity)</code>: 已明确设置邻居实体</ul><p>这个设计决策有几个关键考虑。首先，保持向后兼容性很重要，所以 <code>Default</code> 实现是 <code>Auto</code> 状态，这与原来的 <code>None</code> 行为相似。其次，需要更新所有相关方法来处理新的三态逻辑，而不仅仅是原来的二元逻辑。<p>在实现上，开发者重构了 <code>NavNeighbors</code> 结构体，将其内部数组类型从 <code>[Option&LTEntity>; 8]</code> 改为 <code>[NavNeighbor; 8]</code>。这影响了多个方面：<ol><li><code>get</code> 方法现在返回 <code>NavNeighbor</code> 而不是 <code>Option&LTEntity></code><li>新增 <code>block</code> 方法用于设置阻止状态<li><code>set</code> 方法现在设置 <code>NavNeighbor::Set(entity)</code></ol><p>在 <code>DirectionalNavigationMap</code> 中，<code>get_neighbor</code> 方法也改为返回 <code>NavNeighbor</code>。这要求在导航系统 (<code>DirectionalNavigation::navigate</code>) 中更新逻辑，现在需要匹配三种状态：<ul><li>如果是 <code>Auto</code>，尝试自动导航（如果失败则返回错误）<li>如果是 <code>Blocked</code>，直接返回阻塞错误<li>如果是 <code>Set(entity)</code>，直接导航到指定实体</ul><p>一个重要的实现细节是 <code>auto_generate_navigation_edges</code> 函数。这个函数负责自动生成导航边，现在需要检查当前状态是否是 <code>Blocked</code> 或 <code>Set</code>，如果是则跳过自动生成，这确保了手动设置（无论是明确邻居还是阻止）不会被自动系统覆盖。<p>技术上的一个重要决策是如何处理对称边。开发者提供了 <code>block_symmetrical_edge</code> 方法，但注意 <code>block_edge</code> 不是对称的，这与 <code>add_edge</code> 的行为一致。这意味着阻止A到B的导航不会自动阻止B到A的导航，这给了开发者更精细的控制。<p>在 <code>bevy_ui</code> 的 <code>AutoDirectionalNavigator</code> 中，导航逻辑需要适应新的错误类型。现在，只有 <code>NoNeighborInDirection</code> 错误会触发自动导航尝试，而 <code>BlockedNavigation</code> 错误则直接返回，不尝试自动查找。<p>示例代码的更新展示了如何使用这个新功能。在第一页中，每个按钮都阻止了上下方向的导航，但用户仍然可以通过左右方向在不同行间导航。这是一个实际的用例，展示了如何创建受限的导航模式。<p>这个实现的一个微妙之处是性能影响：使用枚举而不是 <code>Option&LTEntity></code> 的内存占用略有增加，但提供了更强的表达能力。对于UI导航系统来说，这种表达能力的提升是值得的，因为它允许更精确的导航控制。<p>从架构角度看，这个改变遵循了Rust的类型安全原则：使用类型系统来区分不同的语义状态，而不是依赖注释或约定。通过将“未设置“、“已阻止“和“已设置“编码为不同的变体，编译器可以确保每种情况都被正确处理。<h2 id=shi-jue-biao-shi>视觉表示</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[用户输入方向键] --> B[DirectionalNavigation系统]
</span><span>    B --> C{检查NavNeighbors}
</span><span>    C -->|Auto状态| D[尝试自动查找邻居]
</span><span>    C -->|Blocked状态| E[返回BlockedNavigation错误]
</span><span>    C -->|Set(Entity)状态| F[导航到指定实体]
</span><span>    D --> G{找到合适邻居?}
</span><span>    G -->|是| F
</span><span>    G -->|否| H[返回NoNeighborInDirection错误]
</span></code></pre><h2 id=guan-jian-wen-jian-geng-gai>关键文件更改</h2><h3 id=1-crates-bevy-input-focus-src-directional-navigation-rs-236-57>1. <code>crates/bevy_input_focus/src/directional_navigation.rs</code> (+236/-57)</h3><p><strong>主要更改和原因</strong>: 这是核心改动文件，引入了新的 <code>NavNeighbor</code> 枚举，并重构了相关类型和方法以支持三态导航逻辑。<p><strong>关键代码片段</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 新的枚举定义
</span><span style=color:#fa6e32>pub enum </span><span style=color:#399ee6>NavNeighbor </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>/// No neighbor explicitly set.
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>default</span><span>]
</span><span>    Auto</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>/// Do not find a neighbor.
</span><span>    Blocked</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>/// The neighbor is known and set.
</span><span>    Set(Entity)</span><span style=color:#61676ccc>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// NavNeighbors 结构体的变化
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>NavNeighbors </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 从 Option&LTEntity> 改为 NavNeighbor
</span><span>    </span><span style=color:#fa6e32>pub </span><span>neighbors</span><span style=color:#61676ccc>:</span><span> [NavNeighbor; 8],
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 新增的 block 方法
</span><span style=color:#fa6e32>pub const fn </span><span style=color:#f29718>block</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>octant</span><span style=color:#61676ccc>:</span><span> CompassOctant) {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>neighbors[octant</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_index</span><span>()] </span><span style=color:#ed9366>= </span><span>NavNeighbor</span><span style=color:#ed9366>::</span><span>Blocked</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// DirectionalNavigation::navigate 方法的更新
</span><span style=color:#fa6e32>match </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>map</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_neighbor</span><span>(current_focus</span><span style=color:#61676ccc>,</span><span> direction) {
</span><span>    NavNeighbor</span><span style=color:#ed9366>::</span><span>Auto </span><span style=color:#ed9366>=> </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(DirectionalNavigationError</span><span style=color:#ed9366>::</span><span>NoNeighborInDirection {
</span><span>        current_focus</span><span style=color:#61676ccc>,
</span><span>        direction</span><span style=color:#61676ccc>,
</span><span>    })</span><span style=color:#61676ccc>,
</span><span>    NavNeighbor</span><span style=color:#ed9366>::</span><span>Blocked </span><span style=color:#ed9366>=> </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(DirectionalNavigationError</span><span style=color:#ed9366>::</span><span>BlockedNavigation {
</span><span>        current_focus</span><span style=color:#61676ccc>,
</span><span>        direction</span><span style=color:#61676ccc>,
</span><span>    })</span><span style=color:#61676ccc>,
</span><span>    NavNeighbor</span><span style=color:#ed9366>::</span><span>Set(new_focus) </span><span style=color:#ed9366>=> </span><span>{
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>focus</span><span style=color:#ed9366>.</span><span style=color:#f07171>set</span><span>(new_focus)</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(new_focus)
</span><span>    }
</span><span>}
</span></code></pre><h3 id=2-examples-ui-navigation-directional-navigation-overrides-rs-35-24>2. <code>examples/ui/navigation/directional_navigation_overrides.rs</code> (+35/-24)</h3><p><strong>主要更改和原因</strong>: 更新示例以展示新的阻塞功能，特别展示了如何在第一页中阻止按钮的上下导航。<p><strong>关键代码片段</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 在第一页的每个按钮上阻止上下导航
</span><span style=color:#fa6e32>for</span><span> btn </span><span style=color:#ed9366>in &</span><span>pages_entities[</span><span style=color:#ff8f40>0</span><span>] {
</span><span>    manual_directional_nav_map</span><span style=color:#ed9366>.</span><span style=color:#f07171>block_edge</span><span>(</span><span style=color:#ed9366>*</span><span>btn</span><span style=color:#61676ccc>, </span><span>CompassOctant</span><span style=color:#ed9366>::</span><span>South)</span><span style=color:#61676ccc>;
</span><span>    manual_directional_nav_map</span><span style=color:#ed9366>.</span><span style=color:#f07171>block_edge</span><span>(</span><span style=color:#ed9366>*</span><span>btn</span><span style=color:#61676ccc>, </span><span>CompassOctant</span><span style=color:#ed9366>::</span><span>North)</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 更新页脚文本以说明第一页的导航限制
</span><span style=color:#fa6e32>let</span><span> text </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>match</span><span> page_num {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// For the first page, add a notice about vertical navigation being blocked off
</span><span>    </span><span style=color:#ff8f40>0 </span><span style=color:#ed9366>=> </span><span>Text</span><span style=color:#ed9366>::</span><span>new(
</span><span>        </span><span style=color:#86b300>"Vertical movements disabled on each button, but you can still navigate between rows by going off the left or right sides."
</span><span>    )</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... 其他页面
</span><span>    </span><span style=color:#ed9366>_ => </span><span>Text</span><span style=color:#ed9366>::</span><span>default()
</span><span>}</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=3-crates-bevy-ui-src-auto-directional-navigation-rs-25-19>3. <code>crates/bevy_ui/src/auto_directional_navigation.rs</code> (+25/-19)</h3><p><strong>主要更改和原因</strong>: 更新自动导航器以正确处理新的阻塞错误类型，确保只有 <code>NoNeighborInDirection</code> 错误会触发自动导航。<p><strong>关键代码片段</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>match </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>manual_directional_navigation</span><span style=color:#ed9366>.</span><span style=color:#f07171>navigate</span><span>(direction) {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(new_focus) </span><span style=color:#ed9366>=> </span><span>{
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>manual_directional_navigation</span><span style=color:#ed9366>.</span><span>focus</span><span style=color:#ed9366>.</span><span style=color:#f07171>set</span><span>(new_focus)</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(new_focus)
</span><span>    }
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(DirectionalNavigationError</span><span style=color:#ed9366>::</span><span>NoNeighborInDirection { </span><span style=color:#ed9366>.. </span><span>}) </span><span style=color:#ed9366>=> </span><span>{
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// 尝试自动导航...
</span><span>    }
</span><span>    err </span><span style=color:#ed9366>=></span><span> err</span><span style=color:#61676ccc>, </span><span style=color:#abb0b6;font-style:italic>// 其他错误（包括BlockedNavigation）直接返回
</span><span>}
</span></code></pre><h2 id=wan-zheng-dai-ma-chai-yi>完整代码差异</h2><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>// 详细差异见原始PR，主要更改包括：
</span><span>// 1. 引入 NavNeighbor 枚举
</span><span>// 2. 更新 NavNeighbors 使用新枚举
</span><span>// 3. 添加 block_edge 和 block_symmetrical_edge 方法
</span><span>// 4. 更新所有相关方法处理三态逻辑
</span><span>// 5. 添加测试 test_respects_set_blocks
</span><span>// 6. 更新示例展示阻塞功能
</span></code></pre><h2 id=jin-yi-bu-yue-du>进一步阅读</h2><p>对于想要了解更多关于此PR中使用的概念和模式的读者，建议查看：<ol><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/book/ch06-00-enums.html target=_blank>Rust枚举模式</a> - 了解如何使用枚举表示状态<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/books/bevy-ui-navigation/ target=_blank>Bevy UI导航系统文档</a> - 了解Bevy的UI导航架构<li><a rel="noopener nofollow noreferrer" href=https://gameprogrammingpatterns.com/state.html target=_blank>状态模式在游戏开发中的应用</a> - 了解状态模式，这与三态导航逻辑相关<li><a rel="noopener nofollow noreferrer" href=https://www.parsonsmatt.org/2017/04/26/type_safe_directional_navigation_in_rust.html target=_blank>类型驱动设计</a> - 了解如何使用类型系统提高代码安全性</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_22634.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>