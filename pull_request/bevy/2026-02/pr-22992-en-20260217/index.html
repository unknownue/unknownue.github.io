<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22992 Ktx2, Basis, and DDS files ignoring RenderAssetUsages from .meta files
        
    </title><meta content="#22992 Ktx2, Basis, and DDS files ignoring RenderAssetUsages from .meta files" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-17</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-02/pr-22992-zh-cn-20260217>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>Ktx2, Basis, and DDS files ignoring RenderAssetUsages from .meta files<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Ktx2, Basis, and DDS files ignoring RenderAssetUsages from .meta files<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22992<li><strong>Author</strong>: mholiv<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, S-Ready-For-Final-Review, D-Straightforward<li><strong>Created</strong>: 2026-02-17T08:27:39Z<li><strong>Merged</strong>: 2026-02-17T17:23:27Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p><strong>Objective</strong><p>Fixes #22969<p>Setting asset_usage in a .meta file (e.g. <code>RenderAssetUsages("RENDER_WORLD")</code>) is silently ignored for KTX2, Basis, and DDS textures. The texture always loads with the default <code>MAIN_WORLD | RENDER_WORLD</code>, so CPU-side pixel data is never freed after GPU upload.<p>This happens because <code>asset_usage</code> is only applied inside the catch-all <code>_</code> arm of the format match in <code>Image::from_buffer</code>. The KTX2, Basis, and DDS arms call their own <code>*_buffer_to_image</code> functions which create an <code>Image::default()</code>, bypassing the setting entirely.<p><strong>Solution</strong><p>Set <code>image.asset_usage = asset_usage</code> after the format match in from_buffer, right next to where <code>image.sampler</code> is already set. This applies the correct usage for all formats uniformly.<p><strong>Testing</strong><p>cargo test -p bevy_image, all tests pass.<p>Edit: Tested this patch in my game, ktx files no longer in system memory after transfer to GPU renderworld.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This pull request addresses a memory management issue in Bevy’s texture loading system. The problem involves specific compressed texture formats - KTX2, Basis, and DDS - not respecting memory usage flags configured in metadata files.<p>The core issue was that when textures are loaded, Bevy uses the <code>RenderAssetUsages</code> setting to determine whether to keep CPU-side pixel data after uploading to the GPU. This is a critical optimization: for textures that only need to exist on the GPU (like most game textures), we want to free the CPU memory after the GPU upload completes. This is controlled via <code>.meta</code> files where developers can specify <code>RenderAssetUsages("RENDER_WORLD")</code>.<p>The bug occurred because the <code>Image::from_buffer</code> method was inconsistently applying the <code>asset_usage</code> parameter. Looking at the code structure, when loading standard formats like PNG or JPEG, the code followed the catch-all <code>_</code> arm in a match statement, which correctly set the <code>asset_usage</code> field. However, for specialized compressed formats (KTX2, Basis, and DDS), separate <code>*_buffer_to_image</code> functions were called that returned <code>Image::default()</code> instances, bypassing the intended <code>asset_usage</code> setting entirely.<p>The consequence was predictable: these compressed textures would always load with the default <code>MAIN_WORLD | RENDER_WORLD</code> usage, meaning their CPU data was never freed after GPU upload. In memory-constrained environments or with many textures, this could significantly increase memory usage without providing any benefit.<p>The fix is straightforward and demonstrates good software engineering practice. Rather than modifying each of the three separate <code>*_buffer_to_image</code> functions or duplicating code, the solution moves the <code>asset_usage</code> assignment to a common location after the format-specific decoding logic completes. This placement next to where the <code>sampler</code> is already set makes logical sense - both are post-processing steps that should apply uniformly regardless of the decoding path.<p>The change is minimal (adding just one line) but effectively solves the problem for all formats. This approach maintains clean separation of concerns: the format-specific decoders focus on decoding the compressed data, while the calling function handles the uniform application of rendering-specific configuration.<p>From an architectural perspective, this fix highlights the importance of considering all code paths when implementing configuration propagation. The original implementation had the right idea - setting <code>asset_usage</code> - but only applied it to one code path. The fix ensures consistency across all supported texture formats.<p>Testing confirms the solution works: all existing tests pass, and the author verified in their actual game that KTX files no longer remain in system memory after GPU transfer. This is exactly the behavior developers expect when setting <code>RenderAssetUsages("RENDER_WORLD")</code> in their metadata files.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Image::from_buffer] --> B{Format Match}
</span><span>    B -->|KTX2| C[ktx2_buffer_to_image]
</span><span>    B -->|Basis| D[basis_buffer_to_image]
</span><span>    B -->|DDS| E[dds_buffer_to_image]
</span><span>    B -->|Other| F[Other decoding logic]
</span><span>    C --> G[Returns Image::default]
</span><span>    D --> G
</span><span>    E --> G
</span><span>    F --> H[Sets asset_usage in match arm]
</span><span>    G --> I[Post-processing: Set sampler + asset_usage]
</span><span>    H --> I
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-image-src-image-rs-1-0><code>crates/bevy_image/src/image.rs</code> (+1/-0)</h3><p><strong>What changed and why</strong>: Added a single line to ensure the <code>asset_usage</code> parameter is applied to all <code>Image</code> instances created by <code>Image::from_buffer</code>, regardless of the image format. Previously, this setting was only applied in the catch-all case of a match statement, missing KTX2, Basis, and DDS formats.<p><strong>Code snippet showing the change</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// The relevant section of Image::from_buffer method
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Before (simplified representation):
</span><span style=color:#fa6e32>let mut</span><span> image </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>match</span><span> format {
</span><span>    ImageFormat</span><span style=color:#ed9366>::</span><span>Ktx2 </span><span style=color:#ed9366>=> </span><span style=color:#f07171>ktx2_buffer_to_image</span><span>(buffer</span><span style=color:#61676ccc>,</span><span> format</span><span style=color:#61676ccc>,</span><span> supported_compressed_formats)</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>,
</span><span>    ImageFormat</span><span style=color:#ed9366>::</span><span>Basis </span><span style=color:#ed9366>=> </span><span style=color:#f07171>basis_buffer_to_image</span><span>(buffer</span><span style=color:#61676ccc>,</span><span> format</span><span style=color:#61676ccc>,</span><span> supported_compressed_formats)</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>,
</span><span>    ImageFormat</span><span style=color:#ed9366>::</span><span>Dds </span><span style=color:#ed9366>=> </span><span style=color:#f07171>dds_buffer_to_image</span><span>(buffer</span><span style=color:#61676ccc>,</span><span> format</span><span style=color:#61676ccc>,</span><span> supported_compressed_formats)</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#ed9366>_ => </span><span>{
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ... decoding logic for other formats ...
</span><span>        image</span><span style=color:#ed9366>.</span><span>asset_usage </span><span style=color:#ed9366>=</span><span> asset_usage</span><span style=color:#61676ccc>;  </span><span style=color:#abb0b6;font-style:italic>// Only set here
</span><span>        image
</span><span>    }
</span><span>}</span><span style=color:#61676ccc>;
</span><span>image</span><span style=color:#ed9366>.</span><span>sampler </span><span style=color:#ed9366>=</span><span> image_sampler</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// asset_usage not set for KTX2/Basis/DDS here
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let mut</span><span> image </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>match</span><span> format {
</span><span>    ImageFormat</span><span style=color:#ed9366>::</span><span>Ktx2 </span><span style=color:#ed9366>=> </span><span style=color:#f07171>ktx2_buffer_to_image</span><span>(buffer</span><span style=color:#61676ccc>,</span><span> format</span><span style=color:#61676ccc>,</span><span> supported_compressed_formats)</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>,
</span><span>    ImageFormat</span><span style=color:#ed9366>::</span><span>Basis </span><span style=color:#ed9366>=> </span><span style=color:#f07171>basis_buffer_to_image</span><span>(buffer</span><span style=color:#61676ccc>,</span><span> format</span><span style=color:#61676ccc>,</span><span> supported_compressed_formats)</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>,
</span><span>    ImageFormat</span><span style=color:#ed9366>::</span><span>Dds </span><span style=color:#ed9366>=> </span><span style=color:#f07171>dds_buffer_to_image</span><span>(buffer</span><span style=color:#61676ccc>,</span><span> format</span><span style=color:#61676ccc>,</span><span> supported_compressed_formats)</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#ed9366>_ => </span><span>{
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ... decoding logic for other formats ...
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// Note: asset_usage no longer set here
</span><span>        image
</span><span>    }
</span><span>}</span><span style=color:#61676ccc>;
</span><span>image</span><span style=color:#ed9366>.</span><span>sampler </span><span style=color:#ed9366>=</span><span> image_sampler</span><span style=color:#61676ccc>;
</span><span>image</span><span style=color:#ed9366>.</span><span>asset_usage </span><span style=color:#ed9366>=</span><span> asset_usage</span><span style=color:#61676ccc>;  </span><span style=color:#abb0b6;font-style:italic>// Now set uniformly for all formats
</span></code></pre><p><strong>How these changes relate to the overall purpose</strong>: This single-line addition fixes the memory leak issue for compressed textures by ensuring all image formats respect the <code>asset_usage</code> configuration from <code>.meta</code> files. The change moves the setting to a common location after format-specific decoding, guaranteeing consistent behavior.<h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/assets/ target=_blank>Bevy Asset System Documentation</a> - Understanding how assets and metadata work in Bevy<li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/render/render_resource/enum.RenderAssetUsages.html target=_blank>RenderAssetUsages API Documentation</a> - Official documentation for the RenderAssetUsages enum<li><a rel="noopener nofollow noreferrer" href=https://www.khronos.org/opengl/wiki/Compressed_Texture target=_blank>Compressed Texture Formats in Graphics Programming</a> - Background on KTX2, Basis, and DDS formats<li><a rel="noopener nofollow noreferrer" href=https://gameprogrammingpatterns.com/object-pool.html target=_blank>Memory Management in Game Engines</a> - Patterns for efficient resource management in games</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_22992.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>