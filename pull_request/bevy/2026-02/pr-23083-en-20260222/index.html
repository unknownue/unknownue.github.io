<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #23083 Fix 2d specialization w/ change lists.
        
    </title><meta content="#23083 Fix 2d specialization w/ change lists." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-22</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-02/pr-23083-zh-cn-20260222>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix 2d specialization w/ change lists.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/23083<li><strong>Author</strong>: tychedelia<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, S-Ready-For-Final-Review, P-Regression<li><strong>Created</strong>: 2026-02-20T21:32:53Z<li><strong>Merged</strong>: 2026-02-22T04:53:04Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>Some fixes for 2d post #22966.<p>This is complicated because, unlike 3d, 2d material systems are generic over their material and not type erased. Which means we have to be defensive against all the weird scenarios that can happen when different material systems race against each other.<p>I am not confident this is correct. The ultimate solution is just to get rid of all these bespoke 2d systems.<p>The main fixes are:<ul><li><code>material_bind_group_id</code> is no longer reset to default every frame. <code>extract_mesh2d</code> was setting <code>material_bind_group_id</code> on every extraction. Previously this was overwritten later during queuing every frame, but with dirty tracking, entities aren’t re-queued every frame so the default sticks.<li><code>prepare_for_new_frame</code> moved to a non-generic system.<li>More careful about not adding wrong material type entities to the pending queue where they’ll churn forever without getting specialized.<li>Dequeue no longer cross-type stomps. When a view is dirty, we were returning all visible entities, which was problematic in the context of multiple materials.</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The problem started with PR #22966, which introduced change list (dirty tracking) optimizations to Bevy’s rendering systems. While these optimizations reduced unnecessary work, they exposed several edge cases in the 2D rendering pipeline that weren’t apparent when everything was re-processed every frame.<p>The core issue is that 2D material systems in Bevy are generic over their material types and not type-erased, unlike the 3D systems. This creates complex interactions when multiple material systems run concurrently, especially when entities change material types or become invisible. Without the safety net of processing everything every frame, these edge cases cause rendering artifacts and infinite loops.<p>The first major issue was with <code>material_bind_group_id</code>. In the extraction phase, <code>extract_mesh2d</code> was resetting this ID to its default value on every frame. Previously, this didn’t matter because the queuing system would overwrite it later in the same frame. But with dirty tracking, entities that haven’t changed aren’t re-queued, so the default value persists, causing incorrect bind groups to be used during rendering.<p>The second issue involved the pending queue system. Each material type maintains its own queue of entities that need specialization. The <code>prepare_for_new_frame</code> logic was running as a generic system, which meant each material type was independently managing view states. This led to races where different material systems could have inconsistent views of which views exist.<p>Third, the system was incorrectly adding entities to pending queues for material types they didn’t belong to. When an entity changed from Material A to Material B, Material A’s system would still try to process it, adding it to its pending queue where it would never get specialized because Material A’s system doesn’t handle Material B’s assets.<p>Finally, the dequeue logic had a cross-type stomping problem. When a view was marked dirty, the system would return all visible entities for dequeueing, not just entities of the current material type. This meant Material A’s system could remove render phase entries for entities that should be handled by Material B’s system.<p>The solution involved four coordinated fixes. First, the bind group ID persistence was fixed by creating a global registry that maps entities to their material IDs, and material IDs to their bind group IDs. This allows <code>extract_mesh2d</code> to look up the correct bind group ID even for entities that aren’t being re-queued.<p>Second, <code>prepare_for_new_frame</code> was moved to a non-generic system that runs once per frame, before any material-specific systems. This ensures all material systems see a consistent view state.<p>Third, the specialization system now carefully filters out entities that don’t have the current material type. If an entity’s material ID isn’t found in the current material’s registry, it’s simply skipped rather than being added to a pending queue where it can’t be processed.<p>Fourth, the dequeue logic was refined to only remove entities that are truly no longer relevant to the current material system. The system now distinguishes between entities that were removed entirely and entities that changed material types, ensuring that cross-type interference doesn’t occur.<p>These changes highlight the complexity of maintaining parallel, type-generic rendering systems. The PR author notes that the ultimate solution would be to refactor the 2D systems to use type-erased approaches similar to 3D, which would eliminate these race conditions entirely. However, as a practical fix for the regression introduced by change lists, these changes restore correctness while maintaining the performance benefits of dirty tracking.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[extract_mesh2d] --> B[RenderMaterial2dIds]
</span><span>    A --> C[RenderMaterial2dBindGroupIds]
</span><span>    D[prepare_asset Material2d] --> C
</span><span>    E[extract_mesh_materials_2d] --> B
</span><span>    
</span><span>    F[prepare_pending_mesh_material2d_queues] --> G[PendingMeshMaterial2dQueues]
</span><span>    G --> H[specialize_material2d_meshes]
</span><span>    G --> I[queue_material2d_meshes]
</span><span>    
</span><span>    B --> A
</span><span>    C --> A
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=1-crates-bevy-sprite-render-src-mesh2d-material-rs-83-44>1. <code>crates/bevy_sprite_render/src/mesh2d/material.rs</code> (+83/-44)</h3><p>This file contains the core fixes for the 2D material specialization system. The changes introduce new resources for tracking material bind group IDs and refactor the pending queue management.<p><strong>Key changes:</strong><ul><li>Added <code>RenderMaterial2dIds</code> resource to map entities to material IDs<li>Added <code>RenderMaterial2dBindGroupIds</code> resource to map material IDs to bind group IDs<li>Created non-generic <code>prepare_pending_mesh_material2d_queues</code> system<li>Fixed specialization system to skip entities with wrong material types<li>Refined dequeue logic to avoid cross-type interference</ul><p><strong>Code snippets:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added new resources
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Resource</span><span style=color:#61676ccc>,</span><span> Default</span><span style=color:#61676ccc>,</span><span> Deref</span><span style=color:#61676ccc>,</span><span> DerefMut)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>RenderMaterial2dBindGroupIds</span><span>(HashMap&LTUntypedAssetId, Material2dBindGroupId>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Resource</span><span style=color:#61676ccc>,</span><span> Default</span><span style=color:#61676ccc>,</span><span> Deref</span><span style=color:#61676ccc>,</span><span> DerefMut)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>RenderMaterial2dIds</span><span>(MainEntityHashMap&LTUntypedAssetId>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Modified extract_mesh_materials_2d to update both resources
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>add_mesh_instance</span><span>&LTM>(
</span><span>    </span><span style=color:#ff8f40>entity</span><span style=color:#61676ccc>:</span><span> Entity,
</span><span>    </span><span style=color:#ff8f40>material</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>MeshMaterial2d&LTM>,
</span><span>    </span><span style=color:#ff8f40>material_instances</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span>RenderMaterial2dInstances&LTM>,
</span><span>    </span><span style=color:#ff8f40>render_material_2d_ids</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> RenderMaterial2dIds,
</span><span>) {
</span><span>    material_instances</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(entity</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()</span><span style=color:#61676ccc>,</span><span> material</span><span style=color:#ed9366>.</span><span style=color:#f07171>id</span><span>())</span><span style=color:#61676ccc>;
</span><span>    render_material_2d_ids</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(entity</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()</span><span style=color:#61676ccc>,</span><span> material</span><span style=color:#ed9366>.</span><span style=color:#f07171>id</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>())</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// New non-generic system for preparing pending queues
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>prepare_pending_mesh_material2d_queues</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>pending_mesh_material2d_queues</span><span style=color:#61676ccc>: </span><span>ResMut&LTPendingMeshMaterial2dQueues>,
</span><span>    </span><span style=color:#ff8f40>views</span><span style=color:#61676ccc>: </span><span>Query<</span><span style=color:#ed9366>&</span><span>ExtractedView>,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> all_views</span><span style=color:#61676ccc>: </span><span>HashSet&LTRetainedViewEntity, FixedHasher> </span><span style=color:#ed9366>= </span><span>HashSet</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>for</span><span> view </span><span style=color:#ed9366>in &</span><span>views {
</span><span>        all_views</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(view</span><span style=color:#ed9366>.</span><span>retained_view_entity)</span><span style=color:#61676ccc>;
</span><span>        pending_mesh_material2d_queues</span><span style=color:#ed9366>.</span><span style=color:#f07171>prepare_for_new_frame</span><span>(view</span><span style=color:#ed9366>.</span><span>retained_view_entity)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>    pending_mesh_material2d_queues</span><span style=color:#ed9366>.</span><span style=color:#f07171>expire_stale_views</span><span>(</span><span style=color:#ed9366>&</span><span>all_views)</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Fixed specialization to skip wrong material types
</span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(material_asset_id) </span><span style=color:#ed9366>=</span><span> render_material_instances</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(visible_entity) </span><span style=color:#fa6e32>else </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Entity doesn't have this material type. Skip it; the
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// correct material type's specialize system will handle it.
</span><span>    </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>}</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=2-crates-bevy-sprite-render-src-mesh2d-mesh-rs-20-3>2. <code>crates/bevy_sprite_render/src/mesh2d/mesh.rs</code> (+20/-3)</h3><p>This file handles mesh extraction and was modified to use the new material ID tracking system to preserve bind group IDs across frames.<p><strong>Key changes:</strong><ul><li>Initialized the new material ID tracking resources<li>Modified <code>extract_mesh2d</code> to look up bind group IDs from the global registries<li>Added the non-generic pending queue preparation system to the render schedule</ul><p><strong>Code snippets:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Initialization of new resources in plugin
</span><span style=color:#ed9366>.</span><span>init_resource</span><span style=color:#ed9366>::</span><span>&LTRenderMaterial2dBindGroupIds>()
</span><span style=color:#ed9366>.</span><span>allow_ambiguous_resource</span><span style=color:#ed9366>::</span><span>&LTRenderMaterial2dBindGroupIds>()
</span><span style=color:#ed9366>.</span><span>init_resource</span><span style=color:#ed9366>::</span><span>&LTRenderMaterial2dIds>()
</span><span style=color:#ed9366>.</span><span>allow_ambiguous_resource</span><span style=color:#ed9366>::</span><span>&LTRenderMaterial2dIds>()
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Modified extract_mesh2d to preserve bind group IDs
</span><span style=color:#fa6e32>let</span><span> material_bind_group_id </span><span style=color:#ed9366>=</span><span> render_material_instances
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#ed9366>&</span><span>main_entity)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>and_then</span><span>(|</span><span style=color:#ff8f40>material_id</span><span>| render_material_2d_bind_group_ids</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(material_id))
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>copied</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_or_default</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span>render_mesh_instances</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(
</span><span>    main_entity</span><span style=color:#61676ccc>,
</span><span>    RenderMesh2dInstance {
</span><span>        transforms</span><span style=color:#61676ccc>:</span><span> Mesh2dTransforms {
</span><span>            world_from_local</span><span style=color:#61676ccc>:</span><span> transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>affine</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()</span><span style=color:#61676ccc>,
</span><span>            flags</span><span style=color:#61676ccc>: </span><span>MeshFlags</span><span style=color:#ed9366>::</span><span>empty()</span><span style=color:#ed9366>.</span><span style=color:#f07171>bits</span><span>()</span><span style=color:#61676ccc>,
</span><span>        }</span><span style=color:#61676ccc>,
</span><span>        mesh_asset_id</span><span style=color:#61676ccc>:</span><span> handle</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0.</span><span style=color:#f07171>id</span><span>()</span><span style=color:#61676ccc>,
</span><span>        material_bind_group_id</span><span style=color:#61676ccc>, </span><span style=color:#abb0b6;font-style:italic>// Now preserved from previous frames
</span><span>        automatic_batching</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>!</span><span>no_automatic_batching</span><span style=color:#61676ccc>,
</span><span>        tag</span><span style=color:#61676ccc>:</span><span> tag</span><span style=color:#ed9366>.</span><span style=color:#f07171>map_or</span><span>(</span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>, </span><span>|</span><span style=color:#ff8f40>i</span><span>| </span><span style=color:#ed9366>**</span><span>i)</span><span style=color:#61676ccc>,
</span><span>    }</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><p><strong>Bevy’s ECS System Scheduling</strong>: Understanding system ordering and execution is crucial for working with Bevy’s rendering pipeline. The official Bevy Book has a comprehensive section on this.</p><li><p><strong>Rendering Pipelines and Change Lists</strong>: The concept of dirty tracking in rendering systems is common in game engines. Articles on “scene graph optimization” and “incremental rendering” cover similar ground.</p><li><p><strong>Type Erasure in Rust</strong>: For understanding why the 2D/3D material system difference matters, resources on trait objects, <code>Any</code> type, and type erasure patterns in Rust would be helpful.</p><li><p><strong>PR #22966</strong>: The original change list implementation that necessitated these fixes provides important context for understanding the regression.</p><li><p><strong>Bevy’s Render Graph Documentation</strong>: The Bevy render graph documentation explains how materials, meshes, and views interact in the rendering pipeline.</p></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_23083.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>