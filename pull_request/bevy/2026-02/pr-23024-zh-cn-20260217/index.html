<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #23024 在atmosphere功能落地后修复 `WGPU_SETTINGS_PRIO="webgl2"
        
    </title><meta content='#23024 在atmosphere功能落地后修复 `WGPU_SETTINGS_PRIO="webgl2"' property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-17</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2026-02/pr-23024-en-20260217>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=title>Title</h1><p>Fix <code>WGPU_SETTINGS_PRIO="webgl2"</code> after atmosphere landed.<h2 id=basic-information>Basic Information</h2><ul><li><strong>标题</strong>: 在atmosphere功能落地后修复 <code>WGPU_SETTINGS_PRIO="webgl2"</code><li><strong>PR链接</strong>: https://github.com/bevyengine/bevy/pull/23024<li><strong>作者</strong>: pcwalton<li><strong>状态</strong>: 已合并 (MERGED)<li><strong>标签</strong>: D-Trivial, A-Rendering, P-Crash, S-Ready-For-Final-Review, A-Diagnostics<li><strong>创建时间</strong>: 2026-02-17T22:39:23Z<li><strong>合并时间</strong>: 2026-02-17T23:40:36Z<li><strong>合并者</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>atmosphere 插件仅检查 <code>RenderAdapter</code> 以确定运行是否安全，而不检查 <code>RenderDevice</code>。正如 PR #18113 所发现的，这会导致 <code>WGPU_SETTINGS_PRIO="webgl2"</code> 失败，因为该环境变量只影响 <code>RenderDevice</code>，而不影响 <code>RenderAdapter</code>。与该PR类似，本PR通过让 atmosphere 在检查 <code>RenderAdapter</code> 之外也检查 <code>RenderDevice</code> 来修复此问题。<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>这个问题始于一个特定的渲染功能——atmosphere（大气效果）——与一个用于控制后端优先级的环境变量 <code>WGPU_SETTINGS_PRIO</code> 之间的冲突。<p>Bevy 的渲染系统通过两个核心结构来抽象GPU：<code>RenderAdapter</code> 和 <code>RenderDevice</code>。<code>RenderAdapter</code> 大致对应于物理GPU硬件及其支持的特性。而 <code>RenderDevice</code> 是实际创建的、用于执行渲染命令的逻辑设备。在某些情况下，用户可能希望通过 <code>WGPU_SETTINGS_PRIO</code> 环境变量（例如设为 <code>"webgl2"</code>）来强制使用特定的、能力可能较低的图形后端（如WebGL2），即使系统适配器本身支持更高级的功能（如Vulkan或Metal）。这个环境变量会直接影响创建的 <code>RenderDevice</code> 的能力限制，但不会改变底层 <code>RenderAdapter</code> 报告的原始能力。<p>atmosphere 渲染效果依赖于存储纹理（storage textures）这一GPU特性。为了安全起见，atmosphere 插件在初始化时需要检查当前环境是否支持此特性。在引入此PR的修复之前，插件的检查逻辑只查询了 <code>RenderAdapter</code> 的 <code>downlevel_capabilities</code>。<p>这里就出现了问题。当 <code>WGPU_SETTINGS_PRIO="webgl2"</code> 被设置时，系统创建的 <code>RenderDevice</code> 其能力会被限制为WebGL2级别，通常这意味着 <code>max_storage_textures_per_shader_stage</code> 限制为0，即不支持存储纹理。然而，底层的 <code>RenderAdapter</code>（例如一个支持Vulkan的独立显卡）仍然会报告它<strong>确实</strong>支持存储纹理（<code>downlevel_capabilities.flags</code> 包含 <code>DownlevelFlags::STORAGE_TEXTURES</code>）。这导致插件基于错误的乐观判断而加载，但在尝试创建或使用需要存储纹理的GPU资源时，底层wgpu库会因为设备能力不足而抛出错误，导致程序崩溃。<p>解决方案非常直接且遵循了既有的修复模式。开发者参考了之前解决类似问题的 PR #18113。修复的核心思想是：进行双重检查。不仅要询问适配器“你<strong>能</strong>做什么？”，还要询问设备“你当前<strong>允许</strong>我做什么？”。<p>因此，实现就是在 <code>AtmospherePlugin</code> 的 <code>build</code> 方法中，在已有的 <code>RenderAdapter</code> 检查之后，新增一段对 <code>RenderDevice</code> 的检查代码。<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 检查 `RenderDevice` 以及 `RenderAdapter`。前者会考虑 `WGPU_SETTINGS_PRIO` 环境变量，而后者不会。
</span><span style=color:#fa6e32>let</span><span> render_device </span><span style=color:#ed9366>=</span><span> render_app</span><span style=color:#ed9366>.</span><span style=color:#f07171>world</span><span>()</span><span style=color:#ed9366>.</span><span>resource</span><span style=color:#ed9366>::</span><span>&LTRenderDevice>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>if</span><span> render_device</span><span style=color:#ed9366>.</span><span style=color:#f07171>limits</span><span>()</span><span style=color:#ed9366>.</span><span>max_storage_textures_per_shader_stage </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0 </span><span>{
</span><span>    </span><span style=color:#f07171>warn!</span><span>(</span><span style=color:#86b300>"AtmospherePlugin not loaded. GPU lacks support: `max_storage_textures_per_shader_stage` is 0"</span><span>)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>这段代码从渲染子应用（<code>render_app</code>）中获取 <code>RenderDevice</code> 资源，并直接查询其 <code>limits</code> 中的 <code>max_storage_textures_per_shader_stage</code> 值。如果该值为0，说明当前配置的逻辑设备不支持存储纹理，插件会记录一条警告信息并安全地中止加载，从而避免了后续的运行时崩溃。<p>从工程角度看，这是一个防御性编程和准确理解抽象层级之间差异的典型案例。<code>RenderAdapter</code> 代表潜在能力，<code>RenderDevice</code> 代表实际可用的、受运行时配置约束的能力。任何依赖于特定GPU特性的插件或系统，如果其可用性会受到像 <code>WGPU_SETTINGS_PRIO</code> 这样的用户配置的影响，都必须对这两者进行检查。<p>此PR的改动很小（仅增加约10行代码），但有效地解决了一个导致程序崩溃的边界情况。它确保了atmosphere插件在用户强制使用能力较低的后端时，能够优雅地降级（即不启用），而不是强行运行导致失败。这种修复也增强了Bevy在不同目标平台（如Web与原生）上行为的一致性。<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    User[用户/环境变量&LTbr/>WGPU_SETTINGS_PRIO="webgl2"] --> RenderDevice
</span><span>    Hardware[GPU硬件 / Adapter 适配器] --> RenderAdapter
</span><span>
</span><span>    RenderAdapter -- 查询原始能力&LTbr/>(支持STORAGE_TEXTURES) --> AtmospherePlugin
</span><span>    RenderDevice -- 查询实际限制&LTbr/>(max_storage_textures=0) --> AtmospherePlugin
</span><span>
</span><span>    AtmospherePlugin{决策逻辑}
</span><span>    AtmospherePlugin -- 双重检查通过 --> Load[成功加载插件]
</span><span>    AtmospherePlugin -- Device检查失败 --> Abort[中止加载，避免崩溃]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ul><li><code>crates/bevy_pbr/src/atmosphere/mod.rs</code> (+10/-0)</ul><p>这是此PR中唯一被修改的文件。改动位于 <code>AtmospherePlugin</code> 的 <code>build</code> 方法内。在已有的、从 <code>RenderApp</code> 资源中检查 <code>RenderAdapter</code> 是否支持存储纹理的代码块之后，新增了一段对 <code>RenderDevice</code> 的类似检查。<p><strong>关键代码片段</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 新增的检查代码块
</span><span style=color:#abb0b6;font-style:italic>// Check the `RenderDevice` in addition to the `RenderAdapter`. The
</span><span style=color:#abb0b6;font-style:italic>// former takes the `WGPU_SETTINGS_PRIO` environment variable into
</span><span style=color:#abb0b6;font-style:italic>// account, and the latter doesn't.
</span><span style=color:#fa6e32>let</span><span> render_device </span><span style=color:#ed9366>=</span><span> render_app</span><span style=color:#ed9366>.</span><span style=color:#f07171>world</span><span>()</span><span style=color:#ed9366>.</span><span>resource</span><span style=color:#ed9366>::</span><span>&LTRenderDevice>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>if</span><span> render_device</span><span style=color:#ed9366>.</span><span style=color:#f07171>limits</span><span>()</span><span style=color:#ed9366>.</span><span>max_storage_textures_per_shader_stage </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0 </span><span>{
</span><span>    </span><span style=color:#f07171>warn!</span><span>(</span><span style=color:#86b300>"AtmospherePlugin not loaded. GPU lacks support: `max_storage_textures_per_shader_stage` is 0"</span><span>)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p><strong>代码作用</strong>:<ol><li><strong>获取资源</strong>: <code>render_app.world().resource::&LTRenderDevice>()</code> 从渲染子应用的世界中获取当前的 <code>RenderDevice</code> 实例。<li><strong>查询限制</strong>: <code>render_device.limits().max_storage_textures_per_shader_stage</code> 查询该逻辑设备允许每个着色器阶段使用的最大存储纹理数量。<li><strong>条件判断</strong>: 如果该限制为0，意味着设备完全不支持存储纹理。<li><strong>安全退出</strong>: 在这种情况下，插件记录一条警告日志并直接 <code>return</code>，跳过后续所有的资源初始化和系统注册步骤，从而确保插件不会在不可用的环境下被激活。</ol><p><strong>与PR目的的关系</strong>: 这个新增的检查直接解决了PR描述中概述的问题。它确保了当用户通过 <code>WGPU_SETTINGS_PRIO</code> 环境变量选择了一个不支持存储纹理的后端（如WebGL2）时，atmosphere插件能够基于<strong>实际生效的设备能力</strong>做出正确的禁用决定，而不是依赖于可能过高的适配器能力报告。这避免了在运行时因创建不支持的资源而导致的panic或崩溃。<h2 id=further-reading>Further Reading</h2><ol><li><strong>关联的PR #18113</strong>: 该PR为其他渲染功能（可能是光照或阴影）应用了完全相同的 <code>RenderDevice</code> 检查模式。阅读此PR可以了解此问题的历史背景以及它在代码库其他部分的应用。<li><strong>Bevy 官方文档 - 渲染</strong>: 了解 <code>RenderAdapter</code>、<code>RenderDevice</code> 以及 Bevy 渲染架构的整体设计。<li><strong>wgpu 仓库的 <code>DownlevelFlags</code> 和 <code>Limits</code></strong>: 深入了解 <code>STORAGE_TEXTURES</code> 标志和 <code>max_storage_textures_per_shader_stage</code> 限制的具体含义，以及它们在 WebGL、Vulkan、Metal 等不同后端下的表现差异。<li><strong>Bevy 诊断标签 (A-Diagnostics)</strong>: 了解 Bevy 中如何处理功能检测和诊断信息，例如本PR中添加的警告日志就属于诊断信息。</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_23024.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>