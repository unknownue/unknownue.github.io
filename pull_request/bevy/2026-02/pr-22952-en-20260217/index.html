<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22952 Add PrepareResourcesBatchPhases RenderSystem set
        
    </title><meta content="#22952 Add PrepareResourcesBatchPhases RenderSystem set" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-17</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-02/pr-22952-zh-cn-20260217>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Add PrepareResourcesBatchPhases RenderSystem set<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22952<li><strong>Author</strong>: atlv24<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, C-Code-Quality, S-Ready-For-Final-Review<li><strong>Created</strong>: 2026-02-14T07:50:21Z<li><strong>Merged</strong>: 2026-02-17T01:26:14Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>reduce RenderApp ambiguities</ul><h2 id=solution>Solution</h2><ul><li>give batch phases their own system set to order them after skin mesh preparation (which lives in PrepareResources, and matches the GetBatchData param query)<li>also make atmosphere ordering a bit more specific</ul><h2 id=testing>Testing</h2><ul><li>ran some examples. atmosphere looks good</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The pull request addresses a specific ordering issue in Bevy’s renderer related to system execution ambiguity. In Bevy’s ECS architecture, systems can run in parallel unless explicitly ordered, and the render graph uses system sets to enforce execution order for critical rendering operations.<p>The core problem was that systems responsible for batch preparation were running in the same system set (<code>PrepareResources</code>) as skin mesh preparation systems. This created a potential ambiguity because both types of systems needed to access and modify similar resources, but batch preparation depends on skin mesh preparation completing first. Without explicit ordering, the systems could execute in any order, potentially causing incorrect batching results or runtime errors.<p>The solution introduces a new system set called <code>PrepareResourcesBatchPhases</code> that sits between <code>PrepareResources</code> and <code>PrepareResourcesCollectPhaseBuffers</code> in the execution order. This creates a clear pipeline:<ol><li>First, standard resource preparation happens in <code>PrepareResources</code><li>Then, batch phase preparation happens in the new <code>PrepareResourcesBatchPhases</code><li>Finally, phase buffer collection happens in <code>PrepareResourcesCollectPhaseBuffers</code></ol><p>The implementation required three key changes. First, in <code>bevy_render/src/lib.rs</code>, the new system set was added to the <code>RenderSystems</code> enum with proper documentation explaining its purpose. The schedule configuration was updated to place this set in the correct position in the execution chain.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub enum </span><span style=color:#399ee6>RenderSystems </span><span>{
</span><span>    Prepare</span><span style=color:#61676ccc>,
</span><span>    PrepareResources</span><span style=color:#61676ccc>,
</span><span>    PrepareResourcesCollectPhaseBuffers</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub enum </span><span style=color:#399ee6>RenderSystems </span><span>{
</span><span>    Prepare</span><span style=color:#61676ccc>,
</span><span>    PrepareResources</span><span style=color:#61676ccc>,
</span><span>    PrepareResourcesBatchPhases</span><span style=color:#61676ccc>,  </span><span style=color:#abb0b6;font-style:italic>// New
</span><span>    PrepareResourcesCollectPhaseBuffers</span><span style=color:#61676ccc>,  </span><span style=color:#abb0b6;font-style:italic>// Now explicitly runs after batch phases
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>}
</span></code></pre><p>Second, in <code>bevy_render/src/render_phase/mod.rs</code>, two batch preparation systems were moved from <code>PrepareResources</code> to the new <code>PrepareResourcesBatchPhases</code> set. This ensures they run after skin mesh preparation but before buffer collection.<p>Third, the PR also fixes an ordering issue in the atmosphere system. The <code>prepare_atmosphere_uniforms</code> system was moved from running before <code>PrepareResources</code> to running in the <code>Prepare</code> set before <code>PrepareResources</code>. This makes the ordering more specific and logical within the render pipeline structure.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>prepare_atmosphere_uniforms
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>before</span><span>(RenderSystems</span><span style=color:#ed9366>::</span><span>PrepareResources)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>after</span><span>(RenderSystems</span><span style=color:#ed9366>::</span><span>PrepareAssets)</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>prepare_atmosphere_uniforms
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>in_set</span><span>(RenderSystems</span><span style=color:#ed9366>::</span><span>Prepare)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>before</span><span>(RenderSystems</span><span style=color:#ed9366>::</span><span>PrepareResources)</span><span style=color:#61676ccc>,
</span></code></pre><p>The technical insight here is that Bevy’s renderer uses a carefully orchestrated sequence of system sets to ensure data dependencies are respected. Skin mesh preparation (which lives in <code>PrepareResources</code>) generates data that batch preparation systems need, so batch preparation must happen after it. By creating a dedicated system set for batch phases, the render graph now has explicit, unambiguous ordering for these critical operations.<p>The impact is improved system execution determinism and reduced risk of hard-to-debug rendering artifacts caused by system execution order ambiguities. The changes are minimal and focused, affecting only the scheduling logic without modifying the actual implementation of the systems themselves. This follows good engineering practice of solving ordering problems at the scheduling level rather than adding complex synchronization logic within systems.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Prepare] --> B[PrepareResources]
</span><span>    B --> C[PrepareResourcesBatchPhases&LTbr/>(New)]
</span><span>    C --> D[PrepareResourcesCollectPhaseBuffers]
</span><span>    D --> E[PrepareResourcesFlush]
</span><span>    E --> F[PrepareBindGroups]
</span><span>    
</span><span>    G[prepare_atmosphere_uniforms] --> B
</span><span>    subgraph "Atmosphere Systems"
</span><span>        G
</span><span>    end
</span><span>    
</span><span>    H[prepare_phase_for::&LTOpaque3d>] --> C
</span><span>    I[prepare_phase_for::&LTAlphaMask3d>] --> C
</span><span>    subgraph "Batch Preparation Systems"
</span><span>        H
</span><span>        I
</span><span>    end
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-render-src-lib-rs-5-2><code>crates/bevy_render/src/lib.rs</code> (+5/-2)</h3><p>This file defines the <code>RenderSystems</code> enum and configures the render schedule. The changes add a new system set and update documentation.<p><strong>Key modifications:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added new system set:
</span><span style=color:#abb0b6;font-style:italic>/// A sub-set within [`Prepare`](RenderSystems::Prepare) that creates batches for render phases.
</span><span>PrepareResourcesBatchPhases</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Updated documentation for existing system set:
</span><span style=color:#abb0b6;font-style:italic>/// A sub-set within [`Prepare`](RenderSystems::Prepare) to collect phase buffers after
</span><span style=color:#abb0b6;font-style:italic>/// [`PrepareResourcesBatchPhases`](RenderSystems::PrepareResourcesBatchPhases) has run.
</span><span>PrepareResourcesCollectPhaseBuffers</span><span style=color:#61676ccc>,
</span></code></pre><h3 id=crates-bevy-render-src-render-phase-mod-rs-2-2><code>crates/bevy_render/src/render_phase/mod.rs</code> (+2/-2)</h3><p>This file contains the batch preparation systems that were moved to the new system set.<p><strong>Key modifications:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Two systems changed from PrepareResources to PrepareResourcesBatchPhases:
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// System 1 (line 1156):
</span><span style=color:#ed9366>-    .</span><span style=color:#f07171>in_set</span><span>(RenderSystems</span><span style=color:#ed9366>::</span><span>PrepareResources)</span><span style=color:#61676ccc>,
</span><span style=color:#ed9366>+    .</span><span style=color:#f07171>in_set</span><span>(RenderSystems</span><span style=color:#ed9366>::</span><span>PrepareResourcesBatchPhases)</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// System 2 (line 1261):
</span><span style=color:#ed9366>-    .</span><span style=color:#f07171>in_set</span><span>(RenderSystems</span><span style=color:#ed9366>::</span><span>PrepareResources)</span><span style=color:#61676ccc>,
</span><span style=color:#ed9366>+    .</span><span style=color:#f07171>in_set</span><span>(RenderSystems</span><span style=color:#ed9366>::</span><span>PrepareResourcesBatchPhases)</span><span style=color:#61676ccc>,
</span></code></pre><h3 id=crates-bevy-pbr-src-atmosphere-mod-rs-2-2><code>crates/bevy_pbr/src/atmosphere/mod.rs</code> (+2/-2)</h3><p>This file contains atmosphere rendering systems. One system’s ordering was made more specific.<p><strong>Key modifications:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Changed ordering constraints:
</span><span style=color:#ed9366>-</span><span>    prepare_atmosphere_uniforms
</span><span style=color:#ed9366>-        .</span><span style=color:#f07171>before</span><span>(RenderSystems</span><span style=color:#ed9366>::</span><span>PrepareResources)
</span><span style=color:#ed9366>-        .</span><span style=color:#f07171>after</span><span>(RenderSystems</span><span style=color:#ed9366>::</span><span>PrepareAssets)</span><span style=color:#61676ccc>,
</span><span style=color:#ed9366>+</span><span>    prepare_atmosphere_uniforms
</span><span style=color:#ed9366>+        .</span><span style=color:#f07171>in_set</span><span>(RenderSystems</span><span style=color:#ed9366>::</span><span>Prepare)
</span><span style=color:#ed9366>+        .</span><span style=color:#f07171>before</span><span>(RenderSystems</span><span style=color:#ed9366>::</span><span>PrepareResources)</span><span style=color:#61676ccc>,
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/ecs/schedule/trait.SystemSet.html target=_blank>Bevy System Sets Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/rendering/ target=_blank>Bevy Render Graph Architecture</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/docs/plugins_guidelines.md#system-ordering target=_blank>ECS System Ordering Patterns</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/crates/bevy_render/src/render_phase/mod.rs target=_blank>Bevy Render Phases and Batching</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_22952.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>