<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22758 Move render app init and extraction to separate plugin
        
    </title><meta content="#22758 Move render app init and extraction to separate plugin" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-06</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-02/pr-22758-zh-cn-20260206>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>Move render app init and extraction to separate plugin<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Move render app init and extraction to separate plugin<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22758<li><strong>Author</strong>: kristoff3r<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, C-Code-Quality, S-Ready-For-Final-Review, M-Migration-Guide<li><strong>Created</strong>: 2026-01-31T21:53:42Z<li><strong>Merged</strong>: 2026-02-06T19:50:36Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Currently in <code>bevy_render</code> the renderer initialization (e.g. creating a surface, registering rendering systems) is very intertwined with setting up the extraction logic itself (e.g. how is data moved between the worlds, how are they kept in sync). This makes it harder to understand both things, and also makes it very hard to test the extraction logic, as you don’t want to start the renderer in unit test.<p>In the future this functionality might even be useful for the ECS outside <code>bevy_render</code>, e.g. for custom renderers that want to use a render world, or for multi world setups.<h2 id=solution>Solution</h2><p>This PR splits out creation of the render subapp plus the extraction logic itself into <code>ExtractPlugin</code>, and uses the new found flexibility to finally add a test for it.<p>This is the first part in a series of PRs I plan to do to:<ul><li>Separate the extraction logic so it’s possible to test (this one)<li>Fix the bug that’s currently commented out in the test<li>Rework the Extract trait to bypass the orphan rules, so we can use it everywhere (speculative but I have an idea)</ul><h2 id=testing>Testing</h2><p>Added a test to show that extraction is working.<p>I also ran a bunch of examples requiring rendering and they still work.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a long-standing architectural issue in Bevy’s render system where renderer initialization and data extraction were tightly coupled. The core problem was that setting up the render subapp (creating surfaces, registering rendering systems) was deeply intertwined with the extraction logic that moves data between the main world and render world.<p>The author identified two main problems with this architecture. First, it made the code harder to understand because responsibilities weren’t clearly separated. Second, and more importantly, it made testing extraction logic nearly impossible because you couldn’t test extraction without starting the full renderer with all its GPU dependencies - something you definitely don’t want in unit tests.<p>Looking at the code before the change, the <code>RenderPlugin::build</code> method in <code>lib.rs</code> was doing everything: creating the render subapp, setting up extraction schedules, configuring world synchronization, and registering all the extraction systems. This monolithic approach meant that if you wanted to understand just the extraction part, you had to sift through all the renderer setup code.<p>The solution was to extract the extraction logic (pun intended) into a separate <code>ExtractPlugin</code>. This plugin now handles:<ol><li>Creating the render subapp structure<li>Setting up the <code>ExtractSchedule</code> and <code>Render</code> schedule<li>Configuring world synchronization systems<li>Managing the data flow between main world and render world</ol><p>The implementation carefully preserves all the existing functionality while making it modular. The <code>ExtractPlugin</code> struct has a <code>pre_extract</code> callback that allows custom logic to run before extraction, which is used by the renderer to update its state. The key insight here is that the extraction process itself doesn’t need to know about rendering specifics - it just needs to move data between worlds according to extraction rules.<p>One of the clever implementation details is how the plugin manages the world swapping. During extraction, the main world needs to be available in the render world as a resource, but you can’t have both worlds accessing each other directly. The solution uses a “scratch world” pattern:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let</span><span> scratch_world </span><span style=color:#ed9366>=</span><span> main_world</span><span style=color:#ed9366>.</span><span>remove_resource</span><span style=color:#ed9366>::</span><span>&LTScratchMainWorld>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> inserted_world </span><span style=color:#ed9366>= </span><span>core</span><span style=color:#ed9366>::</span><span>mem</span><span style=color:#ed9366>::</span><span>replace(main_world</span><span style=color:#61676ccc>,</span><span> scratch_world</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0</span><span>)</span><span style=color:#61676ccc>;
</span><span>render_world</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_resource</span><span>(MainWorld(inserted_world))</span><span style=color:#61676ccc>;
</span></code></pre><p>This swaps the main world into the render world as a resource, runs the extraction schedule, then swaps it back. The scratch world prevents allocating a new world every frame.<p>The separation also enabled adding the first comprehensive test for extraction logic. The test in <code>extract_plugin.rs</code> creates a simple app with extraction components, runs the extraction process, and verifies that components are correctly moved to the render world. Notably, the test comments reveal there’s still a bug to fix in a future PR:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// TODO: this is a bug
</span><span style=color:#abb0b6;font-style:italic>// assert!(entity.4.is_some());
</span></code></pre><p>This demonstrates the value of the separation - without being able to test extraction independently, such bugs would be much harder to identify and fix.<p>From an architectural perspective, this change makes the render system more modular and follows the single responsibility principle. The <code>RenderPlugin</code> can now focus on rendering concerns while the <code>ExtractPlugin</code> handles data movement. This separation also opens up possibilities for custom renderers or multi-world setups that might want to reuse the extraction logic without the full Bevy renderer.<p>The PR includes some minor but important improvements beyond the main refactoring. In <code>sub_app.rs</code>, a warning was added when re-inserting a schedule to help developers avoid accidentally overwriting schedule configurations. The Cargo.toml change enables better debugging utilities when the debug feature is active.<p>Overall, this PR significantly improves code organization, enables testing of a critical system, and lays groundwork for future improvements to Bevy’s render architecture.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TB
</span><span>    subgraph "Before PR"
</span><span>        A[RenderPlugin] --> B[Setup Renderer]
</span><span>        A --> C[Setup Extraction]
</span><span>        A --> D[World Sync]
</span><span>        A --> E[Schedule Configuration]
</span><span>    end
</span><span>
</span><span>    subgraph "After PR"
</span><span>        F[RenderPlugin] --> G[ExtractPlugin]
</span><span>        G --> H[Setup Extraction]
</span><span>        G --> I[World Sync]
</span><span>        G --> J[Schedule Configuration]
</span><span>        F --> K[Setup Renderer]
</span><span>        F --> L[Render Systems]
</span><span>    end
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-render-src-extract-plugin-rs-253-0><code>crates/bevy_render/src/extract_plugin.rs</code> (+253/-0)</h3><p>This is a new file that contains all the extraction logic moved from <code>lib.rs</code>. It defines the <code>ExtractPlugin</code> struct and implements the extraction systems.<p>Key code:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>/// Plugin that sets up the [`RenderApp`] and handles extracting data from the
</span><span style=color:#abb0b6;font-style:italic>/// main world to the render world.
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>ExtractPlugin </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>/// Function that gets run at the beginning of each extraction.
</span><span>    </span><span style=color:#abb0b6;font-style:italic>///
</span><span>    </span><span style=color:#abb0b6;font-style:italic>/// Gets the main world and render world as arguments (in that order).
</span><span>    </span><span style=color:#fa6e32>pub </span><span>pre_extract</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>fn</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> World, </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> World),
</span><span>}
</span><span>
</span><span style=color:#fa6e32>impl </span><span>Plugin </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>ExtractPlugin </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>build</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>app</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> App) {
</span><span>        app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_plugins</span><span>(SyncWorldPlugin)</span><span style=color:#61676ccc>;
</span><span>        app</span><span style=color:#ed9366>.</span><span>init_resource</span><span style=color:#ed9366>::</span><span>&LTScratchMainWorld>()</span><span style=color:#61676ccc>;
</span><span>        
</span><span>        </span><span style=color:#fa6e32>let mut</span><span> render_app </span><span style=color:#ed9366>= </span><span>SubApp</span><span style=color:#ed9366>::</span><span>new()</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ... setup schedules and systems
</span><span>        render_app</span><span style=color:#ed9366>.</span><span style=color:#f07171>set_extract</span><span>(</span><span style=color:#fa6e32>move </span><span style=color:#ed9366>|</span><span>main_world</span><span style=color:#61676ccc>,</span><span> render_world</span><span style=color:#ed9366>| </span><span>{
</span><span>            </span><span style=color:#f07171>pre_extract</span><span>(main_world</span><span style=color:#61676ccc>,</span><span> render_world)</span><span style=color:#61676ccc>;
</span><span>            </span><span style=color:#f07171>entity_sync_system</span><span>(main_world</span><span style=color:#61676ccc>,</span><span> render_world)</span><span style=color:#61676ccc>;
</span><span>            </span><span style=color:#f07171>extract</span><span>(main_world</span><span style=color:#61676ccc>,</span><span> render_world)</span><span style=color:#61676ccc>;
</span><span>        })</span><span style=color:#61676ccc>;
</span><span>        app</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_sub_app</span><span>(RenderApp</span><span style=color:#61676ccc>,</span><span> render_app)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><h3 id=crates-bevy-render-src-lib-rs-68-150><code>crates/bevy_render/src/lib.rs</code> (+68/-150)</h3><p>The main render plugin file was significantly refactored. Most extraction logic was moved to <code>extract_plugin.rs</code>, leaving <code>RenderPlugin</code> to focus on rendering concerns.<p>Key changes:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: All extraction logic inline in RenderPlugin::build
</span><span style=color:#abb0b6;font-style:italic>// After: Delegate to ExtractPlugin
</span><span style=color:#fa6e32>if </span><span style=color:#f07171>insert_future_resources</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>render_creation</span><span style=color:#61676ccc>,</span><span> app</span><span style=color:#ed9366>.</span><span style=color:#f07171>world_mut</span><span>()) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// We only create the render world and set up extraction if we
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// have a rendering backend available.
</span><span>    app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_plugins</span><span>(ExtractPlugin {
</span><span>        pre_extract</span><span style=color:#61676ccc>: </span><span>error_handler</span><span style=color:#ed9366>::</span><span>update_state</span><span style=color:#61676ccc>,
</span><span>    })</span><span style=color:#61676ccc>;
</span><span>}</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-app-src-sub-app-rs-11-2><code>crates/bevy_app/src/sub_app.rs</code> (+11/-2)</h3><p>Added a warning when re-inserting a schedule to help with debugging.<p>Key code:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>add_schedule</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>schedule</span><span style=color:#61676ccc>:</span><span> Schedule) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut Self </span><span>{
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> schedules </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>world</span><span style=color:#ed9366>.</span><span>resource_mut</span><span style=color:#ed9366>::</span><span>&LTSchedules>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> _old_schedule </span><span style=color:#ed9366>=</span><span> schedules</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(schedule)</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"trace"</span><span>)]
</span><span>    </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(schedule) </span><span style=color:#ed9366>=</span><span> _old_schedule {
</span><span>        </span><span style=color:#f07171>warn!</span><span>(
</span><span>            </span><span style=color:#86b300>"Schedule {:?} was re-inserted, all previous configuration has been removed"</span><span style=color:#61676ccc>,
</span><span>            schedule</span><span style=color:#ed9366>.</span><span style=color:#f07171>label</span><span>()
</span><span>        )</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self
</span><span>}
</span></code></pre><h3 id=crates-bevy-render-cargo-toml-1-1><code>crates/bevy_render/Cargo.toml</code> (+1/-1)</h3><p>Added the <code>bevy_utils/debug</code> feature to the debug feature set for better debugging capabilities.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/getting-started/ecs/ target=_blank>Bevy’s ECS System</a> - Understanding Bevy’s Entity Component System<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/getting-started/plugins/ target=_blank>Plugin Architecture in Bevy</a> - How plugins work in Bevy<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/discussions/22758 target=_blank>Extract and Render World Pattern</a> - Discussion about this PR’s approach<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/advanced-topics/schedules/ target=_blank>Schedule Systems in Bevy</a> - Understanding how schedules and systems work</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_22758.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>