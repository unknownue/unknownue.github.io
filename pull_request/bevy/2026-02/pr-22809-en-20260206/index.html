<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22809 Reuse `ViewKeyCache` where possible
        
    </title><meta content="#22809 Reuse `ViewKeyCache` where possible" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-06</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-02/pr-22809-zh-cn-20260206>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Reuse <code>ViewKeyCache</code> where possible<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22809<li><strong>Author</strong>: levydsa<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Docs, A-Rendering, C-Examples, C-Usability, S-Ready-For-Final-Review<li><strong>Created</strong>: 2026-02-05T02:46:45Z<li><strong>Merged</strong>: 2026-02-06T19:50:36Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h2 id=objective>Objective</h2><ul><li>Creating a <code>MeshPipelineKey</code> is tricky and can lead to easily avoidable errors: #21784<li>We already cache the <code>MeshPipelineViewLayoutKey</code> part of <code>MeshPipelineKey</code> for each view in <code>ViewKeyCache</code> with the correct layout for any draw call that uses <code>SetMeshViewBindGroup</code><li>Instruct users to use <code>ViewKeyCache</code> to properly setup the pipeline for any view features.</ul><h2 id=solution>Solution</h2><ul><li>Reuse <code>ViewKeyCache</code> where possible in the engine and examples.<li>Attempt at adding documentation for <code>ViewKeyCache</code></ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a practical problem in Bevy’s rendering system: creating <code>MeshPipelineKey</code> instances correctly is error-prone. The issue (#21784) highlighted how developers could easily make mistakes when manually constructing these keys, particularly when dealing with view-specific rendering features like prepasses, MSAA, HDR, and other view-dependent settings.<p>The core insight behind this fix is that Bevy already maintains a cache called <code>ViewKeyCache</code> that stores the <code>MeshPipelineViewLayoutKey</code> portion of <code>MeshPipelineKey</code> for each view. This cache is specifically designed for draw calls that use <code>SetMeshViewBindGroup</code>, ensuring the correct layout is available. However, several parts of the codebase were not leveraging this cache, instead manually reconstructing the same information through complex queries.<p>The developer took a straightforward approach: identify all places where <code>MeshPipelineKey</code> was being manually constructed for view-specific rendering and replace those constructions with a lookup from <code>ViewKeyCache</code>. This not only reduces code duplication but also ensures consistency and prevents the types of errors documented in issue #21784.<p>Looking at the implementation, the changes follow a consistent pattern. Previously, functions like <code>queue_line_gizmos_3d</code> would query multiple components and conditionally set flags on the <code>MeshPipelineKey</code>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let mut</span><span> view_key </span><span style=color:#ed9366>= </span><span>MeshPipelineKey</span><span style=color:#ed9366>::</span><span>from_msaa_samples(msaa</span><span style=color:#ed9366>.</span><span style=color:#f07171>samples</span><span>())
</span><span>    </span><span style=color:#ed9366>| </span><span>MeshPipelineKey</span><span style=color:#ed9366>::</span><span>from_hdr(view</span><span style=color:#ed9366>.</span><span>hdr)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>if</span><span> normal_prepass {
</span><span>    view_key </span><span style=color:#ed9366>|= </span><span>MeshPipelineKey</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>NORMAL_PREPASS</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#fa6e32>if</span><span> depth_prepass {
</span><span>    view_key </span><span style=color:#ed9366>|= </span><span>MeshPipelineKey</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>DEPTH_PREPASS</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// ... more conditionals for other features
</span></code></pre><p>This approach required developers to know about all possible view features and manually check for each component. It was verbose, prone to omission errors, and would require updates whenever new view features were added.<p>The new implementation is significantly simpler:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#ed9366>&</span><span>view_key) </span><span style=color:#ed9366>=</span><span> view_key_cache</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#ed9366>&</span><span>view</span><span style=color:#ed9366>.</span><span>retained_view_entity) </span><span style=color:#fa6e32>else </span><span>{
</span><span>    </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>}</span><span style=color:#61676ccc>;
</span></code></pre><p>This single line replaces dozens of lines of manual key construction. The <code>ViewKeyCache</code> is populated elsewhere in the rendering system with the correct <code>MeshPipelineKey</code> for each view, including all relevant feature flags based on the view’s actual configuration.<p>The changes affected multiple areas:<ol><li><strong>Gizmo rendering</strong>: Both <code>queue_line_gizmos_3d</code> and <code>queue_line_joint_gizmos_3d</code> in the gizmo renderer were updated to use the cache.<li><strong>Example code</strong>: Three advanced shader examples were updated to demonstrate the correct pattern.<li><strong>Documentation</strong>: Added clear documentation for <code>ViewKeyCache</code> to guide future developers.</ol><p>From a technical perspective, this change improves maintainability in several ways. First, it centralizes the logic for determining view-specific pipeline keys. When new view features are added, they only need to be handled in the code that populates <code>ViewKeyCache</code>, not in every rendering system that might need the key. Second, it reduces boilerplate and cognitive load for developers writing new rendering systems. Third, it eliminates a class of bugs where features might be incorrectly enabled or disabled due to oversight in manual key construction.<p>The performance impact is likely neutral or slightly positive. While there’s an additional hash map lookup, this replaces multiple component checks and bitwise operations. More importantly, it ensures that all systems use the same cached key, potentially improving cache locality.<p>One subtle but important aspect of this change is the simplification of the query parameters. Many functions no longer need to query for all the individual prepass and feature components, making the system signatures cleaner and reducing the complexity of the ECS queries.<p>The PR also serves as a documentation effort. By updating the examples to use <code>ViewKeyCache</code>, it establishes a clear best practice for developers implementing custom rendering systems. The added documentation for <code>ViewKeyCache</code> itself helps clarify its purpose and usage.<p>This change represents a step toward more declarative rendering systems in Bevy. Rather than each system imperatively constructing keys based on what it thinks the view configuration should be, systems now ask for the authoritative view key from a central cache. This aligns with broader software engineering principles of avoiding duplication and maintaining single sources of truth.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[View Components] --> B[ViewKeyCache]
</span><span>    B --> C[Gizmo Rendering]
</span><span>    B --> D[Custom Shader Examples]
</span><span>    B --> E[Specialized Mesh Pipelines]
</span><span>    C --> F[queue_line_gizmos_3d]
</span><span>    C --> G[queue_line_joint_gizmos_3d]
</span><span>    D --> H[custom_render_phase]
</span><span>    D --> I[custom_shader_instancing]
</span><span>    E --> J[specialized_mesh_pipeline]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-gizmos-render-src-pipeline-3d-rs-15-90><code>crates/bevy_gizmos_render/src/pipeline_3d.rs</code> (+15/-90)</h3><p><strong>Purpose</strong>: Update gizmo rendering systems to use <code>ViewKeyCache</code> instead of manually constructing <code>MeshPipelineKey</code>.<p><strong>Key Changes</strong>:<ul><li>Simplified queries by removing multiple component checks<li>Replaced manual <code>MeshPipelineKey</code> construction with cache lookups<li>Reduced code complexity and potential for errors</ul><p><strong>Code Example</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Manual construction with multiple conditionals
</span><span style=color:#fa6e32>let mut</span><span> view_key </span><span style=color:#ed9366>= </span><span>MeshPipelineKey</span><span style=color:#ed9366>::</span><span>from_msaa_samples(msaa</span><span style=color:#ed9366>.</span><span style=color:#f07171>samples</span><span>())
</span><span>    </span><span style=color:#ed9366>| </span><span>MeshPipelineKey</span><span style=color:#ed9366>::</span><span>from_hdr(view</span><span style=color:#ed9366>.</span><span>hdr)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>if</span><span> normal_prepass {
</span><span>    view_key </span><span style=color:#ed9366>|= </span><span>MeshPipelineKey</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>NORMAL_PREPASS</span><span style=color:#61676ccc>;
</span><span>}
</span><span style=color:#abb0b6;font-style:italic>// ... more conditionals for depth_prepass, motion_vector_prepass, etc.
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Simple cache lookup
</span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#ed9366>&</span><span>view_key) </span><span style=color:#ed9366>=</span><span> view_key_cache</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#ed9366>&</span><span>view</span><span style=color:#ed9366>.</span><span>retained_view_entity) </span><span style=color:#fa6e32>else </span><span>{
</span><span>    </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>}</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-pbr-src-render-mesh-rs-2-0><code>crates/bevy_pbr/src/render/mesh.rs</code> (+2/-0)</h3><p><strong>Purpose</strong>: Add documentation for <code>ViewKeyCache</code> to clarify its purpose and usage.<p><strong>Code Example</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>/// This resource caches [`MeshPipelineKey`]s for each view with pre-enabled features needed to properly
</span><span style=color:#abb0b6;font-style:italic>/// setup the [`MeshViewBindGroup`] layout in specialized [`MeshPipeline`]s.
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Resource</span><span style=color:#61676ccc>,</span><span> Deref</span><span style=color:#61676ccc>,</span><span> DerefMut</span><span style=color:#61676ccc>,</span><span> Default</span><span style=color:#61676ccc>,</span><span> Debug</span><span style=color:#61676ccc>,</span><span> Clone)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>ViewKeyCache</span><span>(HashMap&LTRetainedViewEntity, MeshPipelineKey>)</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=examples-shader-advanced-custom-render-phase-rs-7-7><code>examples/shader_advanced/custom_render_phase.rs</code> (+7/-7)</h3><p><strong>Purpose</strong>: Update example to demonstrate correct usage of <code>ViewKeyCache</code>.<p><strong>Code Example</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Manual key construction
</span><span style=color:#fa6e32>let</span><span> view_key </span><span style=color:#ed9366>= </span><span>MeshPipelineKey</span><span style=color:#ed9366>::</span><span>from_msaa_samples(msaa</span><span style=color:#ed9366>.</span><span style=color:#f07171>samples</span><span>())
</span><span>    </span><span style=color:#ed9366>| </span><span>MeshPipelineKey</span><span style=color:#ed9366>::</span><span>from_hdr(view</span><span style=color:#ed9366>.</span><span>hdr)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Cache lookup
</span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#ed9366>&</span><span>view_key) </span><span style=color:#ed9366>=</span><span> view_key_cache</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#ed9366>&</span><span>view</span><span style=color:#ed9366>.</span><span>retained_view_entity) </span><span style=color:#fa6e32>else </span><span>{
</span><span>    </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>}</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=examples-shader-advanced-specialized-mesh-pipeline-rs-7-6><code>examples/shader_advanced/specialized_mesh_pipeline.rs</code> (+7/-6)</h3><p><strong>Purpose</strong>: Update specialized mesh pipeline example to use <code>ViewKeyCache</code>.<h3 id=examples-shader-advanced-custom-shader-instancing-rs-7-5><code>examples/shader_advanced/custom_shader_instancing.rs</code> (+7/-5)</h3><p><strong>Purpose</strong>: Update custom shader instancing example to use <code>ViewKeyCache</code>.<h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/rendering/ target=_blank>Bevy Rendering Documentation</a> - Official Bevy rendering guide<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/crates/bevy_pbr/src/render/mesh.rs target=_blank>Mesh Pipeline System</a> - Source code for Bevy’s mesh rendering system<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/issues/21784 target=_blank>Issue #21784</a> - The original issue documenting problems with manual <code>MeshPipelineKey</code> construction<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/programming/ecs/queries/ target=_blank>ECS Queries in Bevy</a> - Understanding how to query components in Bevy’s ECS</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_22809.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>