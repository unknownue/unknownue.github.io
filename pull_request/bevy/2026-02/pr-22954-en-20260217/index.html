<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22954 Enable RenderApp Ambiguity Detection
        
    </title><meta content="#22954 Enable RenderApp Ambiguity Detection" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-17</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-02/pr-22954-zh-cn-20260217>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Enable RenderApp Ambiguity Detection<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22954<li><strong>Author</strong>: atlv24<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, S-Ready-For-Final-Review<li><strong>Created</strong>: 2026-02-14T08:58:17Z<li><strong>Merged</strong>: 2026-02-17T17:02:22Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p><strong>Objective</strong><ul><li>Fix #7386</ul><p><strong>Solution</strong><ul><li>#22951 #22952 #22949 #22945 and a handful more changes on this PR. NOTE: Ci will not pass until all these other prs are merged.<li>Fix a bug</ul><p><strong>Testing</strong><ul><li>examples look fine</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a long-standing issue in Bevy’s ECS scheduling system. The core problem was that ambiguity detection—which identifies systems that can run in parallel without conflicts—wasn’t being applied to the RenderApp. The RenderApp is a separate sub-app in Bevy’s architecture that handles rendering logic, running in parallel with the main app.<p>Without ambiguity detection in the RenderApp, developers could inadvertently introduce system ordering issues that would only manifest as non-deterministic bugs or race conditions during rendering. These bugs would be difficult to diagnose because the ambiguity detection system wouldn’t flag them.<p>The solution involved two main changes:<ol><li><p><strong>Enabling ambiguity detection for RenderApp</strong>: The test that checks for system ambiguities was updated to run against both the main app and the RenderApp. Previously, this test only checked the main app, leaving potential rendering ambiguities undetected.</p><li><p><strong>Resolving existing ambiguities in the RenderApp</strong>: Once ambiguity detection was enabled for RenderApp, several actual ambiguities were identified. These were fixed by adding explicit <code>.ambiguous_with()</code> constraints to systems that access the same resources but weren’t properly ordered.</p></ol><p>The changes follow a consistent pattern. For systems that are part of a <code>SystemSet</code> but also need exclusive access to resources used by other systems in that same set, we add <code>.ambiguous_with()</code> constraints. This tells the scheduler that these systems cannot run in parallel with other systems in their set, even though they’re grouped together.<p>For example, in <code>core_3d/mod.rs</code>, the <code>configure_occlusion_culling_view_targets</code> system is in the <code>RenderSystems::PrepareViews</code> set, but it modifies resources that other systems in that set might also access. The fix adds <code>.ambiguous_with(RenderSystems::PrepareViews)</code> to ensure it doesn’t run concurrently with other systems in the same set.<p>A similar pattern appears in the material system, where <code>extract_entities_needs_specialization</code> and <code>sweep_entities_needing_specialization</code> systems needed to be marked as ambiguous within their respective system sets to prevent concurrent execution issues.<p>The implementation is careful to maintain the existing system ordering while adding these constraints. The changes are minimal and targeted—each fix addresses a specific ambiguity without restructuring the overall system architecture.<p>These changes improve the robustness of Bevy’s rendering system by ensuring that system execution order is deterministic and free from hidden race conditions. Developers can now rely on ambiguity detection to catch potential issues in both the main app and the RenderApp, making the framework more reliable for complex rendering scenarios.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Main App] --> B[Ambiguity Detection Test]
</span><span>    C[RenderApp] --> B
</span><span>    D[core_3d Systems] --> E[PrepareViews Set]
</span><span>    F[oit Systems] --> E
</span><span>    G[material Systems] --> H[MaterialExtractEntitiesNeedingSpecializationSystems]
</span><span>    G --> I[MaterialSweepEntitiesNeedingSpecializationSystems]
</span><span>    J[gpu_preprocess Systems] --> K[PrepareBindGroups Set]
</span><span>    L[dof Systems] --> E
</span><span>    
</span><span>    B --> M[Detected Ambiguities]
</span><span>    M --> N[Add ambiguous_with Constraints]
</span><span>    N --> O[Resolved Execution Order]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=1-tests-ecs-ambiguity-detection-rs-8-5>1. <code>tests/ecs/ambiguity_detection.rs</code> (+8/-5)</h3><p>This file contains the test that checks for system ambiguities. The key change is enabling ambiguity detection for the RenderApp, which was previously skipped.<p><strong>Before:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Ambiguities in the RenderApp are currently allowed.
</span><span style=color:#abb0b6;font-style:italic>// Eventually, we should forbid these: see https://github.com/bevyengine/bevy/issues/7386
</span><span style=color:#abb0b6;font-style:italic>// Uncomment the lines below to show the current ambiguities in the RenderApp.
</span><span style=color:#abb0b6;font-style:italic>// let sub_app = app.sub_app_mut(bevy_render::RenderApp);
</span><span style=color:#abb0b6;font-style:italic>// configure_ambiguity_detection(sub_app);
</span></code></pre><p><strong>After:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let</span><span> sub_app </span><span style=color:#ed9366>=</span><span> app</span><span style=color:#ed9366>.</span><span style=color:#f07171>sub_app_mut</span><span>(bevy_render</span><span style=color:#ed9366>::</span><span>RenderApp)</span><span style=color:#61676ccc>;
</span><span style=color:#f07171>configure_ambiguity_detection</span><span>(sub_app)</span><span style=color:#61676ccc>;
</span></code></pre><p>Additionally, assertions were added to check that the RenderApp has no ambiguities, matching the existing check for the main app.<h3 id=2-crates-bevy-pbr-src-material-rs-9-1>2. <code>crates/bevy_pbr/src/material.rs</code> (+9/-1)</h3><p>This file handles material systems in the rendering pipeline. Two systems needed ambiguity constraints, and a new SystemSet was defined.<p><strong>Key changes:</strong><ul><li>Added <code>MaterialSweepEntitiesNeedingSpecializationSystems</code> SystemSet definition<li>Added <code>.ambiguous_with()</code> constraints to two material specialization systems</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// New SystemSet definition
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(SystemSet</span><span style=color:#61676ccc>,</span><span> Clone</span><span style=color:#61676ccc>,</span><span> PartialEq</span><span style=color:#61676ccc>,</span><span> Eq</span><span style=color:#61676ccc>,</span><span> Debug</span><span style=color:#61676ccc>,</span><span> Hash)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>MaterialSweepEntitiesNeedingSpecializationSystems</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// System with ambiguity constraint added
</span><span>extract_entities_needs_specialization</span><span style=color:#ed9366>::</span><span>&LTM>
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>in_set</span><span>(MaterialExtractEntitiesNeedingSpecializationSystems)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>ambiguous_with</span><span>(MaterialExtractEntitiesNeedingSpecializationSystems)</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Another system with ambiguity constraint and new set
</span><span>sweep_entities_needing_specialization</span><span style=color:#ed9366>::</span><span>&LTM>
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>in_set</span><span>(MaterialSweepEntitiesNeedingSpecializationSystems)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>ambiguous_with</span><span>(MaterialSweepEntitiesNeedingSpecializationSystems)
</span></code></pre><h3 id=3-crates-bevy-core-pipeline-src-core-3d-mod-rs-2-1>3. <code>crates/bevy_core_pipeline/src/core_3d/mod.rs</code> (+2/-1)</h3><p>This file contains 3D rendering pipeline systems. The occlusion culling system needed an ambiguity constraint.<p><strong>Before:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>configure_occlusion_culling_view_targets
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>after</span><span>(prepare_view_targets)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>in_set</span><span>(RenderSystems</span><span style=color:#ed9366>::</span><span>PrepareViews)</span><span style=color:#61676ccc>,
</span></code></pre><p><strong>After:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>configure_occlusion_culling_view_targets
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>after</span><span>(prepare_view_targets)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>in_set</span><span>(RenderSystems</span><span style=color:#ed9366>::</span><span>PrepareViews)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>ambiguous_with</span><span>(RenderSystems</span><span style=color:#ed9366>::</span><span>PrepareViews)</span><span style=color:#61676ccc>,
</span></code></pre><h3 id=4-crates-bevy-core-pipeline-src-oit-mod-rs-3-1>4. <code>crates/bevy_core_pipeline/src/oit/mod.rs</code> (+3/-1)</h3><p>This file handles Order Independent Transparency systems. The camera depth configuration system needed an ambiguity constraint.<p><strong>Before:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>configure_camera_depth_usages</span><span style=color:#ed9366>.</span><span style=color:#f07171>in_set</span><span>(RenderSystems</span><span style=color:#ed9366>::</span><span>PrepareViews)</span><span style=color:#61676ccc>,
</span></code></pre><p><strong>After:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>configure_camera_depth_usages
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>in_set</span><span>(RenderSystems</span><span style=color:#ed9366>::</span><span>PrepareViews)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>ambiguous_with</span><span>(RenderSystems</span><span style=color:#ed9366>::</span><span>PrepareViews)</span><span style=color:#61676ccc>,
</span></code></pre><h3 id=5-crates-bevy-pbr-src-render-gpu-preprocess-rs-2-1>5. <code>crates/bevy_pbr/src/render/gpu_preprocess.rs</code> (+2/-1)</h3><p>This file handles GPU pre-processing for meshes. Added an explicit ordering constraint.<p><strong>Before:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>prepare_mesh_bind_group</span><span style=color:#ed9366>::</span><span>&LTMeshPipeline, MeshUniform, MeshInputUniform>
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>in_set</span><span>(RenderSystems</span><span style=color:#ed9366>::</span><span>PrepareBindGroups)</span><span style=color:#61676ccc>,
</span></code></pre><p><strong>After:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>prepare_mesh_bind_group</span><span style=color:#ed9366>::</span><span>&LTMeshPipeline, MeshUniform, MeshInputUniform>
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>in_set</span><span>(RenderSystems</span><span style=color:#ed9366>::</span><span>PrepareBindGroups)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>after</span><span>(prepare_preprocess_pipelines)</span><span style=color:#61676ccc>,
</span></code></pre><h3 id=6-crates-bevy-post-process-src-dof-mod-rs-2-1>6. <code>crates/bevy_post_process/src/dof/mod.rs</code> (+2/-1)</h3><p>This file handles Depth of Field post-processing. The view target configuration system needed an ambiguity constraint.<p><strong>Before:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>configure_depth_of_field_view_targets</span><span style=color:#61676ccc>,
</span></code></pre><p><strong>After:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>configure_depth_of_field_view_targets
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>ambiguous_with</span><span>(RenderSystems</span><span style=color:#ed9366>::</span><span>PrepareViews)</span><span style=color:#61676ccc>,
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/ecs-system-order/ target=_blank>Bevy ECS System Ordering Documentation</a> - Official guide on system ordering and ambiguity<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/ecs-system-sets/ target=_blank>System Sets in Bevy</a> - How to organize systems into sets<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/issues/7386 target=_blank>Issue #7386: Enable ambiguity detection for RenderApp</a> - The original issue this PR fixes<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/render-graph/ target=_blank>Bevy Render Graph Architecture</a> - Understanding the RenderApp and its relationship to the main app</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_22954.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>