<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #23062 Fix volumetric rendering order problem
        
    </title><meta content="#23062 Fix volumetric rendering order problem" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-24</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-02/pr-23062-zh-cn-20260224>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix volumetric rendering order problem<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/23062<li><strong>Author</strong>: dan-dozen<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, D-Trivial, A-Rendering, S-Ready-For-Final-Review<li><strong>Created</strong>: 2026-02-19T22:00:00Z<li><strong>Merged</strong>: 2026-02-24T03:08:28Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p><strong>Objective</strong><ul><li>Fixes an issue where volumetric fog renders behind other meshes. Fixes https://github.com/bevyengine/bevy/issues/17429</ul><p><strong>Solution</strong><ul><li>Updates the shader to not render when behind other geometry</ul><p><strong>Testing</strong><ul><li>Tested on macOS 15.7.3 (24G419) Apple M3 Pro<li>Needs testing on other platforms<li>Test this change by patching in https://github.com/dan-dozen/bevy/pull/1/changes and running <code>examples/3d/volumetric_fog.rs</code>. I’m happy to include the changes to the example too.</ul><hr><p><strong>Showcase</strong><details><summary>Click to view showcase</summary> <p>Before the change, you can see the volumetric fog inside of the house, even though it is behind the front wall: <img alt="Screenshot 2026-02-19 at 4 59 03 PM" height=860 src=https://github.com/user-attachments/assets/a5ab1a19-ca39-453f-b6c4-8a667d8a5a88 width=1392></p> <p>After the change, it’s no longer visible: <img alt="Screenshot 2026-02-19 at 4 57 56 PM" height=860 src=https://github.com/user-attachments/assets/88d05951-a3fb-4a05-a85c-ddee31884b5c width=1392></p></details><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a specific visual bug in Bevy’s volumetric fog rendering system. The problem was straightforward: volumetric fog particles were incorrectly rendering behind opaque geometry like walls, when they should have been occluded. This violated the expected depth ordering in 3D rendering where objects closer to the camera should obscure objects further away.<p>The issue stemmed from how the volumetric fog fragment shader handled depth calculations. The original implementation calculated the ray length between the camera and the fog volume using an absolute value function. This mathematical approach caused the fog to render even when it was positioned behind opaque surfaces, because the absolute value always returned a positive length regardless of depth ordering.<p>The solution implemented a more physically accurate depth comparison. Instead of using <code>abs()</code> to calculate ray length, the fix uses <code>max(0.0, end_depth_view - start_depth_view)</code>. This ensures that if the fog volume’s end depth is behind the start depth (meaning it’s occluded by nearer geometry), the calculated ray length will be zero. The shader then checks for this zero-length condition and returns a transparent color (RGBA 0,0,0,0), effectively discarding the fragment.<p>This approach is both efficient and correct. The early exit when <code>ray_length_view == 0.0</code> avoids unnecessary computation for occluded fragments, providing a minor performance optimization in addition to fixing the visual bug. The implementation follows standard graphics programming patterns for depth-aware rendering, where fragments behind opaque surfaces should be culled early to save GPU cycles.<p>From an architectural perspective, this change is minimal and localized to a single shader file, which reduces the risk of introducing regressions. The fix maintains compatibility with the existing rendering pipeline and doesn’t require changes to other systems like material handling or camera setup. The logic is self-contained within the fragment shader’s depth calculation phase, making it easy to understand and maintain.<p>The testing approach demonstrated good practice - the author tested on their development platform (macOS with Apple M3 Pro) and acknowledged the need for cross-platform validation. They provided clear reproduction steps using the existing <code>volumetric_fog.rs</code> example, which allows other developers to verify the fix works correctly in their environments.<p>This fix illustrates an important principle in graphics programming: depth calculations need careful handling of relative positions, not just absolute distances. The original <code>abs()</code> approach worked mathematically but didn’t respect the visual hierarchy of the scene. The new implementation correctly models the physical reality that light from occluded objects doesn’t reach the camera, and therefore shouldn’t contribute to the final image.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Camera Position] --> B[Start Depth Calculation]
</span><span>    B --> C{End Depth Comparison}
</span><span>    C -->|End behind Start| D[Ray Length = 0]
</span><span>    C -->|End in front of Start| E[Ray Length > 0]
</span><span>    D --> F[Return Transparent Fragment]
</span><span>    E --> G[Continue Volumetric Integration]
</span><span>    G --> H[Output Fog Color]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>crates/bevy_pbr/src/volumetric_fog/volumetric_fog.wgsl</strong> (+7/-1)<p>This file contains the WebGPU Shading Language (WGSL) shader for volumetric fog rendering. The changes fix the depth ordering problem by modifying how the ray length is calculated and adding an early exit for occluded fragments.<p><strong>Before:</strong><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>fn fragment(@builtin(position) position: vec4&LTf32>) -> @location(0) vec4&LTf32> {
</span><span>    // ... other code ...
</span><span>    
</span><span>    // We assume world and view have the same scale here.
</span><span>    let start_depth_view = -depth_ndc_to_view_z(frag_coord.z);
</span><span>    let ray_length_view = abs(end_depth_view - start_depth_view);
</span><span>    
</span><span>    // ... continue with volumetric integration ...
</span><span>}
</span></code></pre><p><strong>After:</strong><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>fn fragment(@builtin(position) position: vec4&LTf32>) -> @location(0) vec4&LTf32> {
</span><span>    // ... other code ...
</span><span>    
</span><span>    // We assume world and view have the same scale here.
</span><span>    let start_depth_view = -depth_ndc_to_view_z(frag_coord.z);
</span><span>
</span><span>    let ray_length_view = max(0.0, end_depth_view - start_depth_view);
</span><span>    // If the end is behind the start of the first opaque pixel, then we know it
</span><span>    // is occluded, and we don't need to render it
</span><span>    if (ray_length_view == 0.0) {
</span><span>        return vec4(0.0, 0.0, 0.0, 0.0);
</span><span>    }
</span><span>    let inv_step_count = 1.0 / f32(step_count);
</span><span>    let step_size_world = ray_length_view * inv_step_count;
</span><span>    
</span><span>    // ... continue with volumetric integration ...
</span><span>}
</span></code></pre><p>The key changes are:<ol><li>Replaced <code>abs(end_depth_view - start_depth_view)</code> with <code>max(0.0, end_depth_view - start_depth_view)</code><li>Added an early return of transparent black when <code>ray_length_view == 0.0</code><li>Added a clarifying comment explaining the occlusion logic</ol><h2 id=further-reading>Further Reading</h2><ol><li><strong>WebGPU Shading Language (WGSL) Specification</strong>: https://www.w3.org/TR/WGSL/<li><strong>Volumetric Fog Techniques</strong>: https://developer.nvidia.com/gpugems/gpugems2/part-ii-shading-lighting-and-shadows/chapter-13-volumetric-fog-and-light<li><strong>Depth Buffer and Occlusion Culling</strong>: https://learnopengl.com/Advanced-OpenGL/Depth-testing<li><strong>Bevy Rendering Pipeline Documentation</strong>: https://bevyengine.org/learn/book/rendering/<li><strong>GPU Ray Marching for Volumetric Effects</strong>: https://iquilezles.org/articles/volumetric/</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_23062.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>