<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22903 Do not trigger ui Node change in each frame while updating scrollbar
        
    </title><meta content="#22903 Do not trigger ui Node change in each frame while updating scrollbar" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-12</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2026-02/pr-22903-en-20260212>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=title>Title</h1><p>不要在每个帧更新滚动条时触发 UI 节点变更检测<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Do not trigger ui Node change in each frame while updating scrollbar<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22903<li><strong>Author</strong>: PPakalns<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, C-Performance, A-UI, S-Ready-For-Final-Review, D-Straightforward<li><strong>Created</strong>: 2026-02-11T09:01:23Z<li><strong>Merged</strong>: 2026-02-12T19:50:12Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p><strong>目标</strong> 修复 https://github.com/bevyengine/bevy/issues/22893<p><strong>测试</strong><ul><li>使用 Tracy profiler 观察性能改进和 ‘track_location’ bevy 特性。</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>这个 PR 源于一个性能问题。在 Bevy 的 UI 系统中，滚动条的滑块（thumb）位置和大小需要根据滚动区域的内容动态更新。问题出现在 <code>update_scrollbar_thumb</code> 这个系统函数里。在修复前，该系统在每一帧运行时，无论滑块的属性（如 <code>top</code>， <code>left</code>， <code>width</code>）是否真的发生了变化，都会无条件地对其重新赋值。<p>从技术角度看，这触发了 Bevy ECS 内部的变化检测（Change Detection）机制。Bevy 的组件（<code>Component</code>）通过 <code>DerefMut</code> 实现变化追踪：每当对组件的字段进行赋值，即便赋的是相同的值，也会标记该组件为已变更（<code>Mut</code>）。对于 UI 节点（<code>Node</code>）组件来说，这会导致下游一系列依赖 <code>Changed&LTNode></code> 查询的系统被不必要地执行，例如布局（Layout）重计算，从而造成了性能浪费。<p>开发者 PPakalns 通过 Tracy profiler 和 Bevy 的 <code>track_location</code> 特性定位到了这个问题。Profiler 的结果显示，即使 UI 处于静止状态（没有滚动操作），与 UI 节点变更相关的系统也持续消耗着 CPU 时间。<p>解决方案非常直接：在更新滑块组件的属性前，先进行一次比较。只有当计算出的新值与当前值确实不同时，才执行赋值操作。这个模式在优化中很常见，目的是避免触发无意义的变化检测，其核心是尊重 Bevy ECS 的变更检测语义。<p>具体实现上，代码为水平和垂直两种滚动条方向分别计算了新的位置（如 <code>thumb_pos</code>）和尺寸（如 <code>thumb_size</code>）。在修复前，这些 <code>Val::Px(...)</code> 值被直接赋给 <code>thumb</code>（一个 <code>Node</code> 组件）的对应字段。修复后，代码先将新值存储在局部变量（<code>top</code>， <code>left</code>， <code>width</code> 等）中，然后通过一个 <code>if</code> 条件语句，比较所有相关的新旧值。仅在任一值不相等时，才将局部变量的值赋给 <code>thumb</code> 的字段。<p>这种修改是一个典型的“空操作（no-op）优化”。它没有改变任何业务逻辑——滑块的视觉表现和之前完全一致。它只是减少了在数据未变化时产生的“噪音”，让 ECS 的变化检测机制能更准确地反映真实的变更。<p>这个修复的收益取决于 UI 的复杂度和滚动条的数量。对于一个拥有多个静态滚动条的应用，它可以消除几乎所有的、在空闲状态下由滚动条更新系统引起的冗余计算。对于动态滚动的场景，它确保变化检测只在滑块位置实际移动时才被触发，同样提高了效率。<p>从工程角度看，这是一个低风险、高回报的修改。它改动范围极小，只影响一个函数；逻辑清晰，仅仅是增加了条件判断；并且完美解决了报告的性能问题。这解释了为什么它被标记为 <code>D-Straightforward</code> 并在短时间内就被合并。<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    subgraph "修复前"
</span><span>        A[每帧运行 update_scrollbar_thumb] --> B[无条件赋值 thumb 属性]
</span><span>        B --> C[Node 组件被标记为 Changed]
</span><span>        C --> D[触发依赖 Changed&LTNode> 的系统&LTbr>如布局计算]
</span><span>    end
</span><span>
</span><span>    subgraph "修复后"
</span><span>        E[每帧运行 update_scrollbar_thumb] --> F{计算的新值 != 当前值?}
</span><span>        F -- 是 --> G[赋值 thumb 属性]
</span><span>        G --> H[Node 组件被标记为 Changed]
</span><span>        F -- 否 --> I[跳过赋值]
</span><span>        I --> J[Node 组件状态不变]
</span><span>        H --> D
</span><span>        J --> K[不触发额外系统，节省 CPU]
</span><span>    end
</span><span>
</span><span>    D --> L[性能开销]
</span><span>    K --> M[性能提升]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>crates/bevy_ui_widgets/src/scrollbar.rs</strong> (+28/-8)<p>这是本次 PR 修改的唯一文件。修改位于 <code>update_scrollbar_thumb</code> 函数内，该函数负责根据滚动区域（<code>ScrollArea</code>）的状态更新滚动条滑块的外观（位置和大小）。<p><strong>修改详情：</strong><p>修改的核心逻辑是从直接赋值改为条件赋值。以下是关键代码段的对比：<p><strong>水平滚动条方向处理部分：</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 修改前：
</span><span>thumb</span><span style=color:#ed9366>.</span><span>top </span><span style=color:#ed9366>= </span><span>Val</span><span style=color:#ed9366>::</span><span>Px(</span><span style=color:#ff8f40>0.</span><span>)</span><span style=color:#61676ccc>;
</span><span>thumb</span><span style=color:#ed9366>.</span><span>bottom </span><span style=color:#ed9366>= </span><span>Val</span><span style=color:#ed9366>::</span><span>Px(</span><span style=color:#ff8f40>0.</span><span>)</span><span style=color:#61676ccc>;
</span><span>thumb</span><span style=color:#ed9366>.</span><span>left </span><span style=color:#ed9366>= </span><span>Val</span><span style=color:#ed9366>::</span><span>Px(thumb_pos)</span><span style=color:#61676ccc>;
</span><span>thumb</span><span style=color:#ed9366>.</span><span>width </span><span style=color:#ed9366>= </span><span>Val</span><span style=color:#ed9366>::</span><span>Px(thumb_size)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 修改后：
</span><span style=color:#fa6e32>let</span><span> top </span><span style=color:#ed9366>= </span><span>Val</span><span style=color:#ed9366>::</span><span>Px(</span><span style=color:#ff8f40>0.</span><span>)</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> bottom </span><span style=color:#ed9366>= </span><span>Val</span><span style=color:#ed9366>::</span><span>Px(</span><span style=color:#ff8f40>0.</span><span>)</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> left </span><span style=color:#ed9366>= </span><span>Val</span><span style=color:#ed9366>::</span><span>Px(thumb_pos)</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> width </span><span style=color:#ed9366>= </span><span>Val</span><span style=color:#ed9366>::</span><span>Px(thumb_size)</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>if</span><span> top </span><span style=color:#ed9366>!=</span><span> thumb</span><span style=color:#ed9366>.</span><span>top
</span><span>    </span><span style=color:#ed9366>||</span><span> bottom </span><span style=color:#ed9366>!=</span><span> thumb</span><span style=color:#ed9366>.</span><span>bottom
</span><span>    </span><span style=color:#ed9366>||</span><span> left </span><span style=color:#ed9366>!=</span><span> thumb</span><span style=color:#ed9366>.</span><span>left
</span><span>    </span><span style=color:#ed9366>||</span><span> width </span><span style=color:#ed9366>!=</span><span> thumb</span><span style=color:#ed9366>.</span><span>width
</span><span>{
</span><span>    thumb</span><span style=color:#ed9366>.</span><span>top </span><span style=color:#ed9366>=</span><span> top</span><span style=color:#61676ccc>;
</span><span>    thumb</span><span style=color:#ed9366>.</span><span>bottom </span><span style=color:#ed9366>=</span><span> bottom</span><span style=color:#61676ccc>;
</span><span>    thumb</span><span style=color:#ed9366>.</span><span>left </span><span style=color:#ed9366>=</span><span> left</span><span style=color:#61676ccc>;
</span><span>    thumb</span><span style=color:#ed9366>.</span><span>width </span><span style=color:#ed9366>=</span><span> width</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p><strong>垂直滚动条方向处理部分：</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 修改前：
</span><span>thumb</span><span style=color:#ed9366>.</span><span>left </span><span style=color:#ed9366>= </span><span>Val</span><span style=color:#ed9366>::</span><span>Px(</span><span style=color:#ff8f40>0.</span><span>)</span><span style=color:#61676ccc>;
</span><span>thumb</span><span style=color:#ed9366>.</span><span>right </span><span style=color:#ed9366>= </span><span>Val</span><span style=color:#ed9366>::</span><span>Px(</span><span style=color:#ff8f40>0.</span><span>)</span><span style=color:#61676ccc>;
</span><span>thumb</span><span style=color:#ed9366>.</span><span>top </span><span style=color:#ed9366>= </span><span>Val</span><span style=color:#ed9366>::</span><span>Px(thumb_pos)</span><span style=color:#61676ccc>;
</span><span>thumb</span><span style=color:#ed9366>.</span><span>height </span><span style=color:#ed9366>= </span><span>Val</span><span style=color:#ed9366>::</span><span>Px(thumb_size)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 修改后：
</span><span style=color:#fa6e32>let</span><span> left </span><span style=color:#ed9366>= </span><span>Val</span><span style=color:#ed9366>::</span><span>Px(</span><span style=color:#ff8f40>0.</span><span>)</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> right </span><span style=color:#ed9366>= </span><span>Val</span><span style=color:#ed9366>::</span><span>Px(</span><span style=color:#ff8f40>0.</span><span>)</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> top </span><span style=color:#ed9366>= </span><span>Val</span><span style=color:#ed9366>::</span><span>Px(thumb_pos)</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> height </span><span style=color:#ed9366>= </span><span>Val</span><span style=color:#ed9366>::</span><span>Px(thumb_size)</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>if</span><span> thumb</span><span style=color:#ed9366>.</span><span>left </span><span style=color:#ed9366>!=</span><span> left
</span><span>    </span><span style=color:#ed9366>||</span><span> thumb</span><span style=color:#ed9366>.</span><span>right </span><span style=color:#ed9366>!=</span><span> right
</span><span>    </span><span style=color:#ed9366>||</span><span> thumb</span><span style=color:#ed9366>.</span><span>top </span><span style=color:#ed9366>!=</span><span> top
</span><span>    </span><span style=color:#ed9366>||</span><span> thumb</span><span style=color:#ed9366>.</span><span>height </span><span style=color:#ed9366>!=</span><span> height
</span><span>{
</span><span>    thumb</span><span style=color:#ed9366>.</span><span>left </span><span style=color:#ed9366>=</span><span> left</span><span style=color:#61676ccc>;
</span><span>    thumb</span><span style=color:#ed9366>.</span><span>right </span><span style=color:#ed9366>=</span><span> right</span><span style=color:#61676ccc>;
</span><span>    thumb</span><span style=color:#ed9366>.</span><span>top </span><span style=color:#ed9366>=</span><span> top</span><span style=color:#61676ccc>;
</span><span>    thumb</span><span style=color:#ed9366>.</span><span>height </span><span style=color:#ed9366>=</span><span> height</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p><strong>修改关系：</strong> 这两处修改遵循完全相同的模式，分别处理滚动条的两种朝向。它们直接解决了 PR 描述中的问题：阻止在每一帧（即使滑块位置未变）都触发 UI <code>Node</code> 组件的变更。这是通过确保仅在组件值实际发生变化时才进行写操作来实现的，从而避免了 Bevy ECS 的误判。<h2 id=further-reading>Further Reading</h2><ol><li><p><strong>Bevy Change Detection Official Guide</strong>：了解 Bevy ECS 变化检测的工作原理是其高效使用的关键。</p> <ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/ecs/change_detection/index.html target=_blank>Bevy 官方文档 - Change Detection</a></ul><li><p><strong>《Bevy 游戏开发指南》相关章节</strong>：对于更宏观的 UI 系统架构和性能考量，社区编写的指南可能提供更多上下文。</p> <ul><li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/features/ui.html target=_blank>Bevy Cheatbook - UI</a></ul><li><p><strong>性能分析工具 Tracy</strong>：像本 PR 作者一样，学习使用性能分析工具是定位性能瓶颈的必备技能。</p> <ul><li><a rel="noopener nofollow noreferrer" href=https://github.com/wolfpld/tracy target=_blank>Tracy Profiler 官方网站</a></ul></ol><h1 id=full-code-diff>Full Code Diff</h1><pre style=color:#61676c;background-color:#fafafa><code><span>diff --git a/crates/bevy_ui_widgets/src/scrollbar.rs b/crates/bevy_ui_widgets/src/scrollbar.rs
</span><span>index db3a166ac0be9..6c3087d7576b5 100644
</span><span>--- a/crates/bevy_ui_widgets/src/scrollbar.rs
</span><span>+++ b/crates/bevy_ui_widgets/src/scrollbar.rs
</span><span>@@ -308,10 +308,20 @@ fn update_scrollbar_thumb(
</span><span>                             scroll_area.0.x,
</span><span>                         );
</span><span> 
</span><span>-                        thumb.top = Val::Px(0.);
</span><span>-                        thumb.bottom = Val::Px(0.);
</span><span>-                        thumb.left = Val::Px(thumb_pos);
</span><span>-                        thumb.width = Val::Px(thumb_size);
</span><span>+                        let top = Val::Px(0.);
</span><span>+                        let bottom = Val::Px(0.);
</span><span>+                        let left = Val::Px(thumb_pos);
</span><span>+                        let width = Val::Px(thumb_size);
</span><span>+                        if top != thumb.top
</span><span>+                            || bottom != thumb.bottom
</span><span>+                            || left != thumb.left
</span><span>+                            || width != thumb.width
</span><span>+                        {
</span><span>+                            thumb.top = top;
</span><span>+                            thumb.bottom = bottom;
</span><span>+                            thumb.left = left;
</span><span>+                            thumb.width = width;
</span><span>+                        }
</span><span>                     }
</span><span>                     ControlOrientation::Vertical => {
</span><span>                         let (thumb_size, thumb_pos) = size_and_pos(
</span><span>@@ -322,10 +332,20 @@ fn update_scrollbar_thumb(
</span><span>                             scroll_area.0.y,
</span><span>                         );
</span><span> 
</span><span>-                        thumb.left = Val::Px(0.);
</span><span>-                        thumb.right = Val::Px(0.);
</span><span>-                        thumb.top = Val::Px(thumb_pos);
</span><span>-                        thumb.height = Val::Px(thumb_size);
</span><span>+                        let left = Val::Px(0.);
</span><span>+                        let right = Val::Px(0.);
</span><span>+                        let top = Val::Px(thumb_pos);
</span><span>+                        let height = Val::Px(thumb_size);
</span><span>+                        if thumb.left != left
</span><span>+                            || thumb.right != right
</span><span>+                            || thumb.top != top
</span><span>+                            || thumb.height != height
</span><span>+                        {
</span><span>+                            thumb.left = left;
</span><span>+                            thumb.right = right;
</span><span>+                            thumb.top = top;
</span><span>+                            thumb.height = height;
</span><span>+                        }
</span><span>                     }
</span><span>                 };
</span><span>             }
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_22903.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>