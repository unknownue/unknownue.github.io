<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22860 Fix wrong component sync for GeneratedEnvironmentMapLight
        
    </title><meta content="#22860 Fix wrong component sync for GeneratedEnvironmentMapLight" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-07</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-02/pr-22860-zh-cn-20260207>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix wrong component sync for GeneratedEnvironmentMapLight<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22860<li><strong>Author</strong>: kristoff3r<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, D-Trivial, A-Rendering, S-Ready-For-Final-Review<li><strong>Created</strong>: 2026-02-07T21:42:53Z<li><strong>Merged</strong>: 2026-02-07T23:23:20Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Fixes the following log spam (and wrong sync behavior) introduced by #22766:<pre style=color:#61676c;background-color:#fafafa><code><span>ERROR bevy_pbr::cluster: Clustered light or decal 5v0 had no assigned index!
</span></code></pre><h2 id=solution>Solution</h2><p>The components here are named in an interesting way. We have 3 components:<ul><li><code>EnvironmentMapLight</code><li><code>GeneratedEnvironmentMapLight</code><li><code>RenderEnvironmentMap</code></ul><p>When I added the <code>SyncComponent</code> impl I pattern matched on the upper two names, and assumed that <code>EnvironmentMapLight</code> was the main world component and <code>GeneratedEnvironmentMapLight</code> was in the render world.<p>Actually <code>GeneratedEnvironmentMapLight</code> is a specific way to generate an <code>EnvironmentMapLight</code>, and the render world entity is called <code>RenderEnvironmentMap</code>. Fixing the <code>SyncComponent</code> impl to reflect that fixes the issue.<p>I still feel like there are other issues after this fix:<ul><li><code>GeneratedEnvironmentMapLight</code> could really use a better name (<code>GenerateEnvironmentMapLight</code>? <code>RuntimeEnvironmentMapLight</code>?), and better docs.<li>I think it’s still missing some syncing logic, as far as I can tell nothing handles the generated <code>EnvironmentMapLight</code> if a <code>GeneratedEnvironmentMapLight</code> is updated or deleted? I didn’t do a deep dive so I might have missed something.</ul><h2 id=testing>Testing</h2><p>Tested with the <code>light_probe_blending</code> and <code>reflection_probes</code> examples.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a bug introduced in a previous change (#22766) that caused incorrect synchronization between the main world and render world for environment map lights. The bug manifested as log spam with error messages about clustered lights having no assigned index, indicating a mismatch between how lights were registered and synchronized between worlds.<p>The root cause was a misunderstanding of the component naming and relationships in Bevy’s environment map system. The developer initially implemented a <code>SyncComponent</code> trait for the wrong component pair. They assumed that <code>EnvironmentMapLight</code> was the main world component that should sync to <code>GeneratedEnvironmentMapLight</code> in the render world, based on the naming pattern of the first two components they encountered.<p>However, the actual architecture uses three distinct components:<ol><li><code>EnvironmentMapLight</code> - The actual light component used in the main world<li><code>GeneratedEnvironmentMapLight</code> - A marker component indicating that an <code>EnvironmentMapLight</code> should be generated at runtime<li><code>RenderEnvironmentMap</code> - The render world representation that handles the actual rendering logic</ol><p>The correct synchronization path is from <code>GeneratedEnvironmentMapLight</code> (main world) to <code>RenderEnvironmentMap</code> (render world), not from <code>EnvironmentMapLight</code> to <code>GeneratedEnvironmentMapLight</code>. This incorrect sync meant that render world entities weren’t being properly created or tracked, leading to the “no assigned index” errors when the clustered lighting system tried to reference them.<p>The fix is straightforward but important: update the <code>SyncComponent</code> implementation to use the correct component types. This ensures that when a <code>GeneratedEnvironmentMapLight</code> is added to an entity in the main world, a corresponding <code>RenderEnvironmentMap</code> entity is created in the render world with all the necessary bindings and resources for rendering.<p>Beyond the immediate fix, the PR author notes some broader issues with the component naming and synchronization logic. The name <code>GeneratedEnvironmentMapLight</code> is somewhat confusing since it doesn’t directly correspond to a render world component. Additionally, there may be missing synchronization logic for updates or deletions of generated environment maps, though this wasn’t explored in depth for this bug fix.<p>The implementation shows a common pattern in Bevy’s ECS architecture where components in the main world need corresponding representations in the render world. The <code>SyncComponent</code> trait and associated systems handle this cross-world synchronization automatically when properly configured.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[GeneratedEnvironmentMapLight&LTbr/>Main World] --> B[SyncComponent&LTbr/>Synchronization]
</span><span>    B --> C[RenderEnvironmentMap&LTbr/>Render World]
</span><span>    D[EnvironmentMapLight&LTbr/>Main World] -.-> A
</span><span>    C --> E[Rendering Systems&LTbr/>Render World]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>File:</strong> <code>crates/bevy_pbr/src/light_probe/generate.rs</code><p><strong>Changes:</strong> Fixed incorrect component synchronization for environment map generation.<p><strong>Key modifications:</strong><ol><li><p><strong>Updated the plugin registration to sync the correct component:</strong></p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_plugins</span><span>(SyncComponentPlugin</span><span style=color:#ed9366>::</span><span>&LTEnvironmentMapLight, </span><span style=color:#fa6e32>Self</span><span>></span><span style=color:#ed9366>::</span><span>default())
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_plugins</span><span>(SyncComponentPlugin</span><span style=color:#ed9366>::</span><span>&LTGeneratedEnvironmentMapLight, </span><span style=color:#fa6e32>Self</span><span>></span><span style=color:#ed9366>::</span><span>default())
</span></code></pre><li><p><strong>Simplified a query by removing unnecessary filter:</strong></p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>light_probes</span><span style=color:#61676ccc>: </span><span>Query<
</span><span>    (Entity, </span><span style=color:#ed9366>&</span><span>IntermediateTextures, </span><span style=color:#ed9366>&</span><span>RenderEnvironmentMap),
</span><span>    With&LTRenderEnvironmentMap>,
</span><span>>
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>light_probes</span><span style=color:#61676ccc>: </span><span>Query<(Entity, </span><span style=color:#ed9366>&</span><span>IntermediateTextures, </span><span style=color:#ed9366>&</span><span>RenderEnvironmentMap)>
</span></code></pre> <p>This change removes a redundant <code>With&LTRenderEnvironmentMap></code> filter since the query already requires <code>RenderEnvironmentMap</code> in its tuple.</p><li><p><strong>Fixed the SyncComponent implementation:</strong></p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>impl </span><span>SyncComponent&LTEnvironmentMapGenerationPlugin> </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>EnvironmentMapLight </span><span>{
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Out </span><span style=color:#ed9366>=</span><span> GeneratedEnvironmentMapLight</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>impl </span><span>SyncComponent&LTEnvironmentMapGenerationPlugin> </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>GeneratedEnvironmentMapLight </span><span>{
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Out </span><span style=color:#ed9366>=</span><span> RenderEnvironmentMap</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre> <p>This is the core fix that changes the synchronization from <code>EnvironmentMapLight → GeneratedEnvironmentMapLight</code> to <code>GeneratedEnvironmentMapLight → RenderEnvironmentMap</code>.</p></ol><p>These changes ensure that when a <code>GeneratedEnvironmentMapLight</code> component is added to an entity in the main world, the synchronization system correctly creates a corresponding <code>RenderEnvironmentMap</code> entity in the render world, which is necessary for proper rendering of environment maps.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/getting-started/ecs/ target=_blank>Bevy’s ECS Architecture</a> - Understanding how Bevy’s Entity Component System works<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/getting-started/app-builder/#render-app target=_blank>Bevy Render World Pattern</a> - How Bevy separates main world and render world logic<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/pull/22766 target=_blank>Previous PR #22766</a> - The PR that introduced the bug, for context on what changed<li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Reflection_mapping target=_blank>Environment Maps in Computer Graphics</a> - Background on environment mapping techniques in rendering</ul><h1 id=full-code-diff>Full Code Diff</h1><pre style=color:#61676c;background-color:#fafafa><code><span>diff --git a/crates/bevy_pbr/src/light_probe/generate.rs b/crates/bevy_pbr/src/light_probe/generate.rs
</span><span>index 7d902d6baf199..99c30e2d81180 100644
</span><span>--- a/crates/bevy_pbr/src/light_probe/generate.rs
</span><span>+++ b/crates/bevy_pbr/src/light_probe/generate.rs
</span><span>@@ -17,7 +17,7 @@ use bevy_core_pipeline::mip_generation::{self, DownsampleShaders, DownsamplingCo
</span><span> use bevy_ecs::{
</span><span>     component::Component,
</span><span>     entity::Entity,
</span><span>-    query::{With, Without},
</span><span>+    query::Without,
</span><span>     resource::Resource,
</span><span>     schedule::IntoScheduleConfigs,
</span><span>     system::{Commands, Query, Res, ResMut},
</span><span>@@ -128,7 +128,7 @@ impl Plugin for EnvironmentMapGenerationPlugin {
</span><span>         embedded_asset!(app, "environment_filter.wgsl");
</span><span>         embedded_asset!(app, "copy.wgsl");
</span><span> 
</span><span>-        app.add_plugins(SyncComponentPlugin::&LTEnvironmentMapLight, Self>::default())
</span><span>+        app.add_plugins(SyncComponentPlugin::&LTGeneratedEnvironmentMapLight, Self>::default())
</span><span>             .add_systems(Update, generate_environment_map_light);
</span><span> 
</span><span>         let Some(render_app) = app.get_sub_app_mut(RenderApp) else {
</span><span>@@ -557,10 +557,7 @@ pub struct GeneratorBindGroups {
</span><span> 
</span><span> /// Prepares bind groups for environment map generation pipelines
</span><span> pub fn prepare_generated_environment_map_bind_groups(
</span><span>-    light_probes: Query<
</span><span>-        (Entity, &IntermediateTextures, &RenderEnvironmentMap),
</span><span>-        With&LTRenderEnvironmentMap>,
</span><span>-    >,
</span><span>+    light_probes: Query<(Entity, &IntermediateTextures, &RenderEnvironmentMap)>,
</span><span>     render_device: Res&LTRenderDevice>,
</span><span>     pipeline_cache: Res&LTPipelineCache>,
</span><span>     queue: Res&LTRenderQueue>,
</span><span>@@ -1109,6 +1106,6 @@ pub fn generate_environment_map_light(
</span><span>     }
</span><span> }
</span><span> 
</span><span>-impl SyncComponent&LTEnvironmentMapGenerationPlugin> for EnvironmentMapLight {
</span><span>-    type Out = GeneratedEnvironmentMapLight;
</span><span>+impl SyncComponent&LTEnvironmentMapGenerationPlugin> for GeneratedEnvironmentMapLight {
</span><span>+    type Out = RenderEnvironmentMap;
</span><span> }
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_22860.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>