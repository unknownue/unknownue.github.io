<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22857 Make light extraction retained, and clean up lights that became newly invisible.
        
    </title><meta content="#22857 Make light extraction retained, and clean up lights that became newly invisible." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-09</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2026-02/pr-22857-en-20260209>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=ji-ben-xin-xi>基本信息</h2><ul><li><strong>标题</strong>: Make light extraction retained, and clean up lights that became newly invisible.<li><strong>PR 链接</strong>: https://github.com/bevyengine/bevy/pull/22857<li><strong>作者</strong>: pcwalton<li><strong>状态</strong>: 已合并<li><strong>标签</strong>: C-Bug, A-Rendering, C-Performance, P-Regression<li><strong>创建时间</strong>: 2026-02-07T18:21:08Z<li><strong>合并时间</strong>: 2026-02-09T07:36:06Z<li><strong>合并者</strong>: superdump</ul><h2 id=miao-shu-fan-yi>描述翻译</h2><p>光照代码的设计原则是：任何视图中都不可见的光源不应存在于渲染世界（render world）中。不幸的是，当渲染世界变为保留模式（retained mode）时，光源提取（light extraction）代码并未完全更新以清理那些变得不可见的光源对应的组件。因此，Bevy 当前并未强制执行这一约束。这导致 <code>many_lights</code> 示例的性能随着时间推移而下降，因为更多光源进入视图并被提取到渲染世界，而视图外的光源却没有被移除。<p>本 PR 通过两种方式修复了此问题：<ol><li><p>光源提取现在正确地考虑了保留的渲染世界，遵循了网格（mesh）等其他对象使用的模式。从前一帧以来未发生变化的光源不会被重新提取，而是跨帧保留。</p><li><p>光源和其他可聚类对象（clusterable objects）的可见性现在由确定网格可见性的同一系统来确定。<code>GlobalVisibleClusterableObjects</code> 这个侧表（side table）已被移除。为了实现这一点，我将现有的 <code>Sphere</code> 类型转换为一个组件，可以替代 <code>Aabb</code> 添加到那些使用球体而非轴对齐包围盒（AABB）进行视锥剔除（frustum culling）的实体上。这对于可见性代码的添加出人意料地简单，因为它已经使用球体进行快速剔除（quick rejection）。</p></ol><p>除了简化代码外，本 PR 将 <code>many_lights</code> 的帧率从大约 30 FPS 提升到大约 100 FPS（在我的 Ryzen 9 8945HS 上），使其从 CPU 瓶颈变为明显的 GPU 瓶颈。之前的性能分析主要由 <code>extract_lights</code> 和 <code>prepare_lights</code> 主导。保留模式将 <code>extract_lights</code> 的时间从 8.9 毫秒加上 8.0 毫秒的命令处理时间降低到 0.4 毫秒，而 <code>prepare_lights</code> 的时间降低到大约每帧 1.2 毫秒（如果应用我的额外 PR #22846，将进一步降低到 0.9 毫秒）。<p><code>main</code> 分支上的 <code>many_lights</code>: <img alt="Screenshot 2026-02-07 101916" height=1800 src=https://github.com/user-attachments/assets/18ec7190-cb5b-41c8-8c6f-75ef13d683fb width=2756><p>本 PR 中的 <code>many_lights</code>: <img alt="Screenshot 2026-02-07 101210" height=1800 src=https://github.com/user-attachments/assets/daf3d93f-efcc-4a2e-b728-da1f32e6ad85 width=2756><p><code>main</code> 分支和本 PR 中 <code>many_lights</code> 的 <code>prepare_lights</code> 对比: <img alt="Screenshot 2026-02-07 101234" height=1800 src=https://github.com/user-attachments/assets/c8c63685-a3df-4351-a7f3-d74fc40d505a width=2756><p><code>main</code> 分支和本 PR 中 <code>many_lights</code> 的 <code>extract_lights</code> 对比: <img alt="Screenshot 2026-02-07 101248" height=1800 src=https://github.com/user-attachments/assets/68eb1618-a856-40eb-94bc-91f215d1dc4e width=2756><h2 id=gai-pull-request-de-ji-shu-fen-xi>该 Pull Request 的技术分析</h2><p>这个 PR 解决了一个在渲染世界切换到保留模式后引入的性能回归问题。根本原因在于光照系统的提取逻辑没有完全适配新的保留模式架构，导致不可见光源的组件没有被及时清理，从而造成内存泄漏和性能下降。<h3 id=wen-ti-yu-bei-jing>问题与背景</h3><p>在 Bevy 的渲染架构中，渲染世界是一个独立的世界，用于存放实际参与渲染的实体和组件。为了优化性能，Bevy 实现了“保留模式”渲染，这意味着渲染世界中的实体和组件会跨帧保留，只有当它们对应的主世界（main world）对象发生变化或被移除时才进行更新或清理。<p>光照系统有一个重要的设计约束：任何在视图中不可见的光源都不应存在于渲染世界中。然而，在切换到保留模式后，光源提取系统 <code>extract_lights</code> 没有正确实现这一点。具体来说：<ol><li>光源提取仍然使用一个全局的 <code>GlobalVisibleClusterableObjects</code> 资源来追踪所有可见的光源，但这个资源的更新逻辑可能没有与新的保留模式完全同步。<li>当光源变得不可见时，其对应的渲染世界组件（如 <code>ExtractedPointLight</code>）没有被移除。<li>这导致了 <code>many_lights</code> 示例中，随着光源进入和离开视图，渲染世界中的光源数量只增不减，最终造成性能严重下降。</ol><p>问题的影响是显著的：在 <code>main</code> 分支上，<code>many_lights</code> 示例的帧率大约为 30 FPS，并且是 CPU 瓶颈。性能分析显示，<code>extract_lights</code> 和 <code>prepare_lights</code> 系统占据了大部分时间。<h3 id=jie-jue-fang-an>解决方案</h3><p>PR 作者采用了双管齐下的方法来解决这个问题：<p><strong>1. 使光源提取系统变为保留模式</strong><p>这是通过修改 <code>extract_lights</code> 系统来实现的，使其遵循与其他保留模式系统（如网格提取）相同的模式：<ul><li>只处理自上一帧以来发生变化的组件（通过 <code>Changed</code> 查询）。<li>当光源在主世界中被移除时，相应地移除渲染世界中的组件。<li>引入辅助函数 <code>remove_components</code> 来安全地处理组件移除，同时考虑同一帧内组件被移除又添加的边缘情况。</ul><p><strong>2. 统一可见性判定系统，移除 <code>GlobalVisibleClusterableObjects</code></strong><p>之前，光源的可见性是通过一个独立的聚类（clustering）系统来判定的，并将结果存储在 <code>GlobalVisibleClusterableObjects</code> 资源中。这个 PR 移除了这个资源，改为使用与网格相同的可见性系统。<p>为了实现这一点，作者进行了以下关键修改：<ul><li>将 <code>Sphere</code> 结构体升级为一个组件（<code>#[derive(Component, ...)]</code>），并添加了详细的文档。<li>为点光源（<code>PointLight</code>）和聚光灯（<code>SpotLight</code>）添加了系统（<code>update_point_light_bounding_spheres</code> 和 <code>update_spot_light_bounding_spheres</code>），当光源的 <code>range</code> 或变换（<code>GlobalTransform</code>）发生变化时，更新其关联的 <code>Sphere</code> 组件。<li>修改了 <code>check_visibility</code> 系统，使其能够同时处理 <code>Aabb</code> 和 <code>Sphere</code> 组件，进行视锥剔除。<li>移除了聚类系统 <code>assign_objects_to_clusters</code> 中对 <code>GlobalVisibleClusterableObjects</code> 的依赖，现在它直接处理所有光源，而不需要先经过可见性筛选。<li>相应地，更新了 <code>update_point_light_frusta</code> 和 <code>update_spot_light_frusta</code> 系统，使其依赖 <code>ViewVisibility</code> 组件而不是 <code>GlobalVisibleClusterableObjects</code> 资源来判断是否需要更新光源的视锥体。</ul><h3 id=shi-xian-xi-jie-yu-dai-ma-fen-xi>实现细节与代码分析</h3><p>这个 PR 的修改涉及多个文件，但核心逻辑集中在几个关键系统中。以下是一些重要的代码变更：<p><strong><code>Sphere</code> 组件化 (crates/bevy_camera/src/primitives.rs):</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component</span><span style=color:#61676ccc>,</span><span> Clone</span><span style=color:#61676ccc>,</span><span> Copy</span><span style=color:#61676ccc>,</span><span> Debug</span><span style=color:#61676ccc>,</span><span> Default</span><span style=color:#61676ccc>,</span><span> Reflect)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>reflect</span><span>(Component</span><span style=color:#61676ccc>,</span><span> Clone</span><span style=color:#61676ccc>,</span><span> Debug</span><span style=color:#61676ccc>,</span><span> Default)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>Sphere </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>center</span><span style=color:#61676ccc>:</span><span> Vec3A,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>radius</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>,
</span><span>}
</span></code></pre><p>现在 <code>Sphere</code> 是一个组件，可以被添加到实体上。这对于点光源和聚光灯非常合适，因为它们的照明范围（range）自然可以用球体来近似。<p><strong>更新光源的包围球体 (crates/bevy_light/src/point_light.rs):</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>update_point_light_bounding_spheres</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands,
</span><span>    </span><span style=color:#ff8f40>point_lights_query</span><span style=color:#61676ccc>: </span><span>Query<
</span><span>        (Entity, </span><span style=color:#ed9366>&</span><span>PointLight, </span><span style=color:#ed9366>&</span><span>GlobalTransform),
</span><span>        Or<(Changed&LTPointLight>, Changed&LTGlobalTransform>)>,
</span><span>    >,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>for </span><span>(point_light_entity</span><span style=color:#61676ccc>,</span><span> point_light</span><span style=color:#61676ccc>,</span><span> global_transform) </span><span style=color:#ed9366>in &</span><span>point_lights_query {
</span><span>        commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(point_light_entity)</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(Sphere {
</span><span>            center</span><span style=color:#61676ccc>:</span><span> global_transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>translation_vec3a</span><span>()</span><span style=color:#61676ccc>,
</span><span>            radius</span><span style=color:#61676ccc>:</span><span> point_light</span><span style=color:#ed9366>.</span><span>range</span><span style=color:#61676ccc>,
</span><span>        })</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><p>这个系统监听点光源或其变换的变化，并更新（或插入）对应的 <code>Sphere</code> 组件。球体的中心是光源的世界位置，半径是光源的 <code>range</code>。聚光灯也有类似的系统。<p><strong>修改视锥剔除以支持 <code>Sphere</code> (crates/bevy_camera/src/visibility/mod.rs):</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 在 check_visibility 系统中
</span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>no_frustum_culling </span><span style=color:#ed9366>&& !</span><span>no_cpu_culling_camera </span><span style=color:#ed9366>&& !</span><span>no_cpu_culling_entity {
</span><span>    </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(model_aabb) </span><span style=color:#ed9366>=</span><span> maybe_model_aabb {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ... 原有的 AABB 剔除逻辑
</span><span>    } </span><span style=color:#fa6e32>else if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(model_sphere) </span><span style=color:#ed9366>=</span><span> maybe_model_sphere
</span><span>        </span><span style=color:#ed9366>&& !</span><span>frustum</span><span style=color:#ed9366>.</span><span style=color:#f07171>intersects_sphere</span><span>(model_sphere</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>false</span><span>)
</span><span>    {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// 新增：对 Sphere 组件进行球体剔除
</span><span>        </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><p>现在，如果一个实体有 <code>Sphere</code> 组件但没有 <code>Aabb</code> 组件，系统会使用球体进行快速的视锥剔除。<p><strong>重构光源提取系统 (crates/bevy_pbr/src/render/light.rs):</strong> 这是改动最大的部分。<code>extract_lights</code> 系统被重写以支持保留模式：<ul><li>查询现在使用 <code>Or&LTChanged<...>></code> 过滤器，只处理发生变化的组件。<li>移除了对 <code>GlobalVisibleClusterableObjects</code> 资源的依赖。<li>添加了逻辑来移除那些光源组件已被删除的实体的渲染组件。</ul><p>一个关键的辅助函数是 <code>remove_components</code>，它安全地处理了组件移除：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>fn </span><span style=color:#f29718>remove_components</span><span>&LTMC, RWC>(
</span><span>    </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> Commands,
</span><span>    </span><span style=color:#ff8f40>mapper</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>Query&LTRenderEntity>,
</span><span>    </span><span style=color:#ff8f40>removed_components</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span>RemovedComponents&LTMC>,
</span><span>    </span><span style=color:#ff8f40>seen_entities</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>MainEntityHashSet,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>for</span><span> main_entity </span><span style=color:#ed9366>in</span><span> removed_components</span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>() {
</span><span>        </span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>seen_entities</span><span style=color:#ed9366>.</span><span style=color:#f07171>contains</span><span>(</span><span style=color:#ed9366>&</span><span>MainEntity</span><span style=color:#ed9366>::</span><span>from(main_entity))
</span><span>            </span><span style=color:#ed9366>&& </span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(render_entity) </span><span style=color:#ed9366>=</span><span> mapper</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(main_entity)
</span><span>            </span><span style=color:#ed9366>&& </span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(</span><span style=color:#fa6e32>mut</span><span> entity_commands) </span><span style=color:#ed9366>=</span><span> commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_entity</span><span>(render_entity)
</span><span>        {
</span><span>            entity_commands</span><span style=color:#ed9366>.</span><span>remove</span><span style=color:#ed9366>::</span><span>&LTRWC>()</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre><p>这个函数检查一个主世界组件是否被移除，并且在本帧的提取过程中没有被重新处理（通过 <code>seen_entities</code> 集合），然后从对应的渲染实体中移除相应的渲染世界组件。<p><strong>移除 <code>GlobalVisibleClusterableObjects</code> 资源:</strong> 这个资源从多个地方被移除：<code>LightPlugin</code> 不再初始化它，聚类系统 <code>assign_objects_to_clusters</code> 不再使用它，光照提取系统也不再提取它。这简化了整体的数据流。<h3 id=ji-shu-dong-cha-yu-xing-neng-ying-xiang>技术洞察与性能影响</h3><p>这个 PR 展示了几个重要的工程原则：<ol><li><p><strong>保留模式的一致性</strong>: 当架构转向保留模式时，所有系统都需要适配。光源提取系统之前是“半保留”状态，现在通过只处理变更和正确清理组件，实现了完全保留。</p><li><p><strong>统一的可见性管道</strong>: 将光源的可见性判定合并到通用的可见性系统中，减少了代码重复和潜在的不一致。这也利用了现有的优化，如视锥剔除的层级结构。</p><li><p><strong>性能提升的来源</strong>: 主要的性能提升来自两个方面：</p> <ul><li><strong>减少每帧提取的开销</strong>: 通过只处理变更的光源，<code>extract_lights</code> 系统的执行时间从 ~16.9 毫秒（8.9 毫秒提取 + 8.0 毫秒命令处理）降低到 0.4 毫秒。<li><strong>减少渲染世界的实体数量</strong>: 通过及时清理不可见光源的组件，渲染世界中的光源数量保持在最低必要水平，减轻了后续渲染阶段（如 <code>prepare_lights</code>）的负担。</ul><li><p><strong>简化与维护性</strong>: 移除 <code>GlobalVisibleClusterableObjects</code> 资源简化了数据流，使得光照系统的行为更容易理解。现在，光源的可见性完全由标准的 <code>ViewVisibility</code> 组件驱动，与其他实体类型保持一致。</p></ol><h3 id=qian-zai-zhu-yi-shi-xiang>潜在注意事项</h3><ol><li><p><strong>包围球体的准确性</strong>: 对于聚光灯，使用一个以光源位置为中心、以 <code>range</code> 为半径的球体进行剔除可能不够紧密（over-approximation），可能导致一些实际上不可见的聚光灯被包含进来。但这是一个合理的性能/精度权衡，因为球体剔除非常快速。</p><li><p><strong>组件添加顺序</strong>: 新的 <code>update_point_light_bounding_spheres</code> 系统需要在可见性系统之前运行，以确保 <code>Sphere</code> 组件在视锥剔除时可用。这通过将其添加到 <code>SimulationLightSystems::UpdateBounds</code> 系统集并在 <code>VisibilitySystems::UpdateFrusta</code> 之前运行来保证。</p><li><p><strong>向后兼容性</strong>: 由于 <code>Sphere</code> 现在是一个组件，并且被添加到点光源和聚光灯实体上，这可能影响那些依赖于实体组件布局的用户代码。不过，这应该是一个内部实现细节，对大多数用户透明。</p></ol><h2 id=ke-shi-hua-biao-shi>可视化表示</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TB
</span><span>    subgraph "主世界 (Main World)"
</span><span>        PL[PointLight] --> UBS[update_*_bounding_spheres]
</span><span>        SL[SpotLight] --> UBS
</span><span>        UBS --> SC[Sphere Component]
</span><span>        SC --> VS[Visibility System]
</span><span>        VS --> VV[ViewVisibility Component]
</span><span>    end
</span><span>
</span><span>    subgraph "渲染世界 (Render World)"
</span><span>        EL[extract_lights] --> RP[Retained PointLights]
</span><span>        VV --> EL
</span><span>        RC[remove_components] --> EL
</span><span>        RP --> PLR[Prepare Lights & Rendering]
</span><span>    end
</span><span>
</span><span>    VS --> CL[Cluster System assign_objects_to_clusters]
</span><span>    CL --> CLR[Clusters Resource]
</span></code></pre><h2 id=guan-jian-wen-jian-bian-geng>关键文件变更</h2><h3 id=crates-bevy-pbr-src-render-light-rs-201-126><code>crates/bevy_pbr/src/render/light.rs</code> (+201/-126)</h3><p>这是本次修改的核心文件，重写了 <code>extract_lights</code> 系统以实现保留模式。<ul><li><strong>变更要点</strong>: <ol><li>修改了所有光源查询，添加了 <code>Or&LTChanged<...>></code> 过滤器，只提取发生变化的组件。<li>移除了对 <code>GlobalVisibleClusterableObjects</code> 资源的依赖。<li>添加了 <code>remove_components</code> 辅助函数，用于在光源组件被移除时清理渲染世界中的对应组件。<li>引入了 <code>seen_*_main_entities</code> 集合来跟踪本帧已处理的光源，防止在同一帧内被移除又添加的光源被错误地清理。</ol></ul><p><strong>关键代码片段</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 在 extract_lights 系统中，点光源查询现在包含 Changed 过滤器
</span><span style=color:#fa6e32>let</span><span> point_lights</span><span style=color:#61676ccc>: </span><span>Extract<
</span><span>    Query<
</span><span>        (
</span><span>            Entity,
</span><span>            RenderEntity,
</span><span>            </span><span style=color:#ed9366>&</span><span>PointLight,
</span><span>            </span><span style=color:#ed9366>&</span><span>CubemapVisibleEntities,
</span><span>            </span><span style=color:#ed9366>&</span><span>GlobalTransform,
</span><span>            </span><span style=color:#ed9366>&</span><span>ViewVisibility,
</span><span>            </span><span style=color:#ed9366>&</span><span>CubemapFrusta,
</span><span>            </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#ed9366>&</span><span>VolumetricLight>,
</span><span>        ),
</span><span>        Or<(
</span><span>            Changed&LTPointLight>,
</span><span>            Changed&LTCubemapVisibleEntities>,
</span><span>            Changed&LTGlobalTransform>,
</span><span>            Changed&LTViewVisibility>,
</span><span>            Changed&LTCubemapFrusta>,
</span><span>            Changed&LTVolumetricLight>,
</span><span>        )>,
</span><span>    >,
</span><span>> </span><span style=color:#ed9366>= </span><span style=color:#abb0b6;font-style:italic>/* ... */</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-light-src-cluster-assign-rs-32-49><code>crates/bevy_light/src/cluster/assign.rs</code> (+32/-49)</h3><p>修改了 <code>assign_objects_to_clusters</code> 系统，移除了对 <code>GlobalVisibleClusterableObjects</code> 的依赖。<ul><li><strong>变更要点</strong>: <ol><li>移除了 <code>global_clusterable_objects</code> 参数。<li>不再过滤光源的 <code>ViewVisibility</code>，而是处理所有光源，因为可见性现在由通用的可见性系统处理。<li>不再将可见光源插入 <code>GlobalVisibleClusterableObjects</code>。</ol></ul><p><strong>关键代码片段</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 之前:
</span><span>clusterable_objects</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend</span><span>(
</span><span>    point_lights_query
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>filter</span><span>(|(..</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>visibility</span><span>)| visibility</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>())  </span><span style=color:#abb0b6;font-style:italic>// 过滤可见光源
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(</span><span style=color:#abb0b6;font-style:italic>/* ... */</span><span>)
</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 之后:
</span><span>clusterable_objects</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend</span><span>(point_lights_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(</span><span style=color:#abb0b6;font-style:italic>/* ... */</span><span>))</span><span style=color:#61676ccc>;  </span><span style=color:#abb0b6;font-style:italic>// 处理所有光源
</span></code></pre><h3 id=crates-bevy-light-src-cluster-mod-rs-32-23><code>crates/bevy_light/src/cluster/mod.rs</code> (+32/-23)</h3><p>移除了 <code>GlobalVisibleClusterableObjects</code> 资源，并添加了一个新系统来为光探针（light probe）和贴花（decal）添加 AABB。<ul><li><strong>变更要点</strong>: <ol><li>删除了 <code>GlobalVisibleClusterableObjects</code> 结构体及其相关实现。<li>添加了 <code>add_light_probe_and_decal_aabbs</code> 系统，为光探针和聚类贴花添加 AABB 组件，以便它们也能通过通用的可见性系统进行剔除。</ol></ul><p><strong>关键代码片段</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>add_light_probe_and_decal_aabbs</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands,
</span><span>    </span><span style=color:#ff8f40>light_probes_and_decals_query</span><span style=color:#61676ccc>: </span><span>Query<
</span><span>        Entity,
</span><span>        (Or<(With&LTClusteredDecal>, With&LTLightProbe>)>, Without&LTAabb>),
</span><span>    >,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>for</span><span> entity </span><span style=color:#ed9366>in &</span><span>light_probes_and_decals_query {
</span><span>        commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(entity)</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(Aabb {
</span><span>            center</span><span style=color:#61676ccc>: </span><span>Vec3A</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ZERO</span><span style=color:#61676ccc>,
</span><span>            half_extents</span><span style=color:#61676ccc>: </span><span>Vec3A</span><span style=color:#ed9366>::</span><span>splat(</span><span style=color:#ff8f40>0.5</span><span>)</span><span style=color:#61676ccc>,
</span><span>        })</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><h3 id=crates-bevy-light-src-point-light-rs-33-20><code>crates/bevy_light/src/point_light.rs</code> (+33/-20)</h3><p>添加了 <code>update_point_light_bounding_spheres</code> 系统，并修改了 <code>update_point_light_frusta</code> 系统。<ul><li><strong>变更要点</strong>: <ol><li>添加了 <code>update_point_light_bounding_spheres</code> 系统，用于更新点光源的 <code>Sphere</code> 组件。<li>修改了 <code>update_point_light_frusta</code> 系统，使其依赖 <code>ViewVisibility</code> 而不是 <code>GlobalVisibleClusterableObjects</code>。</ol></ul><p><strong>关键代码片段</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>update_point_light_frusta</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>views</span><span style=color:#61676ccc>: </span><span>Query<
</span><span>        (
</span><span>            </span><span style=color:#ed9366>&</span><span>GlobalTransform,
</span><span>            </span><span style=color:#ed9366>&</span><span>PointLight,
</span><span>            </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> CubemapFrusta,
</span><span>            </span><span style=color:#ed9366>&</span><span>ViewVisibility,  // 使用 ViewVisibility 组件
</span><span>        ),
</span><span>        Or<(
</span><span>            Changed&LTGlobalTransform>,
</span><span>            Changed&LTPointLight>,
</span><span>            Changed&LTViewVisibility>,  // 当可见性变化时也更新
</span><span>        )>,
</span><span>    >,
</span><span>) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>    </span><span style=color:#fa6e32>for </span><span>(transform</span><span style=color:#61676ccc>,</span><span> point_light</span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>mut</span><span> cubemap_frusta</span><span style=color:#61676ccc>,</span><span> view_visibility) </span><span style=color:#ed9366>in &</span><span style=color:#fa6e32>mut</span><span> views {
</span><span>        </span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>point_light</span><span style=color:#ed9366>.</span><span>shadow_maps_enabled </span><span style=color:#ed9366>|| !</span><span>view_visibility</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>() {  </span><span style=color:#abb0b6;font-style:italic>// 检查 ViewVisibility
</span><span>            </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>    }
</span><span>}
</span></code></pre><h3 id=crates-bevy-camera-src-visibility-mod-rs-22-17><code>crates/bevy_camera/src/visibility/mod.rs</code> (+22/-17)</h3><p>修改了 <code>check_visibility</code> 系统，使其能够处理 <code>Sphere</code> 组件。<ul><li><strong>变更要点</strong>: <ol><li>查询中现在包含 <code>Option<&Sphere></code>。<li>在视锥剔除逻辑中，如果实体有 <code>Sphere</code> 组件但没有 <code>Aabb</code> 组件，则使用球体进行剔除。</ol></ul><p><strong>关键代码片段</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>check_visibility</span><span>(
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#ed9366>&</span><span>Aabb>,
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#ed9366>&</span><span>Sphere>,  </span><span style=color:#abb0b6;font-style:italic>// 新增参数
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>    </span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>no_frustum_culling </span><span style=color:#ed9366>&& !</span><span>no_cpu_culling_camera </span><span style=color:#ed9366>&& !</span><span>no_cpu_culling_entity {
</span><span>        </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(model_aabb) </span><span style=color:#ed9366>=</span><span> maybe_model_aabb {
</span><span>            </span><span style=color:#abb0b6;font-style:italic>// 原有的 AABB 剔除逻辑
</span><span>        } </span><span style=color:#fa6e32>else if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(model_sphere) </span><span style=color:#ed9366>=</span><span> maybe_model_sphere
</span><span>            </span><span style=color:#ed9366>&& !</span><span>frustum</span><span style=color:#ed9366>.</span><span style=color:#f07171>intersects_sphere</span><span>(model_sphere</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>false</span><span>)
</span><span>        {
</span><span>            </span><span style=color:#abb0b6;font-style:italic>// 新增的 Sphere 剔除逻辑
</span><span>            </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>    }
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>}
</span></code></pre><h2 id=kuo-zhan-yue-du>扩展阅读</h2><ol><li><strong>Bevy 保留模式渲染</strong>: <a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/architecture/ target=_blank>Bevy 官方文档</a>中关于 ECS 和渲染管道的部分。<li><strong>视锥剔除算法</strong>: 《Real-Time Rendering, 4th Edition》第 19 章，详细介绍了各种剔除技术。<li><strong>光源聚类技术</strong>: 关于延迟渲染和正向+（Forward+）渲染中光源聚类的经典论文，如 “Forward+: Bringing Deferred Lighting to the Next Level”。<li><strong>Filament 渲染引擎</strong>: <a rel="noopener nofollow noreferrer" href=https://google.github.io/filament/Filament.html target=_blank>Filament 文档</a>中关于物理光源单位（luminous power 和 luminous intensity）的部分，Bevy 的光照计算参考了这些公式。</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_22857.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>