<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22857 Make light extraction retained, and clean up lights that became newly invisible.
        
    </title><meta content="#22857 Make light extraction retained, and clean up lights that became newly invisible." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-09</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-02/pr-22857-zh-cn-20260209>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Make light extraction retained, and clean up lights that became newly invisible.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22857<li><strong>Author</strong>: pcwalton<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, C-Performance, P-Regression<li><strong>Created</strong>: 2026-02-07T18:21:08Z<li><strong>Merged</strong>: 2026-02-09T07:36:06Z<li><strong>Merged By</strong>: superdump</ul><h2 id=description-translation>Description Translation</h2><p>The lighting code is designed such that lights that aren’t visible in any view shouldn’t exist in the render world. Unfortunately, when the render world was made retained, the light extraction code was never fully updated to clean up components corresponding to lights that became invisible. So Bevy is currently not enforcing that invariant. This causes <code>many_lights</code> to become slower over time as more lights enter the view and are extracted to the render world, while lights outside the view aren’t removed.<p>This PR fixes the issue in two ways:<ol><li><p>Light extraction now properly accounts for the retained render world, following the patterns that other objects like meshes use. Lights that haven’t changed from the previous frame aren’t re-extracted and are retained from frame to frame.</p><li><p>Visibility of lights and other clustered objects is now determined by the same system that determines visibility of meshes. The <code>GlobalVisibleClusterableObjects</code> side table is gone. To do this, I made the existing <code>Sphere</code> type into a component that can be added in lieu of <code>Aabb</code> to entities that are culled using spheres instead of AABBs. This was surprisingly straightforward to add to the visibility code, as it was already using spheres for quick rejection.</p></ol><p>In addition to being a simplification, this PR increases the FPS of <code>many_lights</code> from around 30 FPS to around 100 FPS on my Ryzen 9 8945HS, moving it from CPU bound to strongly GPU bound. The profile was dominated by <code>extract_lights</code> and <code>prepare_lights</code> before. Retained mode drops <code>extract_lights</code> time from 8.9 ms plus 8.0 ms of commands processing time to 0.4 ms, and <code>prepare_lights</code> time drops to approximately 1.2 ms per frame (which further drops to 0.9 ms with my extra PR #22846 applied).<p><code>many_lights</code> on <code>main</code>: <img alt="Screenshot 2026-02-07 101916" height=1800 src=https://github.com/user-attachments/assets/18ec7190-cb5b-41c8-8c6f-75ef13d683fb width=2756><p><code>many_lights</code> in this PR: <img alt="Screenshot 2026-02-07 101210" height=1800 src=https://github.com/user-attachments/assets/daf3d93f-efcc-4a2e-b728-da1f32e6ad85 width=2756><p>Comparison of <code>prepare_lights</code> between <code>main</code> and this PR for <code>many_lights</code>: <img alt="Screenshot 2026-02-07 101234" height=1800 src=https://github.com/user-attachments/assets/c8c63685-a3df-4351-a7f3-d74fc40d505a width=2756><p>Comparison of <code>extract_lights</code> between <code>main</code> and this PR for <code>many_lights</code>: <img alt="Screenshot 2026-02-07 101248" height=1800 src=https://github.com/user-attachments/assets/68eb1618-a856-40eb-94bc-91f215d1dc4e width=2756><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The render world in Bevy was transitioned to a retained model to improve performance by avoiding re-extraction of unchanged entities each frame. However, the light extraction system wasn’t fully updated during this transition, leaving a critical gap: lights that became invisible weren’t being cleaned up from the render world.<p>This created a performance regression where the <code>many_lights</code> example would gradually slow down over time. The problem was that as more lights entered the view frustum, they were extracted to the render world, but when they left the frustum, their corresponding components weren’t removed. This violated the design invariant that invisible lights shouldn’t exist in the render world, leading to unnecessary processing and memory usage that accumulated frame after frame.<p>The solution implemented here addresses two main issues. First, light extraction needed to be made properly retained, following the same pattern used by other render objects like meshes. Second, the system for determining light visibility needed to be unified with the existing mesh visibility system, eliminating a separate side table that tracked visible clusterable objects.<p>To achieve the second goal, the developer made a strategic observation: the existing visibility system already used spheres for quick frustum culling rejection, even though it primarily worked with AABBs. By converting the existing <code>Sphere</code> struct into a proper <code>Component</code>, lights (which are naturally bounded by spheres based on their range) could use the same visibility determination pipeline as meshes.<p>The implementation involved several coordinated changes:<ol><li><p><strong>Sphere Component</strong>: The <code>Sphere</code> struct in <code>primitives.rs</code> was converted to a component with proper documentation. This allowed lights to have bounding spheres instead of AABBs for frustum culling.</p><li><p><strong>Visibility System Updates</strong>: The <code>check_visibility</code> function was extended to handle entities with either <code>Aabb</code> or <code>Sphere</code> components. The logic already existed for sphere-based quick rejection, so this was a natural extension.</p><li><p><strong>Light Bound Updates</strong>: New systems (<code>update_point_light_bounding_spheres</code> and <code>update_spot_light_bounding_spheres</code>) were added to automatically update bounding sphere components when light properties or transforms change. These systems run in a new <code>UpdateBounds</code> system set before visibility calculations.</p><li><p><strong>Removal of GlobalVisibleClusterableObjects</strong>: The <code>GlobalVisibleClusterableObjects</code> resource was completely removed. Instead of maintaining a separate set of visible lights, the system now relies on the standard <code>ViewVisibility</code> component that’s part of the visibility system.</p><li><p><strong>Retained Light Extraction</strong>: The <code>extract_lights</code> system was refactored to work in retained mode. It now:</p> <ul><li>Only processes lights that have changed (using <code>Changed</code> filters in queries)<li>Properly removes extracted light components when lights become invisible<li>Tracks which lights were processed in the current frame to avoid incorrectly removing components when lights are removed and re-added in the same frame</ul></ol><p>The key insight in the extraction logic was that the system needed to handle component removal correctly. The developer added a helper function <code>remove_components</code> that removes render-world components when their corresponding main-world components are removed, but only if those entities weren’t already processed in the current extraction pass. This handles the edge case where a component might be removed and re-added in the same frame.<p>The performance improvements are substantial. By moving from a non-retained extraction model (where all visible lights were re-extracted every frame) to a retained model (where only changed lights are processed), extraction time dropped from ~17ms (8.9ms extraction + 8.0ms commands processing) to just 0.4ms. The <code>prepare_lights</code> system also saw significant improvements due to reduced data volume.<p>This refactoring also simplified the codebase by eliminating the <code>GlobalVisibleClusterableObjects</code> side table and unifying light visibility determination with the existing mesh visibility system. The changes maintain backward compatibility while fixing both a bug (lights not being cleaned up) and a performance regression.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TB
</span><span>    subgraph "Before PR"
</span><span>        A[Main World Lights] --> B[GlobalVisibleClusterableObjects]
</span><span>        B --> C[extract_lights processes all]
</span><span>        C --> D[Render World Lights]
</span><span>    end
</span><span>    
</span><span>    subgraph "After PR"
</span><span>        E[Main World Lights] --> F[Visibility System]
</span><span>        F --> G[ViewVisibility Component]
</span><span>        G --> H[extract_lights processes only changed]
</span><span>        H --> I[Render World Lights]
</span><span>    end
</span><span>    
</span><span>    style A fill:#e1f5fe
</span><span>    style E fill:#e1f5fe
</span><span>    style D fill:#f1f8e9
</span><span>    style I fill:#f1f8e9
</span><span>    style B fill:#ffebee
</span><span>    style F fill:#f3e5f5
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-camera-src-primitives-rs><code>crates/bevy_camera/src/primitives.rs</code></h3><p><strong>What changed</strong>: The <code>Sphere</code> struct was converted to a <code>Component</code> with proper documentation. <strong>Why</strong>: To allow entities (particularly lights) to use spheres for frustum culling instead of AABBs. <strong>Code snippet</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Clone</span><span style=color:#61676ccc>,</span><span> Debug</span><span style=color:#61676ccc>,</span><span> Default)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>Sphere </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>center</span><span style=color:#61676ccc>:</span><span> Vec3A,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>radius</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component</span><span style=color:#61676ccc>,</span><span> Clone</span><span style=color:#61676ccc>,</span><span> Copy</span><span style=color:#61676ccc>,</span><span> Debug</span><span style=color:#61676ccc>,</span><span> Default</span><span style=color:#61676ccc>,</span><span> Reflect)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>reflect</span><span>(Component</span><span style=color:#61676ccc>,</span><span> Clone</span><span style=color:#61676ccc>,</span><span> Debug</span><span style=color:#61676ccc>,</span><span> Default)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>Sphere </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>center</span><span style=color:#61676ccc>:</span><span> Vec3A,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>radius</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>,
</span><span>}
</span></code></pre><h3 id=crates-bevy-camera-src-visibility-mod-rs><code>crates/bevy_camera/src/visibility/mod.rs</code></h3><p><strong>What changed</strong>: The <code>check_visibility</code> function was extended to handle entities with <code>Sphere</code> components for frustum culling. <strong>Why</strong>: To allow lights with bounding spheres to use the same visibility determination as meshes with AABBs. <strong>Code snippet</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// After: Added support for Sphere components
</span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>no_frustum_culling </span><span style=color:#ed9366>&& !</span><span>no_cpu_culling_camera </span><span style=color:#ed9366>&& !</span><span>no_cpu_culling_entity {
</span><span>    </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(model_aabb) </span><span style=color:#ed9366>=</span><span> maybe_model_aabb {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// Existing AABB-based culling
</span><span>    } </span><span style=color:#fa6e32>else if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(model_sphere) </span><span style=color:#ed9366>=</span><span> maybe_model_sphere
</span><span>        </span><span style=color:#ed9366>&& !</span><span>frustum</span><span style=color:#ed9366>.</span><span style=color:#f07171>intersects_sphere</span><span>(model_sphere</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>false</span><span>)
</span><span>    {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// Do sphere-based frustum culling in this case
</span><span>        </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><h3 id=crates-bevy-light-src-point-light-rs><code>crates/bevy_light/src/point_light.rs</code></h3><p><strong>What changed</strong>: Added <code>update_point_light_bounding_spheres</code> system and updated <code>update_point_light_frusta</code>. <strong>Why</strong>: To automatically maintain bounding sphere components for point lights and update frusta based on visibility. <strong>Code snippet</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// New system to update bounding spheres
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>update_point_light_bounding_spheres</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands,
</span><span>    </span><span style=color:#ff8f40>point_lights_query</span><span style=color:#61676ccc>: </span><span>Query<
</span><span>        (Entity, </span><span style=color:#ed9366>&</span><span>PointLight, </span><span style=color:#ed9366>&</span><span>GlobalTransform),
</span><span>        Or<(Changed&LTPointLight>, Changed&LTGlobalTransform>)>,
</span><span>    >,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>for </span><span>(point_light_entity</span><span style=color:#61676ccc>,</span><span> point_light</span><span style=color:#61676ccc>,</span><span> global_transform) </span><span style=color:#ed9366>in &</span><span>point_lights_query {
</span><span>        commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(point_light_entity)</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(Sphere {
</span><span>            center</span><span style=color:#61676ccc>:</span><span> global_transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>translation_vec3a</span><span>()</span><span style=color:#61676ccc>,
</span><span>            radius</span><span style=color:#61676ccc>:</span><span> point_light</span><span style=color:#ed9366>.</span><span>range</span><span style=color:#61676ccc>,
</span><span>        })</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Updated frusta update to use ViewVisibility instead of GlobalVisibleClusterableObjects
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>update_point_light_frusta</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>views</span><span style=color:#61676ccc>: </span><span>Query<
</span><span>        (
</span><span>            </span><span style=color:#ed9366>&</span><span>GlobalTransform,
</span><span>            </span><span style=color:#ed9366>&</span><span>PointLight,
</span><span>            </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> CubemapFrusta,
</span><span>            </span><span style=color:#ed9366>&</span><span>ViewVisibility,
</span><span>        ),
</span><span>        Or<(
</span><span>            Changed&LTGlobalTransform>,
</span><span>            Changed&LTPointLight>,
</span><span>            Changed&LTViewVisibility>,
</span><span>        )>,
</span><span>    >,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>for </span><span>(transform</span><span style=color:#61676ccc>,</span><span> point_light</span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>mut</span><span> cubemap_frusta</span><span style=color:#61676ccc>,</span><span> view_visibility) </span><span style=color:#ed9366>in &</span><span style=color:#fa6e32>mut</span><span> views {
</span><span>        </span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>point_light</span><span style=color:#ed9366>.</span><span>shadow_maps_enabled </span><span style=color:#ed9366>|| !</span><span>view_visibility</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>() {
</span><span>            </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// Update frusta...
</span><span>    }
</span><span>}
</span></code></pre><h3 id=crates-bevy-light-src-spot-light-rs><code>crates/bevy_light/src/spot_light.rs</code></h3><p><strong>What changed</strong>: Added <code>update_spot_light_bounding_spheres</code> system with similar changes to point lights. <strong>Why</strong>: Consistency with point lights - spot lights also need bounding spheres for visibility determination. <strong>Code snippet</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>update_spot_light_bounding_spheres</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands,
</span><span>    </span><span style=color:#ff8f40>spot_lights_query</span><span style=color:#61676ccc>: </span><span>Query<
</span><span>        (Entity, </span><span style=color:#ed9366>&</span><span>SpotLight, </span><span style=color:#ed9366>&</span><span>GlobalTransform),
</span><span>        Or<(Changed&LTSpotLight>, Changed&LTGlobalTransform>)>,
</span><span>    >,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>for </span><span>(spot_light_entity</span><span style=color:#61676ccc>,</span><span> spot_light</span><span style=color:#61676ccc>,</span><span> global_transform) </span><span style=color:#ed9366>in &</span><span>spot_lights_query {
</span><span>        commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(spot_light_entity)</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(Sphere {
</span><span>            center</span><span style=color:#61676ccc>:</span><span> global_transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>translation_vec3a</span><span>()</span><span style=color:#61676ccc>,
</span><span>            radius</span><span style=color:#61676ccc>:</span><span> spot_light</span><span style=color:#ed9366>.</span><span>range</span><span style=color:#61676ccc>,
</span><span>        })</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><h3 id=crates-bevy-pbr-src-render-light-rs><code>crates/bevy_pbr/src/render/light.rs</code></h3><p><strong>What changed</strong>: Complete refactor of <code>extract_lights</code> to work in retained mode with proper cleanup. <strong>Why</strong>: To fix the performance regression and ensure invisible lights are removed from render world. <strong>Key changes</strong>:<ol><li>Uses <code>Changed</code> filters to only process modified lights<li>Tracks processed entities to avoid incorrect removal<li>Adds helper function to clean up components when lights are removed</ol><p><strong>Code snippet</strong> (extract logic for point lights):<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Now using Changed filters
</span><span style=color:#fa6e32>let</span><span> point_lights </span><span style=color:#ed9366>= </span><span>Extract<
</span><span>    Query<
</span><span>        (
</span><span>            Entity,
</span><span>            RenderEntity,
</span><span>            </span><span style=color:#ed9366>&</span><span>PointLight,
</span><span>            </span><span style=color:#ed9366>&</span><span>CubemapVisibleEntities,
</span><span>            </span><span style=color:#ed9366>&</span><span>GlobalTransform,
</span><span>            </span><span style=color:#ed9366>&</span><span>ViewVisibility,
</span><span>            </span><span style=color:#ed9366>&</span><span>CubemapFrusta,
</span><span>            </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#ed9366>&</span><span>VolumetricLight>,
</span><span>        ),
</span><span>        Or<(
</span><span>            Changed&LTPointLight>,
</span><span>            Changed&LTCubemapVisibleEntities>,
</span><span>            Changed&LTGlobalTransform>,
</span><span>            Changed&LTViewVisibility>,
</span><span>            Changed&LTCubemapFrusta>,
</span><span>            Changed&LTVolumetricLight>,
</span><span>        )>,
</span><span>    >,
</span><span>></span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Helper function for component removal
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>remove_components</span><span>&LTMC, RWC>(
</span><span>    </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> Commands,
</span><span>    </span><span style=color:#ff8f40>mapper</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>Query&LTRenderEntity>,
</span><span>    </span><span style=color:#ff8f40>removed_components</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span>RemovedComponents&LTMC>,
</span><span>    </span><span style=color:#ff8f40>seen_entities</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>MainEntityHashSet,
</span><span>) </span><span style=color:#fa6e32>where
</span><span>    MC</span><span style=color:#61676ccc>:</span><span> Component,
</span><span>    RWC</span><span style=color:#61676ccc>:</span><span> Component,
</span><span>{
</span><span>    </span><span style=color:#fa6e32>for</span><span> main_entity </span><span style=color:#ed9366>in</span><span> removed_components</span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>() {
</span><span>        </span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>seen_entities</span><span style=color:#ed9366>.</span><span style=color:#f07171>contains</span><span>(</span><span style=color:#ed9366>&</span><span>MainEntity</span><span style=color:#ed9366>::</span><span>from(main_entity))
</span><span>            </span><span style=color:#ed9366>&& </span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(render_entity) </span><span style=color:#ed9366>=</span><span> mapper</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(main_entity)
</span><span>            </span><span style=color:#ed9366>&& </span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(</span><span style=color:#fa6e32>mut</span><span> entity_commands) </span><span style=color:#ed9366>=</span><span> commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_entity</span><span>(render_entity)
</span><span>        {
</span><span>            entity_commands</span><span style=color:#ed9366>.</span><span>remove</span><span style=color:#ed9366>::</span><span>&LTRWC>()</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre><h3 id=crates-bevy-light-src-cluster-mod-rs><code>crates/bevy_light/src/cluster/mod.rs</code></h3><p><strong>What changed</strong>: Removed <code>GlobalVisibleClusterableObjects</code> resource and added system to add AABBs to light probes and decals. <strong>Why</strong>: To eliminate the side table and use standard visibility system for all clustered objects. <strong>Code snippet</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Resource removed entirely
</span><span style=color:#abb0b6;font-style:italic>// Previously: #[derive(Resource, Default)]
</span><span style=color:#abb0b6;font-style:italic>// pub struct GlobalVisibleClusterableObjects {
</span><span style=color:#abb0b6;font-style:italic>//     pub(crate) entities: HashSet&LTEntity>,
</span><span style=color:#abb0b6;font-style:italic>// }
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// New system to ensure light probes and decals have AABBs for visibility
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>add_light_probe_and_decal_aabbs</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands,
</span><span>    </span><span style=color:#ff8f40>light_probes_and_decals_query</span><span style=color:#61676ccc>: </span><span>Query<
</span><span>        Entity,
</span><span>        (Or<(With&LTClusteredDecal>, With&LTLightProbe>)>, Without&LTAabb>),
</span><span>    >,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>for</span><span> entity </span><span style=color:#ed9366>in &</span><span>light_probes_and_decals_query {
</span><span>        commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(entity)</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(Aabb {
</span><span>            center</span><span style=color:#61676ccc>: </span><span>Vec3A</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ZERO</span><span style=color:#61676ccc>,
</span><span>            half_extents</span><span style=color:#61676ccc>: </span><span>Vec3A</span><span style=color:#ed9366>::</span><span>splat(</span><span style=color:#ff8f40>0.5</span><span>)</span><span style=color:#61676ccc>,
</span><span>        })</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><strong>Bevy Render Architecture</strong>: Understanding Bevy’s ECS-based renderer and the retained render world pattern<li><strong>Frustum Culling Algorithms</strong>: Techniques for visibility determination in 3D graphics<li><strong>Clustered Forward/Deferred Rendering</strong>: Modern approaches to handling many lights in real-time rendering<li><strong>Component Removal Patterns in ECS</strong>: Best practices for managing component lifecycle in entity-component systems</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_22857.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>