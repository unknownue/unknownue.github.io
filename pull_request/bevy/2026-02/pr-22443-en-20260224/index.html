<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22443 Convert `MeshPipelineViewLayouts` , `MeshPipeline` and `RenderDebugOverlayPipeline` to `RenderStartup` system
        
    </title><meta content="#22443 Convert `MeshPipelineViewLayouts` , `MeshPipeline` and `RenderDebugOverlayPipeline` to `RenderStartup` system" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-24</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-02/pr-22443-zh-cn-20260224>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Convert <code>MeshPipelineViewLayouts</code> , <code>MeshPipeline</code> and <code>RenderDebugOverlayPipeline</code> to <code>RenderStartup</code> system<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22443<li><strong>Author</strong>: Zeophlite<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, C-Code-Quality, S-Ready-For-Final-Review<li><strong>Created</strong>: 2026-01-09T00:39:27Z<li><strong>Merged</strong>: 2026-02-24T19:01:25Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Convert <code>MeshPipelineViewLayouts</code> , <code>MeshPipeline</code> and <code>RenderDebugOverlayPipeline</code> to <code>RenderStartup</code> system</ul><h2 id=solution>Solution</h2><ul><li>Do the thing</ul><h2 id=testing>Testing</h2><ul><li>Ran <code>animated_mesh</code> example</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a code quality improvement in Bevy’s rendering system by converting several critical resources from <code>FromWorld</code> initialization to explicit <code>RenderStartup</code> systems. The core issue was that these resources were being initialized implicitly through <code>init_resource()</code>, which uses the <code>FromWorld</code> trait. This approach can lead to initialization order issues and makes dependencies less explicit.<p>The developer needed to ensure proper initialization order for rendering resources that depend on other systems. Resources like <code>MeshPipelineViewLayouts</code> and <code>MeshPipeline</code> serve as foundational building blocks for many other rendering components, so their initialization must complete before dependent systems can run. The previous implementation used <code>FromWorld</code>, which initializes resources when they’re first accessed, potentially causing race conditions or initialization-order bugs in complex rendering setups.<p>The solution converts three key resources to explicit initialization systems:<ol><li><code>MeshPipelineViewLayouts</code> - Generates all possible view layout combinations for mesh rendering<li><code>MeshPipeline</code> - The main mesh rendering pipeline configuration<li><code>RenderDebugOverlayPipeline</code> - The debug overlay rendering pipeline</ol><p>The implementation introduces a new <code>MeshPipelineSet</code> system set to coordinate initialization order. This set contains the systems that initialize <code>MeshPipelineViewLayouts</code> and <code>MeshPipeline</code>, establishing them as foundational dependencies. Other rendering systems that depend on these resources are then explicitly scheduled to run after <code>MeshPipelineSet</code> using <code>.after(MeshPipelineSet)</code> constraints.<p>A key technical insight is that by moving from <code>FromWorld</code> to explicit systems, we gain better control over initialization order and make dependencies more transparent. The <code>FromWorld</code> approach can lead to hidden initialization dependencies where resources are initialized on-demand, potentially causing issues in multi-threaded contexts. Explicit systems allow the scheduler to understand and enforce proper ordering.<p>The changes required converting <code>FromWorld</code> implementations into regular systems that take resources as parameters and insert the initialized resource into the world. For example, the <code>init_mesh_pipeline</code> function now explicitly depends on <code>RenderDevice</code>, <code>RenderAdapter</code>, <code>MeshPipelineViewLayouts</code>, and <code>AssetServer</code>, making all its dependencies clear from the function signature.<p>This refactoring improves code maintainability by making initialization sequences explicit rather than implicit. It also helps prevent subtle bugs that can occur when resources are initialized in different orders in different contexts. The change is particularly valuable for the rendering system, where initialization order directly affects GPU resource creation and shader compilation.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[RenderStartup Schedule] --> B[MeshPipelineSet]
</span><span>    B --> C[init_mesh_pipeline_view_layouts]
</span><span>    B --> D[init_mesh_pipeline]
</span><span>    C --> E[MeshPipelineViewLayouts Resource]
</span><span>    D --> F[MeshPipeline Resource]
</span><span>    
</span><span>    A --> G[Other Rendering Systems]
</span><span>    G --> H[init_render_debug_overlay_pipeline]
</span><span>    G --> I[init_deferred_lighting_layout]
</span><span>    G --> J[init_material_pipeline]
</span><span>    G --> K[init_screen_space_reflections_pipeline]
</span><span>    G --> L[init_volumetric_fog_pipeline]
</span><span>    G --> M[init_line_gizmo_uniform_bind_group_layout]
</span><span>    
</span><span>    B -.->|after constraint| G
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-pbr-src-render-mesh-rs-40-34><code>crates/bevy_pbr/src/render/mesh.rs</code> (+40/-34)</h3><p>This file defines the new <code>MeshPipelineSet</code> system set and converts <code>MeshPipeline</code> from <code>FromWorld</code> to a <code>RenderStartup</code> system.<p><strong>Key Changes:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: FromWorld implementation
</span><span style=color:#fa6e32>impl </span><span>FromWorld </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>MeshPipeline </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>from_world</span><span>(</span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> World) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>        </span><span style=color:#fa6e32>let</span><span> shader </span><span style=color:#ed9366>= </span><span style=color:#f07171>load_embedded_asset!</span><span>(world</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"mesh.wgsl"</span><span>)</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#fa6e32>let mut</span><span> system_state</span><span style=color:#61676ccc>: </span><span>SystemState<(
</span><span>            Res&LTRenderDevice>,
</span><span>            Res&LTRenderAdapter>,
</span><span>            Res&LTMeshPipelineViewLayouts>,
</span><span>        )> </span><span style=color:#ed9366>= </span><span>SystemState</span><span style=color:#ed9366>::</span><span>new(world)</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#fa6e32>let </span><span>(render_device</span><span style=color:#61676ccc>,</span><span> render_adapter</span><span style=color:#61676ccc>,</span><span> view_layouts) </span><span style=color:#ed9366>=</span><span> system_state</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_mut</span><span>(world)</span><span style=color:#61676ccc>;
</span><span>        
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ... rest of initialization
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: RenderStartup system
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>init_mesh_pipeline</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands,
</span><span>    </span><span style=color:#ff8f40>render_device</span><span style=color:#61676ccc>: </span><span>Res&LTRenderDevice>,
</span><span>    </span><span style=color:#ff8f40>render_adapter</span><span style=color:#61676ccc>: </span><span>Res&LTRenderAdapter>,
</span><span>    </span><span style=color:#ff8f40>view_layouts</span><span style=color:#61676ccc>: </span><span>Res&LTMeshPipelineViewLayouts>,
</span><span>    </span><span style=color:#ff8f40>asset_server</span><span style=color:#61676ccc>: </span><span>Res&LTAssetServer>,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>let</span><span> shader </span><span style=color:#ed9366>= </span><span style=color:#f07171>load_embedded_asset!</span><span>(asset_server</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_ref</span><span>()</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"mesh.wgsl"</span><span>)</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... rest of initialization
</span><span>    commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_resource</span><span>(res)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p><strong>Why this matters:</strong> This change makes the dependencies explicit and allows proper ordering with other rendering systems through the <code>MeshPipelineSet</code>.<h3 id=crates-bevy-pbr-src-render-mesh-view-bindings-rs-43-43><code>crates/bevy_pbr/src/render/mesh_view_bindings.rs</code> (+43/-43)</h3><p>This file converts <code>MeshPipelineViewLayouts</code> from <code>FromWorld</code> to a <code>RenderStartup</code> system.<p><strong>Key Changes:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: FromWorld implementation
</span><span style=color:#fa6e32>impl </span><span>FromWorld </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>MeshPipelineViewLayouts </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>from_world</span><span>(</span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> World) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>        </span><span style=color:#fa6e32>let</span><span> render_device </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span>resource</span><span style=color:#ed9366>::</span><span>&LTRenderDevice>()</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#fa6e32>let</span><span> render_adapter </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span>resource</span><span style=color:#ed9366>::</span><span>&LTRenderAdapter>()</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ... layout generation
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: RenderStartup system
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>init_mesh_pipeline_view_layouts</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands,
</span><span>    </span><span style=color:#ff8f40>render_device</span><span style=color:#61676ccc>: </span><span>Res&LTRenderDevice>,
</span><span>    </span><span style=color:#ff8f40>render_adapter</span><span style=color:#61676ccc>: </span><span>Res&LTRenderAdapter>,
</span><span>) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... layout generation
</span><span>    commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_resource</span><span>(res)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p><strong>Why this matters:</strong> <code>MeshPipelineViewLayouts</code> generates all possible view layout combinations upfront, which is computationally expensive. Making this initialization explicit ensures it completes before any rendering systems try to use these layouts.<h3 id=crates-bevy-dev-tools-src-render-debug-rs-52-46><code>crates/bevy_dev_tools/src/render_debug.rs</code> (+52/-46)</h3><p>This file converts <code>RenderDebugOverlayPipeline</code> from <code>FromWorld</code> to a <code>RenderStartup</code> system and adds proper ordering constraints.<p><strong>Key Changes:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: init_resource in finish()
</span><span>render_app
</span><span>    </span><span style=color:#ed9366>.</span><span>init_resource</span><span style=color:#ed9366>::</span><span>&LTRenderDebugOverlayPipeline>()
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: RenderStartup system with ordering
</span><span>render_app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(
</span><span>    RenderStartup</span><span style=color:#61676ccc>,
</span><span>    init_render_debug_overlay_pipeline</span><span style=color:#ed9366>.</span><span style=color:#f07171>after</span><span>(MeshPipelineSet)</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// System implementation
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>init_render_debug_overlay_pipeline</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands,
</span><span>    </span><span style=color:#ff8f40>render_device</span><span style=color:#61676ccc>: </span><span>Res&LTRenderDevice>,
</span><span>    </span><span style=color:#ff8f40>mesh_view_layouts</span><span style=color:#61676ccc>: </span><span>Res&LTMeshPipelineViewLayouts>,
</span><span>    </span><span style=color:#ff8f40>asset_server</span><span style=color:#61676ccc>: </span><span>Res&LTAssetServer>,
</span><span>    </span><span style=color:#ff8f40>fullscreen_shader</span><span style=color:#61676ccc>: </span><span>Res&LTFullscreenShader>,
</span><span>) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... initialization
</span><span>    commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_resource</span><span>(res)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p><strong>Why this matters:</strong> The debug overlay pipeline depends on <code>MeshPipelineViewLayouts</code>, so it must be initialized after the mesh pipeline systems complete.<h3 id=other-modified-files>Other Modified Files:</h3><ul><li><code>crates/bevy_pbr/src/deferred/mod.rs</code> (+9/-9): Adds <code>.after(MeshPipelineSet)</code> to <code>init_deferred_lighting_layout</code><li><code>crates/bevy_pbr/src/material.rs</code> (+9/-9): Adds <code>.after(MeshPipelineSet)</code> to <code>init_material_pipeline</code><li><code>crates/bevy_pbr/src/ssr/mod.rs</code> (+6/-3): Adds <code>.after(MeshPipelineSet)</code> to <code>init_screen_space_reflections_pipeline</code><li><code>crates/bevy_pbr/src/volumetric_fog/mod.rs</code> (+9/-9): Adds <code>.after(MeshPipelineSet)</code> to <code>init_volumetric_fog_pipeline</code><li><code>crates/bevy_gizmos_render/src/lib.rs</code> (+3/-3): Adds <code>.after(MeshPipelineSet)</code> to <code>init_line_gizmo_uniform_bind_group_layout</code></ul><p><strong>Why these matter:</strong> All these systems depend on mesh pipeline resources, so they need explicit ordering constraints to ensure proper initialization sequence.<h2 id=further-reading>Further Reading</h2><ol><li><strong>Bevy Render Schedules</strong>: Understanding Bevy’s render schedule system, particularly the <code>RenderStartup</code> schedule for one-time initialization tasks<li><strong>System Ordering in ECS</strong>: How to use system sets and ordering constraints (<code>before</code>, <code>after</code>) in entity component systems<li><strong>GPU Resource Management</strong>: The importance of proper initialization order for GPU resources like pipelines, layouts, and buffers<li><strong>FromWorld vs Systems</strong>: Trade-offs between implicit resource initialization with <code>FromWorld</code> and explicit initialization with systems</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_22443.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>