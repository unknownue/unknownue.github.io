<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #23073 Panic fail-safe in real.rs during non-monotonic clock updates
        
    </title><meta content="#23073 Panic fail-safe in real.rs during non-monotonic clock updates" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-24</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-02/pr-23073-zh-cn-20260224>中文</a></div></div><div class=pr-content><h1 id=panic-fail-safe-in-real-rs-during-non-monotonic-clock-updates>Panic fail-safe in real.rs during non-monotonic clock updates</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Panic fail-safe in real.rs during non-monotonic clock updates<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/23073<li><strong>Author</strong>: fcarvajalbrown<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, P-Crash, S-Ready-For-Final-Review, A-Time, D-Straightforward<li><strong>Created</strong>: 2026-02-20T11:05:15Z<li><strong>Merged</strong>: 2026-02-24T01:50:21Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Replaces the panicking subtraction in <code>update_with_instant</code> with a saturating alternative. Although <code>Instant</code> is generally monotonic, system-level clock jitter or manual mocking in tests may occasionally cause a backward time jump. The use of <code>saturating_duration_since</code> ensures that these edge cases produce a safe <code>Duration::ZERO</code> instead of a panic.<h2 id=solution>Solution</h2><p>In <code>bevy_time/src/real.rs</code>, changed the delta calculation to <code>instant.saturating_duration_since(last_update)</code> instead of <code>instant - last_update</code>.<h2 id=testing>Testing</h2><ul><li><p>Used <code>cargo test -p bevy_time</code> to ensure that all existing unit tests are still passing.</p><li><p>Verified that all crate doctests compile and execute successfully.</p><li><p>Manually tested that passing a past <code>Instant</code> is no longer a panic.</p></ul><hr><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This pull request addresses a subtle but important edge case in Bevy’s time system. The issue occurs in the <code>Time&LTReal></code> implementation, which tracks real-world time progression for game updates. The core problem was that the code assumed system clocks would always move forward monotonically, but real-world systems don’t always guarantee this behavior.<p>The <code>update_with_instant</code> method calculates the time delta between the current instant and the last recorded update. Originally, this used the subtraction operator (<code>instant - last_update</code>), which panics if <code>instant</code> is earlier than <code>last_update</code> (i.e., if time appears to move backward). While Rust’s <code>Instant</code> type is designed to be monotonic, there are practical scenarios where this assumption breaks down.<p>System-level clock adjustments are one source of this issue. When the system clock jumps backward due to NTP synchronization or manual adjustments, <code>Instant</code> values can appear to go backward relative to each other. Another common scenario is in testing environments where developers manually mock time values for unit tests. In both cases, the panic would crash the application unexpectedly.<p>The solution implements a defensive programming approach by replacing the panicking subtraction with <code>instant.saturating_duration_since(last_update)</code>. This method returns <code>Duration::ZERO</code> when <code>instant</code> is earlier than <code>last_update</code>, effectively ignoring backward time jumps. This is a reasonable fallback because:<ol><li>A zero delta means no time progression, which maintains game logic consistency<li>It prevents crashes in edge cases while preserving normal functionality<li>The next valid forward time progression will resume normal operation</ol><p>The implementation change is minimal but significant. The <code>saturating_duration_since</code> method was introduced in Rust 1.66.0, and Bevy already requires a newer version, so there’s no compatibility concern. This approach follows the principle of being conservative in what you accept (tolerating minor time anomalies) while being precise in what you produce (properly handling valid time progression).<p>Performance impact is negligible. The <code>saturating_duration_since</code> method has essentially the same cost as the subtraction operator, with just an additional branch check. Since backward time jumps should be rare exceptions rather than common occurrences, this doesn’t affect normal performance.<p>The testing approach was comprehensive yet straightforward. Existing tests continue to pass, confirming backward compatibility. Manual testing verified the specific failure case no longer triggers a panic. This demonstrates the fix works while maintaining all existing functionality.<p>This change represents good engineering practice for handling edge cases in time-sensitive systems. It acknowledges that real-world systems have imperfections and provides a graceful degradation path rather than a hard failure. The zero-duration fallback is particularly appropriate for game engines, where missing a frame of time progression is generally preferable to crashing the entire application.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Time.update_with_instant] --> B{Is instant >= last_update?}
</span><span>    B -- Yes --> C[Calculate delta = instant - last_update]
</span><span>    B -- No --> D[Set delta = Duration::ZERO]
</span><span>    C --> E[Advance time by delta]
</span><span>    D --> E
</span><span>    E --> F[Update last_update to instant]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-time-src-real-rs><code>crates/bevy_time/src/real.rs</code></h3><p>This file contains the <code>Time&LTReal></code> implementation which manages real-time progression. The change replaces a panicking time delta calculation with a safe alternative that handles backward time jumps gracefully.<p><strong>Before:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let</span><span> delta </span><span style=color:#ed9366>=</span><span> instant </span><span style=color:#ed9366>-</span><span> last_update</span><span style=color:#61676ccc>;
</span></code></pre><p><strong>After:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let</span><span> delta </span><span style=color:#ed9366>=</span><span> instant</span><span style=color:#ed9366>.</span><span style=color:#f07171>saturating_duration_since</span><span>(last_update)</span><span style=color:#61676ccc>;
</span></code></pre><p>The change is a one-line substitution that addresses the core issue. The <code>saturating_duration_since</code> method was chosen over other alternatives like <code>checked_duration_since</code> (which returns <code>None</code>) because a zero duration is the most sensible fallback for game time progression when time appears to move backward.<h2 id=further-reading>Further Reading</h2><ol><li><strong>Rust std::time::Instant documentation</strong> - Details on <code>Instant</code> monotonic guarantees and available methods<li><strong>Rust RFC 3128: I/O Safety</strong> - Background on Rust’s approach to system interface safety<li><strong>Game Engine Architecture by Jason Gregory</strong> - Discusses time management in game engines<li><strong>Defensive Programming Techniques</strong> - General approaches for handling edge cases and system imperfections<li><strong>Bevy Time System Documentation</strong> - Context on how time is managed within the Bevy engine</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_23073.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>