<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22812 Fixes panic when using Option<Gizmos>
        
    </title><meta content="#22812 Fixes panic when using Option<Gizmos>" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-08</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2026-02/pr-22812-en-20260208>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=fixes-panic-when-using-option>Fixes panic when using Option<gizmos> <h2 id=ji-ben-xin-xi>基本信息</h2> <ul><li><strong>标题</strong>: Fixes panic when using Option<gizmos> <li><strong>PR链接</strong>: https://github.com/bevyengine/bevy/pull/22812</li> <li><strong>作者</strong>: kfc35</li> <li><strong>状态</strong>: 已合并</li> <li><strong>标签</strong>: C-Bug, A-ECS, P-Crash, S-Ready-For-Final-Review, A-Gizmos, D-Straightforward</li> <li><strong>创建时间</strong>: 2026-02-05T06:29:59Z</li> <li><strong>合并时间</strong>: 2026-02-08T19:06:58Z</li> <li><strong>合并者</strong>: alice-i-cecile</li> <h2 id=miao-shu-fan-yi>描述翻译</h2> <h1 id=mu-biao>目标</h1> <ul><li>修复 #14949<li>目前，当支持 <code>Gizmos</code> 的配置组（config group）尚未初始化时，一个 <code>Option&LTGizmos></code> 会导致 panic。当然，期望的行为是使其为 <code>None</code>。</ul> <h2 id=jie-jue-fang-an>解决方案</h2> <p><code>Gizmos</code> 是一个非 <code>#[derive]</code> 的 <code>SystemParam</code>，它要求：</p> <ul><li>其 <code>GizmoConfigGroup</code> 在 <code>GizmoConfigStore</code> 中有对应的条目<li>各种 <code>GizmoStorage</code> 资源被插入到世界中。</ul> <p>为了以对用户非侵入性的方式支持一个不会 panic 的 <code>Option&LTGizmos></code> <code>SystemParam</code>（当 Gizmo 配置组没有被有意设置时），这个 PR：</p> <ul><li>向 <code>GizmoConfigStore</code> 添加了符合人体工程学的、可失败地获取组配置的方法<li>修改 <code>Gizmos</code> 的 <code>validate_param</code> 方法，使其在无法从 <code>GizmoConfigStore</code> 中找到自身配置时返回错误<li>修改 <code>GizmoBuffer</code> 的 <code>apply</code> 方法，使其仅在对应配置组的 <code>GizmoStorage</code> 存在时才应用更改。</ul> <h2 id=ce-shi>测试</h2> <p>我修改了 2d gizmos 示例 (<code>cargo run --example 2d_gizmos</code>)，具体操作如下：</p> <ul><li>注释掉自定义 gizmo 组的初始化代码 <code>// .init_gizmo_group::&LTMyRoundGizmos>()</code><li>在 <code>draw_example_collection</code> 中的两个 <code>Gizmos</code> 系统参数上使用 <code>Option</code>（即 <code>Option&LTGizmos></code> 和 <code>Option&LTGizmos&LTMyRoundGizmos>></code>），并且在使用解包后的 <code>my_gizmos</code> 绘制内容之前，要求 <code>my_gizmos_option.is_some()</code>。<li>当尝试获取 <code>MyRoundGizmos</code> 的配置时，使用新的 <code>GizmoConfigStore</code> 方法 <code>try_config_mut</code>，并且仅在 <code>my_config_option.is_some()</code> 时继续修改其设置。</ul> <p>没有崩溃发生。默认的 Gizmos 继续被绘制，而 <code>MyRoundGizmos</code> 不被绘制。修改设置对于默认 gizmos 仍然有效，即使它们被应用于 <code>MyRoundGizmos</code> 也没有效果。示例的性能似乎没有下降。</p> <h2 id=ben-ci-prde-ji-shu-xu-shi>本次PR的技术叙事</h2> <p>这个问题源于 Bevy 引擎中 Gizmos 系统的设计。<code>Gizmos</code> 是一个用于在调试时绘制简单图形（如线条、球体）的系统参数（SystemParam）。用户可以创建自定义的 gizmo 配置组。当开发者尝试将 <code>Gizmos</code> 包装在 <code>Option</code> 中时（这是一种常见的 ECS 模式，用于处理可选功能），如果对应的 gizmo 配置组没有初始化，系统会在参数提取时发生 panic，而不是优雅地返回 <code>None</code>。</p> <p>问题的核心在于 <code>Gizmos</code> 是一个手动实现的 <code>SystemParam</code>，其验证逻辑（<code>validate_param</code>）假设它所需的配置和资源总是存在的。这与 <code>Option&LTGizmos></code> 的预期行为相矛盾，<code>Option</code> 应该优雅地处理参数不存在的情况。</p> <p>开发者采取的解决方案分为三个关键部分，以非破坏性（non-breaking）的方式增强了系统的健壮性。</p> <p>首先，在 <code>config.rs</code> 中，重构了 <code>GizmoConfigStore</code> 的 API。原有的 <code>config()</code> 和 <code>config_mut()</code> 方法在配置不存在时会 panic。PR 保持了这些方法的原有行为（因为它们被广泛使用），但将它们的内部逻辑提取出来。然后，新增了对应的 <code>get_config()</code> 和 <code>get_config_mut()</code> 方法，这些方法返回 <code>Option</code>，允许调用者安全地检查配置是否存在。这是一个清晰、向后兼容的 API 演进。</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// File: crates/bevy_gizmos/src/config.rs
</span><span style=color:#abb0b6;font-style:italic>// 修改前: `config` 方法直接 panic
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>config</span><span>&LTT</span><span style=color:#61676ccc>:</span><span> GizmoConfigGroup>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span>(</span><span style=color:#ed9366>&</span><span>GizmoConfig, </span><span style=color:#ed9366>&</span><span>T) {
</span><span>    </span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>((config</span><span style=color:#61676ccc>,</span><span> ext)) </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_config_dyn</span><span>(</span><span style=color:#ed9366>&</span><span>TypeId</span><span style=color:#ed9366>::</span><span>of</span><span style=color:#ed9366>::</span><span>&LTT>()) </span><span style=color:#fa6e32>else </span><span>{
</span><span>        </span><span style=color:#f07171>panic!</span><span>(</span><span style=color:#86b300>"Requested config {} does not exist..."</span><span>)</span><span style=color:#61676ccc>;
</span><span>    }</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... 向下转换等操作
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 修改后: `config` 方法调用新的 `get_config`，但保持 panic 行为
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>config</span><span>&LTT</span><span style=color:#61676ccc>:</span><span> GizmoConfigGroup>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span>(</span><span style=color:#ed9366>&</span><span>GizmoConfig, </span><span style=color:#ed9366>&</span><span>T) {
</span><span>    </span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(configs) </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_config</span><span>() </span><span style=color:#fa6e32>else </span><span>{ </span><span style=color:#abb0b6;font-style:italic>// 调用新方法
</span><span>        </span><span style=color:#f07171>panic!</span><span>(</span><span style=color:#86b300>"Requested config {} does not exist..."</span><span>)</span><span style=color:#61676ccc>;
</span><span>    }</span><span style=color:#61676ccc>;
</span><span>    configs
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 新增: 可失败的方法
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>get_config</span><span>&LTT</span><span style=color:#61676ccc>:</span><span> GizmoConfigGroup>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Option</span><span><(</span><span style=color:#ed9366>&</span><span>GizmoConfig, </span><span style=color:#ed9366>&</span><span>T)> {
</span><span>    </span><span style=color:#fa6e32>let </span><span>(config</span><span style=color:#61676ccc>,</span><span> ext) </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_config_dyn</span><span>(</span><span style=color:#ed9366>&</span><span>TypeId</span><span style=color:#ed9366>::</span><span>of</span><span style=color:#ed9366>::</span><span>&LTT>())</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// 使用 `?` 操作符
</span><span>    </span><span style=color:#fa6e32>let</span><span> ext </span><span style=color:#ed9366>=</span><span> ext</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_any</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>downcast_ref</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Some</span><span>((config</span><span style=color:#61676ccc>,</span><span> ext))
</span><span>}
</span></code></pre> <p>其次，在 <code>gizmos.rs</code> 中，改动了 <code>Gizmos</code> 系统参数实现的 <code>validate_param</code> 方法。这是支持 <code>Option&LTGizmos></code> 的核心。<code>validate_param</code> 在系统运行前被调用，用于验证参数是否可用。修改后的逻辑在内部状态验证通过后，会尝试获取一次配置。如果配置不存在（使用新增的 <code>get_config</code> 方法检查），它就返回一个 <code>SystemParamValidationError</code>。对于常规的 <code>Gizmos</code> 参数，这个错误会导致系统无法运行（这是期望的）。然而，对于 <code>Option&LTGizmos></code>，Bevy 的 ECS 框架会将此验证错误解释为“参数无效”，从而将 <code>Option&LTGizmos></code> 设置为 <code>None</code>。这正好实现了预期的行为。</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// File: crates/bevy_gizmos/src/gizmos.rs
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>validate_param</span><span>(...) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><(), SystemParamValidationError> {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... 原有状态验证
</span><span>    </span><span style=color:#fa6e32>unsafe </span><span>{ GizmosState</span><span style=color:#ed9366>::</span><span>&LTConfig, Clear></span><span style=color:#ed9366>::</span><span>validate_param(</span><span style=color:#ed9366>...</span><span>)</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>; </span><span>}
</span><span>
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 新增的配置检查逻辑
</span><span>    </span><span style=color:#fa6e32>let </span><span>(</span><span style=color:#ed9366>_</span><span style=color:#61676ccc>,</span><span> f1) </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>unsafe </span><span>{ GizmosState</span><span style=color:#ed9366>::</span><span>&LTConfig, Clear></span><span style=color:#ed9366>::</span><span>get_param(</span><span style=color:#ed9366>...</span><span>) }</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 使用新的 `get_config` 方法进行安全检查
</span><span>    </span><span style=color:#fa6e32>if</span><span> f1</span><span style=color:#ed9366>.</span><span>get_config</span><span style=color:#ed9366>::</span><span>&LTConfig>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_none</span><span>() {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// 返回错误，这会使 `Option&LTGizmos>` 变为 `None`
</span><span>        </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(SystemParamValidationError</span><span style=color:#ed9366>::</span><span>invalid</span><span style=color:#ed9366>::</span><span><</span><span style=color:#fa6e32>Self</span><span>>(</span><span style=color:#ed9366>...</span><span>))
</span><span>    } </span><span style=color:#fa6e32>else </span><span>{
</span><span>        </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(())
</span><span>    }
</span><span>}
</span></code></pre> <p>第三，修改了 <code>GizmoBuffer</code>（负责存储图形数据）的 <code>queue</code> 方法。这是防御性编程。如果某个配置组的 <code>GizmoStorage</code> 资源没有被初始化（可能是因为配置组未初始化），但它的 <code>GizmoBuffer</code> 仍然被填充了数据，那么在 <code>queue</code> 阶段尝试获取该资源就会失败。修改后的逻辑使用 <code>world.get_resource_mut</code>（返回 <code>Option</code>）来安全地获取资源。如果资源存在，则追加数据；如果不存在，则清空缓冲区，防止其无限增长（内存泄漏）。这确保了系统的资源安全。</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// File: crates/bevy_gizmos/src/gizmos.rs
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>queue</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>_system_meta</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>SystemMeta, </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>:</span><span> DeferredWorld) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 安全地尝试获取资源
</span><span>    </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#fa6e32>mut</span><span> storage) </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span>get_resource_mut</span><span style=color:#ed9366>::</span><span>&LTGizmoStorage&LTConfig, Clear>>() {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// 资源存在，正常追加数据
</span><span>        storage</span><span style=color:#ed9366>.</span><span>list_positions</span><span style=color:#ed9366>.</span><span style=color:#f07171>append</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>list_positions)</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>    } </span><span style=color:#fa6e32>else </span><span>{
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// 资源不存在，清空缓冲区避免内存泄漏
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>list_positions</span><span style=color:#ed9366>.</span><span style=color:#f07171>clear</span><span>()</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>    }
</span><span>}
</span></code></pre> <p>从技术角度来看，这个 PR 展示了如何增强一个现有的、非派生的 <code>SystemParam</code> 以支持 <code>Option</code> 包装器，这是 Bevy ECS 中一个强大的模式。关键洞察在于利用 <code>validate_param</code> 的返回错误机制，该机制是 <code>Option&LTSystemParam></code> 能够工作的基础。同时，它也演示了如何通过添加可失败的方法（fallible methods）来扩展现有 API 而不破坏现有代码。性能方面，新增的检查开销很小，且只在参数验证阶段发生一次，因此对运行时性能没有显著影响，正如测试所验证的那样。</p> <p>总的来说，这个修复提高了 <code>Gizmos</code> 系统的健壮性和开发者体验。它允许代码更灵活地处理可选的可视化调试功能，同时保持了与现有代码的完全兼容性。这种模式——在验证阶段进行存在性检查并为资源操作添加防御性逻辑——对于设计可靠的手动实现 <code>SystemParam</code> 是一个很好的参考。</p> <h2 id=shi-jue-biao-shi>视觉表示</h2> <pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    subgraph “系统执行前”
</span><span>        A[Option&LTGizmos&LTMyGroup>> 参数提取] --> B[调用 validate_param]
</span><span>        B --> C{配置组 MyGroup 已初始化？}
</span><span>        C -- 是 --> D[验证成功，Option 变为 Some(Gizmos)]
</span><span>        C -- 否 --> E[返回 SystemParamValidationError]
</span><span>        E --> F[Option 保持为 None]
</span><span>    end
</span><span>
</span><span>    subgraph “系统执行中/后”
</span><span>        G[GizmoBuffer 填充数据] --> H[调用 queue 方法]
</span><span>        H --> I{GizmoStorage&LTMyGroup> 资源存在？}
</span><span>        I -- 是 --> J[数据追加到存储]
</span><span>        I -- 否 --> K[缓冲区被清空，防止泄露]
</span><span>    end
</span></code></pre> <h2 id=guan-jian-wen-jian-geng-gai>关键文件更改</h2> <h3 id=crates-bevy-gizmos-src-config-rs-40-4><code>crates/bevy_gizmos/src/config.rs</code> (+40/-4)</h3> <p><strong>目的</strong>：为 <code>GizmoConfigStore</code> 添加可安全失败（fallible）的配置获取方法，作为支持 <code>Option&LTGizmos></code> 的基础。 <strong>关键修改</strong>：</p> <ol><li>重构了 <code>config()</code> 和 <code>config_mut()</code> 方法，使其调用新的 <code>get_config()</code> 和 <code>get_config_mut()</code> 方法，但保持 panic 行为以维持向后兼容性。<li>新增了 <code>get_config()</code> 和 <code>get_config_mut()</code> 方法，它们返回 <code>Option</code>，允许调用者检查配置是否存在而不引发 panic。</ol> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 关键新增方法示例
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>get_config</span><span>&LTT</span><span style=color:#61676ccc>:</span><span> GizmoConfigGroup>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Option</span><span><(</span><span style=color:#ed9366>&</span><span>GizmoConfig, </span><span style=color:#ed9366>&</span><span>T)> {
</span><span>    </span><span style=color:#fa6e32>let </span><span>(config</span><span style=color:#61676ccc>,</span><span> ext) </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_config_dyn</span><span>(</span><span style=color:#ed9366>&</span><span>TypeId</span><span style=color:#ed9366>::</span><span>of</span><span style=color:#ed9366>::</span><span>&LTT>())</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> ext </span><span style=color:#ed9366>=</span><span> ext</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_any</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>downcast_ref</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Some</span><span>((config</span><span style=color:#61676ccc>,</span><span> ext))
</span><span>}
</span></code></pre> <h3 id=crates-bevy-gizmos-src-gizmos-rs-34-7><code>crates/bevy_gizmos/src/gizmos.rs</code> (+34/-7)</h3> <p><strong>目的</strong>：修改 <code>Gizmos</code> 系统参数的验证逻辑和缓冲区排队逻辑，以优雅处理配置或资源缺失的情况。 <strong>关键修改</strong>：</p> <ol><li>在 <code>Gizmos::validate_param</code> 中，在完成基础状态验证后，增加了对配置存在性的检查。如果配置不存在，则返回错误，这将导致 <code>Option&LTGizmos></code> 被设为 <code>None</code>。<li>在 <code>GizmoBuffer::queue</code> 中，将直接获取资源改为先尝试获取 <code>Option</code>。如果资源存在则追加数据，否则清空自身缓冲区，这是一种防御性措施，防止内存泄漏。</ol> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// validate_param 中的新增检查逻辑（片段）
</span><span style=color:#fa6e32>if</span><span> f1</span><span style=color:#ed9366>.</span><span>get_config</span><span style=color:#ed9366>::</span><span>&LTConfig>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_none</span><span>() {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(SystemParamValidationError</span><span style=color:#ed9366>::</span><span>invalid</span><span style=color:#ed9366>::</span><span><</span><span style=color:#fa6e32>Self</span><span>>(
</span><span>        </span><span style=color:#f07171>format!</span><span>(</span><span style=color:#86b300>"Requested config </span><span style=color:#ff8f40>{}</span><span style=color:#86b300> does not exist..."</span><span style=color:#61676ccc>, </span><span>Config</span><span style=color:#ed9366>::</span><span>type_path())))
</span><span>} </span><span style=color:#fa6e32>else </span><span>{
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(())
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// queue 方法中的防御性逻辑
</span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#fa6e32>mut</span><span> storage) </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span>get_resource_mut</span><span style=color:#ed9366>::</span><span>&LTGizmoStorage&LTConfig, Clear>>() {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 正常操作...
</span><span>} </span><span style=color:#fa6e32>else </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 清空缓冲区
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>list_positions</span><span style=color:#ed9366>.</span><span style=color:#f07171>clear</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>}
</span></code></pre> <h2 id=jin-yi-bu-yue-du>进一步阅读</h2> <ol><li>Bevy 官方文档中的 <a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/ecs/system/trait.SystemParam.html target=_blank>SystemParam</a> trait 说明，了解自定义系统参数的工作原理。<li>Bevy 官方示例中的 <a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/examples/ecs/system_param.rs target=_blank>System Parameter</a> 示例，展示了包括 <code>Option</code> 在内的各种系统参数用法。<li>GitHub Issue <a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/issues/14949 target=_blank>#14949</a>，这是本 PR 所要解决的原问题，包含了更多的背景和讨论。<li>Rust 编程中的 <a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/book/ch09-00-error-handling.html target=_blank>Error Handling</a> 章节，理解 <code>Result</code> 和 <code>Option</code> 类型在处理潜在错误时的最佳实践。</ol>    <div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_22812.patch id=patch-info style=display:none></div>  <div class=bottom-spacer></div> 