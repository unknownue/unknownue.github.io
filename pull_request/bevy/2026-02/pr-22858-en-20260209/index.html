<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22858 gltf: let extension handle late-added materials
        
    </title><meta content="#22858 gltf: let extension handle late-added materials" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-09</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-02/pr-22858-zh-cn-20260209>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: gltf: let extension handle late-added materials<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22858<li><strong>Author</strong>: mockersf<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: S-Ready-For-Final-Review, A-glTF<li><strong>Created</strong>: 2026-02-07T19:04:28Z<li><strong>Merged</strong>: 2026-02-09T22:55:35Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p><strong>Objective</strong><ul><li>#22569 broke some examples, some materials are not displayed</ul><p><strong>Solution</strong><ul><li>Some materials are added late because we modify them depending on how they’re used (for example, with an inverted scale). Also triggers extensions on those</ul><p><strong>Testing</strong> examples <code>light_probe_blending</code>, <code>irradiance_volumes</code>, <code>pccm</code>, <code>pcss</code> are now fixed<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR fixes a regression introduced by PR #22569 that caused materials to not display in several examples (<code>light_probe_blending</code>, <code>irradiance_volumes</code>, <code>pccm</code>, <code>pcss</code>). The issue occurred because some materials are added to the asset system late in the glTF loading process, after the initial material loading pass.<p>The problem stems from how Bevy’s glTF loader handles materials that require runtime modifications. Some materials need to be adjusted based on their usage context - for instance, materials applied to meshes with inverted scales require special handling. These “late-added” materials were being added to the asset system, but the extension system wasn’t being notified about them.<p>The core issue was that when the glTF loader processes materials that require modifications (like those for inverted scale meshes), it adds them to the asset context outside of the normal material loading flow. PR #22569 had changed how extensions interact with materials, but the change didn’t account for these late-added materials. Extensions that needed to process material data weren’t being called for these materials, leading to incomplete material setup and rendering issues.<p>The solution implemented here is straightforward: after adding a late-added material to the asset context, the code now explicitly calls the extension system to process that material. This ensures that extensions have the opportunity to set up any required material data, just like they do for materials loaded during the initial pass.<p>Looking at the implementation, the fix modifies the <code>load_node</code> function in the glTF loader. When a material needs to be added late (because it wasn’t previously loaded and requires modification for inverted scale), the code now:<ol><li>Loads the material as before<li>Adds it to the labeled asset context<li>Iterates through all registered extensions and calls their <code>on_material</code> method with the newly created material</ol><p>This approach ensures consistency - all materials, whether loaded during the initial pass or added later with modifications, go through the same extension processing pipeline. The fix is minimal and surgical, targeting exactly the gap in the processing flow.<p>From an architectural perspective, this fix reinforces the pattern that all asset creation in the glTF loader should go through the extension system when appropriate. It also highlights the importance of considering edge cases when refactoring asset loading pipelines - in this case, the “late addition” pattern for modified materials.<p>The impact is immediate and positive: the four broken examples now work correctly again. No performance impact is expected since we’re simply ensuring existing extension logic runs on a previously missed subset of materials. The fix maintains backward compatibility and doesn’t introduce any new APIs or breaking changes.<p>This case demonstrates a common pattern in game engine development: asset loaders often need to handle multiple passes or late modifications due to runtime context. The solution shows good separation of concerns - the core loader handles the basic material loading and modification, while extensions get a chance to process all materials regardless of when they enter the system.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    subgraph "Original Flow (Broken)"
</span><span>        A[Load glTF Materials] --> B[Extensions Process Materials]
</span><span>        C[Add Late-Modified Materials] --> D[Material Missing Extension Data]
</span><span>    end
</span><span>    
</span><span>    subgraph "Fixed Flow"
</span><span>        E[Load glTF Materials] --> F[Extensions Process Materials]
</span><span>        G[Add Late-Modified Materials] --> H[Call Extensions on Material]
</span><span>        H --> I[Extension Data Applied]
</span><span>    end
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>crates/bevy_gltf/src/loader/mod.rs</strong> (+15/-6)<p>This file contains the core glTF loading logic. The change modifies how materials that are added late in the loading process (due to runtime modifications like inverted scale) are processed by extensions.<p><strong>Key Changes:</strong><ol><li><strong>Added extension processing for late-added materials</strong>: The code now explicitly calls extension handlers for materials that are added after the initial loading pass.</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// File: crates/bevy_gltf/src/loader/mod.rs
</span><span style=color:#abb0b6;font-style:italic>// Before (simplified):
</span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>root_load_context</span><span style=color:#ed9366>.</span><span style=color:#f07171>has_labeled_asset</span><span>(</span><span style=color:#ed9366>&</span><span>material_label)
</span><span>    </span><span style=color:#ed9366>&& !</span><span>load_context</span><span style=color:#ed9366>.</span><span style=color:#f07171>has_labeled_asset</span><span>(</span><span style=color:#ed9366>&</span><span>material_label)
</span><span>{
</span><span>    </span><span style=color:#fa6e32>let </span><span>(label</span><span style=color:#61676ccc>,</span><span> material) </span><span style=color:#ed9366>= </span><span style=color:#f07171>load_material</span><span>(
</span><span>        </span><span style=color:#ed9366>&</span><span>material</span><span style=color:#61676ccc>,
</span><span>        textures</span><span style=color:#61676ccc>,
</span><span>        is_scale_inverted</span><span style=color:#61676ccc>,
</span><span>        load_context</span><span style=color:#ed9366>.</span><span style=color:#f07171>path</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#61676ccc>,
</span><span>    )</span><span style=color:#61676ccc>;
</span><span>    load_context</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_labeled_asset</span><span>(label</span><span style=color:#61676ccc>,</span><span> material)</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>root_load_context</span><span style=color:#ed9366>.</span><span style=color:#f07171>has_labeled_asset</span><span>(</span><span style=color:#ed9366>&</span><span>material_label)
</span><span>    </span><span style=color:#ed9366>&& !</span><span>load_context</span><span style=color:#ed9366>.</span><span style=color:#f07171>has_labeled_asset</span><span>(</span><span style=color:#ed9366>&</span><span>material_label)
</span><span>{
</span><span>    </span><span style=color:#fa6e32>let </span><span>(label</span><span style=color:#61676ccc>,</span><span> gltf_material) </span><span style=color:#ed9366>= </span><span style=color:#f07171>load_material</span><span>(
</span><span>        </span><span style=color:#ed9366>&</span><span>material</span><span style=color:#61676ccc>,
</span><span>        textures</span><span style=color:#61676ccc>,
</span><span>        is_scale_inverted</span><span style=color:#61676ccc>,
</span><span>        load_context</span><span style=color:#ed9366>.</span><span style=color:#f07171>path</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#61676ccc>,
</span><span>    )</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> handle </span><span style=color:#ed9366>=</span><span> load_context</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_labeled_asset</span><span>(label</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#61676ccc>,</span><span> gltf_material</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>())</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// let extensions handle material data
</span><span>    </span><span style=color:#fa6e32>for</span><span> extension </span><span style=color:#ed9366>in</span><span> extensions</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter_mut</span><span>() {
</span><span>        extension</span><span style=color:#ed9366>.</span><span style=color:#f07171>on_material</span><span>(
</span><span>            load_context</span><span style=color:#61676ccc>,
</span><span>            </span><span style=color:#ed9366>&</span><span>material</span><span style=color:#61676ccc>,
</span><span>            handle</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#61676ccc>,
</span><span>            </span><span style=color:#ed9366>&</span><span>gltf_material</span><span style=color:#61676ccc>,
</span><span>            </span><span style=color:#ed9366>&</span><span>label</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#61676ccc>,
</span><span>        )</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><p>The key addition is the loop that calls <code>extension.on_material()</code> for each extension. This ensures that extensions can process the material even when it’s added late in the loading process. The comment was also updated to better reflect what’s happening: “This adds materials that Bevy modifies depending on how they’re used, like those with inverted scale.”<h2 id=further-reading>Further Reading</h2><ol><li><strong>Bevy glTF Extension System</strong>: The <a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_gltf/latest/bevy_gltf/ target=_blank>Bevy glTF documentation</a> covers how extensions work in the glTF loader<li><strong>glTF Material Extensions</strong>: The <a rel="noopener nofollow noreferrer" href=https://github.com/KhronosGroup/glTF/tree/main/extensions target=_blank>glTF specification on extensions</a> provides context on why extension systems are needed<li><strong>Asset Loading Patterns</strong>: The <a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/features/assets.html target=_blank>Bevy Asset System documentation</a> explains Bevy’s asset loading patterns<li><strong>Previous PR #22569</strong>: Understanding the changes in the previous PR that introduced this regression provides context for why this fix was necessary<li><strong>Inverted Scale Handling</strong>: The concept of handling inverted scale in rendering is common in 3D graphics; resources on normal transformation and rendering with negative scale can provide background on why materials need modification</ol><h1 id=full-code-diff>Full Code Diff</h1><p>diff –git a/crates/bevy_gltf/src/loader/mod.rs b/crates/bevy_gltf/src/loader/mod.rs index 6fece7e3702e..916ed1a5701ba 100644 — a/crates/bevy_gltf/src/loader/mod.rs +++ b/crates/bevy_gltf/src/loader/mod.rs @@ -1585,21 +1585,30 @@ fn load_node( let mat_label = material_label(&material, is_scale_inverted); let material_label = mat_label.to_string();<ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>           // This will make sure we load the default material now since it would not have been
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           // added when iterating over all the gltf materials (since the default material is
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           // not explicitly listed in the gltf).
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           // It also ensures an inverted scale copy is instantiated if required.
</span></code></pre></ul><ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>           // This adds materials that Bevy modifies depending on how they're used, like those with inverted scale.
</span><span>           if !root_load_context.has_labeled_asset(&material_label)
</span><span>               && !load_context.has_labeled_asset(&material_label)
</span><span>           {
</span></code></pre></ul><ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>               let (label, material) = load_material(
</span></code></pre></ul><ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>               let (label, gltf_material) = load_material(
</span><span>                   &material,
</span><span>                   textures,
</span><span>                   is_scale_inverted,
</span><span>                   load_context.path().clone(),
</span><span>               );
</span><span>               // TODO: maybe move this into `load_material` ?
</span></code></pre></ul><ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>               load_context.add_labeled_asset(label, material);
</span></code></pre></ul><ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>               let handle =
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>                   load_context.add_labeled_asset(label.clone(), gltf_material.clone());
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>               // let extensions handle material data
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>               for extension in extensions.iter_mut() {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>                   extension.on_material(
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>                       load_context,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>                       &material,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>                       handle.clone(),
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>                       &gltf_material,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>                       &label.clone(),
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>                   );
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>               }
</span><span>           }
</span><span>
</span><span>           let primitive_label = GltfAssetLabel::Primitive {</span></code></pre></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_22858.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>