<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22628 Fix failed sub-asset loads getting stuck in `LoadState::Loading`
        
    </title><meta content="#22628 Fix failed sub-asset loads getting stuck in `LoadState::Loading`" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-02</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-02/pr-22628-zh-cn-20260202>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>Fix failed sub-asset loads getting stuck in <code>LoadState::Loading</code><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix failed sub-asset loads getting stuck in <code>LoadState::Loading</code><li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22628<li><strong>Author</strong>: greeble-dev<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Assets, S-Ready-For-Final-Review<li><strong>Created</strong>: 2026-01-21T17:16:05Z<li><strong>Merged</strong>: 2026-02-02T23:26:53Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>Objective<p>Fix #22607. Also add a test that reproduces the issues.<p>If it makes things clearer, I can split this into an “add a test” PR and a separate “fix the bug” PR.<p>Solution<p>There are three additions to <code>AssetServer::load_internal</code> that each fix a separate case. In source code order:<h3 id=case-1>Case 1</h3><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Sub-asset exists, but is not of type `WrongAssetType`.
</span><span>asset_server</span><span style=color:#ed9366>.</span><span>load</span><span style=color:#ed9366>::</span><span>&LTWrongAssetType>(</span><span style=color:#86b300>"asset#subasset"</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><p>Previously this would silently fail - the asset would successfully load, but the handle can’t actually resolve to that asset so it’s stuck in limbo.<p>Fixed by adding a type check, then sending a <code>AssetLoadError::RequestedHandleTypeMismatch</code> event and returning it as an error.<p>Note that this doesn’t prevent someone loading the asset with the correct type - the error is only associated with the <code>&LTWrongAssetType></code> handle.<h3 id=case-2>Case 2</h3><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Sub-asset doesn't exist.
</span><span>asset_server</span><span style=color:#ed9366>.</span><span>load</span><span style=color:#ed9366>::</span><span>&LTAssetType>(</span><span style=color:#86b300>"asset#non_existent_subasset"</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><p>Previously this was detected and would return a <code>AssetLoadError::MissingLabel</code> error from <code>load_internal</code>, but the load status for the handle wasn’t set.<p>Fixed by sending an <code>InternalAssetEvent::Failed</code>.<h3 id=case-3>Case 3</h3><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Asset loader returns an error.
</span><span>asset_server</span><span style=color:#ed9366>.</span><span>load</span><span style=color:#ed9366>::</span><span>&LTAssetType>(</span><span style=color:#86b300>"malformed_asset#subasset"</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><p>Previously this was detected, but the event was sent with the root asset’s id (<code>base_asset_id</code>) so it wasn’t associated with the sub-asset’s handle.<p>Fixed by using the sub-asset’s id.<h3 id=notes>Notes</h3><p>Some of the events are only sent if <code>asset_id</code> is set. This might seem odd, but I think it’s correct - <code>asset_id</code> can only be unset when using <code>load_untyped</code> with a sub-asset path, in which case there’s no handle to associate with the error, and so there’s no handle to pass to <code>get_load_status</code>.<h2 id=testing>Testing</h2><pre class=language-sh data-lang=sh style=color:#61676c;background-color:#fafafa><code class=language-sh data-lang=sh><span style=color:#f29718>cargo</span><span> test</span><span style=color:#ff8f40> -p</span><span> bevy_asset
</span><span style=color:#f29718>cargo</span><span> test</span><span style=color:#ff8f40> -p</span><span> bevy_asset</span><span style=color:#ff8f40> --features </span><span style=color:#86b300>"multi_threaded"
</span></code></pre><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The issue (#22607) reported a bug where sub-assets could get stuck in a perpetual <code>LoadState::Loading</code> state when certain types of failures occurred. This created problems for developers who needed to know when asset loading had definitively failed so they could handle errors appropriately or retry the operation. The bug was particularly problematic because it affected three distinct failure scenarios, each requiring a different fix.<p>At its core, the problem was in the <code>AssetServer::load_internal</code> method, which handles the loading of both root assets and sub-assets (assets referenced by labels like <code>"asset#subasset"</code>). When loading failed, the method wasn’t properly notifying the asset system about the failure for sub-assets, leaving their handles stuck in a loading state.<p>The developer identified three specific failure cases:<ol><li><p><strong>Type mismatch for existing sub-assets</strong>: When a developer requested a sub-asset with the wrong type (e.g., loading a <code>Texture</code> handle for an asset that was actually a <code>Mesh</code>), the system would successfully load the parent asset but then fail to connect the handle to the actual asset data. The handle would remain in <code>LoadState::Loading</code> indefinitely because no failure event was sent.</p><li><p><strong>Missing sub-asset labels</strong>: When a developer requested a sub-asset that didn’t exist (e.g., <code>"asset#nonexistent"</code>), the system detected the missing label and returned an error, but it didn’t send the appropriate <code>InternalAssetEvent::Failed</code> event. Without this event, the asset handle’s load state never updated from <code>Loading</code> to <code>Failed</code>.</p><li><p><strong>Loader errors for sub-assets</strong>: When the asset loader failed to parse or process the root asset (which contains the sub-asset), the system was sending the failure event with the wrong asset ID. It used the root asset’s ID (<code>base_asset_id</code>) instead of the sub-asset’s ID, so the sub-asset handle never received the failure notification.</p></ol><p>The solution implemented checks for each case in the <code>load_internal</code> method. For the type mismatch case, the code now verifies that the requested asset type matches the actual type of the labeled asset before returning a handle. If there’s a mismatch, it sends a <code>RequestedHandleTypeMismatch</code> error event. For the missing label case, the code now sends a <code>Failed</code> event before returning the error. For loader errors, the code now uses the correct asset ID when sending the failure event.<p>An important design consideration was that these failure events are only sent when <code>asset_id</code> is set. This is correct because <code>asset_id</code> represents the specific handle being loaded. When using <code>load_untyped</code> with a sub-asset path, there’s no typed handle to track, so there’s no need to send failure events that would update a handle’s load state.<p>The implementation also includes comprehensive tests that verify each failure case now correctly transitions the asset handle to a <code>Failed</code> state. These tests use a helper function <code>test_load_state</code> that loads assets and checks their final load state against expected values. The tests cover normal successful loads, various failure modes, and edge cases to ensure the fixes work correctly.<p>From an architectural perspective, this fix maintains the existing event-driven design of Bevy’s asset system. Assets communicate their state through events, and handles listen for these events to update their internal state. The bug occurred because certain failure paths weren’t emitting the expected events for sub-assets, breaking the communication chain between asset loading and handle state management.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[AssetServer.load_internal] --> B{Is sub-asset?}
</span><span>    B -->|Yes| C[Find labeled asset]
</span><span>    B -->|No| D[Load root asset]
</span><span>    
</span><span>    C --> E{Label exists?}
</span><span>    E -->|No| F[Send MissingLabel error event]
</span><span>    E -->|Yes| G{Type matches?}
</span><span>    G -->|No| H[Send TypeMismatch error event]
</span><span>    G -->|Yes| I[Return sub-asset handle]
</span><span>    
</span><span>    D --> J{Loader succeeded?}
</span><span>    J -->|No| K[Send error with correct asset_id]
</span><span>    J -->|Yes| L[Return root asset handle]
</span><span>    
</span><span>    F --> M[Update handle state to Failed]
</span><span>    H --> M
</span><span>    K --> M
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-asset-src-server-mod-rs-38-8><code>crates/bevy_asset/src/server/mod.rs</code> (+38/-8)</h3><p>This file contains the main fix in the <code>AssetServer::load_internal</code> method. The changes add proper error handling for three sub-asset loading failure cases.<p><strong>Key changes:</strong><ol><li><strong>Type mismatch check for labeled assets</strong>:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: No type checking for labeled assets
</span><span style=color:#55b4d4;font-style:italic>Some</span><span>(labeled_asset) </span><span style=color:#ed9366>=> </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(labeled_asset</span><span style=color:#ed9366>.</span><span>handle</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>())</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Added type verification with error handling
</span><span style=color:#55b4d4;font-style:italic>Some</span><span>(labeled_asset) </span><span style=color:#ed9366>=> </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// If we know the requested type then check it
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// matches the labeled asset.
</span><span>    </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(asset_id) </span><span style=color:#ed9366>=</span><span> asset_id
</span><span>        </span><span style=color:#ed9366>&&</span><span> asset_id</span><span style=color:#ed9366>.</span><span>type_id </span><span style=color:#ed9366>!=</span><span> labeled_asset</span><span style=color:#ed9366>.</span><span>handle</span><span style=color:#ed9366>.</span><span style=color:#f07171>type_id</span><span>()
</span><span>    {
</span><span>        </span><span style=color:#fa6e32>let</span><span> error </span><span style=color:#ed9366>= </span><span>AssetLoadError</span><span style=color:#ed9366>::</span><span>RequestedHandleTypeMismatch {
</span><span>            path</span><span style=color:#61676ccc>:</span><span> path</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#61676ccc>,
</span><span>            requested</span><span style=color:#61676ccc>:</span><span> asset_id</span><span style=color:#ed9366>.</span><span>type_id</span><span style=color:#61676ccc>,
</span><span>            actual_asset_name</span><span style=color:#61676ccc>:</span><span> labeled_asset</span><span style=color:#ed9366>.</span><span>asset</span><span style=color:#ed9366>.</span><span>value</span><span style=color:#ed9366>.</span><span style=color:#f07171>asset_type_name</span><span>()</span><span style=color:#61676ccc>,
</span><span>            loader_name</span><span style=color:#61676ccc>:</span><span> loader</span><span style=color:#ed9366>.</span><span style=color:#f07171>type_path</span><span>()</span><span style=color:#61676ccc>,
</span><span>        }</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>send_asset_event</span><span>(InternalAssetEvent</span><span style=color:#ed9366>::</span><span>Failed {
</span><span>            index</span><span style=color:#61676ccc>:</span><span> asset_id</span><span style=color:#61676ccc>,
</span><span>            error</span><span style=color:#61676ccc>:</span><span> error</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#61676ccc>,
</span><span>            path</span><span style=color:#61676ccc>:</span><span> path</span><span style=color:#ed9366>.</span><span style=color:#f07171>into_owned</span><span>()</span><span style=color:#61676ccc>,
</span><span>        })</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#fa6e32>return </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(error)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(labeled_asset</span><span style=color:#ed9366>.</span><span>handle</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>())
</span><span>}
</span></code></pre><ol start=2><li><strong>Missing label error event</strong>:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Just returned error without sending event
</span><span style=color:#fa6e32>return </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(AssetLoadError</span><span style=color:#ed9366>::</span><span>MissingLabel {
</span><span>    base_path</span><span style=color:#61676ccc>,
</span><span>    label</span><span style=color:#61676ccc>:</span><span> label</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_string</span><span>()</span><span style=color:#61676ccc>,
</span><span>    all_labels</span><span style=color:#61676ccc>,
</span><span>})</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Send failure event before returning error
</span><span style=color:#fa6e32>let</span><span> error </span><span style=color:#ed9366>= </span><span>AssetLoadError</span><span style=color:#ed9366>::</span><span>MissingLabel {
</span><span>    base_path</span><span style=color:#61676ccc>,
</span><span>    label</span><span style=color:#61676ccc>:</span><span> label</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_string</span><span>()</span><span style=color:#61676ccc>,
</span><span>    all_labels</span><span style=color:#61676ccc>,
</span><span>}</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(asset_id) </span><span style=color:#ed9366>=</span><span> asset_id {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>send_asset_event</span><span>(InternalAssetEvent</span><span style=color:#ed9366>::</span><span>Failed {
</span><span>        index</span><span style=color:#61676ccc>:</span><span> asset_id</span><span style=color:#61676ccc>,
</span><span>        error</span><span style=color:#61676ccc>:</span><span> error</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#61676ccc>,
</span><span>        path</span><span style=color:#61676ccc>:</span><span> path</span><span style=color:#ed9366>.</span><span style=color:#f07171>into_owned</span><span>()</span><span style=color:#61676ccc>,
</span><span>    })</span><span style=color:#61676ccc>;
</span><span>}
</span><span style=color:#fa6e32>return </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(error)</span><span style=color:#61676ccc>;
</span></code></pre><ol start=3><li><strong>Correct asset ID for loader errors</strong>:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Used base_asset_id for all failures
</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>send_asset_event</span><span>(InternalAssetEvent</span><span style=color:#ed9366>::</span><span>Failed {
</span><span>    index</span><span style=color:#61676ccc>:</span><span> base_asset_id</span><span style=color:#61676ccc>,  </span><span style=color:#abb0b6;font-style:italic>// Wrong for sub-assets
</span><span>    error</span><span style=color:#61676ccc>:</span><span> err</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#61676ccc>,
</span><span>    path</span><span style=color:#61676ccc>:</span><span> path</span><span style=color:#ed9366>.</span><span style=color:#f07171>into_owned</span><span>()</span><span style=color:#61676ccc>,
</span><span>})</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Use the specific asset_id for the handle being loaded
</span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(asset_id) </span><span style=color:#ed9366>=</span><span> asset_id {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>send_asset_event</span><span>(InternalAssetEvent</span><span style=color:#ed9366>::</span><span>Failed {
</span><span>        index</span><span style=color:#61676ccc>:</span><span> asset_id</span><span style=color:#61676ccc>,  </span><span style=color:#abb0b6;font-style:italic>// Correct for sub-assets
</span><span>        error</span><span style=color:#61676ccc>:</span><span> err</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#61676ccc>,
</span><span>        path</span><span style=color:#61676ccc>:</span><span> path</span><span style=color:#ed9366>.</span><span style=color:#f07171>into_owned</span><span>()</span><span style=color:#61676ccc>,
</span><span>    })</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=crates-bevy-asset-src-lib-rs-166-1><code>crates/bevy_asset/src/lib.rs</code> (+166/-1)</h3><p>This file contains the comprehensive test suite that validates the fix works for all identified failure cases.<p><strong>Key additions:</strong><ol><li><p><strong>Test infrastructure</strong>:</p> <ul><li>Added <code>TestLoadState</code> enum for simplified load state comparison<li>Added <code>TestAssetLoadError</code> enum for simplified error comparison<li>Added <code>test_load_state</code> helper function that sets up an app, loads an asset, and verifies the final load state</ul><li><p><strong>Comprehensive test cases</strong>:</p></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>load_failure</span><span>() {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Tests various failure scenarios including:
</span><span>    test_load_state</span><span style=color:#ed9366>::</span><span>&LTCoolText>(</span><span style=color:#86b300>"root asset exists"</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"test.cool.ron"</span><span style=color:#61676ccc>, </span><span>TestLoadState</span><span style=color:#ed9366>::</span><span>Loaded)</span><span style=color:#61676ccc>;
</span><span>    test_load_state</span><span style=color:#ed9366>::</span><span>&LTSubText>(</span><span style=color:#86b300>"sub-asset exists"</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"test.cool.ron#subasset"</span><span style=color:#61676ccc>, </span><span>TestLoadState</span><span style=color:#ed9366>::</span><span>Loaded)</span><span style=color:#61676ccc>;
</span><span>    test_load_state</span><span style=color:#ed9366>::</span><span>&LTCoolText>(</span><span style=color:#86b300>"root asset does not exist"</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"does_not_exist.cool.ron"</span><span style=color:#61676ccc>, </span><span>TestLoadState</span><span style=color:#ed9366>::</span><span>Failed(TestAssetLoadError</span><span style=color:#ed9366>::</span><span>AssetReaderErrorNotFound))</span><span style=color:#61676ccc>;
</span><span>    test_load_state</span><span style=color:#ed9366>::</span><span>&LTSubText>(</span><span style=color:#86b300>"sub-asset does not exist"</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"test.cool.ron#does_not_exist"</span><span style=color:#61676ccc>, </span><span>TestLoadState</span><span style=color:#ed9366>::</span><span>Failed(TestAssetLoadError</span><span style=color:#ed9366>::</span><span>MissingLabel))</span><span style=color:#61676ccc>;
</span><span>    test_load_state</span><span style=color:#ed9366>::</span><span>&LTCoolText>(</span><span style=color:#86b300>"sub-asset is not requested type"</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"test.cool.ron#subasset"</span><span style=color:#61676ccc>, </span><span>TestLoadState</span><span style=color:#ed9366>::</span><span>Failed(TestAssetLoadError</span><span style=color:#ed9366>::</span><span>RequestedHandleTypeMismatch { requested</span><span style=color:#61676ccc>: </span><span>TypeId</span><span style=color:#ed9366>::</span><span>of</span><span style=color:#ed9366>::</span><span>&LTCoolText>()</span><span style=color:#61676ccc>,</span><span> actual_asset_name</span><span style=color:#61676ccc>: </span><span style=color:#86b300>"bevy_asset::tests::SubText" </span><span>}))</span><span style=color:#61676ccc>;
</span><span>    test_load_state</span><span style=color:#ed9366>::</span><span>&LTCoolText>(</span><span style=color:#86b300>"malformed root asset"</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"malformed.cool.ron"</span><span style=color:#61676ccc>, </span><span>TestLoadState</span><span style=color:#ed9366>::</span><span>Failed(TestAssetLoadError</span><span style=color:#ed9366>::</span><span>AssetLoaderError))</span><span style=color:#61676ccc>;
</span><span>    test_load_state</span><span style=color:#ed9366>::</span><span>&LTCoolText>(</span><span style=color:#86b300>"sub-asset of malformed root asset"</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"malformed.cool.ron#subasset"</span><span style=color:#61676ccc>, </span><span>TestLoadState</span><span style=color:#ed9366>::</span><span>Failed(TestAssetLoadError</span><span style=color:#ed9366>::</span><span>AssetLoaderError))</span><span style=color:#61676ccc>;
</span><span>    test_load_state</span><span style=color:#ed9366>::</span><span>&LTLoaderlessAsset>(</span><span style=color:#86b300>"root asset has no loader"</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"loaderless"</span><span style=color:#61676ccc>, </span><span>TestLoadState</span><span style=color:#ed9366>::</span><span>Failed(TestAssetLoadError</span><span style=color:#ed9366>::</span><span>MissingAssetLoader))</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_asset/latest/bevy_asset/ target=_blank>Bevy Asset System Documentation</a> - Official documentation for Bevy’s asset system<li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/features/assets.html target=_blank>Asset Loading in Bevy</a> - Comprehensive guide to asset loading patterns<li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/book/ch09-00-error-handling.html target=_blank>Handling Errors in Async Systems</a> - Rust error handling patterns relevant to async asset loading<li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/std/any/index.html target=_blank>Type IDs and Reflection in Rust</a> - Understanding TypeId and type comparison used in the fix</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_22628.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>