<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #23081 移除循环依赖 (remove circular dependency)
        
    </title><meta content="#23081 移除循环依赖 (remove circular dependency)" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-21</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2026-02/pr-23081-en-20260221>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>标题</strong>: 移除循环依赖 (remove circular dependency)<li><strong>PR 链接</strong>: https://github.com/bevyengine/bevy/pull/23081<li><strong>作者</strong>: mockersf<li><strong>状态</strong>: 已合并 (MERGED)<li><strong>标签</strong>: C-Bug, D-Trivial, S-Ready-For-Final-Review, A-Utils<li><strong>创建时间</strong>: 2026-02-20T20:57:45Z<li><strong>合并时间</strong>: 2026-02-21T00:56:45Z<li><strong>合并者</strong>: mockersf</ul><h2 id=miao-shu-fan-yi>描述翻译</h2><h3 id=mu-biao-objective>目标 (Objective)</h3><ul><li>#22297 引入了循环依赖，这将导致无法发布 Bevy</ul><h3 id=jie-jue-fang-an-solution>解决方案 (Solution)</h3><ul><li>移除它</ul><hr><h2 id=gai-pr-de-ji-shu-fen-xi>该 PR 的技术分析</h2><p>这是一个典型的维护性修复 PR，主要解决由先前 PR #22297 引入的循环依赖问题。循环依赖在 Rust 的 Cargo 构建系统中会导致编译失败，尤其是在准备发布构建时，因此必须立即修复。<p>问题的核心在于开发依赖项 (dev-dependencies) 的配置错误。在 <code>crates/bevy_utils/Cargo.toml</code> 中，开发者添加了三个对同级 crate 的开发依赖：<code>bevy_ecs</code>、<code>bevy_app</code> 和 <code>bevy_tasks</code>。然而，<code>bevy_utils</code> 本身是 Bevy 生态系统中的一个基础工具库，被许多其他核心 crate（包括这三个）所依赖。当这些依赖项反过来又作为开发依赖引用 <code>bevy_utils</code> 时，就创建了一个循环依赖图。<p>具体来说，这个循环依赖在运行测试或示例时才会显现，因为开发依赖只在运行 <code>cargo test</code> 或构建示例时才会被拉入。这种依赖结构会阻止 Cargo 正确解析依赖关系，导致构建失败。对于项目发布而言，这是一个致命问题，因为发布流程通常包括运行测试以确保代码质量。<p>解决方案直接而有效：移除导致循环的开发依赖。然而，这个决定有一个连带影响——<code>buffered_channel.rs</code> 文件中包含的一个完整使用示例依赖于这些被移除的 crate。这个示例原本展示了如何在 Bevy 应用系统中使用 <code>BufferedChannel</code> 类型，结合 <code>bevy_app</code>、<code>bevy_ecs</code> 和 <code>bevy_tasks</code> 来执行并行任务。<p>从工程角度看，这里有几种可能的处理方式：<ol><li>保留开发依赖但重构依赖结构（复杂且耗时）<li>将示例移至不会产生循环依赖的地方（可能需要重构代码组织）<li>完全移除示例（最简单直接的解决方案）</ol><p>开发者选择了第三种方案，这是合理的，因为：<ul><li>这个示例不是 API 文档的核心部分，更像是集成测试<li>移除示例可以立即解决问题，不影响核心功能<li><code>BufferedChannel</code> 类型本身的功能不受影响，仍可通过单元测试验证</ul><p><code>BufferedChannel</code> 是一个为高效并行处理设计的实用工具，它允许生产者任务批量发送数据，而消费者任务可以并发处理这些批次。虽然示例被移除，但类型的设计和功能保持不变。未来可以考虑在不引入循环依赖的情况下，通过其他方式（如独立的集成测试或文档示例）来演示其用法。<p>这个修复展示了依赖管理在大型 Rust 项目中的重要性。开发依赖虽然只在测试时使用，但如果配置不当，仍然会破坏整个项目的构建。这也提醒我们，在添加跨模块的依赖时，必须仔细分析依赖图，避免循环。<h2 id=shi-jue-biao-shi>视觉表示</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[bevy_utils] -->|依赖| B[bevy_ecs]
</span><span>    A -->|依赖| C[bevy_app]
</span><span>    A -->|依赖| D[bevy_tasks]
</span><span>    
</span><span>    B -.->|开发依赖| A
</span><span>    C -.->|开发依赖| A
</span><span>    D -.->|开发依赖| A
</span><span>    
</span><span>    style A fill:#f9f,stroke:#333,stroke-width:2px
</span><span>    style B fill:#ccf,stroke:#333,stroke-width:1px
</span><span>    style C fill:#ccf,stroke:#333,stroke-width:1px
</span><span>    style D fill:#ccf,stroke:#333,stroke-width:1px
</span><span>    
</span><span>    linkStyle 3 stroke:red,stroke-width:2px,stroke-dasharray:5 5
</span><span>    linkStyle 4 stroke:red,stroke-width:2px,stroke-dasharray:5 5
</span><span>    linkStyle 5 stroke:red,stroke-width:2px,stroke-dasharray:5 5
</span></code></pre><h2 id=guan-jian-wen-jian-bian-geng>关键文件变更</h2><h3 id=1-crates-bevy-utils-cargo-toml>1. <code>crates/bevy_utils/Cargo.toml</code></h3><p><strong>变更说明</strong>: 移除了三个导致循环依赖的开发依赖项。<p><strong>变更前</strong>:<pre class=language-toml data-lang=toml style=color:#61676c;background-color:#fafafa><code class=language-toml data-lang=toml><span>[</span><span style=color:#399ee6>dev-dependencies</span><span>]
</span><span style=color:#399ee6>static_assertions </span><span>= </span><span style=color:#86b300>"1.1.0"
</span><span style=color:#399ee6>bevy_ecs </span><span>= { </span><span style=color:#399ee6>path </span><span>= </span><span style=color:#86b300>"../bevy_ecs"</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>version </span><span>= </span><span style=color:#86b300>"0.19.0-dev"</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>default-features </span><span>= </span><span style=color:#ff8f40>false </span><span>}
</span><span style=color:#399ee6>bevy_app </span><span>= { </span><span style=color:#399ee6>path </span><span>= </span><span style=color:#86b300>"../bevy_app"</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>version </span><span>= </span><span style=color:#86b300>"0.19.0-dev"</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>default-features </span><span>= </span><span style=color:#ff8f40>false </span><span>}
</span><span style=color:#399ee6>bevy_tasks </span><span>= { </span><span style=color:#399ee6>path </span><span>= </span><span style=color:#86b300>"../bevy_tasks"</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>version </span><span>= </span><span style=color:#86b300>"0.19.0-dev"</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>default-features </span><span>= </span><span style=color:#ff8f40>false </span><span>}
</span></code></pre><p><strong>变更后</strong>:<pre class=language-toml data-lang=toml style=color:#61676c;background-color:#fafafa><code class=language-toml data-lang=toml><span>[</span><span style=color:#399ee6>dev-dependencies</span><span>]
</span><span style=color:#399ee6>static_assertions </span><span>= </span><span style=color:#86b300>"1.1.0"
</span></code></pre><p><strong>影响</strong>: 解决了循环依赖问题，但移除了在示例中使用的这些 crate。<h3 id=2-crates-bevy-utils-src-buffered-channel-rs>2. <code>crates/bevy_utils/src/buffered_channel.rs</code></h3><p><strong>变更说明</strong>: 移除了依赖于被删除开发依赖项的大型使用示例。<p><strong>变更前</strong> (示例代码片段):<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>/// # Usage
</span><span style=color:#abb0b6;font-style:italic>///
</span><span style=color:#abb0b6;font-style:italic>/// ```
</span><span style=color:#abb0b6;font-style:italic>/// use bevy_utils::BufferedChannel;
</span><span style=color:#abb0b6;font-style:italic>/// use bevy_app::{App, TaskPoolPlugin, Update};
</span><span style=color:#abb0b6;font-style:italic>/// use bevy_ecs::system::Local;
</span><span style=color:#abb0b6;font-style:italic>/// use bevy_tasks::ComputeTaskPool;
</span><span style=color:#abb0b6;font-style:italic>///
</span><span style=color:#abb0b6;font-style:italic>/// App::new()
</span><span style=color:#abb0b6;font-style:italic>///     .add_plugins(TaskPoolPlugin::default())
</span><span style=color:#abb0b6;font-style:italic>///     .add_systems(Update, parallel_system)
</span><span style=color:#abb0b6;font-style:italic>///     .update();
</span><span style=color:#abb0b6;font-style:italic>///
</span><span style=color:#abb0b6;font-style:italic>/// // ... 大量示例代码
</span><span style=color:#abb0b6;font-style:italic>/// ```
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>BufferedChannel</span><span>&LTT</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Send</span><span>> {
</span></code></pre><p><strong>变更后</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>BufferedChannel</span><span>&LTT</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Send</span><span>> {
</span></code></pre><p><strong>影响</strong>: <code>BufferedChannel</code> 类型的文档现在没有使用示例，但其核心文档（关于设计目的和工作原理的描述）仍然保留。类型的功能本身没有变化。<h2 id=yan-shen-yue-du>延伸阅读</h2><ol><li><strong>Rust Cargo 文档 - 依赖管理</strong>: https://doc.rust-lang.org/cargo/reference/specifying-dependencies.html<li><strong>循环依赖问题讨论</strong>: https://github.com/rust-lang/cargo/issues/4242<li><strong>Bevy 工程结构</strong>: https://github.com/bevyengine/bevy/blob/main/ARCHITECTURE.md<li><strong>Rust 模块系统最佳实践</strong>: https://doc.rust-lang.org/book/ch07-02-defining-modules-to-control-scope-and-privacy.html</ol><hr><h2 id=wan-zheng-dai-ma-chai-yi>完整代码差异</h2><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_utils/Cargo.toml b/crates/bevy_utils/Cargo.toml
</span><span>index 96d726009c10a..a6f0189d34924 100644
</span><span style=color:#c594c5>--- a/crates/bevy_utils/Cargo.toml
</span><span style=color:#c594c5>+++ b/crates/bevy_utils/Cargo.toml
</span><span style=color:#c594c5>@@ -29,9 +29,6 @@ </span><span style=color:#399ee6>async-channel = { version = "2.3.0", optional = true }
</span><span> 
</span><span> [dev-dependencies]
</span><span> static_assertions = "1.1.0"
</span><span style=color:#f07171>-bevy_ecs = { path = "../bevy_ecs", version = "0.19.0-dev", default-features = false }
</span><span style=color:#f07171>-bevy_app = { path = "../bevy_app", version = "0.19.0-dev", default-features = false }
</span><span style=color:#f07171>-bevy_tasks = { path = "../bevy_tasks", version = "0.19.0-dev", default-features = false }
</span><span> 
</span><span> [lints]
</span><span> workspace = true
</span><span>diff --git a/crates/bevy_utils/src/buffered_channel.rs b/crates/bevy_utils/src/buffered_channel.rs
</span><span>index e717380b7ddfa..f7e0b73fab2a9 100644
</span><span style=color:#c594c5>--- a/crates/bevy_utils/src/buffered_channel.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_utils/src/buffered_channel.rs
</span><span style=color:#c594c5>@@ -13,55 +13,6 @@ </span><span style=color:#399ee6>use core::ops::{Deref, DerefMut};
</span><span> /// tasks. Unlike `Parallel`, this allows you to execute a consuming task while producing tasks are
</span><span> /// concurrently sending data into the channel, enabling you to run a serial processing consumer
</span><span> /// at the same time as many parallel processing producers.
</span><span style=color:#f07171>-///
</span><span style=color:#f07171>-/// # Usage
</span><span style=color:#f07171>-///
</span><span style=color:#f07171>-/// ```
</span><span style=color:#f07171>-/// use bevy_utils::BufferedChannel;
</span><span style=color:#f07171>-/// use bevy_app::{App, TaskPoolPlugin, Update};
</span><span style=color:#f07171>-/// use bevy_ecs::system::Local;
</span><span style=color:#f07171>-/// use bevy_tasks::ComputeTaskPool;
</span><span style=color:#f07171>-///
</span><span style=color:#f07171>-/// App::new()
</span><span style=color:#f07171>-///     .add_plugins(TaskPoolPlugin::default())
</span><span style=color:#f07171>-///     .add_systems(Update, parallel_system)
</span><span style=color:#f07171>-///     .update();
</span><span style=color:#f07171>-///
</span><span style=color:#f07171>-/// fn parallel_system(channel: Local&LTBufferedChannel&LTu64>>) {
</span><span style=color:#f07171>-///     let (rx, tx) = channel.unbounded();
</span><span style=color:#f07171>-///     ComputeTaskPool::get().scope(|scope| {
</span><span style=color:#f07171>-///         // Spawn a single consumer task that reads from the producers. Note we can spawn this
</span><span style=color:#f07171>-///         // first and have it immediately start processing the messages produced in parallel.
</span><span style=color:#f07171>-///         // Because we are receiving asynchronously, we avoid deadlocks even on a single thread.
</span><span style=color:#f07171>-///         scope.spawn(async move {
</span><span style=color:#f07171>-///             let mut total = 0;
</span><span style=color:#f07171>-///             let mut count = 0;
</span><span style=color:#f07171>-///             while let Ok(mut chunk) = rx.recv().await {
</span><span style=color:#f07171>-///                 count += chunk.len();
</span><span style=color:#f07171>-///                 total += chunk.iter().sum::&LTu64>();
</span><span style=color:#f07171>-///             }
</span><span style=color:#f07171>-///             assert_eq!(count, 500_000);
</span><span style=color:#f07171>-///             assert_eq!(total, 24_999_750_000);
</span><span style=color:#f07171>-///         });
</span><span style=color:#f07171>-///
</span><span style=color:#f07171>-///         // Spawn a few producing tasks in parallel that send data into the buffered channel.
</span><span style=color:#f07171>-///         for _ in 0..5 {
</span><span style=color:#f07171>-///             let mut tx = tx.clone();
</span><span style=color:#f07171>-///             scope.spawn(async move {
</span><span style=color:#f07171>-///                 // Because this is buffered, we can iterate over hundreds of thousands of
</span><span style=color:#f07171>-///                 // entities in each task while avoiding allocation and channel overhead.
</span><span style=color:#f07171>-///                 // The buffer is flushed periodically, sending chunks of data to the receiver.
</span><span style=color:#f07171>-///                 for i in 0..100_000 {
</span><span style=color:#f07171>-///                     tx.send(i).await;
</span><span style=color:#f07171>-///                 }
</span><span style=color:#f07171>-///             });
</span><span style=color:#f07171>-///         }
</span><span style=color:#f07171>-///
</span><span style=color:#f07171>-///         // Drop the unused sender so the channel can close.
</span><span style=color:#f07171>-///         drop(tx);
</span><span style=color:#f07171>-///     });
</span><span style=color:#f07171>-/// }
</span><span style=color:#f07171>-/// ```
</span><span> pub struct BufferedChannel&LTT: Send> {
</span><span>     /// The minimum length of a `Vec` of buffered data before it is sent through the channel.
</span><span>     pub chunk_size: usize,
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_23081.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>