<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #23081 remove circular dependency
        
    </title><meta content="#23081 remove circular dependency" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-21</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-02/pr-23081-zh-cn-20260221>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>remove circular dependency<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: remove circular dependency<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/23081<li><strong>Author</strong>: mockersf<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, D-Trivial, S-Ready-For-Final-Review, A-Utils<li><strong>Created</strong>: 2026-02-20T20:57:45Z<li><strong>Merged</strong>: 2026-02-21T00:56:45Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>#22297 introduced circular dependencies that would make it impossible to release Bevy</ul><h2 id=solution>Solution</h2><ul><li>Remove it</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a straightforward but critical issue in the Bevy engine’s build system: a circular dependency that was blocking the project’s ability to release new versions. The problem originated from PR #22297, which unintentionally created a dependency cycle between <code>bevy_utils</code> and other core Bevy crates.<p>Circular dependencies in Rust workspaces create problems for the build system and can prevent publishing crates to crates.io. When multiple crates depend on each other in a cycle, the build tool cannot determine a valid compilation order, and cargo publish operations fail because each crate requires the others to already be published.<p>The issue was located in the <code>bevy_utils</code> crate, which had added development dependencies on three other Bevy crates: <code>bevy_ecs</code>, <code>bevy_app</code>, and <code>bevy_tasks</code>. These dev-dependencies were only used for documentation examples, specifically in the <code>buffered_channel.rs</code> file’s doc comment. However, since <code>bevy_ecs</code>, <code>bevy_app</code>, and <code>bevy_tasks</code> themselves depend on <code>bevy_utils</code>, this created a circular dependency chain during development builds.<p>The solution was direct and practical: remove the problematic dependencies and the documentation example that required them. The PR author took the simplest approach to resolve the blocking issue, prioritizing build system health over preserving the example. While the example provided valuable context for using <code>BufferedChannel</code> within Bevy’s task system, its removal was necessary to maintain the project’s ability to release.<p>This type of circular dependency issue is common in large Rust workspaces where examples and tests need to demonstrate integration between crates. The typical trade-off is between comprehensive documentation and clean dependency graphs. In this case, the release-blocking nature of the circular dependency made the decision straightforward.<p>From a technical perspective, the fix involved two key changes:<ol><li>Removing the three dev-dependencies from <code>Cargo.toml</code><li>Removing the comprehensive usage example from the <code>BufferedChannel</code> documentation</ol><p>The removal of 49 lines of example code might seem significant, but it only affects documentation, not the actual functionality of the <code>BufferedChannel</code>. The struct remains fully functional and available for use, just without the illustrative example showing integration with Bevy’s task system.<p>This PR demonstrates an important principle in managing Rust workspaces: documentation and examples should not create hard dependencies that compromise the build system. Alternative approaches could have included moving the example to integration tests or using feature flags, but for a straightforward release-blocking issue, the direct removal was the most pragmatic solution.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[bevy_utils] --> B[Previous Dev Dependencies]
</span><span>    B --> C[bevy_ecs]
</span><span>    B --> D[bevy_app]
</span><span>    B --> E[bevy_tasks]
</span><span>    C --> A
</span><span>    D --> A
</span><span>    E --> A
</span><span>    
</span><span>    F[Circular Dependency Created]
</span><span>    A --> F
</span><span>    F --> C
</span><span>    C --> F
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-utils-cargo-toml-0-3><code>crates/bevy_utils/Cargo.toml</code> (+0/-3)</h3><p>This change removed three development dependencies that were creating the circular dependency.<p>Before:<pre class=language-toml data-lang=toml style=color:#61676c;background-color:#fafafa><code class=language-toml data-lang=toml><span>[</span><span style=color:#399ee6>dev-dependencies</span><span>]
</span><span style=color:#399ee6>static_assertions </span><span>= </span><span style=color:#86b300>"1.1.0"
</span><span style=color:#399ee6>bevy_ecs </span><span>= { </span><span style=color:#399ee6>path </span><span>= </span><span style=color:#86b300>"../bevy_ecs"</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>version </span><span>= </span><span style=color:#86b300>"0.19.0-dev"</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>default-features </span><span>= </span><span style=color:#ff8f40>false </span><span>}
</span><span style=color:#399ee6>bevy_app </span><span>= { </span><span style=color:#399ee6>path </span><span>= </span><span style=color:#86b300>"../bevy_app"</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>version </span><span>= </span><span style=color:#86b300>"0.19.0-dev"</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>default-features </span><span>= </span><span style=color:#ff8f40>false </span><span>}
</span><span style=color:#399ee6>bevy_tasks </span><span>= { </span><span style=color:#399ee6>path </span><span>= </span><span style=color:#86b300>"../bevy_tasks"</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>version </span><span>= </span><span style=color:#86b300>"0.19.0-dev"</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>default-features </span><span>= </span><span style=color:#ff8f40>false </span><span>}
</span></code></pre><p>After:<pre class=language-toml data-lang=toml style=color:#61676c;background-color:#fafafa><code class=language-toml data-lang=toml><span>[</span><span style=color:#399ee6>dev-dependencies</span><span>]
</span><span style=color:#399ee6>static_assertions </span><span>= </span><span style=color:#86b300>"1.1.0"
</span></code></pre><h3 id=crates-bevy-utils-src-buffered-channel-rs-0-49><code>crates/bevy_utils/src/buffered_channel.rs</code> (+0/-49)</h3><p>This change removed a large documentation example that was using the removed dev-dependencies to demonstrate how <code>BufferedChannel</code> works with Bevy’s task system.<p>The removed code was a comprehensive example showing:<ul><li>How to use <code>BufferedChannel</code> with Bevy’s <code>TaskPoolPlugin</code><li>Integration with <code>bevy_ecs</code> systems<li>Usage of <code>bevy_tasks::ComputeTaskPool</code> for parallel processing<li>A complete example of producer-consumer pattern using the channel</ul><p>The example spanned 55 lines (from line 13 to line 67 in the original file) and included detailed comments about the benefits of buffered channels for parallel processing with serial consumers.<h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/cargo/reference/workspaces.html target=_blank>Rust Cargo Workspaces Documentation</a> - Understanding how Rust manages multi-crate projects<li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/cargo/guide/dependencies.html target=_blank>Circular Dependencies in Rust</a> - How to avoid and resolve circular dependencies<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/introduction/ target=_blank>Bevy Engine Architecture</a> - Understanding Bevy’s modular crate structure<li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/rustdoc/write-documentation/documentation-tests.html target=_blank>Rust Doc-test Documentation</a> - How documentation examples work as tests<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/pull/22297 target=_blank>PR #22297</a> - The original PR that introduced the circular dependency</ol><h1 id=full-code-diff>Full Code Diff</h1><p>diff –git a/crates/bevy_utils/Cargo.toml b/crates/bevy_utils/Cargo.toml index 96d726009c10a..a6f0189d34924 100644 — a/crates/bevy_utils/Cargo.toml +++ b/crates/bevy_utils/Cargo.toml @@ -29,9 +29,6 @@ async-channel = { version = “2.3.0”, optional = true }<p>[dev-dependencies] static_assertions = “1.1.0” -bevy_ecs = { path = “../bevy_ecs”, version = “0.19.0-dev”, default-features = false } -bevy_app = { path = “../bevy_app”, version = “0.19.0-dev”, default-features = false } -bevy_tasks = { path = “../bevy_tasks”, version = “0.19.0-dev”, default-features = false }<p>[lints] workspace = true diff –git a/crates/bevy_utils/src/buffered_channel.rs b/crates/bevy_utils/src/buffered_channel.rs index e717380b7ddfa..f7e0b73fab2a9 100644 — a/crates/bevy_utils/src/buffered_channel.rs +++ b/crates/bevy_utils/src/buffered_channel.rs @@ -13,55 +13,6 @@ use core::ops::{Deref, DerefMut}; /// tasks. Unlike <code>Parallel</code>, this allows you to execute a consuming task while producing tasks are /// concurrently sending data into the channel, enabling you to run a serial processing consumer /// at the same time as many parallel processing producers. -/// -/// # Usage -/// -/// <code>-/// use bevy_utils::BufferedChannel; -/// use bevy_app::{App, TaskPoolPlugin, Update}; -/// use bevy_ecs::system::Local; -/// use bevy_tasks::ComputeTaskPool; -/// -/// App::new() -///     .add_plugins(TaskPoolPlugin::default()) -///     .add_systems(Update, parallel_system) -///     .update(); -/// -/// fn parallel_system(channel: Local&LTBufferedChannel&LTu64>>) { -///     let (rx, tx) = channel.unbounded(); -///     ComputeTaskPool::get().scope(|scope| { -///         // Spawn a single consumer task that reads from the producers. Note we can spawn this -///         // first and have it immediately start processing the messages produced in parallel. -///         // Because we are receiving asynchronously, we avoid deadlocks even on a single thread. -///         scope.spawn(async move { -///             let mut total = 0; -///             let mut count = 0; -///             while let Ok(mut chunk) = rx.recv().await { -///                 count += chunk.len(); -///                 total += chunk.iter().sum::&LTu64>(); -///             } -///             assert_eq!(count, 500_000); -///             assert_eq!(total, 24_999_750_000); -///         }); -/// -///         // Spawn a few producing tasks in parallel that send data into the buffered channel. -///         for _ in 0..5 { -///             let mut tx = tx.clone(); -///             scope.spawn(async move { -///                 // Because this is buffered, we can iterate over hundreds of thousands of -///                 // entities in each task while avoiding allocation and channel overhead. -///                 // The buffer is flushed periodically, sending chunks of data to the receiver. -///                 for i in 0..100_000 { -///                     tx.send(i).await; -///                 } -///             }); -///         } -/// -///         // Drop the unused sender so the channel can close. -///         drop(tx); -///     }); -/// } -///</code> pub struct BufferedChannel&LTT: Send> { /// The minimum length of a <code>Vec</code> of buffered data before it is sent through the channel. pub chunk_size: usize,</div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_23081.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>