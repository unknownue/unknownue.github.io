<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22767 Add per-entity NoCpuCulling
        
    </title><meta content="#22767 Add per-entity NoCpuCulling" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-04</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2026-02/pr-22767-en-20260204>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=wei-shi-ti-tian-jia-nocpuculling-zu-jian>为实体添加 NoCpuCulling 组件</h1><h2 id=ji-ben-xin-xi>基本信息</h2><ul><li><strong>标题</strong>: Add per-entity NoCpuCulling<li><strong>PR 链接</strong>: https://github.com/bevyengine/bevy/pull/22767<li><strong>作者</strong>: Lampan-git<li><strong>状态</strong>: 已合并<li><strong>标签</strong>: C-Feature, A-Rendering, S-Ready-For-Final-Review, D-Straightforward<li><strong>创建时间</strong>: 2026-02-01T17:12:34Z<li><strong>合并时间</strong>: 2026-02-04T17:02:11Z<li><strong>合并者</strong>: alice-i-cecile</ul><h2 id=miao-shu-fan-yi>描述翻译</h2><h1 id=mu-biao>目标</h1><ul><li>我使用计算着色器（compute shader）更新某些实体的变换（transforms）并直接将其写入 MeshInput，而不回读（readback）到 CPU。这导致了一个副作用：主世界中的变换位置始终为 (0,0)，然后在 CPU 侧被视锥体剔除（frustum culled）。目前无法为每个实体禁用 CPU 剔除，因此有了这个 PR。</ul><h2 id=jie-jue-fang-an>解决方案</h2><ul><li>在 visible_aabb_query 中使用与 view_query 相同的 <code>Has&LTNoCpuCulling></code></ul><h2 id=ce-shi>测试</h2><p>我在 RenderDoc 中检查了 VkDrawIndexedIndirectCommand 的 instanceCount，结果显示与不使用 NoCpuCulling 时数量相同，且低于使用 NoFrustumCulling 时的数量。在远离中心观察时也能正常工作。<p>请注意，这是我第一次真正的贡献，并且我没有实际的渲染经验。<h2 id=zhe-ge-pull-request-de-gu-shi>这个 Pull Request 的故事</h2><p>这个 PR 源于一个具体的技术需求：开发者使用计算着色器直接在 GPU 上更新实体变换，绕过 CPU 的数据流。这种优化方法在避免 CPU-GPU 数据传输开销的同时，也带来了一个副作用：CPU 侧的变换数据变得陈旧，导致错误的视锥体剔除。<p>问题出现在渲染系统的可见性检查环节。Bevy 的渲染管线默认会在 CPU 侧执行视锥体剔除，以优化 GPU 的绘制调用。然而，当实体变换完全在 GPU 上计算时（例如通过计算着色器直接写入 MeshInputUniform 的 world_from_local），CPU 侧的变换数据（存储在 GlobalTransform 组件中）就不再反映真实情况。这些陈旧的变换数据通常是初始值（如 (0,0,0)），导致实体在视锥体检查中被错误地剔除，即使它们在 GPU 上是正确变换并可见的。<p>为了解决这个问题，PR 作者选择扩展现有的 NoCpuCulling 组件功能。原本这个组件只能附加到相机（Camera）上，禁用该相机视角下所有实体的 CPU 侧剔除。现在，通过将这个组件也附加到单个实体上，开发者可以更精细地控制哪些实体需要跳过 CPU 剔除。<p>从技术实现角度看，这个改动很小但很有针对性。核心思路是修改 <code>check_visibility</code> 函数中的两个查询（queries）：<ol><li><strong>view_query</strong>：已经包含了相机的 NoCpuCulling 状态<li><strong>visible_aabb_query</strong>：现在也包含实体的 NoCpuCulling 状态</ol><p>关键的变化逻辑在视锥体检查的条件判断中。原来的代码只检查相机的 NoCpuCulling 状态：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>no_frustum_culling
</span><span>    </span><span style=color:#ed9366>&& !</span><span>no_cpu_culling
</span><span>    </span><span style=color:#ed9366>&& </span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(model_aabb) </span><span style=color:#ed9366>=</span><span> maybe_model_aabb
</span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 执行视锥体剔除
</span><span>}
</span></code></pre><p>现在增加了对实体 NoCpuCulling 状态的检查：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>no_frustum_culling
</span><span>    </span><span style=color:#ed9366>&& !</span><span>no_cpu_culling_camera
</span><span>    </span><span style=color:#ed9366>&& !</span><span>no_cpu_culling_entity
</span><span>    </span><span style=color:#ed9366>&& </span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(model_aabb) </span><span style=color:#ed9366>=</span><span> maybe_model_aabb
</span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 执行视锥体剔除
</span><span>}
</span></code></pre><p>这意味着如果相机或实体中的任何一个拥有 NoCpuCulling 组件，该实体就会跳过 CPU 侧的视锥体剔除。这种设计保持了向后兼容性：现有的仅将 NoCpuCulling 附加到相机的用法继续有效，同时为需要更精细控制的场景提供了新选项。<p>这个实现体现了 Bevy ECS 系统的灵活性。通过将 NoCpuCulling 作为标记组件（marker component），系统可以高效地查询和过滤实体。<code>Has&LTNoCpuCulling></code> 查询确保只有拥有该组件的实体才会被标记，避免了不必要的存储开销。<p>从架构角度看，这个改动符合 Bevy 的设计哲学：通过组件组合来实现功能。NoCpuCulling 组件现在可以在两个层级上工作：<ul><li>相机层级：影响该相机视野内的所有实体<li>实体层级：仅影响特定实体</ul><p>这种分层控制为开发者提供了更大的灵活性。例如，一个场景可以有一个禁用所有 CPU 剔除的调试相机，同时让游戏相机只对 GPU 变换的实体禁用 CPU 剔除。<p>性能方面，这个改动的影响很小。增加的只是一个简单的布尔检查，而可见性检查已经是渲染管线中相对昂贵的部分（需要计算轴对齐边界框和视锥体相交测试）。对于使用 GPU 变换的实体，跳过 CPU 剔除避免了错误剔除导致的渲染问题，这可能实际上提高了性能，因为原本会被错误剔除的实体现在能够正确渲染。<p>值得注意的是，PR 作者在描述中提到的测试方法很专业：使用 RenderDoc 检查 VkDrawIndexedIndirectCommand 的 instanceCount。这是验证渲染正确性的有效方法，因为 instanceCount 直接反映了最终被绘制的实例数量，可以确认实体是否被正确剔除或保留。<h2 id=ke-shi-hua-biao-shi>可视化表示</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[相机 Camera] --> B{相机有 NoCpuCulling?}
</span><span>    B -->|是| C[跳过所有实体的CPU剔除]
</span><span>    B -->|否| D[检查每个实体]
</span><span>    
</span><span>    D --> E[实体 Entity]
</span><span>    E --> F{实体有 NoCpuCulling?}
</span><span>    F -->|是| G[跳过该实体的CPU剔除]
</span><span>    F -->|否| H[执行CPU视锥体剔除]
</span><span>    
</span><span>    C --> I[进入GPU剔除阶段]
</span><span>    G --> I
</span><span>    H -->|通过| I
</span><span>    H -->|未通过| J[实体被剔除]
</span></code></pre><h2 id=guan-jian-wen-jian-geng-gai>关键文件更改</h2><h3 id=crates-bevy-camera-src-visibility-mod-rs-12-2><code>crates/bevy_camera/src/visibility/mod.rs</code> (+12/-2)</h3><p>这个文件包含了 Bevy 的可见性系统，负责管理相机、实体可见性和各种剔除技术。<p><strong>主要更改：</strong><ol><li>为 <code>NoCpuCulling</code> 组件添加了文档注释，说明其现在可以附加到相机或单个实体上<li>修改 <code>check_visibility</code> 系统，使实体级别的 NoCpuCulling 能够工作</ol><p><strong>代码片段：</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 文档注释添加：
</span><span style=color:#abb0b6;font-style:italic>/// Use this component to opt-out of the built-in CPU frustum culling, see
</span><span style=color:#abb0b6;font-style:italic>/// [`Frustum`]. This can be attached to a [`Camera`] or to individual entities.
</span><span style=color:#abb0b6;font-style:italic>///
</span><span style=color:#abb0b6;font-style:italic>/// It can be used for example:
</span><span style=color:#abb0b6;font-style:italic>/// - disabling CPU culling completely for a [`Camera`], using only GPU culling.
</span><span style=color:#abb0b6;font-style:italic>/// - when overwriting a [`Mesh`]'s transform on the GPU side (e.g. overwriting `MeshInputUniform`'s
</span><span style=color:#abb0b6;font-style:italic>///   `world_from_local`), resulting in stale CPU-side positions.
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component</span><span style=color:#61676ccc>,</span><span> Default)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>NoCpuCulling</span><span style=color:#61676ccc>;
</span></code></pre><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 查询修改：为实体查询添加 Has&LTNoCpuCulling>
</span><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>(
</span><span>    </span><span style=color:#ed9366>&</span><span>GlobalTransform</span><span style=color:#61676ccc>,
</span><span>    Has&LTNoFrustumCulling></span><span style=color:#61676ccc>,
</span><span>    Has&LTVisibilityRange></span><span style=color:#61676ccc>,
</span><span>)
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>(
</span><span>    </span><span style=color:#ed9366>&</span><span>GlobalTransform</span><span style=color:#61676ccc>,
</span><span>    Has&LTNoFrustumCulling></span><span style=color:#61676ccc>,
</span><span>    Has&LTVisibilityRange></span><span style=color:#61676ccc>,
</span><span>    Has&LTNoCpuCulling></span><span style=color:#61676ccc>,
</span><span>)
</span></code></pre><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 可见性检查逻辑修改：
</span><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>no_frustum_culling
</span><span>    </span><span style=color:#ed9366>&& !</span><span>no_cpu_culling
</span><span>    </span><span style=color:#ed9366>&& </span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(model_aabb) </span><span style=color:#ed9366>=</span><span> maybe_model_aabb
</span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// frustum culling logic
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>no_frustum_culling
</span><span>    </span><span style=color:#ed9366>&& !</span><span>no_cpu_culling_camera  </span><span style=color:#abb0b6;font-style:italic>// 相机级别的检查
</span><span>    </span><span style=color:#ed9366>&& !</span><span>no_cpu_culling_entity  </span><span style=color:#abb0b6;font-style:italic>// 实体级别的检查
</span><span>    </span><span style=color:#ed9366>&& </span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(model_aabb) </span><span style=color:#ed9366>=</span><span> maybe_model_aabb
</span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// frustum culling logic
</span><span>}
</span></code></pre><h2 id=jin-yi-bu-yue-du>进一步阅读</h2><ol><li><strong>Bevy 渲染管线文档</strong>：了解 Bevy 的渲染架构和可见性系统<li><strong>GPU 驱动的渲染技术</strong>：学习如何使用计算着色器进行变换更新<li><strong>视锥体剔除算法</strong>：理解各种剔除技术的原理和实现<li><strong>现代图形 API（Vulkan/DirectX 12）</strong>：了解间接绘制命令（indirect draw commands）和 GPU 剔除<li><strong>Bevy ECS 查询系统</strong>：掌握 Bevy 的组件查询和过滤机制</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_22767.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>