<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22725 Don't consider despawns as invalidating `EntityWorldMut`
        
    </title><meta content="#22725 Don't consider despawns as invalidating `EntityWorldMut`" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-03</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-02/pr-22725-zh-cn-20260203>中文</a></div></div><div class=pr-content><h1 id=title-don-t-consider-despawns-as-invalidating-entityworldmut>Title: Don’t consider despawns as invalidating <code>EntityWorldMut</code></h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Don’t consider despawns as invalidating <code>EntityWorldMut</code><li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22725<li><strong>Author</strong>: ElliottjPierce<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-ECS, C-Usability, S-Ready-For-Final-Review, P-Regression, X-Contentious<li><strong>Created</strong>: 2026-01-27T19:57:50Z<li><strong>Merged</strong>: 2026-02-02T23:35:46Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>#19451 changed how entities handle spawning and despawning. One of those changes introduced the idea that despawning an entity from commands while holding an <code>EntityWorldMut</code> of that entity made that <code>EntityWorldMut</code> invalid and panicked when that happened.<p>Fixes #19828.<h2 id=solution>Solution</h2><p>Handle these despawns in the same way as despawning without freeing. This means an <code>EntityWorldMut</code> can no longer assume its <code>EntityId</code> is valid; it can not assume that its generation is up to date. AFAIK, this restriction doesn’t introduce any new or exciting ways for this to fail. It just delays the panics for some cases. For example, despawning from commands and then attempting an insert will panic later (at the insert) instead of earlier (at the despawn).<h2 id=testing>Testing</h2><ul><li>CI</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a regression introduced in PR #19451 that affected how <code>EntityWorldMut</code> handles entity despawning. The core problem was that when an entity was despawned via commands while an <code>EntityWorldMut</code> reference to that entity was still alive, the system would immediately panic, considering the <code>EntityWorldMut</code> invalid. This caused issues particularly in observer systems and component hooks where entities might be despawned as part of their own initialization logic.<p>The issue was reported in #19828, where developers encountered panics when despawning entities within <code>on_add</code> hooks. These hooks receive an <code>EntityWorldMut</code>, and if they despawn the entity via commands, the previous implementation would immediately panic, making certain patterns impossible to implement.<p>The solution approach was to change the despawn handling to match the behavior of “despawning without freeing.” Instead of immediately invalidating <code>EntityWorldMut</code> when a despawn command is queued, the system now allows the <code>EntityWorldMut</code> to continue existing but marks it as despawned. The entity’s location information becomes <code>None</code>, and subsequent operations on the despawned entity will panic when attempted, rather than at the moment of despawn.<p>This change required updating several key components. In <code>world/entity_access/world_mut.rs</code>, the <code>EntityWorldMut::new</code> method’s safety requirements were relaxed to allow creation with <code>None</code> location for despawned entities. The <code>update_location</code> method was updated to use <code>get_spawned()</code> instead of <code>get()</code>, which returns <code>None</code> for despawned entities rather than panicking. Documentation was also added to clarify that <code>EntityWorldMut</code> may point to despawned entities and that developers should check <code>is_despawned()</code> before trusting the entity state.<p>In <code>world/mod.rs</code>, the <code>spawn_non_existent</code> method was updated to handle the case where commands might have despawned the entity during its own spawning process. Instead of assuming the entity must still exist after flushing commands, it now uses <code>get_spawned()</code> which gracefully handles despawned entities.<p>Several dynamic bundle implementations in <code>spawn.rs</code> and <code>observe.rs</code> were updated to add early returns when encountering despawned entities. This prevents attempting to perform operations on entities that were despawned by hooks or observers during the spawning process. These checks are particularly important in observer systems where entity despawning might be triggered by component additions.<p>The technical insight here is that this change shifts the panic from the despawn operation to the subsequent invalid operation. While this doesn’t eliminate the panic entirely, it provides more flexibility in patterns where entities might be despawned as part of their initialization. Developers can now check <code>is_despawned()</code> and handle the case appropriately, whereas before the panic was immediate and unavoidable.<p>This change maintains the safety guarantees of the ECS system while improving usability. The trade-off is that developers now need to be more aware that <code>EntityWorldMut</code> might point to despawned entities, particularly when working with observers and hooks that might despawn entities. The added documentation helps guide developers toward proper usage patterns.<p>The impact of this change is that certain patterns that were previously impossible due to immediate panics now become possible. For example, components can have <code>on_add</code> hooks that conditionally despawn entities based on game logic. However, developers must now be cautious about using <code>EntityWorldMut</code> after operations that might trigger despawning, and should check <code>is_despawned()</code> when uncertain about the entity’s state.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[EntityWorldMut Creation] --> B{Entity Spawned?}
</span><span>    B -->|Yes| C[Location = Some]
</span><span>    B -->|No| D[Location = None]
</span><span>    C --> E[Operations Allowed]
</span><span>    D --> F[Operations Panic]
</span><span>    
</span><span>    G[Command Despawn] --> H[Entity Marked Despawned]
</span><span>    H --> I[EntityWorldMut Location = None]
</span><span>    I --> F
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ol><li><strong><code>crates/bevy_ecs/src/world/entity_access/world_mut.rs</code></strong> (+24/-7) <ul><li>Updated <code>EntityWorldMut::new</code> to accept <code>None</code> location for despawned entities<li>Changed <code>update_location</code> to use <code>get_spawned()</code> instead of <code>get()</code><li>Added documentation about despawned entity handling</ul></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// File: crates/bevy_ecs/src/world/entity_access/world_mut.rs
</span><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>unsafe fn </span><span style=color:#f29718>new</span><span>(
</span><span>    </span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'w mut</span><span> World,
</span><span>    </span><span style=color:#ff8f40>entity</span><span style=color:#61676ccc>:</span><span> Entity,
</span><span>    </span><span style=color:#ff8f40>location</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTEntityLocation>,
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>    </span><span style=color:#f07171>debug_assert!</span><span>(world</span><span style=color:#ed9366>.</span><span style=color:#f07171>entities</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>contains</span><span>(entity))</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#f07171>debug_assert_eq!</span><span>(world</span><span style=color:#ed9366>.</span><span style=color:#f07171>entities</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(entity)</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>,</span><span> location)</span><span style=color:#61676ccc>;
</span><span>
</span><span>    EntityWorldMut {
</span><span>        world</span><span style=color:#61676ccc>,
</span><span>        entity</span><span style=color:#61676ccc>,
</span><span>        location</span><span style=color:#61676ccc>,
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>unsafe fn </span><span style=color:#f29718>new</span><span>(
</span><span>    </span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'w mut</span><span> World,
</span><span>    </span><span style=color:#ff8f40>entity</span><span style=color:#61676ccc>:</span><span> Entity,
</span><span>    </span><span style=color:#ff8f40>location</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTEntityLocation>,
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>    </span><span style=color:#f07171>debug_assert_eq!</span><span>(world</span><span style=color:#ed9366>.</span><span style=color:#f07171>entities</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_spawned</span><span>(entity)</span><span style=color:#ed9366>.</span><span style=color:#f07171>ok</span><span>()</span><span style=color:#61676ccc>,</span><span> location)</span><span style=color:#61676ccc>;
</span><span>
</span><span>    EntityWorldMut {
</span><span>        world</span><span style=color:#61676ccc>,
</span><span>        entity</span><span style=color:#61676ccc>,
</span><span>        location</span><span style=color:#61676ccc>,
</span><span>    }
</span><span>}
</span></code></pre><ol start=2><li><strong><code>crates/bevy_ecs/src/world/entity_access/mod.rs</code></strong> (+28/-0) <ul><li>Added tests for the new despawn behavior<li>Test <code>command_despawns_dont_invalidate_entity_world_muts</code> verifies the fix<li>Test <code>using_despawned_entity_world_mut_panics</code> ensures safety</ul></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// File: crates/bevy_ecs/src/world/entity_access/mod.rs
</span><span style=color:#abb0b6;font-style:italic>// Added test:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>command_despawns_dont_invalidate_entity_world_muts</span><span>() {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> world </span><span style=color:#ed9366>= </span><span>World</span><span style=color:#ed9366>::</span><span>new()</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> entity </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>(TestComponent(</span><span style=color:#ff8f40>1</span><span>))</span><span style=color:#61676ccc>;
</span><span>    entity</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(DespawnOnAdd)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#f07171>assert!</span><span>(entity</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_despawned</span><span>())</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><ol start=3><li><strong><code>crates/bevy_ecs/src/spawn.rs</code></strong> (+11/-3) <ul><li>Added early returns in <code>SpawnRelatedBundle</code> and <code>SpawnOneRelated</code> when entity is despawned<li>Prevents attempting to spawn related entities for despawned parents</ul></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// File: crates/bevy_ecs/src/spawn.rs
</span><span style=color:#abb0b6;font-style:italic>// Added check in SpawnRelatedBundle::get_components:
</span><span style=color:#fa6e32>if</span><span> entity</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_despawned</span><span>() {
</span><span>    </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><ol start=4><li><strong><code>crates/bevy_ecs/src/world/mod.rs</code></strong> (+3/-5) <ul><li>Updated <code>spawn_non_existent</code> to handle despawned entities after command flush<li>Uses <code>get_spawned()</code> instead of panicking <code>get()</code></ul></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// File: crates/bevy_ecs/src/world/mod.rs
</span><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>entity_location </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>entities</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(entity)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>expect</span><span>(</span><span style=color:#86b300>"For this to fail, a queued command would need to despawn the entity."</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>entity_location </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>entities</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_spawned</span><span>(entity)</span><span style=color:#ed9366>.</span><span style=color:#f07171>ok</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><ol start=5><li><strong><code>crates/bevy_ui_widgets/src/observe.rs</code></strong> (+4/-0) <ul><li>Added despawn check in observer bundle to avoid using despawned entities</ul></ol><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_ecs/latest/bevy_ecs/world/struct.EntityRef.html target=_blank>Bevy ECS Entity Reference Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/examples/ecs/observer.rs target=_blank>Observer Patterns in Bevy ECS</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_ecs/latest/bevy_ecs/system/struct.Commands.html target=_blank>Entity Commands and Deferred World Operations</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/issues/19828 target=_blank>Original Issue #19828</a></ul><h1 id=full-code-diff>Full Code Diff</h1><details><summary>Click to expand full code diff</summary> <pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_ecs/src/bundle/mod.rs b/crates/bevy_ecs/src/bundle/mod.rs
</span><span>index f7cd9996b2853..a18cad21f052f 100644
</span><span style=color:#c594c5>--- a/crates/bevy_ecs/src/bundle/mod.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_ecs/src/bundle/mod.rs
</span><span style=color:#c594c5>@@ -287,6 +287,8 @@ </span><span style=color:#399ee6>pub trait DynamicBundle: Sized {
</span><span>     ///  - If any part of `ptr` is to be accessed in this function, it must *not* be dropped at any point in
</span><span>     ///    `get_components`. Calling [`bevy_ptr::deconstruct_moving_ptr`] in `get_components` automatically
</span><span>     ///    ensures this is the case.
</span><span style=color:#86b300>+    ///  - Note that `entity` may already have been despawned by hooks or observers at this point,
</span><span style=color:#86b300>+    ///    so check [`EntityWorldMut::is_spawned`] before trusting it.
</span><span>     ///
</span><span>     /// [`World`]: crate::world::World
</span><span>     // This function explicitly uses `MovingPtr` to avoid potentially large stack copies of the bundle
</span><span>diff --git a/crates/bevy_ecs/src/spawn.rs b/crates/bevy_ecs/src/spawn.rs
</span><span>index 7f14c08e11a0c..56a53f3550aeb 100644
</span><span style=color:#c594c5>--- a/crates/bevy_ecs/src/spawn.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_ecs/src/spawn.rs
</span><span style=color:#c594c5>@@ -336,12 +336,16 @@ </span><span style=color:#399ee6>impl&LTR: Relationship, L: SpawnableList&LTR>> DynamicBundle for SpawnRelatedBundle<
</span><span>         // SAFETY: The value was not moved out in `get_components`, only borrowed, and thus should still
</span><span>         // be valid and initialized.
</span><span>         let effect = unsafe { ptr.assume_init() };
</span><span style=color:#86b300>+        bevy_ptr::deconstruct_moving_ptr!({
</span><span style=color:#86b300>+            let Self { list, marker: _ } = effect;
</span><span style=color:#86b300>+        });
</span><span>         let id = entity.id();
</span><span> 
</span><span style=color:#86b300>+        if entity.is_despawned() {
</span><span style=color:#86b300>+            return;
</span><span style=color:#86b300>+        }
</span><span style=color:#86b300>+
</span><span>         entity.world_scope(|world: &mut World| {
</span><span style=color:#f07171>-            bevy_ptr::deconstruct_moving_ptr!({
</span><span style=color:#f07171>-                let Self { list, marker: _ } = effect;
</span><span style=color:#f07171>-            });
</span><span>             L::spawn(list, world, id);
</span><span>         });
</span><span>     }
</span><span style=color:#c594c5>@@ -381,6 +385,10 @@ </span><span style=color:#399ee6>impl&LTR: Relationship, B: Bundle> DynamicBundle for SpawnOneRelated&LTR, B> {
</span><span>         // SAFETY: The value was not moved out in `get_components`, only borrowed, and thus should still
</span><span>         // be valid and initialized.
</span><span>         let effect = unsafe { ptr.assume_init() };
</span><span style=color:#86b300>+        if entity.is_despawned() {
</span><span style=color:#86b300>+            return;
</span><span style=color:#86b300>+        }
</span><span style=color:#86b300>+
</span><span>         let effect = effect.read();
</span><span>         entity.with_related::&LTR>(effect.bundle);
</span><span>     }
</span><span>diff --git a/crates/bevy_ecs/src/world/entity_access/mod.rs b/crates/bevy_ecs/src/world/entity_access/mod.rs
</span><span>index cc1bd85449761..53bd06feb7e53 100644
</span><span style=color:#c594c5>--- a/crates/bevy_ecs/src/world/entity_access/mod.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_ecs/src/world/entity_access/mod.rs
</span><span style=color:#c594c5>@@ -44,6 +44,14 @@ </span><span style=color:#399ee6>mod tests {
</span><span>     #[derive(Component)]
</span><span>     struct Marker;
</span><span> 
</span><span style=color:#86b300>+    #[derive(Component)]
</span><span style=color:#86b300>+    #[component(on_add = despawn_on_add)]
</span><span style=color:#86b300>+    struct DespawnOnAdd;
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+    fn despawn_on_add(mut world: DeferredWorld, HookContext { entity, .. }: HookContext) {
</span><span style=color:#86b300>+        world.commands().entity(entity).despawn();
</span><span style=color:#86b300>+    }
</span><span style=color:#86b300>+
</span><span>     #[test]
</span><span>     fn entity_ref_get_by_id() {
</span><span>         let mut world = World::new();
</span><span style=color:#c594c5>@@ -1404,6 +1412,26 @@ </span><span style=color:#399ee6>mod tests {
</span><span>         assert_eq!(world.entity(entity_b).get::&LTD>(), Some(&D));
</span><span>     }
</span><span> 
</span><span style=color:#86b300>+    #[test]
</span><span style=color:#86b300>+    fn command_despawns_dont_invalidate_entity_world_muts() {
</span><span style=color:#86b300>+        let mut world = World::new();
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+        let mut entity = world.spawn(TestComponent(1));
</span><span style=color:#86b300>+        entity.insert(DespawnOnAdd);
</span><span style=color:#86b300>+        assert!(entity.is_despawned());
</span><span style=color:#86b300>+    }
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+    #[test]
</span><span style=color:#86b300>+    #[should_panic]
</span><span style=color:#86b300>+    fn using_despawned_entity_world_mut_panics() {
</span><span style=color:#86b300>+        let mut world = World::new();
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+        let mut entity = world.spawn(TestComponent(1));
</span><span style=color:#86b300>+        entity.insert(DespawnOnAdd);
</span><span style=color:#86b300>+        assert!(entity.is_despawned());
</span><span style=color:#86b300>+        entity.insert(TestComponent2(2));
</span><span style=color:#86b300>+    }
</span><span style=color:#86b300>+
</span><span>     #[test]
</span><span>     fn update_despawned_by_after_observers() {
</span><span>         let mut world = World::new();
</span><span>diff --git a/crates/bevy_ecs/src/world/entity_access/world_mut.rs b/crates/bevy_ecs/src/world/entity_access/world_mut.rs
</span><span>index a676a9f52b62d..822e0c06a5450 100644
</span><span style=color:#c594c5>--- a/crates/bevy_ecs/src/world/entity_access/world_mut.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_ecs/src/world/entity_access/world_mut.rs
</span><span style=color:#c594c5>@@ -39,6 +39,17 @@ </span><span style=color:#399ee6>use core::{any::TypeId, marker::PhantomData, mem::MaybeUninit};
</span><span> /// See also [`EntityMut`], which allows disjoint mutable access to multiple
</span><span> /// entities at once.  Unlike `EntityMut`, this type allows adding and
</span><span> /// removing components, and despawning the entity.
</span><span style=color:#86b300>+///
</span><span style=color:#86b300>+/// # Invariants and Risk
</span><span style=color:#86b300>+///
</span><span style=color:#86b300>+/// An [`EntityWorldMut`] may point to a despawned entity.
</span><span style=color:#86b300>+/// You can check this via [`is_despawned`](Self::is_despawned).
</span><span style=color:#86b300>+/// Using an [`EntityWorldMut`] of a despawned entity may panic in some contexts, so read method documentation carefully.
</span><span style=color:#86b300>+///
</span><span style=color:#86b300>+/// Unless you have strong reason to assume these invariants, you should generally avoid keeping an [`EntityWorldMut`] to an entity that is potentially not spawned.
</span><span style=color:#86b300>+/// For example, when inserting a component, that component insert may trigger an observer that despawns the entity.
</span><span style=color:#86b300>+/// So, when you don't have full knowledge of what commands may interact with this entity,
</span><span style=color:#86b300>+/// do not further use this value without first checking [`is_despawned`](Self::is_despawned).
</span><span> pub struct EntityWorldMut<'w> {
</span><span>     world: &'w mut World,
</span><span>     entity: Entity,
</span><span style=color:#c594c5>@@ -109,18 +120,17 @@ </span><span style=color:#399ee6>impl<'w> EntityWorldMut<'w> {
</span><span> 
</span><span>     /// # Safety
</span><span>     ///
</span><span style=color:#f07171>-    ///  - `entity` must be valid for `world`: the generation should match that of the entity at the same index.
</span><span style=color:#f07171>-    ///  - `location` must be sourced from `world`'s `Entities` and must exactly match the location for `entity`
</span><span style=color:#86b300>+    ///  The `location` must be sourced from `world`'s `Entities` and must exactly match the location for `entity`.
</span><span style=color:#86b300>+    ///  If the `entity` is not spawned for any reason (See [`EntityNotSpawnedError`](crate::entity::EntityNotSpawnedError)), the location should be `None`.
</span><span>     ///
</span><span style=color:#f07171>-    ///  The above is trivially satisfied if `location` was sourced from `world.entities().get(entity)`.
</span><span style=color:#86b300>+    ///  The above is trivially satisfied if `location` was sourced from `world.entities().get_spawned(entity).ok()`.
</span><span>     #[inline]
</span><span>     pub(crate) unsafe fn new(
</span><span>         world: &'w mut World,
</span><span>         entity: Entity,
</span><span>         location: Option&LTEntityLocation>,
</span><span>     ) -> Self {
</span><span style=color:#f07171>-        debug_assert!(world.entities().contains(entity));
</span><span style=color:#f07171>-        debug_assert_eq!(world.entities().get(entity).unwrap(), location);
</span><span style=color:#86b300>+        debug_assert_eq!(world.entities().get_spawned(entity).ok(), location);
</span><span> 
</span><span>         EntityWorldMut {
</span><span>             world,
</span><span style=color:#c594c5>@@ -1540,6 +1550,11 @@ </span><span style=color:#399ee6>impl<'w> EntityWorldMut<'w> {
</span><span>     /// This returns the new [`Entity`], which you must manage.
</span><span>     /// Note that this still increases the generation to differentiate different spawns of the same row.
</span><span>     ///
</span><span style=color:#86b300>+    /// Additionally, keep in mind the limitations documented in the type-level docs.
</span><span style=color:#86b300>+    /// Unless you have full knowledge of this [`EntityWorldMut`]'s lifetime,
</span><span style=color:#86b300>+    /// you may not assume that nothing else has taken responsibility of this [`Entity`].
</span><span style=color:#86b300>+    /// If you are not careful, this could cause a double free.
</span><span style=color:#86b300>+    ///
</span><span>     /// This may be later [`spawn_at`](World::spawn_at).
</span><span>     /// See [`World::despawn_no_free`] for details and usage examples.
</span><span>     #[track_caller]
</span><span style=color:#c594c5>@@ -1813,9 +1828,11 @@ </span><span style=color:#399ee6>impl<'w> EntityWorldMut<'w> {
</span><span>     ///
</span><span>     /// This is *only* required when using the unsafe function [`EntityWorldMut::world_mut`],
</span><span>     /// which enables the location to change.
</span><span style=color:#86b300>+    ///
</span><span style=color:#86b300>+    /// Note that if the entity is not spawned for any reason,
</span><span style=color:#86b300>+    /// this will have a location of `None`, leading some methods to panic.
</span><span>     pub fn update_location(&mut self) {
</span><span style=color:#f07171>-        self.location = self.world.entities().get(self.entity)
</span><span style=color:#f07171>-            .expect("Attempted to update the location of a despawned entity, which is impossible. This was the result of performing an operation on this EntityWorldMut that queued a despawn command");
</span><span style=color:#86b300>+        self.location = self.world.entities().get_spawned(self.entity).ok();
</span><span>     }
</span><span> 
</span><span>     /// Returns if the entity has been despawned.
</span><span>diff --git a/crates/bevy_ecs/src/world/mod.rs b/crates/bevy_ecs/src/world/mod.rs
</span><span>index 5c37688d23637..f57e43ed73180 100644
</span><span style=color:#c594c5>--- a/crates/bevy_ecs/src/world/mod.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_ecs/src/world/mod.rs
</span><span style=color:#c594c5>@@ -1102,13 +1102,11 @@ </span><span style=color:#399ee6>impl World {
</span><span>         // SAFETY: command_queue is not referenced anywhere else
</span><span>         if !unsafe { self.command_queue.is_empty() } {
</span><span>             self.flush();
</span><span style=color:#f07171>-            entity_location = self
</span><span style=color:#f07171>-                .entities()
</span><span style=color:#f07171>-                .get(entity)
</span><span style=color:#f07171>-                .expect("For this to fail, a queued command would need to despawn the entity.");
</span><span style=color:#86b300>+            entity_location = self.entities().get_spawned(entity).ok();
</span><span>         }
</span><span> 
</span><span style=color:#f07171>-        // SAFETY: entity and location are valid, as they were just created above
</span><span style=color:#86b300>+        // SAFETY: The entity and location started as valid.
</span><span style=color:#86b300>+        // If they were changed by commands, the location was updated to match.
</span><span>         let mut entity = unsafe { EntityWorldMut::new(self, entity, entity_location) };
</span><span>         // SAFETY:
</span><span>         // - This is called exactly once after `get_components` has been called in `spawn_non_existent`.
</span><span>diff --git a/crates/bevy_ui_widgets/src/observe.rs b/crates/bevy_ui_widgets/src/observe.rs
</span><span>index 9443cb5898711..944d0c198dd21 100644
</span><span style=color:#c594c5>--- a/crates/bevy_ui_widgets/src/observe.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_ui_widgets/src/observe.rs
</span><span style=color:#c594c5>@@ -64,6 +64,10 @@ </span><span style=color:#399ee6>impl&LTE: EntityEvent, B: Bundle, M, I: IntoObserverSystem&LTE, B, M>> DynamicBundle
</span><span>         // SAFETY: The pointer was not dropped in `get_components`, so the allocation is still
</span><span>         // initialized.
</span><span>         let add_observer = unsafe { ptr.assume_init() };
</span><span style=color:#86b300>+        if entity.is_despawned() {
</span><span style=color:#86b300>+            return;
</span><span style=color:#86b300>+        }
</span><span style=color:#86b300>+
</span><span>         let add_observer = add_observer.read();
</span><span>         entity.observe(add_observer.observer);
</span><span>     }
</span></code></pre></details></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_22725.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>