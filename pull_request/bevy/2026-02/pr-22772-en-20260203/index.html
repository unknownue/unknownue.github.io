<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22772 Feature/populated message reader
        
    </title><meta content="#22772 Feature/populated message reader" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-03</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-02/pr-22772-zh-cn-20260203>中文</a></div></div><div class=pr-content><h1 id=feature-populated-message-reader>Feature/populated message reader</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Feature/populated message reader<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22772<li><strong>Author</strong>: Person-93<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Feature, A-ECS, S-Ready-For-Final-Review, X-Contentious<li><strong>Created</strong>: 2026-02-02T05:05:52Z<li><strong>Merged</strong>: 2026-02-03T01:54:21Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Offer a way to skip a system that reads messages if there are no messages that need to be read.<h2 id=solution>Solution</h2><p>Add a <code>SystemParam</code>: <code>PopulatedMessageReader</code>.<h2 id=testing>Testing</h2><p>I added a test case<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a specific optimization need in Bevy’s ECS message system. When working with message-driven architectures, developers often write systems that process messages from queues. However, in many cases, these systems run even when their message queues are empty, which wastes CPU cycles and reduces overall performance.<p>The existing <code>MessageReader&LTT></code> SystemParam allows systems to read messages of type <code>T</code>, but it always runs the system regardless of whether there are messages to process. This creates inefficiencies, especially for systems that perform expensive computations or have side effects that should only occur when messages are present.<p>The developer recognized this limitation and implemented a new SystemParam called <code>PopulatedMessageReader&LTT></code>. This wrapper around <code>MessageReader&LTT></code> adds conditional execution logic: if the message queue is empty, the system is skipped entirely. The implementation leverages Bevy’s existing <code>SystemParamValidationError</code> mechanism, which provides a clean way to conditionally skip systems during schedule validation.<p>The core technical challenge was ensuring that <code>PopulatedMessageReader</code> could reuse most of <code>MessageReader</code>’s implementation while adding the empty queue check. The solution uses Rust’s Deref traits to delegate functionality to the underlying <code>MessageReader</code>, then overrides the <code>validate_param</code> method to perform the queue emptiness check. When validation detects an empty queue, it returns a <code>SystemParamValidationError</code> with a “skipped” status, preventing the system from executing.<p>This approach maintains consistency with Bevy’s existing patterns while providing a clear performance optimization. The PR also properly documents when to use <code>PopulatedMessageReader</code> versus the existing <code>on_message</code> run condition, clarifying that <code>on_message</code> is for skipping systems based on messages they don’t read, while <code>PopulatedMessageReader</code> is for messages they do read.<p>The test case demonstrates the expected behavior: systems with <code>PopulatedMessageReader</code> are skipped when the queue is empty but execute when messages are present. This validation ensures the optimization works correctly and won’t break existing functionality.<p>From an architectural perspective, this change fits well within Bevy’s ECS design. It provides a more granular control mechanism for system execution without requiring complex conditional logic within the systems themselves. Developers can now choose between always-running message readers and conditionally-executing ones based on their specific performance requirements.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Message Queue] --> B{Is Queue Empty?}
</span><span>    B -->|Yes| C[System with PopulatedMessageReader: Skipped]
</span><span>    B -->|No| D[System with PopulatedMessageReader: Executes]
</span><span>    E[System with MessageReader] --> F[Always Executes]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ol><li><p><strong>crates/bevy_ecs/src/message/message_reader.rs</strong> (+124/-1) This file contains the main implementation of <code>PopulatedMessageReader</code>. The new struct wraps <code>MessageReader</code> and adds validation logic to skip systems when the message queue is empty.</p> <p>Key code snippet showing the validation logic:</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>unsafe fn </span><span style=color:#f29718>validate_param</span><span>(
</span><span>    </span><span style=color:#ff8f40>state</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut Self</span><span style=color:#ed9366>::</span><span>State,
</span><span>    </span><span style=color:#ff8f40>system_meta</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>crate</span><span style=color:#ed9366>::</span><span>system</span><span style=color:#ed9366>::</span><span>SystemMeta,
</span><span>    </span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>: </span><span>crate</span><span style=color:#ed9366>::</span><span>world</span><span style=color:#ed9366>::</span><span>unsafe_world_cell</span><span style=color:#ed9366>::</span><span>UnsafeWorldCell,
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><(), SystemParamValidationError> {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// SAFETY: requirements are upheld by MessageReader's implementation
</span><span>    </span><span style=color:#fa6e32>unsafe </span><span>{ MessageReader</span><span style=color:#ed9366>::</span><span>&LTM></span><span style=color:#ed9366>::</span><span>validate_param(state</span><span style=color:#61676ccc>,</span><span> system_meta</span><span style=color:#61676ccc>,</span><span> world) }</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// SAFETY: requirements are upheld by MessageReader's implementation
</span><span>    </span><span style=color:#fa6e32>let</span><span> reader </span><span style=color:#ed9366>=
</span><span>        </span><span style=color:#fa6e32>unsafe </span><span>{ MessageReader</span><span style=color:#ed9366>::</span><span>get_param(state</span><span style=color:#61676ccc>,</span><span> system_meta</span><span style=color:#61676ccc>,</span><span> world</span><span style=color:#61676ccc>,</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>change_tick</span><span>()) }</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>if</span><span> reader</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_empty</span><span>() {
</span><span>        </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(SystemParamValidationError</span><span style=color:#ed9366>::</span><span>skipped</span><span style=color:#ed9366>::</span><span><</span><span style=color:#fa6e32>Self</span><span>>(
</span><span>            </span><span style=color:#86b300>"message queue is empty"</span><span style=color:#61676ccc>,
</span><span>        ))
</span><span>    } </span><span style=color:#fa6e32>else </span><span>{
</span><span>        </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(())
</span><span>    }
</span><span>}
</span></code></pre><li><p><strong>crates/bevy_ecs/src/lib.rs</strong> (+3/-1) This file adds <code>PopulatedMessageReader</code> to the public prelude, making it easily accessible to Bevy users.</p> <p>Code snippet showing the export:</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub mod </span><span style=color:#399ee6>prelude </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>    message</span><span style=color:#ed9366>::</span><span>{
</span><span>        Message</span><span style=color:#61676ccc>,</span><span> MessageMutator</span><span style=color:#61676ccc>,</span><span> MessageReader</span><span style=color:#61676ccc>,</span><span> MessageWriter</span><span style=color:#61676ccc>,</span><span> Messages</span><span style=color:#61676ccc>,</span><span> PopulatedMessageReader</span><span style=color:#61676ccc>,
</span><span>    }</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>}
</span></code></pre><li><p><strong>crates/bevy_ecs/src/schedule/condition.rs</strong> (+2/-0) This file updates documentation for the <code>on_message</code> run condition to clarify when to use <code>PopulatedMessageReader</code> instead.</p> <p>Code snippet showing the documentation update:</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>/// A [`SystemCondition`]-satisfying system that returns `true`
</span><span style=color:#abb0b6;font-style:italic>/// if there are any new messages of the given type since it was last called.
</span><span style=color:#abb0b6;font-style:italic>///
</span><span style=color:#abb0b6;font-style:italic>/// To skip a system based on messages that it reads, use [`PopulatedMessageReader`](crate::prelude::PopulatedMessageReader) instead.
</span></code></pre></ol><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_ecs/latest/bevy_ecs/system/trait.SystemParam.html target=_blank>Bevy ECS System Parameters Documentation</a> - Understanding how SystemParams work in Bevy<li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/programming/messages.html target=_blank>Bevy Message System Guide</a> - How to use messages in Bevy<li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/std/ops/trait.Deref.html target=_blank>Rust Deref Trait Documentation</a> - Understanding the delegation pattern used in this implementation<li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/programming/conditions.html target=_blank>Conditional System Execution in Bevy</a> - Other ways to conditionally execute systems in Bevy</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_22772.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>