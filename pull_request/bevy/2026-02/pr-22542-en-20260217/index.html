<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22542 Fix feature gating in `bevy_post_process`
        
    </title><meta content="#22542 Fix feature gating in `bevy_post_process`" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-17</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-02/pr-22542-zh-cn-20260217>中文</a></div></div><div class=pr-content><h1 id=fix-feature-gating-in-bevy-post-process>Fix feature gating in <code>bevy_post_process</code></h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix feature gating in <code>bevy_post_process</code><li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22542<li><strong>Author</strong>: beicause<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, S-Ready-For-Final-Review, D-Straightforward<li><strong>Created</strong>: 2026-01-16T08:06:03Z<li><strong>Merged</strong>: 2026-02-17T17:23:27Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>The features in <code>bevy_post_process</code> is never enabled. <del>Bloom texture with mipmaps actually works on WebGL2</del><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This pull request addresses two related issues in the Bevy engine’s post-processing system, specifically focusing on the bloom effect implementation. The problems stemmed from incomplete feature gating and platform-specific texture handling inconsistencies.<p>The initial problem was straightforward: the <code>bevy_post_process</code> crate’s features weren’t being properly enabled through the main <code>bevy_internal</code> crate’s feature definitions. In the root <code>Cargo.toml</code>, the <code>trace</code>, <code>webgl</code>, and <code>webgpu</code> features didn’t propagate to the post-processing module. This meant that when developers enabled these features at the project level, the post-processing system wouldn’t receive the corresponding feature flags, potentially causing compilation issues or runtime behavior differences.<p>Looking deeper, a more subtle bug was discovered in the bloom effect’s texture caching system. The bloom implementation uses bind group caching to avoid recreating GPU resources when they haven’t changed. The cache key was originally constructed using a single texture ID, but this approach didn’t account for WebGL’s specific behavior. On WebGL targets without the <code>webgpu</code> feature enabled, the bloom system uses multiple textures stored in a vector, requiring a different cache key structure.<p>The solution involved two complementary fixes. First, the <code>Cargo.toml</code> was updated to properly forward the features to <code>bevy_post_process</code>. This ensures that feature-dependent code in the post-processing module compiles correctly when those features are enabled at the project level.<p>Second, the bloom module’s cache key logic was refactored to handle platform differences. The <code>BloomBindGroups</code> struct and its initialization in <code>prepare_bloom_bind_groups</code> were modified with conditional compilation attributes. On non-WebGL platforms or when using WebGPU, the cache key remains a simple tuple of <code>(TextureId, BufferId)</code>. However, on WebGL targets without WebGPU, the cache key becomes <code>(Vec&LTTextureId>, BufferId)</code> to properly account for the texture array used in that configuration.<p>This conditional compilation approach maintains performance on platforms where a single texture ID suffices while providing correctness on WebGL. The implementation uses Rust’s <code>cfg</code> attributes with feature and target architecture checks, ensuring each platform gets the appropriate data structure without runtime overhead.<p>The changes are minimal but important for two reasons. First, they ensure feature consistency across the engine - a critical consideration in a modular codebase like Bevy. Second, they fix a potential correctness issue where WebGL builds might use incorrect cached bind groups, leading to rendering artifacts or performance degradation from unnecessary bind group recreation.<p>From an engineering perspective, this PR demonstrates good practices in handling platform-specific code in graphics systems. The solution avoids runtime branching for performance-critical paths, uses conditional compilation appropriately, and maintains clean separation between different rendering backends. It also highlights the importance of thorough feature propagation in Rust workspace configurations, especially for graphics engines supporting multiple backends.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[bevy_internal Cargo.toml] --> B[Feature Propagation]
</span><span>    B --> C[trace feature]
</span><span>    B --> D[webgl feature]
</span><span>    B --> E[webgpu feature]
</span><span>    C --> F[bevy_post_process/trace]
</span><span>    D --> G[bevy_post_process/webgl]
</span><span>    E --> H[bevy_post_process/webgpu]
</span><span>    
</span><span>    I[bevy_post_process bloom module] --> J[Platform Detection]
</span><span>    J --> K[Non-WebGL/WebGPU]
</span><span>    J --> L[WebGL without WebGPU]
</span><span>    K --> M[Cache Key: (TextureId, BufferId)]
</span><span>    L --> N[Cache Key: (Vec&LTTextureId>, BufferId)]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-internal-cargo-toml><code>crates/bevy_internal/Cargo.toml</code></h3><p>This file was updated to properly propagate feature flags to the <code>bevy_post_process</code> crate. Without these entries, enabling features like <code>trace</code>, <code>webgl</code>, or <code>webgpu</code> at the project level wouldn’t activate the corresponding features in the post-processing module.<pre class=language-toml data-lang=toml style=color:#61676c;background-color:#fafafa><code class=language-toml data-lang=toml><span style=color:#abb0b6;font-style:italic># Changes to feature definitions:
</span><span style=color:#399ee6>trace </span><span>= [
</span><span>  </span><span style=color:#abb0b6;font-style:italic># ... existing entries ...
</span><span>  </span><span style=color:#86b300>"bevy_post_process?/trace"</span><span style=color:#61676ccc>,  </span><span style=color:#abb0b6;font-style:italic># Added
</span><span>]
</span><span>
</span><span style=color:#399ee6>webgl </span><span>= [
</span><span>  </span><span style=color:#abb0b6;font-style:italic># ... existing entries ...
</span><span>  </span><span style=color:#86b300>"bevy_post_process?/webgl"</span><span style=color:#61676ccc>,  </span><span style=color:#abb0b6;font-style:italic># Added
</span><span>]
</span><span>
</span><span style=color:#399ee6>webgpu </span><span>= [
</span><span>  </span><span style=color:#abb0b6;font-style:italic># ... existing entries ...
</span><span>  </span><span style=color:#86b300>"bevy_post_process?/webgpu"</span><span style=color:#61676ccc>,  </span><span style=color:#abb0b6;font-style:italic># Added
</span><span>]
</span></code></pre><h3 id=crates-bevy-post-process-src-bloom-mod-rs><code>crates/bevy_post_process/src/bloom/mod.rs</code></h3><p>This file contains the main logic fix for WebGL texture caching. The changes ensure that the bloom effect’s bind group cache uses the correct key structure for each rendering backend.<ol><li><strong>BloomBindGroups struct definition</strong> - The cache key field now has two different types depending on platform:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>BloomBindGroups </span><span>{
</span><span>    cache_key</span><span style=color:#61676ccc>: </span><span>(TextureId, BufferId),
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other fields
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>BloomBindGroups </span><span>{
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(</span><span style=color:#f29718>any</span><span>(
</span><span>        </span><span style=color:#f29718>not</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"webgl"</span><span>)</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#f29718>not</span><span>(target_arch </span><span style=color:#ed9366>= </span><span style=color:#86b300>"wasm32"</span><span>)</span><span style=color:#61676ccc>,
</span><span>        feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"webgpu"
</span><span>    ))]
</span><span>    cache_key</span><span style=color:#61676ccc>: </span><span>(TextureId, BufferId),
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(</span><span style=color:#f29718>all</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"webgl"</span><span style=color:#61676ccc>,</span><span> target_arch </span><span style=color:#ed9366>= </span><span style=color:#86b300>"wasm32"</span><span style=color:#61676ccc>, </span><span style=color:#f29718>not</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"webgpu"</span><span>)))]
</span><span>    cache_key</span><span style=color:#61676ccc>: </span><span>(</span><span style=color:#55b4d4;font-style:italic>Vec</span><span>&LTTextureId>, BufferId),
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other fields
</span><span>}
</span></code></pre><ol start=2><li><strong>prepare_bloom_bind_groups function</strong> - Updated to create the appropriate cache key based on platform:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> cache_key </span><span style=color:#ed9366>= </span><span>(
</span><span>    bloom_texture</span><span style=color:#ed9366>.</span><span>texture</span><span style=color:#ed9366>.</span><span>texture</span><span style=color:#ed9366>.</span><span style=color:#f07171>id</span><span>()</span><span style=color:#61676ccc>,
</span><span>    uniforms</span><span style=color:#ed9366>.</span><span style=color:#f07171>buffer</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>id</span><span>()</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(</span><span style=color:#f29718>any</span><span>(
</span><span>    </span><span style=color:#f29718>not</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"webgl"</span><span>)</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#f29718>not</span><span>(target_arch </span><span style=color:#ed9366>= </span><span style=color:#86b300>"wasm32"</span><span>)</span><span style=color:#61676ccc>,
</span><span>    feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"webgpu"
</span><span>))]
</span><span style=color:#fa6e32>let</span><span> cache_key </span><span style=color:#ed9366>= </span><span>(
</span><span>    bloom_texture</span><span style=color:#ed9366>.</span><span>texture</span><span style=color:#ed9366>.</span><span>texture</span><span style=color:#ed9366>.</span><span style=color:#f07171>id</span><span>()</span><span style=color:#61676ccc>,
</span><span>    uniforms</span><span style=color:#ed9366>.</span><span style=color:#f07171>buffer</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>id</span><span>()</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(</span><span style=color:#f29718>all</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"webgl"</span><span style=color:#61676ccc>,</span><span> target_arch </span><span style=color:#ed9366>= </span><span style=color:#86b300>"wasm32"</span><span style=color:#61676ccc>, </span><span style=color:#f29718>not</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"webgpu"</span><span>)))]
</span><span style=color:#fa6e32>let</span><span> cache_key </span><span style=color:#ed9366>= </span><span>(
</span><span>    bloom_texture
</span><span>        </span><span style=color:#ed9366>.</span><span>texture
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|</span><span style=color:#ff8f40>tex</span><span>| tex</span><span style=color:#ed9366>.</span><span>texture</span><span style=color:#ed9366>.</span><span style=color:#f07171>id</span><span>())
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>collect</span><span>()</span><span style=color:#61676ccc>,
</span><span>    uniforms</span><span style=color:#ed9366>.</span><span style=color:#f07171>buffer</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>id</span><span>()</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><p>These changes work together: the Cargo.toml updates ensure features are properly enabled, while the bloom module changes ensure correct cache key generation for each rendering backend configuration.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/getting-started/rendering/ target=_blank>Bevy’s Rendering Architecture</a> - Official documentation on Bevy’s rendering system<li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/reference/conditional-compilation.html target=_blank>Rust Conditional Compilation</a> - Reference for <code>#[cfg]</code> attributes used in this PR<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/getting-started/setup/#web-assembly target=_blank>WebGL vs WebGPU in Bevy</a> - Platform targeting in Bevy<li><a rel="noopener nofollow noreferrer" href=https://github.com/gfx-rs/wgpu/wiki/BindGroups target=_blank>Bind Groups in Graphics Programming</a> - Concept explanation from wgpu documentation</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_22542.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>