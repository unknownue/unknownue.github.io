<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22827 Remove short circuit logic workaround
        
    </title><meta content="#22827 Remove short circuit logic workaround" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-07</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-02/pr-22827-zh-cn-20260207>中文</a></div></div><div class=pr-content><h1 id=remove-short-circuit-logic-workaround>Remove short circuit logic workaround</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Remove short circuit logic workaround<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22827<li><strong>Author</strong>: goodartistscopy<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, C-Code-Quality, S-Ready-For-Final-Review, D-Straightforward<li><strong>Created</strong>: 2026-02-06T14:17:07Z<li><strong>Merged</strong>: 2026-02-07T00:30:15Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>wgpu 28 brought a partial resolution of https://github.com/gfx-rs/wgpu/issues/4394, which means we can now use proper short-circuiting logic in control statements.<p>I found two instances, but if anyone knows about other ones let me know<ul><li>in the PPLL OIT implementation<li>in the GPU mesh preprocessing</ul><h2 id=testing>Testing</h2><p>Launched the relevant samples to validate that they still work<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a specific technical limitation that existed in Bevy’s shader code due to a bug in the underlying graphics API implementation. The issue stemmed from a known problem in wgpu (WebGPU implementation in Rust) where short-circuit evaluation in control flow statements didn’t work correctly in WGSL shaders. Short-circuit evaluation is the programming language feature where logical operators like <code>&&</code> (AND) and <code>||</code> (OR) stop evaluating expressions as soon as the result is determined.<p>Before wgpu version 28, developers couldn’t use short-circuit logic in <code>for</code> loop conditions or complex conditional expressions. This forced Bevy contributors to implement workarounds in shader code. The workaround involved manually breaking out of loops or splitting complex conditions into separate <code>if-else</code> blocks to achieve the same behavior while avoiding the bug.<p>With wgpu 28’s partial resolution of <a rel="noopener nofollow noreferrer" href=https://github.com/gfx-rs/wgpu/issues/4394 target=_blank>gfx-rs/wgpu issue #4394</a>, this limitation has been addressed. The PR author identified two instances where these workarounds were no longer necessary and removed them, simplifying the code and bringing it closer to standard WGSL patterns.<p>The first change affects the Order-Independent Transparency (OIT) implementation using Per-Pixel Linked Lists (PPLL). This technique requires sorting transparent fragments by depth to composite them correctly. The original code had a workaround in two <code>for</code> loops that performed insertion and removal operations on a sorted fragment list. Without short-circuit evaluation, the loop conditions couldn’t include the comparison that determined when to stop iterating. Instead, the code had to check the condition inside the loop body and use a <code>break</code> statement to exit early.<p>The second change is in the GPU mesh preprocessing shader, which handles indirect rendering parameters. Here, a conditional check that combined two conditions with logical OR had to be split into separate <code>if</code> and <code>else if</code> blocks. This was necessary because the expression <code>(instance_index == 0u) || (work_items[instance_index - 1].output_or_indirect_parameters_index != indirect_parameters_index)</code> would potentially cause undefined behavior when <code>instance_index</code> was 0, as accessing <code>work_items[instance_index - 1]</code> would be out of bounds without short-circuit evaluation.<p>The removal of these workarounds makes the code cleaner, more maintainable, and easier to understand. It also potentially improves shader performance slightly by reducing the number of conditional branches and simplifying the control flow. Most importantly, it aligns the code with standard WGSL practices now that the underlying implementation supports the language feature correctly.<p>The changes are minimal and focused, affecting only the necessary parts of the shader code. The author tested the changes by launching relevant samples to ensure the functionality remained intact, which is a practical approach given that shader changes can be subtle and hard to test comprehensively.<p>This PR demonstrates a common pattern in graphics programming where workarounds for driver or API bugs become obsolete when the underlying issues are fixed. It’s important for maintainers to track these dependencies and clean up technical debt when opportunities arise.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[wgpu 28 Update] --> B[Short-circuit Bug Partial Fix]
</span><span>    B --> C[Remove PPLL OIT Workaround]
</span><span>    B --> D[Remove Mesh Preprocess Workaround]
</span><span>    C --> E[Cleaner OIT Shader Code]
</span><span>    D --> F[Cleaner Mesh Preprocess Shader Code]
</span><span>    E --> G[Improved Code Maintainability]
</span><span>    F --> G
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-core-pipeline-src-oit-resolve-oit-resolve-wgsl><code>crates/bevy_core_pipeline/src/oit/resolve/oit_resolve.wgsl</code></h3><p><strong>What changed</strong>: Removed workarounds for short-circuit evaluation in two <code>for</code> loops in the OIT resolve shader.<p><strong>Before</strong>:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>for(; i > 0; i -= 1) {
</span><span>    // short-circuit can't be used in for(;;;), https://github.com/gfx-rs/wgpu/issues/4394
</span><span>    if fragment_node.depth_alpha > fragment_list[i - 1].depth_alpha {
</span><span>        fragment_list[i] = fragment_list[i - 1];
</span><span>    } else {
</span><span>        break;
</span><span>    }
</span><span>}
</span></code></pre><p><strong>After</strong>:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>for (; i > 0 && fragment_node.depth_alpha > fragment_list[i - 1].depth_alpha; i -= 1) {
</span><span>    fragment_list[i] = fragment_list[i - 1];
</span><span>}
</span></code></pre><p><strong>Relation to PR</strong>: This change leverages the newly available short-circuit evaluation in <code>for</code> loop conditions, simplifying the loop logic by moving the comparison into the loop condition itself.<h3 id=crates-bevy-pbr-src-render-mesh-preprocess-wgsl><code>crates/bevy_pbr/src/render/mesh_preprocess.wgsl</code></h3><p><strong>What changed</strong>: Combined separate <code>if</code> and <code>else if</code> conditions into a single condition using logical OR.<p><strong>Before</strong>:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// https://github.com/gfx-rs/wgpu/issues/4394
</span><span>if (instance_index == 0u) {
</span><span>    indirect_parameters_gpu_metadata[indirect_parameters_index].mesh_index = input_index;
</span><span>} else if (work_items[instance_index - 1].output_or_indirect_parameters_index != indirect_parameters_index) {
</span><span>    indirect_parameters_gpu_metadata[indirect_parameters_index].mesh_index = input_index;
</span><span>}
</span></code></pre><p><strong>After</strong>:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>if (instance_index == 0u) || (work_items[instance_index - 1].output_or_indirect_parameters_index != indirect_parameters_index) {
</span><span>    indirect_parameters_gpu_metadata[indirect_parameters_index].mesh_index = input_index;
</span><span>}
</span></code></pre><p><strong>Relation to PR</strong>: This change uses short-circuit evaluation to safely combine two conditions that share the same action, eliminating code duplication and making the intent clearer.<h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://www.w3.org/TR/WGSL/#control-flow target=_blank>WGSL Specification - Control Flow</a>: Official WebGPU Shading Language specification covering control flow statements<li><a rel="noopener nofollow noreferrer" href=https://github.com/gfx-rs/wgpu/issues/4394 target=_blank>gfx-rs/wgpu Issue #4394</a>: The original issue tracking the short-circuit evaluation bug in wgpu<li><a rel="noopener nofollow noreferrer" href=https://jcgt.org/published/0002/02/09/ target=_blank>Order-Independent Transparency Techniques</a>: Research paper on various OIT methods including Per-Pixel Linked Lists<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/rendering/ target=_blank>Bevy Rendering Architecture</a>: Official Bevy documentation on the rendering system<li><a rel="noopener nofollow noreferrer" href=https://webgpufundamentals.org/webgpu/lessons/webgpu-shader-modules.html target=_blank>WebGPU Shader Language (WGSL)</a>: Tutorial on WGSL shader programming</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_22827.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>