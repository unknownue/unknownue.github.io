<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22905 Move gltf stuff in pbr to its own file
        
    </title><meta content="#22905 Move gltf stuff in pbr to its own file" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-17</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-02/pr-22905-zh-cn-20260217>中文</a></div></div><div class=pr-content><h1 id=title-move-gltf-stuff-in-pbr-to-its-own-file>Title: Move gltf stuff in pbr to its own file</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Move gltf stuff in pbr to its own file<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22905<li><strong>Author</strong>: Zeophlite<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: D-Trivial, A-Rendering, C-Code-Quality, S-Ready-For-Final-Review<li><strong>Created</strong>: 2026-02-11T12:11:36Z<li><strong>Merged</strong>: 2026-02-17T00:14:46Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Separation of concerns</ul><h2 id=solution>Solution</h2><ul><li>Move GLTF stuff in pbr to its own files</ul><h2 id=testing>Testing</h2><ul><li><code>cargo run --example animated_mesh</code></ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR is a straightforward code refactoring that addresses a common issue in growing codebases: the accumulation of related but distinct functionality in a single file. The <code>lib.rs</code> file in the <code>bevy_pbr</code> crate had grown to contain both the core PBR (Physically Based Rendering) logic and the GLTF-specific integration code.<p>The problem was one of organization and maintainability. With the GLTF handling code embedded directly in <code>lib.rs</code>, the file had become longer and harder to navigate. This made it more difficult for developers to understand the separation between the core PBR rendering system and the GLTF asset loading integration. The code worked correctly, but the organization didn’t reflect the logical separation between these concerns.<p>The solution was simple and effective: extract all GLTF-related code into its own dedicated module. This approach follows established software engineering principles of modular design and separation of concerns. By moving the GLTF handling code to a separate file, the main <code>lib.rs</code> file becomes more focused on its primary responsibility - the PBR rendering system itself.<p>The implementation involved two main changes. First, a new <code>gltf.rs</code> file was created with 144 lines of code moved from <code>lib.rs</code>. This file contains the <code>add_gltf</code> function, the <code>standard_material_from_gltf_material</code> conversion function, and the <code>GltfExtensionHandlerPbr</code> struct with its trait implementation. Second, the main <code>lib.rs</code> file was updated to remove these 136 lines of GLTF code and instead include a simple module declaration and a call to the extracted function.<p>Looking at the code that was moved, we can see it handles several key responsibilities:<ol><li><p><strong>GLTF Extension Registration</strong>: The <code>add_gltf</code> function registers a GLTF extension handler, with platform-specific handling for WebAssembly versus native targets using conditional compilation.</p><li><p><strong>Material Conversion</strong>: The <code>standard_material_from_gltf_material</code> function maps GLTF material properties to Bevy’s <code>StandardMaterial</code> struct. This is a non-trivial mapping that needs to handle many material properties including base color, metallic roughness, normal maps, and various optional features controlled by feature flags.</p><li><p><strong>Extension Handler Implementation</strong>: The <code>GltfExtensionHandlerPbr</code> struct implements the <code>GltfExtensionHandler</code> trait with three main callbacks:</p> <ul><li><code>on_root</code>: Creates a default StandardMaterial for GLTF assets<li><code>on_material</code>: Converts each GLTF material to a StandardMaterial<li><code>on_spawn_mesh_and_material</code>: Attaches the converted materials to entities</ul></ol><p>The refactoring maintains the exact same functionality while improving code organization. The conditional compilation blocks (<code>#[cfg(target_family = "wasm")]</code> and <code>#[cfg(not(target_family = "wasm"))]</code>) are preserved exactly as they were, ensuring the same platform-specific behavior.<p>From an architectural perspective, this change makes the codebase more modular. The GLTF integration is now a self-contained module that can be understood and modified independently of the core PBR system. This separation also makes it easier to test the GLTF integration in isolation and reduces cognitive load when working on either the PBR system or the GLTF integration.<p>The testing approach was minimal but appropriate for a refactoring PR: running the <code>animated_mesh</code> example ensures that the GLTF functionality still works correctly after the code reorganization. Since this is a pure refactoring with no behavior changes, more extensive testing isn’t necessary.<p>This type of refactoring is common in mature codebases as they evolve. What starts as a few related functions in a main file can grow into a substantial amount of code that deserves its own module. By proactively addressing this, the Bevy maintainers keep the codebase clean and maintainable, which pays dividends in long-term development velocity.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[bevy_pbr/src/lib.rs] --> B[Core PBR Systems]
</span><span>    A --> C[GLTF Integration]
</span><span>    C --> D[bevy_pbr/src/gltf.rs]
</span><span>    
</span><span>    D --> E[add_gltf function]
</span><span>    D --> F[standard_material_from_gltf_material]
</span><span>    D --> G[GltfExtensionHandlerPbr]
</span><span>    
</span><span>    G --> H[on_root callback]
</span><span>    G --> I[on_material callback]
</span><span>    G --> J[on_spawn_mesh_and_material callback]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-pbr-src-gltf-rs-144-0><code>crates/bevy_pbr/src/gltf.rs</code> (+144/-0)</h3><p>This is a new file created to house all GLTF-related functionality that was previously in <code>lib.rs</code>. It contains:<ol><li><strong>The <code>add_gltf</code> function</strong>: Registers the GLTF extension handler with platform-specific logic<li><strong>The <code>standard_material_from_gltf_material</code> function</strong>: Converts GLTF materials to Bevy’s StandardMaterial<li><strong>The <code>GltfExtensionHandlerPbr</code> struct and implementation</strong>: Handles GLTF extension callbacks</ol><p>Key code snippet from the new file:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>add_gltf</span><span>(</span><span style=color:#ff8f40>app</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> App) {
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(target_family </span><span style=color:#ed9366>= </span><span style=color:#86b300>"wasm"</span><span>)]
</span><span>    bevy_tasks</span><span style=color:#ed9366>::</span><span>block_on(async {
</span><span>        app</span><span style=color:#ed9366>.</span><span style=color:#f07171>world_mut</span><span>()
</span><span>            </span><span style=color:#ed9366>.</span><span>resource_mut</span><span style=color:#ed9366>::</span><span>&LTGltfExtensionHandlers>()
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>write</span><span>()
</span><span>            </span><span style=color:#ed9366>.</span><span>await
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>push</span><span>(</span><span style=color:#55b4d4;font-style:italic>Box</span><span style=color:#ed9366>::</span><span>new(GltfExtensionHandlerPbr))
</span><span>    })</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(</span><span style=color:#f29718>not</span><span>(target_family </span><span style=color:#ed9366>= </span><span style=color:#86b300>"wasm"</span><span>))]
</span><span>    app</span><span style=color:#ed9366>.</span><span style=color:#f07171>world_mut</span><span>()
</span><span>        </span><span style=color:#ed9366>.</span><span>resource_mut</span><span style=color:#ed9366>::</span><span>&LTGltfExtensionHandlers>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>write_blocking</span><span>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>push</span><span>(</span><span style=color:#55b4d4;font-style:italic>Box</span><span style=color:#ed9366>::</span><span>new(GltfExtensionHandlerPbr))</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=crates-bevy-pbr-src-lib-rs-2-136><code>crates/bevy_pbr/src/lib.rs</code> (+2/-136)</h3><p>The main changes in this file are:<ol><li>Added <code>mod gltf;</code> to declare the new module<li>Replaced the inline GLTF registration code with a call to <code>gltf::add_gltf(app)</code><li>Removed 136 lines of GLTF-specific code that was moved to the new file</ol><p>Key code snippet showing the simplified PbrPlugin implementation:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>impl </span><span>Plugin </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>PbrPlugin </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>build</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>app</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> App) {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ... other initialization code ...
</span><span>        
</span><span>        </span><span style=color:#fa6e32>if </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>gltf_render_enabled {
</span><span>            gltf</span><span style=color:#ed9366>::</span><span>add_gltf(app)</span><span style=color:#61676ccc>;  </span><span style=color:#abb0b6;font-style:italic>// Simple function call instead of inline code
</span><span>        }
</span><span>        
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ... rest of the plugin initialization ...
</span><span>    }
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><strong>Bevy’s GLTF Support Documentation</strong>: For understanding how GLTF assets are handled in Bevy<li><strong>Rust Module System</strong>: For understanding Rust’s module organization patterns<li><strong>Separation of Concerns Principle</strong>: A fundamental software design principle<li><strong>Refactoring Patterns</strong>: Martin Fowler’s refactoring catalog for similar code organization improvements<li><strong>Bevy’s PBR Rendering System</strong>: To understand the core rendering system that GLTF materials integrate with</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_22905.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>