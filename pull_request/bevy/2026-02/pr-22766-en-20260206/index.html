<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22766 Refactor extraction to bypass the orphan rules
        
    </title><meta content="#22766 Refactor extraction to bypass the orphan rules" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-06</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-02/pr-22766-zh-cn-20260206>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Refactor extraction to bypass the orphan rules<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22766<li><strong>Author</strong>: kristoff3r<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, C-Usability, S-Ready-For-Final-Review, M-Migration-Guide<li><strong>Created</strong>: 2026-02-01T15:34:09Z<li><strong>Merged</strong>: 2026-02-06T21:50:10Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Fixes #18722, and allows <code>ExtractComponent</code> to be used for foreign types.<h2 id=solution>Solution</h2><ul><li>Split the <code>Out</code> type from <code>ExtractComponent</code> to a <code>SyncComponent</code> trait. This allows types to use the synchronization logic without the extraction logic, and allows <code>SyncComponentPlugin</code> to correctly identify which components should be removed.<li>Don’t delete the entire entity but only the <code>Out</code> components in <code>SyncComponentPlugin</code>/<code>SyncWorldPlugin</code>, fixing #18722.<li>Add marker types to <code>ExtractComponent</code> and <code>SyncComponent</code>, allowing them to be implemented for foreign types outside <code>bevy_render</code>. (Example: <code>DirectionalLight</code> is defined in <code>bevy_light</code> which doesn’t depend on <code>bevy_render</code>, and used by <code>bevy_pbr</code>. Without the marker no crate is allowed to implement the trait.)</ul><p>During some earlier render crate refactors by @atlv24, some uses of <code>ExtractComponent</code> was converted to manual implementations. I have not ported these back, that can be done in follow up PRs.<p>As a follow up it might be interesting to make a derive macro for <code>SyncComponent</code>, and/or update the <code>ExtractComponent</code> macro to be able to customize the behavior around syncing.<h2 id=testing>Testing</h2><p>Ran a bunch of the examples. It would be good to test others, especially ones that toggle components.<p><del>A test case is in #22758. If that one gets merged first this PR should be updated to uncomment the relevant assert.</del> edit: the assert has been added.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The Bevy rendering system operates across two separate worlds: the main app world and the render world. Components need to be extracted from the main world and transferred to the render world for processing. This extraction is handled by the <code>ExtractComponent</code> trait and the <code>ExtractComponentPlugin</code>. However, the system had two significant technical problems that this PR addresses.<p>The first problem was Rust’s orphan rules, which prevented implementing the <code>ExtractComponent</code> trait for types defined outside the <code>bevy_render</code> crate. For example, <code>DirectionalLight</code> is defined in <code>bevy_pbr</code> but needs to be extracted for rendering. Since <code>ExtractComponent</code> is defined in <code>bevy_render</code>, neither the trait nor the type is local to <code>bevy_pbr</code>, making it impossible to implement the trait directly.<p>The second problem was a bug (#18722) in component cleanup. When a component was removed from an entity in the main world, the synchronization system would delete the entire corresponding entity in the render world, not just the extracted components. This caused issues when other components were attached to the render world entity.<p>The solution involved restructuring the extraction system into two separate concerns: synchronization and extraction. Previously, <code>ExtractComponent</code> defined both the extraction logic and the output type. This PR splits that responsibility:<ol><li>A new <code>SyncComponent</code> trait defines the output type that should be removed when the component is deleted<li><code>ExtractComponent</code> now depends on <code>SyncComponent</code> and only handles the extraction logic<li>Marker types are added to both traits to bypass Rust’s orphan rules</ol><p>This architectural change allows foreign types to implement the traits by using a local marker type (typically the plugin type) as a parameter. For example, <code>DirectionalLight</code> in <code>bevy_pbr</code> can now implement <code>SyncComponent&LTPbrPlugin></code>.<p>The implementation also fixes the cleanup bug. Previously, when a component was removed, the entire render world entity was despawned. Now, <code>SyncComponentPlugin</code> uses a removal function that only removes the components specified by <code>SyncComponent::Out</code>. This is more precise and preserves other components attached to the render world entity.<p>The changes required updates throughout the codebase where <code>ExtractComponent</code> was implemented. Each implementation now needs to provide both <code>SyncComponent</code> and <code>ExtractComponent</code> implementations, with <code>ExtractComponent</code> inheriting the <code>Out</code> type from <code>SyncComponent</code>.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Main World Component] -->|ExtractComponent| B[Render World Bundle]
</span><span>    A -->|SyncComponent| C[Defines Output Type]
</span><span>    C -->|guides| B
</span><span>    D[SyncComponentPlugin] -->|registers cleanup| E[Removal Function]
</span><span>    E -->|removes only| F[SyncComponent::Out]
</span><span>    F --> B
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-render-src-extract-component-rs-21-30><code>crates/bevy_render/src/extract_component.rs</code> (+21/-30)</h3><p>This file contains the core refactoring of the extraction system. The <code>ExtractComponent</code> trait no longer defines an <code>Out</code> associated type, and now depends on <code>SyncComponent</code> for that information.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub trait </span><span style=color:#399ee6>ExtractComponent</span><span>: Component {
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>QueryData</span><span style=color:#61676ccc>:</span><span> ReadOnlyQueryData</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>QueryFilter</span><span style=color:#61676ccc>:</span><span> QueryFilter</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Out</span><span style=color:#61676ccc>: </span><span>Bundle&LTEffect</span><span style=color:#61676ccc>:</span><span> NoBundleEffect></span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>extract_component</span><span>(</span><span style=color:#ff8f40>item</span><span style=color:#61676ccc>: </span><span>QueryItem<'</span><span style=color:#ed9366>_</span><span>, '</span><span style=color:#ed9366>_</span><span>, </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>QueryData>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Out></span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub trait </span><span style=color:#399ee6>ExtractComponent</span><span>&LTMarker = ()>: SyncComponent {
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>QueryData</span><span style=color:#61676ccc>:</span><span> ReadOnlyQueryData</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>QueryFilter</span><span style=color:#61676ccc>:</span><span> QueryFilter</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>extract_component</span><span>(</span><span style=color:#ff8f40>item</span><span style=color:#61676ccc>: </span><span>QueryItem<'</span><span style=color:#ed9366>_</span><span>, '</span><span style=color:#ed9366>_</span><span>, </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>QueryData>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Out></span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>The <code>ExtractComponentPlugin</code> also changed to accommodate the marker type parameter, allowing foreign implementations.<h3 id=crates-bevy-render-src-sync-component-rs-39-9><code>crates/bevy_render/src/sync_component.rs</code> (+39/-9)</h3><p>This new file (split from the extraction logic) defines the <code>SyncComponent</code> trait and its plugin. The key change is the removal function that now only removes the <code>Out</code> components instead of the entire entity.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before (in sync_world.rs):
</span><span>EntityRecord</span><span style=color:#ed9366>::</span><span>ComponentRemoved(main_entity) </span><span style=color:#ed9366>=> </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... despawn entire entity
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>EntityRecord</span><span style=color:#ed9366>::</span><span>ComponentRemoved(main_entity</span><span style=color:#61676ccc>,</span><span> removal_function) </span><span style=color:#ed9366>=> </span><span>{
</span><span>    </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(render_world_entity) </span><span style=color:#ed9366>=</span><span> render_world</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_entity_mut</span><span>(render_entity</span><span style=color:#ed9366>.</span><span style=color:#f07171>id</span><span>()) {
</span><span>        </span><span style=color:#f07171>removal_function</span><span>(render_world_entity)</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// Only removes SyncComponent::Out
</span><span>    }
</span><span>}
</span></code></pre><h3 id=release-content-migration-guides-extract-refactor-md-41-0><code>release-content/migration-guides/extract_refactor.md</code> (+41/-0)</h3><p>A new migration guide explains how to update code using the old <code>ExtractComponent</code> pattern. It shows the before/after structure with clear code examples.<h3 id=crates-bevy-pbr-src-lib-rs-22-5><code>crates/bevy_pbr/src/lib.rs</code> (+22/-5)</h3><p>This file demonstrates the pattern for implementing extraction for foreign types. Multiple light types now implement <code>SyncComponent&LTPbrPlugin></code> with the plugin as a marker.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>impl </span><span>SyncComponent&LTPbrPlugin> </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>DirectionalLight </span><span>{
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Out </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>Self</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>The plugin registrations also changed to include the marker type parameter.<h3 id=crates-bevy-post-process-src-dof-mod-rs-13-10><code>crates/bevy_post_process/src/dof/mod.rs</code> (+13/-10)</h3><p>This file shows the cleanup improvement. Instead of manually listing all components to remove, it now uses the <code>SyncComponent::Out</code> type.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>entity_commands</span><span style=color:#ed9366>.</span><span>remove</span><span style=color:#ed9366>::</span><span><(
</span><span>    DepthOfField,
</span><span>    DepthOfFieldUniform,
</span><span>    DepthOfFieldPipelines,
</span><span>    AuxiliaryDepthOfFieldTexture,
</span><span>    ViewDepthOfFieldBindGroupLayouts,
</span><span>)>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>entity_commands</span><span style=color:#ed9366>.</span><span>remove</span><span style=color:#ed9366>::</span><span><&LTDepthOfField </span><span style=color:#ed9366>as</span><span> SyncComponent></span><span style=color:#ed9366>::</span><span>Out>()</span><span style=color:#61676ccc>;
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/book/ch10-02-traits.html#implementing-a-trait-on-a-type target=_blank>Rust Orphan Rules</a> - Understanding the trait implementation restrictions<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/ecs/ target=_blank>Bevy ECS Guide</a> - Bevy’s Entity Component System architecture<li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_render/latest/bevy_render/extract_component/index.html target=_blank>Extract Schedule Documentation</a> - How extraction works in Bevy’s render pipeline</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_22766.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>