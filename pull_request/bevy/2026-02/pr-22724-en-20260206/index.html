<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22724 Add padding for color_plane widget for wasm/webgl compat
        
    </title><meta content="#22724 Add padding for color_plane widget for wasm/webgl compat" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-06</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-02/pr-22724-zh-cn-20260206>中文</a></div></div><div class=pr-content><h1 id=add-padding-for-color-plane-widget-for-wasm-webgl-compat>Add padding for color_plane widget for wasm/webgl compat</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Add padding for color_plane widget for wasm/webgl compat<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22724<li><strong>Author</strong>: mitchty<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, A-UI, S-Ready-For-Final-Review, D-Straightforward<li><strong>Created</strong>: 2026-01-27T14:51:05Z<li><strong>Merged</strong>: 2026-02-06T20:08:32Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>The new bevy feathers color plane widget throws out wgpu alignment issues for the f32 in use. To enable wasm builds to use this widget add padding similar to the existing shaders/materials.<p>Note this is my first contribution, I yolo’d names and whatnot so if the names I chose suck I can change them I’m not wedded to the names.<h2 id=solution>Solution</h2><p>Add a Vec3 padding to the uniform and material struct to pad to 16 bytes on wasm builds.<h2 id=testing>Testing</h2><p>Yep built before/after in linux (wayland though I could test X if pressed), macos, and windows. Those all continued to work as expected as they did before. And tested in wasm on safari/firefox/chrome (mostly latest versions I think of those) where all 3 couldn’t render the shader widget with this fix in place as a cargo patch its all good and works the same as the native builds.<ul><li>Are there any parts that need more testing?</ul><p>Maybe? I’m not sure I know enough to speak with any authority to that. I literally never program for the web this is all a fun side project in wasm for me and I honestly don’t know if I did this jazz right or not. Real web programmers should yea/nay these bits I’m just a tourist.<ul><li>How can other people (reviewers) test your changes? Is there anything specific they need to know?</ul><p>Just test/build on wasm with the color widget in place. All I did was use cargo patch to point to the fixed version like so:<p>Same patch against 0.18.1 release branch:<pre style=color:#61676c;background-color:#fafafa><code><span>bevy = { git = "https://github.com/mitchty/bevy", branch = "colorplane-wasm" }
</span></code></pre><p>This branch:<pre style=color:#61676c;background-color:#fafafa><code><span>bevy = { git = "https://github.com/mitchty/bevy", branch = "colorplane-wasm-fix" }
</span></code></pre><ul><li>If relevant, what platforms did you test these changes on, and are there any important ones you can’t test?</ul><p>I tried testing on all the systems I setup cross compilation for which is most of em methinks/mehopes.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The developer was working with Bevy’s new color plane widget in the feathers UI system and encountered a WebGL compatibility issue when targeting WebAssembly (wasm) platforms. The widget worked correctly on native platforms like Linux, macOS, and Windows, but failed to render on WebGL builds in browsers like Safari, Firefox, and Chrome.<p>The root cause was a buffer alignment issue specific to WebGL’s stricter uniform buffer requirements. In WebGL 2.0 (used by wgpu’s WebGL backend), uniform buffer objects require 16-byte alignment for structures. The original implementation used a single <code>f32</code> (4 bytes) for the <code>fixed_channel</code> uniform, which didn’t meet this alignment requirement, causing the shader to fail validation on WebGL targets.<p>This type of alignment issue is common when porting graphics code to WebGL, as native GPU APIs often have more flexible alignment rules. The WebGL specification enforces stricter alignment to ensure portability across different GPU drivers and hardware configurations.<p>The solution follows established patterns already present in Bevy’s codebase for handling WebGL alignment constraints. The developer added conditional padding to both the shader code and the Rust material struct definition, ensuring 16-byte alignment only when targeting WebGL on wasm platforms.<p>In the shader (<code>color_plane.wgsl</code>), the change involved wrapping the <code>fixed_channel</code> uniform in a struct and conditionally adding a <code>vec3&LTf32></code> padding field when the <code>SIXTEEN_BYTE_ALIGNMENT</code> preprocessor define is active. This padding adds 12 bytes to the struct, bringing the total size to 16 bytes (4 bytes for the <code>f32</code> plus 12 bytes for the <code>vec3&LTf32></code>).<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>struct ColorPlaneUniform {
</span><span>  fixed_channel : f32,
</span><span>#ifdef SIXTEEN_BYTE_ALIGNMENT
</span><span>  _webgl2_padding_12b : vec3&LTf32>,
</span><span>#endif
</span><span>}
</span></code></pre><p>The corresponding Rust code in <code>color_plane.rs</code> needed to mirror this structure. The developer added a conditional field to the <code>ColorPlaneMaterial</code> struct using Rust’s <code>cfg</code> attributes:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(</span><span style=color:#f29718>all</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"webgl"</span><span style=color:#61676ccc>,</span><span> target_arch </span><span style=color:#ed9366>= </span><span style=color:#86b300>"wasm32"</span><span style=color:#61676ccc>, </span><span style=color:#f29718>not</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"webgpu"</span><span>)))]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>uniform</span><span>(0)]
</span><span>_webgl2_padding_12b</span><span style=color:#61676ccc>:</span><span> Vec3</span><span style=color:#61676ccc>,
</span></code></pre><p>This field is only included when building for wasm32 with the <code>webgl</code> feature enabled and the <code>webgpu</code> feature disabled. The padding is initialized to <code>Default::default()</code> (which for <code>Vec3</code> is <code>Vec3::ZERO</code>) when creating the material.<p>The developer also needed to update the feature propagation in the Cargo.toml files. They added <code>webgl</code> and <code>webgpu</code> features to <code>bevy_feathers/Cargo.toml</code> and connected the <code>bevy_feathers</code> crate to the existing <code>webgl</code> and <code>webgpu</code> features in <code>bevy_internal/Cargo.toml</code>. This ensures that when users enable the <code>webgl</code> or <code>webgpu</code> features at the top level, they properly propagate to the feathers crate.<p>The implementation maintains compatibility with all existing platforms - native builds remain unchanged, and WebGPU builds (which don’t have the same alignment constraints) also remain unaffected. The padding only applies to WebGL builds targeting wasm32.<p>This approach demonstrates good platform-specific optimization while maintaining clean separation of concerns. The WebGL-specific code is clearly marked and isolated, making it easy for developers to understand why the padding exists and when it applies.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[ColorPlane Widget] --> B[ColorPlaneMaterial Struct]
</span><span>    A --> C[color_plane.wgsl Shader]
</span><span>    B --> D{Rust Compilation}
</span><span>    C --> E{Shader Compilation}
</span><span>    
</span><span>    D --> F[Native Build: No Padding]
</span><span>    D --> G[WASM32 + WebGL Build: Add Vec3 Padding]
</span><span>    
</span><span>    E --> H[Native/WebGPU: SIXTEEN_BYTE_ALIGNMENT not defined]
</span><span>    E --> I[WebGL: SIXTEEN_BYTE_ALIGNMENT defined]
</span><span>    
</span><span>    G --> J[16-byte aligned uniform buffer]
</span><span>    I --> J
</span><span>    
</span><span>    F --> K[4-byte uniform buffer works]
</span><span>    H --> K
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-feathers-src-assets-shaders-color-plane-wgsl-13-6><code>crates/bevy_feathers/src/assets/shaders/color_plane.wgsl</code> (+13/-6)</h3><p>This shader file was modified to wrap the uniform in a struct and conditionally add padding for WebGL builds.<p><strong>Key changes:</strong><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>@group(1) @binding(0) var&LTuniform> fixed_channel: f32;
</span><span>
</span><span>// After:
</span><span>struct ColorPlaneUniform {
</span><span>  fixed_channel : f32,
</span><span>#ifdef SIXTEEN_BYTE_ALIGNMENT
</span><span>  _webgl2_padding_12b : vec3&LTf32>,
</span><span>#endif
</span><span>}
</span><span>
</span><span>@group(1) @binding(0) var&LTuniform> uniform_data : ColorPlaneUniform;
</span></code></pre><p>The shader also updated all references from <code>fixed_channel</code> to <code>uniform_data.fixed_channel</code> to match the new struct access pattern.<h3 id=crates-bevy-feathers-src-controls-color-plane-rs-6-0><code>crates/bevy_feathers/src/controls/color_plane.rs</code> (+6/-0)</h3><p>The Rust material struct was updated to include conditional padding for WebGL builds on wasm32.<p><strong>Key changes:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added to ColorPlaneMaterial struct:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(</span><span style=color:#f29718>all</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"webgl"</span><span style=color:#61676ccc>,</span><span> target_arch </span><span style=color:#ed9366>= </span><span style=color:#86b300>"wasm32"</span><span style=color:#61676ccc>, </span><span style=color:#f29718>not</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"webgpu"</span><span>)))]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>uniform</span><span>(0)]
</span><span>_webgl2_padding_12b</span><span style=color:#61676ccc>:</span><span> Vec3</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Added to material creation:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(</span><span style=color:#f29718>all</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"webgl"</span><span style=color:#61676ccc>,</span><span> target_arch </span><span style=color:#ed9366>= </span><span style=color:#86b300>"wasm32"</span><span style=color:#61676ccc>, </span><span style=color:#f29718>not</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"webgpu"</span><span>)))]
</span><span>_webgl2_padding_12b</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Default</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>,
</span></code></pre><h3 id=crates-bevy-feathers-cargo-toml-2-0><code>crates/bevy_feathers/Cargo.toml</code> (+2/-0)</h3><p>Added feature definitions for <code>webgl</code> and <code>webgpu</code> to the feathers crate.<pre class=language-toml data-lang=toml style=color:#61676c;background-color:#fafafa><code class=language-toml data-lang=toml><span>[</span><span style=color:#399ee6>features</span><span>]
</span><span style=color:#abb0b6;font-style:italic># ... existing features
</span><span style=color:#399ee6>webgl </span><span>= []
</span><span style=color:#399ee6>webgpu </span><span>= []
</span></code></pre><h3 id=crates-bevy-internal-cargo-toml-2-0><code>crates/bevy_internal/Cargo.toml</code> (+2/-0)</h3><p>Connected the bevy_feathers crate to the existing webgl and webgpu feature sets.<pre class=language-toml data-lang=toml style=color:#61676c;background-color:#fafafa><code class=language-toml data-lang=toml><span style=color:#399ee6>webgl </span><span>= [
</span><span>  </span><span style=color:#abb0b6;font-style:italic># ... existing dependencies
</span><span>  </span><span style=color:#86b300>"bevy_feathers?/webgl"</span><span style=color:#61676ccc>,
</span><span>]
</span><span>
</span><span style=color:#399ee6>webgpu </span><span>= [
</span><span>  </span><span style=color:#abb0b6;font-style:italic># ... existing dependencies
</span><span>  </span><span style=color:#86b300>"bevy_feathers?/webgpu"</span><span style=color:#61676ccc>,
</span><span>]
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li>WebGL 2.0 Uniform Buffer Object specification: https://www.khronos.org/registry/webgl/specs/latest/2.0/#5.23<li>WGSL memory layout rules: https://www.w3.org/TR/WGSL/#memory-layout<li>Bevy’s WebGL compatibility guidelines: https://bevyengine.org/learn/quick-start/platform-specifics/web/<li>WGPU WebGL backend documentation: https://wgpu.rs/#supported-backends</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_22724.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>