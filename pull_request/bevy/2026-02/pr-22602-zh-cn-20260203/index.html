<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22602 Observer run conditions
        
    </title><meta content="#22602 Observer run conditions" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-03</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2026-02/pr-22602-en-20260203>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=observer-run-conditions>Observer run conditions</h1><h2 id=ji-ben-xin-xi>基本信息</h2><ul><li><strong>标题</strong>: Observer run conditions<li><strong>PR链接</strong>: https://github.com/bevyengine/bevy/pull/22602<li><strong>作者</strong>: jonas-meyer<li><strong>状态</strong>: MERGED<li><strong>标签</strong>: C-Feature, A-ECS, S-Ready-For-Final-Review, M-Release-Note, D-Modest, D-Unsafe<li><strong>创建时间</strong>: 2026-01-19T21:58:49Z<li><strong>合并时间</strong>: 2026-02-03T16:12:26Z<li><strong>合并者</strong>: alice-i-cecile</ul><h2 id=miao-shu-fan-yi>描述翻译</h2><h3 id=mu-biao>目标</h3><p>允许观察者使用运行条件，使其能够基于世界状态进行条件执行——与系统使用 <code>.run_if()</code> 的模式相同。<p>修复 #14195 修复 #21442<h3 id=jie-jue-fang-an>解决方案</h3><p>通过 <code>ObserverSystemExt</code> trait 为观察者系统添加 <code>run_if()</code> 方法。条件存储在 <code>Observer</code> 中，并在运行器中执行前检查。<p>关键实现细节：<ul><li><code>ObserverWithCondition&LTE,B,M,S></code> 包装器保留事件类型信息，以便在实体观察者上实现编译时 <code>EntityEvent</code> 强制。<li>条件必须是 <code>ReadOnlySystem</code>（由 <code>SystemCondition</code> trait 强制执行），与系统运行条件一致。<li>多个条件以 AND 语义链式组合，第一个 false 会短路。</ul><p>这比<a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/issues/21442#issuecomment-3765694484 target=_blank>这里</a>提到的要复杂一些，因为我们需要完整的系统风格 API：链式 run_ifs、带有编译时 <code>EntityEvent</code> 检查的实体观察者，以及与 <code>add_observer</code>/<code>observe</code> 的配合使用。<p>这迫使实现使用了类型包装器 + 标记类型 + <code>IntoObserver</code>/<code>IntoEntityObserver</code>，并且条件必须在生成时初始化（因此钩子必须接受/初始化/恢复）。运行器还需要在运行观察者之前进行安全检查。<h3 id=ce-shi>测试</h3><ul><li>新增 7 个测试，涵盖： <ul><li>条件阻止/允许执行<li>多个条件（全部为真 / 一个为假）<li>带有条件的实体观察者<li>基于资源的条件<li><code>Observer::new()</code> 上的构建器模式</ul><li>所有现有测试通过 (<code>cargo test -p bevy_ecs</code>)<li>使用空格键切换更新了 <code>observers.rs</code> 示例</ul><hr><h3 id=zhan-shi>展示</h3><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Resource)]
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>GameActive</span><span>(</span><span style=color:#fa6e32>bool</span><span>)</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// 全局观察者 - 仅在游戏激活时运行
</span><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_observer</span><span>(
</span><span>    on_damage</span><span style=color:#ed9366>.</span><span style=color:#f07171>run_if</span><span>(|</span><span style=color:#ff8f40>state</span><span style=color:#61676ccc>: </span><span>Res&LTGameActive>| state</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0</span><span>)
</span><span>)</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// 链式条件（AND 语义）
</span><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_observer</span><span>(
</span><span>    on_damage
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>run_if</span><span>(|</span><span style=color:#ff8f40>state</span><span style=color:#61676ccc>: </span><span>Res&LTGameActive>| state</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0</span><span>)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>run_if</span><span>(|</span><span style=color:#ff8f40>player</span><span style=color:#61676ccc>: </span><span>Query<</span><span style=color:#ed9366>&</span><span>Health, With&LTPlayer>>| player</span><span style=color:#ed9366>.</span><span style=color:#f07171>single</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_ok</span><span>())
</span><span>)</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// 实体观察者
</span><span>commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>(Enemy)</span><span style=color:#ed9366>.</span><span style=color:#f07171>observe</span><span>(
</span><span>    on_hit</span><span style=color:#ed9366>.</span><span style=color:#f07171>run_if</span><span>(|</span><span style=color:#ff8f40>game</span><span style=color:#61676ccc>: </span><span>Res&LTGameActive>| game</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0</span><span>)
</span><span>)</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// 构建器模式
</span><span>world</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>(
</span><span>    Observer</span><span style=color:#ed9366>::</span><span>new(on_event)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>with_entity</span><span>(target)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>run_if</span><span>(some_condition)
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><details><summary>observers.rs 示例</summary> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Resource</span><span style=color:#61676ccc>,</span><span> Default)]
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>ExplosionsEnabled</span><span>(</span><span style=color:#fa6e32>bool</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>toggle_explosions</span><span>(</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>enabled</span><span style=color:#61676ccc>: </span><span>ResMut&LTExplosionsEnabled>, </span><span style=color:#ff8f40>input</span><span style=color:#61676ccc>: </span><span>Res&LTButtonInput&LTKeyCode>>) {
</span><span>    </span><span style=color:#fa6e32>if</span><span> input</span><span style=color:#ed9366>.</span><span style=color:#f07171>just_pressed</span><span>(KeyCode</span><span style=color:#ed9366>::</span><span>Space) {
</span><span>        enabled</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0 </span><span style=color:#ed9366>= !</span><span>enabled</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#f07171>info!</span><span>(</span><span style=color:#86b300>"Explosions {}"</span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>if</span><span> enabled</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0 </span><span>{ </span><span style=color:#86b300>"enabled" </span><span>} </span><span style=color:#fa6e32>else </span><span>{ </span><span style=color:#86b300>"disabled" </span><span>})</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>setup</span><span>(</span><span style=color:#ff8f40>app</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> App) {
</span><span>    app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_observer</span><span>(
</span><span>        explode_mine</span><span style=color:#ed9366>.</span><span style=color:#f07171>run_if</span><span>(|</span><span style=color:#ff8f40>enabled</span><span style=color:#61676ccc>: </span><span>Res&LTExplosionsEnabled>| enabled</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0</span><span>)
</span><span>    )</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre></details><h2 id=zhe-ge-prde-gu-shi>这个PR的故事</h2><p>这个PR开始于一个实际的需求：Bevy的观察者(Observer)系统缺乏条件执行能力。在Bevy ECS中，观察者用于响应事件，类似于回调函数，但当开发者需要在特定条件下才执行观察者时，之前没有直接的方法。系统(Systems)已经有<code>.run_if()</code>方法，但观察者没有。<p>问题在issue #14195和#21442中明确提出。开发者需要让观察者只在某些资源存在或某些状态为真时才运行，例如只在游戏未暂停时执行伤害处理，或者只在玩家存在时处理事件。<p>这个PR的目标很直接：为观察者添加运行条件，使其API与系统保持一致。但实现起来比预期复杂，因为需要保持现有的类型安全特性和编译时检查。<h3 id=he-xin-tiao-zhan>核心挑战</h3><p>观察者有两个主要使用场景：全局观察者（通过<code>add_observer</code>添加）和实体观察者（通过<code>observe</code>方法附加到特定实体）。对于实体观察者，Bevy要求在编译时验证事件类型实现了<code>EntityEvent</code> trait。这意味着任何解决方案都不能破坏现有的类型检查。<p>另一个挑战是条件需要在观察者被触发时动态评估，这涉及到：<ol><li>将条件存储在观察者内部<li>在观察者运行前评估所有条件<li>保持条件系统与普通系统运行条件相同的语义</ol><h3 id=jie-jue-fang-an-jia-gou>解决方案架构</h3><p>开发者采用了分层的设计。首先创建了<code>ObserverCondition</code>结构体来包装条件系统：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>ObserverCondition </span><span>{
</span><span>    condition</span><span style=color:#61676ccc>:</span><span> BoxedCondition,
</span><span>}
</span></code></pre><p>这个结构体负责条件的初始化和检查。关键的设计决策是让条件系统与普通系统使用相同的<code>BoxedCondition</code>类型，确保API一致性。<p>然后引入了<code>ObserverWithCondition&LTE, B, M, S></code>包装器：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>ObserverWithCondition</span><span>&LTE</span><span style=color:#61676ccc>:</span><span> Event, B</span><span style=color:#61676ccc>:</span><span> Bundle, M, S</span><span style=color:#61676ccc>: </span><span>IntoObserverSystem&LTE, B, M>> {
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) system</span><span style=color:#61676ccc>:</span><span> S,
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) conditions</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Vec</span><span>&LTBoxedCondition>,
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) _marker</span><span style=color:#61676ccc>: </span><span>PhantomData<</span><span style=color:#fa6e32>fn</span><span>() </span><span style=color:#61676ccc>-> </span><span>(E, B, M)>,
</span><span>}
</span></code></pre><p>这个包装器是关键所在。它保留了事件类型<code>E</code>、bundle类型<code>B</code>和marker类型<code>M</code>的信息，这使得它可以在编译时进行类型检查。<code>_marker</code>字段确保类型参数在编译时被使用，防止类型擦除。<h3 id=kuo-zhan-traitshe-ji>扩展trait设计</h3><p>为了提供流畅的API，添加了<code>ObserverSystemExt</code> trait：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub trait </span><span style=color:#399ee6>ObserverSystemExt</span><span>&LTE: Event, B: Bundle, M>: IntoObserverSystem&LTE, B, M> + Sized {
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>run_if</span><span>&LTC, CM>(</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>condition</span><span style=color:#61676ccc>:</span><span> C) </span><span style=color:#61676ccc>-> </span><span>ObserverWithCondition&LTE, B, M, </span><span style=color:#fa6e32>Self</span><span>>
</span><span>    </span><span style=color:#fa6e32>where
</span><span>        C</span><span style=color:#61676ccc>: </span><span>SystemCondition&LTCM>;
</span><span>}
</span></code></pre><p>这个trait为所有观察者系统添加了<code>.run_if()</code>方法，返回<code>ObserverWithCondition</code>包装器。这使得链式调用成为可能：<code>observer.run_if(cond1).run_if(cond2)</code>。<h3 id=tong-yi-ru-kou-dian>统一入口点</h3><p>为了处理不同类型的观察者输入（普通系统、带条件的系统、已构建的Observer实例），引入了两个新的trait：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub trait </span><span style=color:#399ee6>IntoObserver</span><span>&LTMarker>: Send + 'static {
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>into_observer</span><span>(</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-></span><span> Observer</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#fa6e32>pub trait </span><span style=color:#399ee6>IntoEntityObserver</span><span>&LTMarker>: Send + 'static {
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>into_observer_for_entity</span><span>(</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>entity</span><span style=color:#61676ccc>:</span><span> Entity) </span><span style=color:#61676ccc>-></span><span> Observer</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>这些trait替代了之前直接使用<code>IntoObserverSystem</code>的方法签名。<code>add_observer</code>现在接受<code>impl IntoObserver</code>，而<code>observe</code>接受<code>impl IntoEntityObserver</code>。这种设计提供了灵活性，同时保持了类型安全。<h3 id=tiao-jian-zhi-xing-ji-zhi>条件执行机制</h3><p>在运行器层面，修改了观察者的执行流程。在<code>runner.rs</code>中，在执行观察者系统之前添加了条件检查：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let mut</span><span> should_run </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>true</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>for</span><span> condition </span><span style=color:#ed9366>in</span><span> state</span><span style=color:#ed9366>.</span><span>conditions</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter_mut</span><span>() {
</span><span>    should_run </span><span style=color:#ed9366>&= </span><span style=color:#fa6e32>unsafe </span><span>{ condition</span><span style=color:#ed9366>.</span><span style=color:#f07171>check</span><span>(world) }</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>should_run {
</span><span>    </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>这里的安全注释很重要：条件系统被限制为只读系统(<code>ReadOnlySystem</code>)，因此它们不会引起别名问题。调用者必须确保世界单元格对条件系统的参数有效。<h3 id=chu-shi-hua-liu-cheng>初始化流程</h3><p>条件的初始化需要特别处理，因为观察者可能通过命令(command)或钩子(hook)添加。在<code>hook_on_add</code>函数中，现在会提取条件、初始化它们，然后再存回观察者：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let mut</span><span> conditions </span><span style=color:#ed9366>= </span><span>{
</span><span>    </span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#fa6e32>mut</span><span> observe) </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span>get_mut</span><span style=color:#ed9366>::</span><span>&LTObserver>(entity) </span><span style=color:#fa6e32>else </span><span>{
</span><span>        </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span>    }</span><span style=color:#61676ccc>;
</span><span>    core</span><span style=color:#ed9366>::</span><span>mem</span><span style=color:#ed9366>::</span><span>take(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> observe</span><span style=color:#ed9366>.</span><span>conditions)
</span><span>}</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>for</span><span> condition </span><span style=color:#ed9366>in &</span><span style=color:#fa6e32>mut</span><span> conditions {
</span><span>    condition</span><span style=color:#ed9366>.</span><span style=color:#f07171>initialize</span><span>(world)</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#fa6e32>mut</span><span> observe) </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span>get_mut</span><span style=color:#ed9366>::</span><span>&LTObserver>(entity) {
</span><span>    observe</span><span style=color:#ed9366>.</span><span>conditions </span><span style=color:#ed9366>=</span><span> conditions</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>使用<code>core::mem::take</code>确保了在初始化期间不会持有对观察者的可变引用，避免了借用冲突。<h3 id=ce-shi-ce-lue>测试策略</h3><p>PR包含了全面的测试，验证了各种场景：<ul><li>条件为真/假时的观察者执行<li>多个条件的AND语义<li>条件重新评估（资源变化后）<li>实体观察者与条件的配合<li>构建器模式</ul><p>这些测试不仅验证了功能正确性，还验证了变更检测的正确性。一个有趣的测试展示了条件与变更检测的交互：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>observer</span><span style=color:#ed9366>.</span><span style=color:#f07171>run_if</span><span>(|</span><span style=color:#ff8f40>res1</span><span style=color:#61676ccc>: </span><span>Res&LTRunConditionFlag>| res1</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_changed</span><span>())
</span><span>       </span><span style=color:#ed9366>.</span><span style=color:#f07171>run_if</span><span>(|</span><span style=color:#ff8f40>res2</span><span style=color:#61676ccc>: </span><span>Res&LTBool2>| res2</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_changed</span><span>())
</span></code></pre><p>这个测试确保当条件使用<code>is_changed()</code>时，行为符合预期。<h3 id=shi-li-geng-xin>示例更新</h3><p><code>observers.rs</code>示例被更新以展示新功能。添加了<code>ExplosionsEnabled</code>资源，并通过空格键切换其状态。观察者现在只在爆炸启用时运行：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_observer</span><span>(
</span><span>    explode_mine</span><span style=color:#ed9366>.</span><span style=color:#f07171>run_if</span><span>(|</span><span style=color:#ff8f40>enabled</span><span style=color:#61676ccc>: </span><span>Res&LTExplosionsEnabled>| enabled</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0</span><span>)
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><p>这个示例直观地展示了运行条件的实用性。<h3 id=she-ji-quan-heng>设计权衡</h3><p>实现中做了几个重要的设计决策：<ol><li><p><strong>AND语义</strong>：多个条件使用AND连接，所有条件必须为真。这与系统运行条件的行为一致。</p><li><p><strong>无短路求值</strong>：文档明确指出，链式的<code>.run_if()</code>调用不会短路——所有条件每次都会运行。这是为了保持变更检测的正确性。如果需要短路行为，可以使用<code>.run_if(a.and(b))</code>，但要注意这可能导致陈旧的<code>Changed&LTT></code>检测。</p><li><p><strong>编译时类型安全</strong>：通过<code>ObserverWithCondition</code>包装器保持实体观察者的类型检查，即使添加了条件也不会削弱类型安全。</p><li><p><strong>统一API</strong>：通过<code>IntoObserver</code>和<code>IntoEntityObserver</code> trait统一了不同输入类型的处理，使API更加一致和灵活。</p></ol><h3 id=ying-xiang>影响</h3><p>这个PR为Bevy观察者带来了重要的功能扩展。它使观察者更加灵活，能够根据游戏状态动态控制执行。API设计保持了与现有系统的一致性，降低了学习成本。<p>从架构角度看，这个PR展示了如何在保持向后兼容性和类型安全的同时扩展复杂系统。条件系统的设计与现有系统运行条件共享基础设施，避免了重复实现。<h2 id=ke-shi-hua-biao-shi>可视化表示</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[用户代码] --> B[.run_if(condition)]
</span><span>    B --> C[ObserverWithCondition]
</span><span>    C --> D[IntoObserver/IntoEntityObserver]
</span><span>    D --> E[Observer结构体]
</span><span>    E --> F[包含conditions字段]
</span><span>    F --> G[观察者运行器]
</span><span>    G --> H{检查所有条件}
</span><span>    H -->|全部为真| I[执行观察者系统]
</span><span>    H -->|任一为假| J[跳过执行]
</span><span>    
</span><span>    subgraph "条件系统"
</span><span>        K[SystemCondition trait]
</span><span>        L[ReadOnlySystem约束]
</span><span>        M[BoxedCondition包装]
</span><span>    end
</span><span>    
</span><span>    K --> L
</span><span>    L --> M
</span><span>    M --> F
</span></code></pre><h2 id=guan-jian-wen-jian-bian-geng>关键文件变更</h2><h3 id=crates-bevy-ecs-src-observer-condition-rs-108-0><code>crates/bevy_ecs/src/observer/condition.rs</code> (+108/-0)</h3><p><strong>新增文件</strong>，定义观察者运行条件的核心类型。<p>关键代码：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>ObserverCondition </span><span>{
</span><span>    condition</span><span style=color:#61676ccc>:</span><span> BoxedCondition,
</span><span>}
</span><span>
</span><span style=color:#fa6e32>impl </span><span style=color:#399ee6>ObserverCondition </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>new</span><span>&LTM>(</span><span style=color:#ff8f40>condition</span><span style=color:#61676ccc>:</span><span> impl SystemCondition&LTM>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>        </span><span style=color:#fa6e32>Self </span><span>{
</span><span>            condition</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Box</span><span style=color:#ed9366>::</span><span>new(IntoSystem</span><span style=color:#ed9366>::</span><span>into_system(condition))</span><span style=color:#61676ccc>,
</span><span>        }
</span><span>    }
</span><span>    
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>unsafe fn </span><span style=color:#f29718>check</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>:</span><span> UnsafeWorldCell) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>bool </span><span>{
</span><span>        </span><span style=color:#fa6e32>unsafe </span><span>{ </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>condition</span><span style=color:#ed9366>.</span><span style=color:#f07171>run_unsafe</span><span>(()</span><span style=color:#61676ccc>,</span><span> world) }</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_or</span><span>(</span><span style=color:#ff8f40>false</span><span>)
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>ObserverWithCondition</span><span>&LTE</span><span style=color:#61676ccc>:</span><span> Event, B</span><span style=color:#61676ccc>:</span><span> Bundle, M, S</span><span style=color:#61676ccc>: </span><span>IntoObserverSystem&LTE, B, M>> {
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) system</span><span style=color:#61676ccc>:</span><span> S,
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) conditions</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Vec</span><span>&LTBoxedCondition>,
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) _marker</span><span style=color:#61676ccc>: </span><span>PhantomData<</span><span style=color:#fa6e32>fn</span><span>() </span><span style=color:#61676ccc>-> </span><span>(E, B, M)>,
</span><span>}
</span></code></pre><h3 id=crates-bevy-ecs-src-observer-distributed-storage-rs-138-12><code>crates/bevy_ecs/src/observer/distributed_storage.rs</code> (+138/-12)</h3><p><strong>主要修改文件</strong>，更新<code>Observer</code>结构体并添加新trait。<p>关键变更：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 在Observer结构体中添加conditions字段
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>Observer </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... 其他字段
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) conditions</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Vec</span><span>&LTObserverCondition>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 为Observer添加run_if方法
</span><span style=color:#fa6e32>impl </span><span style=color:#399ee6>Observer </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>run_if</span><span>&LTM>(</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>condition</span><span style=color:#61676ccc>:</span><span> impl SystemCondition&LTM>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>conditions</span><span style=color:#ed9366>.</span><span style=color:#f07171>push</span><span>(ObserverCondition</span><span style=color:#ed9366>::</span><span>new(condition))</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 新增IntoObserver trait
</span><span style=color:#fa6e32>pub trait </span><span style=color:#399ee6>IntoObserver</span><span>&LTMarker>: Send + 'static {
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>into_observer</span><span>(</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-></span><span> Observer</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 新增IntoEntityObserver trait
</span><span style=color:#fa6e32>pub trait </span><span style=color:#399ee6>IntoEntityObserver</span><span>&LTMarker>: Send + 'static {
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>into_observer_for_entity</span><span>(</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>entity</span><span style=color:#61676ccc>:</span><span> Entity) </span><span style=color:#61676ccc>-></span><span> Observer</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 新增ObserverSystemExt trait
</span><span style=color:#fa6e32>pub trait </span><span style=color:#399ee6>ObserverSystemExt</span><span>&LTE: Event, B: Bundle, M>: IntoObserverSystem&LTE, B, M> + Sized {
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>run_if</span><span>&LTC, CM>(</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>condition</span><span style=color:#61676ccc>:</span><span> C) </span><span style=color:#61676ccc>-> </span><span>ObserverWithCondition&LTE, B, M, </span><span style=color:#fa6e32>Self</span><span>>
</span><span>    </span><span style=color:#fa6e32>where
</span><span>        C</span><span style=color:#61676ccc>: </span><span>SystemCondition&LTCM>;
</span><span>}
</span></code></pre><h3 id=crates-bevy-ecs-src-observer-runner-rs-20-0><code>crates/bevy_ecs/src/observer/runner.rs</code> (+20/-0)</h3><p><strong>修改运行器</strong>，添加条件检查逻辑。<p>关键代码：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 在执行观察者系统前添加条件检查
</span><span style=color:#fa6e32>let mut</span><span> should_run </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>true</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>for</span><span> condition </span><span style=color:#ed9366>in</span><span> state</span><span style=color:#ed9366>.</span><span>conditions</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter_mut</span><span>() {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// SAFETY: See the safety comment above.
</span><span>    should_run </span><span style=color:#ed9366>&= </span><span style=color:#fa6e32>unsafe </span><span>{ condition</span><span style=color:#ed9366>.</span><span style=color:#f07171>check</span><span>(world) }</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>should_run {
</span><span>    </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=crates-bevy-ecs-src-observer-mod-rs-215-6><code>crates/bevy_ecs/src/observer/mod.rs</code> (+215/-6)</h3><p><strong>修改模块主文件</strong>，更新API并添加测试。<p>关键变更：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 更新add_observer方法签名
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>add_observer</span><span>&LTM>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>observer</span><span style=color:#61676ccc>:</span><span> impl IntoObserver&LTM>) </span><span style=color:#61676ccc>-> </span><span>EntityWorldMut<'</span><span style=color:#ed9366>_</span><span>> {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>(observer</span><span style=color:#ed9366>.</span><span style=color:#f07171>into_observer</span><span>())
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 添加7个新测试验证运行条件功能
</span></code></pre><h3 id=examples-ecs-observers-rs-32-7><code>examples/ecs/observers.rs</code> (+32/-7)</h3><p><strong>更新示例</strong>，展示运行条件的使用。<p>关键变更：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 添加资源控制爆炸是否启用
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Resource)]
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>ExplosionsEnabled</span><span>(</span><span style=color:#fa6e32>bool</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 添加系统切换爆炸状态
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>toggle_explosions</span><span>(</span><span style=color:#ff8f40>keyboard</span><span style=color:#61676ccc>: </span><span>Res&LTButtonInput&LTKeyCode>>, </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>enabled</span><span style=color:#61676ccc>: </span><span>ResMut&LTExplosionsEnabled>) {
</span><span>    </span><span style=color:#fa6e32>if</span><span> keyboard</span><span style=color:#ed9366>.</span><span style=color:#f07171>just_pressed</span><span>(KeyCode</span><span style=color:#ed9366>::</span><span>Space) {
</span><span>        enabled</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0 </span><span style=color:#ed9366>= !</span><span>enabled</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#f07171>info!</span><span>(</span><span style=color:#86b300>"Explosions {}"</span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>if</span><span> enabled</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0 </span><span>{ </span><span style=color:#86b300>"ENABLED" </span><span>} </span><span style=color:#fa6e32>else </span><span>{ </span><span style=color:#86b300>"DISABLED" </span><span>})</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 观察者使用运行条件
</span><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_observer</span><span>(
</span><span>    explode_mine</span><span style=color:#ed9366>.</span><span style=color:#f07171>run_if</span><span>(|</span><span style=color:#ff8f40>enabled</span><span style=color:#61676ccc>: </span><span>Res&LTExplosionsEnabled>| enabled</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0</span><span>)
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=release-content-release-notes-observer-run-conditions-md-26-0><code>release-content/release-notes/observer_run_conditions.md</code> (+26/-0)</h3><p><strong>新增发布说明</strong>，记录新功能。<h2 id=jin-yi-bu-yue-du>进一步阅读</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_ecs/latest/bevy_ecs/observer/index.html target=_blank>Bevy观察者文档</a> - 官方观察者系统文档<li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_ecs/latest/bevy_ecs/system/trait.IntoSystem.html#method.run_if target=_blank>系统运行条件</a> - 系统运行条件的设计和实现<li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_ecs/latest/bevy_ecs/event/trait.EntityEvent.html target=_blank>EntityEvent trait</a> - 实体事件的定义和用途<li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/std/marker/struct.PhantomData.html target=_blank>Rust PhantomData</a> - 理解类型标记模式<li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/programming/ecs-intro.html target=_blank>Bevy ECS架构</a> - Bevy ECS整体架构介绍</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_22602.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>