<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #23082 building bevy with only feature bevy_input_focus fails
        
    </title><meta content="#23082 building bevy with only feature bevy_input_focus fails" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-21</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2026-02/pr-23082-en-20260221>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: building bevy with only feature bevy_input_focus fails<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/23082<li><strong>Author</strong>: mockersf<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, D-Trivial, A-UI, S-Ready-For-Final-Review<li><strong>Created</strong>: 2026-02-20T21:12:00Z<li><strong>Merged</strong>: 2026-02-21T01:03:16Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>目标：<ul><li><code>cargo build --features bevy_input_focus --no-default-features</code> 构建失败，报错：</ul><pre style=color:#61676c;background-color:#fafafa><code><span>error[E0599]: no method named `sqrt` found for type `f32` in the current scope
</span><span>   --> crates/bevy_input_focus/src/navigator.rs:112:40
</span><span>    |
</span><span>112 |     let distance = (dx * dx + dy * dy).sqrt();
</span><span>    |                                        ^^^^ method not found in `f32`
</span></code></pre><p>解决方案：<ul><li>使用来自 <code>bevy_math</code> 的 <code>sqrt</code> 函数。</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>这个PR的故事始于一个具体的构建错误。开发者尝试使用命令 <code>cargo build --features bevy_input_focus --no-default-features</code> 编译 Bevy 引擎时，构建过程失败了。这个命令的含义是只启用 <code>bevy_input_focus</code> 这一个功能（feature），并禁用所有默认功能。编译器的错误信息直指问题核心：在 <code>navigator.rs</code> 文件的第112行，代码试图在 <code>f32</code> 类型上调用 <code>.sqrt()</code> 方法，但编译器在当前作用域内找不到这个方法。<p>在Rust中，为基本类型（如 <code>f32</code>、<code>f64</code>）实现的方法（比如数学运算）通常来自标准库 <code>std</code> 或者核心库 <code>core</code>。然而，这里的问题与条件编译（conditional compilation）有关。当使用 <code>--no-default-features</code> 标志时，<code>bevy_input_focus</code> 模块被独立编译，它可能没有引入通常通过其他默认功能（如 <code>bevy_math</code>）提供的必要的 trait 实现。具体来说，<code>f32</code> 的 <code>.sqrt()</code> 方法是通过 <code>std</code> 的 <code>f32</code> 类型自带的，但在某些严格的 <code>no_std</code> 或特定特性配置环境下，其直接的 trait 实现可能不可见或未被引入。更常见且保险的做法是使用 Bevy 自己的数学库 <code>bevy_math</code> 提供的函数，它封装了这些操作并确保了跨不同特性配置的一致性。<p>问题的解决方案非常直接，体现了软件工程中一个常见的模式：当某个功能依赖一个可能因配置不同而变得不可用的隐式实现时，最佳实践是显式地依赖一个稳定的、受控的接口。开发者没有试图去调整复杂的特性依赖或条件编译属性，而是简单地修改了一行代码。将原先对 <code>f32</code> 原生方法的调用 <code>(dx * dx + dy * dy).sqrt()</code>，替换为对 <code>bevy_math::ops::sqrt</code> 函数的显式调用。<p>这个改动很小，但很重要。它确保了 <code>bevy_input_focus</code> 模块在作为独立功能编译时，其功能不依赖于隐式的、可能因编译环境而变化的 trait 实现。<code>bevy_math::ops::sqrt</code> 函数被设计为在各种配置下都可用，它提供了 <code>f32</code> 平方根运算的一个稳定抽象层。通过这个改动，模块的编译不再依赖于是否通过其他特性间接引入了 <code>std</code> 中 <code>f32</code> 的完整方法集，而是明确地声明了对 <code>bevy_math</code> crate 中特定功能的依赖。<p>从工程角度看，这次修复强调了在模块化、可配置的大型项目中管理依赖关系的重要性。它展示了如何处理因条件编译导致的“隐式依赖缺失”问题。修复方案是低风险且高效的，仅更改一行代码就解决了构建阻塞问题，没有引入新的逻辑或影响现有功能，因此可以被快速审查和合并。<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    subgraph "Before Fix"
</span><span>        A[bevy_input_focus] -- Implicitly depends on --> B[std's f32 impl]
</span><span>        B -- .sqrt() method may be missing under --no-default-features --> C[Build Failure]
</span><span>    end
</span><span>
</span><span>    subgraph "After Fix"
</span><span>        D[bevy_input_focus] -- Explicitly calls --> E[bevy_math::ops::sqrt]
</span><span>        E -- Provides stable sqrt function --> F[Successful Build]
</span><span>    end
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ul><li><code>crates/bevy_input_focus/src/navigator.rs</code> (+1/-1)</ul><p>这个文件包含了修复构建错误的唯一修改。<code>navigator.rs</code> 中的 <code>score_candidate</code> 函数用于计算UI导航中焦点候选元素的分数，其中需要计算两个矩形之间的欧几里得距离。<ol><li><p><strong>修改内容与原因</strong>： 修改将距离计算中的平方根操作，从依赖 <code>f32</code> 的原生方法改为使用 <code>bevy_math</code> crate 提供的显式函数。这确保了在仅启用 <code>bevy_input_focus</code> 特性时，必要的数学运算依然可用。</p><li><p><strong>代码修改对比</strong>：</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// File: crates/bevy_input_focus/src/navigator.rs
</span><span style=color:#abb0b6;font-style:italic>// Before (Line 112):
</span><span style=color:#fa6e32>let</span><span> distance </span><span style=color:#ed9366>= </span><span>(dx </span><span style=color:#ed9366>*</span><span> dx </span><span style=color:#ed9366>+</span><span> dy </span><span style=color:#ed9366>*</span><span> dy)</span><span style=color:#ed9366>.</span><span style=color:#f07171>sqrt</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> distance </span><span style=color:#ed9366>= </span><span>bevy_math</span><span style=color:#ed9366>::</span><span>ops</span><span style=color:#ed9366>::</span><span>sqrt(dx </span><span style=color:#ed9366>*</span><span> dx </span><span style=color:#ed9366>+</span><span> dy </span><span style=color:#ed9366>*</span><span> dy)</span><span style=color:#61676ccc>;
</span></code></pre><li><p><strong>与PR目标的关联</strong>： 这行代码的修改直接解决了PR描述中提到的构建错误，是本次PR的核心所在。</p></ol><h2 id=further-reading>Further Reading</h2><ol><li><p><strong>Rust 条件编译（Conditional Compilation）</strong>:</p> <ul><li>Rust 官方文档关于 <code>#[cfg]</code> 属性的章节对于理解特性（features）如何控制代码编译很有帮助。</ul><li><p><strong>Bevy 引擎的特性系统</strong>:</p> <ul><li>查看 Bevy 项目的 <code>Cargo.toml</code> 文件可以了解其如何定义默认特性和可选特性，这有助于理解模块间的依赖关系。</ul><li><p><strong>Rust 的 Orphan Rule 和 Trait 实现</strong>:</p> <ul><li>深入理解 Rust 的 trait 一致性规则（orphan rule）可以解释为何在某些情况下不能轻易地为外部类型（如 <code>f32</code>）添加 trait 实现，从而理解为何需要像 <code>bevy_math</code> 这样的封装层。</ul></ol><h1 id=full-code-diff>Full Code Diff</h1><p>diff –git a/crates/bevy_input_focus/src/navigator.rs b/crates/bevy_input_focus/src/navigator.rs index 2e984b0088beb..d5504652b1432 100644 — a/crates/bevy_input_focus/src/navigator.rs +++ b/crates/bevy_input_focus/src/navigator.rs @@ -109,7 +109,7 @@ fn score_candidate( let dy = (candidate_rect.min.y - origin_rect.max.y) .max(origin_rect.min.y - candidate_rect.max.y) .max(0.0);<ul><li>let distance = (dx * dx + dy * dy).sqrt();</ul><ul><li><p>let distance = bevy_math::ops::sqrt(dx * dx + dy * dy);</p> <p>// Check max distance if let Some(max_dist) = config.max_search_distance {</p></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_23082.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>