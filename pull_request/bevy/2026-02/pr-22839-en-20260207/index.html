<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22839 Fix non-global `core` references in macros
        
    </title><meta content="#22839 Fix non-global `core` references in macros" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-02/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-02-07</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-02/pr-22839-zh-cn-20260207>中文</a></div></div><div class=pr-content><h1 id=title-fix-non-global-core-references-in-macros>Title: Fix non-global <code>core</code> references in macros</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix non-global <code>core</code> references in macros<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22839<li><strong>Author</strong>: Pedro-0550<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, D-Trivial, C-Code-Quality, S-Ready-For-Final-Review, A-Cross-Cutting, D-Macros<li><strong>Created</strong>: 2026-02-07T01:14:40Z<li><strong>Merged</strong>: 2026-02-07T02:19:06Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Some user-facing macros generate references to <code>core</code> using non-global paths. If a downstream crate has another module named <code>core</code> in scope, it shadows the standard library’s <code>core</code> module and causes a compile error when such macros are used.<p>This PR ensures all references to <code>core</code> in macro outputs use global paths.<h2 id=solution>Solution</h2><p>Added the <code>::</code> prefix to <code>core</code> paths that didn’t already have one.<h2 id=testing>Testing</h2><p>Tested by running compile CI locally.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This pull request addresses a subtle but important namespace collision issue in Bevy’s procedural macros. The problem occurs when downstream crates use Bevy’s macros while also having their own module named <code>core</code>. In Rust, when a local module has the same name as a standard library module, it can shadow the standard library’s module if referenced with a relative path.<p>The issue specifically affects three procedural macro implementations in Bevy’s ECS (Entity Component System) module: <code>derive_component</code>, <code>derive_bundle</code>, and <code>derive_query_data_impl</code>. These macros generate code that references items from Rust’s standard <code>core</code> library, such as <code>core::mem::offset_of</code>, <code>core::iter::empty</code>, and <code>core::default::Default::default</code>. When the generated code uses non-global paths like <code>core::mem::offset_of</code>, and a downstream crate has its own <code>core</code> module, the compiler will resolve the path to the local <code>core</code> module instead of the standard library’s <code>core</code> module. This leads to compile errors because the local <code>core</code> module doesn’t contain the expected items like <code>mem::offset_of</code>.<p>The solution is straightforward but requires careful application across multiple macros. By adding the <code>::</code> prefix to create global paths (like <code>::core::mem::offset_of</code>), we ensure the path always resolves to the crate root’s <code>core</code> module, which is the standard library’s <code>core</code> module when Rust’s prelude is properly configured. This is a common pattern in Rust macro development to avoid namespace collisions.<p>The implementation involved modifying 10 lines across three files. Each change follows the same pattern: adding <code>::</code> before <code>core</code> in paths that were previously relative. For example, in <code>component.rs</code>:<ul><li><code>core::mem::offset_of!(Self, #relationship_member)</code> becomes <code>::core::mem::offset_of!(Self, #relationship_member)</code><li><code>core::default::Default::default()</code> becomes <code>::core::default::Default::default()</code></ul><p>In <code>lib.rs</code>:<ul><li><code>core::iter::empty()</code> becomes <code>::core::iter::empty()</code><li><code>core::mem::MaybeUninit&LTSelf></code> becomes <code>::core::mem::MaybeUninit&LTSelf></code></ul><p>In <code>query_data.rs</code>:<ul><li><code>core::iter::Iterator&LTItem = #path::query::EcsAccessType<'_>></code> becomes <code>::core::iter::Iterator&LTItem = #path::query::EcsAccessType<'_>></code><li><code>core::iter::empty()</code> becomes <code>::core::iter::empty()</code></ul><p>These changes are minimal and focused. They don’t affect the macro’s functionality or performance—they only change how paths are resolved during compilation. The PR maintains backward compatibility because the new global paths resolve to the same items as the previous relative paths when there’s no local <code>core</code> module shadowing the standard library.<p>From an engineering perspective, this fix demonstrates good practice in macro design. When generating code that references standard library items, it’s safer to use global paths to avoid unexpected name resolution issues. The fact that this issue wasn’t caught earlier suggests that the Bevy team and community don’t commonly create modules named <code>core</code>, but it’s still a valid edge case that needed fixing.<p>The testing approach mentioned—running compile CI locally—is appropriate for this type of change. Since the fix is purely syntactic and doesn’t change behavior, verifying that the code still compiles is sufficient. More extensive testing would be needed if the changes affected runtime behavior.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Downstream Crate] --> B[Local core module]
</span><span>    A --> C[Bevy Macros]
</span><span>    C --> D[Generated Code]
</span><span>    D --> E{Path Resolution}
</span><span>    E -->|Non-global path| F[Local core module - ERROR]
</span><span>    E -->|Global path| G[Standard library core - OK]
</span><span>    H[PR #22839] --> I[Add :: prefix to core paths]
</span><span>    I --> J[Always resolves to standard library]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ecs-macros-src-component-rs-4-4><code>crates/bevy_ecs/macros/src/component.rs</code> (+4/-4)</h3><p>This file contains the <code>derive_component</code> macro and related helper functions for deriving relationships between components. The changes fix <code>core</code> path references in generated code for component relationships.<p><strong>Key changes:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>core</span><span style=color:#ed9366>::</span><span>mem</span><span style=color:#ed9366>::</span><span>offset_of</span><span style=color:#ed9366>!</span><span>(</span><span style=color:#fa6e32>Self</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>#</span><span>relationship_member)
</span><span>core</span><span style=color:#ed9366>::</span><span>default</span><span style=color:#ed9366>::</span><span>Default</span><span style=color:#ed9366>::</span><span>default()
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#ed9366>::</span><span>core</span><span style=color:#ed9366>::</span><span>mem</span><span style=color:#ed9366>::</span><span>offset_of</span><span style=color:#ed9366>!</span><span>(</span><span style=color:#fa6e32>Self</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>#</span><span>relationship_member)
</span><span style=color:#ed9366>::</span><span>core</span><span style=color:#ed9366>::</span><span>default</span><span style=color:#ed9366>::</span><span>Default</span><span style=color:#ed9366>::</span><span>default()
</span></code></pre><h3 id=crates-bevy-ecs-macros-src-lib-rs-3-3><code>crates/bevy_ecs/macros/src/lib.rs</code> (+3/-3)</h3><p>This file contains the <code>derive_bundle</code> macro for creating bundles of components. The changes ensure that iterator creation and <code>MaybeUninit</code> references use global paths.<p><strong>Key changes:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>core</span><span style=color:#ed9366>::</span><span>iter</span><span style=color:#ed9366>::</span><span>empty()
</span><span>core</span><span style=color:#ed9366>::</span><span>mem</span><span style=color:#ed9366>::</span><span>MaybeUninit<</span><span style=color:#fa6e32>Self</span><span>>
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#ed9366>::</span><span>core</span><span style=color:#ed9366>::</span><span>iter</span><span style=color:#ed9366>::</span><span>empty()
</span><span style=color:#ed9366>::</span><span>core</span><span style=color:#ed9366>::</span><span>mem</span><span style=color:#ed9366>::</span><span>MaybeUninit<</span><span style=color:#fa6e32>Self</span><span>>
</span></code></pre><h3 id=crates-bevy-ecs-macros-src-query-data-rs-4-4><code>crates/bevy_ecs/macros/src/query_data.rs</code> (+4/-4)</h3><p>This file contains the <code>derive_query_data_impl</code> macro for creating query data types. The changes fix <code>core</code> path references in iterator-related generated code.<p><strong>Key changes:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>impl </span><span style=color:#399ee6>core</span><span>::</span><span style=color:#399ee6>iter</span><span>::</span><span style=color:#399ee6>Iterator</span><span>&LTItem = </span><span style=color:#f51818>#</span><span style=color:#399ee6>path</span><span>::</span><span style=color:#399ee6>query</span><span>::</span><span style=color:#399ee6>EcsAccessType</span><span><'</span><span style=color:#ed9366>_</span><span>>>
</span><span style=color:#399ee6>core</span><span>::</span><span style=color:#399ee6>iter</span><span>::</span><span style=color:#399ee6>empty</span><span>()
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#399ee6>impl</span><span> ::</span><span style=color:#399ee6>core</span><span>::</span><span style=color:#399ee6>iter</span><span>::</span><span style=color:#399ee6>Iterator</span><span>&LTItem = </span><span style=color:#f51818>#</span><span style=color:#399ee6>path</span><span>::</span><span style=color:#399ee6>query</span><span>::</span><span style=color:#399ee6>EcsAccessType</span><span><'</span><span style=color:#ed9366>_</span><span>>>
</span><span>::</span><span style=color:#399ee6>core</span><span>::</span><span style=color:#399ee6>iter</span><span>::</span><span style=color:#399ee6>empty</span><span>()
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><p><strong>Rust Module System</strong>: The Rust Book’s chapter on modules explains path resolution and the <code>::</code> prefix: https://doc.rust-lang.org/book/ch07-03-paths-for-referring-to-an-item-in-the-module-tree.html</p><li><p><strong>Procedural Macros</strong>: The Rust Reference on procedural macros: https://doc.rust-lang.org/reference/procedural-macros.html</p><li><p><strong>Bevy ECS Macros</strong>: Bevy’s documentation on its ECS macros and how they generate code: https://bevyengine.org/learn/quick-start/ecs/</p><li><p><strong>Name Resolution in Rust</strong>: Detailed explanation of how Rust resolves names, including module shadowing: https://doc.rust-lang.org/nightly/reference/names.html</p><li><p><strong>Common Macro Pitfalls</strong>: Rust API Guidelines on macro design, including avoiding name collisions: https://rust-lang.github.io/api-guidelines/macros.html</p></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-02/pr_22839.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>