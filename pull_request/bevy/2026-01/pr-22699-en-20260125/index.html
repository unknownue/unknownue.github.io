<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22699 Fix occlusion culling
        
    </title><meta content="#22699 Fix occlusion culling" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-01/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-01-25</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-01/pr-22699-zh-cn-20260125>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>Fix occlusion culling<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix occlusion culling<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22699<li><strong>Author</strong>: atlv24<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, P-Crash, S-Ready-For-Final-Review, P-Regression<li><strong>Created</strong>: 2026-01-25T19:53:20Z<li><strong>Merged</strong>: 2026-01-25T20:44:04Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>fix #22655</ul><h2 id=solution>Solution</h2><ul><li>separate readonly storage binding for late phase to make wgpu happy</ul><h2 id=testing>Testing</h2><ul><li>occlusion_culling example no longer crashes</ul><p>finding this was very difficult lol<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR fixes a crash in the occlusion_culling example that was caused by an incorrect WebGPU buffer binding configuration. The issue was a regression introduced in the GPU-driven occlusion culling system, where a buffer that should have been read-only in the late phase of occlusion culling was incorrectly configured as read-write.<p>The problem manifested as a WebGPU validation error because the same buffer resource was being bound with different usage flags (read-write vs read-only) across different pipeline stages. WebGPU’s strict validation requires consistent buffer usage declarations, and when the late phase shader only needed read access but the binding was declared as read-write, it caused a validation failure that resulted in a crash.<p>The developer traced this to a mismatch between the Rust-side bind group layout definitions and the WGSL shader bindings. In the <code>gpu_preprocess.rs</code> file, both early and late phase occlusion culling used the same bind group layout entries, including a read-write storage buffer for <code>LatePreprocessWorkItemIndirectParameters</code>. However, in the WGSL shader (<code>mesh_preprocess.wgsl</code>), the late phase only needed read access to this buffer.<p>The solution involved creating two separate bind group layouts:<ol><li>For the early phase: Includes read-write storage buffers for both <code>PreprocessWorkItem</code> (binding 11) and <code>LatePreprocessWorkItemIndirectParameters</code> (binding 12)<li>For the late phase: Uses a read-only storage buffer for <code>LatePreprocessWorkItemIndirectParameters</code> (binding 12)</ol><p>This required modifying the bind group layout creation in Rust to differentiate between the two phases and updating the WGSL shader to conditionally bind the buffer with the appropriate access mode based on the compilation phase.<p>The fix is minimal and surgical - it only changes the binding declarations without altering any actual rendering logic. The <code>LatePreprocessWorkItemIndirectParameters</code> buffer contains indirect draw parameters that the late phase reads to determine what to render, but doesn’t need to modify. By declaring it as read-only in the late phase, we comply with WebGPU’s safety guarantees while maintaining the necessary functionality.<p>This type of issue is particularly challenging to debug because WebGPU validation errors often provide limited context about the exact mismatch. The developer’s note “finding this was very difficult lol” reflects the difficulty of tracing GPU validation errors back to specific binding declarations in a complex rendering pipeline.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Occlusion Culling System] --> B{Early Phase}
</span><span>    A --> C{Late Phase}
</span><span>    
</span><span>    B --> D[PreprocessWorkItem Buffer]
</span><span>    B --> E[LatePreprocessWorkItemIndirectParameters Buffer]
</span><span>    D -->|read-write| B
</span><span>    E -->|read-write| B
</span><span>    
</span><span>    C --> F[LatePreprocessWorkItemIndirectParameters Buffer]
</span><span>    F -->|read-only| C
</span><span>    
</span><span>    style D fill:#e1f5fe
</span><span>    style E fill:#f3e5f5
</span><span>    style F fill:#f1f8e9
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-pbr-src-render-gpu-preprocess-rs-17-10><code>crates/bevy_pbr/src/render/gpu_preprocess.rs</code> (+17/-10)</h3><p>This file contains the Rust-side bind group layout definitions for the GPU preprocess pipelines. The key change was separating the bind group layouts for early and late phase occlusion culling to use different buffer access modes.<p><strong>Before:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let</span><span> gpu_early_occlusion_culling_bind_group_layout_entries </span><span style=color:#ed9366>=
</span><span>    </span><span style=color:#f07171>gpu_occlusion_culling_bind_group_layout_entries</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend_with_indices</span><span>(((
</span><span>        </span><span style=color:#ff8f40>11</span><span style=color:#61676ccc>,
</span><span>        storage_buffer</span><span style=color:#ed9366>::</span><span>&LTPreprocessWorkItem>(</span><span style=color:#abb0b6;font-style:italic>/*has_dynamic_offset=*/ </span><span style=color:#ff8f40>false</span><span>)</span><span style=color:#61676ccc>,
</span><span>    )</span><span style=color:#61676ccc>,</span><span>))</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> gpu_late_occlusion_culling_bind_group_layout_entries </span><span style=color:#ed9366>=
</span><span>    </span><span style=color:#f07171>gpu_occlusion_culling_bind_group_layout_entries</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><p><strong>After:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let</span><span> gpu_early_occlusion_culling_bind_group_layout_entries </span><span style=color:#ed9366>=
</span><span>    </span><span style=color:#f07171>gpu_occlusion_culling_bind_group_layout_entries</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend_with_indices</span><span>((
</span><span>        (
</span><span>            </span><span style=color:#ff8f40>11</span><span style=color:#61676ccc>,
</span><span>            storage_buffer</span><span style=color:#ed9366>::</span><span>&LTPreprocessWorkItem>(</span><span style=color:#abb0b6;font-style:italic>/*has_dynamic_offset=*/ </span><span style=color:#ff8f40>false</span><span>)</span><span style=color:#61676ccc>,
</span><span>        )</span><span style=color:#61676ccc>,
</span><span>        (
</span><span>            </span><span style=color:#ff8f40>12</span><span style=color:#61676ccc>,
</span><span>            storage_buffer</span><span style=color:#ed9366>::</span><span>&LTLatePreprocessWorkItemIndirectParameters>(
</span><span>                </span><span style=color:#abb0b6;font-style:italic>/*has_dynamic_offset=*/ </span><span style=color:#ff8f40>false</span><span style=color:#61676ccc>,
</span><span>            )</span><span style=color:#61676ccc>,
</span><span>        )</span><span style=color:#61676ccc>,
</span><span>    ))</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> gpu_late_occlusion_culling_bind_group_layout_entries </span><span style=color:#ed9366>=
</span><span>    </span><span style=color:#f07171>gpu_occlusion_culling_bind_group_layout_entries</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend_with_indices</span><span>(((
</span><span>        </span><span style=color:#ff8f40>12</span><span style=color:#61676ccc>,
</span><span>        storage_buffer_read_only</span><span style=color:#ed9366>::</span><span>&LTLatePreprocessWorkItemIndirectParameters>(
</span><span>            </span><span style=color:#abb0b6;font-style:italic>/*has_dynamic_offset=*/ </span><span style=color:#ff8f40>false</span><span style=color:#61676ccc>,
</span><span>        )</span><span style=color:#61676ccc>,
</span><span>    )</span><span style=color:#61676ccc>,</span><span>))</span><span style=color:#61676ccc>;
</span></code></pre><p>The <code>gpu_occlusion_culling_bind_group_layout_entries()</code> function was also modified to remove the binding for <code>LatePreprocessWorkItemIndirectParameters</code> at index 12, since it’s now added separately for each phase.<h3 id=crates-bevy-pbr-src-render-mesh-preprocess-wgsl-6-1><code>crates/bevy_pbr/src/render/mesh_preprocess.wgsl</code> (+6/-1)</h3><p>This WGSL shader file needed corresponding updates to match the Rust-side binding changes. The buffer binding declarations were split between early and late phases with different access modes.<p><strong>Before:</strong><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>#ifdef EARLY_PHASE
</span><span>@group(0) @binding(11) var&LTstorage, read_write> late_preprocess_work_items:
</span><span>    array&LTPreprocessWorkItem>;
</span><span>#endif  // EARLY_PHASE
</span><span>
</span><span>@group(0) @binding(12) var&LTstorage, read_write> late_preprocess_work_item_indirect_parameters:
</span><span>    array&LTLatePreprocessWorkItemIndirectParameters>;
</span></code></pre><p><strong>After:</strong><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>#ifdef EARLY_PHASE
</span><span>@group(0) @binding(11) var&LTstorage, read_write> late_preprocess_work_items:
</span><span>    array&LTPreprocessWorkItem>;
</span><span>
</span><span>@group(0) @binding(12) var&LTstorage, read_write> late_preprocess_work_item_indirect_parameters:
</span><span>    array&LTLatePreprocessWorkItemIndirectParameters>;
</span><span>#endif  // EARLY_PHASE
</span><span>
</span><span>#ifdef LATE_PHASE
</span><span>@group(0) @binding(12) var&LTstorage, read> late_preprocess_work_item_indirect_parameters:
</span><span>    array&LTLatePreprocessWorkItemIndirectParameters>;
</span><span>#endif  // LATE_PHASE
</span></code></pre><p>The key change here is that in the late phase, the indirect parameters buffer is now declared as <code>read</code> instead of <code>read_write</code>, matching the Rust-side binding declaration.<h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://www.w3.org/TR/webgpu/#buffer-usage target=_blank>WebGPU Buffer Usage Validation</a> - Official WebGPU specification on buffer usage constraints<li><a rel="noopener nofollow noreferrer" href=https://docs.rs/wgpu/latest/wgpu/struct.BufferBindingType.html target=_blank>wgpu Buffer Binding Types</a> - Documentation on different buffer binding types in wgpu<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/getting-started/systems/ target=_blank>Bevy Rendering Pipeline</a> - Overview of Bevy’s ECS and rendering architecture<li><a rel="noopener nofollow noreferrer" href=https://interplayoflight.wordpress.com/2023/05/29/a-history-of-gpu-driven-rendering/ target=_blank>GPU-Driven Rendering Techniques</a> - Background on GPU-driven rendering approaches including occlusion culling<li><a rel="noopener nofollow noreferrer" href=https://www.w3.org/TR/WGSL/#storage-buffer target=_blank>WGSL Storage Buffer Access Modes</a> - WGSL specification for storage buffer access modes</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-01/pr_22699.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>