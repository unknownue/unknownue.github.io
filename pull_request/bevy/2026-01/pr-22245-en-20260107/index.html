<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22245 Make `bevy_audio` optional for `android_shared_stdcxx`
        
    </title><meta content="#22245 Make `bevy_audio` optional for `android_shared_stdcxx`" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-01/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-01-07</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-01/pr-22245-zh-cn-20260107>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Make <code>bevy_audio</code> optional for <code>android_shared_stdcxx</code><li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22245<li><strong>Author</strong>: Shatur<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Audio, C-Code-Quality, O-Android, S-Waiting-on-Author<li><strong>Created</strong>: 2025-12-23T16:58:57Z<li><strong>Merged</strong>: 2026-01-07T21:51:06Z<li><strong>Merged By</strong>: cart</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>It’s a bit unexpected to require <code>bevy_audio</code> even when it’s not used with <code>default_platform</code>, which enables <code>android_shared_stdcxx</code>.</ul><h2 id=solution>Solution</h2><ul><li>Treat this feature similar to <code>std</code>. It just enables <code>android_shared_stdcxx</code> on <code>cpal</code> inside <code>bevy_audio</code>.</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The issue began with a feature dependency problem in the Bevy game engine’s build system. Specifically, when developers used the <code>android_shared_stdcxx</code> feature, they were forced to include the entire <code>bevy_audio</code> crate as a dependency, even if they didn’t need audio functionality. This was counterintuitive because <code>android_shared_stdcxx</code> is a platform-specific feature related to Android’s C++ standard library handling, not audio functionality.<p>This behavior stemmed from how the feature was defined in <code>crates/bevy_internal/Cargo.toml</code>. The original implementation had a direct dependency: <code>android_shared_stdcxx = ["bevy_audio/android_shared_stdcxx"]</code>. This meant that enabling the <code>android_shared_stdcxx</code> feature would always activate the corresponding feature in <code>bevy_audio</code>.<p>The root cause was that the <code>cpal</code> crate (Cross-Platform Audio Library), which <code>bevy_audio</code> depends on, has its own <code>android_shared_stdcxx</code> feature. This feature is necessary for Android builds because it enables using a shared C++ standard library on Android platforms. However, not all Bevy projects on Android require audio functionality, so forcing the audio dependency was unnecessary bloat.<p>The solution drew inspiration from how optional dependencies are handled in Cargo features. The developer modified the feature definition to use Cargo’s conditional feature syntax with the <code>?</code> operator: <code>android_shared_stdcxx = ["bevy_audio?/android_shared_stdcxx"]</code>. This change makes the dependency on <code>bevy_audio</code> optional - if <code>bevy_audio</code> is present in the dependency graph, the feature gets forwarded to it; if not, the feature simply doesn’t apply to anything.<p>This approach mirrors how the standard library (<code>std</code>) feature is often handled. The <code>android_shared_stdcxx</code> feature is essentially a configuration flag for Android builds that should propagate to relevant dependencies when they exist, but shouldn’t force inclusion of unnecessary crates.<p>The implementation is minimal but significant. It follows good Cargo feature design practices by making features additive rather than restrictive. This change reduces binary size and build times for Android projects that don’t need audio functionality, while maintaining full compatibility for projects that do use <code>bevy_audio</code>.<p>From an architectural perspective, this change improves the modularity of Bevy’s feature system. Features should enable functionality, not force unnecessary dependencies. The fix demonstrates proper use of Cargo’s feature forwarding syntax, which is particularly important for large, modular codebases like Bevy where different users may need different subsets of functionality.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[android_shared_stdcxx feature] --> B{Conditional Dependency}
</span><span>    B -->|If bevy_audio present| C[bevy_audio crate]
</span><span>    B -->|If bevy_audio absent| D[No audio dependency]
</span><span>    C --> E[cpal/android_shared_stdcxx]
</span><span>    
</span><span>    style A fill:#e1f5fe
</span><span>    style C fill:#f3e5f5
</span><span>    style E fill:#e8f5e8
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-internal-cargo-toml><code>crates/bevy_internal/Cargo.toml</code></h3><p>This is the only file modified in this PR. The change updates the feature definition for <code>android_shared_stdcxx</code> to make the dependency on <code>bevy_audio</code> conditional rather than mandatory.<p><strong>Before:</strong><pre class=language-toml data-lang=toml style=color:#61676c;background-color:#fafafa><code class=language-toml data-lang=toml><span style=color:#abb0b6;font-style:italic># Enable using a shared stdlib for cxx on Android.
</span><span style=color:#399ee6>android_shared_stdcxx </span><span>= [</span><span style=color:#86b300>"bevy_audio/android_shared_stdcxx"</span><span>]
</span></code></pre><p><strong>After:</strong><pre class=language-toml data-lang=toml style=color:#61676c;background-color:#fafafa><code class=language-toml data-lang=toml><span style=color:#abb0b6;font-style:italic># Enable using a shared stdlib for cxx on Android.
</span><span style=color:#399ee6>android_shared_stdcxx </span><span>= [</span><span style=color:#86b300>"bevy_audio?/android_shared_stdcxx"</span><span>]
</span></code></pre><p>The key difference is the addition of the <code>?</code> character after <code>bevy_audio</code>. In Cargo’s feature syntax, this means:<ul><li>If the <code>bevy_audio</code> crate is included in the project (either directly or as a dependency), the <code>android_shared_stdcxx</code> feature will be forwarded to it<li>If <code>bevy_audio</code> is not included, the feature won’t try to activate anything (and won’t cause an error)</ul><p>This change aligns with the PR’s objective of making <code>bevy_audio</code> optional when using the <code>android_shared_stdcxx</code> feature, which is particularly useful for Android projects that don’t require audio functionality.<h2 id=full-code-diff>Full Code Diff</h2><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_internal/Cargo.toml b/crates/bevy_internal/Cargo.toml
</span><span>index 989cddf728d56..1b16fd9de4e85 100644
</span><span style=color:#c594c5>--- a/crates/bevy_internal/Cargo.toml
</span><span style=color:#c594c5>+++ b/crates/bevy_internal/Cargo.toml
</span><span style=color:#c594c5>@@ -262,7 +262,7 @@ </span><span style=color:#399ee6>bevy_gltf = ["dep:bevy_gltf", "bevy_scene", "bevy_pbr"]
</span><span> dynamic_linking = ["bevy_diagnostic/dynamic_linking"]
</span><span> 
</span><span> # Enable using a shared stdlib for cxx on Android.
</span><span style=color:#f07171>-android_shared_stdcxx = ["bevy_audio/android_shared_stdcxx"]
</span><span style=color:#86b300>+android_shared_stdcxx = ["bevy_audio?/android_shared_stdcxx"]
</span><span> 
</span><span> # Enable AccessKit on Unix backends (currently only works with experimental
</span><span> # screen readers and forks.)
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><strong>Cargo Feature Documentation</strong>: The official Rust Cargo documentation on features provides detailed information about conditional features and the <code>?</code> syntax: https://doc.rust-lang.org/cargo/reference/features.html<li><strong>Bevy’s Feature System</strong>: Understanding how Bevy structures its features can help with similar optimizations: https://bevyengine.org/learn/book/getting-started/features/<li><strong>Android C++ Shared Library</strong>: For context on why <code>android_shared_stdcxx</code> is needed, see Android NDK documentation on C++ runtime libraries: https://developer.android.com/ndk/guides/cpp-support<li><strong>cpal Crate Features</strong>: The cpal crate’s feature documentation explains its Android-specific requirements: https://github.com/RustAudio/cpal<li><strong>Rust Conditional Compilation</strong>: The Rust reference on conditional compilation provides background on how features work under the hood: https://doc.rust-lang.org/reference/conditional-compilation.html</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-01/pr_22245.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>