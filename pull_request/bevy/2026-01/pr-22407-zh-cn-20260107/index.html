<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22407 docs: adds migration guide for Assets<Mesh> retaining render_world only meshes
        
    </title><meta content="#22407 docs: adds migration guide for Assets<Mesh> retaining render_world only meshes" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-01/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-01-07</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2026-01/pr-22407-en-20260107>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: docs: adds migration guide for Assets<mesh> retaining render_world only meshes <li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22407</li> <li><strong>Author</strong>: kfc35</li> <li><strong>Status</strong>: MERGED</li> <li><strong>Labels</strong>: C-Docs, A-Rendering, S-Needs-Review, A-Picking</li> <li><strong>Created</strong>: 2026-01-07T02:07:59Z</li> <li><strong>Merged</strong>: 2026-01-07T05:42:46Z</li> <li><strong>Merged By</strong>: alice-i-cecile</li> <h2 id=description-translation>Description Translation</h2> <p>此PR的目标是<code>release-0.18.0</code>分支，而非<code>main</code>！</p> <h1 id=mu-biao-objective>目标 (Objective)</h1> <ul><li>修复 #22206</ul> <h2 id=jie-jue-fang-an-solution>解决方案 (Solution)</h2> <ul><li>为 #21732 中的变更添加一份迁移指南。鉴于我对网格(Mesh)相关的内容不是特别熟悉，希望能得到更熟悉这些变更和网格系统的开发者审阅！</ul> <p>FYI @robtfm @beicause</p> <h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2> <p>这个PR的故事源于Bevy引擎渲染管线中一个关于资源生命周期的设计变更。在0.17版本及之前，<code>Assets&LTMesh></code>资源的行为有一个潜在问题：当一个网格(Mesh)被标记为<code>RenderAssetUsages::RENDER_WORLD</code>时，意味着它仅用于渲染世界(Render World)，一旦其数据被提取(extract)到渲染世界后，它在主世界的<code>Assets&LTMesh></code>集合中就不再保留其实际数据。这个设计导致了一个问题：如果其他系统在主世界尝试访问一个已被提取的网格的数据，会直接导致程序panic，因为数据已经不存在了。</p> <p>为了解决这个问题，PR #21732 修改了行为：从Bevy 0.18开始，<code>Assets&LTMesh></code>会保留<code>RenderAssetUsages::RENDER_WORLD</code>类型的网格，即使它们的数据已经被提取到渲染世界。这是一个积极的架构改进，因为它消除了因数据访问时机不当导致的意外崩溃，使得资源管理更加健壮。然而，这个改进引入了一个新的挑战：当网格数据在渲染世界时，主世界的代码尝试修改或读取这些数据在逻辑上是不允许的，因为这涉及到跨线程的数据竞争和安全问题（渲染通常发生在独立的线程）。</p> <p>因此，解决方案不是简单地允许访问，而是提供一个安全、显式的机制来让开发者处理这种情况。这就是<code>try_*</code>系列函数被引入的原因。原有的如<code>mesh.insert_attribute()</code>这样的函数被设计为直接修改内部数据。在新的架构下，如果一个网格是<code>RENDER_WORLD</code>类型且已被提取，调用这些函数将导致panic，因为数据不可变或不存在。新的<code>mesh.try_insert_attribute()</code>等函数则返回一个<code>Result</code>类型。如果网格数据可用（例如，它是<code>MAIN_WORLD</code>类型，或者尚未被提取），则操作成功。如果数据已被提取到渲染世界，则返回一个<code>Err(MeshAccessError::ExtractedToRenderWorld)</code>错误。这强制开发者显式处理这种可能的失败情况，从而编写出更健壮的代码。</p> <p>这份迁移指南（PR #22407）的核心任务就是清晰地文档化这一行为变更，并为开发者提供一个从0.17升级到0.18的明确路径。它没有修改任何运行时代码，而是创建了一份详尽的“函数映射表”。这份表格列出了所有受到影响的<code>Mesh</code>方法，并指明了它们在0.17中的原名和在0.18中对应的<code>try_*</code>版本。例如，你需要将<code>mesh.insert_attribute(...)</code>替换为<code>mesh.try_insert_attribute(...)</code>，然后处理其返回的<code>Result</code>。</p> <p>值得注意的是，指南还提到了另一类函数，如<code>mesh.get_vertex_size(...)</code>。这些函数没有对应的<code>try_*</code>版本，但在0.18中，如果调用时网格数据已被提取，它们同样会panic。这可能是出于性能或API简洁性的考虑，同时也提醒开发者，在使用这些函数时需要确保上下文安全（例如，仅在数据确定可用的预处理阶段使用）。</p> <p>从工程角度来看，这个变更体现了几个重要的软件设计原则：</p> <ol><li><strong>Fail-fast 与 明确性</strong>：通过<code>Result</code>类型，将潜在的运行时错误提升为编译时必须处理的类型系统错误，使错误处理路径更加清晰。<li><strong>资源生命周期管理</strong>：明确了<code>RENDER_WORLD</code>资源的所有权转移（数据移动到渲染线程），并通过API强制实施访问规则。<li><strong>向后兼容与平滑迁移</strong>：提供详尽的迁移指南是维护大型项目生态健康的关键。开发者可以根据这份清单系统地更新代码，而不是在运行时遇到神秘的崩溃后再去调试。</ol> <p>总之，这个PR虽然只是一个文档变更，但它是一把关键的“钥匙”，解锁了#21732中重要架构改进的实用价值。它确保了开发者社区能够顺利地从旧有的、可能不安全的模式，过渡到新的、更安全、更明确的资源访问模式。</p> <h2 id=visual-representation>Visual Representation</h2> <pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    subgraph "Main World (逻辑世界)"
</span><span>        A[Assets&LTMesh> 资源集合] --> B{网格使用类型?}
</span><span>        B -- RenderAssetUsages::MAIN_WORLD --> C[数据可被主世界直接访问/修改]
</span><span>        B -- RenderAssetUsages::RENDER_WORLD --> D[数据将被提取]
</span><span>    end
</span><span>
</span><span>    D --> E[Extract阶段]
</span><span>    E --> F[Render World 渲染世界]
</span><span>    
</span><span>    C --> G[调用 mesh.try_*() 成功]
</span><span>    D -.->|数据已提取后| H[在主世界调用 mesh.try_*() 返回 Err(ExtractedToRenderWorld)]
</span><span>    
</span><span>    style C fill:#cfc
</span><span>    style H fill:#fcc
</span></code></pre> <h2 id=key-files-changed>Key Files Changed</h2> <ul><li><code>release-content/migration-guides/assets_mesh_try_functions.md</code> (+125/-0)</ul> <p>这是此PR创建的唯一文件，一个全新的迁移指南文档。它没有“之前”的内容，因为文件是新建的。</p> <p><strong>内容描述</strong>： 该文件是一个结构清晰的迁移指南，专门用于指导开发者适应<code>Assets&LTMesh></code>对<code>RENDER_WORLD</code>网格的保留行为。其核心内容是两个并列的函数列表，分别对应0.17版本（旧函数）和0.18版本（新函数）。它明确告知开发者：如果你的代码可能处理<code>RENDER_WORLD</code>类型的网格，就必须将左侧列表中的函数调用替换为右侧对应的<code>try_*</code>版本，并妥善处理<code>Result</code>。</p> <p><strong>关键代码片段</strong>： 文档中的核心部分是两个对比列表，下面是一个节选：</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 0.17 版本中直接调用的函数（在0.18中，如果网格已提取，这些函数会Panic）
</span><span>mesh</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_attribute</span><span>(</span><span style=color:#ed9366>...</span><span>)
</span><span>mesh</span><span style=color:#ed9366>.</span><span style=color:#f07171>with_inserted_attribute</span><span>(</span><span style=color:#ed9366>...</span><span>)
</span><span>mesh</span><span style=color:#ed9366>.</span><span style=color:#f07171>remove_attribute</span><span>(</span><span style=color:#ed9366>...</span><span>)
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 0.18 版本中对应的安全函数
</span><span>mesh</span><span style=color:#ed9366>.</span><span style=color:#f07171>try_insert_attribute</span><span>(</span><span style=color:#ed9366>...</span><span>)        </span><span style=color:#abb0b6;font-style:italic>// 返回 Result
</span><span>mesh</span><span style=color:#ed9366>.</span><span style=color:#f07171>try_with_inserted_attribute</span><span>(</span><span style=color:#ed9366>...</span><span>) </span><span style=color:#abb0b6;font-style:italic>// 返回 Result
</span><span>mesh</span><span style=color:#ed9366>.</span><span style=color:#f07171>try_remove_attribute</span><span>(</span><span style=color:#ed9366>...</span><span>)        </span><span style=color:#abb0b6;font-style:italic>// 返回 Result
</span></code></pre> <p>此外，文档还解释了新引入的错误类型：</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 这些函数返回一个 `Result<..., MeshAccessError>`。
</span><span style=color:#abb0b6;font-style:italic>// 当网格已提取时，返回 `Err(MeshAccessError::ExtractedToRenderWorld)`。
</span></code></pre> <p>以及那些没有<code>try_*</code>版本但行为改变的函数：</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 以下函数没有对应的 try_* 版本，但如果网格数据已被提取到 `RenderWorld`，现在会直接 panic。
</span><span>mesh</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_vertex_size</span><span>(</span><span style=color:#ed9366>...</span><span>)
</span><span>mesh</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_vertex_buffer_size</span><span>(</span><span style=color:#ed9366>...</span><span>)
</span></code></pre> <p><strong>与PR目的的关系</strong>： 这份文档是PR #21732所实现功能面向用户的最终接口。没有这份指南，开发者升级到0.18后可能会遇到令人困惑的panic或编译错误，而不清楚如何修复。它直接服务于PR的“目标”（Fix #22206），即提供一个清晰的升级路径，解决因行为变更导致的迁移问题。</p> <h2 id=further-reading>Further Reading</h2> <ol><li><strong>PR #21732</strong>: 这是实现核心行为变更的PR。阅读它可以深入理解<code>Assets&LTMesh></code>保留机制和<code>try_*</code>函数是如何被实现的。<li><strong>Issue #22206</strong>: 原始问题报告，可能包含了用户遇到的具体错误场景和讨论，有助于理解此变更要解决的痛点。<li><strong>Bevy官方文档 - Render Phases and Extract</strong>: 了解Bevy的渲染阶段，特别是“Extract”阶段，对于理解为什么网格数据会被移动到<code>RenderWorld</code>至关重要。<li><strong>Rust的<code>Result</code>和错误处理</strong>: 熟悉Rust的<code>Result</code>枚举和<code>?</code>操作符，将帮助你更高效地处理<code>try_*</code>函数返回的错误。</ol>    <div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-01/pr_22407.patch id=patch-info style=display:none></div>  <div class=bottom-spacer></div> 