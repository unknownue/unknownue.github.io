<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22365 Fix flickering on macOS 26 when tracy is enabled
        
    </title><meta content="#22365 Fix flickering on macOS 26 when tracy is enabled" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-01/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-01-03</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2026-01/pr-22365-en-20260103>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=title-fix-flickering-on-macos-26-when-tracy-is-enabled>Title: Fix flickering on macOS 26 when tracy is enabled</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix flickering on macOS 26 when tracy is enabled<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22365<li><strong>Author</strong>: aevyrie<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, O-MacOS, A-Accessibility, S-Needs-Testing<li><strong>Created</strong>: 2026-01-03T20:04:21Z<li><strong>Merged</strong>: 2026-01-03T22:37:03Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><p><strong>目标</strong><ul><li>修复使用 tracy 时出现的画面闪烁/频闪问题。<li>关闭 Issue #22257</ul><p><strong>解决方案</strong><ul><li>在 macOS 上，禁用命令编码器 (command encoder) 中的时间戳写入功能。</ul><p><strong>测试</strong><ul><li>使用 <code>cargo run --example bloom_3d --features=trace_tracy</code> 命令无法再复现该问题。<li><code>bevy_bistro_scene</code> 示例也不再出现闪烁现象。</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>这个 Pull Request 处理的是一个非常具体且与平台相关的问题：当在 macOS 上启用 <code>tracy</code> 性能分析工具时，渲染画面会出现间歇性的闪烁（flickering）或频闪（strobing）。这个问题被记录在 Issue #22257 中，对用户体验和渲染的稳定性有明显的负面影响。<p>问题的核心在于 <code>tracy</code> 如何与 Bevy 的渲染后端（WebGPU）交互以收集 GPU 性能数据。<code>tracy</code> 是一个强大的实时性能分析工具，它依赖于精确的时间戳来测量 GPU 命令的执行耗时。在 Bevy 的实现中，这是通过调用 WebGPU 的 <code>CommandEncoder::write_timestamp</code> 方法来完成的。这个方法会在 GPU 的命令缓冲区中插入一个特殊的命令，用于记录一个高精度的时间戳到指定的 <code>QuerySet</code> 中。<p>然而，在特定的 macOS 版本（代号 Tahoe）上，当 <code>write_timestamp</code> 的调用时机非常接近帧的最终呈现（presentation）时，似乎会干扰底层的图形驱动或 GPU 调度逻辑，导致正在渲染的画面出现不完整的提交或同步问题，从而在屏幕上表现为闪烁。<p>开发者 <code>aevyrie</code> 采取的解决方案是直接且务实的。与其深入挖掘 macOS 图形驱动或 Metal API（WebGPU 在 macOS 的底层实现）中可能存在的、难以定位的底层 bug，不如针对出现问题的特定平台和特定操作（写入时间戳）施加一个运行时规避措施。<p>具体的实现是在 <code>WriteTimestamp</code> trait 针对 <code>CommandEncoder</code> 的实现中，添加了一个条件判断。在编译目标为 <code>macos</code> 时，这个 <code>write_timestamp</code> 函数会提前返回，不再执行任何实际的操作。<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>impl </span><span>WriteTimestamp </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>CommandEncoder </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>write_timestamp</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>query_set</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>QuerySet, </span><span style=color:#ff8f40>index</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u32</span><span>) {
</span><span>        </span><span style=color:#fa6e32>if </span><span style=color:#f07171>cfg!</span><span>(target_os </span><span style=color:#ed9366>= </span><span style=color:#86b300>"macos"</span><span>) {
</span><span>            </span><span style=color:#abb0b6;font-style:italic>// When using tracy (and thus this function), rendering was flickering on macOS Tahoe.
</span><span>            </span><span style=color:#abb0b6;font-style:italic>// See: https://github.com/bevyengine/bevy/issues/22257
</span><span>            </span><span style=color:#abb0b6;font-style:italic>// The issue seems to be triggered when `write_timestamp` is called very close to frame
</span><span>            </span><span style=color:#abb0b6;font-style:italic>// presentation.
</span><span>            </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>        CommandEncoder</span><span style=color:#ed9366>::</span><span>write_timestamp(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#61676ccc>,</span><span> query_set</span><span style=color:#61676ccc>,</span><span> index)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><p>这个方法有几个关键点：<ol><li><strong>平台特异性 (Platform-specific)</strong>：使用 <code>cfg!(target_os = "macos")</code> 编译时属性，确保只有 macOS 平台会激活此规避逻辑，不影响其他操作系统（如 Windows, Linux）上的性能分析功能。<li><strong>功能降级 (Graceful Degradation)</strong>：在 macOS 上，这实质上禁用了通过 <code>write_timestamp</code> 进行的 GPU 计时功能。对于 <code>tracy</code> 用户来说，这意味着他们无法获取 macOS 上精确的 GPU 区间性能数据，但应用程序的核心渲染功能恢复了稳定，不再闪烁。这是一个典型的可用性优先于辅助功能的权衡。<li><strong>最小侵入性 (Minimally Invasive)</strong>：这个修改仅存在于诊断和性能分析模块中，对 Bevy 引擎的核心渲染逻辑、ECS（Entity Component System）或其他游戏逻辑完全没有影响。</ol><p>这个解决方案是有效的，正如测试部分所述，原先能够稳定复现问题的示例程序（如 <code>bloom_3d</code> 和 <code>bevy_bistro_scene</code>）在应用此补丁后，闪烁现象消失了。这种“规避性修复” (workaround) 在跨平台图形编程中很常见，尤其是在处理不同供应商的驱动或操作系统层级的差异时。<p>从工程角度看，这个 PR 提供了一个清晰的模式：当遇到一个复杂的、根因可能在第三方驱动或库中的问题时，一个局部的、条件性的规避措施可以作为一种快速且稳定的解决方案。当然，这也留下了未来改进的空间，例如，可以探索是否在某些更新的 macOS 版本或驱动中此问题已被修复，从而有条件地重新启用该功能；或者寻找其他不引发闪烁的 GPU 计时方法。<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    subgraph "Tracy Profiling"
</span><span>        A[Tracy Client] -->|Requests GPU Timing| B[WriteTimestamp Trait]
</span><span>    end
</span><span>
</span><span>    subgraph "Platform Abstraction"
</span><span>        B --> C{cfg!(target_os = "macos")?}
</span><span>        C -->|No| D[Call Native write_timestamp]
</span><span>        C -->|Yes| E[Early Return (Workaround)]
</span><span>    end
</span><span>
</span><span>    subgraph "Rendering Backend"
</span><span>        D --> F[GPU Command Buffer]
</span><span>        E --> G[No Timestamp Inserted]
</span><span>    end
</span><span>
</span><span>    F -->|Timestamp Close to Present| H[Potential Driver Bug: Flickering]
</span><span>    G -->|No Interference| I[Stable Rendering]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-render-src-diagnostic-internal-rs-7-0><code>crates/bevy_render/src/diagnostic/internal.rs</code> (+7/-0)</h3><ol><li><p><strong>变更描述与原因</strong>： 此文件是渲染系统内部诊断功能的一部分。新增的代码在 <code>WriteTimestamp</code> trait 的实现中添加了一个针对 macOS 平台的防护。其目的是在 macOS 系统上，当检测到正在执行写入时间戳操作（通常由 Tracy 触发）时，直接跳过该操作，以避免触发底层图形驱动的 bug，从而解决渲染画面闪烁的问题。</p><li><p><strong>关键代码片段</strong>：</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// File: crates/bevy_render/src/diagnostic/internal.rs
</span><span style=color:#abb0b6;font-style:italic>// After (新增的代码块):
</span><span style=color:#fa6e32>impl </span><span>WriteTimestamp </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>CommandEncoder </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>write_timestamp</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>query_set</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>QuerySet, </span><span style=color:#ff8f40>index</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u32</span><span>) {
</span><span>        </span><span style=color:#fa6e32>if </span><span style=color:#f07171>cfg!</span><span>(target_os </span><span style=color:#ed9366>= </span><span style=color:#86b300>"macos"</span><span>) {
</span><span>            </span><span style=color:#abb0b6;font-style:italic>// When using tracy (and thus this function), rendering was flickering on macOS Tahoe.
</span><span>            </span><span style=color:#abb0b6;font-style:italic>// See: https://github.com/bevyengine/bevy/issues/22257
</span><span>            </span><span style=color:#abb0b6;font-style:italic>// The issue seems to be triggered when `write_timestamp` is called very close to frame
</span><span>            </span><span style=color:#abb0b6;font-style:italic>// presentation.
</span><span>            </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>        CommandEncoder</span><span style=color:#ed9366>::</span><span>write_timestamp(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#61676ccc>,</span><span> query_set</span><span style=color:#61676ccc>,</span><span> index)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre> <p>（变更前，<code>impl</code> 块内直接调用 <code>CommandEncoder::write_timestamp(self, query_set, index);</code>，没有条件判断。）</p><li><p><strong>与 PR 目标的关联</strong>： 这是实现整个 PR 解决方案的唯一变更。它直接拦截了导致 macOS 上 Tracy 启用时闪烁问题的特定 API 调用，通过一个平台相关的“短路”逻辑实现了修复。</p></ol><h2 id=further-reading>Further Reading</h2><ol><li><strong>Tracy Profiler</strong>: https://github.com/wolfpld/tracy - 理解此 PR 试图集成的性能分析工具。<li><strong>WebGPU <code>writeTimestamp</code> API</strong>: https://www.w3.org/TR/webgpu/#dom-gpucommandencoder-writetimestamp - 了解被禁用的底层 WebGPU 方法的功能。<li><strong>Rust <code>cfg!</code> macro</strong>: https://doc.rust-lang.org/reference/conditional-compilation.html#the-cfg-attribute - 学习 Rust 中用于条件编译的属性，这是实现平台特异性代码的关键。<li><strong>Graphics Driver Workarounds</strong>: 在大型图形引擎（如 Unity， Unreal）的发布说明或代码库中，经常可以看到针对特定 GPU 或驱动版本的“workaround”。这个 PR 是一个小而具体的例子。</ol><h1 id=full-code-diff>Full Code Diff</h1><pre style=color:#61676c;background-color:#fafafa><code><span>diff --git a/crates/bevy_render/src/diagnostic/internal.rs b/crates/bevy_render/src/diagnostic/internal.rs
</span><span>index 2bd360c51bee6..641f5a9efc668 100644
</span><span>--- a/crates/bevy_render/src/diagnostic/internal.rs
</span><span>+++ b/crates/bevy_render/src/diagnostic/internal.rs
</span><span>@@ -643,6 +643,13 @@ pub trait WriteTimestamp {
</span><span> 
</span><span> impl WriteTimestamp for CommandEncoder {
</span><span>     fn write_timestamp(&mut self, query_set: &QuerySet, index: u32) {
</span><span>+        if cfg!(target_os = "macos") {
</span><span>+            // When using tracy (and thus this function), rendering was flickering on macOS Tahoe.
</span><span>+            // See: https://github.com/bevyengine/bevy/issues/22257
</span><span>+            // The issue seems to be triggered when `write_timestamp` is called very close to frame
</span><span>+            // presentation.
</span><span>+            return;
</span><span>+        }
</span><span>         CommandEncoder::write_timestamp(self, query_set, index);
</span><span>     }
</span><span> }
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-01/pr_22365.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>