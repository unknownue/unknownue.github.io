<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22156 Minimal Font Families, Font Queries, Collections, System Fonts, Stretch, and Slant support
        
    </title><meta content="#22156 Minimal Font Families, Font Queries, Collections, System Fonts, Stretch, and Slant support" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-01/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-01-03</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2026-01/pr-22156-en-20260103>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=ji-ben-xin-xi>基本信息</h2><ul><li><strong>标题</strong>: Minimal Font Families, Font Queries, Collections, System Fonts, Stretch, and Slant support<li><strong>PR 链接</strong>: https://github.com/bevyengine/bevy/pull/22156<li><strong>作者</strong>: ickshonpe<li><strong>状态</strong>: 已合并<li><strong>标签</strong>: C-Feature, S-Ready-For-Final-Review, M-Migration-Guide, A-Text, M-Release-Note<li><strong>创建时间</strong>: 2025-12-16T22:14:54Z<li><strong>合并时间</strong>: 2026-01-03T23:03:06Z<li><strong>合并者</strong>: alice-i-cecile</ul><h2 id=miao-shu-fan-yi>描述翻译</h2><h3 id=mu-biao>目标</h3><p>以最小的改动实现对剩余缺失文本功能的支持。<h3 id=jie-jue-fang-an>解决方案</h3><p><code>TextFont</code> 已扩展为包含新字段：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>TextFont </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>font</span><span style=color:#61676ccc>:</span><span> FontSource,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>font_size</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>weight</span><span style=color:#61676ccc>:</span><span> FontWeight,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>width</span><span style=color:#61676ccc>:</span><span> FontWidth,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>style</span><span style=color:#61676ccc>:</span><span> FontStyle,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>font_smoothing</span><span style=color:#61676ccc>:</span><span> FontSmoothing,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>font_features</span><span style=color:#61676ccc>:</span><span> FontFeatures,
</span><span>}
</span></code></pre><p>FontSource 有两个变体：Handle（通过资源句柄标识字体）和 Family（通过字体族名称选择字体）。<p><code>FontWidth</code> 是一个表示 OpenType 字体拉伸分类的新类型结构体，范围从 ULTRA_CONDENSED（50%）到 ULTRA_EXPANDED（200%）。<p><code>FontStyle</code> 是一个用于设置字体倾斜样式的枚举，可以是 <code>Normal</code>、<code>Italic</code> 或 <code>Oblique</code>。<p>系统字体支持非常基础。你可以使用 <code>CosmicFontSystem</code> 资源加载它们：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>font_system</span><span style=color:#ed9366>.</span><span style=color:#f07171>db_mut</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>load_system_fonts</span><span>()
</span></code></pre><p>然后就可以使用 <code>FontSource::Family</code> 通过族名称选择它们。<h3 id=qi-ta-bian-geng>其他变更</h3><ul><li><p><code>TextPipelines</code> 的 <code>glyph_info</code> 字段已被移除。在文本布局更新期间，不再需要收集段落信息或执行任何查询，因此相关代码也被移除。</p><li><p><code>update_text_layout_info</code> 使用了一些嵌套闭包的 <code>try_for_each</code>，这变得不必要的复杂。它们已被替换为常规的 for 循环。</p><li><p>字体资源加载后，新增了一个系统 <code>load_font_assets_into_fontdb_system</code>，它会自动将它们添加到 cosmic text 的字体数据库中。然后这些字体既可以通过资源句柄查找，也可以通过族名称查找。</p><li><p>虽然没有基于性能的改动，但布局更新现在总体上似乎显著更高效，只是对于大量短的、单段文本实体有轻微的回归。</p><li><p>当生成字体纹理图集的字体资源被移除时，字体纹理图集不再自动清理。由于无法从 cosmic text 的 <code>FontSystem</code> 中移除单个字体，字体仍然可以通过 <code>FontSource::family</code> 使用族名称访问，而简单移除文本图集可能会导致渲染时因期望它们存在而发生恐慌。</p></ul><h3 id=ce-shi>测试</h3><pre style=color:#61676c;background-color:#fafafa><code><span>cargo run --example font_query
</span></code></pre><hr><h3 id=zhan-shi>展示</h3><img alt=font-query height=591 src=https://github.com/user-attachments/assets/23f5aaa2-fdb8-4448-9b4e-9d65d6431107 width=1229><h2 id=ben-ci-pull-request-de-gu-shi>本次 Pull Request 的故事</h2><p>这个 PR 源于 Bevy 文本渲染系统需要补齐一系列高级字体特性的支持，包括字体族查询、字体集合、系统字体、字体宽度（stretch）和倾斜样式（slant）。之前，<code>TextFont</code> 结构体仅支持通过资源句柄引用字体、字号和字重，功能相对基础。<p>核心问题是，开发者在使用文本时，无法直接通过字体族名称选择字体，也无法指定字体的拉伸或倾斜样式。此外，系统字体的集成也缺失，用户只能加载特定的字体资源文件。这些限制使得创建灵活、动态的文本渲染变得困难。<p>为了解决这些问题，开发者选择了一种最小化的实现方式，在不破坏现有 API 的前提下扩展 <code>TextFont</code> 结构体。主要思路是引入一个新的 <code>FontSource</code> 枚举，它既可以包装现有的 <code>Handle&LTFont></code>，也可以表示一个字体族名称字符串。同时，添加了 <code>FontWidth</code> 和 <code>FontStyle</code> 类型来支持字体拉伸和倾斜。<p>在实现层面，<code>crates/bevy_text/src/text.rs</code> 是改动最大的文件之一。这里定义了 <code>FontSource</code> 枚举及其 <code>From</code> trait 实现，确保了与现有代码的向后兼容性——现有的 <code>Handle&LTFont></code> 可以无缝转换为 <code>FontSource::Handle</code>。<code>TextFont</code> 结构体新增了 <code>width</code> 和 <code>style</code> 字段，并修改了 <code>font</code> 字段的类型。<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 关键变化示例：FontSource 枚举
</span><span style=color:#fa6e32>pub enum </span><span style=color:#399ee6>FontSource </span><span>{
</span><span>    Handle(Handle&LTFont>)</span><span style=color:#61676ccc>,
</span><span>    Family(SmolStr)</span><span style=color:#61676ccc>,
</span><span>}
</span></code></pre><p>另一个重大改动在 <code>crates/bevy_text/src/pipeline.rs</code>。这里移除了 <code>glyph_info</code> 字段及相关逻辑，因为在新的布局更新流程中，不再需要在文本布局阶段预先收集每个段落的字体度量信息。取而代之的是，在 <code>update_text_layout_info</code> 函数中，我们直接在遍历布局运行的每个字形（glyph）时，根据需要从字体系统获取度量信息并计算下划线和删除线的位置。这种按需计算的方式简化了流程，也移除了之前复杂的 <code>try_for_each</code> 链式调用，代之以更清晰的分层 for 循环。<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 旧逻辑（简化示意）
</span><span style=color:#fa6e32>let</span><span> result </span><span style=color:#ed9366>=</span><span> buffer</span><span style=color:#ed9366>.</span><span style=color:#f07171>layout_runs</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>try_for_each</span><span>(|</span><span style=color:#ff8f40>run</span><span>| {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 复杂的闭包嵌套，收集信息并处理字形
</span><span>})</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 新逻辑
</span><span style=color:#fa6e32>for</span><span> run </span><span style=color:#ed9366>in</span><span> buffer</span><span style=color:#ed9366>.</span><span style=color:#f07171>layout_runs</span><span>() {
</span><span>    </span><span style=color:#fa6e32>for</span><span> layout_glyph </span><span style=color:#ed9366>in</span><span> run</span><span style=color:#ed9366>.</span><span>glyphs {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// 直接处理每个字形，需要时获取字体度量
</span><span>        </span><span style=color:#fa6e32>let</span><span> metrics </span><span style=color:#ed9366>=</span><span> font_system</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_font</span><span>(</span><span style=color:#ed9366>...</span><span>)</span><span style=color:#ed9366>?.</span><span style=color:#f07171>as_swash</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>metrics</span><span>(</span><span style=color:#ed9366>&</span><span>[])</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ... 计算并处理
</span><span>    }
</span><span>}
</span></code></pre><p>技术实现上的一个关键点是字体资源的动态注册。新增的 <code>load_font_assets_into_fontdb_system</code> 系统（位于 <code>crates/bevy_text/src/font.rs</code>）会监听 <code>Font</code> 资产的添加事件，并将字体数据加载到 cosmic text 的底层 <code>fontdb</code> 中。这使得字体不仅可以通过其资源 ID 被引用，还可以通过其族名称被查找。这为实现 <code>FontSource::Family</code> 奠定了基础。<p>与此同时，<code>FontAtlasKey</code> 的定义也发生了变化。它的 <code>id</code> 字段从 <code>AssetId&LTFont></code> 变成了 cosmic text 的 <code>fontdb::ID</code>。这是因为现在字体图集需要与字体在数据库中的内部 ID 关联，而不是与 Bevy 的资产 ID 关联。这导致了 <code>free_unused_font_atlases_system</code> 的移除，因为现在无法仅通过资产事件来安全地判断一个字体是否还在使用（它可能通过族名称被引用）。这是一个有意识的权衡，避免了潜在的运行时崩溃（渲染时缺少预期的图集），但代价是可能的内存泄漏。文档中明确指出了这一点。<p>性能方面，尽管 PR 描述提到没有专门的性能优化，但移除了 <code>glyph_info</code> 的收集和简化了布局更新逻辑，使得整体布局更新更高效。不过，对于大量非常短的文本实体，可能会有轻微的性能回归，这可能是由于新流程中更频繁的字体度量查询开销。<p>为了展示新功能，新增了一个示例 <code>examples/ui/font_query.rs</code>。它创建了一个 UI，展示了如何使用不同的字重（Weight）、宽度（Width）和样式（Style）来渲染文本。这个示例直观地验证了所有新字段的功能。<p>总的来说，这个 PR 通过精心设计的最小化改动，显著增强了 Bevy 文本系统的表达能力。它引入了现代字体渲染中常见的概念，同时保持了 API 的简洁性和向后兼容性。开发者现在可以更灵活地控制文本的外观，包括使用系统字体和查询字体族，这为构建更丰富的用户界面和文本渲染效果打开了大门。<h2 id=shi-jue-cheng-xian>视觉呈现</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Font Asset] --> B[load_font_assets_into_fontdb_system]
</span><span>    B --> C[CosmicText FontDB]
</span><span>    D[FontSource::Family] --> C
</span><span>    E[FontSource::Handle] --> A
</span><span>    F[TextFont] --> D
</span><span>    F --> E
</span><span>    F --> G[FontWidth]
</span><span>    F --> H[FontStyle]
</span><span>    F --> I[Update Text Layout]
</span><span>    I --> J[TextPipeline]
</span><span>    J --> K[Rendered Text]
</span><span>    C --> I
</span></code></pre><h2 id=guan-jian-wen-jian-bian-geng>关键文件变更</h2><h3 id=crates-bevy-text-src-text-rs-150-12><code>crates/bevy_text/src/text.rs</code> (+150/-12)</h3><p>这个文件是本次功能扩展的核心。它定义了新的数据类型并更新了 <code>TextFont</code> 结构体。<p><strong>主要变更：</strong><ol><li>引入了 <code>FontSource</code> 枚举，用于表示字体的两种来源：资源句柄或字体族名称。<li>新增了 <code>FontWidth</code> 新类型结构体，封装了 OpenType 的宽度分类值（1-9）。<li>新增了 <code>FontStyle</code> 枚举，表示字体的倾斜样式（Normal, Italic, Oblique）。<li>更新了 <code>TextFont</code> 结构体，将 <code>font</code> 字段类型改为 <code>FontSource</code>，并新增了 <code>width</code> 和 <code>style</code> 字段。<li>为 <code>FontSource</code>、<code>FontWidth</code> 和 <code>FontStyle</code> 提供了到 cosmic text 相应类型的 <code>From</code> trait 实现，确保它们能无缝集成到现有的文本布局管线中。</ol><p><strong>关键代码片段：</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// FontSource 定义
</span><span style=color:#fa6e32>pub enum </span><span style=color:#399ee6>FontSource </span><span>{
</span><span>    Handle(Handle&LTFont>)</span><span style=color:#61676ccc>,
</span><span>    Family(SmolStr)</span><span style=color:#61676ccc>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// TextFont 的新结构
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>TextFont </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>font</span><span style=color:#61676ccc>:</span><span> FontSource, </span><span style=color:#abb0b6;font-style:italic>// 从 Handle&LTFont> 改为 FontSource
</span><span>    </span><span style=color:#fa6e32>pub </span><span>font_size</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>weight</span><span style=color:#61676ccc>:</span><span> FontWeight,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>width</span><span style=color:#61676ccc>:</span><span> FontWidth, </span><span style=color:#abb0b6;font-style:italic>// 新增字段
</span><span>    </span><span style=color:#fa6e32>pub </span><span>style</span><span style=color:#61676ccc>:</span><span> FontStyle, </span><span style=color:#abb0b6;font-style:italic>// 新增字段
</span><span>    </span><span style=color:#fa6e32>pub </span><span>font_smoothing</span><span style=color:#61676ccc>:</span><span> FontSmoothing,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>font_features</span><span style=color:#61676ccc>:</span><span> FontFeatures,
</span><span>}
</span></code></pre><h3 id=crates-bevy-text-src-pipeline-rs-167-234><code>crates/bevy_text/src/pipeline.rs</code> (+167/-234)</h3><p>这个文件包含了文本布局管线的核心逻辑，进行了大规模重构以支持新特性并简化流程。<p><strong>主要变更：</strong><ol><li>移除了 <code>TextPipeline</code> 结构体中的 <code>glyph_info: Vec<(...)></code> 字段。该字段之前用于在布局前收集每个文本段的字体度量信息。<li>重构了 <code>update_text_layout_info</code> 函数。移除了 <code>text_font_query</code> 和 <code>scale_factor</code> 参数。现在字体的度量信息（如下划线位置）是在遍历布局字形时按需从 <code>font_system</code> 中查询和计算的。<li>简化了布局运行（layout runs）和字形处理的逻辑，用清晰的 for 循环替换了之前复杂的 <code>try_for_each</code> 和嵌套闭包。<li>更新了 <code>FontFaceInfo</code> 结构体，现在它只包含 <code>family_name</code>（一个 <code>SmolStr</code>），而不再包含 <code>stretch</code> 和 <code>style</code>。这些属性现在直接从 <code>TextFont</code> 的 <code>width</code> 和 <code>style</code> 字段获取。<li>修改了 <code>load_font_to_fontdb</code> 函数的逻辑（实际上其功能被分散和整合），现在字体加载和 ID 映射的处理更直接。</ol><p><strong>关键代码片段（展示逻辑简化）：</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 旧代码（简化）：使用 try_for_each 和嵌套闭包
</span><span style=color:#fa6e32>let</span><span> result </span><span style=color:#ed9366>=</span><span> buffer</span><span style=color:#ed9366>.</span><span style=color:#f07171>layout_runs</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>try_for_each</span><span>(|</span><span style=color:#ff8f40>run</span><span>| {
</span><span>    run</span><span style=color:#ed9366>.</span><span>glyphs</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(</span><span style=color:#ed9366>...</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>try_for_each</span><span>(|...| {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// 处理每个字形，依赖预先收集的 glyph_info
</span><span>    })
</span><span>})</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 新代码：使用嵌套的 for 循环，逻辑更清晰
</span><span style=color:#fa6e32>for</span><span> run </span><span style=color:#ed9366>in</span><span> buffer</span><span style=color:#ed9366>.</span><span style=color:#f07171>layout_runs</span><span>() {
</span><span>    </span><span style=color:#fa6e32>for</span><span> layout_glyph </span><span style=color:#ed9366>in</span><span> run</span><span style=color:#ed9366>.</span><span>glyphs {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// 直接查询字体度量
</span><span>        </span><span style=color:#fa6e32>let</span><span> metrics </span><span style=color:#ed9366>=</span><span> font_system</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_font</span><span>(layout_glyph</span><span style=color:#ed9366>.</span><span>font_id</span><span style=color:#61676ccc>,</span><span> layout_glyph</span><span style=color:#ed9366>.</span><span>font_weight)</span><span style=color:#ed9366>?.</span><span style=color:#f07171>as_swash</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>metrics</span><span>(</span><span style=color:#ed9366>&</span><span>[])</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ... 使用 metrics 进行计算
</span><span>    }
</span><span>}
</span></code></pre><h3 id=examples-ui-font-query-rs-251-0><code>examples/ui/font_query.rs</code> (+251/-0)</h3><p>这是一个全新的示例文件，用于展示本次 PR 新增的字体查询功能。<p><strong>主要作用：</strong><ol><li>演示如何通过 <code>FontSource::Family</code> 使用字体族名称。<li>展示 <code>FontWeight</code> 的所有可能取值（从 THIN 到 BLACK）。<li>展示 <code>FontWidth</code> 的所有可能取值（从 ULTRA_CONDENSED 到 ULTRA_EXPANDED）。<li>展示 <code>FontStyle</code> 的所有变体（Normal, Oblique, Italic）。</ol><p><strong>关键代码片段：</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 使用 FontSource::Family
</span><span>TextFont {
</span><span>    font</span><span style=color:#61676ccc>: </span><span style=color:#86b300>"Comic Sans MS"</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()</span><span style=color:#61676ccc>, </span><span style=color:#abb0b6;font-style:italic>// 字符串被转换为 FontSource::Family
</span><span>    font_size</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>67.0</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#ed9366>..</span><span style=color:#f07171>default</span><span>()
</span><span>}</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 展示不同的 FontWidth
</span><span>TextFont {
</span><span>    font</span><span style=color:#61676ccc>:</span><span> family</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#61676ccc>,
</span><span>    width</span><span style=color:#61676ccc>: </span><span>FontWidth</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ULTRA_CONDENSED</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#ed9366>..</span><span style=color:#f07171>default</span><span>()
</span><span>}</span><span style=color:#61676ccc>,
</span></code></pre><h3 id=crates-bevy-text-src-font-rs-44-0><code>crates/bevy_text/src/font.rs</code> (+44/-0)</h3><p>这个文件新增了一个系统，用于将加载的字体资产注册到 cosmic text 的字体数据库中。<p><strong>主要变更：</strong><ol><li>在 <code>Font</code> 资产结构体中新增了 <code>ids: SmallVec<[ID; 8]></code> 字段，用于存储该字体文件在 cosmic text 字体数据库中的内部 ID。<li>新增了 <code>load_font_assets_into_fontdb_system</code> 系统。该系统监听 <code>AssetEvent::Added&LTFont></code> 事件，将新添加的字体数据加载到 <code>CosmicFontSystem</code> 的数据库中，并将生成的 ID 存储回 <code>Font</code> 资产的 <code>ids</code> 字段。如果添加了新字体，它会标记所有现有的 <code>ComputedTextBlock</code> 需要重新渲染，以确保新字体立即可用。</ol><p><strong>关键代码片段：</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>load_font_assets_into_fontdb_system</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>fonts</span><span style=color:#61676ccc>: </span><span>ResMut&LTAssets&LTFont>>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>events</span><span style=color:#61676ccc>: </span><span>MessageReader&LTAssetEvent&LTFont>>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>cosmic_font_system</span><span style=color:#61676ccc>: </span><span>ResMut&LTCosmicFontSystem>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>text_block_query</span><span style=color:#61676ccc>: </span><span>Query<</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> ComputedTextBlock>,
</span><span>) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... 处理添加事件，加载字体到数据库
</span><span>    font</span><span style=color:#ed9366>.</span><span>ids </span><span style=color:#ed9366>=</span><span> font_system</span><span style=color:#ed9366>.</span><span style=color:#f07171>db_mut</span><span>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>load_font_source</span><span>(cosmic_text</span><span style=color:#ed9366>::</span><span>fontdb</span><span style=color:#ed9366>::</span><span>Source</span><span style=color:#ed9366>::</span><span>Binary(data))
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>into_iter</span><span>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>collect</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... 标记需要重新渲染
</span><span>}
</span></code></pre><h3 id=crates-bevy-text-src-font-atlas-set-rs-44-30><code>crates/bevy_text/src/font_atlas_set.rs</code> (+44/-30)</h3><p>这个文件管理字体纹理图集，其键类型和清理逻辑发生了变化。<p><strong>主要变更：</strong><ol><li><code>FontAtlasKey</code> 的 <code>id</code> 字段类型从 <code>AssetId&LTFont></code> 更改为 <code>cosmic_text::fontdb::ID</code>。这是因为图集现在与字体在数据库中的内部 ID 关联，而不是 Bevy 资产 ID。<li>移除了 <code>From<&TextFont> for FontAtlasKey</code> 的实现，因为现在构造键需要的信息不同。<li>移除了 <code>free_unused_font_atlases_system</code> 系统。由于字体现在可以通过族名称持久化引用，无法再安全地根据资产移除事件来清理图集。这是为了优先保证渲染稳定性而做出的权衡。</ol><p><strong>关键代码片段：</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// FontAtlasKey 的新定义
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>FontAtlasKey </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>id</span><span style=color:#61676ccc>:</span><span> ID, </span><span style=color:#abb0b6;font-style:italic>// 类型变了
</span><span>    </span><span style=color:#fa6e32>pub </span><span>font_size_bits</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u32</span><span>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>font_smoothing</span><span style=color:#61676ccc>:</span><span> FontSmoothing,
</span><span>}
</span></code></pre><h2 id=yan-shen-yue-du>延伸阅读</h2><ul><li><strong>cosmic-text 库</strong>: 这是 Bevy 当前文本布局和渲染的后端。了解其 <a rel="noopener nofollow noreferrer" href=https://docs.rs/cosmic-text/latest/cosmic_text/fontdb/index.html target=_blank>fontdb</a> 模块有助于理解字体加载和查询机制。<li><strong>OpenType 规范 - OS/2 表</strong>: 了解 <a rel="noopener nofollow noreferrer" href=https://docs.microsoft.com/en-us/typography/opentype/spec/os2#uswidthclass target=_blank><code>usWidthClass</code></a> 有助于理解 <code>FontWidth</code> 值的含义和标准范围。<li><strong>Bevy 官方示例 - UI</strong>: 运行 <code>cargo run --example font_query</code> 和 <code>cargo run --example text</code> 来直观感受新功能。<li><strong>Bevy 迁移指南</strong>: 查看本次 PR 附带的迁移指南 <code>TextFont_font_is_now_a_FontSource.md</code>，了解现有代码的适配方法。</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-01/pr_22156.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>