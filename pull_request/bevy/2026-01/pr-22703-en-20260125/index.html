<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22703 Use an `f32` `scale_factor` in `TextPipeline`
        
    </title><meta content="#22703 Use an `f32` `scale_factor` in `TextPipeline`" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-01/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-01-25</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-01/pr-22703-zh-cn-20260125>中文</a></div></div><div class=pr-content><h1 id=title-use-an-f32-scale-factor-in-textpipeline>Title: Use an <code>f32</code> <code>scale_factor</code> in <code>TextPipeline</code></h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Use an <code>f32</code> <code>scale_factor</code> in <code>TextPipeline</code><li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22703<li><strong>Author</strong>: ickshonpe<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: D-Trivial, C-Code-Quality, S-Ready-For-Final-Review, A-Text<li><strong>Created</strong>: 2026-01-25T21:46:54Z<li><strong>Merged</strong>: 2026-01-25T22:52:31Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p><code>TextPipeline</code>’s methods don’t need to take an <code>f64</code> scalefactor (cosmic text used to want <code>f64</code>s but not anymore), it just gets converted back to an <code>f32</code>.<h2 id=solution>Solution</h2><ul><li><p>Changed the types of the <code>scale_factor</code> parameters belonging to <code>update_buffer</code>, <code>create_text_measure</code>, and <code>get_attrs</code> from <code>f64</code> to <code>f32</code></p><li><p>Removed some needless conversions.</p></ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This pull request addresses a straightforward type mismatch in Bevy’s text rendering pipeline. The issue originated from a historical requirement in the cosmic-text library, which previously used <code>f64</code> values for scaling factors. Over time, cosmic-text transitioned to using <code>f32</code>, but Bevy’s text pipeline methods still accepted <code>f64</code> parameters that were immediately converted to <code>f32</code> internally. This created unnecessary conversions and potential precision loss at the API boundary.<p>The problem manifested in three key methods within the <code>TextPipeline</code> implementation: <code>update_buffer</code>, <code>create_text_measure</code>, and the helper function <code>get_attrs</code>. Each of these methods accepted a <code>scale_factor</code> parameter as <code>f64</code>, but then immediately converted it to <code>f32</code> for actual use in font size calculations and layout computations.<p>The solution was conceptually simple but required coordinated changes across multiple files. The developer changed the parameter types from <code>f64</code> to <code>f32</code> in the method signatures and then updated all call sites to pass <code>f32</code> values directly, removing the intermediate <code>as f64</code> conversions. This cleanup affected three different crates: <code>bevy_text</code>, <code>bevy_sprite</code>, and <code>bevy_ui</code>, each of which uses the text pipeline for different rendering contexts.<p>The implementation details show careful attention to consistency. In <code>pipeline.rs</code>, the <code>update_buffer</code> method’s signature changed from accepting <code>scale_factor: f64</code> to <code>scale_factor: f32</code>. Within the method body, calculations like <code>text_font.font_size * scale_factor as f32</code> were simplified to <code>text_font.font_size * scale_factor</code>, since the parameter was already the correct type. Similarly, in the <code>get_attrs</code> helper function, both font size and line height calculations were simplified by removing the redundant type conversions.<p>The changes in <code>text2d.rs</code> and <code>text.rs</code> demonstrate how call sites were updated. Previously, these files were passing <code>scale_factor as f64</code> to the text pipeline methods. After the parameter type change, they simply pass the <code>f32</code> value directly, which is more efficient and avoids unnecessary precision conversions.<p>This PR represents a typical example of cleaning up technical debt that accumulates when external dependencies change their APIs. The cosmic-text library’s transition from <code>f64</code> to <code>f32</code> for scaling factors was not immediately reflected in Bevy’s API, leading to this inconsistency. By updating the parameter types, the code becomes more efficient (eliminating unnecessary type conversions), clearer (the API accurately reflects what the underlying library expects), and more consistent (matching the actual precision requirements of the text rendering system).<p>The impact of these changes is primarily in code quality and minor performance improvements. While the performance gain from removing a few <code>f64</code> to <code>f32</code> conversions is minimal, the cleaner API surface makes the code easier to understand and maintain. Developers working with text rendering no longer need to wonder why <code>f64</code> is being used when the underlying system only needs <code>f32</code> precision.<p>From an architectural perspective, this change demonstrates good API design principles: exposing only the precision actually needed by the implementation, avoiding unnecessary type conversions at API boundaries, and keeping the public interface aligned with the capabilities of underlying dependencies. It also shows the importance of periodically reviewing APIs when dependencies change to ensure consistency throughout the codebase.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[bevy_sprite/text2d.rs] --> B[TextPipeline::update_buffer]
</span><span>    C[bevy_ui/widget/text.rs] --> D[TextPipeline::create_text_measure]
</span><span>    B --> E[TextPipeline::get_attrs]
</span><span>    D --> E
</span><span>    E --> F[cosmic-text library]
</span><span>    
</span><span>    style A fill:#e1f5fe
</span><span>    style C fill:#e1f5fe
</span><span>    style B fill:#f3e5f5
</span><span>    style D fill:#f3e5f5
</span><span>    style E fill:#f3e5f5
</span><span>    style F fill:#e8f5e8
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=1-crates-bevy-text-src-pipeline-rs-6-6>1. <code>crates/bevy_text/src/pipeline.rs</code> (+6/-6)</h3><p>This is the core file where the text pipeline implementation resides. The changes update method signatures and remove unnecessary type conversions.<p><strong>Key changes:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>update_buffer</span><span>(
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other parameters
</span><span>    </span><span style=color:#ff8f40>scale_factor</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f64</span><span>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... rest of implementation
</span><span>) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Inside method: using scale_factor as f64, converting to f32 when needed
</span><span>    </span><span style=color:#fa6e32>if</span><span> text_font</span><span style=color:#ed9366>.</span><span>font_size </span><span style=color:#ed9366>*</span><span> scale_factor </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32 </span><span style=color:#ed9366>> </span><span style=color:#ff8f40>WARN_FONT_SIZE </span><span>{
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// warning logic
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>update_buffer</span><span>(
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other parameters
</span><span>    </span><span style=color:#ff8f40>scale_factor</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>,  </span><span style=color:#abb0b6;font-style:italic>// Changed from f64 to f32
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... rest of implementation
</span><span>) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Now scale_factor is already f32, no conversion needed
</span><span>    </span><span style=color:#fa6e32>if</span><span> text_font</span><span style=color:#ed9366>.</span><span>font_size </span><span style=color:#ed9366>*</span><span> scale_factor </span><span style=color:#ed9366>> </span><span style=color:#ff8f40>WARN_FONT_SIZE </span><span>{
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// warning logic
</span><span>    }
</span><span>}
</span></code></pre><p>The <code>create_text_measure</code> method and <code>get_attrs</code> function received similar updates, changing their <code>scale_factor</code> parameters from <code>f64</code> to <code>f32</code> and removing the <code>as f32</code> conversions in calculations.<h3 id=2-crates-bevy-sprite-src-text2d-rs-1-1>2. <code>crates/bevy_sprite/src/text2d.rs</code> (+1/-1)</h3><p>This file handles 2D text rendering for sprites. The change updates the call to <code>update_buffer</code> to pass the <code>f32</code> value directly instead of converting to <code>f64</code>.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>TextPipeline</span><span style=color:#ed9366>::</span><span>update_buffer(
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other parameters
</span><span>    scale_factor </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f64</span><span style=color:#61676ccc>,  </span><span style=color:#abb0b6;font-style:italic>// Converting f32 to f64
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... rest of call
</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>TextPipeline</span><span style=color:#ed9366>::</span><span>update_buffer(
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other parameters
</span><span>    scale_factor</span><span style=color:#61676ccc>,  </span><span style=color:#abb0b6;font-style:italic>// Now passes f32 directly
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... rest of call
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=3-crates-bevy-ui-src-widget-text-rs-1-1>3. <code>crates/bevy_ui/src/widget/text.rs</code> (+1/-1)</h3><p>This file manages UI text rendering. The change updates the call to <code>create_text_measure</code> to pass the <code>f32</code> value directly.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>TextPipeline</span><span style=color:#ed9366>::</span><span>create_text_measure(
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other parameters
</span><span>    computed_target</span><span style=color:#ed9366>.</span><span>scale_factor</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()</span><span style=color:#61676ccc>,  </span><span style=color:#abb0b6;font-style:italic>// Converting to f64
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... rest of call
</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>TextPipeline</span><span style=color:#ed9366>::</span><span>create_text_measure(
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other parameters
</span><span>    computed_target</span><span style=color:#ed9366>.</span><span>scale_factor</span><span style=color:#61676ccc>,  </span><span style=color:#abb0b6;font-style:italic>// Now passes f32 directly
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... rest of call
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><strong>Bevy Text Rendering Documentation</strong>: For understanding Bevy’s text rendering pipeline and how text components work<li><strong>Cosmic-text Library</strong>: The underlying text layout library used by Bevy, which originally motivated the <code>f64</code> requirement<li><strong>Floating-Point Precision in Graphics</strong>: Technical discussions about when to use <code>f32</code> vs <code>f64</code> in game development and graphics programming<li><strong>Rust Type Conversions</strong>: Best practices for type conversions in Rust, particularly between floating-point types<li><strong>API Design Principles</strong>: Guidelines for designing clean, efficient APIs that minimize unnecessary type conversions</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-01/pr_22703.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>