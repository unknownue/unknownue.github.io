<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22437 Store registered system as Option and take it when running
        
    </title><meta content="#22437 Store registered system as Option and take it when running" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-01/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-01-08</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-01/pr-22437-zh-cn-20260108>中文</a></div></div><div class=pr-content><h1 id=title-store-registered-system-as-option-and-take-it-when-running>Title: Store registered system as Option and take it when running</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Store registered system as Option and take it when running<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22437<li><strong>Author</strong>: cart<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-ECS, S-Ready-For-Final-Review<li><strong>Created</strong>: 2026-01-08T21:38:15Z<li><strong>Merged</strong>: 2026-01-08T22:47:07Z<li><strong>Merged By</strong>: cart</ul><h2 id=description>Description</h2><p>Translate the PR description to the target language, preserving:<ul><li>Technical terms in English<li>All image references and links exactly as they appear<li>Code blocks and formatting</ul><h1 id=objective>Objective</h1><p>Fixes #22380<h2 id=solution>Solution</h2><ul><li>Store the registered system as Option<li>Take it when running instead of removing <code>RegisteredSystem</code></ul><p>This prevents a flush of the global command buffer and also enables running one-shot systems without changing the shape of entities (opening up DeferredWorld scenarios).<h2 id=testing>Testing</h2><ul><li>Tested the repro in #22380</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a bug in Bevy’s ECS where recursive system execution would fail. The issue occurred when a system tried to run itself during its own execution, which would panic because the <code>RegisteredSystem</code> component had been temporarily removed from the entity.<p>The root cause was in how systems were stored and accessed. Previously, when running a system, the code would completely remove the <code>RegisteredSystem</code> component from its entity, run the system, then re-insert it. This approach had several problems. First, it caused structural changes to entities that could flush command buffers unexpectedly. Second, it made recursive system execution impossible because the component would be missing when the system tried to run itself again.<p>The solution changes the storage approach from direct ownership to optional ownership. Instead of removing the entire <code>RegisteredSystem</code> component, we now store the system inside an <code>Option&LTBoxedSystem></code>. When running the system, we take the system out of the <code>Option</code>, leaving <code>None</code> in its place, run the system, then put it back. This approach maintains the component’s presence on the entity while still allowing exclusive access to the system during execution.<p>The key implementation changes are in <code>crates/bevy_ecs/src/system/system_registry.rs</code>. The <code>RegisteredSystem</code> struct now stores the system as <code>Option&LTBoxedSystem&LTI, O>></code> instead of <code>BoxedSystem&LTI, O></code>. This change is reflected in the constructor and all usage sites.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>RegisteredSystem</span><span>&LTI, O> {
</span><span>    initialized</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>bool</span><span>,
</span><span>    system</span><span style=color:#61676ccc>: </span><span>BoxedSystem&LTI, O>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>RegisteredSystem</span><span>&LTI, O> {
</span><span>    initialized</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>bool</span><span>,
</span><span>    system</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTBoxedSystem&LTI, O>>,
</span><span>}
</span></code></pre><p>The <code>run_system</code> method shows the most significant change in logic. Instead of taking the entire <code>RegisteredSystem</code> component:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Old approach - removed component entirely
</span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(RegisteredSystem {
</span><span>    </span><span style=color:#fa6e32>mut</span><span> initialized</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#fa6e32>mut</span><span> system</span><span style=color:#61676ccc>,
</span><span>}) </span><span style=color:#ed9366>=</span><span> entity</span><span style=color:#ed9366>.</span><span>take</span><span style=color:#ed9366>::</span><span>&LTRegisteredSystem&LTI, O>>()
</span><span style=color:#fa6e32>else </span><span>{
</span><span>    </span><span style=color:#fa6e32>return </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(RegisteredSystemError</span><span style=color:#ed9366>::</span><span>Recursive(id))</span><span style=color:#61676ccc>;
</span><span>}</span><span style=color:#61676ccc>;
</span></code></pre><p>The new approach gets a mutable reference to the component and takes the system from the Option:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// New approach - takes system from Option within component
</span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#fa6e32>mut</span><span> registered_system) </span><span style=color:#ed9366>=</span><span> entity</span><span style=color:#ed9366>.</span><span>get_mut</span><span style=color:#ed9366>::</span><span>&LTRegisteredSystem&LTI, O>>() </span><span style=color:#fa6e32>else </span><span>{
</span><span>    </span><span style=color:#fa6e32>return </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(RegisteredSystemError</span><span style=color:#ed9366>::</span><span>MissingRegisteredSystemComponent(id))</span><span style=color:#61676ccc>;
</span><span>}</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>let mut</span><span> system </span><span style=color:#ed9366>=</span><span> registered_system
</span><span>    </span><span style=color:#ed9366>.</span><span>system
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>take</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>ok_or</span><span>(RegisteredSystemError</span><span style=color:#ed9366>::</span><span>SystemMissing(id))</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span></code></pre><p>After running the system, it’s put back into the component:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(</span><span style=color:#fa6e32>mut</span><span> entity) </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_entity_mut</span><span>(id</span><span style=color:#ed9366>.</span><span>entity)
</span><span>    </span><span style=color:#ed9366>&& </span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#fa6e32>mut</span><span> registered_system) </span><span style=color:#ed9366>=</span><span> entity</span><span style=color:#ed9366>.</span><span>get_mut</span><span style=color:#ed9366>::</span><span>&LTRegisteredSystem&LTI, O>>()
</span><span>{
</span><span>    registered_system</span><span style=color:#ed9366>.</span><span>system </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(system)</span><span style=color:#61676ccc>;
</span><span>    registered_system</span><span style=color:#ed9366>.</span><span>initialized </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>true</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>This change has several technical benefits. First, it prevents unnecessary command buffer flushes because entities aren’t undergoing structural changes (components aren’t being added/removed). Second, it enables one-shot systems to work with deferred world operations more reliably. Third, it provides better error messages when systems go missing - instead of a generic “recursive” error, we now get specific errors about missing systems or missing components.<p>The error handling was also improved. The <code>RegisteredSystemError::Recursive</code> variant was replaced with two more specific errors: <code>MissingRegisteredSystemComponent</code> and <code>SystemMissing</code>. This provides clearer diagnostics for debugging system execution issues.<p>A subtle but important consideration is that this approach leaves the system as <code>None</code> during execution. If the system panics during execution, the system won’t be returned to the component, leaving it permanently missing. The TODO comment in the code acknowledges this limitation and suggests using <code>catch_unwind</code> as a future improvement.<p>This implementation demonstrates a common pattern in Rust for temporary ownership: using <code>Option::take()</code> to move a value out, work with it, then <code>Option::replace()</code> or assignment to put it back. This pattern maintains the container’s structure while allowing exclusive access to its contents.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[System Execution Request] --> B{Get RegisteredSystem Component}
</span><span>    B -->|Success| C[Take system from Option]
</span><span>    B -->|Missing| D[Error: MissingRegisteredSystemComponent]
</span><span>    C -->|Some(system)| E[Run System]
</span><span>    C -->|None| F[Error: SystemMissing]
</span><span>    E --> G[Return system to Option]
</span><span>    G --> H[Command Buffer Execution]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ecs-src-system-system-registry-rs-30-20><code>crates/bevy_ecs/src/system/system_registry.rs</code> (+30/-20)</h3><p>This is the only file modified in this PR. It contains the core logic for registering and running systems in Bevy’s ECS.<p><strong>Key Changes:</strong><ol><li><p><strong>RegisteredSystem struct changed to use Option</strong>:</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>RegisteredSystem</span><span>&LTI, O> {
</span><span>    initialized</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>bool</span><span>,
</span><span>    system</span><span style=color:#61676ccc>: </span><span>BoxedSystem&LTI, O>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>RegisteredSystem</span><span>&LTI, O> {
</span><span>    initialized</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>bool</span><span>,
</span><span>    system</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTBoxedSystem&LTI, O>>,
</span><span>}
</span></code></pre><li><p><strong>run_system method updated to take system from Option</strong>:</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Remove entire component
</span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(RegisteredSystem {
</span><span>    </span><span style=color:#fa6e32>mut</span><span> initialized</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#fa6e32>mut</span><span> system</span><span style=color:#61676ccc>,
</span><span>}) </span><span style=color:#ed9366>=</span><span> entity</span><span style=color:#ed9366>.</span><span>take</span><span style=color:#ed9366>::</span><span>&LTRegisteredSystem&LTI, O>>()
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Take system from Option within component
</span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#fa6e32>mut</span><span> registered_system) </span><span style=color:#ed9366>=</span><span> entity</span><span style=color:#ed9366>.</span><span>get_mut</span><span style=color:#ed9366>::</span><span>&LTRegisteredSystem&LTI, O>>() </span><span style=color:#fa6e32>else </span><span>{
</span><span>    </span><span style=color:#fa6e32>return </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(RegisteredSystemError</span><span style=color:#ed9366>::</span><span>MissingRegisteredSystemComponent(id))</span><span style=color:#61676ccc>;
</span><span>}</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>let mut</span><span> system </span><span style=color:#ed9366>=</span><span> registered_system
</span><span>    </span><span style=color:#ed9366>.</span><span>system
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>take</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>ok_or</span><span>(RegisteredSystemError</span><span style=color:#ed9366>::</span><span>SystemMissing(id))</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span></code></pre><li><p><strong>Error types updated for better diagnostics</strong>:</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>error</span><span>(</span><span style=color:#86b300>"System {0:?} tried to run itself recursively"</span><span>)]
</span><span>Recursive(SystemId&LTI, O>)</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>error</span><span>(</span><span style=color:#86b300>"System {0:?} does not have a RegisteredSystem component. This only happens if app code removed the component."</span><span>)]
</span><span>MissingRegisteredSystemComponent(SystemId&LTI, O>)</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>error</span><span>(</span><span style=color:#86b300>"The system is not present in the RegisteredSystem component. This can happen if the system was called recursively or if the system panicked on the last run."</span><span>)]
</span><span>SystemMissing(SystemId&LTI, O>)</span><span style=color:#61676ccc>,
</span></code></pre><li><p><strong>System return logic preserves component structure</strong>:</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Put system back after execution
</span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(</span><span style=color:#fa6e32>mut</span><span> entity) </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_entity_mut</span><span>(id</span><span style=color:#ed9366>.</span><span>entity)
</span><span>    </span><span style=color:#ed9366>&& </span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#fa6e32>mut</span><span> registered_system) </span><span style=color:#ed9366>=</span><span> entity</span><span style=color:#ed9366>.</span><span>get_mut</span><span style=color:#ed9366>::</span><span>&LTRegisteredSystem&LTI, O>>()
</span><span>{
</span><span>    registered_system</span><span style=color:#ed9366>.</span><span>system </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(system)</span><span style=color:#61676ccc>;
</span><span>    registered_system</span><span style=color:#ed9366>.</span><span>initialized </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>true</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre></ol><h2 id=further-reading>Further Reading</h2><ol><li><strong>Bevy ECS Documentation</strong>: https://bevyengine.org/learn/book/next/programming/ecs-intro/<li><strong>Rust Option Type</strong>: https://doc.rust-lang.org/std/option/enum.Option.html<li><strong>Bevy Command Buffer System</strong>: Understanding how command buffering works in Bevy’s ECS<li><strong>Temporary Ownership Patterns in Rust</strong>: Common patterns for borrowing and taking ownership temporarily</ol><h1 id=full-code-diff>Full Code Diff</h1><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_ecs/src/system/system_registry.rs b/crates/bevy_ecs/src/system/system_registry.rs
</span><span>index 2488dbcfd0b47..7305bd5dd8b9f 100644
</span><span style=color:#c594c5>--- a/crates/bevy_ecs/src/system/system_registry.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_ecs/src/system/system_registry.rs
</span><span style=color:#c594c5>@@ -20,14 +20,14 @@ </span><span style=color:#399ee6>use thiserror::Error;
</span><span> #[require(SystemIdMarker = SystemIdMarker::typed_system_id_marker::&LTI, O>())]
</span><span> pub(crate) struct RegisteredSystem&LTI, O> {
</span><span>     initialized: bool,
</span><span style=color:#f07171>-    system: BoxedSystem&LTI, O>,
</span><span style=color:#86b300>+    system: Option&LTBoxedSystem&LTI, O>>,
</span><span> }
</span><span> 
</span><span> impl&LTI, O> RegisteredSystem&LTI, O> {
</span><span>     pub fn new(system: BoxedSystem&LTI, O>) -> Self {
</span><span>         RegisteredSystem {
</span><span>             initialized: false,
</span><span style=color:#f07171>-            system,
</span><span style=color:#86b300>+            system: Some(system),
</span><span>         }
</span><span>     }
</span><span> }
</span><span style=color:#c594c5>@@ -236,7 +236,9 @@ </span><span style=color:#399ee6>impl World {
</span><span>                 entity.despawn();
</span><span>                 Ok(RemovedSystem {
</span><span>                     initialized: registered_system.initialized,
</span><span style=color:#f07171>-                    system: registered_system.system,
</span><span style=color:#86b300>+                    system: registered_system
</span><span style=color:#86b300>+                        .system
</span><span style=color:#86b300>+                        .ok_or(RegisteredSystemError::SystemMissing(id))?,
</span><span>                 })
</span><span>             }
</span><span>             Err(_) => Err(RegisteredSystemError::SystemIdNotRegistered(id)),
</span><span style=color:#c594c5>@@ -374,11 +376,7 @@ </span><span style=color:#399ee6>impl World {
</span><span>             .map_err(|_| RegisteredSystemError::SystemIdNotRegistered(id))?;
</span><span> 
</span><span>         // Take ownership of system trait object
</span><span style=color:#f07171>-        let Some(RegisteredSystem {
</span><span style=color:#f07171>-            mut initialized,
</span><span style=color:#f07171>-            mut system,
</span><span style=color:#f07171>-        }) = entity.take::&LTRegisteredSystem&LTI, O>>()
</span><span style=color:#f07171>-        else {
</span><span style=color:#86b300>+        let Some(mut registered_system) = entity.get_mut::&LTRegisteredSystem&LTI, O>>() else {
</span><span>             let Some(system_id_marker) = entity.get::&LTSystemIdMarker>() else {
</span><span>                 return Err(RegisteredSystemError::SystemIdNotRegistered(id));
</span><span>             };
</span><span style=color:#c594c5>@@ -390,13 +388,17 @@ </span><span style=color:#399ee6>impl World {
</span><span>                     system_id_marker.clone(),
</span><span>                 ));
</span><span>             }
</span><span style=color:#f07171>-            return Err(RegisteredSystemError::Recursive(id));
</span><span style=color:#86b300>+            return Err(RegisteredSystemError::MissingRegisteredSystemComponent(id));
</span><span>         };
</span><span> 
</span><span style=color:#86b300>+        let mut system = registered_system
</span><span style=color:#86b300>+            .system
</span><span style=color:#86b300>+            .take()
</span><span style=color:#86b300>+            .ok_or(RegisteredSystemError::SystemMissing(id))?;
</span><span style=color:#86b300>+
</span><span>         // Initialize the system
</span><span style=color:#f07171>-        if !initialized {
</span><span style=color:#86b300>+        if !registered_system.initialized {
</span><span>             system.initialize(self);
</span><span style=color:#f07171>-            initialized = true;
</span><span>         }
</span><span> 
</span><span>         // refresh hotpatches for stored systems
</span><span style=color:#c594c5>@@ -416,11 +418,11 @@ </span><span style=color:#399ee6>impl World {
</span><span>         system.queue_deferred(self.into());
</span><span> 
</span><span>         // Return ownership of system trait object (if entity still exists)
</span><span style=color:#f07171>-        if let Ok(mut entity) = self.get_entity_mut(id.entity) {
</span><span style=color:#f07171>-            entity.insert::&LTRegisteredSystem&LTI, O>>(RegisteredSystem {
</span><span style=color:#f07171>-                initialized,
</span><span style=color:#f07171>-                system,
</span><span style=color:#f07171>-            });
</span><span style=color:#86b300>+        if let Ok(mut entity) = self.get_entity_mut(id.entity)
</span><span style=color:#86b300>+            && let Some(mut registered_system) = entity.get_mut::&LTRegisteredSystem&LTI, O>>()
</span><span style=color:#86b300>+        {
</span><span style=color:#86b300>+            registered_system.system = Some(system);
</span><span style=color:#86b300>+            registered_system.initialized = true;
</span><span>         }
</span><span> 
</span><span>         // Run any commands enqueued by the system
</span><span style=color:#c594c5>@@ -539,9 +541,9 @@ </span><span style=color:#399ee6>pub enum RegisteredSystemError&LTI: SystemInput = (), O = ()> {
</span><span>     /// Did you forget to register it?
</span><span>     #[error("Cached system was not found")]
</span><span>     SystemNotCached,
</span><span style=color:#f07171>-    /// A system tried to run itself recursively.
</span><span style=color:#f07171>-    #[error("System {0:?} tried to run itself recursively")]
</span><span style=color:#f07171>-    Recursive(SystemId&LTI, O>),
</span><span style=color:#86b300>+    /// The `RegisteredSystem` component is missing.
</span><span style=color:#86b300>+    #[error("System {0:?} does not have a RegisteredSystem component. This only happens if app code removed the component.")]
</span><span style=color:#86b300>+    MissingRegisteredSystemComponent(SystemId&LTI, O>),
</span><span>     /// A system tried to remove itself.
</span><span>     #[error("System {0:?} tried to remove itself")]
</span><span>     SelfRemove(SystemId&LTI, O>),
</span><span style=color:#c594c5>@@ -555,6 +557,10 @@ </span><span style=color:#399ee6>pub enum RegisteredSystemError&LTI: SystemInput = (), O = ()> {
</span><span>     /// [`SystemId`] had different input and/or output types than [`SystemIdMarker`]
</span><span>     #[error("Could not get system from `{}`, entity was `SystemId<{}, {}>`", DebugName::type_name::&LTSystemId&LTI, O>>(), .1.input_type_id.name, .1.output_type_id.name)]
</span><span>     IncorrectType(SystemId&LTI, O>, SystemIdMarker),
</span><span style=color:#86b300>+    /// System is not present in the `RegisteredSystem` component.
</span><span style=color:#86b300>+    // TODO: We should consider using catch_unwind to protect against the panic case.
</span><span style=color:#86b300>+    #[error("The system is not present in the RegisteredSystem component. This can happen if the system was called recursively or if the system panicked on the last run.")]
</span><span style=color:#86b300>+    SystemMissing(SystemId&LTI, O>),
</span><span> }
</span><span> 
</span><span> impl&LTI: SystemInput, O> From&LTRunSystemError> for RegisteredSystemError&LTI, O> {
</span><span style=color:#c594c5>@@ -573,7 +579,10 @@ </span><span style=color:#399ee6>impl&LTI: SystemInput, O> core::fmt::Debug for RegisteredSystemError&LTI, O> {
</span><span>                 f.debug_tuple("SystemIdNotRegistered").field(arg0).finish()
</span><span>             }
</span><span>             Self::SystemNotCached => write!(f, "SystemNotCached"),
</span><span style=color:#f07171>-            Self::Recursive(arg0) => f.debug_tuple("Recursive").field(arg0).finish(),
</span><span style=color:#86b300>+            Self::MissingRegisteredSystemComponent(arg0) => f
</span><span style=color:#86b300>+                .debug_tuple("MissingRegisteredSystemComponent")
</span><span style=color:#86b300>+                .field(arg0)
</span><span style=color:#86b300>+                .finish(),
</span><span>             Self::SelfRemove(arg0) => f.debug_tuple("SelfRemove").field(arg0).finish(),
</span><span>             Self::Skipped(arg0) => f.debug_tuple("Skipped").field(arg0).finish(),
</span><span>             Self::Failed(arg0) => f.debug_tuple("Failed").field(arg0).finish(),
</span><span style=color:#c594c5>@@ -582,6 +591,7 @@ </span><span style=color:#399ee6>impl&LTI: SystemInput, O> core::fmt::Debug for RegisteredSystemError&LTI, O> {
</span><span>                 .field(arg0)
</span><span>                 .field(arg1)
</span><span>                 .finish(),
</span><span style=color:#86b300>+            Self::SystemMissing(arg0) => f.debug_tuple("SystemMissing").field(arg0).finish(),
</span><span>         }
</span><span>     }
</span><span> }
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-01/pr_22437.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>