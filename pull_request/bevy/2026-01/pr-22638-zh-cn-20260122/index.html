<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22638 Rename world.entities_allocator to entity_allocator
        
    </title><meta content="#22638 Rename world.entities_allocator to entity_allocator" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-01/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-01-22</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2026-01/pr-22638-en-20260122>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Rename world.entities_allocator to entity_allocator<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22638<li><strong>Author</strong>: cart<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-ECS, C-Code-Quality, C-Usability, S-Ready-For-Final-Review, X-Uncontroversial, D-Straightforward<li><strong>Created</strong>: 2026-01-21T23:45:08Z<li><strong>Merged</strong>: 2026-01-22T01:14:01Z<li><strong>Merged By</strong>: cart</ul><h2 id=description-translation>Description Translation</h2><p><strong>目标</strong><p>我们在将 <code>EntitiesAllocator</code> 重命名为 <code>EntityAllocator</code> 时遗漏了这一点<p><strong>解决方案</strong><p>重命名它<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>这个PR的核心是一个简单的重构操作，但它体现了软件开发中一个重要的原则：保持命名一致性。在Bevy ECS的核心模块中，<code>EntitiesAllocator</code>类型已经被重命名为<code>EntityAllocator</code>，但是相关的字段和方法名称却没有同步更新。这种不一致会导致代码库中产生认知负担，开发者需要记住一个类型对应着两种不同的命名方式。<p>问题最初是在代码审查或使用过程中发现的。当开发者查看<code>World</code>结构的定义时，会发现一个名为<code>allocator</code>的字段，其类型是<code>EntityAllocator</code>，但访问这个字段的方法却叫做<code>entities_allocator()</code>和<code>entities_allocator_mut()</code>。这种命名上的不一致不仅影响代码的可读性，也增加了新贡献者的学习曲线。<p>解决这个问题的技术方案非常直接：将所有相关的方法和字段名称从<code>entities_allocator</code>变更为<code>entity_allocator</code>，使其与返回的类型名称<code>EntityAllocator</code>保持一致。这个变更涉及整个代码库中多个使用该API的地方，包括：<ol><li><code>World</code>结构体中的字段定义<li>公开的API方法（<code>entity_allocator()</code>和<code>entity_allocator_mut()</code>）<li>内部实现中对这些方法的调用<li>测试代码中的使用<li><code>UnsafeWorldCell</code>中的对应方法</ol><p>从技术实现角度来看，这个PR展示了Rust所有权和借用系统在实际应用中的体现。在<code>World</code>结构体中，<code>entity_allocator</code>字段是<code>EntityAllocator</code>类型，它管理着实体的分配和回收。这个字段有对应的不可变和可变引用访问方法，这些方法的设计遵循了Rust的借用规则，确保内存安全。<p>变更过程中需要考虑的一个重要方面是API的向后兼容性。由于这是一个破坏性变更（breaking change），PR的作者同时创建了一个迁移指南文件（<code>entity_allocator.md</code>），帮助现有用户升级他们的代码。这种实践体现了对用户生态的负责态度。<p>这个重构虽然简单，但对代码库的长期健康有积极影响。一致的命名减少了认知负荷，使得代码更容易阅读和维护。当开发者看到<code>world.entity_allocator()</code>时，可以立即推断出它返回的是<code>EntityAllocator</code>类型的引用，而不需要额外的心理映射。<p>在性能方面，这个变更没有引入任何影响，因为这只是标识符的重命名，不涉及运行时逻辑的修改。编译器在编译过程中会将所有引用正确解析，生成的二进制代码保持不变。<p>这个PR也展示了开源项目中一个常见的工作流程：当进行大规模重构时，可能会有一些遗漏的细节需要在后续的PR中修复。通过细致的代码审查和持续集成测试，可以捕捉到这些不一致性并加以纠正。<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[World Struct] --> B[entity_allocator字段]
</span><span>    B --> C[EntityAllocator类型]
</span><span>    A --> D[entity_allocator()方法]
</span><span>    A --> E[entity_allocator_mut()方法]
</span><span>    D --> C
</span><span>    E --> C
</span><span>    
</span><span>    F[UnsafeWorldCell] --> G[entity_allocator()方法]
</span><span>    G --> C
</span><span>    
</span><span>    H[使用代码] --> D
</span><span>    H --> E
</span><span>    H --> G
</span><span>    
</span><span>    I[之前的名称] --> J[entities_allocator]
</span><span>    J -.->|重命名为| B
</span><span>    J -.->|重命名为| D
</span><span>    J -.->|重命名为| E
</span><span>    J -.->|重命名为| G
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=1-crates-bevy-ecs-src-world-mod-rs>1. <code>crates/bevy_ecs/src/world/mod.rs</code></h3><p>这是主要的变更文件，修改了<code>World</code>结构体的字段定义和公共API方法。<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 之前:
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) allocator</span><span style=color:#61676ccc>:</span><span> EntityAllocator</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 之后:
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) entity_allocator</span><span style=color:#61676ccc>:</span><span> EntityAllocator</span><span style=color:#61676ccc>,
</span></code></pre><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 之前:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>entities_allocator</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span>EntityAllocator {
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>allocator
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 之后:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>entity_allocator</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span>EntityAllocator {
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>entity_allocator
</span><span>}
</span></code></pre><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 之前:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>entities_allocator_mut</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> EntityAllocator {
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>allocator
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 之后:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>entity_allocator_mut</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> EntityAllocator {
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>entity_allocator
</span><span>}
</span></code></pre><h3 id=2-crates-bevy-ecs-src-world-unsafe-world-cell-rs>2. <code>crates/bevy_ecs/src/world/unsafe_world_cell.rs</code></h3><p>修改了<code>UnsafeWorldCell</code>中对应的方法，保持API一致性。<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 之前:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>entities_allocator</span><span>(</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'w</span><span> EntityAllocator {
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>unsafe </span><span>{ </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>world_metadata</span><span>() }</span><span style=color:#ed9366>.</span><span>allocator
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 之后:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>entity_allocator</span><span>(</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'w</span><span> EntityAllocator {
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>unsafe </span><span>{ </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>world_metadata</span><span>() }</span><span style=color:#ed9366>.</span><span>entity_allocator
</span><span>}
</span></code></pre><h3 id=3-release-content-migration-guides-entity-allocator-md>3. <code>release-content/migration-guides/entity_allocator.md</code></h3><p>新增的迁移指南，帮助用户适应API变更。<pre class=language-markdown data-lang=markdown style=color:#61676c;background-color:#fafafa><code class=language-markdown data-lang=markdown><span style=color:#abb0b6;background-color:#61676c10;font-weight:700>---
</span><span>title: "</span><span style=color:#ed9366;background-color:#61676c10>`World::entities_allocator`</span><span> is now </span><span style=color:#ed9366;background-color:#61676c10>`World::entity_allocator`</span><span>"
</span><span>pull_requests: [22638]
</span><span style=color:#fa6e32;font-weight:700>---
</span><span>
</span><span style=color:#ed9366;background-color:#61676c10>`World::entities_allocator()`</span><span> has been renamed to </span><span style=color:#ed9366;background-color:#61676c10>`World::entity_allocator()`</span><span> to match the type returned (</span><span style=color:#ed9366;background-color:#61676c10>`EntityAllocator`</span><span>). Likewise, </span><span style=color:#ed9366;background-color:#61676c10>`World::entities_allocator_mut()`</span><span> has been renamed to </span><span style=color:#ed9366;background-color:#61676c10>`World::entity_allocator_mut()`</span><span>.
</span></code></pre><h3 id=4-crates-bevy-ecs-src-lib-rs>4. <code>crates/bevy_ecs/src/lib.rs</code></h3><p>更新了测试代码中的方法调用，确保测试通过。<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 之前:
</span><span style=color:#fa6e32>let</span><span> e1 </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>entities_allocator_mut</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>alloc</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 之后:
</span><span style=color:#fa6e32>let</span><span> e1 </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity_allocator_mut</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>alloc</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=5-qi-ta-xiang-guan-wen-jian>5. 其他相关文件</h3><ul><li><code>crates/bevy_ecs/src/bundle/spawner.rs</code><li><code>crates/bevy_ecs/src/entity/clone_entities.rs</code><li><code>crates/bevy_ecs/src/entity/map_entities.rs</code><li><code>crates/bevy_ecs/src/system/commands/mod.rs</code><li><code>crates/bevy_ecs/src/system/systemparam.rs</code><li><code>crates/bevy_ecs/src/world/deferred_world.rs</code><li><code>crates/bevy_ecs/src/world/entity_access/world_mut.rs</code></ul><p>这些文件都更新了对<code>entity_allocator</code>字段或方法的引用，确保整个代码库的一致性。<h2 id=further-reading>Further Reading</h2><ol><li><p><strong>Bevy ECS 官方文档</strong>: https://bevyengine.org/learn/book/ecs/ - 了解Bevy ECS的基本概念和设计哲学</p><li><p><strong>Rust 命名约定</strong>: https://rust-lang.github.io/api-guidelines/naming.html - Rust API设计指南中的命名约定部分</p><li><p><strong>语义化版本控制 (SemVer)</strong>: https://semver.org/ - 了解如何管理API破坏性变更和版本发布</p><li><p><strong>重构：改善既有代码的设计</strong> (Martin Fowler著) - 经典的重构技术参考，包括重命名等基本重构手法</p><li><p><strong>Bevy 迁移指南</strong>: https://bevyengine.org/learn/migration-guides/ - Bevy引擎的官方迁移指南，包含各个版本的破坏性变更说明</p></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-01/pr_22638.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>