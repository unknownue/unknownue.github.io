<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22671 Solari: Skip ReSTIR GI for smooth metallic surfaces
        
    </title><meta content="#22671 Solari: Skip ReSTIR GI for smooth metallic surfaces" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-01/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-01-24</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-01/pr-22671-zh-cn-20260124>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Solari: Skip ReSTIR GI for smooth metallic surfaces<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22671<li><strong>Author</strong>: JMS55<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: D-Trivial, A-Rendering, C-Performance, S-Ready-For-Final-Review<li><strong>Created</strong>: 2026-01-23T18:08:52Z<li><strong>Merged</strong>: 2026-01-24T19:47:40Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Save perf on scenes with smooth metallic surfaces</ul><h2 id=solution>Solution</h2><ul><li>Skip ReSTIR GI for these surfaces as the contribution will be zero anyways</ul><h2 id=testing>Testing</h2><ul><li>Tested on a half metallic half non-metallic scene with varying roughness</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a specific performance optimization in Bevy’s Solari rendering system, which implements ReSTIR GI (ReSTIR: ReSTIR Temporal Importance Resampling for Global Illumination). The core insight driving this change is straightforward: don’t waste computational resources calculating lighting contributions that will effectively be zero.<p>The problem centers around physically-based rendering (PBR) materials and their interaction with global illumination. In PBR, materials have two primary components: a diffuse component (which scatters light in all directions) and a specular component (which reflects light like a mirror). The <code>metallic</code> parameter controls the balance between these components. When <code>metallic</code> is 1.0, the material is fully metallic, meaning it has no diffuse component at all - it only reflects specularly. The <code>roughness</code> parameter controls how sharp or blurry these specular reflections are.<p>For smooth metallic surfaces (high metallic value, low roughness), there’s essentially no diffuse component to contribute to global illumination. ReSTIR GI primarily handles diffuse indirect lighting, so calculating it for these surfaces is computationally wasteful since the result will be negligible or zero. The existing code was performing the full ReSTIR GI pipeline for all surfaces regardless of their material properties.<p>The solution implements a simple early exit in the ReSTIR GI shader code. Before proceeding with expensive GI calculations, the shader now checks if the surface meets specific criteria: <code>metallic > 0.9999</code> (essentially fully metallic) and <code>roughness <= DIFFUSE_GI_REUSE_ROUGHNESS_THRESHOLD</code> (smooth enough that diffuse contribution is negligible). When both conditions are true, the shader immediately returns an empty reservoir (zero contribution) and skips the rest of the computation.<p>This approach is effective because it operates at the shader level, avoiding unnecessary work before it happens rather than trying to optimize calculations that are already in progress. The threshold values are carefully chosen: 0.9999 for metallic (not exactly 1.0 to handle floating-point precision issues) and reusing the existing <code>DIFFUSE_GI_REUSE_ROUGHNESS_THRESHOLD</code> constant for consistency with other parts of the rendering system.<p>The implementation required changes in two key shader functions: <code>initial_and_temporal</code> and <code>spatial_and_shade</code>. Both functions follow the same pattern - they resolve the surface material properties, check the metallic/roughness conditions, and early-exit if appropriate. This ensures the optimization applies throughout the ReSTIR GI pipeline, from initial sample generation through temporal and spatial reuse.<p>From an architectural perspective, this change fits well into the existing Solari system. It leverages already-available material data from the GBuffer and uses an existing constant for consistency. The optimization is localized to the ReSTIR GI shader without affecting other rendering passes or requiring changes to the material system.<p>The performance impact is straightforward: scenes with many smooth metallic surfaces will see reduced GPU load during GI calculations. Since the check happens early in the shader and avoids subsequent ray tracing and sampling operations, the savings can be significant for qualifying surfaces. The author tested this on a scene with half metallic and half non-metallic surfaces with varying roughness, confirming both correctness and performance improvement.<p>This optimization demonstrates a common pattern in real-time graphics: identifying calculations that can be skipped based on material properties. Similar optimizations exist in other rendering systems, like skipping specular calculations for fully diffuse materials or avoiding transparency calculations for opaque surfaces.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Surface Material Evaluation] --> B{Check Material Properties}
</span><span>    B -->|metallic > 0.9999&LTbr>AND roughness ≤ threshold| C[Skip ReSTIR GI - Return Empty Reservoir]
</span><span>    B -->|Otherwise| D[Proceed with Full ReSTIR GI Pipeline]
</span><span>    D --> E[Initial/Temporal Reservoir Generation]
</span><span>    D --> F[Spatial Reuse and Shading]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>crates/bevy_solari/src/realtime/restir_gi.wgsl</strong> (+9/-0)<p>This is the only file modified in this PR. It contains the WebGPU Shading Language (WGSL) code for the ReSTIR GI implementation in Solari, Bevy’s global illumination system.<h3 id=changes-in-detail>Changes in Detail:</h3><ol><li><strong>Import Addition</strong>: Added import for <code>DIFFUSE_GI_REUSE_ROUGHNESS_THRESHOLD</code> constant from the specular GI module:</ol><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>#import bevy_solari::specular_gi::DIFFUSE_GI_REUSE_ROUGHNESS_THRESHOLD
</span></code></pre><ol start=2><li><strong>Early Exit in <code>initial_and_temporal</code> Function</strong>: Added material check after surface resolution:</ol><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before: No check, always proceed
</span><span>let surface = gpixel_resolve(...);
</span><span>
</span><span>// After: Check material properties and early exit
</span><span>let surface = gpixel_resolve(textureLoad(gbuffer, global_id.xy, 0), depth, global_id.xy, view.main_pass_viewport.zw, view.world_from_clip);
</span><span>if surface.material.metallic > 0.9999 && surface.material.roughness <= DIFFUSE_GI_REUSE_ROUGHNESS_THRESHOLD {
</span><span>    gi_reservoirs_b[pixel_index] = empty_reservoir();
</span><span>    return;
</span><span>}
</span></code></pre><ol start=3><li><strong>Early Exit in <code>spatial_and_shade</code> Function</strong>: Added identical check in the second stage:</ol><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>let surface = gpixel_resolve(textureLoad(gbuffer, global_id.xy, 0), depth, global_id.xy, view.main_pass_viewport.zw, view.world_from_clip);
</span><span>if surface.material.metallic > 0.9999 && surface.material.roughness <= DIFFUSE_GI_REUSE_ROUGHNESS_THRESHOLD {
</span><span>    gi_reservoirs_a[pixel_index] = empty_reservoir();
</span><span>    return;
</span><span>}
</span></code></pre><p>These changes implement the core optimization: when a surface is essentially fully metallic and smooth enough, the shader skips all ReSTIR GI calculations and returns an empty reservoir (no GI contribution). This saves computational resources that would otherwise be wasted on calculations with negligible results.<h2 id=further-reading>Further Reading</h2><ol><li><strong>ReSTIR GI Paper</strong>: “Spatiotemporal reservoir resampling for real-time ray tracing with dynamic direct lighting” by Bitterli et al. - The foundational paper for the ReSTIR algorithm<li><strong>Physically Based Rendering</strong>: The PBR theory behind metallic/roughness workflow and why diffuse contribution approaches zero for smooth metallic surfaces<li><strong>Bevy Solari Documentation</strong>: For understanding how Solari integrates with Bevy’s rendering pipeline<li><strong>WebGPU Shading Language (WGSL) Specification</strong>: For details on the shader language used in this implementation<li><strong>Global Illumination Techniques</strong>: Overview of various GI methods and their performance characteristics in real-time rendering</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-01/pr_22671.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>