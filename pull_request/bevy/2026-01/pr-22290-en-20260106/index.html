<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22290 fix: add unwind safety to `resource_scope`
        
    </title><meta content="#22290 fix: add unwind safety to `resource_scope`" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-01/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-01-06</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-01/pr-22290-zh-cn-20260106>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: fix: add unwind safety to <code>resource_scope</code><li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22290<li><strong>Author</strong>: joseph-gio<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-ECS, S-Ready-For-Final-Review, D-Complex, X-Uncontroversial<li><strong>Created</strong>: 2025-12-28T01:28:50Z<li><strong>Merged</strong>: 2026-01-05T23:43:56Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>The function <code>World::resource_scope</code> is a primitive that allows the user to get mutable access to a resource and the rest of the world at the same time. This is incredibly useful for exclusive systems, implementations of <code>Command</code>, and custom abstractions. It works by temporarily removing the resource from the world and running a user-provided closure with mutable access to both. After the closure completes, the resource is re-inserted into the world for other code to use.<p>With the current implementation, any panics originating in the user-provided closure will result in the resource being lost. This is problematic for a couple of reasons:<ul><li>Any users wishing to utilize <code>std::panic::catch_unwind</code> have to deal with the fact that the panic has left the world in an invalid state. <ul><li>While some individuals consider catch_unwind to be bad practice, it is a native feature of Rust that we should provide support for. In certain situations it is quite valuable: <ul><li>When creating apps targeting production, it is crucial to avoid hard-crashing on users, and in many cases it is not reasonable to ensure that every code path will always complete successfully. catch_unwind is useful for capturing panics and shifting into a controlled error state. This is hard to do when the world is left in an invalid state.<li>It is often useful to <em>localize</em> panics, rather than fully recover from them. When using threads or async tasks, the usual default is to localize panics to the original context that caused them. When implementing abstractions that give async tasks access to the world, it is useful to capture panics and propagate them back to the async context.</ul></ul><li>Panics occurring inside of <code>resource_scope</code> can lead to knock-on errors, which can make debugging more difficult, as the user may need to sort through many errors to identify which one was the root cause.</ul><p>The objective here is to make resource_scope panic-safe, ensuring that the resource is always restored to the world when unwinding from a panic (on platforms that support unwinding; <code>panic=abort</code> is unrecoverable by design). This enables more robust panic handling, and allows for more graceful shutdown sequences when panics are truly fatal.<h2 id=solution>Solution</h2><p>Add a “guard” type that captures mutable access to the world and temporary ownership of the resource. This type has a <code>Drop</code> implementation that is responsible for re-inserting the resource at the end of the scope – this pattern is similar to <code>try ... finally</code> blocks in many languages.<h2 id=testing>Testing</h2><ul><li>Added a test that verifies the resource is properly restored when unwinding from <code>resource_scope</code>.<li>Added a regression test for an existing edge-case triggered by <code>World::clear_resources</code> or <code>World::clear_all</code>.</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The <code>World::resource_scope</code> method in Bevy’s ECS provides a critical primitive: it allows code to temporarily take exclusive ownership of a resource while still having mutable access to the rest of the world. This is essential for exclusive systems, custom commands, and various abstractions that need to operate on a resource while also modifying other parts of the world.<p>The original implementation followed a straightforward pattern: remove the resource from the world, run the user’s closure with access to the resource and world, then re-insert the resource. However, this approach had a significant flaw - if the user’s closure panicked, the resource would never be re-inserted, leaving the world in an invalid state.<p>This problem manifested in several concrete scenarios. Developers using <code>std::panic::catch_unwind</code> for production applications found their worlds corrupted after panics, making controlled error recovery impossible. Those implementing async task systems that needed to isolate panics to individual tasks discovered that panics in <code>resource_scope</code> would leak resources and cause cascading failures. Even in debugging scenarios, the loss of resources created confusing knock-on errors that obscured the original problem.<p>The solution implements a guard pattern using Rust’s drop semantics. The key insight is that by wrapping the temporary resource ownership in a struct with a custom <code>Drop</code> implementation, we can guarantee the resource gets re-inserted regardless of how the closure exits - whether through normal completion, early return, or panic unwinding.<p>The implementation introduces a <code>ReinsertGuard</code> struct that holds:<ul><li>A mutable reference to the world<li>The component ID of the resource<li>The resource value wrapped in <code>ManuallyDrop</code><li>The component ticks and caller metadata<li>A boolean flag tracking successful re-insertion</ul><p>The guard’s <code>Drop</code> implementation handles several edge cases intelligently. If the resource was already re-inserted by user code during the scope (which typically indicates a logic error), the behavior differs between debug and release builds. In debug builds, it panics to alert developers during development. In release builds, it logs a warning and overwrites the user-inserted value with the original one. This pragmatic approach balances safety during development with robustness in production.<p>A subtle but important optimization is the use of a <code>was_successful</code> boolean flag. This tracks whether the guard successfully re-inserted the resource, avoiding the need for separate code paths for normal vs panicking control flow. The method returns <code>Some(result)</code> only if re-insertion succeeded, maintaining the existing API contract while adding unwind safety.<p>The implementation also includes careful handling of the case where resource metadata is cleared during the scope (via <code>World::clear_resources</code>). In this scenario, the guard’s drop implementation detects that the resource data is no longer present and simply drops the resource value without attempting re-insertion. This maintains backward compatibility with existing behavior while ensuring resources aren’t leaked.<p>Two new tests validate the implementation. The <code>resource_scope_unwind</code> test verifies that resources are properly restored after a panic, using <code>std::panic::catch_unwind</code> to simulate panic recovery. The <code>resource_scope_resources_cleared</code> test documents and preserves the existing edge-case behavior when resources are cleared within the scope, serving as a regression test for future maintainers.<p>This change demonstrates a common Rust pattern for resource management: using <code>Drop</code> implementations to ensure cleanup happens regardless of control flow. It’s particularly relevant for ECS systems where resource ownership and lifetimes are critical to maintaining invariants. The implementation shows careful attention to both development experience (with helpful panic messages in debug builds) and production robustness (with non-panicking behavior in release builds).<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[World::resource_scope called] --> B[Remove resource from world]
</span><span>    B --> C[Create ReinsertGuard with resource]
</span><span>    C --> D[Run user closure]
</span><span>    D --> E{Closure exits normally?}
</span><span>    E -->|Yes| F[Guard.drop() re-inserts resource]
</span><span>    E -->|No - Panic| G[Unwind begins]
</span><span>    G --> H[Guard.drop() re-inserts resource]
</span><span>    F --> I[Return Some(result)]
</span><span>    H --> J[Panic propagates]
</span><span>    
</span><span>    subgraph "ReinsertGuard::drop logic"
</span><span>        K[Check if resource already present]
</span><span>        K --> L{Resource present?}
</span><span>        L -->|No| M[Insert resource]
</span><span>        L -->|Yes| N[Debug: Panic/Release: Warn]
</span><span>        N --> O[Overwrite with original value]
</span><span>        M --> P[Set was_successful = true]
</span><span>        O --> P
</span><span>    end
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ecs-src-world-mod-rs-104-30><code>crates/bevy_ecs/src/world/mod.rs</code> (+104/-30)</h3><p>This file contains the core implementation change to <code>try_resource_scope</code>. The method was completely rewritten to use the <code>ReinsertGuard</code> pattern.<p><strong>Key changes:</strong><ol><li>Added the <code>ReinsertGuard</code> struct with custom <code>Drop</code> implementation<li>Modified the control flow to use the guard for resource management<li>Added debug/release differentiation for handling resource re-insertion during scope</ol><p><strong>Code snippet showing the guard implementation:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// type used to manage reinserting the resource at the end of the scope. use of a drop impl means that
</span><span style=color:#abb0b6;font-style:italic>// the resource is inserted even if the user-provided closure unwinds.
</span><span style=color:#abb0b6;font-style:italic>// this facilitates localized panic recovery and makes app shutdown in response to a panic more graceful
</span><span style=color:#abb0b6;font-style:italic>// by avoiding knock-on errors.
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>ReinsertGuard</span><span><</span><span style=color:#fa6e32>'a</span><span>, R> {
</span><span>    world</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'a mut</span><span> World,
</span><span>    component_id</span><span style=color:#61676ccc>:</span><span> ComponentId,
</span><span>    value</span><span style=color:#61676ccc>: </span><span>ManuallyDrop&LTR>,
</span><span>    ticks</span><span style=color:#61676ccc>:</span><span> ComponentTicks,
</span><span>    caller</span><span style=color:#61676ccc>:</span><span> MaybeLocation,
</span><span>    was_successful</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'a mut bool</span><span>,
</span><span>}
</span><span style=color:#fa6e32>impl</span><span>&LTR> Drop </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>ReinsertGuard</span><span><'</span><span style=color:#ed9366>_</span><span>, R> {
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>drop</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>) {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// take ownership of the value first so it'll get dropped if we return early
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// SAFETY: drop semantics ensure that `self.value` will never be accessed again after this call
</span><span>        </span><span style=color:#fa6e32>let</span><span> value </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>unsafe </span><span>{ ManuallyDrop</span><span style=color:#ed9366>::</span><span>take(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>value) }</span><span style=color:#61676ccc>;
</span><span>
</span><span>        </span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(resource_data) </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>world</span><span style=color:#ed9366>.</span><span>storages</span><span style=color:#ed9366>.</span><span>resources</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_mut</span><span>(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>component_id)
</span><span>        </span><span style=color:#fa6e32>else </span><span>{
</span><span>            </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span>        }</span><span style=color:#61676ccc>;
</span><span>
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// in debug mode, raise a panic if user code re-inserted a resource of this type within the scope.
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// resource insertion usually indicates a logic error in user code, which is useful to catch at dev time,
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// however it does not inherently lead to corrupted state, so we avoid introducing an unnecessary crash
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// for production builds.
</span><span>        </span><span style=color:#fa6e32>if</span><span> resource_data</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_present</span><span>() {
</span><span>            </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(debug_assertions)]
</span><span>            {
</span><span>                </span><span style=color:#abb0b6;font-style:italic>// if we're already panicking, log an error instead of panicking, as double-panics result in an abort
</span><span>                </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"std"</span><span>)]
</span><span>                </span><span style=color:#fa6e32>if </span><span>std</span><span style=color:#ed9366>::</span><span>thread</span><span style=color:#ed9366>::</span><span>panicking() {
</span><span>                    log</span><span style=color:#ed9366>::</span><span>error</span><span style=color:#ed9366>!</span><span>(</span><span style=color:#86b300>"Resource `{}` was inserted during a call to World::resource_scope, which may result in unexpected behavior.</span><span style=color:#4cbf99>\n</span><span style=color:#61676ccc>\
</span><span style=color:#86b300>                           In release builds, the value inserted will be overwritten at the end of the scope."</span><span style=color:#61676ccc>,
</span><span>                           DebugName</span><span style=color:#ed9366>::</span><span>type_name</span><span style=color:#ed9366>::</span><span>&LTR>())</span><span style=color:#61676ccc>;
</span><span>                    </span><span style=color:#abb0b6;font-style:italic>// return early to maintain consistent behavior with non-panicking calls in debug builds
</span><span>                    </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span>                }
</span><span>
</span><span>                </span><span style=color:#f07171>panic!</span><span>(</span><span style=color:#86b300>"Resource `{}` was inserted during a call to World::resource_scope, which may result in unexpected behavior.</span><span style=color:#4cbf99>\n</span><span style=color:#61676ccc>\
</span><span style=color:#86b300>                       In release builds, the value inserted will be overwritten at the end of the scope."</span><span style=color:#61676ccc>,
</span><span>                       DebugName</span><span style=color:#ed9366>::</span><span>type_name</span><span style=color:#ed9366>::</span><span>&LTR>())</span><span style=color:#61676ccc>;
</span><span>            }
</span><span>            </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(</span><span style=color:#f29718>not</span><span>(debug_assertions))]
</span><span>            {
</span><span>                </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cold</span><span>]
</span><span>                </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>inline</span><span>(never)]
</span><span>                </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>warn_reinsert</span><span>(</span><span style=color:#ff8f40>resource_name</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>str</span><span>) {
</span><span>                    </span><span style=color:#f07171>warn!</span><span>(
</span><span>                        </span><span style=color:#86b300>"Resource `{resource_name}` was inserted during a call to World::resource_scope: the inserted value will be overwritten."</span><span style=color:#61676ccc>,
</span><span>                    )</span><span style=color:#61676ccc>;
</span><span>                }
</span><span>
</span><span>                </span><span style=color:#f07171>warn_reinsert</span><span>(</span><span style=color:#ed9366>&</span><span>DebugName</span><span style=color:#ed9366>::</span><span>type_name</span><span style=color:#ed9366>::</span><span>&LTR>())</span><span style=color:#61676ccc>;
</span><span>            }
</span><span>        }
</span><span>
</span><span>        OwningPtr</span><span style=color:#ed9366>::</span><span>make(value</span><span style=color:#61676ccc>, </span><span>|</span><span style=color:#ff8f40>ptr</span><span>| {
</span><span>            </span><span style=color:#abb0b6;font-style:italic>// SAFETY: ptr is of type `R`, which corresponds to the same component ID used to retrieve the resource data.
</span><span>            </span><span style=color:#fa6e32>unsafe </span><span>{
</span><span>                resource_data</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_with_ticks</span><span>(ptr</span><span style=color:#61676ccc>, </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>ticks</span><span style=color:#61676ccc>, </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>caller)</span><span style=color:#61676ccc>;
</span><span>            }
</span><span>        })</span><span style=color:#61676ccc>;
</span><span>
</span><span>        </span><span style=color:#ed9366>*</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>was_successful </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>true</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><h3 id=crates-bevy-ecs-src-lib-rs-35-0><code>crates/bevy_ecs/src/lib.rs</code> (+35/-0)</h3><p>This file contains the new tests for unwind safety and edge-case behavior.<p><strong>Key changes:</strong><ol><li>Added <code>resource_scope_unwind</code> test to verify panic recovery<li>Added <code>resource_scope_resources_cleared</code> test for the clear_resources edge case</ol><p><strong>Code snippet showing the unwind test:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"std"</span><span>)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>resource_scope_unwind</span><span>() {
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Debug</span><span style=color:#61676ccc>,</span><span> PartialEq)]
</span><span>    </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>Panic</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> world </span><span style=color:#ed9366>= </span><span>World</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#f07171>assert!</span><span>(world</span><span style=color:#ed9366>.</span><span>try_resource_scope</span><span style=color:#ed9366>::</span><span>&LTResA, </span><span style=color:#ed9366>_</span><span>>(|_</span><span style=color:#61676ccc>,</span><span> _| {})</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_none</span><span>())</span><span style=color:#61676ccc>;
</span><span>    world</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_resource</span><span>(ResA(</span><span style=color:#ff8f40>0</span><span>))</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> panic </span><span style=color:#ed9366>= </span><span>std</span><span style=color:#ed9366>::</span><span>panic</span><span style=color:#ed9366>::</span><span>catch_unwind(core</span><span style=color:#ed9366>::</span><span>panic</span><span style=color:#ed9366>::</span><span>AssertUnwindSafe(|| {
</span><span>        world</span><span style=color:#ed9366>.</span><span style=color:#f07171>resource_scope</span><span>(|</span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> World</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>_value</span><span style=color:#61676ccc>: </span><span>Mut&LTResA>| {
</span><span>            </span><span style=color:#f07171>assert!</span><span>(</span><span style=color:#ed9366>!</span><span>world</span><span style=color:#ed9366>.</span><span>contains_resource</span><span style=color:#ed9366>::</span><span>&LTResA>())</span><span style=color:#61676ccc>;
</span><span>            std</span><span style=color:#ed9366>::</span><span>panic</span><span style=color:#ed9366>::</span><span>panic_any(Panic)</span><span style=color:#61676ccc>;
</span><span>        })</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#f07171>unreachable!</span><span>()</span><span style=color:#61676ccc>;
</span><span>    }))</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#f07171>assert_eq!</span><span>(panic</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_err</span><span>()</span><span style=color:#ed9366>.</span><span>downcast_ref</span><span style=color:#ed9366>::</span><span>&LTPanic>()</span><span style=color:#61676ccc>, </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#ed9366>&</span><span>Panic))</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#f07171>assert!</span><span>(world</span><span style=color:#ed9366>.</span><span>contains_resource</span><span style=color:#ed9366>::</span><span>&LTResA>())</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><p><strong>Rust’s Unwind Safety</strong>: The Rustonomicon chapter on <a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/nomicon/exception-safety.html target=_blank>Exception Safety</a> explains the concepts behind panic safety and unwind safety.</p><li><p><strong>RAII Pattern</strong>: The guard pattern used here is an example of Resource Acquisition Is Initialization (RAII). The <a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/book/ch15-03-drop.html target=_blank>Rust Book section on Drop</a> covers this fundamental Rust pattern.</p><li><p><strong>Bevy ECS Resources</strong>: The <a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/programming/resources.html target=_blank>Bevy ECS Resources documentation</a> provides context on how resources are used in Bevy’s Entity Component System.</p><li><p><strong>std::panic Module</strong>: The <a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/std/panic/index.html target=_blank>std::panic module documentation</a> covers Rust’s panic handling mechanisms, including <code>catch_unwind</code>.</p><li><p><strong>ManuallyDrop</strong>: The <a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/std/mem/struct.ManuallyDrop.html target=_blank>std::mem::ManuallyDrop documentation</a> explains how to control drop order and manual destruction of values.</p></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-01/pr_22290.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>