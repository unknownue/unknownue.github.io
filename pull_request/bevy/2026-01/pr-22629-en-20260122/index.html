<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22629 Fix FPS overlay system ordering ambiguity
        
    </title><meta content="#22629 Fix FPS overlay system ordering ambiguity" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-01/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-01-22</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-01/pr-22629-zh-cn-20260122>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix FPS overlay system ordering ambiguity<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22629<li><strong>Author</strong>: JWSong<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Diagnostics, X-Uncontroversial, D-Straightforward, S-Needs-Review<li><strong>Created</strong>: 2026-01-21T17:33:58Z<li><strong>Merged</strong>: 2026-01-22T19:01:23Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Fixes #22571<h2 id=solution>Solution</h2><p>Added <code>FpsOverlaySystems</code> system set and explicitly ordered <code>customize_overlay</code> to run before <code>update_text</code>. This gets rid of the internal ambiguity warnings and also gives users a way to order their own systems against the overlay.<h2 id=testing>Testing</h2><p>Ran locally with ambiguity warnings enabled - no more internal overlay warnings. Didn’t add a unit test since scheduling order is tricky to test in isolation. To verify:<ul><li>Enable <code>ScheduleBuildSettings</code> ambiguity warnings.<li>Add a user system that uses <code>TextUiWriter</code>.<li>Run an app with <code>FpsOverlayPlugin</code> and confirm no overlay-related ambiguity warnings.</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a system ordering ambiguity in Bevy’s FPS overlay functionality. The issue surfaced when developers enabled ambiguity warnings in their Bevy applications, revealing that the FPS overlay systems didn’t have explicit ordering constraints, causing the scheduler to issue warnings about potential nondeterministic execution.<p>The root problem was in the FPS overlay plugin’s system scheduling. Two key systems - <code>customize_overlay</code> and <code>update_text</code> - both write to UI text components using <code>TextUiWriter</code>. Without explicit ordering, Bevy’s scheduler couldn’t guarantee which system would run first when both were eligible to execute. While this might not cause obvious bugs in practice, it violates the determinism guarantees that explicit system ordering aims to provide in ECS architectures.<p>The solution implements a straightforward but important pattern in Bevy’s scheduling system: defining a dedicated system set for related systems. The developer created a new <code>FpsOverlaySystems</code> enum with two variants: <code>Customize</code> and <code>UpdateText</code>. This approach serves dual purposes: it resolves the immediate ambiguity warning by providing explicit ordering constraints, and it provides a public API endpoint for users to order their own systems relative to the overlay systems.<p>The implementation follows Bevy’s standard pattern for system ordering:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>configure_sets</span><span>(
</span><span>    Update</span><span style=color:#61676ccc>,
</span><span>    FpsOverlaySystems</span><span style=color:#ed9366>::</span><span>Customize</span><span style=color:#ed9366>.</span><span style=color:#f07171>before</span><span>(FpsOverlaySystems</span><span style=color:#ed9366>::</span><span>UpdateText)</span><span style=color:#61676ccc>,
</span><span>)
</span></code></pre><p>This configuration establishes that <code>Customize</code> systems must run before <code>UpdateText</code> systems within the <code>Update</code> schedule. The individual systems are then assigned to their respective sets:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>(toggle_display</span><span style=color:#61676ccc>,</span><span> customize_overlay)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>run_if</span><span>(resource_changed</span><span style=color:#ed9366>::</span><span>&LTFpsOverlayConfig>)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>in_set</span><span>(FpsOverlaySystems</span><span style=color:#ed9366>::</span><span>Customize)</span><span style=color:#61676ccc>,
</span><span>update_text
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>run_if</span><span>(</span><span style=color:#f07171>on_timer</span><span>(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>config</span><span style=color:#ed9366>.</span><span>refresh_interval))
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>in_set</span><span>(FpsOverlaySystems</span><span style=color:#ed9366>::</span><span>UpdateText)</span><span style=color:#61676ccc>,
</span></code></pre><p>This structure makes the dependencies explicit and clear: configuration changes (handled by <code>customize_overlay</code>) must be applied before the text is updated (handled by <code>update_text</code>). The logical flow here is that you want to apply any styling or formatting changes from the config before computing and displaying the actual FPS values.<p>A secondary but important change was made in the frame time graph module. The <code>update_frame_time_values</code> system was also added to the <code>FpsOverlaySystems::UpdateText</code> set. This ensures that both text-updating systems (FPS overlay and frame time graph) are grouped together in the same execution phase, maintaining consistency in how they interact with the UI text components.<p>The PR author made a pragmatic decision not to include unit tests for the scheduling changes, noting that “scheduling order is tricky to test in isolation.” This is a reasonable trade-off given that the primary validation method is enabling ambiguity warnings and verifying they disappear. The testing instructions provided are practical and sufficient for verifying the fix works as intended.<p>This fix demonstrates an important pattern in Bevy development: when multiple systems access the same resources (in this case, UI text components), explicit ordering is necessary to guarantee deterministic behavior. The solution is minimal and focused, adding just enough structure to resolve the ambiguity without over-engineering or introducing unnecessary complexity.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Update Schedule] --> B[FpsOverlaySystems::Customize]
</span><span>    A --> C[FpsOverlaySystems::UpdateText]
</span><span>    B -->|.before| C
</span><span>    
</span><span>    D[customize_overlay system] --> B
</span><span>    E[toggle_display system] --> B
</span><span>    F[update_text system] --> C
</span><span>    G[update_frame_time_values system] --> C
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-dev-tools-src-fps-overlay-rs-19-3><code>crates/bevy_dev_tools/src/fps_overlay.rs</code> (+19/-3)</h3><p>This file contains the main changes to fix the system ordering ambiguity. The changes introduce a new system set and reorganize how systems are scheduled.<p><strong>Key changes:</strong><ol><li><strong>Added <code>FpsOverlaySystems</code> enum</strong>:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>/// System sets for FPS overlay updates.
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(SystemSet</span><span style=color:#61676ccc>,</span><span> Debug</span><span style=color:#61676ccc>,</span><span> Hash</span><span style=color:#61676ccc>,</span><span> PartialEq</span><span style=color:#61676ccc>,</span><span> Eq</span><span style=color:#61676ccc>,</span><span> Clone)]
</span><span style=color:#fa6e32>pub enum </span><span style=color:#399ee6>FpsOverlaySystems </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>/// Applies config changes to the overlay UI.
</span><span>    Customize</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>/// Updates the overlay contents.
</span><span>    UpdateText</span><span style=color:#61676ccc>,
</span><span>}
</span></code></pre><ol start=2><li><strong>Configured system ordering</strong>:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>configure_sets</span><span>(
</span><span>    Update</span><span style=color:#61676ccc>,
</span><span>    FpsOverlaySystems</span><span style=color:#ed9366>::</span><span>Customize</span><span style=color:#ed9366>.</span><span style=color:#f07171>before</span><span>(FpsOverlaySystems</span><span style=color:#ed9366>::</span><span>UpdateText)</span><span style=color:#61676ccc>,
</span><span>)
</span></code></pre><ol start=3><li><strong>Assigned systems to appropriate sets</strong>:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(
</span><span>    Update</span><span style=color:#61676ccc>,
</span><span>    (
</span><span>        (toggle_display</span><span style=color:#61676ccc>,</span><span> customize_overlay)
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>run_if</span><span>(resource_changed</span><span style=color:#ed9366>::</span><span>&LTFpsOverlayConfig>)
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>in_set</span><span>(FpsOverlaySystems</span><span style=color:#ed9366>::</span><span>Customize)</span><span style=color:#61676ccc>,
</span><span>        update_text
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>run_if</span><span>(</span><span style=color:#f07171>on_timer</span><span>(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>config</span><span style=color:#ed9366>.</span><span>refresh_interval))
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>in_set</span><span>(FpsOverlaySystems</span><span style=color:#ed9366>::</span><span>UpdateText)</span><span style=color:#61676ccc>,
</span><span>    )</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-dev-tools-src-frame-time-graph-mod-rs-9-3><code>crates/bevy_dev_tools/src/frame_time_graph/mod.rs</code> (+9/-3)</h3><p>This file ensures the frame time graph system is properly ordered with the FPS overlay systems.<p><strong>Key changes:</strong><ol><li><strong>Added necessary imports</strong>:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>use </span><span>bevy_ecs</span><span style=color:#ed9366>::</span><span>{
</span><span>    schedule</span><span style=color:#ed9366>::</span><span>IntoScheduleConfigs</span><span style=color:#61676ccc>,
</span><span>    system</span><span style=color:#ed9366>::</span><span>{Res</span><span style=color:#61676ccc>,</span><span> ResMut}</span><span style=color:#61676ccc>,
</span><span>}</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>use crate</span><span style=color:#ed9366>::</span><span>fps_overlay</span><span style=color:#ed9366>::</span><span>{FpsOverlayConfig</span><span style=color:#61676ccc>,</span><span> FpsOverlaySystems}</span><span style=color:#61676ccc>;
</span></code></pre><ol start=2><li><strong>Added the frame time graph system to the UpdateText set</strong>:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(
</span><span>    Update</span><span style=color:#61676ccc>,
</span><span>    update_frame_time_values</span><span style=color:#ed9366>.</span><span style=color:#f07171>in_set</span><span>(FpsOverlaySystems</span><span style=color:#ed9366>::</span><span>UpdateText)</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/ecs/schedule/index.html target=_blank>Bevy ECS System Ordering Documentation</a> - Official documentation on Bevy’s system scheduling and ordering<li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/programming/system-sets.html target=_blank>Bevy System Sets Guide</a> - Comprehensive guide to using system sets for organization and ordering<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/examples/ecs/schedule.rs target=_blank>ECS Scheduling and Ambiguity Detection</a> - Example demonstrating system ordering patterns<li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/text/struct.TextUiWriter.html target=_blank>TextUiWriter Documentation</a> - API reference for the text component writer that was causing the ambiguity</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-01/pr_22629.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>