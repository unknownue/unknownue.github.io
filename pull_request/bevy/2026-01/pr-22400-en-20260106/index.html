<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22400 Reduce aliasing and Moiré patterns in temporal shadow filtering
        
    </title><meta content="#22400 Reduce aliasing and Moiré patterns in temporal shadow filtering" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-01/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-01-06</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-01/pr-22400-zh-cn-20260106>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>Reduce aliasing and Moiré patterns in temporal shadow filtering<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Reduce aliasing and Moiré patterns in temporal shadow filtering<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22400<li><strong>Author</strong>: superdump<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, S-Ready-For-Final-Review, C-Refinement<li><strong>Created</strong>: 2026-01-06T08:10:27Z<li><strong>Merged</strong>: 2026-01-06T20:37:48Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description>Description</h2><h1 id=objective>Objective</h1><ul><li>Reduce aliasing and Moiré patterns in temporal shadow filtering</ul><h2 id=solution>Solution</h2><ul><li>Use interleaved gradient noise based on screen UV not light local UV</ul><p>NOTE: It only affects <strong><code>ShadowFilteringMethod::Temporal</code> or non-temporal PCSS</strong><h2 id=testing>Testing</h2><p>Tested with <code>pcss</code> and <code>shadow_biases</code> examples. The latter was more useful - see showcase section.<p>NOTE: It only affects <strong><code>ShadowFilteringMethod::Temporal</code> or non-temporal PCSS</strong><p>However, this touches more code paths and all combinations need testing:<ul><li>Light types: <ul><li>Point<li>Spot<li>Directional</ul><li>Shadow mapping<li>Soft shadows (PCSS)<li>Transmission<li>Distance fog</ul><hr><h2 id=showcase>Showcase</h2><p><code>main</code>: <img alt="Screenshot 2026-01-06 at 01 12 48" height=860 src=https://github.com/user-attachments/assets/abcc38ab-baa8-434d-8280-b35698c2c030 width=1392><p><code>PR</code>: <img alt="Screenshot 2026-01-06 at 01 12 26" height=860 src=https://github.com/user-attachments/assets/b09d36ed-a7e1-455b-bd69-2b477c94b5bd width=1392><p>It also makes the full temporal mode where the noise patterns change each frame look much better, especially with TAA enabled. That is however a bit difficult to illustrate due to the animation aspect.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The problem was visual artifacts in Bevy’s shadow rendering system, specifically aliasing and Moiré patterns that appeared when using temporal shadow filtering or PCSS (Percentage-Closer Soft Shadows). These artifacts manifested as distracting, repetitive patterns in shadows that degraded visual quality. The issue was particularly noticeable in the <code>shadow_biases</code> example, where the structured noise patterns created unnatural-looking shadows.<p>The root cause was in how the temporal filtering noise was generated. Previously, the system used light-local UV coordinates to seed the interleaved gradient noise function that determines sampling patterns for temporal shadow filtering. This approach caused problems because light-space coordinates can change rapidly across screen space, especially for directional lights with large shadow maps. When the noise pattern varies too quickly relative to screen pixels, it creates visible Moiré patterns and aliasing artifacts.<p>The solution changed the noise generation to use screen-space UV coordinates (<code>frag_coord.xy</code>) instead of light-local coordinates. This ensures the noise pattern is stable in screen space, which aligns better with how temporal anti-aliasing (TAA) and other screen-space effects work. The change required modifying multiple shader functions to pass the screen coordinates through the shadow sampling pipeline.<p>The implementation involved updating four WGSL shader files to propagate the screen coordinates through the shadow sampling system. The key technical insight was that the <code>random_rotation_matrix</code> function, which generates the sampling pattern for temporal filtering, needed to be seeded with screen-space coordinates rather than light-space coordinates. This required modifying the function signatures at multiple levels:<ol><li>At the highest level, functions like <code>fetch_point_shadow</code> and <code>fetch_directional_shadow</code> needed to accept screen coordinates as parameters<li>These coordinates then needed to be passed down through intermediate functions like <code>sample_shadow_map_pcss</code> and <code>sample_shadow_cubemap_jittered</code><li>Finally, the <code>random_rotation_matrix</code> function uses these screen coordinates to generate consistent noise patterns across the screen</ol><p>An important aspect of this change is that it only affects specific shadow filtering methods. The PR description emphasizes twice that it only impacts <code>ShadowFilteringMethod::Temporal</code> or non-temporal PCSS. This selective impact is important because other filtering methods like hardware PCF or Gaussian filtering don’t use the same temporal sampling patterns and therefore don’t need this change.<p>The implementation also maintains backward compatibility for non-temporal shadow filtering paths. For example, in <code>shadow_sampling.wgsl</code>, the <code>sample_shadow_map_jimenez_fourteen</code> function still accepts a <code>temporal</code> boolean parameter that controls whether temporal filtering is applied, and the screen coordinates are only used for the noise generation when temporal filtering is active.<p>One interesting implementation detail is in <code>shadow_sampling.wgsl</code> where the order of operations was adjusted in <code>sample_shadow_cubemap_jittered</code>. Previously, the function computed the orthonormal basis first, then generated the rotation matrix. The updated version generates the rotation matrix first (using screen coordinates), then computes the basis. This reorganization doesn’t change the mathematical outcome but makes the code flow more logical since the rotation matrix generation now depends on the screen coordinates parameter.<p>The impact of this change is significant visual improvement. The before-and-after screenshots show a clear reduction in structured noise patterns in the shadows. The shadows appear more natural and less “patterned,” which is particularly important for temporal filtering where these patterns would otherwise create distracting temporal artifacts when combined with TAA. The change makes the temporal mode “look much better, especially with TAA enabled,” as noted in the PR description.<p>From an architectural perspective, this change demonstrates good practice in shader programming: using stable screen-space coordinates for noise generation rather than derivatives of world-space or light-space coordinates that can vary unpredictably across the screen. This approach aligns with techniques used in other temporal rendering methods where screen-space stability is crucial for good temporal convergence.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[PBR Lighting/Fog Functions] --> B[Shadow Fetch Functions]
</span><span>    B --> C[Shadow Sampling Functions]
</span><span>    C --> D[Random Rotation Matrix]
</span><span>    
</span><span>    A -- passes --> B
</span><span>    B -- passes --> C
</span><span>    C -- uses --> D
</span><span>    
</span><span>    E[Screen Coordinates&LTbr/>frag_coord.xy] --> A
</span><span>    A --> B
</span><span>    B --> C
</span><span>    C --> D
</span><span>    
</span><span>    style D fill:#f9f,stroke:#333,stroke-width:2px
</span><span>    style E fill:#ccf,stroke:#333,stroke-width:2px
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ol><li><p><strong><code>crates/bevy_pbr/src/render/shadows.wgsl</code></strong> (+59/-9)</p> <ul><li>Modified shadow fetching functions to accept screen coordinates parameter<li>Updated <code>fetch_point_shadow</code>, <code>fetch_spot_shadow</code>, <code>fetch_directional_shadow</code>, and <code>sample_directional_cascade</code> to pass <code>frag_coord_xy</code> to sampling functions<li>Added <code>frag_coord_xy</code> parameter to function signatures and propagated through cascade blending</ul> <p>Key changes:</p> <pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>fn fetch_point_shadow(light_id: u32, frag_position: vec4&LTf32>, surface_normal: vec3&LTf32>) -> f32
</span><span>
</span><span>// After:
</span><span>fn fetch_point_shadow(
</span><span>    light_id: u32,
</span><span>    frag_position: vec4&LTf32>,
</span><span>    surface_normal: vec3&LTf32>,
</span><span>    frag_coord_xy: vec2&LTf32>,
</span><span>) -> f32
</span></code></pre><li><p><strong><code>crates/bevy_pbr/src/render/shadow_sampling.wgsl</code></strong> (+24/-14)</p> <ul><li>Modified sampling functions to accept screen coordinates for noise generation<li>Updated <code>sample_shadow_map_jimenez_fourteen</code> to use <code>frag_coord_xy</code> instead of <code>light_local * shadow_map_size</code><li>Updated <code>sample_shadow_cubemap_jittered</code> to use <code>frag_coord_xy</code> instead of fixed <code>vec2(1.0)</code><li>Propagated screen coordinates through PCSS and temporal filtering paths</ul> <p>Key changes:</p> <pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>let rotation_matrix = random_rotation_matrix(light_local * shadow_map_size, temporal);
</span><span>
</span><span>// After:
</span><span>let rotation_matrix = random_rotation_matrix(frag_coord_xy, temporal);
</span></code></pre><li><p><strong><code>crates/bevy_pbr/src/render/pbr_functions.wgsl</code></strong> (+9/-7)</p> <ul><li>Updated calls to shadow fetching functions to pass <code>in.frag_coord.xy</code><li>Modified point light, spot light, and directional light shadow fetching<li>Updated fog rendering to use screen coordinates for directional shadow sampling</ul> <p>Key changes:</p> <pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>shadow = shadows::fetch_point_shadow(light_id, in.world_position, in.world_normal);
</span><span>
</span><span>// After:
</span><span>shadow = shadows::fetch_point_shadow(light_id, in.world_position, in.world_normal, in.frag_coord.xy);
</span></code></pre><li><p><strong><code>crates/bevy_pbr/src/volumetric_fog/volumetric_fog.wgsl</code></strong> (+10/-9)</p> <ul><li>Updated volumetric fog shadow fetching functions to accept screen coordinates<li>Modified <code>fetch_point_shadow_without_normal</code> and <code>fetch_spot_shadow_without_normal</code><li>Ensured consistency with main shadow rendering pipeline</ul> <p>Key changes:</p> <pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>shadow = fetch_point_shadow_without_normal(light_id, vec4(P_world, 1.0));
</span><span>
</span><span>// After:
</span><span>shadow = fetch_point_shadow_without_normal(light_id, vec4(P_world, 1.0), position.xy);
</span></code></pre></ol><h2 id=further-reading>Further Reading</h2><ol><li><p><strong>Interleaved Gradient Noise</strong>: The technique used for generating screen-space noise patterns</p> <ul><li>Original presentation: “Interleaved Gradient Noise” by Jorge Jimenez (Call of Duty: Advanced Warfare)<li>Useful for reducing banding and temporal artifacts in real-time rendering</ul><li><p><strong>Temporal Shadow Filtering</strong>:</p> <ul><li>Jimenez, J., et al. “Next Generation Post Processing in Call of Duty: Advanced Warfare” (SIGGRAPH 2014)<li>Discusses temporal reprojection techniques for shadows and other effects</ul><li><p><strong>PCSS (Percentage-Closer Soft Shadows)</strong>:</p> <ul><li>Fernando, R. “Percentage-Closer Soft Shadows” (SIGGRAPH 2005)<li>The algorithm for rendering soft shadows with variable penumbra size</ul><li><p><strong>WGSL Shader Programming</strong>:</p> <ul><li>WebGPU Shading Language specification<li>Bevy’s rendering architecture and shader pipeline</ul><li><p><strong>Temporal Anti-Aliasing (TAA)</strong>:</p> <ul><li>Karis, B. “High-Quality Temporal Supersampling” (SIGGRAPH 2014)<li>How temporal techniques combine with shadow filtering for better visual quality</ul></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-01/pr_22400.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>