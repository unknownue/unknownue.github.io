<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22699 修复遮挡剔除
        
    </title><meta content="#22699 修复遮挡剔除" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-01/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-01-25</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2026-01/pr-22699-en-20260125>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=title>Title</h1><p>Fix occlusion culling<h2 id=basic-information>Basic Information</h2><ul><li><strong>标题</strong>: 修复遮挡剔除<li><strong>PR链接</strong>: https://github.com/bevyengine/bevy/pull/22699<li><strong>作者</strong>: atlv24<li><strong>状态</strong>: 已合并<li><strong>标签</strong>: C-Bug (错误), A-Rendering (渲染), P-Crash (崩溃), S-Ready-For-Final-Review (准备最终审核), P-Regression (回归问题)<li><strong>创建时间</strong>: 2026-01-25T19:53:20Z<li><strong>合并时间</strong>: 2026-01-25T20:44:04Z<li><strong>合并者</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p><strong>目标</strong><ul><li>修复 issue #22655</ul><p><strong>解决方案</strong><ul><li>为后期阶段分离只读存储绑定以适配 wgpu</ul><p><strong>测试</strong><ul><li>occlusion_culling 示例不再崩溃</ul><p>找到这个问题的根源非常困难<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>这是一个关于修复渲染管线中遮挡剔除功能崩溃问题的PR。问题出现在Bevy引擎的<code>occlusion_culling</code>示例中，该示例在执行时会触发崩溃。根据标签可以看出，这是一个回归问题（P-Regression），意味着之前的功能正常，但在某个后续改动中出现了问题。<h3 id=wen-ti-gen-yuan-wgslbang-ding-chong-tu>问题根源：WGSL绑定冲突</h3><p>问题的核心在于GPU预处理管线中绑定组的配置。在WGSL着色器中，同一个绑定点（binding point）在不同渲染阶段被重复使用，但访问模式（access mode）不兼容。具体来说，在遮挡剔除的早期阶段（EARLY_PHASE），着色器代码需要以<code>read_write</code>模式访问<code>late_preprocess_work_item_indirect_parameters</code>缓冲区。然而，在后期阶段（LATE_PHASE），同一个绑定点也需要访问相同的缓冲区，但wgpu要求如果同一绑定点在管线不同阶段使用，其访问模式必须兼容。<h3 id=ji-shu-xi-jie-wgslfang-wen-mo-shi-yue-shu>技术细节：WGSL访问模式约束</h3><p>在WebGPU/WGSL规范中，存储缓冲区的访问模式有严格限制：<ul><li><code>read_write</code>模式允许读写操作<li><code>read</code>模式只允许读取操作<li>同一绑定资源在不同着色器阶段使用时，访问模式必须一致或兼容</ul><p>问题出现在<code>mesh_preprocess.wgsl</code>文件中，第112-115行在早期阶段（EARLY_PHASE）定义了<code>read_write</code>访问：<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>@group(0) @binding(12) var&LTstorage, read_write> late_preprocess_work_item_indirect_parameters:
</span><span>    array&LTLatePreprocessWorkItemIndirectParameters>;
</span></code></pre><p>但在后期阶段（LATE_PHASE），代码也需要访问同一个绑定点12。虽然原代码中没有显式定义后期阶段的绑定，但渲染管线配置期望这个绑定在后期阶段也可用。wgpu的验证层检测到这种不一致而引发崩溃。<h3 id=jie-jue-fang-an-fen-chi-zhi-du-bang-ding>解决方案：分离只读绑定</h3><p>修复方案是在Rust代码中为早期阶段和后期阶段创建不同的绑定组布局。具体来说：<ol><li><strong>早期阶段绑定组</strong>：继续使用<code>storage_buffer</code>（默认可读写）<li><strong>后期阶段绑定组</strong>：使用<code>storage_buffer_read_only</code>（只读）</ol><p>这通过修改<code>gpu_preprocess.rs</code>中的绑定组布局实现：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let</span><span> gpu_early_occlusion_culling_bind_group_layout_entries </span><span style=color:#ed9366>=
</span><span>    </span><span style=color:#f07171>gpu_occlusion_culling_bind_group_layout_entries</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend_with_indices</span><span>((
</span><span>        (
</span><span>            </span><span style=color:#ff8f40>11</span><span style=color:#61676ccc>,
</span><span>            storage_buffer</span><span style=color:#ed9366>::</span><span>&LTPreprocessWorkItem>(</span><span style=color:#abb0b6;font-style:italic>/*has_dynamic_offset=*/ </span><span style=color:#ff8f40>false</span><span>)</span><span style=color:#61676ccc>,
</span><span>        )</span><span style=color:#61676ccc>,
</span><span>        (
</span><span>            </span><span style=color:#ff8f40>12</span><span style=color:#61676ccc>,
</span><span>            storage_buffer</span><span style=color:#ed9366>::</span><span>&LTLatePreprocessWorkItemIndirectParameters>(
</span><span>                </span><span style=color:#abb0b6;font-style:italic>/*has_dynamic_offset=*/ </span><span style=color:#ff8f40>false</span><span style=color:#61676ccc>,
</span><span>            )</span><span style=color:#61676ccc>,
</span><span>        )</span><span style=color:#61676ccc>,
</span><span>    ))</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> gpu_late_occlusion_culling_bind_group_layout_entries </span><span style=color:#ed9366>=
</span><span>    </span><span style=color:#f07171>gpu_occlusion_culling_bind_group_layout_entries</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend_with_indices</span><span>(((
</span><span>        </span><span style=color:#ff8f40>12</span><span style=color:#61676ccc>,
</span><span>        storage_buffer_read_only</span><span style=color:#ed9366>::</span><span>&LTLatePreprocessWorkItemIndirectParameters>(
</span><span>            </span><span style=color:#abb0b6;font-style:italic>/*has_dynamic_offset=*/ </span><span style=color:#ff8f40>false</span><span style=color:#61676ccc>,
</span><span>        )</span><span style=color:#61676ccc>,
</span><span>    )</span><span style=color:#61676ccc>,</span><span>))</span><span style=color:#61676ccc>;
</span></code></pre><p>关键改动是从<code>gpu_occlusion_culling_bind_group_layout_entries()</code>函数中移除了绑定点12的定义，然后在两个不同的布局中分别添加：早期阶段用可读写存储缓冲区，后期阶段用只读存储缓冲区。<h3 id=wgslzhao-se-qi-tong-bu-geng-xin>WGSL着色器同步更新</h3><p>相应地，WGSL着色器也需要更新以反映这种分离：<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>#ifdef EARLY_PHASE
</span><span>@group(0) @binding(11) var&LTstorage, read_write> late_preprocess_work_items:
</span><span>    array&LTPreprocessWorkItem>;
</span><span>
</span><span>@group(0) @binding(12) var&LTstorage, read_write> late_preprocess_work_item_indirect_parameters:
</span><span>    array&LTLatePreprocessWorkItemIndirectParameters>;
</span><span>#endif  // EARLY_PHASE
</span><span>
</span><span>#ifdef LATE_PHASE
</span><span>@group(0) @binding(12) var&LTstorage, read> late_preprocess_work_item_indirect_parameters:
</span><span>    array&LTLatePreprocessWorkItemIndirectParameters>;
</span><span>#endif  // LATE_PHASE
</span></code></pre><p>这样，在早期阶段使用<code>read_write</code>访问模式，在后期阶段使用<code>read</code>访问模式，避免了wgpu验证错误。<h3 id=ji-shu-dong-cha-gpuqu-dong-de-zhe-dang-ti-chu>技术洞察：GPU驱动的遮挡剔除</h3><p>这个PR涉及的遮挡剔除是Bevy中GPU驱动的剔除系统的一部分。该系统分为两个阶段：<ol><li><strong>早期阶段</strong>：执行初步的剔除计算，可能需要写入间接参数<li><strong>后期阶段</strong>：使用早期阶段计算的结果执行进一步处理，只需要读取这些参数</ol><p>这种设计允许GPU高效地执行复杂的场景剔除，减少CPU-GPU之间的数据传输。但是，它也需要仔细管理GPU资源的状态和访问权限。<h3 id=ying-xiang-yu-jiao-xun>影响与教训</h3><p>这个修复解决了<code>occlusion_culling</code>示例的崩溃问题，恢复了遮挡剔除功能的正常工作。从工程角度看，这个PR提醒我们：<ol><li><strong>WebGPU访问模式约束</strong>：在多个渲染阶段使用同一资源时，必须确保访问模式兼容<li><strong>绑定组布局分离</strong>：当不同阶段需要不同访问权限时，应该使用不同的绑定组布局<li><strong>调试难度</strong>：作者提到“finding this was very difficult lol“，这反映了GPU编程调试的挑战性，尤其是涉及底层API验证错误时</ol><h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[GPU Preprocess Pipeline] --> B{Early Phase}
</span><span>    A --> C{Late Phase}
</span><span>    
</span><span>    B --> D[Binding 11: read_write&LTbr/>PreprocessWorkItem]
</span><span>    B --> E[Binding 12: read_write&LTbr/>LatePreprocessWorkItemIndirectParameters]
</span><span>    
</span><span>    C --> F[Binding 12: read_only&LTbr/>LatePreprocessWorkItemIndirectParameters]
</span><span>    
</span><span>    G[Before Fix] --> H[Single Binding 12: read_write]
</span><span>    H --> I[wgpu Validation Error]
</span><span>    
</span><span>    J[After Fix] --> K[Early Phase Binding 12: read_write]
</span><span>    J --> L[Late Phase Binding 12: read_only]
</span><span>    K --> M[No Validation Error]
</span><span>    L --> M
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=1-crates-bevy-pbr-src-render-gpu-preprocess-rs-17-10>1. <code>crates/bevy_pbr/src/render/gpu_preprocess.rs</code> (+17/-10)</h3><p>这个文件负责创建GPU预处理管线的绑定组布局。主要改动是分离了早期阶段和后期阶段的绑定组布局。<p><strong>关键改动：</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 之前：早期和后期阶段共享同一个绑定组布局
</span><span style=color:#fa6e32>let</span><span> gpu_early_occlusion_culling_bind_group_layout_entries </span><span style=color:#ed9366>=
</span><span>    </span><span style=color:#f07171>gpu_occlusion_culling_bind_group_layout_entries</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend_with_indices</span><span>(((
</span><span>        </span><span style=color:#ff8f40>11</span><span style=color:#61676ccc>,
</span><span>        storage_buffer</span><span style=color:#ed9366>::</span><span>&LTPreprocessWorkItem>(</span><span style=color:#abb0b6;font-style:italic>/*has_dynamic_offset=*/ </span><span style=color:#ff8f40>false</span><span>)</span><span style=color:#61676ccc>,
</span><span>    )</span><span style=color:#61676ccc>,</span><span>))</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> gpu_late_occlusion_culling_bind_group_layout_entries </span><span style=color:#ed9366>=
</span><span>    </span><span style=color:#f07171>gpu_occlusion_culling_bind_group_layout_entries</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 之后：早期阶段使用可读写绑定，后期阶段使用只读绑定
</span><span style=color:#fa6e32>let</span><span> gpu_early_occlusion_culling_bind_group_layout_entries </span><span style=color:#ed9366>=
</span><span>    </span><span style=color:#f07171>gpu_occlusion_culling_bind_group_layout_entries</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend_with_indices</span><span>((
</span><span>        (
</span><span>            </span><span style=color:#ff8f40>11</span><span style=color:#61676ccc>,
</span><span>            storage_buffer</span><span style=color:#ed9366>::</span><span>&LTPreprocessWorkItem>(</span><span style=color:#abb0b6;font-style:italic>/*has_dynamic_offset=*/ </span><span style=color:#ff8f40>false</span><span>)</span><span style=color:#61676ccc>,
</span><span>        )</span><span style=color:#61676ccc>,
</span><span>        (
</span><span>            </span><span style=color:#ff8f40>12</span><span style=color:#61676ccc>,
</span><span>            storage_buffer</span><span style=color:#ed9366>::</span><span>&LTLatePreprocessWorkItemIndirectParameters>(
</span><span>                </span><span style=color:#abb0b6;font-style:italic>/*has_dynamic_offset=*/ </span><span style=color:#ff8f40>false</span><span style=color:#61676ccc>,
</span><span>            )</span><span style=color:#61676ccc>,
</span><span>        )</span><span style=color:#61676ccc>,
</span><span>    ))</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> gpu_late_occlusion_culling_bind_group_layout_entries </span><span style=color:#ed9366>=
</span><span>    </span><span style=color:#f07171>gpu_occlusion_culling_bind_group_layout_entries</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend_with_indices</span><span>(((
</span><span>        </span><span style=color:#ff8f40>12</span><span style=color:#61676ccc>,
</span><span>        storage_buffer_read_only</span><span style=color:#ed9366>::</span><span>&LTLatePreprocessWorkItemIndirectParameters>(
</span><span>            </span><span style=color:#abb0b6;font-style:italic>/*has_dynamic_offset=*/ </span><span style=color:#ff8f40>false</span><span style=color:#61676ccc>,
</span><span>        )</span><span style=color:#61676ccc>,
</span><span>    )</span><span style=color:#61676ccc>,</span><span>))</span><span style=color:#61676ccc>;
</span></code></pre><p>同时从<code>gpu_occlusion_culling_bind_group_layout_entries()</code>函数中移除了绑定点12的定义：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 移除这部分代码：
</span><span>(
</span><span>    </span><span style=color:#ff8f40>12</span><span style=color:#61676ccc>,
</span><span>    storage_buffer</span><span style=color:#ed9366>::</span><span>&LTLatePreprocessWorkItemIndirectParameters>(
</span><span>        </span><span style=color:#abb0b6;font-style:italic>/*has_dynamic_offset=*/ </span><span style=color:#ff8f40>false</span><span style=color:#61676ccc>,
</span><span>    )</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>,
</span></code></pre><h3 id=2-crates-bevy-pbr-src-render-mesh-preprocess-wgsl-6-1>2. <code>crates/bevy_pbr/src/render/mesh_preprocess.wgsl</code> (+6/-1)</h3><p>WGSL着色器文件，更新了绑定声明以匹配新的绑定组布局。<p><strong>关键改动：</strong><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// 之前：只在早期阶段定义绑定
</span><span>#ifdef EARLY_PHASE
</span><span>@group(0) @binding(11) var&LTstorage, read_write> late_preprocess_work_items:
</span><span>    array&LTPreprocessWorkItem>;
</span><span>
</span><span>@group(0) @binding(12) var&LTstorage, read_write> late_preprocess_work_item_indirect_parameters:
</span><span>    array&LTLatePreprocessWorkItemIndirectParameters>;
</span><span>#endif  // EARLY_PHASE
</span><span>
</span><span>// 之后：早期阶段和后期阶段分别定义绑定
</span><span>#ifdef EARLY_PHASE
</span><span>@group(0) @binding(11) var&LTstorage, read_write> late_preprocess_work_items:
</span><span>    array&LTPreprocessWorkItem>;
</span><span>
</span><span>@group(0) @binding(12) var&LTstorage, read_write> late_preprocess_work_item_indirect_parameters:
</span><span>    array&LTLatePreprocessWorkItemIndirectParameters>;
</span><span>#endif  // EARLY_PHASE
</span><span>
</span><span>#ifdef LATE_PHASE
</span><span>@group(0) @binding(12) var&LTstorage, read> late_preprocess_work_item_indirect_parameters:
</span><span>    array&LTLatePreprocessWorkItemIndirectParameters>;
</span><span>#endif  // LATE_PHASE
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><strong>WebGPU Specification</strong> - 了解WGSL绑定和访问模式的官方规范<li><strong>Bevy Rendering Architecture</strong> - Bevy引擎的渲染架构文档<li><strong>GPU-Driven Rendering Techniques</strong> - GPU驱动渲染和剔除技术的现代方法<li><strong>wgpu Validation Errors</strong> - 理解wgpu验证错误和调试方法</ol><h1 id=full-code-diff>Full Code Diff</h1><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_pbr/src/render/gpu_preprocess.rs b/crates/bevy_pbr/src/render/gpu_preprocess.rs
</span><span>index 6260d43694faf..60a0f014f79b6 100644
</span><span style=color:#c594c5>--- a/crates/bevy_pbr/src/render/gpu_preprocess.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_pbr/src/render/gpu_preprocess.rs
</span><span style=color:#c594c5>@@ -1302,12 +1302,25 @@ </span><span style=color:#399ee6>impl FromWorld for PreprocessPipelines {
</span><span>         let direct_bind_group_layout_entries = preprocess_direct_bind_group_layout_entries();
</span><span>         let gpu_frustum_culling_bind_group_layout_entries = gpu_culling_bind_group_layout_entries();
</span><span>         let gpu_early_occlusion_culling_bind_group_layout_entries =
</span><span style=color:#86b300>+            gpu_occlusion_culling_bind_group_layout_entries().extend_with_indices((
</span><span style=color:#86b300>+                (
</span><span style=color:#86b300>+                    11,
</span><span style=color:#86b300>+                    storage_buffer::&LTPreprocessWorkItem>(/*has_dynamic_offset=*/ false),
</span><span style=color:#86b300>+                ),
</span><span style=color:#86b300>+                (
</span><span style=color:#86b300>+                    12,
</span><span style=color:#86b300>+                    storage_buffer::&LTLatePreprocessWorkItemIndirectParameters>(
</span><span style=color:#86b300>+                        /*has_dynamic_offset=*/ false,
</span><span style=color:#86b300>+                    ),
</span><span style=color:#86b300>+                ),
</span><span style=color:#86b300>+            ));
</span><span style=color:#86b300>+        let gpu_late_occlusion_culling_bind_group_layout_entries =
</span><span>             gpu_occlusion_culling_bind_group_layout_entries().extend_with_indices(((
</span><span style=color:#f07171>-                11,
</span><span style=color:#f07171>-                storage_buffer::&LTPreprocessWorkItem>(/*has_dynamic_offset=*/ false),
</span><span style=color:#86b300>+                12,
</span><span style=color:#86b300>+                storage_buffer_read_only::&LTLatePreprocessWorkItemIndirectParameters>(
</span><span style=color:#86b300>+                    /*has_dynamic_offset=*/ false,
</span><span style=color:#86b300>+                ),
</span><span>             ),));
</span><span style=color:#f07171>-        let gpu_late_occlusion_culling_bind_group_layout_entries =
</span><span style=color:#f07171>-            gpu_occlusion_culling_bind_group_layout_entries();
</span><span> 
</span><span>         let reset_indirect_batch_sets_bind_group_layout_entries =
</span><span>             DynamicBindGroupLayoutEntries::sequential(
</span><span style=color:#c594c5>@@ -1495,12 +1508,6 @@ </span><span style=color:#399ee6>fn gpu_occlusion_culling_bind_group_layout_entries() -> DynamicBindGroupLayoutEn
</span><span>             10,
</span><span>             texture_2d(TextureSampleType::Float { filterable: true }),
</span><span>         ),
</span><span style=color:#f07171>-        (
</span><span style=color:#f07171>-            12,
</span><span style=color:#f07171>-            storage_buffer::&LTLatePreprocessWorkItemIndirectParameters>(
</span><span style=color:#f07171>-                /*has_dynamic_offset=*/ false,
</span><span style=color:#f07171>-            ),
</span><span style=color:#f07171>-        ),
</span><span>     ))
</span><span> }
</span><span> 
</span><span>diff --git a/crates/bevy_pbr/src/render/mesh_preprocess.wgsl b/crates/bevy_pbr/src/render/mesh_preprocess.wgsl
</span><span>index c7cc5deeca878..aec0226cf7bbf 100644
</span><span style=color:#c594c5>--- a/crates/bevy_pbr/src/render/mesh_preprocess.wgsl
</span><span style=color:#c594c5>+++ b/crates/bevy_pbr/src/render/mesh_preprocess.wgsl
</span><span style=color:#c594c5>@@ -112,10 +112,15 @@ </span><span style=color:#399ee6>struct Immediates {
</span><span> #ifdef EARLY_PHASE
</span><span> @group(0) @binding(11) var&LTstorage, read_write> late_preprocess_work_items:
</span><span>     array&LTPreprocessWorkItem>;
</span><span style=color:#f07171>-#endif  // EARLY_PHASE
</span><span> 
</span><span> @group(0) @binding(12) var&LTstorage, read_write> late_preprocess_work_item_indirect_parameters:
</span><span>     array&LTLatePreprocessWorkItemIndirectParameters>;
</span><span style=color:#86b300>+#endif  // EARLY_PHASE
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+#ifdef LATE_PHASE
</span><span style=color:#86b300>+@group(0) @binding(12) var&LTstorage, read> late_preprocess_work_item_indirect_parameters:
</span><span style=color:#86b300>+    array&LTLatePreprocessWorkItemIndirectParameters>;
</span><span style=color:#86b300>+#endif  // LATE_PHASE
</span><span> 
</span><span> var&LTimmediate> immediates: Immediates;
</span><span> #endif  // OCCLUSION_CULLING
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-01/pr_22699.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>