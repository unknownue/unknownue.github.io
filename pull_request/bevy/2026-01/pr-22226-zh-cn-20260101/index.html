<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22226 Optimize Visibility Systems
        
    </title><meta content="#22226 Optimize Visibility Systems" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-01/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-01-01</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2026-01/pr-22226-en-20260101>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Optimize Visibility Systems<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22226<li><strong>Author</strong>: aevyrie<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, C-Performance, S-Ready-For-Final-Review, P-Regression<li><strong>Created</strong>: 2025-12-22T02:04:27Z<li><strong>Merged</strong>: 2026-01-01T22:25:12Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=miao-shu-fan-yi>描述翻译</h2><p><strong>目标</strong><ul><li>让可见性系统运行得更快<li>在（GPU 受限的）6.7ms 帧中，渲染 Caldera Hotel 场景时，最高可节省 1.2ms 的 CPU 时间<li>修复 #22256</ul><p><strong>解决方案</strong><ul><li>将 <code>EntityHashSet</code> 替换为直接添加到实体的组件。这仍然允许对可见性进行正确的变更检测触发，但避免了哈希计算。同时这也实现了并行更新。</ul><p><strong>总结</strong><ul><li>这个 PR 发现了一个深层问题，揭示了 #22256<li>这个 PR 解决了自 0.17 版本发布以来引入的性能回归<li>更公平的比较不是与当前主分支（存在回归问题）比较，而是与 0.17 版本比较<li>与 0.17.3 相比，在 M4 Max 上运行 Caldera Hotel 场景时，<code>PostUpdate</code> 调度性能提升了 27%</ul><img alt=image height=251 src=https://github.com/user-attachments/assets/2d711e3c-b65e-4c3a-9d2a-a587f8f36aae width=558><p><strong>测试</strong><ul><li>大量立方体、大量狐狸、Caldera Hotel 场景<li>黄色是新代码，红色是旧代码<li>注意旧代码跟踪中的双峰分布，这是可重复出现的，似乎与 <code>EntityHashSet</code> 和 <code>EntityHashMap</code> 有关。值得进一步调查，因为之前也见过这种双峰行为，并归因于性能核心与能效核心，但已验证不是这个原因<li>总结：Caldera Hotel 场景不再表现出双峰性能分布，避免了运行非常缓慢的病理模式。粗略比较约 90% 分位的性能，优化后的代码大约快 1.2ms。这在设备已经达到 150fps（GPU 受限）的情况下特别显著，因为每帧只有 6.7ms 的预算<li>值得注意的是，可见性检查曾是大多数 Bevy 应用常见热路径中最后一个性能明显不佳的系统集，现在在帧分析中不再明显显示为慢速：</ul><img alt=image height=512 src=https://github.com/user-attachments/assets/5252ff0f-d9f3-49d1-a3ce-309bd84d5485 width=1738><p><strong>Caldera Hotel - 所有实体都在视图中</strong> 此测试中，我没有移动摄像机，所以所有实体始终在视图中<p><code>check_visibility</code> <img alt=image height=397 src=https://github.com/user-attachments/assets/c80c470a-1548-42d2-838c-4e74525a6cb8 width=1262><p><code>reset_view_visibility</code> <img alt=image height=407 src=https://github.com/user-attachments/assets/7b550823-f832-41f1-9e42-20cab342b0f2 width=1262><p><code>mark_newly_hidden_entities_invisible</code> 这比主分支现有代码的“快速模式“慢 23us，但比主分支的“慢速模式“快 180-250us。新代码更稳定，不会出现超慢模式</p><img alt=image height=418 src=https://github.com/user-attachments/assets/b7cbf57d-a221-468a-9af8-3381981874b2 width=1256><p><strong>Caldera Hotel - 没有实体在视图中</strong> 此测试中，我立即旋转摄像机，使酒店不在视图中<p><code>check_visibility</code> 基本持平。旧代码快 2us，但这可能在噪声范围内</p><img alt=image height=372 src=https://github.com/user-attachments/assets/2c795f72-ebea-4b35-ba19-a8eccd4c56fc width=1255><p><code>reset_view_visibility</code> 这是个大改进。主峰值现在快了约 30us，但主要改进是最坏情况，快了近 500us</p><img alt=image height=398 src=https://github.com/user-attachments/assets/f8a9d99f-a6e1-48db-8639-d52276dba9ab width=1252><p><code>mark_newly_hidden_entities_invisible</code> 与所有实体都在视图中的 Caldera 比较相同，比主分支的快速模式稍慢，但比主分支的慢速模式快得多</p><img alt=image height=400 src=https://github.com/user-attachments/assets/4564d94e-911a-4b3f-a584-c6e102ef2dd0 width=1248><h2 id=zhe-ge-pull-requestde-gu-shi>这个Pull Request的故事</h2><p>这个PR起源于对Bevy引擎中可见性系统性能回归的深度调查。在0.17版本之后，开发者发现可见性检查在一些场景中出现了显著性能下降，特别是在Caldera Hotel这样的复杂场景中，有时会浪费1.2ms的宝贵CPU时间，而GPU受限帧的预算只有6.7ms。<p>问题的核心在于<code>PreviousVisibleEntities</code>资源的设计。这个资源使用了<code>EntityHashSet</code>来存储前一帧可见的实体，然后在每帧开始时重置所有实体的<code>ViewVisibility</code>组件。可见性检查系统会在本帧中标记可见的实体，最后<code>mark_newly_hidden_entities_invisible</code>系统会遍历前帧可见但本帧不可见的实体，将它们的状态重置为隐藏。<p>这种设计存在几个关键问题。首先，哈希操作本身有开销，特别是在实体数量多的情况下。其次，更严重的是，这种设计导致了双峰性能分布——有时系统运行很快，有时却异常缓慢。作者发现这与<code>EntityHashSet</code>的内部行为有关，但这种不稳定性是不可接受的。<p>解决方案的关键洞察是：与其使用外部哈希集存储前帧可见实体，不如直接将状态信息编码到<code>ViewVisibility</code>组件中。新的设计将<code>ViewVisibility</code>从简单的<code>bool</code>包装器改为<code>u8</code>类型，利用位操作来存储当前和前一帧的可见状态：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>ViewVisibility</span><span>(
</span><span>    </span><span style=color:#abb0b6;font-style:italic>/// 位打包的布尔值，用于跟踪当前和之前的视图可见性状态
</span><span>    </span><span style=color:#fa6e32>u8</span><span>,
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><p>具体来说，最低有效位（bit 0）表示当前帧是否可见，第二位（bit 1）表示前一帧是否可见。这种设计有几个优势：避免了哈希操作，减少了内存分配，最重要的是支持了并行处理。<p>实现上，系统的工作流程重新设计为：<ol><li><strong>reset_view_visibility</strong>：并行遍历所有实体的<code>ViewVisibility</code>组件，将当前可见状态复制到前一帧位置，并清除当前状态<li><strong>check_visibility</strong>：并行执行可见性检查，通过新的<code>SetViewVisibility</code> trait的<code>set_visible()</code>方法标记可见实体<li><strong>mark_newly_hidden_entities_invisible</strong>：并行检查所有实体，将前一帧可见但当前帧不可见的实体标记为隐藏</ol><p><code>SetViewVisibility</code> trait的实现确保了变更检测只在必要时触发：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>impl</span><span><</span><span style=color:#fa6e32>'a</span><span>> SetViewVisibility </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>Mut</span><span><</span><span style=color:#fa6e32>'a</span><span>, ViewVisibility> {
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>inline</span><span>]
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>set_visible</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>) {
</span><span>        </span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_ref</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>() {
</span><span>            </span><span style=color:#abb0b6;font-style:italic>// 将第一位置为true
</span><span>            </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0 </span><span style=color:#ed9366>|= </span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre><p>光照系统也相应更新，移除了对<code>PreviousVisibleEntities</code>的依赖，直接使用新的API。这是一个关键的架构改进，因为光源（特别是投射阴影的光源）需要标记不在摄像机视图中但需要渲染的实体。<p>技术层面上，这个改变解决了几个深层问题。首先，它消除了<code>EntityHashSet</code>带来的哈希开销和内存碎片。其次，并行处理现在成为可能，因为每个实体的状态更新是独立的。最后，通过将状态内化到组件中，系统更容易理解和维护。<p>性能改进是显著的。在Caldera Hotel场景中，<code>PostUpdate</code>调度相对于0.17.3版本提升了27%。更令人印象深刻的是，双峰性能分布完全消失，系统现在表现出稳定、可预测的性能。对于已经达到150fps（GPU受限）的场景，节省1.2ms意味着将近18%的CPU时间预算被释放出来。<p>这个PR也揭示了更广泛的设计原则：当需要跨帧跟踪状态时，将状态内化到组件中通常比使用外部数据结构更高效。这不仅适用于可见性系统，也适用于其他需要历史状态信息的场景。<p>从工程角度看，这个改变展示了几个重要技术：<ol><li>位打包用于存储紧凑的跨帧状态<li>trait设计用于封装状态更新逻辑<li>并行处理通过避免共享可变状态实现<li>变更检测的最小化触发</ol><p>值得注意的是，作者没有采用简单的暴力重置所有<code>ViewVisibility</code>为false的方法，而是实现了更精细的状态跟踪。这是因为实体可能被多个视图（摄像机、光源等）看到，所以知道实体对某个视图可见是容易的，但知道实体对所有视图都不可见是困难的。通过跟踪前一帧的可见性，系统可以精确地只更新那些真正改变状态的实体。<p>这个优化对整个渲染管线都有积极影响。可见性系统曾是Bevy应用中最后一个明显慢速的热路径组件，现在它不再在性能分析中突出显示。这为其他系统留下了更多的CPU时间预算，也使引擎在性能受限的设备上表现更好。<h2 id=ke-shi-hua-biao-shi>可视化表示</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[ViewVisibility组件&LTbr/>u8位打包状态] --> B[reset_view_visibility系统&LTbr/>并行更新状态]
</span><span>    B --> C[check_visibility系统&LTbr/>并行标记可见实体]
</span><span>    C --> D[mark_newly_hidden_entities_invisible系统&LTbr/>并行清理状态]
</span><span>    
</span><span>    E[摄像机] --> C
</span><span>    F[光源] --> C
</span><span>    G[SetViewVisibility trait] --> C
</span><span>    
</span><span>    C --> H[VisibleEntities&LTbr/>按可见性类分组]
</span><span>    
</span><span>    B --> I[性能改进&LTbr/>避免哈希操作]
</span><span>    C --> I
</span><span>    D --> I
</span><span>    
</span><span>    style A fill:#e1f5fe
</span><span>    style B</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-01/pr_22226.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>