<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22669 Workaround rustfmt panic on `quote!(Self(#var))` in Rust 1.93.0
        
    </title><meta content="#22669 Workaround rustfmt panic on `quote!(Self(#var))` in Rust 1.93.0" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-01/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-01-26</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-01/pr-22669-zh-cn-20260126>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Workaround rustfmt panic on <code>quote!(Self(#var))</code> in Rust 1.93.0<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22669<li><strong>Author</strong>: natepiano<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, D-Trivial, S-Ready-For-Final-Review, A-Reflection<li><strong>Created</strong>: 2026-01-23T16:59:46Z<li><strong>Merged</strong>: 2026-01-26T00:48:28Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p><strong>Objective</strong><p>Fix CI failure caused by a rustfmt regression in Rust 1.93.0.<p>The <code>cargo fmt --all -- --check</code> CI step panics when formatting <code>crates/bevy_reflect/derive/src/from_reflect.rs</code> due to the pattern <code>quote!(Self(#__this))</code>.<p>Upstream issue: https://github.com/rust-lang/rustfmt/issues/6779<p>Fixes #22704.<p><strong>Solution</strong><p>Pre-construct <code>Self</code> as a separate token stream before using it in the <code>quote!</code> macro:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let</span><span> self_ty </span><span style=color:#ed9366>= </span><span style=color:#f07171>quote!</span><span>(</span><span style=color:#fa6e32>Self</span><span>)</span><span style=color:#61676ccc>;
</span><span style=color:#f07171>quote!</span><span>(</span><span style=color:#ed9366>#</span><span style=color:#f07171>self_ty</span><span>(</span><span style=color:#ed9366>#</span><span>__this))  </span><span style=color:#abb0b6;font-style:italic>// instead of quote!(Self(#__this))
</span></code></pre><p>This produces identical output but avoids the rustfmt parser bug.<p><strong>Testing</strong><ul><li><code>cargo fmt --all</code> no longer panics<li><code>cargo build -p bevy_reflect_derive</code> succeeds<li><code>cargo nextest run -p bevy_reflect</code> passes all 212 tests</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The Bevy project’s continuous integration (CI) system encountered a failure when Rust 1.93.0 was released. The specific failure occurred during the <code>cargo fmt --all -- --check</code> step, which verifies that all code conforms to the project’s formatting standards. This step was panicking while processing the file <code>crates/bevy_reflect/derive/src/from_reflect.rs</code>. The root cause was identified as a regression in rustfmt, the Rust formatting tool, which had an issue parsing the specific pattern <code>quote!(Self(#__this))</code> in macro expansions.<p>The upstream rustfmt issue (#6779) documented this bug, which triggered a panic when encountering the <code>Self</code> keyword in certain contexts within <code>quote!</code> macros. This was a blocker for the Bevy project’s CI because it prevented successful formatting checks, which are essential for maintaining code consistency and catching formatting issues early.<p>The developer addressed this by implementing a straightforward workaround. Instead of using <code>quote!(Self(#__this))</code> directly, they pre-constructed the <code>Self</code> token as a separate variable:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let</span><span> self_ty </span><span style=color:#ed9366>= </span><span style=color:#f07171>quote!</span><span>(</span><span style=color:#fa6e32>Self</span><span>)</span><span style=color:#61676ccc>;
</span><span style=color:#f07171>quote!</span><span>(</span><span style=color:#ed9366>#</span><span style=color:#f07171>self_ty</span><span>(</span><span style=color:#ed9366>#</span><span>__this))
</span></code></pre><p>This approach yields identical token streams and generated code, but avoids the rustfmt parser bug. The workaround is explicitly marked with a TODO comment indicating it can be removed after Rust 1.94, when the rustfmt issue is expected to be fixed. This demonstrates good practice in temporary workarounds by including clear documentation about when they can be safely removed.<p>The fix was minimal and surgical, changing only the problematic pattern in two locations within the same function. The changes maintained backward compatibility and didn’t affect the generated code’s functionality—only how it was constructed at the macro expansion level. This is important because the <code>from_reflect</code> derive macro generates code for reflection capabilities in Bevy’s ECS (Entity Component System).<p>The testing approach was pragmatic: verifying that formatting no longer panics, that the macro still compiles correctly (<code>cargo build -p bevy_reflect_derive</code>), and that all existing reflection tests pass. This ensures the workaround doesn’t introduce regressions in functionality while solving the immediate CI problem.<p>This PR illustrates a common scenario in large Rust projects: dealing with toolchain regressions that affect build processes. The solution demonstrates understanding of Rust’s macro system, specifically how <code>quote!</code> macros work and how token streams can be manipulated to work around tooling issues without changing the generated code’s semantics.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Rust 1.93.0 Release] --> B[rustfmt regression]
</span><span>    B --> C[CI format check fails]
</span><span>    C --> D[Identify panic in from_reflect.rs]
</span><span>    D --> E[Implement workaround]
</span><span>    E --> F[Separate Self token]
</span><span>    F --> G[Macro generates same code]
</span><span>    G --> H[CI passes]
</span><span>    
</span><span>    I[Upstream rustfmt issue #6779] --> B
</span><span>    J[TODO: Remove after Rust 1.94] --> E
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>File: <code>crates/bevy_reflect/derive/src/from_reflect.rs</code></strong> (+7/-2)<p>This file contains the derive macro implementation for the <code>FromReflect</code> trait, which enables constructing types from their reflected representations. The changes modify how the macro generates code for struct initialization.<p><strong>Key Changes:</strong><ol><li>Added a workaround variable to avoid rustfmt panic<li>Updated two macro expansions to use the variable instead of direct <code>Self</code> token</ol><p><strong>Code Changes:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before (lines 146-170 approximately):
</span><span style=color:#abb0b6;font-style:italic>// The constructed "Self" ident
</span><span style=color:#fa6e32>let</span><span> __this </span><span style=color:#ed9366>= </span><span>Ident</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#86b300>"__this"</span><span style=color:#61676ccc>, </span><span>Span</span><span style=color:#ed9366>::</span><span>call_site())</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// The reflected type: either `Self` or a remote type
</span><span style=color:#fa6e32>let </span><span>(reflect_ty</span><span style=color:#61676ccc>,</span><span> constructor</span><span style=color:#61676ccc>,</span><span> retval) </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(remote_ty) </span><span style=color:#ed9366>=</span><span> remote_ty {
</span><span>    </span><span style=color:#fa6e32>let</span><span> constructor </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>match</span><span> remote_ty</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_expr_path</span><span>() {
</span><span>        </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(path) </span><span style=color:#ed9366>=></span><span> path</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#55b4d4;font-style:italic>None </span><span style=color:#ed9366>=> </span><span style=color:#fa6e32>return </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(Error</span><span style=color:#ed9366>::</span><span>new_spanned(remote_ty</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"expected type path"</span><span>))</span><span style=color:#61676ccc>,
</span><span>    }</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    (
</span><span>        </span><span style=color:#f07171>quote!</span><span>(</span><span style=color:#ed9366>#</span><span>remote_ty)</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#f07171>quote!</span><span>(</span><span style=color:#ed9366>#</span><span>constructor)</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#f07171>quote!</span><span>(</span><span style=color:#fa6e32>Self</span><span>(</span><span style=color:#ed9366>#</span><span>__this))</span><span style=color:#61676ccc>,  </span><span style=color:#abb0b6;font-style:italic>// Problematic line
</span><span>    )
</span><span>} </span><span style=color:#fa6e32>else </span><span>{
</span><span>    (</span><span style=color:#f07171>quote!</span><span>(</span><span style=color:#fa6e32>Self</span><span>)</span><span style=color:#61676ccc>, </span><span style=color:#f07171>quote!</span><span>(</span><span style=color:#fa6e32>Self</span><span>)</span><span style=color:#61676ccc>, </span><span style=color:#f07171>quote!</span><span>(</span><span style=color:#ed9366>#</span><span>__this))  </span><span style=color:#abb0b6;font-style:italic>// Another problematic line
</span><span>}</span><span style=color:#61676ccc>;
</span></code></pre><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#abb0b6;font-style:italic>// The constructed "Self" ident
</span><span style=color:#fa6e32>let</span><span> __this </span><span style=color:#ed9366>= </span><span>Ident</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#86b300>"__this"</span><span style=color:#61676ccc>, </span><span>Span</span><span style=color:#ed9366>::</span><span>call_site())</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Workaround for rustfmt issue: https://github.com/rust-lang/rustfmt/issues/6779
</span><span style=color:#abb0b6;font-style:italic>// `quote!(Self(#__this))` causes rustfmt to panic in Rust 1.93.0+
</span><span style=color:#abb0b6;font-style:italic>// TODO: not needed after Rust 1.94
</span><span style=color:#fa6e32>let</span><span> self_ty </span><span style=color:#ed9366>= </span><span style=color:#f07171>quote!</span><span>(</span><span style=color:#fa6e32>Self</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// The reflected type: either `Self` or a remote type
</span><span style=color:#fa6e32>let </span><span>(reflect_ty</span><span style=color:#61676ccc>,</span><span> constructor</span><span style=color:#61676ccc>,</span><span> retval) </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(remote_ty) </span><span style=color:#ed9366>=</span><span> remote_ty {
</span><span>    </span><span style=color:#fa6e32>let</span><span> constructor </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>match</span><span> remote_ty</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_expr_path</span><span>() {
</span><span>        </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(path) </span><span style=color:#ed9366>=></span><span> path</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#55b4d4;font-style:italic>None </span><span style=color:#ed9366>=> </span><span style=color:#fa6e32>return </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(Error</span><span style=color:#ed9366>::</span><span>new_spanned(remote_ty</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"expected type path"</span><span>))</span><span style=color:#61676ccc>,
</span><span>    }</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    (
</span><span>        </span><span style=color:#f07171>quote!</span><span>(</span><span style=color:#ed9366>#</span><span>remote_ty)</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#f07171>quote!</span><span>(</span><span style=color:#ed9366>#</span><span>constructor)</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#f07171>quote!</span><span>(</span><span style=color:#ed9366>#</span><span style=color:#f07171>self_ty</span><span>(</span><span style=color:#ed9366>#</span><span>__this))</span><span style=color:#61676ccc>,  </span><span style=color:#abb0b6;font-style:italic>// Fixed: use variable instead of direct Self
</span><span>    )
</span><span>} </span><span style=color:#fa6e32>else </span><span>{
</span><span>    (</span><span style=color:#f07171>quote!</span><span>(</span><span style=color:#ed9366>#</span><span>self_ty)</span><span style=color:#61676ccc>, </span><span style=color:#f07171>quote!</span><span>(</span><span style=color:#ed9366>#</span><span>self_ty)</span><span style=color:#61676ccc>, </span><span style=color:#f07171>quote!</span><span>(</span><span style=color:#ed9366>#</span><span>__this))  </span><span style=color:#abb0b6;font-style:italic>// Fixed: use variable
</span><span>}</span><span style=color:#61676ccc>;
</span></code></pre><p>The changes are minimal and focused:<ol><li>Line 149-152: Added <code>self_ty</code> variable holding <code>quote!(Self)</code><li>Line 165: Changed <code>quote!(Self(#__this))</code> to <code>quote!(#self_ty(#__this))</code><li>Line 168: Changed <code>quote!(Self)</code> to <code>quote!(#self_ty)</code></ol><p>These modifications ensure the macro generates identical token streams while avoiding the rustfmt parser bug.<h2 id=further-reading>Further Reading</h2><ol><li><strong>Rust <code>quote!</code> Macro</strong>: The <a rel="noopener nofollow noreferrer" href=https://docs.rs/quote/latest/quote/ target=_blank>quote crate documentation</a> provides details on procedural macro quoting in Rust<li><strong>rustfmt Issues</strong>: The <a rel="noopener nofollow noreferrer" href=https://github.com/rust-lang/rustfmt/issues target=_blank>rustfmt issue tracker</a> for tracking formatting tool bugs and regressions<li><strong>Bevy Reflection System</strong>: <a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/tree/main/crates/bevy_reflect target=_blank>Bevy’s reflection documentation</a> explains how reflection works in the ECS<li><strong>Procedural Macros</strong>: The <a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/book/ch19-06-macros.html target=_blank>Rust Book chapter on macros</a> covers both declarative and procedural macros<li><strong>CI/CD with Rust</strong>: <a rel="noopener nofollow noreferrer" href=https://github.com/actions-rs target=_blank>GitHub Actions for Rust</a> provides tools and examples for Rust CI workflows</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-01/pr_22669.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>