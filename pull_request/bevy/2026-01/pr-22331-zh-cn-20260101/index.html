<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22331 Remove the need to import `SpawnRelated` to use `related!` macro
        
    </title><meta content="#22331 Remove the need to import `SpawnRelated` to use `related!` macro" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-01/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-01-01</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2026-01/pr-22331-en-20260101>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Remove the need to import <code>SpawnRelated</code> to use <code>related!</code> macro<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22331<li><strong>Author</strong>: ItsDoot<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: D-Trivial, A-ECS, C-Usability, S-Ready-For-Final-Review, D-Domain-Agnostic<li><strong>Created</strong>: 2026-01-01T04:57:39Z<li><strong>Merged</strong>: 2026-01-01T05:55:50Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h3 id=mu-biao>目标</h3><p>目前，为了使用 <code>related!</code> 宏，你必须额外导入 <code>SpawnRelated</code>。我们应该能够避免这一点。<h3 id=jie-jue-fang-an>解决方案</h3><p>在宏展开中添加了一个 <code>as SpawnRelated</code> 类型转换。<h3 id=ce-shi>测试</h3><p>从宏的文档测试中移除了导入语句，以证明其有效。<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>这个PR解决了一个关于Bevy ECS API易用性的小问题。核心问题是，使用<code>related!</code>这个便捷宏时，开发者需要记住并手动导入一个特定的trait——<code>SpawnRelated</code>。这是一个不必要的摩擦点，增加了认知负担并可能导致编译错误，尤其是在新手学习API时。<p>问题的根源在于Rust的宏展开和trait解析机制。<code>related!</code>宏在内部依赖于<code>SpawnRelated</code> trait提供的<code>.spawn()</code>方法。在宏展开后的代码中，如果直接调用<code><$relationship_target>::spawn(...)</code>，Rust编译器需要在该作用域内找到<code>SpawnRelated</code> trait的实现。如果用户没有导入该trait，编译器就无法解析这个调用，导致错误。<p>开发者采取的解决方案直接而有效。他没有修改trait定义或添加新的宏，而是修改了宏本身的展开方式。关键在于将宏内部的调用从依赖trait导入的简写形式，改为使用<strong>完全限定路径</strong>（Fully Qualified Path）。具体做法是在宏展开的代码中，显式地将类型<code>$relationship_target</code>转换为<code>$crate::spawn::SpawnRelated</code>，然后调用其<code>spawn</code>方法。这样，无论用户是否在代码顶部导入了<code>SpawnRelated</code>，宏展开后的代码都能明确无误地指向正确的trait实现，因为它使用了从crate根目录开始的绝对路径。<p>这个改动的技术细节很清晰。原来的宏展开生成类似<code>Type::spawn(...)</code>的代码，它依赖于<code>SpawnRelated</code>在作用域内。修改后，它生成<code>&LTType as bevy_ecs::spawn::SpawnRelated>::spawn(...)</code>。<code>$crate</code>宏变量在展开时会被替换为当前crate的根路径（这里是<code>bevy_ecs</code>），确保了路径的绝对正确性。这是一个Rust宏编程中的标准技巧，用于避免命名空间污染和导入依赖。<p>为了验证解决方案，作者同步更新了宏的文档测试（doctest）。他移除了测试中原本存在的<code>use bevy_ecs::spawn::{Spawn, SpawnRelated};</code>导入语句。如果这个测试通过了，就铁证如山地证明了用户不再需要手动导入<code>SpawnRelated</code>来使用<code>related!</code>宏。这不仅是功能验证，也直接更新了面向用户的文档示例，起到了很好的示范作用。<p>从工程角度看，这个改动虽小，但体现了良好的API设计原则：<strong>便利性不应以额外的认知负担为代价</strong>。它移除了一个“陷阱”，让API更加自包含和友好。这种改进是向后兼容的——现有导入了<code>SpawnRelated</code>的代码完全不受影响，编译和行为照旧。同时，它也没有引入任何性能开销，因为改动仅发生在编译时的宏展开阶段，运行时的代码逻辑没有任何变化。<p>总的来说，这是一个典型的“用户体验”优化。它通过一个精妙但简单的技术调整——在宏内部使用完全限定路径——解决了API使用中的一个不便之处，使Bevy的ECS API更加整洁和易用。<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[用户代码调用 `related!` 宏] --> B[宏展开]
</span><span>    B --> C{展开后的代码形式}
</span><span>    
</span><span>    C -- 修改前 --> D[依赖导入: Type::spawn(...)]
</span><span>    D --> E[要求用户导入 SpawnRelated Trait]
</span><span>    E --> F[可能导致编译错误]
</span><span>
</span><span>    C -- 修改后 --> G[完全限定路径: &LTType as bevy_ecs::spawn::SpawnRelated>::spawn(...)]
</span><span>    G --> H[无需用户导入 Trait]
</span><span>    H --> I[编译成功，API更易用]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>crates/bevy_ecs/src/spawn.rs</strong> (+1, -2)<p>这个文件包含了<code>SpawnRelated</code> trait的定义、<code>related!</code>宏的实现以及相关的文档测试。本次PR的改动全部集中于此。<ol><li><p><strong>改动说明与原因</strong>:</p> <ul><li>第一处改动移除了宏文档测试中对<code>SpawnRelated</code>（和<code>Spawn</code>）的手动导入。这用于验证和演示宏修改后的效果——不再需要导入。<li>第二处是核心改动，修改了<code>related!</code>宏的实现，在展开时使用完全限定路径(<code>as $crate::spawn::SpawnRelated</code>)来调用<code>spawn</code>方法，从而消除了用户手动导入trait的必要性。</ul><li><p><strong>代码片段</strong>:</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 文件: crates/bevy_ecs/src/spawn.rs
</span><span style=color:#abb0b6;font-style:italic>// 修改前 (文档测试部分):
</span><span style=color:#abb0b6;font-style:italic>/// # use bevy_ecs::name::Name;
</span><span style=color:#abb0b6;font-style:italic>/// # use bevy_ecs::world::World;
</span><span style=color:#abb0b6;font-style:italic>/// # use bevy_ecs::related;
</span><span style=color:#abb0b6;font-style:italic>/// # use bevy_ecs::spawn::{Spawn, SpawnRelated}; // &LT-- 这一行被删除
</span><span style=color:#abb0b6;font-style:italic>/// let mut world = World::new();
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 修改后 (文档测试部分):
</span><span style=color:#abb0b6;font-style:italic>/// # use bevy_ecs::name::Name;
</span><span style=color:#abb0b6;font-style:italic>/// # use bevy_ecs::world::World;
</span><span style=color:#abb0b6;font-style:italic>/// # use bevy_ecs::related;
</span><span style=color:#abb0b6;font-style:italic>/// // 不再需要导入 SpawnRelated
</span><span style=color:#abb0b6;font-style:italic>/// let mut world = World::new();
</span></code></pre> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 文件: crates/bevy_ecs/src/spawn.rs
</span><span style=color:#abb0b6;font-style:italic>// 修改前 (宏定义部分):
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>macro_export</span><span>]
</span><span style=color:#f07171>macro_rules! </span><span style=color:#399ee6>related </span><span>{
</span><span>    (</span><span style=color:#ff8f40>$relationship_target</span><span style=color:#61676ccc>:</span><span style=color:#fa6e32>ty</span><span> [</span><span style=color:#ed9366>$</span><span>(</span><span style=color:#ff8f40>$child</span><span style=color:#61676ccc>:</span><span style=color:#fa6e32>expr</span><span>),</span><span style=color:#ed9366>*$</span><span>(,)?]) </span><span style=color:#ed9366>=> </span><span>{
</span><span>       </span><span style=color:#ed9366><</span><span>$relationship_target</span><span style=color:#ed9366>>::</span><span>spawn($crate</span><span style=color:#ed9366>::</span><span>recursive_spawn</span><span style=color:#ed9366>!</span><span>(</span><span style=color:#ed9366>$</span><span>($child)</span><span style=color:#61676ccc>,</span><span style=color:#ed9366>*</span><span>)) </span><span style=color:#abb0b6;font-style:italic>// &LT-- 依赖 Trait 导入
</span><span>    }</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 修改后 (宏定义部分):
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>macro_export</span><span>]
</span><span style=color:#f07171>macro_rules! </span><span style=color:#399ee6>related </span><span>{
</span><span>    (</span><span style=color:#ff8f40>$relationship_target</span><span style=color:#61676ccc>:</span><span style=color:#fa6e32>ty</span><span> [</span><span style=color:#ed9366>$</span><span>(</span><span style=color:#ff8f40>$child</span><span style=color:#61676ccc>:</span><span style=color:#fa6e32>expr</span><span>),</span><span style=color:#ed9366>*$</span><span>(,)?]) </span><span style=color:#ed9366>=> </span><span>{
</span><span>       </span><span style=color:#ed9366><</span><span>$relationship_target </span><span style=color:#ed9366>as </span><span>$crate</span><span style=color:#ed9366>::</span><span>spawn</span><span style=color:#ed9366>::</span><span>SpawnRelated</span><span style=color:#ed9366>>::</span><span>spawn($crate</span><span style=color:#ed9366>::</span><span>recursive_spawn</span><span style=color:#ed9366>!</span><span>(</span><span style=color:#ed9366>$</span><span>($child)</span><span style=color:#61676ccc>,</span><span style=color:#ed9366>*</span><span>)) </span><span style=color:#abb0b6;font-style:italic>// &LT-- 使用完全限定路径
</span><span>    }</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><li><p><strong>与PR目标的关联</strong>: 这两处修改共同实现了PR的目标。宏定义的修改是根本原因，它确保了<code>related!</code>宏可以独立工作。文档测试的修改是结果验证和用户文档的更新，直观地展示了修改带来的好处。</p></ol><h2 id=further-reading>Further Reading</h2><ul><li><strong>Rust Reference: Paths and Qualifiers</strong>: 了解Rust中路径（Path）的规则，特别是完全限定路径（Fully Qualified Syntax）如 <code>&LTType as Trait>::method</code> 的工作原理，这是理解本PR技术方案的基础。<li><strong>Rust Book: Macros</strong>: 深入学习Rust宏的编写，包括<code>$crate</code>元变量的使用，这对于编写健壮、不依赖外部环境的声明宏至关重要。<li><strong>Bevy ECS Guide: Relationships</strong>: 了解Bevy中实体关系（Relationships）的设计以及<code>SpawnRelated</code> trait和<code>related!</code>宏在整个ECS架构中的角色，提供本次改进的上下文。</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-01/pr_22331.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>