<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22621 Assign indices to light probes in the clustered objects list, and refactor the clustering code.
        
    </title><meta content="#22621 Assign indices to light probes in the clustered objects list, and refactor the clustering code." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-01/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-01-22</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-01/pr-22621-zh-cn-20260122>中文</a></div></div><div class=pr-content><h1 id=title-assign-indices-to-light-probes-in-the-clustered-objects-list-and-refactor-the-clustering-code>Title: Assign indices to light probes in the clustered objects list, and refactor the clustering code.</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Assign indices to light probes in the clustered objects list, and refactor the clustering code.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22621<li><strong>Author</strong>: pcwalton<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, S-Ready-For-Final-Review<li><strong>Created</strong>: 2026-01-21T07:56:08Z<li><strong>Merged</strong>: 2026-01-22T17:58:24Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>At the moment, clustering is a three-step process:<ol><li><p><code>assign_objects_to_clusters</code> runs on all clusterable objects during the <code>PostUpdate</code> schedule, creating lists of all clusterable objects in each view.</p><li><p>During the extraction phase, <code>extract_clusters</code> runs on all views that had clusters created for them, linearizing the clusters into a list of <code>ExtractedClusterableObjectElement::ClusterHeader</code> commands followed by other <code>ExtractedClusterableObjectElement</code>s, one for each object in the cluster. Each <code>ExtractedClusterableObjectElement</code> specifies the render world entity for the clusterable object.</p><li><p>In the render world, <code>prepare_clusters</code> processes all <code>ExtractedClusterableObjectElement</code> commands to create the GPU buffers, looking up each clustered object in the <code>GlobalClusterableObjectMeta</code> table in order to translate from entity to index.</p></ol><p>Unfortunately, there are two main problems with this:<p>a. Light probes don’t have render world entities at all and are instead tracked in <code>RenderViewLightProbes</code> components in the render world. Thus step (2) silently fails for them.<p>b. The <code>GlobalClusterableObjectMeta</code> table only contains clustered lights and decals, so even if light probes had render-world entities, step (3) would still fail.<p>The end result is that the GPU ends up consulting bogus out-of-bounds indices that may or may not actually refer to the light probe when traversing clusters.<p>This PR fixes the issues:<ul><li><p>I extended <code>extract_clusters</code> to support light probes, by adding <code>ExtractedClusterableObjectElement::ReflectionProbe</code> and <code>ExtractedClusterableObjectElement::IrradianceVolume</code> variants. These variants reference the <em>main</em> world entities for light probes, since no render-world entities exist for them.</p><li><p>When processing the new <code>ExtractedClusterableObjectElement</code> commands, <code>prepare_clusters</code> uses the <code>RenderViewLightProbes</code> to find the index in the reflection probe or irradiance volume table as appropriate and supply it to the GPU. Note that this step might fail if a texture that the light probe needs hasn’t been loaded yet. In this case, an index of -1 is stored, and the shader skips it. This isn’t the optimum behavior; ideally we wouldn’t cluster such objects at all. However, it was a minimally-invasive change.</p><li><p>I renamed types that referenced clusterable objects to refer to clusterable <em>lights</em> specifically if the types only dealt with lights, to reduce confusion in the future.</p><li><p>The <code>VisibleClusterableObjects</code> type is currently overloaded to both serve as a component, in which case it contains <em>all</em> clusterable objects associated with a view, and to serve as a container for the objects associated with a cluster. Not only is this confusing, but it’s also wasteful, as there’s bookkeeping that the type does that’s not needed when it’s serving as a component. I split the type into the component <code>VisibleClusterableObjects</code> and the helper structure <code>ObjectsInCluster</code>, and encapsulated logic within each type in order to make <code>assign_objects_to_clusters</code> easier to understand.</p><li><p>The <code>gather_light_probes</code> system performed its own frustum culling on light probes separately from the frustum culling that <code>assign_objects_to_clusters</code> also does. This was wasteful and confusing, especially since the frustum culling algorithms differed between the two systems, so I simplified the logic so that <code>assign_objects_to_clusters</code> fills out a table for <code>gather_light_probes</code> to use.</p><li><p><code>compute_radiances</code> in <code>environment_map.wgsl</code> was broken, as it neglected to set <code>light_from_world</code> to the identity matrix when falling back to the view environment map when a reflection probe wasn’t found. This would cause specular to vanish in some cases (e.g. in the <code>reflection_probes</code> example). I fixed the problem.</p></ul><p>This commit is a prerequisite for #22610, as multiple light probes are too broken without it.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a critical bug in Bevy’s clustered forward rendering system where light probes were not being properly assigned indices in the clustered objects list. The issue stemmed from architectural mismatches between how lights and light probes are managed in the rendering pipeline.<p>The problem manifested in two specific ways. First, light probes don’t have render-world entities—they’re tracked in separate <code>RenderViewLightProbes</code> components instead. The existing <code>extract_clusters</code> system only handled entities that existed in both the main and render worlds, causing it to silently skip light probes. Second, even if light probes had render-world entities, the <code>GlobalClusterableObjectMeta</code> table only contained mappings for lights and decals, so the subsequent index lookup would fail.<p>The consequence was that shaders would access out-of-bounds memory when trying to use clustered light probes, leading to undefined behavior and rendering artifacts. This was particularly problematic for scenes with multiple light probes, making the feature essentially unusable.<p>The solution involved modifying the data flow through the clustering pipeline. Instead of forcing light probes into the entity-based paradigm used by lights, the implementation now handles them through dedicated data paths. In the extraction phase, <code>extract_clusters</code> was extended to emit new command variants (<code>ReflectionProbe</code> and <code>IrradianceVolume</code>) that reference main-world entities directly. During preparation, <code>prepare_clusters</code> now consults the appropriate <code>RenderViewLightProbes</code> component to map these main-world entities to their GPU buffer indices.<p>A key design decision was how to handle light probes whose textures haven’t finished loading. The simplest approach was to store an index of -1 (via <code>push_dummy_index()</code>) and let the shader skip them. This is suboptimal but minimally invasive; a better solution would avoid clustering unloaded probes entirely, but that would require more extensive changes to the clustering logic.<p>While fixing the core bug, the PR also included several refactoring improvements to make the codebase more maintainable. The <code>VisibleClusterableObjects</code> type was split into two distinct structures: <code>VisibleClusterableObjects</code> as a component storing all visible clusterable objects per view, and <code>ObjectsInCluster</code> as a helper for objects within individual clusters. This separation eliminated unnecessary bookkeeping and clarified responsibilities.<p>The PR also removed duplicate frustum culling logic. Previously, <code>gather_light_probes</code> performed its own culling separate from <code>assign_objects_to_clusters</code>, using different algorithms. Now, <code>assign_objects_to_clusters</code> populates a table that <code>gather_light_probes</code> consults, ensuring consistent culling and eliminating redundant work.<p>Finally, a bug was fixed in the environment map shader where the <code>light_from_world</code> matrix wasn’t properly set to identity when falling back to the view environment map, which caused specular reflections to disappear in certain cases.<p>These changes collectively fix the immediate bug while improving the codebase’s structure, setting the stage for further improvements to light probe clustering.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[assign_objects_to_clusters] --> B[VisibleClusterableObjects component]
</span><span>    A --> C[ObjectsInCluster per cluster]
</span><span>    B --> D[extract_clusters]
</span><span>    C --> D
</span><span>    D --> E[ExtractedClusterableObjectElement commands]
</span><span>    E --> F[prepare_clusters]
</span><span>    G[RenderViewLightProbes] --> F
</span><span>    F --> H[GPU buffers]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-light-src-cluster-assign-rs-278-295><code>crates/bevy_light/src/cluster/assign.rs</code> (+278/-295)</h3><p>This file contains the core clustering algorithm. The main changes involve refactoring to use the new <code>ObjectsInCluster</code> type and integrating light probe handling.<p>Key changes:<ul><li>Split <code>VisibleClusterableObjects</code> usage into separate component and per-cluster structures<li>Added proper type-based tracking for light probes in the visible objects list<li>Removed duplicate entity list management</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Using a single type for both purposes
</span><span style=color:#fa6e32>for</span><span> clusterable_objects </span><span style=color:#ed9366>in &</span><span style=color:#fa6e32>mut</span><span> clusters</span><span style=color:#ed9366>.</span><span>clusterable_objects {
</span><span>    clusterable_objects</span><span style=color:#ed9366>.</span><span>entities</span><span style=color:#ed9366>.</span><span style=color:#f07171>clear</span><span>()</span><span style=color:#61676ccc>;
</span><span>    clusterable_objects</span><span style=color:#ed9366>.</span><span>counts </span><span style=color:#ed9366>= </span><span style=color:#f07171>default</span><span>()</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Clear using dedicated method
</span><span style=color:#fa6e32>for</span><span> clusterable_objects </span><span style=color:#ed9366>in &</span><span style=color:#fa6e32>mut</span><span> clusters</span><span style=color:#ed9366>.</span><span>clusterable_objects {
</span><span>    clusterable_objects</span><span style=color:#ed9366>.</span><span style=color:#f07171>clear</span><span>()</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Before: Manual entity and count tracking
</span><span>clusters</span><span style=color:#ed9366>.</span><span>clusterable_objects[cluster_index]
</span><span>    </span><span style=color:#ed9366>.</span><span>entities
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>push</span><span>(clusterable_object</span><span style=color:#ed9366>.</span><span>entity)</span><span style=color:#61676ccc>;
</span><span>clusters</span><span style=color:#ed9366>.</span><span>clusterable_objects[cluster_index]
</span><span>    </span><span style=color:#ed9366>.</span><span>counts
</span><span>    </span><span style=color:#ed9366>.</span><span>spot_lights </span><span style=color:#ed9366>+= </span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Encapsulated in methods
</span><span>clusters</span><span style=color:#ed9366>.</span><span>clusterable_objects[cluster_index]
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>add_spot_light</span><span>(clusterable_object</span><span style=color:#ed9366>.</span><span>entity)</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-pbr-src-cluster-rs-199-50><code>crates/bevy_pbr/src/cluster.rs</code> (+199/-50)</h3><p>This file handles the extraction and preparation of clustered objects for GPU consumption. The changes add support for light probes through new command variants and index resolution.<p>Key changes:<ul><li>Added new <code>ExtractedClusterableObjectElement</code> variants for light probes<li>Modified <code>prepare_clusters</code> to resolve light probe indices from <code>RenderViewLightProbes</code><li>Renamed light-specific types to clarify their purpose (<code>GpuClusterableObject</code> → <code>GpuClusteredLight</code>)</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// New variants for light probes
</span><span style=color:#fa6e32>enum </span><span style=color:#399ee6>ExtractedClusterableObjectElement </span><span>{
</span><span>    ClusterHeader(ClusterableObjectCounts)</span><span style=color:#61676ccc>,
</span><span>    Light(Entity)</span><span style=color:#61676ccc>,                    </span><span style=color:#abb0b6;font-style:italic>// For point/spot lights
</span><span>    ReflectionProbe(MainEntity)</span><span style=color:#61676ccc>,      </span><span style=color:#abb0b6;font-style:italic>// New: for environment maps
</span><span>    IrradianceVolume(MainEntity)</span><span style=color:#61676ccc>,     </span><span style=color:#abb0b6;font-style:italic>// New: for irradiance volumes
</span><span>    Decal(Entity)</span><span style=color:#61676ccc>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Index resolution for light probes in prepare_clusters
</span><span>ExtractedClusterableObjectElement</span><span style=color:#ed9366>::</span><span>ReflectionProbe(main_entity) </span><span style=color:#ed9366>=> </span><span>{
</span><span>    </span><span style=color:#fa6e32>match</span><span> maybe_environment_maps</span><span style=color:#ed9366>.</span><span style=color:#f07171>and_then</span><span>(|</span><span style=color:#ff8f40>environment_maps</span><span>| {
</span><span>        environment_maps
</span><span>            </span><span style=color:#ed9366>.</span><span>main_entity_to_render_light_probe_index
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(main_entity)
</span><span>    }) {
</span><span>        </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(render_light_probe_index) </span><span style=color:#ed9366>=> </span><span>{
</span><span>            view_clusters_bindings</span><span style=color:#ed9366>.</span><span style=color:#f07171>push_index</span><span>(</span><span style=color:#ed9366>*</span><span>render_light_probe_index </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>usize</span><span>)</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>        </span><span style=color:#55b4d4;font-style:italic>None </span><span style=color:#ed9366>=> </span><span>{
</span><span>            view_clusters_bindings</span><span style=color:#ed9366>.</span><span style=color:#f07171>push_dummy_index</span><span>()</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre><h3 id=crates-bevy-pbr-src-light-probe-mod-rs-105-64><code>crates/bevy_pbr/src/light_probe/mod.rs</code> (+105/-64)</h3><p>This file manages light probe gathering and preparation. The changes remove duplicate frustum culling and integrate with the clustering system.<p>Key changes:<ul><li><code>gather_light_probes</code> now uses the visible light probes list from <code>assign_objects_to_clusters</code><li>Added entity-to-index mapping in <code>RenderViewLightProbes</code> for cluster index resolution<li>Removed standalone frustum culling logic</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Separate frustum culling in gather_light_probes
</span><span>view_reflection_probes</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend</span><span>(
</span><span>    reflection_probes
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>filter</span><span>(|</span><span style=color:#ff8f40>light_probe_info</span><span>| light_probe_info</span><span style=color:#ed9366>.</span><span style=color:#f07171>frustum_cull</span><span>(view_frustum))
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>cloned</span><span>()</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Use pre-culled list from VisibleClusterableObjects
</span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(visible_light_probes) </span><span style=color:#ed9366>=</span><span> visible_clusterable_objects
</span><span>    </span><span style=color:#ed9366>.</span><span>light_probes
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#ed9366>&</span><span>TypeId</span><span style=color:#ed9366>::</span><span>of</span><span style=color:#ed9366>::</span><span>&LTC>())
</span><span>{
</span><span>    </span><span style=color:#fa6e32>for </span><span style=color:#ed9366>&</span><span>main_entity </span><span style=color:#ed9366>in</span><span> visible_light_probes {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// Look up and process light probe
</span><span>    }
</span><span>}
</span></code></pre><h3 id=crates-bevy-light-src-cluster-mod-rs-98-12><code>crates/bevy_light/src/cluster/mod.rs</code> (+98/-12)</h3><p>This file defines the data structures for clustering. The changes split <code>VisibleClusterableObjects</code> and add the <code>ObjectsInCluster</code> helper.<p>Key changes:<ul><li>Added <code>ObjectsInCluster</code> struct for per-cluster object tracking<li>Refactored <code>VisibleClusterableObjects</code> to separate light types<li>Added type-safe methods for adding different object types</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// New structure for objects within a single cluster
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>ObjectsInCluster </span><span>{
</span><span>    clusterables</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Vec</span><span>&LTEntity>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>counts</span><span style=color:#61676ccc>:</span><span> ClusterableObjectCounts,
</span><span>}
</span><span>
</span><span style=color:#fa6e32>impl </span><span style=color:#399ee6>ObjectsInCluster </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>add_spot_light</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>entity</span><span style=color:#61676ccc>:</span><span> Entity) {
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>clusterables</span><span style=color:#ed9366>.</span><span style=color:#f07171>push</span><span>(entity)</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>counts</span><span style=color:#ed9366>.</span><span>spot_lights </span><span style=color:#ed9366>+= </span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... similar methods for other types
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Revised component for all visible clusterable objects in a view
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>VisibleClusterableObjects </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>point_and_spot_lights</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Vec</span><span>&LTEntity>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>light_probes</span><span style=color:#61676ccc>: </span><span>TypeIdMap<</span><span style=color:#55b4d4;font-style:italic>Vec</span><span>&LTEntity>>,
</span><span>}
</span></code></pre><h3 id=crates-bevy-pbr-src-render-light-rs-19-13><code>crates/bevy_pbr/src/render/light.rs</code> (+19/-13)</h3><p>This file prepares lights for rendering. The changes are minimal but important for consistency.<p>Key changes:<ul><li>Updated variable names from <code>global_light_meta</code> to <code>global_clusterable_object_meta</code> to reflect broader responsibility<li>Updated comments to acknowledge that clusterable objects include more than just lights</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Specifically about lights
</span><span>global_light_meta</span><span style=color:#ed9366>.</span><span>entity_to_index</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(entity</span><span style=color:#61676ccc>,</span><span> index)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: More general naming
</span><span>global_clusterable_object_meta</span><span style=color:#ed9366>.</span><span>entity_to_index</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(entity</span><span style=color:#61676ccc>,</span><span> index)</span><span style=color:#61676ccc>;
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><p><strong>Practical Clustered Shading</strong> (Persson et al.): The original paper describing the clustering algorithm used in Bevy. Available at: http://newq.net/dl/pub/s2015_practical.pdf</p><li><p><strong>Bevy Rendering Architecture</strong>: The Bevy engine’s documentation on its ECS-based rendering architecture provides context for understanding how extraction and preparation systems work.</p><li><p><strong>WebGPU Shader Language (WGSL)</strong>: Understanding WGSL is essential for following the shader changes in this PR, particularly the fixes in <code>environment_map.wgsl</code>.</p><li><p><strong>Spatial Data Structures for Real-Time Rendering</strong>: Resources on frustum culling, spatial partitioning, and clustering algorithms would help understand the optimization aspects of this PR.</p><li><p><strong>Bevy Light Probes Documentation</strong>: The Bevy book’s sections on environment maps and irradiance volumes explain the light probe system this PR fixes.</p></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-01/pr_22621.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>