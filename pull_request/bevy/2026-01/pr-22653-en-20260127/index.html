<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22653 Make safety comments on unsafe traits internal comments
        
    </title><meta content="#22653 Make safety comments on unsafe traits internal comments" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-01/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-01-27</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-01/pr-22653-zh-cn-20260127>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Make safety comments on unsafe traits internal comments<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22653<li><strong>Author</strong>: hymm<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-ECS, C-Code-Quality, S-Ready-For-Final-Review, X-Contentious<li><strong>Created</strong>: 2026-01-22T20:01:00Z<li><strong>Merged</strong>: 2026-01-27T06:44:28Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Safety comments on implementations of unsafe traits should not be part of the public docs as these are meant to bevy devs explain why implementing the trait is safe.</ul><h2 id=solution>Solution</h2><ul><li>Make them regular doc comments</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a documentation clarity issue in the Bevy codebase related to how safety comments are presented in public API documentation. The core problem was that safety justifications for implementing unsafe traits were appearing in the generated public documentation, which could confuse users who only need to understand the API’s behavior, not its internal safety guarantees.<p>The issue stems from a distinction in Rust documentation: <code>///</code> comments (doc comments) appear in the generated public documentation, while <code>//</code> comments (regular comments) do not. When implementing unsafe traits in Rust, developers must provide safety comments explaining why their implementation is sound. These comments are crucial for maintainers and contributors who need to verify the code’s safety, but they aren’t relevant to end users who just want to understand how to use the API.<p>The developer recognized that safety comments like <code>/// SAFETY: ...</code> were appearing in public documentation, creating noise and potentially confusing users. These comments are intended for developers working on the engine itself, not for consumers of the API. The solution was straightforward: convert all safety comments on unsafe trait implementations from doc comments (<code>///</code>) to regular comments (<code>//</code>).<p>The implementation involved a systematic search and replace across 11 files in the codebase. The changes were primarily concentrated in the ECS (Entity Component System) module, where many unsafe traits are implemented for query types. For example, in <code>crates/bevy_ecs/src/query/fetch.rs</code>, numerous <code>/// SAFETY:</code> comments were converted to <code>// SAFETY:</code>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#abb0b6;font-style:italic>/// SAFETY: `update_component_access` does nothing.
</span><span style=color:#abb0b6;font-style:italic>/// This is sound because `fetch` does not access components.
</span><span style=color:#fa6e32>unsafe impl </span><span>WorldQuery </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>Entity </span><span>{
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#abb0b6;font-style:italic>// SAFETY: `update_component_access` does nothing.
</span><span style=color:#abb0b6;font-style:italic>// This is sound because `fetch` does not access components.
</span><span style=color:#fa6e32>unsafe impl </span><span>WorldQuery </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>Entity </span><span>{
</span></code></pre><p>This change doesn’t affect the code’s functionality or safety - it only changes how the comments are processed by Rust’s documentation generator. The safety justifications remain in the source code for developers to review, but they no longer clutter the public API documentation.<p>The technical insight here is about balancing two needs: providing enough information for contributors to understand safety invariants, while keeping public documentation focused on API usage. Unsafe code in Rust requires careful justification, and those justifications should be preserved in the source code. However, they don’t belong in the public-facing documentation where they can distract from how to use the API correctly.<p>This PR faced some contention (as indicated by the “X-Contentious” label), likely because it touches many files and changes documentation conventions. However, the change is consistent with Rust community practices where safety comments are typically internal documentation rather than public API documentation.<p>The impact of this change is cleaner public documentation that focuses on what the API does rather than how it achieves safety. Users reading the documentation will see only the information relevant to using the API, while developers examining the source code can still access the safety justifications. This separation of concerns makes the codebase more maintainable and user-friendly.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    subgraph "Primary Change"
</span><span>        A[Safety Comments] -->|Before: Doc Comments| B[Public Documentation]
</span><span>        A -->|After: Regular Comments| C[Source Code Only]
</span><span>    end
</span><span>    
</span><span>    subgraph "Affected Components"
</span><span>        D[bevy_ecs Query System]
</span><span>        E[bevy_ecs Macros]
</span><span>        F[bevy_render]
</span><span>        G[bevy_ui]
</span><span>        H[bevy_asset]
</span><span>    end
</span><span>    
</span><span>    C --> D
</span><span>    C --> E
</span><span>    C --> F
</span><span>    C --> G
</span><span>    C --> H
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ecs-src-query-fetch-rs-98-98><code>crates/bevy_ecs/src/query/fetch.rs</code> (+98/-98)</h3><p>This file contains the core implementations of query-related traits. The changes convert safety comments from doc comments to regular comments for various <code>WorldQuery</code>, <code>QueryData</code>, and <code>ReadOnlyQueryData</code> implementations.<p><strong>Example change:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#abb0b6;font-style:italic>/// SAFETY: `update_component_access` does nothing.
</span><span style=color:#abb0b6;font-style:italic>/// This is sound because `fetch` does not access components.
</span><span style=color:#fa6e32>unsafe impl </span><span>WorldQuery </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>Entity </span><span>{
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#abb0b6;font-style:italic>// SAFETY: `update_component_access` does nothing.
</span><span style=color:#abb0b6;font-style:italic>// This is sound because `fetch` does not access components.
</span><span style=color:#fa6e32>unsafe impl </span><span>WorldQuery </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>Entity </span><span>{
</span></code></pre><p><strong>Why this matters:</strong> This file contains many unsafe trait implementations that power Bevy’s query system. The safety comments explain invariants that maintain memory safety, but these details aren’t needed by API consumers.<h3 id=crates-bevy-ecs-src-query-filter-rs-30-30><code>crates/bevy_ecs/src/query/filter.rs</code> (+30/-30)</h3><p>This file handles query filtering implementations. Similar changes were made to safety comments for filter-related traits.<p><strong>Example change:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#abb0b6;font-style:italic>/// SAFETY:
</span><span style=color:#abb0b6;font-style:italic>/// `update_component_access` does not add any accesses.
</span><span style=color:#abb0b6;font-style:italic>/// This is sound because [`QueryFilter::filter_fetch`] does not access any components.
</span><span style=color:#abb0b6;font-style:italic>/// `update_component_access` adds a `With` filter for `T`.
</span><span style=color:#abb0b6;font-style:italic>/// This is sound because `matches_component_set` returns whether the set contains the component.
</span><span style=color:#fa6e32>unsafe impl</span><span>&LTT</span><span style=color:#61676ccc>:</span><span> Component> WorldQuery </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>With</span><span>&LTT> {
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#abb0b6;font-style:italic>// SAFETY:
</span><span style=color:#abb0b6;font-style:italic>// `update_component_access` does not add any accesses.
</span><span style=color:#abb0b6;font-style:italic>// This is sound because [`QueryFilter::filter_fetch`] does not access any components.
</span><span style=color:#abb0b6;font-style:italic>// `update_component_access` adds a `With` filter for `T`.
</span><span style=color:#abb0b6;font-style:italic>// This is sound because `matches_component_set` returns whether the set contains the component.
</span><span style=color:#fa6e32>unsafe impl</span><span>&LTT</span><span style=color:#61676ccc>:</span><span> Component> WorldQuery </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>With</span><span>&LTT> {
</span></code></pre><p><strong>Why this matters:</strong> Filter implementations have complex safety requirements that are important for contributors to understand but not for users to see in documentation.<h3 id=crates-bevy-ecs-macros-src-query-data-rs-3-3><code>crates/bevy_ecs/macros/src/query_data.rs</code> (+3/-3)</h3><p>This file contains macro-generated code for query data. The changes ensure that safety comments in generated code also use regular comments.<p><strong>Example change:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#abb0b6;font-style:italic>/// SAFETY: we assert fields are readonly below
</span><span style=color:#fa6e32>unsafe impl </span><span>#</span><span style=color:#399ee6>user_impl_generics</span><span> #</span><span style=color:#399ee6>path</span><span>::</span><span style=color:#399ee6>query</span><span>::</span><span style=color:#399ee6>QueryData
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#abb0b6;font-style:italic>// SAFETY: we assert fields are readonly below
</span><span style=color:#399ee6>unsafe impl</span><span> #</span><span style=color:#399ee6>user_impl_generics</span><span> #</span><span style=color:#399ee6>path</span><span>::</span><span style=color:#399ee6>query</span><span>::</span><span style=color:#399ee6>QueryData
</span></code></pre><p><strong>Why this matters:</strong> Consistent comment style across both hand-written and generated code maintains codebase uniformity.<h3 id=crates-bevy-render-src-sync-world-rs-4-4><code>crates/bevy_render/src/sync_world.rs</code> (+4/-4)</h3><p>This file handles synchronization between render and main worlds. The changes apply the same pattern to render-specific query implementations.<p><strong>Example change:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#abb0b6;font-style:italic>/// SAFETY: defers completely to `&RenderEntity` implementation,
</span><span style=color:#abb0b6;font-style:italic>/// and then only modifies the output safely.
</span><span style=color:#fa6e32>unsafe impl </span><span>WorldQuery </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>RenderEntity </span><span>{
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#abb0b6;font-style:italic>// SAFETY: defers completely to `&RenderEntity` implementation,
</span><span style=color:#abb0b6;font-style:italic>// and then only modifies the output safely.
</span><span style=color:#fa6e32>unsafe impl </span><span>WorldQuery </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>RenderEntity </span><span>{
</span></code></pre><p><strong>Why this matters:</strong> Even in specialized systems like rendering, safety comments should remain internal documentation.<h3 id=crates-bevy-asset-src-asset-changed-rs-2-2><code>crates/bevy_asset/src/asset_changed.rs</code> (+2/-2)</h3><p>This file handles asset change tracking. The changes ensure consistency across different parts of the codebase.<p><strong>Example change:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#abb0b6;font-style:italic>/// SAFETY: `ROQueryFetch&LTSelf>` is the same as `QueryFetch&LTSelf>`
</span><span style=color:#fa6e32>unsafe impl</span><span>&LTA</span><span style=color:#61676ccc>:</span><span> AsAssetId> WorldQuery </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>AssetChanged</span><span>&LTA> {
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#abb0b6;font-style:italic>// SAFETY: `ROQueryFetch&LTSelf>` is the same as `QueryFetch&LTSelf>`
</span><span style=color:#fa6e32>unsafe impl</span><span>&LTA</span><span style=color:#61676ccc>:</span><span> AsAssetId> WorldQuery </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>AssetChanged</span><span>&LTA> {
</span></code></pre><p><strong>Why this matters:</strong> Maintaining consistency across all modules makes the codebase easier to understand and maintain.<h2 id=further-reading>Further Reading</h2><ol><li><p><strong>Rust Documentation Comments</strong>: <a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/book/ch14-02-publishing-to-crates-io.html#making-useful-documentation-comments target=_blank>The Rust Book’s chapter on documentation</a> explains the difference between <code>///</code>, <code>//!</code>, and <code>//</code> comments.</p><li><p><strong>Unsafe Rust</strong>: <a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/nomicon/ target=_blank>The Rustonomicon</a> provides in-depth information about unsafe Rust and the safety invariants that must be maintained.</p><li><p><strong>Bevy ECS</strong>: <a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/ecs-intro/ target=_blank>Bevy’s ECS documentation</a> explains the Entity Component System pattern and how queries work in Bevy.</p><li><p><strong>Rust API Guidelines</strong>: <a rel="noopener nofollow noreferrer" href=https://rust-lang.github.io/api-guidelines/ target=_blank>The Rust API Guidelines</a> include recommendations about documentation practices for public APIs.</p></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-01/pr_22653.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>