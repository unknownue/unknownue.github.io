<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22711 remove conditional that never runs
        
    </title><meta content="#22711 remove conditional that never runs" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-01/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-01-27</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2026-01/pr-22711-en-20260127>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=ji-ben-xin-xi>基本信息</h2><ul><li><strong>标题</strong>: remove conditional that never runs<li><strong>PR链接</strong>: https://github.com/bevyengine/bevy/pull/22711<li><strong>作者</strong>: atlv24<li><strong>状态</strong>: 已合并<li><strong>标签</strong>: A-Rendering, C-Code-Quality, S-Ready-For-Final-Review<li><strong>创建时间</strong>: 2026-01-26T01:38:55Z<li><strong>合并时间</strong>: 2026-01-27T07:55:25Z<li><strong>合并者</strong>: alice-i-cecile</ul><h2 id=miao-shu-fan-yi>描述翻译</h2><h1 id=mu-biao>目标</h1><ul><li>据我所知，这段代码从未运行过，而且似乎没有任何作用。自定义渲染阶段无法将自己添加到这个列表中，因此如果由于某种原因渲染阶段必须在这里，这对第三方用户来说就已经是损坏的。</ul><h2 id=jie-jue-fang-an>解决方案</h2><ul><li>移除并进行回归测试以确认</ul><h2 id=ce-shi>测试</h2><ul><li>我运行了bistro和其他几个示例，现在请渲染专家检查一下</ul><h2 id=zhe-ge-prde-gu-shi>这个PR的故事</h2><p>这个PR解决了一个看似微不足道但实际上是代码质量问题的bug：一段永远不会执行的冗余条件检查。在分析渲染管线的<code>prepare_core_3d_depth_textures</code>函数时，开发者发现了一段检查三个渲染阶段资源是否包含特定视图的条件代码。<p>问题的核心在于这段条件检查的逻辑是有缺陷的。在Bevy的架构中，<code>Opaque3d</code>、<code>AlphaMask3d</code>和<code>Transparent3d</code>这些渲染阶段是通过核心3D渲染图自动为所有3D视图添加的。这意味着对于一个有效的3D视图，这三个渲染阶段资源都必然包含对应的视图实体。因此，这个条件检查永远不会失败，代码也永远不会跳过循环。<p>更深入地看，这个条件检查不仅冗余，还可能造成混淆。如果有人想添加自定义的渲染阶段，他们无法通过常规方式将自己添加到这些核心的渲染阶段资源中。这意味着如果这个条件检查对于渲染深度纹理确实是必要的，那么第三方开发者根本无法使用这个功能。实际上，这种设计暴露了接口一致性问题。<p>开发者采用的解决方案很直接：删除这段永远不会执行的条件代码，并相应地调整函数参数。具体来说，他们：<ol><li>从函数参数中移除了三个不再需要的渲染阶段资源<li>从查询中移除了<code>ExtractedView</code>组件，因为它只在被删除的条件检查中使用<li>调整了循环结构，移除了条件检查和相关的continue语句</ol><p>这个修改体现了良好的代码维护实践。删除死代码有几个好处：减少代码复杂度、提高可读性、减少维护负担，并且让新开发者更容易理解系统的工作原理。经过测试，bistro和其他示例都正常运行，确认了这个修改不会影响现有的渲染行为。<p>从技术角度来看，这个修复也符合最小化修改原则。开发者没有重新设计整个系统，而是精确地移除了无效的代码。这降低了引入新bug的风险，同时解决了实际问题。PR的标签“Code-Quality“准确地反映了它的性质：这是一个代码质量改进，而不是功能变更或性能优化。<h2 id=shi-jue-biao-shi>视觉表示</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[prepare_core_3d_depth_textures函数] --> B[条件检查阶段]
</span><span>    B --> C[检查三个渲染阶段资源]
</span><span>    C --> D{视图是否在所有阶段中?}
</span><span>    D -->|总是True| E[继续执行深度纹理准备]
</span><span>    D -->|实际上Never False| F[跳过此视图]
</span><span>    F -.->|死代码| G[从未执行的分支]
</span><span>    
</span><span>    H[修改后] --> I[直接遍历所有3D视图]
</span><span>    I --> J[为每个视图准备深度纹理]
</span></code></pre><h2 id=zhu-yao-wen-jian-geng-gai>主要文件更改</h2><h3 id=crates-bevy-core-pipeline-src-core-3d-mod-rs-2-13><code>crates/bevy_core_pipeline/src/core_3d/mod.rs</code> (+2/-13)</h3><p>这个文件包含了3D核心管线的实现。修改移除了<code>prepare_core_3d_depth_textures</code>函数中冗余的条件检查。<p><strong>关键修改：</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 修改前：
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>prepare_core_3d_depth_textures</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>texture_cache</span><span style=color:#61676ccc>: </span><span>ResMut&LTTextureCache>,
</span><span>    </span><span style=color:#ff8f40>render_device</span><span style=color:#61676ccc>: </span><span>Res&LTRenderDevice>,
</span><span>    </span><span style=color:#ff8f40>opaque_3d_phases</span><span style=color:#61676ccc>: </span><span>Res&LTViewBinnedRenderPhases&LTOpaque3d>>,  </span><span style=color:#abb0b6;font-style:italic>// 不再需要的参数
</span><span>    </span><span style=color:#ff8f40>alpha_mask_3d_phases</span><span style=color:#61676ccc>: </span><span>Res&LTViewBinnedRenderPhases&LTAlphaMask3d>>,  </span><span style=color:#abb0b6;font-style:italic>// 不再需要的参数
</span><span>    </span><span style=color:#ff8f40>transparent_3d_phases</span><span style=color:#61676ccc>: </span><span>Res&LTViewSortedRenderPhases&LTTransparent3d>>,  </span><span style=color:#abb0b6;font-style:italic>// 不再需要的参数
</span><span>    </span><span style=color:#ff8f40>views_3d</span><span style=color:#61676ccc>: </span><span>Query<(
</span><span>        Entity,
</span><span>        </span><span style=color:#ed9366>&</span><span>ExtractedCamera,
</span><span>        </span><span style=color:#ed9366>&</span><span>ExtractedView,  // 只在条件检查中使用
</span><span>        </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#ed9366>&</span><span>DepthPrepass>,
</span><span>        </span><span style=color:#ed9366>&</span><span>Camera3d,
</span><span>        </span><span style=color:#ed9366>&</span><span>Msaa,
</span><span>    )>,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> render_target_usage </span><span style=color:#ed9366>= </span><span>&LTHashMap<</span><span style=color:#ed9366>_</span><span>, </span><span style=color:#ed9366>_</span><span>>></span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>for </span><span>(</span><span style=color:#ed9366>_</span><span style=color:#61676ccc>,</span><span> camera</span><span style=color:#61676ccc>,</span><span> extracted_view</span><span style=color:#61676ccc>,</span><span> depth_prepass</span><span style=color:#61676ccc>,</span><span> camera_3d</span><span style=color:#61676ccc>,</span><span> _msaa) </span><span style=color:#ed9366>in &</span><span>views_3d {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// 冗余的条件检查 - 永远不会跳过
</span><span>        </span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>opaque_3d_phases</span><span style=color:#ed9366>.</span><span style=color:#f07171>contains_key</span><span>(</span><span style=color:#ed9366>&</span><span>extracted_view</span><span style=color:#ed9366>.</span><span>retained_view_entity)
</span><span>            </span><span style=color:#ed9366>|| !</span><span>alpha_mask_3d_phases</span><span style=color:#ed9366>.</span><span style=color:#f07171>contains_key</span><span>(</span><span style=color:#ed9366>&</span><span>extracted_view</span><span style=color:#ed9366>.</span><span>retained_view_entity)
</span><span>            </span><span style=color:#ed9366>|| !</span><span>transparent_3d_phases</span><span style=color:#ed9366>.</span><span style=color:#f07171>contains_key</span><span>(</span><span style=color:#ed9366>&</span><span>extracted_view</span><span style=color:#ed9366>.</span><span>retained_view_entity)
</span><span>        {
</span><span>            </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>        }</span><span style=color:#61676ccc>;
</span><span>        
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// 实际的工作代码...
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 修改后：
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>prepare_core_3d_depth_textures</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>texture_cache</span><span style=color:#61676ccc>: </span><span>ResMut&LTTextureCache>,
</span><span>    </span><span style=color:#ff8f40>render_device</span><span style=color:#61676ccc>: </span><span>Res&LTRenderDevice>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 移除了三个渲染阶段资源参数
</span><span>    </span><span style=color:#ff8f40>views_3d</span><span style=color:#61676ccc>: </span><span>Query<(
</span><span>        Entity,
</span><span>        </span><span style=color:#ed9366>&</span><span>ExtractedCamera,
</span><span>        // 移除了ExtractedView，因为它不再被使用
</span><span>        </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#ed9366>&</span><span>DepthPrepass>,
</span><span>        </span><span style=color:#ed9366>&</span><span>Camera3d,
</span><span>        </span><span style=color:#ed9366>&</span><span>Msaa,
</span><span>    )>,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> render_target_usage </span><span style=color:#ed9366>= </span><span>&LTHashMap<</span><span style=color:#ed9366>_</span><span>, </span><span style=color:#ed9366>_</span><span>>></span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>for </span><span>(</span><span style=color:#ed9366>_</span><span style=color:#61676ccc>,</span><span> camera</span><span style=color:#61676ccc>,</span><span> depth_prepass</span><span style=color:#61676ccc>,</span><span> camera_3d</span><span style=color:#61676ccc>,</span><span> _msaa) </span><span style=color:#ed9366>in &</span><span>views_3d {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// 直接执行实际工作，没有冗余的条件检查
</span><span>        
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// 实际的工作代码...
</span></code></pre><p>这些修改直接移除了死代码，简化了函数签名和实现，同时保持了功能的完整性。<h2 id=jin-yi-bu-yue-du>进一步阅读</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_render/latest/bevy_render/render_phase/index.html target=_blank>Bevy渲染阶段文档</a> - 理解Bevy中渲染阶段的工作原理<li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/programming/queries.html target=_blank>Bevy ECS查询系统</a> - 了解Query系统如何工作<li><a rel="noopener nofollow noreferrer" href=https://refactoring.guru/smells/dead-code target=_blank>代码质量：识别和移除死代码</a> - 关于死代码识别和处理的通用指南<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/crates/bevy_core_pipeline/src/core_3d/mod.rs target=_blank>Bevy 3D渲染管线架构</a> - 理解完整的3D渲染管线实现</ul><h1 id=wan-zheng-dai-ma-chai-yi>完整代码差异</h1><p>diff –git a/crates/bevy_core_pipeline/src/core_3d/mod.rs b/crates/bevy_core_pipeline/src/core_3d/mod.rs index 64db62dec5ea4..46e2acaa0491e 100644 — a/crates/bevy_core_pipeline/src/core_3d/mod.rs +++ b/crates/bevy_core_pipeline/src/core_3d/mod.rs @@ -690,27 +690,16 @@ pub fn prepare_core_3d_depth_textures( mut commands: Commands, mut texture_cache: ResMut<texturecache>, render_device: Res<renderdevice>, <ul><li>opaque_3d_phases: Res&LTViewBinnedRenderPhases<opaque3d>>, <li>alpha_mask_3d_phases: Res&LTViewBinnedRenderPhases<alphamask3d>>, <li>transparent_3d_phases: Res&LTViewSortedRenderPhases<transparent3d>>, views_3d: Query<( Entity, &ExtractedCamera, <li><pre style=color:#61676c;background-color:#fafafa><code><span>   &ExtractedView,
</span><span>   Option<&DepthPrepass>,
</span><span>   &Camera3d,
</span><span>   &Msaa,
</span></code></pre> )>, ) { let mut render_target_usage = &LTHashMap<_, _>>::default();</li> <li>for (_, camera, extracted_view, depth_prepass, camera_3d, _msaa) in &views_3d {</li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>   if !opaque_3d_phases.contains_key(&extracted_view.retained_view_entity)
</span></code></pre></li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>       || !alpha_mask_3d_phases.contains_key(&extracted_view.retained_view_entity)
</span></code></pre></li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>       || !transparent_3d_phases.contains_key(&extracted_view.retained_view_entity)
</span></code></pre></li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>   {
</span></code></pre></li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>       continue;
</span></code></pre></li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>   };
</span></code></pre></li> <li></li> <ul><li><p>for (_, camera, depth_prepass, camera_3d, _msaa) in &views_3d { // Default usage required to write to the depth texture let mut usage: TextureUsages = camera_3d.depth_texture_usages.into(); if depth_prepass.is_some() { @@ -724,7 +713,7 @@ pub fn prepare_core_3d_depth_textures( }</p> <p>let mut textures = &LTHashMap<_, _>>::default();</p></ul> <ul><li>for (entity, camera, _, _, camera_3d, msaa) in &views_3d {</ul> <ul><li>for (entity, camera, _, camera_3d, msaa) in &views_3d { let Some(physical_target_size) = camera.physical_target_size else { continue; };</ul>    <div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-01/pr_22711.patch id=patch-info style=display:none></div>  <div class=bottom-spacer></div> 