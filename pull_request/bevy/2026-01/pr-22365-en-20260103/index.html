<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22365 Fix flickering on macOS 26 when tracy is enabled
        
    </title><meta content="#22365 Fix flickering on macOS 26 when tracy is enabled" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-01/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-01-03</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-01/pr-22365-zh-cn-20260103>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix flickering on macOS 26 when tracy is enabled<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22365<li><strong>Author</strong>: aevyrie<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, O-MacOS, A-Accessibility, S-Needs-Testing<li><strong>Created</strong>: 2026-01-03T20:04:21Z<li><strong>Merged</strong>: 2026-01-03T22:37:03Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Fix flickering/strobing when using tracy.<li>Close #22257</ul><h2 id=solution>Solution</h2><ul><li>Disable writing timestamps in command encoders on macOS.</ul><h2 id=testing>Testing</h2><ul><li>Can no longer repro with <code>cargo run --example bloom_3d --features=trace_tracy</code><li><code>bevy_bistro_scene</code> also no longer exhibits the flickering</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This pull request addresses a specific rendering issue on macOS that occurs when Tracy profiling is enabled. The problem manifested as noticeable flickering or strobing artifacts during rendering, which was tracked in GitHub issue #22257.<p>The core issue relates to the interaction between Tracy’s timing instrumentation and macOS’s graphics pipeline. When Tracy is enabled, it instruments the code to collect detailed timing information for performance analysis. This includes calling the <code>write_timestamp</code> method on command encoders to record precise timing points in the GPU command stream. However, on macOS (specifically macOS Tahoe), calling <code>write_timestamp</code> very close to frame presentation appears to interfere with the rendering pipeline, causing visible flickering.<p>The solution implemented in this PR is straightforward but targeted. Instead of attempting to work around the issue at a higher level or making complex changes to the timing logic, the fix directly addresses the problematic operation on the affected platform. The implementation adds a conditional check in the <code>WriteTimestamp</code> trait implementation for <code>CommandEncoder</code> that simply returns early without performing any operation when running on macOS.<p>Here’s the technical reasoning behind this approach:<ol><li><p><strong>Platform-specific behavior</strong>: The issue is specific to macOS, so the fix uses conditional compilation (<code>cfg!(target_os = "macos")</code>) to apply only where needed. This avoids affecting other platforms where the <code>write_timestamp</code> functionality works correctly.</p><li><p><strong>Minimal impact on profiling</strong>: While this disables timestamp writing on macOS when Tracy is enabled, it represents an acceptable trade-off. The alternative would be to leave users with broken rendering when using Tracy for profiling. For most profiling scenarios, the loss of these specific GPU timestamps on macOS is preferable to unusable rendering output.</p><li><p><strong>Clear documentation</strong>: The code includes a comment explaining why this workaround is necessary, referencing the original GitHub issue. This helps future maintainers understand the context if they need to revisit this decision or if Apple fixes the underlying driver issue.</p></ol><p>From an architectural perspective, this change is minimal and localized. It affects only the timing instrumentation code path when Tracy is enabled on macOS. The rendering pipeline itself remains unchanged, and all other profiling functionality continues to work. The fix demonstrates a pragmatic approach to platform-specific issues: when a particular operation causes problems on a specific platform, it’s sometimes best to simply disable that operation rather than attempting complex workarounds.<p>The testing methodology was appropriate for this type of fix. The developer verified that the flickering no longer occurs in specific examples (<code>bloom_3d</code> and <code>bevy_bistro_scene</code>) that previously exhibited the issue when running with Tracy enabled. This targeted testing confirms that the fix resolves the reported problem without introducing regressions for those use cases.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Tracy Profiling Enabled] --> B{Platform Check}
</span><span>    B -->|macOS| C[Skip write_timestamp]
</span><span>    B -->|Other Platforms| D[Execute write_timestamp]
</span><span>    C --> E[No Flickering]
</span><span>    D --> F[Normal Timing Data]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-render-src-diagnostic-internal-rs><code>crates/bevy_render/src/diagnostic/internal.rs</code></h3><p>This file contains the <code>WriteTimestamp</code> trait implementation for <code>CommandEncoder</code>. The change adds a platform-specific early return to prevent calling <code>write_timestamp</code> on macOS, which was causing rendering flickering when Tracy profiling is enabled.<p><strong>Key Modification:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// File: crates/bevy_render/src/diagnostic/internal.rs
</span><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>impl </span><span>WriteTimestamp </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>CommandEncoder </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>write_timestamp</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>query_set</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>QuerySet, </span><span style=color:#ff8f40>index</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u32</span><span>) {
</span><span>        CommandEncoder</span><span style=color:#ed9366>::</span><span>write_timestamp(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#61676ccc>,</span><span> query_set</span><span style=color:#61676ccc>,</span><span> index)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>impl </span><span>WriteTimestamp </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>CommandEncoder </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>write_timestamp</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>query_set</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>QuerySet, </span><span style=color:#ff8f40>index</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u32</span><span>) {
</span><span>        </span><span style=color:#fa6e32>if </span><span style=color:#f07171>cfg!</span><span>(target_os </span><span style=color:#ed9366>= </span><span style=color:#86b300>"macos"</span><span>) {
</span><span>            </span><span style=color:#abb0b6;font-style:italic>// When using tracy (and thus this function), rendering was flickering on macOS Tahoe.
</span><span>            </span><span style=color:#abb0b6;font-style:italic>// See: https://github.com/bevyengine/bevy/issues/22257
</span><span>            </span><span style=color:#abb0b6;font-style:italic>// The issue seems to be triggered when `write_timestamp` is called very close to frame
</span><span>            </span><span style=color:#abb0b6;font-style:italic>// presentation.
</span><span>            </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>        CommandEncoder</span><span style=color:#ed9366>::</span><span>write_timestamp(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#61676ccc>,</span><span> query_set</span><span style=color:#61676ccc>,</span><span> index)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><p><strong>Explanation:</strong> The change adds a conditional check at the beginning of the <code>write_timestamp</code> method. When the target operating system is macOS, the method returns immediately without executing the actual <code>write_timestamp</code> operation. This prevents the flickering issue that occurs due to the interaction between timestamp writing and frame presentation on macOS. The comment provides context by linking to the original issue and explaining the suspected cause.<h2 id=further-reading>Further Reading</h2><ol><li><strong>Tracy Profiler</strong>: The official Tracy documentation provides details about the profiling system and its instrumentation capabilities: https://github.com/wolfpld/tracy<li><strong>WebGPU CommandEncoder</strong>: The WebGPU specification includes details about command encoders and timestamp queries: https://www.w3.org/TR/webgpu/#command-encoder<li><strong>Bevy Rendering Architecture</strong>: The Bevy engine’s rendering architecture documentation explains how command encoding and timing work within the engine’s structure.<li><strong>Platform-Specific Graphics Issues</strong>: For understanding common cross-platform graphics challenges, the GPUOpen blog often covers platform-specific rendering issues and workarounds: https://gpuopen.com/</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-01/pr_22365.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>