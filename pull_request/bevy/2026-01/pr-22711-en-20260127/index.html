<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22711 remove conditional that never runs
        
    </title><meta content="#22711 remove conditional that never runs" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-01/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-01-27</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-01/pr-22711-zh-cn-20260127>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: remove conditional that never runs<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22711<li><strong>Author</strong>: atlv24<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, C-Code-Quality, S-Ready-For-Final-Review<li><strong>Created</strong>: 2026-01-26T01:38:55Z<li><strong>Merged</strong>: 2026-01-27T07:55:25Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>this code doesn’t run as far as i can tell, and doesn’t seem to serve any purpose. custom render phases can’t add themselves to this list, so if render phases must be here for some reason this is broken anyways for 3rd party users.</ul><h2 id=solution>Solution</h2><ul><li>yeet and regression test for confidence</ul><h2 id=testing>Testing</h2><ul><li>i ran bistro and a few other examples, gonna ask pixel smeagol now</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a code quality issue in Bevy’s 3D rendering pipeline. The developer identified a conditional check in the <code>prepare_core_3d_depth_textures</code> function that appeared to serve no practical purpose and potentially created confusion for third-party developers working with custom render phases.<p>The function in question is responsible for preparing depth textures for 3D rendering. Before the change, it performed a check to see if three specific render phase collections (<code>opaque_3d_phases</code>, <code>alpha_mask_3d_phases</code>, and <code>transparent_3d_phases</code>) contained entries for each view. If any of these were missing, the function would skip that view entirely. However, as the developer noted, this check effectively never runs because these render phases are always present for 3D views in Bevy’s current implementation.<p>More importantly, the check created a misleading API constraint. The condition implied that views without these specific render phases shouldn’t have depth textures prepared, but third-party developers can’t add their custom render phases to these built-in collections. This meant the code was essentially enforcing a requirement that couldn’t be met by custom render pipelines, creating confusion about whether such pipelines needed to provide these specific phases.<p>The implementation approach was straightforward: remove the unnecessary check and the associated parameters that were only used for that check. The changes are minimal but meaningful:<ol><li>Removed the three <code>Res</code> parameters for the render phase collections<li>Removed the conditional check that used these parameters<li>Simplified the tuple destructuring in the query to remove the now-unused <code>ExtractedView</code> reference</ol><p>The developer tested the change by running several examples including Bistro, ensuring no regression in rendering behavior. They also sought review from a rendering expert (“pixel smeagol”) to confirm the change was safe.<p>This cleanup demonstrates good code hygiene practices. Removing dead code simplifies the codebase, reduces cognitive load for developers reading the function, and eliminates a potential source of confusion about API requirements. It also slightly improves performance by avoiding unnecessary hash map lookups, though this is likely negligible in practice.<p>From a technical perspective, this change highlights an important principle: code that appears to enforce requirements should actually be enforceable. If the requirement can’t be satisfied by the API, it shouldn’t be checked for. The original code created a false impression about what constraints existed in the system.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[prepare_core_3d_depth_textures function] --> B[Before: Check render phases]
</span><span>    A --> C[After: Direct texture preparation]
</span><span>    
</span><span>    B --> D[Query opaque_3d_phases]
</span><span>    B --> E[Query alpha_mask_3d_phases]
</span><span>    B --> F[Query transparent_3d_phases]
</span><span>    D --> G[Skip view if any missing]
</span><span>    E --> G
</span><span>    F --> G
</span><span>    
</span><span>    C --> H[Prepare depth texture]
</span><span>    H --> I[Set usage flags]
</span><span>    H --> J[Create/update texture]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-core-pipeline-src-core-3d-mod-rs-2-13><code>crates/bevy_core_pipeline/src/core_3d/mod.rs</code> (+2/-13)</h3><p>This file contains the core 3D rendering pipeline logic. The changes remove an unnecessary conditional check and clean up function parameters that were only used for that check.<p><strong>Key Changes:</strong><ol><li><strong>Removed render phase parameters and conditional check</strong>:</ol><p>Before:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>prepare_core_3d_depth_textures</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>texture_cache</span><span style=color:#61676ccc>: </span><span>ResMut&LTTextureCache>,
</span><span>    </span><span style=color:#ff8f40>render_device</span><span style=color:#61676ccc>: </span><span>Res&LTRenderDevice>,
</span><span>    </span><span style=color:#ff8f40>opaque_3d_phases</span><span style=color:#61676ccc>: </span><span>Res&LTViewBinnedRenderPhases&LTOpaque3d>>,
</span><span>    </span><span style=color:#ff8f40>alpha_mask_3d_phases</span><span style=color:#61676ccc>: </span><span>Res&LTViewBinnedRenderPhases&LTAlphaMask3d>>,
</span><span>    </span><span style=color:#ff8f40>transparent_3d_phases</span><span style=color:#61676ccc>: </span><span>Res&LTViewSortedRenderPhases&LTTransparent3d>>,
</span><span>    </span><span style=color:#ff8f40>views_3d</span><span style=color:#61676ccc>: </span><span>Query<(
</span><span>        Entity,
</span><span>        </span><span style=color:#ed9366>&</span><span>ExtractedCamera,
</span><span>        </span><span style=color:#ed9366>&</span><span>ExtractedView,
</span><span>        </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#ed9366>&</span><span>DepthPrepass>,
</span><span>        </span><span style=color:#ed9366>&</span><span>Camera3d,
</span><span>        </span><span style=color:#ed9366>&</span><span>Msaa,
</span><span>    )>,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> render_target_usage </span><span style=color:#ed9366>= </span><span>&LTHashMap<</span><span style=color:#ed9366>_</span><span>, </span><span style=color:#ed9366>_</span><span>>></span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>for </span><span>(</span><span style=color:#ed9366>_</span><span style=color:#61676ccc>,</span><span> camera</span><span style=color:#61676ccc>,</span><span> extracted_view</span><span style=color:#61676ccc>,</span><span> depth_prepass</span><span style=color:#61676ccc>,</span><span> camera_3d</span><span style=color:#61676ccc>,</span><span> _msaa) </span><span style=color:#ed9366>in &</span><span>views_3d {
</span><span>        </span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>opaque_3d_phases</span><span style=color:#ed9366>.</span><span style=color:#f07171>contains_key</span><span>(</span><span style=color:#ed9366>&</span><span>extracted_view</span><span style=color:#ed9366>.</span><span>retained_view_entity)
</span><span>            </span><span style=color:#ed9366>|| !</span><span>alpha_mask_3d_phases</span><span style=color:#ed9366>.</span><span style=color:#f07171>contains_key</span><span>(</span><span style=color:#ed9366>&</span><span>extracted_view</span><span style=color:#ed9366>.</span><span>retained_view_entity)
</span><span>            </span><span style=color:#ed9366>|| !</span><span>transparent_3d_phases</span><span style=color:#ed9366>.</span><span style=color:#f07171>contains_key</span><span>(</span><span style=color:#ed9366>&</span><span>extracted_view</span><span style=color:#ed9366>.</span><span>retained_view_entity)
</span><span>        {
</span><span>            </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>        }</span><span style=color:#61676ccc>;
</span></code></pre><p>After:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>prepare_core_3d_depth_textures</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>texture_cache</span><span style=color:#61676ccc>: </span><span>ResMut&LTTextureCache>,
</span><span>    </span><span style=color:#ff8f40>render_device</span><span style=color:#61676ccc>: </span><span>Res&LTRenderDevice>,
</span><span>    </span><span style=color:#ff8f40>views_3d</span><span style=color:#61676ccc>: </span><span>Query<(
</span><span>        Entity,
</span><span>        </span><span style=color:#ed9366>&</span><span>ExtractedCamera,
</span><span>        </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#ed9366>&</span><span>DepthPrepass>,
</span><span>        </span><span style=color:#ed9366>&</span><span>Camera3d,
</span><span>        </span><span style=color:#ed9366>&</span><span>Msaa,
</span><span>    )>,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> render_target_usage </span><span style=color:#ed9366>= </span><span>&LTHashMap<</span><span style=color:#ed9366>_</span><span>, </span><span style=color:#ed9366>_</span><span>>></span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>for </span><span>(</span><span style=color:#ed9366>_</span><span style=color:#61676ccc>,</span><span> camera</span><span style=color:#61676ccc>,</span><span> depth_prepass</span><span style=color:#61676ccc>,</span><span> camera_3d</span><span style=color:#61676ccc>,</span><span> _msaa) </span><span style=color:#ed9366>in &</span><span>views_3d {
</span></code></pre><ol start=2><li><strong>Simplified the second loop iteration</strong>:</ol><p>Before:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>    </span><span style=color:#fa6e32>for </span><span>(entity</span><span style=color:#61676ccc>,</span><span> camera</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>_</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>_</span><span style=color:#61676ccc>,</span><span> camera_3d</span><span style=color:#61676ccc>,</span><span> msaa) </span><span style=color:#ed9366>in &</span><span>views_3d {
</span></code></pre><p>After:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>    </span><span style=color:#fa6e32>for </span><span>(entity</span><span style=color:#61676ccc>,</span><span> camera</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>_</span><span style=color:#61676ccc>,</span><span> camera_3d</span><span style=color:#61676ccc>,</span><span> msaa) </span><span style=color:#ed9366>in &</span><span>views_3d {
</span></code></pre><p>The changes relate to the overall purpose by eliminating code that:<ul><li>Was effectively dead (the condition never triggered)<li>Created misleading API constraints for third-party developers<li>Added unnecessary complexity to the function signature and logic</ul><h2 id=further-reading>Further Reading</h2><ol><li><strong>Bevy Render Phases Documentation</strong>: Understanding how render phases work in Bevy’s rendering architecture<li><strong>ECS Systems and Queries</strong>: How Bevy’s Entity Component System handles system parameters and queries<li><strong>Code Quality Practices</strong>: The importance of removing dead code and simplifying complex conditionals<li><strong>Rendering Pipeline Architecture</strong>: How depth textures are managed in modern game engines<li><strong>Third-party Extension Patterns</strong>: Best practices for designing extensible APIs in game engines</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-01/pr_22711.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>