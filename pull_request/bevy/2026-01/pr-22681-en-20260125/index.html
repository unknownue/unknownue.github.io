<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22681 Glam 0.31
        
    </title><meta content="#22681 Glam 0.31" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-01/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-01-25</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-01/pr-22681-zh-cn-20260125>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Glam 0.31<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22681<li><strong>Author</strong>: hukasu<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Dependencies, S-Ready-For-Final-Review, A-Math, M-Migration-Guide<li><strong>Created</strong>: 2026-01-24T14:53:34Z<li><strong>Merged</strong>: 2026-01-25T22:41:29Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p><strong>Objective</strong><p>Adopt and closes #22665<p><strong>Solution</strong><p>Delete bevy’s <code>Affine3</code>, create an extension trait for methods create for old bevy’s <code>Affine3</code> to be used by glam’s <code>Affine3</code>, and register glam’s <code>Affine3</code> for reflection<p><strong>Testing</strong><p><code>cargo run -p ci</code><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR updates Bevy’s dependency on the glam math library from version 0.30.7 to 0.31.0. The primary challenge was that glam 0.31 introduced its own <code>Affine3</code> type, which conflicted with Bevy’s custom <code>Affine3</code> struct that served as a storage-optimized version. This required a coordinated migration across the codebase to replace Bevy’s custom type with glam’s implementation while maintaining backward compatibility for existing functionality.<p>The core issue was straightforward: glam 0.31 introduced a new <code>Affine3</code> struct in its public API, making it impossible to have both Bevy’s custom <code>Affine3</code> and glam’s <code>Affine3</code> in the same namespace. Since using the upstream implementation from glam is preferable for maintenance and consistency, the decision was made to remove Bevy’s version entirely.<p>However, Bevy’s <code>Affine3</code> provided two utility methods that weren’t available in glam’s implementation: <code>to_transpose()</code> and <code>inverse_transpose_3x3()</code>. These methods were used throughout the rendering pipeline to format affine transformations for GPU buffer packing. Rather than losing this functionality or modifying glam’s upstream type, the solution was to create an extension trait <code>Affine3Ext</code> that adds these methods to glam’s <code>Affine3</code> type.<p>The implementation approach was methodical:<ol><li>Update all Cargo.toml files to reference glam 0.31.0<li>Replace the custom <code>Affine3</code> struct in <code>bevy_math</code> with an extension trait<li>Update all usage sites to import and use the extension trait<li>Register glam’s <code>Affine3</code> for reflection to maintain serialization capabilities<li>Update dependent crates like hexasphere that also needed version bumps</ol><p>The key insight was recognizing that an extension trait provides a clean separation of concerns: glam provides the core affine transformation functionality, while Bevy adds domain-specific utilities needed for its rendering pipeline. This approach follows Rust’s trait system design patterns and avoids modifying upstream dependencies.<p>The migration required updating approximately 11 files across the codebase, with most changes being mechanical conversions from <code>Affine3::from(&affine)</code> to <code>Affine3::from(affine)</code> and adding the <code>Affine3Ext</code> import where the utility methods were needed. The changes in rendering code were particularly important because affine transformations are fundamental to positioning and transforming objects in 3D space.<p>One notable aspect of the implementation is how the <code>to_transpose()</code> method works. It converts a 4x3 affine matrix (3x3 rotation/scale matrix + 3D translation vector) into a transposed 3x4 format suitable for GPU shader consumption. The method cleverly uses <code>Vec4</code> types where the fourth component stores the translation component, which matches the expected memory layout for GPU buffers.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Custom struct with methods
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>Affine3 </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>matrix3</span><span style=color:#61676ccc>:</span><span> Mat3,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>translation</span><span style=color:#61676ccc>:</span><span> Vec3,
</span><span>}
</span><span>
</span><span style=color:#fa6e32>impl </span><span style=color:#399ee6>Affine3 </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>to_transpose</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span>[Vec4</span><span style=color:#61676ccc>; </span><span style=color:#ff8f40>3</span><span>] { </span><span style=color:#ed9366>... </span><span>}
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Extension trait for glam's type
</span><span style=color:#fa6e32>pub trait </span><span style=color:#399ee6>Affine3Ext </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>to_transpose</span><span>(</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span>[Vec4</span><span style=color:#61676ccc>; </span><span style=color:#ff8f40>3</span><span>]</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#fa6e32>impl </span><span>Affine3Ext </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>Affine3 </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>to_transpose</span><span>(</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span>[Vec4</span><span style=color:#61676ccc>; </span><span style=color:#ff8f40>3</span><span>] {
</span><span>        </span><span style=color:#fa6e32>let</span><span> transpose_3x3 </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>matrix3</span><span style=color:#ed9366>.</span><span style=color:#f07171>transpose</span><span>()</span><span style=color:#61676ccc>;
</span><span>        [
</span><span>            transpose_3x3</span><span style=color:#ed9366>.</span><span>x_axis</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend</span><span>(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>translation</span><span style=color:#ed9366>.</span><span>x)</span><span style=color:#61676ccc>,
</span><span>            transpose_3x3</span><span style=color:#ed9366>.</span><span>y_axis</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend</span><span>(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>translation</span><span style=color:#ed9366>.</span><span>y)</span><span style=color:#61676ccc>,
</span><span>            transpose_3x3</span><span style=color:#ed9366>.</span><span>z_axis</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend</span><span>(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>translation</span><span style=color:#ed9366>.</span><span>z)</span><span style=color:#61676ccc>,
</span><span>        ]
</span><span>    }
</span><span>}
</span></code></pre><p>The migration guide was created to help users update their code, noting that the <code>to_transpose</code> and <code>inverse_transpose_3x3</code> methods now require the <code>Affine3Ext</code> trait to be in scope. This is a minor breaking change but follows established Rust patterns for extension traits.<p>From a performance perspective, using glam’s native <code>Affine3</code> type likely provides better optimization opportunities since it’s implemented by the same team that specializes in high-performance graphics math. The removal of conversion layers between Bevy’s <code>Affine3</code> and glam’s <code>Affine3A</code> also eliminates some overhead.<p>The PR successfully modernizes Bevy’s math dependencies while maintaining all existing functionality through careful use of Rust’s trait system. The approach demonstrates how to handle upstream API changes in a large codebase with minimal disruption.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Glam 0.30.7] --> B{Glam 0.31.0 Update}
</span><span>    B --> C[Remove Bevy Affine3]
</span><span>    B --> D[Use Glam Affine3]
</span><span>    C --> E[Create Affine3Ext Trait]
</span><span>    D --> F[Register for Reflection]
</span><span>    E --> G[Update Usage Sites]
</span><span>    F --> G
</span><span>    G --> H[Updated Codebase]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>crates/bevy_math/src/affine3.rs (+10/-36)</strong> This file underwent the most significant change, transforming from a custom struct definition to an extension trait. The old <code>Affine3</code> struct was completely removed and replaced with <code>Affine3Ext</code> trait that provides the same utility methods for glam’s <code>Affine3</code> type.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Custom struct with implementations
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>Affine3 </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>matrix3</span><span style=color:#61676ccc>:</span><span> Mat3,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>translation</span><span style=color:#61676ccc>:</span><span> Vec3,
</span><span>}
</span><span>
</span><span style=color:#fa6e32>impl </span><span style=color:#399ee6>Affine3 </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>to_transpose</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span>[Vec4</span><span style=color:#61676ccc>; </span><span style=color:#ff8f40>3</span><span>] { </span><span style=color:#ed9366>... </span><span>}
</span><span>    </span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>inverse_transpose_3x3</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span>([Vec4; 2], </span><span style=color:#fa6e32>f32</span><span>) { </span><span style=color:#ed9366>... </span><span>}
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Extension trait only
</span><span style=color:#fa6e32>pub trait </span><span style=color:#399ee6>Affine3Ext </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>to_transpose</span><span>(</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span>[Vec4</span><span style=color:#61676ccc>; </span><span style=color:#ff8f40>3</span><span>]</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>inverse_transpose_3x3</span><span>(</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span>([Vec4; 2], </span><span style=color:#fa6e32>f32</span><span>)</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#fa6e32>impl </span><span>Affine3Ext </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>Affine3 </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>to_transpose</span><span>(</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span>[Vec4</span><span style=color:#61676ccc>; </span><span style=color:#ff8f40>3</span><span>] { </span><span style=color:#ed9366>... </span><span>}
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>inverse_transpose_3x3</span><span>(</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span>([Vec4; 2], </span><span style=color:#fa6e32>f32</span><span>) { </span><span style=color:#ed9366>... </span><span>}
</span><span>}
</span></code></pre><p><strong>crates/bevy_reflect/src/impls/glam.rs (+8/-0)</strong> Added reflection support for glam’s <code>Affine3</code> type, which is necessary for serialization and deserialization workflows in Bevy’s ECS.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#f07171>impl_reflect!</span><span>(
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>reflect</span><span>(Clone</span><span style=color:#61676ccc>,</span><span> Debug</span><span style=color:#61676ccc>,</span><span> PartialEq</span><span style=color:#61676ccc>,</span><span> Default</span><span style=color:#61676ccc>,</span><span> Deserialize</span><span style=color:#61676ccc>,</span><span> Serialize)]
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>type_path </span><span style=color:#ed9366>= </span><span style=color:#86b300>"glam"</span><span>]
</span><span>    </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>Affine3 </span><span>{
</span><span>        matrix3</span><span style=color:#61676ccc>:</span><span> Mat3,
</span><span>        translation</span><span style=color:#61676ccc>:</span><span> Vec3,
</span><span>    }
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><p><strong>crates/bevy_pbr/src/render/mesh.rs (+5/-5)</strong> Updated mesh rendering code to use the new extension trait and remove references to the old <code>Affine3</code> type. The changes show the pattern of removing the reference operator when converting affine transformations.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>world_from_local</span><span style=color:#61676ccc>: </span><span>(</span><span style=color:#ed9366>&</span><span>transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>affine</span><span>())</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>world_from_local</span><span style=color:#61676ccc>:</span><span> transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>affine</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()</span><span style=color:#61676ccc>,
</span></code></pre><p><strong>release-content/migration-guides/affine3_extension_trait.md (+9/-0)</strong> Created a migration guide explaining that the <code>to_transpose</code> and <code>inverse_transpose_3x3</code> methods are now part of an extension trait and require the trait to be in scope.<p><strong>Multiple Cargo.toml files</strong> Updated glam dependency from 0.30.7 to 0.31.0 across the entire project, ensuring consistency. Also updated hexasphere from 16.0 to 17.0 in bevy_mesh, which was likely required due to its own glam dependency.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/book/ch10-02-traits.html target=_blank>Rust Traits: Defining Shared Behavior</a> - Understanding extension traits<li><a rel="noopener nofollow noreferrer" href=https://docs.rs/glam/ target=_blank>Glam Library Documentation</a> - Official documentation for the glam math library<li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Affine_transformation target=_blank>Affine Transformations in Computer Graphics</a> - Mathematical background on affine transformations<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/features/reflection/ target=_blank>Bevy Reflection System</a> - How Bevy handles serialization and runtime type information</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-01/pr_22681.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>