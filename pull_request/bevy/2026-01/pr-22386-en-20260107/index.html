<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22386 Fix font ID leak in `TextPipeline`
        
    </title><meta content="#22386 Fix font ID leak in `TextPipeline`" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-01/>‚Üê Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-01-07</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-01/pr-22386-zh-cn-20260107>‰∏≠Êñá</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix font ID leak in <code>TextPipeline</code><li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22386<li><strong>Author</strong>: ickshonpe<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, S-Ready-For-Final-Review, P-Regression, P-Critical, M-Migration-Guide, A-Text, D-Straightforward<li><strong>Created</strong>: 2026-01-05T12:52:31Z<li><strong>Merged</strong>: 2026-01-07T23:09:55Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>#22156 introduced a leak üòì . Every time a text section with a font handle font source is updated in <code>TextPipeLine::update_buffer</code>, a new font with a new font ID is added to cosmic text‚Äôs FontDb.<p>Fixes #22419<h2 id=solution>Solution</h2><p>Remove font loading and asset-ID association from TextPipeline. Instead, add the font family name to the <code>Font</code> asset after loading. Then <code>update_buffer</code> can just use the family name from the asset.<h2 id=testing>Testing</h2><p>Add this system to the <code>text</code> example (or any bevy app with updating text):<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(Update</span><span style=color:#61676ccc>, </span><span>|</span><span style=color:#ff8f40>font_system</span><span style=color:#61676ccc>: </span><span>Res&LTCosmicFontSystem>| {
</span><span>                </span><span style=color:#f07171>println!</span><span>(</span><span style=color:#86b300>"fonts: </span><span style=color:#ff8f40>{}</span><span style=color:#86b300>"</span><span style=color:#61676ccc>,</span><span> font_system</span><span style=color:#ed9366>.</span><span style=color:#f07171>db</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>len</span><span>())</span><span style=color:#61676ccc>;
</span><span>            })
</span></code></pre><p>You should observe the count increasing with every text update on main. The count should be stable with this PR.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The issue started with PR #22156 which introduced a regression where font IDs were leaking in the text rendering system. Every time text with a font handle was updated, the system would load the font again into cosmic text‚Äôs FontDb, creating new font IDs that were never cleaned up. This led to unbounded memory growth in applications that updated text frequently.<p>The core problem was in how <code>TextPipeline</code> handled font loading. When <code>update_buffer</code> was called for text using a font handle, it would load the font into cosmic text‚Äôs database each time. The system maintained a mapping from <code>AssetId&LTFont></code> to cosmic text font IDs in <code>TextPipeline::map_handle_to_font_id</code>, but this approach had a critical flaw: it didn‚Äôt prevent duplicate loading of the same font asset.<p>The solution involved a significant architectural change. Instead of having <code>TextPipeline</code> responsible for loading fonts and maintaining the ID mapping, the loading was moved to the asset system. The <code>Font</code> asset was enhanced to store its family name after loading, and <code>TextPipeline</code> was simplified to just use that family name directly.<p>Here‚Äôs how the implementation works: when a <code>Font</code> asset is loaded by the asset system, the <code>load_font_assets_into_fontdb_system</code> system loads it into cosmic text‚Äôs font database and extracts the font family name from the loaded font data. This family name is stored in the <code>Font</code> asset‚Äôs new <code>family_name</code> field.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// In load_font_assets_into_fontdb_system
</span><span>font</span><span style=color:#ed9366>.</span><span>family_name </span><span style=color:#ed9366>=</span><span> font_system
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>db</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>face</span><span>(</span><span style=color:#ed9366>*</span><span>font</span><span style=color:#ed9366>.</span><span>ids</span><span style=color:#ed9366>.</span><span style=color:#f07171>last</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>())
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span>families[</span><span style=color:#ff8f40>0</span><span>]
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>as_str</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><p>When <code>TextPipeline::update_buffer</code> needs to render text, it now simply retrieves the family name from the <code>Font</code> asset instead of loading the font again:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let</span><span> family_name</span><span style=color:#61676ccc>:</span><span> SmolStr </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>match </span><span style=color:#ed9366>&</span><span>text_font</span><span style=color:#ed9366>.</span><span>font {
</span><span>    FontSource</span><span style=color:#ed9366>::</span><span>Handle(handle) </span><span style=color:#ed9366>=> </span><span>{
</span><span>        fonts
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(handle</span><span style=color:#ed9366>.</span><span style=color:#f07171>id</span><span>())
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>ok_or</span><span>(TextError</span><span style=color:#ed9366>::</span><span>NoSuchFont)</span><span style=color:#ed9366>?
</span><span>            </span><span style=color:#ed9366>.</span><span>family_name
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()
</span><span>    }
</span><span>    FontSource</span><span style=color:#ed9366>::</span><span>Family(family) </span><span style=color:#ed9366>=></span><span> family</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#61676ccc>,
</span><span>}</span><span style=color:#61676ccc>;
</span></code></pre><p>This change eliminated the need for the <code>map_handle_to_font_id</code> hash map entirely, which was removed along with the <code>get_font_id</code> method. The approach is cleaner because it leverages the existing asset system for loading and caching, rather than duplicating that logic in <code>TextPipeline</code>.<p>The fix required updates to the test infrastructure as well. Tests needed to manually set the <code>family_name</code> on font assets since they don‚Äôt run the full asset loading pipeline. This demonstrates an important consideration when refactoring asset loading logic: tests that bypass the normal asset pipeline need explicit setup.<p>The migration guide was added to document the removal of <code>map_handle_to_font_id</code> and <code>get_font_id</code> from <code>TextPipeline</code>. Developers who were using these methods to retrieve font IDs now need to access the information directly from the <code>Font</code> asset, which actually provides a cleaner API.<p>This fix is a good example of addressing a memory leak by reevaluating responsibility boundaries. Instead of trying to patch the leak in the existing approach, the solution restructured where and how font loading happens, resulting in both simpler code and better performance.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Font Asset Loading] --> B[Store family_name in Font asset]
</span><span>    B --> C[TextPipeline uses family_name directly]
</span><span>    C --> D[Cosmic text references font by family]
</span><span>    
</span><span>    E[Old: TextPipeline loads font] --> F[Creates new font ID each time]
</span><span>    F --> G[Memory leak]
</span><span>    
</span><span>    style A fill:#e1f5e1
</span><span>    style B fill:#e1f5e1
</span><span>    style C fill:#e1f5e1
</span><span>    style D fill:#e1f5e1
</span><span>    style E fill:#ffebee
</span><span>    style F fill:#ffebee
</span><span>    style G fill:#ffebee
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ol><li><p><strong><code>crates/bevy_text/src/font.rs</code></strong> (+14/-0)</p> <ul><li>Added <code>family_name: SmolStr</code> field to the <code>Font</code> struct to store the font family name after loading<li>Updated <code>load_font_assets_into_fontdb_system</code> to extract and store the family name when loading fonts</ul><li><p><strong><code>crates/bevy_text/src/pipeline.rs</code></strong> (+7/-30)</p> <ul><li>Removed <code>map_handle_to_font_id: HashMap&LTAssetId&LTFont>, (ID, Arc&LTstr>)></code> field from <code>TextPipeline</code><li>Removed <code>get_font_id</code> method from <code>TextPipeline</code><li>Simplified <code>update_buffer</code> to use <code>family_name</code> from <code>Font</code> asset instead of loading fonts<li>Cleaned up imports that were no longer needed</ul><li><p><strong><code>crates/bevy_sprite/src/text2d.rs</code></strong> (+13/-0)</p> <ul><li>Updated test setup to manually set <code>family_name</code> and load font data since tests don‚Äôt run the asset loading system</ul> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let</span><span> font </span><span style=color:#ed9366>=</span><span> fonts</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_mut</span><span>(bevy_asset</span><span style=color:#ed9366>::</span><span>AssetId</span><span style=color:#ed9366>::</span><span>default())</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span><span>font</span><span style=color:#ed9366>.</span><span>family_name </span><span style=color:#ed9366>= </span><span style=color:#86b300>"Fira Mono"</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> data </span><span style=color:#ed9366>=</span><span> font</span><span style=color:#ed9366>.</span><span>data</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_ref</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>world_mut</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span>resource_mut</span><span style=color:#ed9366>::</span><span>&LTCosmicFontSystem>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>db_mut</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>load_font_data</span><span>(data)</span><span style=color:#61676ccc>;
</span></code></pre><li><p><strong><code>release-content/migration-guides/map_handle_to_font_id-and-get_font_id-removed-from-TextPipeline.md</code></strong> (+8/-0)</p> <ul><li>Created migration guide documenting the removal of <code>map_handle_to_font_id</code> and <code>get_font_id</code> from <code>TextPipeline</code><li>Noted that font ID and family name can now be retrieved from the <code>Font</code> asset itself</ul></ol><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://github.com/pop-os/cosmic-text target=_blank>cosmic-text</a> - The text layout library used by Bevy<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/getting-started/assets/ target=_blank>Bevy Asset System</a> - How Bevy handles asset loading and management<li><a rel="noopener nofollow noreferrer" href=https://rust-lang.github.io/rust-clippy/master/index.html#/mem_leak target=_blank>Memory Leak Patterns in Rust</a> - Common patterns that can cause memory leaks in Rust</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-01/pr_22386.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>