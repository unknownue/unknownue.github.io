<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22328 Deduplicate solari realtime bindings
        
    </title><meta content="#22328 Deduplicate solari realtime bindings" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-01/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-01-05</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-01/pr-22328-zh-cn-20260105>中文</a></div></div><div class=pr-content><h1 id=deduplicate-solari-realtime-bindings>Deduplicate solari realtime bindings</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Deduplicate solari realtime bindings<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22328<li><strong>Author</strong>: SparkyPotato<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, C-Code-Quality, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-12-31T21:12:20Z<li><strong>Merged</strong>: 2026-01-05T02:58:29Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>Most solari realtime passes redeclare the same resources in the same bind group. This PR collects all the bindings into one file, along with the struct definitions required for them.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The PR addresses a code duplication issue in the Bevy engine’s solari realtime rendering system. Multiple WGSL shader files were independently declaring the same bind group resources and data structures, which created maintenance overhead and increased the risk of inconsistencies.<p>When examining the solari realtime shaders before this change, it was clear that several passes - including <code>restir_di.wgsl</code>, <code>restir_gi.wgsl</code>, <code>specular_gi.wgsl</code>, and others - were all declaring similar sets of bindings at the top of their files. Each shader was defining its own version of resources like <code>view_output</code>, <code>gbuffer</code>, <code>depth_buffer</code>, <code>view</code>, and various world cache buffers. This duplication wasn’t just about bindings - even complex data structures like <code>ResolvedLightSamplePacked</code> and <code>Reservoir</code> were being redefined in multiple places.<p>The core issue was that any change to these shared resources required modifications across multiple files. For example, if the layout of the <code>Reservoir</code> struct needed adjustment, developers would have to find and update every shader file that declared it. This was error-prone and violated the DRY (Don’t Repeat Yourself) principle.<p>The solution implemented in this PR follows a straightforward refactoring approach: create a single shared file (<code>realtime_bindings.wgsl</code>) that contains all common bindings and struct definitions, then have individual shaders import from this centralized location. This pattern is already established in Bevy’s rendering system with other shared modules.<p>The implementation creates <code>realtime_bindings.wgsl</code> with 24 bindings (0-23) that cover the full set of resources needed by the solari realtime passes. It defines three key structs:<ul><li><code>ResolvedLightSamplePacked</code>: Used for packed light sample data<li><code>Reservoir</code>: Used for ReSTIR (ReSTIR算法是一种实时光线追踪降噪技术) reservoirs in global illumination<li><code>WorldCacheGeometryData</code>: Used for world cache geometry information</ul><p>Each struct includes important comments warning developers about maintaining structure sizes in sync with corresponding CPU-side code. The bindings file is then loaded as a shader library in the plugin initialization.<p>The changes to individual shader files follow a consistent pattern: remove local declarations and replace them with imports. For example, in <code>restir_di.wgsl</code>:<p>Before the change, the file had 15 lines of binding declarations and struct definitions. After the change, it imports everything from <code>realtime_bindings</code> with a single line: <code>#import bevy_solari::realtime_bindings::{view_output, light_tile_samples, light_tile_resolved_samples, di_reservoirs_a, di_reservoirs_b, gbuffer, depth_buffer, motion_vectors, previous_gbuffer, previous_depth_buffer, view, previous_view, constants, ResolvedLightSamplePacked}</code>.<p>This approach offers several advantages:<ol><li><strong>Maintainability</strong>: Changes to bindings or struct layouts now only need to be made in one place.<li><strong>Consistency</strong>: All shaders use the exact same definitions, eliminating potential subtle bugs from mismatched declarations.<li><strong>Reduced file size</strong>: The shader files become significantly smaller and more focused on their specific algorithms rather than boilerplate declarations.<li><strong>Clarity</strong>: It’s immediately clear which resources a shader uses by examining its imports.</ol><p>The refactoring also revealed that some shaders were importing more than they needed. For instance, <code>presample_light_tiles.wgsl</code> was importing the entire <code>presample_light_tiles</code> module just to get the <code>unpack_resolved_light_sample</code> function, when it really only needed that specific function. This wasn’t changed in this PR, but the clearer structure makes such optimizations more apparent.<p>One technical consideration is that WGSL’s import system works at compile time, so there’s no runtime performance impact from this change. The GPU sees the same final shader code after imports are resolved. The main benefit is developer productivity and code quality.<p>The changes affect 10 files total, with the key transformation being the creation of the new bindings file and the simplification of 5 main shader files that previously contained duplicated declarations. The net result is a cleaner, more maintainable codebase that’s easier to extend and debug.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[realtime_bindings.wgsl] --> B[restir_di.wgsl]
</span><span>    A --> C[restir_gi.wgsl]
</span><span>    A --> D[specular_gi.wgsl]
</span><span>    A --> E[presample_light_tiles.wgsl]
</span><span>    A --> F[resolve_dlss_rr_textures.wgsl]
</span><span>    A --> G[world_cache_query.wgsl]
</span><span>    A --> H[world_cache_compact.wgsl]
</span><span>    A --> I[world_cache_update.wgsl]
</span><span>    
</span><span>    subgraph "Centralized Definitions"
</span><span>        A
</span><span>    end
</span><span>    
</span><span>    subgraph "Consumer Shaders"
</span><span>        B
</span><span>        C
</span><span>        D
</span><span>        E
</span><span>        F
</span><span>        G
</span><span>        H
</span><span>        I
</span><span>    end
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=1-crates-bevy-solari-src-realtime-realtime-bindings-wgsl-63-0>1. <code>crates/bevy_solari/src/realtime/realtime_bindings.wgsl</code> (+63/-0)</h3><p>This is the new file that centralizes all shared bindings and struct definitions. It contains:<ul><li>All 24 bindings (0-23) used by solari realtime passes<li>Three critical struct definitions with size warnings<li>Push constants definition used across multiple shaders</ul><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>#define_import_path bevy_solari::realtime_bindings
</span><span>
</span><span>#import bevy_render::view::View
</span><span>#import bevy_pbr::prepass_bindings::PreviousViewUniforms
</span><span>#import bevy_solari::sampling::LightSample
</span><span>
</span><span>@group(1) @binding(0) var view_output: texture_storage_2d&LTrgba16float, read_write>;
</span><span>@group(1) @binding(1) var&LTstorage, read_write> light_tile_samples: array&LTLightSample>;
</span><span>// ... (23 total bindings)
</span><span>
</span><span>struct ResolvedLightSamplePacked {
</span><span>    world_position_x: f32,
</span><span>    world_position_y: f32,
</span><span>    world_position_z: f32,
</span><span>    world_normal: u32,
</span><span>    radiance: u32,
</span><span>    inverse_pdf: f32,
</span><span>}
</span><span>
</span><span>struct Reservoir {
</span><span>    sample_point_world_position: vec3&LTf32>,
</span><span>    weight_sum: f32,
</span><span>    radiance: vec3&LTf32>,
</span><span>    confidence_weight: f32,
</span><span>    sample_point_world_normal: vec3&LTf32>,
</span><span>    unbiased_contribution_weight: f32,
</span><span>}
</span></code></pre><h3 id=2-crates-bevy-solari-src-realtime-world-cache-query-wgsl-12-22>2. <code>crates/bevy_solari/src/realtime/world_cache_query.wgsl</code> (+12/-22)</h3><p>This file previously contained its own declarations of world cache buffers and the <code>WorldCacheGeometryData</code> struct. Now it imports them from the centralized bindings.<p><strong>Before:</strong><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>struct WorldCacheGeometryData {
</span><span>    world_position: vec3&LTf32>,
</span><span>    padding_a: u32,
</span><span>    world_normal: vec3&LTf32>,
</span><span>    padding_b: u32
</span><span>}
</span><span>
</span><span>@group(1) @binding(14) var&LTstorage, read_write> world_cache_checksums: array&LTatomic&LTu32>, #{WORLD_CACHE_SIZE}>;
</span><span>// ... (9 more buffer declarations)
</span></code></pre><p><strong>After:</strong><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>#import bevy_solari::realtime_bindings::{
</span><span>    world_cache_life,
</span><span>    world_cache_checksums,
</span><span>    world_cache_radiance,
</span><span>    world_cache_geometry_data,
</span><span>    world_cache_luminance_deltas,
</span><span>    world_cache_a,
</span><span>    world_cache_b,
</span><span>    world_cache_active_cell_indices,
</span><span>    world_cache_active_cells_count,
</span><span>    WorldCacheGeometryData,
</span><span>}
</span></code></pre><h3 id=3-crates-bevy-solari-src-realtime-restir-gi-wgsl-1-23>3. <code>crates/bevy_solari/src/realtime/restir_gi.wgsl</code> (+1/-23)</h3><p>This shader for global illumination using ReSTIR previously had its own binding declarations and the <code>Reservoir</code> struct definition. Now it imports everything needed.<p><strong>Before:</strong><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>@group(1) @binding(0) var view_output: texture_storage_2d&LTrgba16float, read_write>;
</span><span>@group(1) @binding(5) var&LTstorage, read_write> gi_reservoirs_a: array&LTReservoir>;
</span><span>// ... (12 more lines of bindings)
</span><span>
</span><span>struct PushConstants { frame_index: u32, reset: u32 }
</span><span>var&LTpush_constant> constants: PushConstants;
</span><span>
</span><span>// ... (later in the file)
</span><span>
</span><span>struct Reservoir {
</span><span>    sample_point_world_position: vec3&LTf32>,
</span><span>    weight_sum: f32,
</span><span>    radiance: vec3&LTf32>,
</span><span>    confidence_weight: f32,
</span><span>    sample_point_world_normal: vec3&LTf32>,
</span><span>    unbiased_contribution_weight: f32,
</span><span>}
</span></code></pre><p><strong>After:</strong><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>#import bevy_solari::realtime_bindings::{view_output, gi_reservoirs_a, gi_reservoirs_b, gbuffer, depth_buffer, motion_vectors, previous_gbuffer, previous_depth_buffer, view, previous_view, constants, Reservoir}
</span></code></pre><h3 id=4-crates-bevy-solari-src-realtime-restir-di-wgsl-2-16>4. <code>crates/bevy_solari/src/realtime/restir_di.wgsl</code> (+2/-16)</h3><p>This direct illumination shader saw similar simplification, removing 16 lines of duplicate bindings.<h3 id=5-crates-bevy-solari-src-realtime-presample-light-tiles-wgsl-1-15>5. <code>crates/bevy_solari/src/realtime/presample_light_tiles.wgsl</code> (+1/-15)</h3><p>This shader for light tile presampling was simplified by importing bindings instead of declaring them locally.<h3 id=6-crates-bevy-solari-src-realtime-mod-rs-1-0>6. <code>crates/bevy_solari/src/realtime/mod.rs</code> (+1/-0)</h3><p>The plugin was updated to load the new shader library:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#f07171>load_shader_library!</span><span>(app</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"realtime_bindings.wgsl"</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://www.w3.org/TR/WGSL/#shader-module-creation target=_blank>WGSL Shader Modules Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/crates/bevy_render/src/render_resource/shader.rs target=_blank>Bevy’s Shader Import System</a><li><a rel="noopener nofollow noreferrer" href=https://research.nvidia.com/sites/default/files/pubs/2020-07_Spatiotemporal-reservoir-resampling/ReSTIR.pdf target=_blank>ReSTIR (Real-time Spatiotemporal Reservoir Resampling) Paper</a><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Don%27t_repeat_yourself target=_blank>DRY Principle in Software Development</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-01/pr_22328.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>