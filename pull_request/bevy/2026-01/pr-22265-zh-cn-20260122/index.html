<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22265 Upgrade to wgpu 28
        
    </title><meta content="#22265 Upgrade to wgpu 28" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-01/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-01-22</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2026-01/pr-22265-en-20260122>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Upgrade to wgpu 28<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22265<li><strong>Author</strong>: ChristopherBiscardi<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, C-Dependencies, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-12-25T01:07:06Z<li><strong>Merged</strong>: 2026-01-22T19:02:13Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>升级到 wgpu 28<blockquote><p>[!important] 此PR无法合并，直到 https://github.com/bevyengine/naga_oil/pull/132 合并，并且依赖从我的fork更新到发布版本。<p>同时需要在 dlss_wgpu 中使用 wgpu 28：https://github.com/bevyengine/dlss_wgpu/pull/17</blockquote><blockquote><p>[!note] 此PR不启用网格着色器，naga_oil PR也不启用。我选择先进行升级，然后再回过来看网格着色器。</blockquote><p>以下是更改的概览以及我所做的工作。提交按功能分组，除了最后一个提交，它在运行solari示例时启用了solari。<h2 id=mipmapfiltermode-cong-filtermode-zhong-fen-chi>MipmapFilterMode 从 FilterMode 中分离</h2><ul><li>Split MipmapFilterMode from FilterMode #8314：https://github.com/gfx-rs/wgpu/pull/8314</ul><p>解决方案：为 <code>MipmapFilterMode</code>/<code>ImageFilterMode</code> 实现 From trait，因为它们的值相同。分离是因为规范指出它们是不同的类型，即使值相同。<h2 id=push-constants-xian-zai-gai-wei-immediates>Push Constants 现在改为 Immediates</h2><ul><li>https://github.com/gfx-rs/wgpu/pull/8724</ul><p>immediate_size 是 <a rel="noopener nofollow noreferrer" href=https://docs.rs/wgpu/28.0.0/wgpu/struct.PipelineLayoutDescriptor.html#structfield.immediate_size target=_blank>一个 u32</a>，因此使用它代替 <code>PushConstantRange</code>。<h2 id=capabilities-ming-cheng-bian-geng>Capabilities 名称变更</h2><ul><li>https://github.com/gfx-rs/wgpu/pull/8671</ul><p>从 https://github.com/gfx-rs/wgpu/blob/trunk/wgpu-core/src/device/mod.rs#L449 获取新列表并复制到代码中。<h2 id=subgroup-min-max-size-cong-limits-yi-dong-dao-adapterinfo>subgroup_{min,max}_size 从 Limits 移动到 AdapterInfo</h2><ul><li>https://github.com/gfx-rs/wgpu/pull/8609</ul><p>更新 limits 结构体，使其包含现在的字段，并镜像其他 limits 调用的逻辑。<h2 id=multiview-mask>multiview_mask</h2><ul><li>https://github.com/gfx-rs/wgpu/pull/8206</ul><p>设置为 None，因为我们目前不使用它。它大致用于VR。<h2 id=error-scope-xian-zai-shi-yi-ge-guard>error scope 现在是一个 guard</h2><ul><li>https://github.com/gfx-rs/wgpu/pull/8685</ul><p>保留 guard，然后稍后调用 pop()。<hr><p>我在PR中犯了一个错误，以为 set_immediates 是 immediates 的大小而不是偏移量。我希望审查者仔细检查 immediates 偏移量和大小相关的代码，以防我遗漏了什么。<p>以下是一些运行示例的截图：</p><img alt="screenshot-2025-12-24-at-16 47 22@2x" height=1040 src=https://github.com/user-attachments/assets/83dcf4c8-69f5-480a-b724-86598530f25a width=1470><img alt="screenshot-2025-12-24-at-16 48 44@2x" height=1040 src=https://github.com/user-attachments/assets/46d897fa-1ab2-44ef-8055-fe2fce740dbc width=1470><img alt="screenshot-2025-12-24-at-16 49 10@2x" height=1040 src=https://github.com/user-attachments/assets/6ae7a9bf-0473-4800-8dfc-233a6a41d6df width=1470><img alt="screenshot-2025-12-24-at-16 49 31@2x" height=1040 src=https://github.com/user-attachments/assets/89f84a26-cfbd-4196-bca8-111c3d20ba7b width=1470><h2 id=yi-zhi-wen-ti>已知问题</h2><blockquote><p>[!NOTE]<p>当前没有已知问题。之前的所有问题都已解决。</blockquote><ul><li><input checked disabled type=checkbox> enable extensions 无法在 naga oil 中以允许在组合模块中使用的方式编写。</ul><p>更新：通过在 naga-oil 中引入一个标志来修复，该标志在使用 bevy_solari 时强制着色器在组合模块中允许光线查询。这是临时解决方案，在 WESL 未来版本中会有所不同。<details><summary>旧的解释</summary> 这导致 solari 在 NVIDIA 上无法工作（solari 在 macOS M1 上运行成功），因为它需要 `enable wgpu_ray_query;`。将声明放在 `#define_import_path` 之前意味着它会被剥离（据我所知），而放在之后会导致： <pre style=color:#61676c;background-color:#fafafa><code><span>error: expected global declaration, but found a global directive
</span><span>  ┌─ embedded://bevy_solari/scene/raytracing_scene_bindings.wgsl:3:1
</span><span>  │
</span><span>3 │ enable wgpu_ray_query;
</span><span>  │ ^^^^^^ written after first global declaration
</span><span>  │
</span><span>  = expected global declaration, but found a global directive
</span></code></pre></details><ul><li><input checked disabled type=checkbox> dlss_wgpu 混合了 API，现在会导致 panic。</ul><details><summary>之前 dlss_wgpu 修复时的注释</summary> <p>wgpu 发布说明没有提及是哪个PR引入了此更改，只是说：</p> <blockquote><p>现在，在同一编码器上同时使用 wgpu 命令编码 API 和 CommandEncoder::as_hal_mut 将导致 panic。</blockquote> <p>它是由 https://github.com/gfx-rs/wgpu/pull/8373 引起的，该PR声称不知道任何使用场景：</p> <blockquote><p>使用记录完成时，命令缓冲区上的实际顺序非常违反直觉（所有 as_hal 会先出现），而且我认为在某些方面它根本就是坏的。<ul><li>https://discord.com/channels/691052431525675048/743663924229963868/1453786307099758683</ul></blockquote> <p>可能的解决方法是使用多个命令缓冲区：https://discord.com/channels/691052431525675048/743663924229963868/1453795633503670415</p> <h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2> <p>这个PR的核心任务是升级Bevy的图形后端依赖wgpu从版本27到版本28。wgpu是Rust生态中一个重要的图形抽象层，它提供了跨平台的图形API（如Vulkan、Metal、DirectX 12）访问。对于Bevy这样的游戏引擎，保持与最新wgpu版本的同步至关重要，因为它意味着可以获取最新的性能优化、bug修复以及新特性支持，同时确保与未来驱动和操作系统的兼容性。</p> <p>升级过程并非简单地修改版本号。wgpu 28引入了一些破坏性变更（breaking changes），这些变更影响了Bevy渲染器的多个层面。开发者必须系统地识别并适应这些变更，确保引擎的所有功能在新技术栈上正常运行。这包括更新渲染管线描述符、适配器信息查询、错误处理机制以及着色器中的语法。</p> <p>首先，开发者面对的第一个变更是<code>MipmapFilterMode</code>从<code>FilterMode</code>中分离。在wgpu 28之前，mipmap过滤模式与纹理过滤模式共享同一个枚举类型。但根据WebGPU规范，它们是独立的类型，即使枚举值相同。因此，解决方案是为这两个类型实现<code>From</code> trait，确保现有代码能够无缝转换。这个变更影响了所有创建采样器（sampler）的代码，例如在抗锯齿、后期处理、材质系统中，需要将<code>FilterMode::Linear</code>等替换为<code>MipmapFilterMode::Linear</code>。</p> <p>第二个重大变更是Push Constants被重命名为Immediates，并且其API发生了改变。在wgpu 27中，管线布局描述符（PipelineLayoutDescriptor）包含一个<code>push_constant_ranges</code>字段，它是一个<code>PushConstantRange</code>的向量。在wgpu 28中，这个字段被替换为一个<code>immediate_size</code>（u32）字段，表示立即值数据的总大小。相应地，在渲染或计算通道中设置这些数据的方法也从<code>set_push_constants</code>改为<code>set_immediates</code>。这个变更影响深远，因为它触及了所有使用push constants的渲染和计算管线，包括meshlet剔除、线框渲染、GPU预处理等。开发者需要更新所有相关的位置，将原来的<code>push_constant_ranges</code>向量替换为计算出的总大小（通常是将所有范围的大小累加），并将<code>set_push_constants</code>调用改为<code>set_immediates</code>。这里需要注意偏移量的计算，开发者最初错误地认为<code>set_immediates</code>的参数是大小而非偏移量，后来进行了修正。</p> <p>第三个变更涉及功能（Capabilities）枚举的名称。wgpu 28重新组织并重命名了许多功能标志，以更好地反映WebGPU规范。Bevy的着色器缓存系统需要将wgpu的<code>Features</code>映射到naga的<code>Capabilities</code>。开发者从wgpu源代码中获取了最新的映射列表，并更新了<code>shader_cache.rs</code>中的<code>get_capabilities</code>函数。这个映射确保了着色器编译时能够正确启用或禁用特定的硬件功能。</p> <p>第四个变更是子组（subgroup）大小信息从<code>Limits</code>结构体移到了<code>AdapterInfo</code>中。子组是GPU并行执行的一个概念，与性能优化相关。开发者更新了渲染器初始化代码，从适配器信息中获取这些值，并相应地调整了<code>WgpuLimits</code>结构体的字段。</p> <p>第五个变更是渲染通道描述符（RenderPassDescriptor）新增了一个<code>multiview_mask</code>字段，用于多视图渲染（如VR）。由于Bevy目前不使用此功能，开发者将其设置为<code>None</code>。这需要在所有创建渲染通道的地方添加这个字段，涉及大量的渲染节点（Node）实现。</p> <p>第六个变更是错误处理（error scope）的API从基于作用域（scope）的模式改为基于守卫（guard）的模式。原来调用<code>push_error_scope</code>会返回一个未来（Future），现在则返回一个守卫对象，必须保留该对象并在适当时候调用<code>pop</code>方法。这个变更确保了错误处理资源的正确释放。</p> <p>除了这些主要的API变更，升级还涉及到其他调整，例如<code>enumerate_adapters</code>方法现在返回一个Future（在非WebAssembly目标上），需要异步处理；<code>wgpu-types</code>和<code>naga</code>等依赖也需要同步升级到版本28；一些第三方crate如<code>dlss_wgpu</code>和<code>naga_oil</code>也需要相应的版本更新或补丁。</p> <p>整个升级过程展示了如何在大型代码库中协调依赖更新。开发者采用了分而治之的策略，将变更按功能分组提交，便于审查和测试。最终，通过更新89个crate文件和2个示例文件，Bevy成功迁移到了wgpu 28，为后续利用新特性（如网格着色器）奠定了基础。</p> <h2 id=visual-representation>Visual Representation</h2> <pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[wgpu 28 API Changes] --> B[MipmapFilterMode分离]
</span><span>    A --> C[Push Constants重命名为Immediates]
</span><span>    A --> D[Capabilities名称变更]
</span><span>    A --> E[subgroup大小移至AdapterInfo]
</span><span>    A --> F[multiview_mask字段]
</span><span>    A --> G[error scope改为guard]
</span><span>
</span><span>    B --> H[采样器创建代码]
</span><span>    C --> I[管线布局描述符]
</span><span>    C --> J[渲染/计算通道设置]
</span><span>    D --> K[着色器缓存映射]
</span><span>    E --> L[渲染器初始化]
</span><span>    F --> M[渲染通道描述符]
</span><span>    G --> N[错误处理代码]
</span><span>
</span><span>    H --> O[抗锯齿、后期处理、材质系统]
</span><span>    I --> P[管线缓存]
</span><span>    J --> Q[Meshlet、线框、GPU预处理]
</span><span>    K --> R[着色器编译]
</span><span>    L --> S[适配器信息查询]
</span><span>    M --> T[所有渲染节点]
</span><span>    N --> U[设备错误处理]
</span></code></pre> <h2 id=key-files-changed>Key Files Changed</h2> <h3 id=crates-bevy-render-src-renderer-mod-rs-48-26><code>crates/bevy_render/src/renderer/mod.rs</code> (+48/-26)</h3> <p>此文件处理渲染器初始化和适配器选择。主要变更包括：</p> <ol><li>将<code>enumerate_adapters</code>调用改为异步（通过<code>.await</code>），并更新了相关的适配器查找逻辑。<li>更新<code>WgpuLimits</code>结构体以反映wgpu 28中的新字段，特别是将<code>subgroup_size</code>相关字段移除，因为它们已移至<code>AdapterInfo</code>。<li>更新了许多限制（limits）字段的名称，例如<code>max_push_constant_size</code>改为<code>max_immediate_size</code>，以及新增了与网格着色器（mesh shader）和任务着色器（task shader）相关的限制。</ol> <p>代码片段示例（更新limits字段）：</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 之前（wgpu 27）：
</span><span>max_push_constant_size</span><span style=color:#61676ccc>:</span><span> limits
</span><span>    </span><span style=color:#ed9366>.</span><span>max_push_constant_size
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>min</span><span>(constrained_limits</span><span style=color:#ed9366>.</span><span>max_push_constant_size)</span><span style=color:#61676ccc>,
</span><span>min_subgroup_size</span><span style=color:#61676ccc>:</span><span> limits
</span><span>    </span><span style=color:#ed9366>.</span><span>min_subgroup_size
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>max</span><span>(constrained_limits</span><span style=color:#ed9366>.</span><span>min_subgroup_size)</span><span style=color:#61676ccc>,
</span><span>max_subgroup_size</span><span style=color:#61676ccc>:</span><span> limits
</span><span>    </span><span style=color:#ed9366>.</span><span>max_subgroup_size
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>min</span><span>(constrained_limits</span><span style=color:#ed9366>.</span><span>max_subgroup_size)</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 之后（wgpu 28）：
</span><span>max_immediate_size</span><span style=color:#61676ccc>:</span><span> limits
</span><span>    </span><span style=color:#ed9366>.</span><span>max_immediate_size
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>min</span><span>(constrained_limits</span><span style=color:#ed9366>.</span><span>max_immediate_size)</span><span style=color:#61676ccc>,
</span><span style=color:#abb0b6;font-style:italic>// subgroup_size 字段已移除，不再在此设置
</span></code></pre> <h3 id=crates-bevy-render-src-render-resource-pipeline-cache-rs-19-28><code>crates/bevy_render/src/render_resource/pipeline_cache.rs</code> (+19/-28)</h3> <p>此文件管理管线缓存和布局创建。主要变更涉及将<code>push_constant_ranges</code>替换为<code>immediate_size</code>。</p> <ol><li>布局缓存（LayoutCache）的键类型从<code>(Vec&LTBindGroupLayoutId>, Vec&LTPushConstantRange>)</code>改为<code>(Vec&LTBindGroupLayoutId>, u32)</code>，其中u32是<code>immediate_size</code>。<li>在创建管线布局时，使用<code>immediate_size</code>字段而不是<code>push_constant_ranges</code>。<li>更新了渲染和计算管线描述符的处理逻辑。</ol> <p>代码片段示例（布局缓存键和创建）：</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 之前：
</span><span style=color:#fa6e32>type </span><span style=color:#399ee6>LayoutCacheKey </span><span style=color:#ed9366>= </span><span>(</span><span style=color:#55b4d4;font-style:italic>Vec</span><span>&LTBindGroupLayoutId></span><span style=color:#61676ccc>, </span><span style=color:#55b4d4;font-style:italic>Vec</span><span>&LTPushConstantRange>)</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// 之后：
</span><span style=color:#fa6e32>type </span><span style=color:#399ee6>ImmediateSize </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>u32</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>type </span><span style=color:#399ee6>LayoutCacheKey </span><span style=color:#ed9366>= </span><span>(</span><span style=color:#55b4d4;font-style:italic>Vec</span><span>&LTBindGroupLayoutId></span><span style=color:#61676ccc>,</span><span> ImmediateSize)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 在创建布局时：
</span><span style=color:#fa6e32>let</span><span> layout </span><span style=color:#ed9366>=</span><span> layout_cache</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#ed9366>&</span><span>device</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>bind_group_layout</span><span style=color:#61676ccc>,</span><span> descriptor</span><span style=color:#ed9366>.</span><span>immediate_size)</span><span style=color:#61676ccc>;
</span></code></pre> <h3 id=crates-bevy-shader-src-shader-cache-rs-60-31><code>crates/bevy_shader/src/shader_cache.rs</code> (+60/-31)</h3> <p>此文件负责着色器缓存和功能映射。主要更新了<code>get_capabilities</code>函数，以匹配wgpu 28中<code>Features</code>枚举的新名称和结构。</p> <ol><li>更新了多个功能映射，例如<code>PUSH_CONSTANT</code>改为<code>IMMEDIATES</code>。<li>添加了新的功能映射，如<code>SHADER_FLOAT16</code>、<code>TEXTURE_AND_SAMPLER_BINDING_ARRAY</code>等。<li>反映了wgpu 28中功能标志的更细粒度划分。</ol> <p>代码片段示例（部分功能映射）：</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 之前：
</span><span>capabilities</span><span style=color:#ed9366>.</span><span style=color:#f07171>set</span><span>(
</span><span>    Capabilities</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>PUSH_CONSTANT</span><span style=color:#61676ccc>,
</span><span>    features</span><span style=color:#ed9366>.</span><span style=color:#f07171>contains</span><span>(Features</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>PUSH_CONSTANTS</span><span>)</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// 之后：
</span><span>capabilities</span><span style=color:#ed9366>.</span><span style=color:#f07171>set</span><span>(
</span><span>    Capabilities</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>IMMEDIATES</span><span style=color:#61676ccc>,
</span><span>    features</span><span style=color:#ed9366>.</span><span style=color:#f07171>contains</span><span>(Features</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>IMMEDIATES</span><span>)</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre> <h3 id=crates-bevy-pbr-src-meshlet-pipelines-rs-18-66><code>crates/bevy_pbr/src/meshlet/pipelines.rs</code> (+18/-66)</h3> <p>此文件定义了meshlet渲染的管线。由于meshlet大量使用push constants（现immediates）进行剔除和调度，因此变更较多。</p> <ol><li>将所有<code>ComputePipelineDescriptor</code>和<code>RenderPipelineDescriptor</code>中的<code>push_constant_ranges</code>字段替换为<code>immediate_size</code>字段。<li>更新了相关的着色器，将<code>var&LTpush_constant></code>改为<code>var&LTimmediate></code>。</ol> <p>代码片段示例（管线描述符变更）：</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 之前：
</span><span>push_constant_ranges</span><span style=color:#61676ccc>: </span><span style=color:#f07171>vec!</span><span>[PushConstantRange {
</span><span>    stages</span><span style=color:#61676ccc>: </span><span>ShaderStages</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>COMPUTE</span><span style=color:#61676ccc>,
</span><span>    range</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>0</span><span style=color:#ed9366>..</span><span style=color:#ff8f40>4</span><span style=color:#61676ccc>,
</span><span>}]</span><span style=color:#61676ccc>,
</span><span style=color:#abb0b6;font-style:italic>// 之后：
</span><span>immediate_size</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>4</span><span style=color:#61676ccc>,
</span></code></pre> <h3 id=crates-bevy-solari-src-realtime-node-rs-12-14><code>crates/bevy_solari/src/realtime/node.rs</code> (+12/-14)</h3> <p>此文件包含Solari实时光照节点的实现。它使用了计算着色器和immediates（原push constants）来传递帧索引和重置标志。</p> <ol><li>将<code>PushConstantRange</code>的使用替换为<code>immediate_size</code>。<li>将<code>set_push_constants</code>调用改为<code>set_immediates</code>。</ol> <p>代码片段示例：</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 之前：
</span><span>push_constant_ranges</span><span style=color:#61676ccc>: </span><span style=color:#f07171>vec!</span><span>[PushConstantRange {
</span><span>    stages</span><span style=color:#61676ccc>: </span><span>ShaderStages</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>COMPUTE</span><span style=color:#61676ccc>,
</span><span>    range</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>0</span><span style=color:#ed9366>..</span><span style=color:#ff8f40>8</span><span style=color:#61676ccc>,
</span><span>}]</span><span style=color:#61676ccc>,
</span><span style=color:#abb0b6;font-style:italic>// 之后：
</span><span>immediate_size</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>8</span><span style=color:#61676ccc>,
</span></code></pre> <p>以及：</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 之前：
</span><span>pass</span><span style=color:#ed9366>.</span><span style=color:#f07171>set_push_constants</span><span>(
</span><span>    </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>,
</span><span>    bytemuck</span><span style=color:#ed9366>::</span><span>cast_slice(</span><span style=color:#ed9366>&</span><span>[frame_index</span><span style=color:#61676ccc>,</span><span> solari_lighting</span><span style=color:#ed9366>.</span><span>reset </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>u32</span><span>])</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// 之后：
</span><span>pass</span><span style=color:#ed9366>.</span><span style=color:#f07171>set_immediates</span><span>(
</span><span>    </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>,
</span><span>    bytemuck</span><span style=color:#ed9366>::</span><span>cast_slice(</span><span style=color:#ed9366>&</span><span>[frame_index</span><span style=color:#61676ccc>,</span><span> solari_lighting</span><span style=color:#ed9366>.</span><span>reset </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>u32</span><span>])</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre> <h2 id=further-reading>Further Reading</h2> <ul><li><a rel="noopener nofollow noreferrer" href=https://github.com/gfx-rs/wgpu/releases/tag/v28.0.0 target=_blank>wgpu 28 发布说明</a>：了解wgpu 28的详细变更列表和新特性。<li><a rel="noopener nofollow noreferrer" href=https://www.w3.org/TR/webgpu/ target=_blank>WebGPU 规范</a>：理解API设计背后的原理，特别是Immediates和MipmapFilterMode的变化。<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/getting-started/systems/ target=_blank>Bevy 渲染架构</a>：熟悉Bevy的渲染器如何组织渲染图、管线和资源。<li><a rel="noopener nofollow noreferrer" href=https://github.com/gfx-rs/naga target=_blank>Naga 着色器转换</a>：了解Bevy如何通过Naga处理不同着色器语言和功能映射。</ul>    <div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-01/pr_22265.patch id=patch-info style=display:none></div>  <div class=bottom-spacer></div>