<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22645 Fix artifacts when rendering large gizmos
        
    </title><meta content="#22645 Fix artifacts when rendering large gizmos" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-01/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-01-23</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-01/pr-22645-zh-cn-20260123>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix artifacts when rendering large gizmos<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22645<li><strong>Author</strong>: EmbersArc<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, S-Ready-For-Final-Review, A-Gizmos<li><strong>Created</strong>: 2026-01-22T12:32:33Z<li><strong>Merged</strong>: 2026-01-23T03:14:22Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Fixes #22580, see the issue for more information.<h2 id=solution>Solution</h2><ul><li>Bring back the EPSILON that was removed in https://github.com/bevyengine/bevy/pull/21503</ul><h2 id=testing>Testing</h2><p>Tested with the example code in the issue.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The problem started when developers reported visual artifacts when rendering large gizmos in Bevy. Specifically, lines were appearing where they shouldn’t - lines that should have been clipped at the near plane were still visible. This was tracked in issue #22580 where users provided reproducible examples showing the problem.<p>Looking at the code history, this regression was introduced in PR #21503 where an EPSILON value was removed from the line clipping logic. The original developer likely removed it thinking it was unnecessary, but as with many floating-point precision issues, the consequences only manifested under specific conditions - in this case, when rendering large-scale gizmos where the numerical precision limitations became apparent.<p>The solution was straightforward: restore the EPSILON value that had been previously removed. In the <code>clip_near_plane</code> function in the WebGPU Shading Language (WGSL) code, when interpolating between two points to find where a line intersects the near clipping plane, floating-point imprecision could cause the calculated intersection point to be slightly behind the clip plane. This meant lines that should have been fully clipped away would still have visible fragments.<p>The implementation change is minimal but critical. In the <code>lines.wgsl</code> file, the function computes an interpolation factor <code>t</code> to find where a line from point <code>a</code> to point <code>b</code> intersects the near plane. Without the epsilon, when <code>distance_a</code> and <code>distance_b</code> are very close in value (which happens with large coordinates due to floating-point precision limits), the calculation could produce a <code>t</code> value that’s mathematically correct but numerically imprecise enough to place the resulting point slightly behind the near plane instead of exactly on it.<p>By adding <code>EPSILON</code> to the interpolator, we ensure the computed point is pushed just slightly in front of the near plane, guaranteeing proper clipping behavior. This is a standard technique in computer graphics to handle floating-point precision issues near clipping boundaries.<p>The fix demonstrates an important principle in graphics programming: when dealing with floating-point calculations for visibility and clipping, small epsilon values are often necessary to account for numerical imprecision. The removal of this epsilon in PR #21503 was likely an oversight during refactoring or optimization, highlighting how seemingly innocuous changes to graphics math can have visible consequences.<p>From an engineering perspective, this fix shows the value of maintaining regression tests for graphical output and the importance of understanding the purpose of even small constants in graphics code. The EPSILON isn’t arbitrary - it serves a specific purpose in mitigating floating-point precision issues that are inherent in 3D graphics calculations.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Issue #22580: Artifacts with large gizmos] --> B[Root Cause Analysis]
</span><span>    B --> C[Traced to PR #21503]
</span><span>    C --> D[EPSILON removed from clip_near_plane]
</span><span>    D --> E[Floating-point imprecision causes incorrect clipping]
</span><span>    E --> F[Solution: Restore EPSILON]
</span><span>    F --> G[Fixed clipping behavior]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-gizmos-render-src-lines-wgsl-4-1><code>crates/bevy_gizmos_render/src/lines.wgsl</code> (+4/-1)</h3><p>This is the only file modified in the PR. It contains the WGSL shader code for rendering gizmo lines. The change is in the <code>clip_near_plane</code> function which handles clipping lines against the near plane of the view frustum.<p><strong>Key Change:</strong> The function computes where a line segment intersects the near clipping plane. The fix adds a small epsilon value to the interpolation factor to ensure numerical stability.<p><strong>Code Snippet:</strong><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// File: crates/bevy_gizmos_render/src/lines.wgsl
</span><span>// Before:
</span><span>fn clip_near_plane(a: vec4&LTf32>, b: vec4&LTf32>) -> vec4&LTf32> {
</span><span>    // ... other code ...
</span><span>    let t = distance_a / (distance_a - distance_b);
</span><span>    return mix(a, b, t);
</span><span>}
</span><span>
</span><span>// After:
</span><span>fn clip_near_plane(a: vec4&LTf32>, b: vec4&LTf32>) -> vec4&LTf32> {
</span><span>    // ... other code ...
</span><span>    // Add an epsilon to the interpolator to ensure that the point is
</span><span>    // not just behind the clip plane due to floating-point imprecision,
</span><span>    // which can lead to lines showing up where they should not.
</span><span>    let t = distance_a / (distance_a - distance_b) + EPSILON;
</span><span>    return mix(a, b, t);
</span><span>}
</span></code></pre><p>The change adds <code>+ EPSILON</code> to the calculation of <code>t</code>. The EPSILON constant is defined elsewhere in the shader (not shown in the diff) and provides a small floating-point value to offset the interpolation factor, ensuring the resulting point is safely in front of the near plane rather than potentially behind it due to floating-point rounding errors.<h2 id=further-reading>Further Reading</h2><ol><li><p><strong>Floating-Point Precision in Graphics</strong>: Understanding how floating-point imprecision affects 3D graphics calculations is fundamental. The classic reference is “What Every Computer Scientist Should Know About Floating-Point Arithmetic” by David Goldberg.</p><li><p><strong>Clipping Algorithms</strong>: The Cohen-Sutherland line clipping algorithm and its variants are standard in computer graphics. This fix relates to the numerical stability of such algorithms when implemented with floating-point arithmetic.</p><li><p><strong>WebGPU Shading Language (WGSL)</strong>: The shader language used in Bevy’s renderer. The official WGSL specification provides details on its floating-point behavior and precision guarantees.</p><li><p><strong>Bevy Gizmos System</strong>: Bevy’s gizmo rendering system provides debug visualization tools. Understanding how it integrates with Bevy’s ECS and rendering pipeline helps contextualize this fix.</p><li><p><strong>Numerical Epsilon Values</strong>: The concept of epsilon values for comparing floating-point numbers is widely used in game development and computer graphics. Different scenarios require different epsilon values based on the scale of numbers involved.</p></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-01/pr_22645.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>