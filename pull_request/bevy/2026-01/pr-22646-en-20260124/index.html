<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22646 Round sub pixel font sizes
        
    </title><meta content="#22646 Round sub pixel font sizes" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-01/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-01-24</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-01/pr-22646-zh-cn-20260124>中文</a></div></div><div class=pr-content><h1 id=round-sub-pixel-font-sizes>Round sub pixel font sizes</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Round sub pixel font sizes<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22646<li><strong>Author</strong>: ickshonpe<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Performance, S-Ready-For-Final-Review, A-Text, X-Contentious, D-Straightforward<li><strong>Created</strong>: 2026-01-22T13:03:58Z<li><strong>Merged</strong>: 2026-01-24T20:23:33Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Sub-pixel font sizes don’t provide much benefit with bitmap fonts and rounding them to the nearest pixel massively reduces the number of font atlases when a text entity’s font size is naively interpolated.<p>fixes #22626<h2 id=solution>Solution</h2><p>Round the font sizes before adding them to the Cosmic Text <code>Attrs</code>.<h2 id=testing>Testing</h2><pre style=color:#61676c;background-color:#fafafa><code><span>cargo run --example animated_ui
</span></code></pre><p>In main, the window is blank and it rapidly generates gigabytes of font atlas images.<p>With this PR, the text is visible and animated, and memory usage remains stable.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a performance issue in Bevy’s text rendering system that occurs when text font sizes are animated or interpolated. The problem manifests when font sizes change by small, sub-pixel amounts during animation, causing the system to generate an excessive number of font atlases.<p>In Bevy, font atlases are cached based on the combination of font handle and scaled font size. When text is animated and the font size changes continuously (even by tiny fractions of a pixel), each distinct font size value triggers the creation of a new font atlas. This leads to rapid memory growth - in the reported issue, gigabytes of font atlas images were being generated, eventually causing the application to become unresponsive or crash.<p>The core issue stems from how Bevy handles font size scaling. When text is rendered, the base font size is multiplied by the window scale factor and UI scale to determine the final font size used for layout and rasterization. Previously, this scaled value was passed directly to Cosmic Text (the underlying text layout engine) without rounding, resulting in many distinct font atlas entries for what are effectively the same visual appearance.<p>The fix is straightforward: round the scaled font size to the nearest whole pixel before passing it to Cosmic Text. This approach makes sense because bitmap fonts (which Bevy primarily uses for text rendering) don’t benefit from sub-pixel precision in font sizing. The visual difference between a font size of 15.1 pixels and 15.0 pixels is negligible, but treating them as different sizes has significant performance consequences.<p>The implementation modifies the <code>get_attrs</code> function in the text pipeline to round the scaled font size:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let</span><span> font_size </span><span style=color:#ed9366>= </span><span>(text_font</span><span style=color:#ed9366>.</span><span>font_size </span><span style=color:#ed9366>*</span><span> scale_factor </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>round</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><p>This simple change has a profound impact on performance. By collapsing many similar font sizes into a single integer value, the number of unique font atlas entries is dramatically reduced. The PR description notes that in the <code>animated_ui</code> example, the memory usage stabilizes and the text becomes visible and animated, whereas previously the window would go blank as the system exhausted memory generating atlas images.<p>The change also affects how line height is calculated. Since the rounded font size is now used for layout, line height calculations must be adjusted to use this rounded value rather than the original unrounded font size. This ensures consistency between font size and line spacing in the rendered text.<p>One important consideration is that this change represents a trade-off: we sacrifice the theoretical possibility of sub-pixel font sizing for substantial performance gains. This is a reasonable trade-off because:<ol><li>Bitmap fonts don’t actually render differently at sub-pixel sizes<li>The performance impact of not rounding is severe in common use cases (animations, interpolations)<li>The visual difference is imperceptible in practice</ol><p>The PR also includes documentation updates to clarify that font sizes are rounded after scaling, helping future developers understand this aspect of Bevy’s text rendering behavior.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[TextFont.font_size] --> B[Multiply by scale_factor]
</span><span>    B --> C{Round to nearest pixel?}
</span><span>    C -->|No (before PR)| D[Many distinct font atlas entries]
</span><span>    C -->|Yes (after PR)| E[Fewer distinct font atlas entries]
</span><span>    D --> F[Performance issues: memory exhaustion]
</span><span>    E --> G[Stable performance]
</span><span>    
</span><span>    H[LineHeight calculation] --> I{Use original or rounded font_size?}
</span><span>    I -->|Original (before PR)| J[Inconsistent with actual font size]
</span><span>    I -->|Rounded (after PR)| K[Consistent with actual font size]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-text-src-pipeline-rs-10-7><code>crates/bevy_text/src/pipeline.rs</code> (+10/-7)</h3><p>This file contains the main logic change for rounding font sizes. The <code>get_attrs</code> function is modified to round the scaled font size and adjust line height calculation accordingly.<p><strong>Key changes:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#ed9366>.</span><span style=color:#f07171>metrics</span><span>(
</span><span>    Metrics {
</span><span>        font_size</span><span style=color:#61676ccc>:</span><span> text_font</span><span style=color:#ed9366>.</span><span>font_size</span><span style=color:#61676ccc>,
</span><span>        line_height</span><span style=color:#61676ccc>:</span><span> line_height</span><span style=color:#ed9366>.</span><span style=color:#f07171>eval</span><span>(text_font</span><span style=color:#ed9366>.</span><span>font_size)</span><span style=color:#61676ccc>,
</span><span>    }
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>scale</span><span>(scale_factor </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32</span><span>)</span><span style=color:#61676ccc>,
</span><span>)
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> font_size </span><span style=color:#ed9366>= </span><span>(text_font</span><span style=color:#ed9366>.</span><span>font_size </span><span style=color:#ed9366>*</span><span> scale_factor </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>round</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> line_height </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>match</span><span> line_height {
</span><span>    LineHeight</span><span style=color:#ed9366>::</span><span>Px(px) </span><span style=color:#ed9366>=></span><span> px </span><span style=color:#ed9366>*</span><span> scale_factor </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32</span><span style=color:#61676ccc>,
</span><span>    LineHeight</span><span style=color:#ed9366>::</span><span>RelativeToFont(s) </span><span style=color:#ed9366>=></span><span> s </span><span style=color:#ed9366>*</span><span> font_size</span><span style=color:#61676ccc>,
</span><span>}</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#ed9366>.</span><span style=color:#f07171>metrics</span><span>(Metrics {
</span><span>    font_size</span><span style=color:#61676ccc>,
</span><span>    line_height</span><span style=color:#61676ccc>,
</span><span>})
</span></code></pre><p>The change replaces the previous approach of scaling the entire <code>Metrics</code> struct with explicit calculation of rounded font size and line height. This ensures that both font size and line height use the same rounded value for consistent layout.<h3 id=crates-bevy-text-src-text-rs-3-11><code>crates/bevy_text/src/text.rs</code> (+3/-11)</h3><p>This file contains documentation updates and removal of unused code. The <code>LineHeight::eval</code> method is removed since it’s no longer used after the refactoring in <code>pipeline.rs</code>.<p><strong>Key changes:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Documentation update for TextFont::font_size field:
</span><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#abb0b6;font-style:italic>/// This is multiplied by the window scale factor and `UiScale`, but not the text entity
</span><span style=color:#abb0b6;font-style:italic>/// transform or camera projection.
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#abb0b6;font-style:italic>/// This is multiplied by the window scale factor and `UiScale`, but not the text entity's
</span><span style=color:#abb0b6;font-style:italic>/// transform or camera projection. Then, the scaled font size is rounded to the nearest pixel
</span><span style=color:#abb0b6;font-style:italic>/// to produce the final font size used during glyph layout.
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Removal of unused LineHeight::eval method:
</span><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>impl </span><span style=color:#399ee6>LineHeight </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>eval</span><span>(</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>font_size</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>f32 </span><span>{
</span><span>        </span><span style=color:#fa6e32>match </span><span style=color:#55b4d4;font-style:italic>self </span><span>{
</span><span>            LineHeight</span><span style=color:#ed9366>::</span><span>Px(px) </span><span style=color:#ed9366>=></span><span> px</span><span style=color:#61676ccc>,
</span><span>            LineHeight</span><span style=color:#ed9366>::</span><span>RelativeToFont(scale) </span><span style=color:#ed9366>=></span><span> scale </span><span style=color:#ed9366>*</span><span> font_size</span><span style=color:#61676ccc>,
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: (method completely removed)
</span></code></pre><p>The documentation update is crucial for understanding the font size rounding behavior, while removing the unused <code>eval</code> method cleans up the codebase.<h2 id=further-reading>Further Reading</h2><ol><li><strong>Bevy Text Rendering Documentation</strong>: The official Bevy documentation on text rendering and font atlases<li><strong>Cosmic Text</strong>: The text layout engine used by Bevy (https://github.com/pop-os/cosmic-text)<li><strong>Font Atlas Management</strong>: General techniques for optimizing font atlas usage in game engines<li><strong>Issue #22626</strong>: The original issue report that prompted this fix, providing context on the specific performance problem<li><strong>Bitmap Font Rendering</strong>: Technical details on how bitmap fonts differ from vector fonts in terms of scaling and sub-pixel precision</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-01/pr_22646.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>