<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22377 Shadow mapping in distance fog
        
    </title><meta content="#22377 Shadow mapping in distance fog" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-01/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-01-04</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-01/pr-22377-zh-cn-20260104>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>Shadow mapping in distance fog<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Shadow mapping in distance fog<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22377<li><strong>Author</strong>: mate-h<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, S-Ready-For-Final-Review, D-Straightforward, M-Deliberate-Rendering-Change<li><strong>Created</strong>: 2026-01-04T20:41:23Z<li><strong>Merged</strong>: 2026-01-04T21:48:51Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p><strong>Objective</strong><ul><li>Fixes https://github.com/bevyengine/bevy/issues/22375</ul><p><strong>Solution</strong><ul><li>For each directional light with shadows enabled, we sample the shadow map at the fragment’s world position. The shadow factor (0.0 = fully shadowed, 1.0 = fully lit) attenuates the inscattering contribution for the mie scattering component.</ul><p><strong>Testing</strong><ul><li>Ran the <code>atmospheric_fog</code> example with and without the shadows_enabled flag</ul><hr><p><strong>Showcase</strong><p>before</p><img alt=image height=1446 src=https://github.com/user-attachments/assets/92d80c85-a4d3-48cf-8974-4dece7ed8027 width=2562><p>after</p><img alt=image height=1444 src=https://github.com/user-attachments/assets/aae98ca3-a20e-49f3-8dfd-914e710dcdc0 width=2566><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a visual inconsistency in Bevy’s atmospheric fog rendering. The issue was straightforward: when directional lights cast shadows, the fog scattering calculation didn’t account for those shadows, resulting in unrealistic lighting where shadowed areas still appeared to have full fog illumination.<p>The problem originated in the shader code for fog calculations. Atmospheric fog in Bevy uses a mie scattering model that simulates how light scatters through particles in the atmosphere. This scattering is directional and depends on the angle between the view direction and light direction. However, the original implementation didn’t check whether a fragment was in shadow when calculating this scattering contribution.<p>The solution implemented is direct and practical. For each directional light with shadows enabled, the shader now samples the shadow map at the fragment’s world position. The shadow factor (ranging from 0.0 for fully shadowed to 1.0 for fully lit) is then used to attenuate the inscattering contribution. This means that areas in shadow receive less fog scattering, which matches physical reality and creates more convincing atmospheric effects.<p>From an implementation perspective, the changes are minimal and focused. The main modification happens in the <code>apply_fog</code> function within the WGSL shader code. The developer added three key calculations:<ol><li>Computing the view-space Z coordinate for shadow cascade selection<li>Calculating a view direction normal for shadow sampling<li>Sampling the shadow map for each directional light with shadows enabled</ol><p>The approach uses existing infrastructure - the <code>shadows::fetch_directional_shadow</code> function was already available in Bevy’s shader modules. This function handles the complexity of cascade shadow mapping, selecting the appropriate shadow map cascade based on the fragment’s view-space depth and sampling the shadow map with proper bias and filtering.<p>One important consideration in this implementation is the use of the view direction as an approximation for surface normal during shadow sampling. Since fog is a volumetric effect that doesn’t have a true surface normal, using the view direction (the normalized vector from the fragment to the camera) provides a reasonable approximation for shadow cascade selection. This is a practical trade-off that works well for atmospheric effects.<p>The impact of this change is purely visual but significant for scene realism. Before the fix, shadowed areas would have the same fog scattering as lit areas, which broke the illusion of light interacting with atmospheric particles. After the fix, fog correctly darkens in shadowed regions, creating more believable outdoor scenes with proper depth cues and atmospheric perspective.<p>From a performance standpoint, the change adds shadow map sampling for each directional light with shadows enabled during fog calculations. This is a reasonable cost given that fog is typically applied to many fragments in a scene, and shadow sampling is already a common operation in deferred rendering pipelines. The implementation is efficient because it reuses existing shadow sampling infrastructure and only performs the additional work when lights have shadows enabled.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Fragment World Position] --> B[Calculate View Position]
</span><span>    B --> C[Get View Z for Cascade Selection]
</span><span>    A --> D[Calculate View Direction Normal]
</span><span>    C --> E[Shadow Sampling]
</span><span>    D --> E
</span><span>    E --> F[Get Shadow Factor]
</span><span>    G[Light Properties] --> H[Calculate Scattering Contribution]
</span><span>    F --> I[Attenuate Scattering by Shadow Factor]
</span><span>    H --> I
</span><span>    I --> J[Final Fog Scattering]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-pbr-src-render-pbr-functions-wgsl><code>crates/bevy_pbr/src/render/pbr_functions.wgsl</code></h3><p><strong>What changed and why</strong>: Modified the <code>apply_fog</code> function to incorporate shadow mapping for directional lights when calculating fog scattering. This fixes the visual issue where fog appeared equally bright in shadowed and lit areas.<p><strong>Key modifications</strong>:<p>The changes add shadow map sampling for directional lights in the fog scattering calculation:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>scattering += pow(
</span><span>    max(
</span><span>        dot(view_to_world_normalized, light.direction_to_light),
</span><span>        0.0
</span><span>    ),
</span><span>    fog_params.directional_light_exponent
</span><span>) * light.color.rgb * view_bindings::view.exposure;
</span><span>
</span><span>// After:
</span><span>let scattering_contribution = pow(
</span><span>    max(
</span><span>        dot(view_to_world_normalized, light.direction_to_light),
</span><span>        0.0
</span><span>    ),
</span><span>    fog_params.directional_light_exponent
</span><span>) * light.color.rgb * view_bindings::view.exposure;
</span><span>
</span><span>// Sample shadow map to attenuate inscattering in shadowed areas
</span><span>var shadow: f32 = 1.0;
</span><span>if ((light.flags & mesh_view_types::DIRECTIONAL_LIGHT_FLAGS_SHADOWS_ENABLED_BIT) != 0u) {
</span><span>    shadow = shadows::fetch_directional_shadow(i, fragment_world_position_vec4, view_direction_normal, view_z);
</span><span>}
</span><span>scattering += scattering_contribution * shadow;
</span></code></pre><p><strong>Additional setup code added</strong>:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Calculate view_z for shadow cascade selection
</span><span>let view_pos = view_transformations::position_world_to_view(fragment_world_position);
</span><span>let view_z = view_pos.z;
</span><span>
</span><span>// Approximate surface normal using view direction for shadow sampling
</span><span>let view_direction_normal = normalize(-view_to_world);
</span><span>let fragment_world_position_vec4 = vec4&LTf32>(fragment_world_position, 1.0);
</span></code></pre><p><strong>How these changes relate to the overall purpose</strong>: These modifications enable the fog scattering calculation to respect shadows cast by directional lights, making atmospheric effects more physically accurate and visually consistent with the scene lighting.<h2 id=further-reading>Further Reading</h2><p>For more information on the concepts and techniques used in this PR:<ol><li><strong>Atmospheric Scattering Models</strong>: Learn about mie scattering and rayleigh scattering models used in real-time atmospheric rendering<li><strong>Cascade Shadow Mapping</strong>: Understand how shadow maps are organized into cascades for efficient rendering at different distances<li><strong>WGSL Shader Programming</strong>: Bevy uses WebGPU Shader Language (WGSL) for its shaders<li><strong>Volumetric Fog Techniques</strong>: Various approaches to rendering convincing atmospheric effects in real-time graphics</ol><p>Relevant Bevy documentation:<ul><li>Bevy’s PBR rendering pipeline<li>Shadow mapping implementation in Bevy<li>Atmospheric fog features in the Bevy renderer</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-01/pr_22377.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>