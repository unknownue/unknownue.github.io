<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22226 Optimize Visibility Systems
        
    </title><meta content="#22226 Optimize Visibility Systems" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-01/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-01-01</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-01/pr-22226-zh-cn-20260101>中文</a></div></div><div class=pr-content><h1 id=optimize-visibility-systems>Optimize Visibility Systems</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Optimize Visibility Systems<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22226<li><strong>Author</strong>: aevyrie<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, C-Performance, S-Ready-For-Final-Review, P-Regression<li><strong>Created</strong>: 2025-12-22T02:04:27Z<li><strong>Merged</strong>: 2026-01-01T22:25:12Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Make visibility systems less slow.<li>Saves as much as 1.2ms of CPU time on a (GPU bound) 6.7ms frame, rendering caldera hotel.<li>Fixes #22256</ul><h2 id=solution>Solution</h2><ul><li>Replace the <code>EntityHashSet</code> with a component added directly to entities. This still allows for correct change detection triggers on visibility, but avoids hashing. This also enables parallel updates.</ul><h2 id=summary>Summary</h2><ul><li>This PR lead to a rabbit hole that uncovered #22256<li>This PR resolves the regression introduced since 0.17 released<li>A more fair comparison is not to main (which has a regression), but to 0.17<li>Compared to 0.17.3, this is a 27% speedup to the <code>PostUpdate</code> schedule for caldera hotel on an M4 Max</ul><img alt=image height=251 src=https://github.com/user-attachments/assets/2d711e3c-b65e-4c3a-9d2a-a587f8f36aae width=558><h2 id=testing>Testing</h2><ul><li>Many cubes, many foxes, caldera<li>Yellow is new, red is old.<li>Note the bimodality in the old traces, this was consistently repeatable, and seems to have something to do with <code>EntityHashSet</code> and <code>EntityHashMap</code>. Worth investigating that further, as I’ve seen that bimodal behavior before, and blamed it on pcores vs ecores, but I verified that is not happening.<li>Summary: caldera hotel no longer exhibits bimodal performance with a pathological mode that runs very slowly. Roughly comparing the ~90th percentile performance, the optimized code is about 1.2ms faster. This is particularly significant when you consider this is running on a device that is already hitting 150fps (GPU bound), so it only has a frame budget of 6.7ms.<li>Notably, visibility checking was the last egregiously performing set of systems in the common hot path of most bevy apps, and no longer stick out as obviously slow in a frame profile:</ul><p>A high level comparison of the change in CPU time by looking at just PostUpdate between old(red) and new(yellow)</p><img alt=image height=512 src=https://github.com/user-attachments/assets/5252ff0f-d9f3-49d1-a3ce-309bd84d5485 width=1738><h3 id=caldera-hotel-all-entities-in-view>caldera hotel - all entities in view</h3><p>For this test, I didn’t touch the camera, so all entities were in view at all times.<p><code>check_visibility</code></p><img alt=image height=397 src=https://github.com/user-attachments/assets/c80c470a-1548-42d2-838c-4e74525a6cb8 width=1262><p><code>reset_view_visibility</code></p><img alt=image height=407 src=https://github.com/user-attachments/assets/7b550823-f832-41f1-9e42-20cab342b0f2 width=1262><p><code>mark_newly_hidden_entities_invisible</code><p>This is 23us slower than the “fast mode” of the existing code on main, but 180-250us <em>faster</em> than the weird “slow mode” on main. The new code is significantly more stable, and does not exhibit the super slow mode.</p><img alt=image height=418 src=https://github.com/user-attachments/assets/b7cbf57d-a221-468a-9af8-3381981874b2 width=1256><h3 id=caldera-hotel-no-entities-in-view>caldera hotel - no entities in view</h3><p>For this test, I immediately rotated the camera so the hotel was not in view.<p><code>check_visibility</code><p>This is largely a wash. The old code is 2us faster, but this is likely in the realm of noise.</p><img alt=image height=372 src=https://github.com/user-attachments/assets/2c795f72-ebea-4b35-ba19-a8eccd4c56fc width=1255><p><code>reset_view_visibility</code><p>This is a big win. The main peak is about 30us faster now, but the major win is the worst case, which is nearly 500us faster.</p><img alt=image height=398 src=https://github.com/user-attachments/assets/f8a9d99f-a6e1-48db-8639-d52276dba9ab width=1252><p><code>mark_newly_hidden_entities_invisible</code><p>Same story as the other caldera comparison with everything in view, this is a bit slower than the fast mode, but way faster than the slow mode on main.</p><img alt=image height=400 src=https://github.com/user-attachments/assets/4564d94e-911a-4b3f-a584-c6e102ef2dd0 width=1248><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The visibility systems in Bevy were showing significant performance issues, particularly in complex scenes like Caldera Hotel. The problem manifested as bimodal performance - sometimes running fast, other times hitting a pathological slow mode that could consume up to 1.2ms of CPU time in a 6.7ms frame. This was especially problematic because visibility systems run in the hot path of most Bevy applications, and this regression had been introduced since version 0.17.<p>The root cause was the use of <code>EntityHashSet</code> to track visible entities from the previous frame. The system worked by maintaining a global <code>PreviousVisibleEntities</code> resource that stored all entities visible in the last frame. During each frame, visibility checking systems would remove entities they judged visible from this set, and at the end, any remaining entities (those that were visible last frame but not this frame) would be marked as hidden. This approach had several problems:<ol><li><strong>Hashing overhead</strong>: Every entity visibility check required hash operations on the EntityHashSet<li><strong>Single-threaded constraints</strong>: The global resource couldn’t be easily parallelized<li><strong>Bimodal performance</strong>: The hash set operations exhibited inconsistent performance characteristics</ol><p>The solution was to move from a centralized hash set to a distributed component-based approach. Instead of tracking visible entities in a global set, each entity now stores its own visibility history directly in the <code>ViewVisibility</code> component using bit-packed state. The implementation uses a single <code>u8</code> where:<ul><li>Bit 0: Current visibility (1 = visible, 0 = hidden)<li>Bit 1: Previous frame’s visibility</ul><p>This bit-packing approach enables several optimizations:<ul><li>No hashing overhead since we’re working directly with component data<li>Parallel processing because each entity’s visibility state is independent<li>Reduced memory footprint compared to maintaining a separate hash set</ul><p>The visibility pipeline was restructured into three main phases:<ol><li><p><strong>Reset phase</strong>: At the start of each frame, <code>reset_view_visibility</code> copies the current visibility bit to the previous visibility bit and clears the current bit. This runs in parallel across all entities.</p><li><p><strong>Marking phase</strong>: Visibility checking systems (for cameras, lights, etc.) call <code>set_visible()</code> on entities they determine to be visible. This only sets the current bit to 1 if it wasn’t already set, avoiding unnecessary change detection triggers.</p><li><p><strong>Cleanup phase</strong>: <code>mark_newly_hidden_entities_invisible</code> runs in parallel, checking for entities where the previous bit is 1 (was visible last frame) but the current bit is 0 (not marked visible this frame). These entities are set to <code>ViewVisibility::HIDDEN</code>, triggering change detection only when visibility actually changes.</p></ol><p>The key insight was realizing that while it’s easy to determine if an entity is visible to something (multiple systems can set the visibility flag), it’s harder to determine if an entity is globally non-visible. The bit-packing approach solves this by letting each entity track its own visibility history.<p>This change also required updating the light systems to use the new <code>SetViewVisibility</code> trait. Previously, light visibility systems had to coordinate with the global <code>PreviousVisibleEntities</code> resource, removing entities they marked as visible. Now they simply call <code>set_visible()</code> on the component, which is more efficient and enables better parallelism.<p>The performance improvements are substantial:<ul><li>27% speedup in the PostUpdate schedule compared to 0.17.3<li>Elimination of the bimodal performance pattern<li>More consistent frame times<li>Better scaling with entity count due to parallel processing</ul><p>This optimization is particularly important for GPU-bound applications where CPU time is at a premium. By reducing visibility system overhead from 1.2ms to negligible levels, more CPU time is available for game logic and other systems.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[reset_view_visibility&LTbr/>Parallel update] --> B[Visibility Check Systems&LTbr/>Cameras, Lights, etc.]
</span><span>    B --> C[mark_newly_hidden_entities_invisible&LTbr/>Parallel cleanup]
</span><span>    
</span><span>    subgraph "ViewVisibility Component"
</span><span>        D[Bit 0: Current visibility] --> E[Bit 1: Previous visibility]
</span><span>    end
</span><span>    
</span><span>    A --> D
</span><span>    B --> D
</span><span>    C --> D
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-camera-src-visibility-mod-rs-77-79><code>crates/bevy_camera/src/visibility/mod.rs</code> (+77/-79)</h3><p>This file contains the core visibility system implementation. The changes completely rework how visibility state is tracked and managed.<p><strong>Key Changes:</strong><ol><li><strong>ViewVisibility component redesign</strong>: Changed from a simple boolean wrapper to a bit-packed u8 storing current and previous visibility states.<li><strong>Removed PreviousVisibleEntities resource</strong>: Eliminated the global EntityHashSet in favor of distributed component storage.<li><strong>Added SetViewVisibility trait</strong>: Provides a clean API for systems to mark entities as visible while avoiding unnecessary change detection.<li><strong>Parallelized systems</strong>: Both <code>reset_view_visibility</code> and <code>mark_newly_hidden_entities_invisible</code> now use parallel iteration.</ol><p><strong>Code Snippets:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Simple boolean wrapper
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component</span><span style=color:#61676ccc>,</span><span> Deref</span><span style=color:#61676ccc>,</span><span> Debug</span><span style=color:#61676ccc>,</span><span> Default</span><span style=color:#61676ccc>,</span><span> Clone</span><span style=color:#61676ccc>,</span><span> Copy</span><span style=color:#61676ccc>,</span><span> Reflect</span><span style=color:#61676ccc>,</span><span> PartialEq</span><span style=color:#61676ccc>,</span><span> Eq)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>reflect</span><span>(Component</span><span style=color:#61676ccc>,</span><span> Default</span><span style=color:#61676ccc>,</span><span> Debug</span><span style=color:#61676ccc>,</span><span> PartialEq</span><span style=color:#61676ccc>,</span><span> Clone)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>ViewVisibility</span><span>(</span><span style=color:#fa6e32>bool</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Bit-packed u8 with current and previous visibility
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component</span><span style=color:#61676ccc>,</span><span> Debug</span><span style=color:#61676ccc>,</span><span> Default</span><span style=color:#61676ccc>,</span><span> Clone</span><span style=color:#61676ccc>,</span><span> Copy</span><span style=color:#61676ccc>,</span><span> Reflect</span><span style=color:#61676ccc>,</span><span> PartialEq</span><span style=color:#61676ccc>,</span><span> Eq)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>reflect</span><span>(Component</span><span style=color:#61676ccc>,</span><span> Default</span><span style=color:#61676ccc>,</span><span> Debug</span><span style=color:#61676ccc>,</span><span> PartialEq</span><span style=color:#61676ccc>,</span><span> Clone)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>ViewVisibility</span><span>(
</span><span>    </span><span style=color:#abb0b6;font-style:italic>/// Bit packed booleans to track current and previous view visibility state.
</span><span>    </span><span style=color:#fa6e32>u8</span><span>,
</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>impl </span><span style=color:#399ee6>ViewVisibility </span><span>{
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>inline</span><span>]
</span><span>    </span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>get</span><span>(</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>bool </span><span>{
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0 </span><span style=color:#ed9366>& </span><span style=color:#ff8f40>1 </span><span style=color:#ed9366>!= </span><span style=color:#ff8f40>0
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>inline</span><span>]
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>was_visible_now_hidden</span><span>(</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>bool </span><span>{
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0 </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0b10
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>inline</span><span>]
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>update</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>) {
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0 </span><span style=color:#ed9366>= </span><span>(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0 </span><span style=color:#ed9366>& !</span><span style=color:#ff8f40>2</span><span>) </span><span style=color:#ed9366>| </span><span>((</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0 </span><span style=color:#ed9366>& </span><span style=color:#ff8f40>1</span><span>) </span><span style=color:#ed9366><< </span><span style=color:#ff8f40>1</span><span>)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Global resource tracking all visible entities
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Resource</span><span style=color:#61676ccc>,</span><span> Default</span><span style=color:#61676ccc>,</span><span> Deref</span><span style=color:#61676ccc>,</span><span> DerefMut)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>PreviousVisibleEntities</span><span>(EntityHashSet)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: No global resource needed - state distributed across components
</span></code></pre><h3 id=crates-bevy-light-src-lib-rs-19-47><code>crates/bevy_light/src/lib.rs</code> (+19/-47)</h3><p>This file contains light visibility systems that needed updating to work with the new component-based approach.<p><strong>Key Changes:</strong><ol><li><strong>Removed PreviousVisibleEntities dependency</strong>: Light systems no longer need to coordinate with the global resource.<li><strong>Updated to use SetViewVisibility trait</strong>: Simplified visibility marking with <code>set_visible()</code> method.<li><strong>Removed entity removal logic</strong>: No longer need to manually remove entities from PreviousVisibleEntities.</ol><p><strong>Code Snippets:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Complex coordination with PreviousVisibleEntities
</span><span>world</span><span style=color:#ed9366>.</span><span>resource_scope</span><span style=color:#ed9366>::</span><span>&LTPreviousVisibleEntities, </span><span style=color:#ed9366>_</span><span>>(
</span><span>    |</span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>previous_visible_entities</span><span>| {
</span><span>        </span><span style=color:#fa6e32>let mut</span><span> query </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span>query</span><span style=color:#ed9366>::</span><span><(Entity, </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> ViewVisibility)>()</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#fa6e32>for</span><span> entities </span><span style=color:#ed9366>in</span><span> defer_queue</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter_mut</span><span>() {
</span><span>            </span><span style=color:#fa6e32>let mut</span><span> iter </span><span style=color:#ed9366>=</span><span> query</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter_many_mut</span><span>(world</span><span style=color:#61676ccc>,</span><span> entities</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>())</span><span style=color:#61676ccc>;
</span><span>            </span><span style=color:#fa6e32>while let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>((entity</span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>mut</span><span> view_visibility)) </span><span style=color:#ed9366>=</span><span> iter</span><span style=color:#ed9366>.</span><span style=color:#f07171>fetch_next</span><span>() {
</span><span>                </span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!**</span><span>view_visibility {
</span><span>                    view_visibility</span><span style=color:#ed9366>.</span><span style=color:#f07171>set</span><span>()</span><span style=color:#61676ccc>;
</span><span>                }
</span><span>                previous_visible_entities</span><span style=color:#ed9366>.</span><span style=color:#f07171>remove</span><span>(</span><span style=color:#ed9366>&</span><span>entity)</span><span style=color:#61676ccc>;
</span><span>            }
</span><span>        }
</span><span>    }</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Simple component update using trait
</span><span style=color:#fa6e32>let mut</span><span> query </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span>query</span><span style=color:#ed9366>::</span><span><</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> ViewVisibility>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>for</span><span> entities </span><span style=color:#ed9366>in</span><span> defer_queue</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter_mut</span><span>() {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> iter </span><span style=color:#ed9366>=</span><span> query</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter_many_mut</span><span>(world</span><span style=color:#61676ccc>,</span><span> entities</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>())</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>while let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#fa6e32>mut</span><span> view_visibility) </span><span style=color:#ed9366>=</span><span> iter</span><span style=color:#ed9366>.</span><span style=color:#f07171>fetch_next</span><span>() {
</span><span>        view_visibility</span><span style=color:#ed9366>.</span><span style=color:#f07171>set_visible</span><span>()</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_ecs/latest/bevy_ecs/ target=_blank>Bevy ECS Documentation</a> - Understanding Bevy’s Entity Component System<li><a rel="noopener nofollow noreferrer" href=https://dataorienteddesign.com/dodbook/ target=_blank>Data-Oriented Design</a> - Principles behind component-based optimization<li><a rel="noopener nofollow noreferrer" href=https://graphics.stanford.edu/~seander/bithacks.html target=_blank>Bit Manipulation Techniques</a> - Efficient bit operations used in this PR<li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/programming/ecs-intro.html target=_blank>Parallel Processing in ECS</a> - How Bevy implements parallel system execution<li><a rel="noopener nofollow noreferrer" href=https://github.com/wolfpld/tracy target=_blank>Performance Profiling with Tracy</a> - Tool used for the performance measurements in this PR</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-01/pr_22226.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>