<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22698 render buffer debug label type prepopulation
        
    </title><meta content="#22698 render buffer debug label type prepopulation" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-01/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-01-26</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-01/pr-22698-zh-cn-20260126>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>render buffer debug label type prepopulation<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: render buffer debug label type prepopulation<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22698<li><strong>Author</strong>: atlv24<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, S-Ready-For-Final-Review, A-Dev-Tools, X-Uncontroversial, C-Refinement<li><strong>Created</strong>: 2026-01-25T16:05:10Z<li><strong>Merged</strong>: 2026-01-26T00:35:30Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>The vast majority of our buffers are unlabelled. This makes debugging wgpu errors really annoying, cus they lack context.</ul><h2 id=solution>Solution</h2><ul><li>We have type information, and buffers predominantly are custom struct types, and the few cases in which they arent they seem to be manually named anyways. Let’s exploit the type info to populate the buffer names under a debug gate.</ul><h2 id=testing>Testing</h2><ul><li>ran occlusion_culling example with and without the debug feature, it currently crashes due to a wgpu 28 change.</ul><h2 id=showcase>Showcase</h2><p>Before:<pre style=color:#61676c;background-color:#fafafa><code><span>Caused by:
</span><span>  In a CommandEncoder
</span><span>    In a dispatch command, indirect:true
</span><span>      Attempted to use Buffer with '' label with conflicting usages. Current usage BufferUses(STORAGE_READ_WRITE) and new usage BufferUses(INDIRECT). BufferUses(STORAGE_READ_WRITE) is an exclusive usage and cannot be used with any other usages within the usage scope (renderpass or compute dispatch).
</span></code></pre><p>After:<pre style=color:#61676c;background-color:#fafafa><code><span>Caused by:
</span><span>  In a CommandEncoder
</span><span>    In a dispatch command, indirect:true
</span><span>      Attempted to use Buffer with 'bevy_render::render_resource::buffer_vec::RawBufferVec&LTbevy_render::batching::gpu_preprocessing::LatePreprocessWorkItemIndirectParameters>' label with conflicting usages. Current usage BufferUses(STORAGE_READ_WRITE) and new usage BufferUses(INDIRECT). BufferUses(STORAGE_READ_WRITE) is an exclusive usage and cannot be used with any other usages within the usage scope (renderpass or compute dispatch).
</span></code></pre><p>Note that now we know 1. its a <code>RawBufferVec</code>, 2. of <code>LatePreprocessWorkItemIndirectParameters</code>. This lets us greatly narrow the scope of the search for an offender.<p>Note: this is the evolution of several different attempts at improving debug info. First attempt was with <code>#[track_caller]</code>, but that doesn’t work in const contexts because Location isnt allowed there. Second attempt was to prepopulate type name info in constructors, but <code>std::any::type_name()</code> returns a <code>&'static str</code>, and label is <code>Option&LTString></code>, and <code>.into()</code> and <code>.to_string()</code> are both not const because <code>String</code> is heap allocated. Finally, i moved it to the buffer creation site, and then extracted it into a generic function to deduplicate.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>Debugging GPU buffer errors in Bevy was challenging because most buffers lacked meaningful labels. When wgpu reported usage conflicts or other buffer-related errors, developers would see empty string labels in error messages, making it difficult to identify which specific buffer was causing the problem. The developer atlv24 recognized that type information was available at compile time and could be used to automatically populate labels when manual labels weren’t provided.<p>The initial approach considered using <code>#[track_caller]</code> to capture source location information, but this wasn’t viable because <code>Location</code> types can’t be used in const contexts. A second approach attempted to prepopulate type names in constructors using <code>std::any::type_name()</code>, but this presented a type conversion problem: <code>type_name()</code> returns a <code>&'static str</code> while buffer labels are <code>Option&LTString></code>, and converting to <code>String</code> involves heap allocation which isn’t allowed in const contexts.<p>The final solution moves the label generation to the buffer creation site and extracts it into a reusable generic function. This approach works because buffer types are known at the point where <code>make_buffer_label</code> is called, allowing the compiler to generate type-specific implementations. The solution is gated behind a <code>type_label_buffers</code> feature flag, which is included in Bevy’s broader <code>debug</code> feature set, ensuring the additional debug information doesn’t affect release builds.<p>The implementation modifies three key buffer types in Bevy’s renderer: <code>RawBufferVec</code>, <code>StorageBuffer</code>/<code>DynamicStorageBuffer</code>, and <code>UniformBuffer</code>/<code>DynamicUniformBuffer</code>. Each of these previously used <code>self.label.as_deref()</code> for their buffer labels. The change replaces this with <code>make_buffer_label::&LTSelf>(&self.label)</code>, which checks if a manual label exists and, if not (and when the debug feature is enabled), returns the type name using <code>core::any::type_name::&LTT>()</code>.<p>The helper function <code>make_buffer_label</code> is defined in <code>buffer_vec.rs</code> with <code>pub(crate)</code> visibility, making it accessible to other render resource modules. It uses conditional compilation with <code>#[cfg(feature = "type_label_buffers")]</code> to include the type name logic only when the feature is enabled. When disabled, it falls back to the original behavior of returning the provided label.<p>The practical impact is significant for debugging. Error messages that previously showed empty labels now display the full type path, including generics. For example, instead of seeing a buffer with <code>''</code> label, developers now see <code>'bevy_render::render_resource::buffer_vec::RawBufferVec&LTbevy_render::batching::gpu_preprocessing::LatePreprocessWorkItemIndirectParameters>'</code>. This immediately tells developers both the container type (<code>RawBufferVec</code>) and the contained type (<code>LatePreprocessWorkItemIndirectParameters</code>), dramatically narrowing the search space when debugging buffer usage conflicts.<p>The changes required minimal modifications to the build system. A new <code>type_label_buffers</code> feature was added to both the root <code>Cargo.toml</code> and <code>bevy_internal/Cargo.toml</code>, and this feature was included in the existing <code>debug</code> feature set. This ensures the type labeling behavior is opt-in through the debug features, maintaining performance in production builds.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Debug Buffer Errors] --> B[Empty Labels in Error Messages]
</span><span>    B --> C[Need Better Debug Context]
</span><span>    C --> D[Attempt: #[track_caller] - Failed]
</span><span>    C --> E[Attempt: Constructor Type Names - Failed]
</span><span>    C --> F[Solution: make_buffer_label at Creation]
</span><span>    F --> G[Generic Helper Function]
</span><span>    G --> H[Conditional Compilation]
</span><span>    H --> I[Type Names in Error Messages]
</span><span>    I --> J[Improved Debugging Experience]
</span><span>    
</span><span>    subgraph "Buffer Types Modified"
</span><span>        K[RawBufferVec]
</span><span>        L[StorageBuffer]
</span><span>        M[UniformBuffer]
</span><span>    end
</span><span>    
</span><span>    G --> K
</span><span>    G --> L
</span><span>    G --> M
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ol><li><p><strong><code>crates/bevy_render/src/render_resource/buffer_vec.rs</code></strong> (+12/-3)</p> <ul><li>Added <code>make_buffer_label</code> function that conditionally returns type names when debug feature is enabled<li>Modified three buffer creation sites to use the new helper function</ul> <p><strong>Key code snippet:</strong></p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// New helper function added
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>inline</span><span>]
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>make_buffer_label</span><span><</span><span style=color:#fa6e32>'a</span><span>, T>(</span><span style=color:#ff8f40>label</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'a </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#55b4d4;font-style:italic>String</span><span>>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'a str</span><span>> {
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"type_label_buffers"</span><span>)]
</span><span>    </span><span style=color:#fa6e32>if</span><span> label</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_none</span><span>() {
</span><span>        </span><span style=color:#fa6e32>return </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(core</span><span style=color:#ed9366>::</span><span>any</span><span style=color:#ed9366>::</span><span>type_name</span><span style=color:#ed9366>::</span><span>&LTT>())</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>    label</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_deref</span><span>()
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Usage in buffer creation (example from RawBufferVec)
</span><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>label</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>label</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_deref</span><span>()</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>label</span><span style=color:#61676ccc>: </span><span>make_buffer_label</span><span style=color:#ed9366>::</span><span><</span><span style=color:#fa6e32>Self</span><span>>(</span><span style=color:#ed9366>&</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>label)</span><span style=color:#61676ccc>,
</span></code></pre><li><p><strong><code>crates/bevy_render/src/render_resource/storage_buffer.rs</code></strong> (+6/-3)</p> <ul><li>Added import for <code>make_buffer_label</code><li>Modified <code>StorageBuffer</code> and <code>DynamicStorageBuffer</code> to use type-based labels</ul> <p><strong>Key code snippet:</strong></p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added import
</span><span style=color:#fa6e32>use crate</span><span style=color:#ed9366>::</span><span>render_resource</span><span style=color:#ed9366>::</span><span>make_buffer_label</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Modified buffer creation
</span><span>label</span><span style=color:#61676ccc>: </span><span>make_buffer_label</span><span style=color:#ed9366>::</span><span><</span><span style=color:#fa6e32>Self</span><span>>(</span><span style=color:#ed9366>&</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>label)</span><span style=color:#61676ccc>,
</span></code></pre><li><p><strong><code>crates/bevy_render/src/render_resource/uniform_buffer.rs</code></strong> (+3/-3)</p> <ul><li>Added import for <code>make_buffer_label</code><li>Modified <code>UniformBuffer</code> and <code>DynamicUniformBuffer</code> to use type-based labels</ul> <p><strong>Key code snippet:</strong></p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added import
</span><span style=color:#fa6e32>use crate</span><span style=color:#ed9366>::</span><span>render_resource</span><span style=color:#ed9366>::</span><span>make_buffer_label</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Modified buffer creation
</span><span>label</span><span style=color:#61676ccc>: </span><span>make_buffer_label</span><span style=color:#ed9366>::</span><span><</span><span style=color:#fa6e32>Self</span><span>>(</span><span style=color:#ed9366>&</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>label)</span><span style=color:#61676ccc>,
</span></code></pre><li><p><strong><code>crates/bevy_internal/Cargo.toml</code></strong> (+4/-1)</p> <ul><li>Added <code>type_label_buffers</code> feature definition<li>Added <code>bevy_render/debug</code> to the <code>debug</code> feature set</ul> <p><strong>Key code snippet:</strong></p> <pre class=language-toml data-lang=toml style=color:#61676c;background-color:#fafafa><code class=language-toml data-lang=toml><span style=color:#abb0b6;font-style:italic># New feature definition
</span><span style=color:#399ee6>type_label_buffers </span><span>= [</span><span style=color:#86b300>"bevy_render/type_label_buffers"</span><span>]
</span><span>
</span><span style=color:#abb0b6;font-style:italic># Added to debug feature
</span><span style=color:#399ee6>debug </span><span>= [</span><span style=color:#86b300>"bevy_utils/debug"</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"bevy_ecs/debug"</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"bevy_render/debug"</span><span>]
</span></code></pre><li><p><strong><code>crates/bevy_render/Cargo.toml</code></strong> (+4/-0)</p> <ul><li>Added <code>type_label_buffers</code> feature<li>Added <code>debug</code> feature that includes <code>type_label_buffers</code></ul> <p><strong>Key code snippet:</strong></p> <pre class=language-toml data-lang=toml style=color:#61676c;background-color:#fafafa><code class=language-toml data-lang=toml><span style=color:#399ee6>type_label_buffers </span><span>= []
</span><span style=color:#399ee6>debug </span><span>= [</span><span style=color:#86b300>"type_label_buffers"</span><span>]
</span></code></pre></ol><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/core/any/fn.type_name.html target=_blank>Rust <code>core::any::type_name</code> documentation</a> - Understanding how type names are obtained at compile time<li><a rel="noopener nofollow noreferrer" href=https://wgpu.rs/doc/wgpu/struct.BufferDescriptor.html#structfield.label target=_blank>wgpu Buffer Labels documentation</a> - How labels are used in wgpu for debugging<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/docs/cargo_features.md target=_blank>Bevy Feature Flags guide</a> - Understanding Bevy’s feature system<li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/reference/conditional-compilation.html target=_blank>Conditional Compilation in Rust</a> - Using <code>#[cfg]</code> attributes for feature gating</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-01/pr_22698.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>