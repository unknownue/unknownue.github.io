<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18670 Remote entity reservation v9
        
    </title><meta content="#18670 Remote entity reservation v9" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-01/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-01-23</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-01/pr-18670-zh-cn-20260123>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Remote entity reservation v9<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18670<li><strong>Author</strong>: ElliottjPierce<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Feature, A-ECS, M-Migration-Guide, X-Controversial, S-Needs-SME<li><strong>Created</strong>: 2025-04-01T19:41:01Z<li><strong>Merged</strong>: 2026-01-23T02:53:26Z<li><strong>Merged By</strong>: cart</ul><h2 id=description-translation>Description Translation</h2><p>fixes #18003<h1 id=objective>Objective</h1><p>It’s version 9 of the same objective lol. For assets as entities, we need entities to be able to be reserved from any thread. Ideally, this can be done without depending on an async context, blocking, or waiting. Any of these compromises <em>could</em> hurt asset performance or discontinue the completely non-blocking nature of the asset system.<p>As a bonus, this PR makes allocating entities only need <code>&Entities</code> instead of <code>&mut</code>. <code>Entities::flush</code> is now completely optional, meaning none of the <code>Entities</code> methods depends on the flush at all, and there is protection against flushing an entity twice.<p>(If you’re curious, v9 actually branched from v8. v8 was focused on #18577 (never flush entities), but this still includes flushing.)<blockquote><p>There’s a doc <a rel="noopener nofollow noreferrer" href=https://hackmd.io/@bevy/Bkjgqvcblx target=_blank>here</a> that builds some background for this too. If you haven’t been following this I’d highly recommend reading that before diving into the code.</blockquote><h2 id=solution>Solution</h2><p>Organizationally, I split off the underlying <code>EntityAllocator</code> from <code>Entities</code>. This makes it easier to read, etc, now that it’s more involved.<p>The basic problem is that we need to be able to allocate an entity from any thread at any time. We also need to be able to free an entity. So at the allocator level, that’s 3 operations: <code>free</code>, <code>alloc</code> (For when you know <code>free</code> isn’t being called), and <code>remote_alloc</code> (can be called any time). None of these can require mutable access.<p>The biggest challenge is having a list of entities that are <code>free</code> and waiting to be re-used. The list needs to be fully functional without mutable access, needs to be resizable, and needs to be pinned in memory. I ended up using a strategy similar to <a rel="noopener nofollow noreferrer" href=https://docs.rs/orx-split-vec/latest/orx_split_vec/ target=_blank><code>SplitVec</code></a>. That dependency requires <code>std</code>, and knowing the max capacity ahead of time lets us simplify the implementation, so I made my own implementation here.<h2 id=testing>Testing</h2><p>No new tests right now. It might be worth using <a rel="noopener nofollow noreferrer" href=https://docs.rs/loom/latest/loom/ target=_blank>loom</a> at some point, but that requires an additional dependency, test-specific loom feature flags, and giving this treatment to multiple crates, especially bevy_platform.<h2 id=future-work>Future work</h2><p>#18577 is still a good end game here IMO. Ultimately, (just like @maniwani said would happen), I decided that doing this all at once would be both too challenging and add too much complexity. However, v9 makes “never flush” much, <em>much</em> more approachable for the future. The biggest issues I ran into were that lots of places hold a reference to an entity’s <code>Archetype</code> (but the entity now might not have an archetype) and that checking archetypes everywhere <em>might</em> actually be less performant than flushing. Maybe.<p>We can also potentially speed up a lot of different processes now that <code>alloc</code> can be called without mutable access and <code>free</code> (etc.) can be called without needing to <code>flush</code> first.<h2 id=costs>Costs</h2><details><summary>Benchmarks</summary> <pre class=language-txt data-lang=txt style=color:#61676c;background-color:#fafafa><code class=language-txt data-lang=txt><span>group                                           main_baseline                           remote_reservation_v9_baseline
</span><span>-----                                           -------------                           ------------------------------
</span><span>add_remove/sparse_set                           1.06   625.2±42.08µs        ? ?/sec     1.00   591.8±24.97µs        ? ?/sec
</span><span>add_remove/table                                1.00   883.9±66.56µs        ? ?/sec     1.06   941.1±34.62µs        ? ?/sec
</span><span>add_remove_very_big/table                       1.08     37.7±2.55ms        ? ?/sec     1.00     34.9±0.76ms        ? ?/sec
</span><span>added_archetypes/archetype_count/1000           1.13  688.8±175.58µs        ? ?/sec     1.00  608.6±137.61µs        ? ?/sec
</span><span>added_archetypes/archetype_count/200            1.13    72.7±18.97µs        ? ?/sec     1.00    64.2±20.78µs        ? ?/sec
</span><span>added_archetypes/archetype_count/2000           1.11  1086.7±290.33µs        ? ?/sec    1.00  977.2±118.15µs        ? ?/sec
</span><span>added_archetypes/archetype_count/5000           1.09      2.7±0.29ms        ? ?/sec     1.00      2.5±0.27ms        ? ?/sec
</span><span>despawn_world/10_entities                       1.00   695.6±13.85ns        ? ?/sec     1.09   760.4±40.01ns        ? ?/sec
</span><span>despawn_world/1_entities                        1.00   182.0±24.14ns        ? ?/sec     1.56   284.3±50.46ns        ? ?/sec
</span><span>despawn_world_recursive/10000_entities          1.00  1668.8±95.30µs        ? ?/sec     1.13  1878.0±111.75µs        ? ?/sec
</span><span>despawn_world_recursive/10_entities             1.00      2.3±0.04µs        ? ?/sec     1.05      2.4±0.09µs        ? ?/sec
</span><span>despawn_world_recursive/1_entities              1.00   382.2±36.07ns        ? ?/sec     1.41   539.1±60.46ns        ? ?/sec
</span><span>empty_archetypes/iter/10000                     1.07     12.8±1.61µs        ? ?/sec     1.00     12.0±0.49µs        ? ?/sec
</span><span>empty_archetypes/par_for_each/100               1.06      9.2±1.04µs        ? ?/sec     1.00      8.7±0.35µs        ? ?/sec
</span><span>empty_archetypes/par_for_each/1000              1.12     12.8±0.87µs        ? ?/sec     1.00     11.5±0.36µs        ? ?/sec
</span><span>empty_archetypes/par_for_each/10000             1.19     25.4±0.98µs        ? ?/sec     1.00     21.3±0.41µs        ? ?/sec
</span><span>empty_archetypes/par_for_each/2000              1.16     13.6±1.17µs        ? ?/sec     1.00     11.7±0.44µs        ? ?/sec
</span><span>empty_archetypes/par_for_each/500               1.08     11.1±0.70µs        ? ?/sec     1.00     10.3±0.28µs        ? ?/sec
</span><span>empty_commands/0_entities                       1.00      3.9±0.06ns        ? ?/sec     1.40      5.4±0.06ns        ? ?/sec
</span><span>entity_hash/entity_set_lookup_miss_gen/10000    1.00     41.6±6.26µs 229.0 MElem/sec    1.05     43.9±5.74µs 217.1 MElem/sec
</span><span>entity_hash/entity_set_lookup_miss_id/10000     1.25     44.5±5.30µs 214.2 MElem/sec    1.00     35.7±5.03µs 266.8 MElem/sec
</span><span>event_propagation/four_event_types              1.13   606.5±27.06µs        ? ?/sec     1.00    535.9±5.38µs        ? ?/sec
</span><span>event_propagation/single_event_type             1.12   870.3±27.20µs        ? ?/sec     1.00   776.4±18.86µs        ? ?/sec
</span><span>fake_commands/2000_commands                     1.00     12.1±0.08µs        ? ?/sec     1.28     15.4±0.25µs        ? ?/sec
</span><span>fake_commands/4000_commands                     1.00     24.2±0.26µs        ? ?/sec     1.28     30.9±0.38µs        ? ?/sec
</span><span>fake_commands/6000_commands                     1.00     36.3±0.50µs        ? ?/sec     1.27     46.2±0.48µs        ? ?/sec
</span><span>fake_commands/8000_commands                     1.00     48.3±0.15µs        ? ?/sec     1.28     61.6±0.87µs        ? ?/sec
</span><span>insert_simple/base                              1.29   403.9±79.33µs        ? ?/sec     1.00   312.1±56.57µs        ? ?/sec
</span><span>insert_simple/unbatched                         2.41  1021.5±234.06µs        ? ?/sec    1.00   423.2±17.00µs        ? ?/sec
</span><span>iter_fragmented/base                            1.00    346.6±8.58ns        ? ?/sec     1.40    485.0±9.30ns        ? ?/sec
</span><span>iter_fragmented/foreach                         1.07    141.4±6.76ns        ? ?/sec     1.00    132.4±3.85ns        ? ?/sec
</span><span>iter_fragmented_sparse/base                     1.19      7.9±0.16ns        ? ?/sec     1.00      6.6±0.09ns        ? ?/sec
</span><span>iter_simple/foreach_wide                        2.76     46.4±0.46µs        ? ?/sec     1.00     16.8±0.18µs        ? ?/sec
</span><span>query_get/50000_entities_table                  1.00    138.8±0.67µs        ? ?/sec     1.05    145.9±1.23µs        ? ?/sec
</span><span>query_get_many_5/50000_calls_sparse             1.06   607.3±14.47µs        ? ?/sec     1.00   570.5±42.57µs        ? ?/sec
</span><span>sized_commands_0_bytes/2000_commands            1.00     10.6±1.20µs        ? ?/sec     1.26     13.3±0.18µs        ? ?/sec
</span><span>sized_commands_0_bytes/4000_commands            1.00     20.6±0.33µs        ? ?/sec     1.29     26.5±0.42µs        ? ?/sec
</span><span>sized_commands_0_bytes/6000_commands            1.00     30.8±0.26µs        ? ?/sec     1.29     39.9±0.61µs        ? ?/sec
</span><span>sized_commands_0_bytes/8000_commands            1.00     41.4±0.77µs        ? ?/sec     1.28     53.1±0.65µs        ? ?/sec
</span><span>sized_commands_12_bytes/2000_commands           1.00     11.6±0.29µs        ? ?/sec     1.23     14.2±0.32µs        ? ?/sec
</span><span>sized_commands_12_bytes/4000_commands           1.00     22.8±3.30µs        ? ?/sec     1.24     28.3±0.30µs        ? ?/sec
</span><span>sized_commands_12_bytes/6000_commands           1.00     33.6±0.20µs        ? ?/sec     1.27     42.8±0.63µs        ? ?/sec
</span><span>sized_commands_12_bytes/8000_commands           1.00     48.8±6.10µs        ? ?/sec     1.22     59.7±0.76µs        ? ?/sec
</span><span>sized_commands_512_bytes/2000_commands          1.00     46.3±1.28µs        ? ?/sec     1.06     48.9±1.73µs        ? ?/sec
</span><span>sized_commands_512_bytes/4000_commands          1.00     90.5±2.06µs        ? ?/sec     1.08     97.4±3.33µs        ? ?/sec
</span><span>spawn_commands/2000_entities                    1.00   155.4±11.61µs        ? ?/sec     1.22   189.5±15.70µs        ? ?/sec
</span><span>spawn_commands/4000_entities                    1.00   303.7±15.69µs        ? ?/sec     1.22   371.1±18.58µs        ? ?/sec
</span><span>spawn_commands/6000_entities                    1.00   463.3±31.95µs        ? ?/sec     1.20   554.8±12.55µs        ? ?/sec
</span><span>spawn_commands/8000_entities                    1.00   619.7±44.57µs        ? ?/sec     1.19   734.9±16.71µs        ? ?/sec
</span><span>spawn_world/1000_entities                       1.06     41.5±2.97µs        ? ?/sec     1.00     39.1±2.94µs        ? ?/sec
</span><span>spawn_world/100_entities                        1.20      4.8±2.29µs        ? ?/sec     1.00      4.0±0.69µs        ? ?/sec
</span><span>spawn_world/10_entities                         1.15   461.9±80.36ns        ? ?/sec     1.00   400.5±26.17ns        ? ?/sec
</span><span>spawn_world/1_entities                          1.05     41.4±6.35ns        ? ?/sec     1.00     39.4±3.02ns        ? ?/sec
</span><span>world_get/50000_entities_sparse                 1.00    167.1±4.23µs        ? ?/sec     1.07    178.8±2.44µs        ? ?/sec
</span><span>world_query_get/50000_entities_sparse_wide      1.00    125.0±0.31µs        ? ?/sec     1.08   135.7±78.30µs        ? ?/sec
</span><span>world_query_iter/50000_entities_sparse          1.00     38.7±0.08µs        ? ?/sec     1.18     45.6±0.60µs        ? ?/sec
</span></code></pre></details><p><strong>Interpreting benches:</strong><p>In most places, v9 is on par with or even faster than main. Some notable exceptions are the “sized_commands” and “fake_commands” sections, but the regression there is purely due to <code>Entities::flush</code> being slower, but we make up for that elsewhere. These commands don’t actually do anything though, so this is not relevant to actual use cases. The benchmarks just exist to stress test <code>CommandQueue</code>.<p>The only place where v9 causes a significant and real-world applicable regression is “spawn_commands”, where v9 is roughly 15% slower than main. This is something that can be changed later now that <code>alloc</code> doesn’t need mutable access. I expect we can change this 15% regression to a 15% improvement given that “spawn_world” is roughly 20% faster on v9 than on main. For users that need really fast spawn commands though, they are already using some form of batch spawning or direct world access.<p>Other regressions seem to be either minimal, unrealistic, easily corrected in the future, or wrong. I feel confident saying “wrong” since running them back to back can sometimes yield different results. I’m on a M2 Max, so there might be some things jumping from perf cores to efficiency cores or something. (I look forward to standardized benchmarking hardware.)<p><strong>Wins:</strong> I was worried that, without “never flush”, this would be an overall regression, but I am relived that that is not the case. Some very common operations, “insert_simple/unbatched” for example, are way faster on this branch than on main. Basically, on main, <code>alloc</code> also adds <code>EntityMeta</code> for the entity immediately, but on this branch, we only do so in <code>set</code>. That seems to improve temporal cache locality and leads to this roughly 220% improvement. “added_arhcetype” sees 20%-80% improvements too, etc. “iter_simple/foreach_wide” also sees a 270% improvement.<p>I think in practice, v9 will out perform main for real-world schedules. And I think moving towards “never flush” (even for only a few operations, like <code>Commands::spawn</code>) will improve performance even more.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a fundamental problem in Bevy’s ECS system: the need to allocate entities from any thread without blocking, while maintaining the performance characteristics necessary for a game engine. The challenge stems from Bevy’s move toward treating assets as entities, which requires non-blocking entity allocation during async operations like asset loading.<p>The existing entity allocation system had several limitations. First, entity allocation required mutable access to the <code>Entities</code> resource, which prevented concurrent allocation from multiple threads. Second, the system relied on periodic “flushing” operations to make allocated entities usable in queries, which added complexity and potential performance overhead. Third, there was no safe way to allocate entities from remote threads or async contexts without potentially compromising the non-blocking nature of the system.<p>The solution takes a comprehensive approach by completely redesigning the entity allocator’s internals. At the core, the PR separates the allocation logic from the <code>Entities</code> structure, creating a new <code>remote_allocator</code> module that contains the allocation machinery. This separation makes the code more maintainable and allows for different allocation strategies.<p>The key insight behind the implementation is that entity allocation involves three distinct operations with different concurrency requirements:<ol><li><strong><code>free</code></strong>: Called when entities are destroyed, requires mutable access (ensuring no concurrent allocations)<li><strong><code>alloc</code></strong>: Normal allocation from the main thread, can assume no concurrent <code>free</code> operations<li><strong><code>remote_alloc</code></strong>: Allocation from any thread at any time, must handle concurrent <code>free</code> operations</ol><p>The most complex part of the implementation is the free list - a data structure that tracks which entity indices are available for reuse. The free list must be:<ul><li>Accessible without mutable references<li>Resizable (to accommodate varying numbers of freed entities)<li>Memory-pinned (addresses of freed entities must remain valid)<li>Concurrently safe for both allocation and freeing operations</ul><p>The implementation uses a split buffer approach similar to <code>SplitVec</code>, where the buffer is divided into chunks of exponentially increasing sizes. Each chunk’s memory remains pinned once allocated, and new chunks are added as needed. This avoids copying elements during resizing while maintaining stable memory addresses.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>struct </span><span style=color:#399ee6>FreeBuffer</span><span>([Chunk; </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>NUM_CHUNKS as </span><span style=color:#fa6e32>usize</span><span>])</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>Chunk </span><span>{
</span><span>    first</span><span style=color:#61676ccc>: </span><span>AtomicPtr&LTSlot>,
</span><span>}
</span><span>
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>Slot </span><span>{
</span><span>    inner</span><span style=color:#61676ccc>: </span><span>SyncUnsafeCell&LTEntity>,
</span><span>}
</span></code></pre><p>The free list’s state is tracked using a single 64-bit atomic integer (<code>FreeCount</code>) that packs three pieces of information:<ul><li>33 bits for the length (using a signed representation to handle underflow)<li>1 bit as a disabling flag (acts as a lightweight mutex)<li>30 bits for a generation counter (distinguishes different states of the same length)</ul><p>This bit-packing allows atomic updates to both the length and generation together, which is crucial for correct concurrent operations.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>struct </span><span style=color:#399ee6>FreeCountState</span><span>(</span><span style=color:#fa6e32>u64</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>const </span><span style=color:#ff8f40>DISABLING_BIT</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u64 </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>1 </span><span style=color:#ed9366><< </span><span style=color:#ff8f40>33</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>const </span><span style=color:#ff8f40>LENGTH_MASK</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u64 </span><span style=color:#ed9366>= </span><span>(</span><span style=color:#ff8f40>1 </span><span style=color:#ed9366><< </span><span style=color:#ff8f40>32</span><span>) </span><span style=color:#ed9366>| </span><span style=color:#fa6e32>u32</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>MAX </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>u64</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>const </span><span style=color:#ff8f40>LENGTH_0</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u64 </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>1 </span><span style=color:#ed9366><< </span><span style=color:#ff8f40>32</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>const </span><span style=color:#ff8f40>GENERATION_LEAST_BIT</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u64 </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>1 </span><span style=color:#ed9366><< </span><span style=color:#ff8f40>34</span><span style=color:#61676ccc>;
</span></code></pre><p>The <code>remote_alloc</code> method demonstrates careful concurrent programming. It uses a compare-and-exchange loop to safely allocate from the free list while handling concurrent <code>free</code> operations. When a <code>free</code> operation is detected (via the disabling flag), the method spins briefly to avoid wasting CPU cycles, yielding the thread after 64 attempts to allow the freeing thread to make progress.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>fn </span><span style=color:#f29718>remote_alloc</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTEntity> {
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"std"</span><span>)]
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> attempts </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>1</span><span style=color:#fa6e32>u32</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> state </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>len</span><span style=color:#ed9366>.</span><span style=color:#f07171>state</span><span>(Ordering</span><span style=color:#ed9366>::</span><span>Acquire)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>loop </span><span>{
</span><span>        </span><span style=color:#fa6e32>if</span><span> state</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_disabled</span><span>() {
</span><span>            </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"std"</span><span>)]
</span><span>            {
</span><span>                attempts </span><span style=color:#ed9366>+= </span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>;
</span><span>                </span><span style=color:#fa6e32>if</span><span> attempts</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_multiple_of</span><span>(</span><span style=color:#ff8f40>64</span><span>) {
</span><span>                    std</span><span style=color:#ed9366>::</span><span>thread</span><span style=color:#ed9366>::</span><span>yield_now()</span><span style=color:#61676ccc>;
</span><span>                } </span><span style=color:#fa6e32>else </span><span>{
</span><span>                    core</span><span style=color:#ed9366>::</span><span>hint</span><span style=color:#ed9366>::</span><span>spin_loop()</span><span style=color:#61676ccc>;
</span><span>                }
</span><span>            }
</span><span>            </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(</span><span style=color:#f29718>not</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"std"</span><span>))]
</span><span>            core</span><span style=color:#ed9366>::</span><span>hint</span><span style=color:#ed9366>::</span><span>spin_loop()</span><span style=color:#61676ccc>;
</span><span>            
</span><span>            state </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>len</span><span style=color:#ed9366>.</span><span style=color:#f07171>state</span><span>(Ordering</span><span style=color:#ed9366>::</span><span>Acquire)</span><span style=color:#61676ccc>;
</span><span>            </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>        
</span><span>        </span><span style=color:#fa6e32>let</span><span> len </span><span style=color:#ed9366>=</span><span> state</span><span style=color:#ed9366>.</span><span style=color:#f07171>length</span><span>()</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#fa6e32>let</span><span> index </span><span style=color:#ed9366>=</span><span> len</span><span style=color:#ed9366>.</span><span style=color:#f07171>checked_sub</span><span>(</span><span style=color:#ff8f40>1</span><span>)</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#fa6e32>let</span><span> entity </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>unsafe </span><span>{ </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>buffer</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(index) }</span><span style=color:#61676ccc>;
</span><span>        
</span><span>        </span><span style=color:#fa6e32>let</span><span> ideal_state </span><span style=color:#ed9366>=</span><span> state</span><span style=color:#ed9366>.</span><span style=color:#f07171>pop</span><span>(</span><span style=color:#ff8f40>1</span><span>)</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#fa6e32>match </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>len</span><span style=color:#ed9366>.</span><span style=color:#f07171>try_set_state</span><span>(state</span><span style=color:#61676ccc>,</span><span> ideal_state</span><span style=color:#61676ccc>, </span><span>Ordering</span><span style=color:#ed9366>::</span><span>Relaxed</span><span style=color:#61676ccc>, </span><span>Ordering</span><span style=color:#ed9366>::</span><span>Acquire) {
</span><span>            </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(</span><span style=color:#ed9366>_</span><span>) </span><span style=color:#ed9366>=> </span><span style=color:#fa6e32>return </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(entity)</span><span style=color:#61676ccc>,
</span><span>            </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(new_state) </span><span style=color:#ed9366>=></span><span> state </span><span style=color:#ed9366>=</span><span> new_state</span><span style=color:#61676ccc>,
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre><p>The public API changes are</div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-01/pr_18670.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>