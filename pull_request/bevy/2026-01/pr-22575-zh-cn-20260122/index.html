<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22575 Fix panic in update_viewport_render_target_size when despawning
        
    </title><meta content="#22575 Fix panic in update_viewport_render_target_size when despawning" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-01/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-01-22</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2026-01/pr-22575-en-20260122>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=title>Title</h1><p>Fix panic in update_viewport_render_target_size when despawning<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix panic in update_viewport_render_target_size when despawning<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22575<li><strong>作者</strong>: mgi388<li><strong>状态</strong>: 已合并 (MERGED)<li><strong>标签</strong>: C-Bug, A-UI, S-Ready-For-Final-Review, D-Straightforward, A-Camera<li><strong>创建时间</strong>: 2026-01-18T01:00:42Z<li><strong>合并时间</strong>: 2026-01-22T18:15:04Z<li><strong>合并者</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h3 id=mu-biao>目标</h3><ul><li>修复当你despawn一个与<code>ViewportNode</code>关联的camera时发生的panic。<li>在Discord中，我曾询问为什么向我的camera添加<code>Msaa::Off</code>会导致灰屏，结果发现这与我的egui inspector camera有关。在尝试找出原因时，我通过egui inspector界面despawn camera来测试是否有效。当despawn一个被<code>ViewportNode</code>引用的camera时，由于使用了<code>unwrap()</code>，我遇到了这个panic。</ul><h3 id=jie-jue-fang-an>解决方案</h3><ul><li>不使用<code>unwrap</code>，而是如果camera不再存在就忽略它。如果camera实体被despawn，这种情况很容易发生，例如使用<code>DespawnOnExit</code>状态，或在编辑器/inspector中手动despawn。<li>这意味着<code>ViewportNode</code>会留下一个悬垂/无效的引用。不过我不确定如何解决这个问题？<li>同时更新文档以说明会发生什么。<li>注意：系统中还有另一个unwrap，但我不想在这个PR中修改它。我没有遇到那个panic，所以宁愿把它留在这个PR之外（它可能是一个有用的panic，应该单独考虑）。</ul><h3 id=ce-shi>测试</h3><ul><li>已在我fork的Bevy 0.17版本中测试，确认不再panic。</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>这个PR源于一个实际的开发调试场景。用户在Discord社区中报告了一个问题：向他们的camera添加<code>Msaa::Off</code>导致屏幕变灰。在调查过程中，他们使用egui inspector工具进行调试，尝试despawn camera以观察影响。当despawn一个被<code>ViewportNode</code>组件引用的camera实体时，程序发生了panic。这直接暴露了<code>update_viewport_render_target_size</code>系统中的一个潜在的可靠性问题。<p>问题的核心在于实体（entity）生命周期管理与组件依赖关系之间的脱节。在Bevy的ECS架构中，<code>ViewportNode</code>作为一个组件，其<code>camera</code>字段持有一个<code>Entity</code> ID，指向另一个作为camera的实体。这是一种典型的实体间引用。然而，当目标camera实体被despawn（无论是通过状态迁移如<code>DespawnOnExit</code>，还是手动操作），这个引用就变成了“悬垂指针”（dangling reference）。随后，当<code>update_viewport_render_target_size</code>系统运行时，它尝试通过<code>camera_query.get(viewport.camera)</code>查询这个已经不存在的实体，并直接对其结果调用<code>.unwrap()</code>。由于查询失败返回<code>Err</code>，<code>unwrap()</code>会引发panic，导致程序崩溃。<p>从工程角度看，这里存在一个设计取舍。使用<code>unwrap</code>是一种“快速失败”（fail-fast）策略，它有助于在开发早期暴露出编程错误，例如错误地配置了<code>ViewportNode</code>。然而，在动态的、允许实体被随时创建和销毁的运行时环境中，这种硬性失败就显得过于严格，并且不符合系统的健壮性（robustness）要求。用户的操作（在inspector中despawn一个实体）是一个完全合法的操作，不应该导致整个应用崩溃。<p>开发者提出的解决方案是务实且直接的：将可能引发panic的<code>unwrap</code>替换为更安全的错误处理。具体做法是使用<code>if let Ok(...)</code>或等价的<code>let Ok(...) = ... else { continue; }</code>模式。如果查询camera实体失败，系统简单地跳过（<code>continue</code>）当前这个拥有无效引用的<code>ViewportNode</code>，继续处理下一个。这确保了系统在遇到无效状态时能够优雅降级，而不是崩溃。<p>这个解决方案也清晰地划分了责任边界。<code>update_viewport_render_target_size</code>系统的职责是根据camera和节点尺寸更新渲染目标大小。当它发现一个camera引用无效时，最合理的操作就是放弃执行本次更新，因为它无法完成自己的工作。清理无效的<code>ViewportNode</code>组件（即移除悬垂引用）应该是另一个系统或操作的职责，可能涉及更复杂的生命周期管理逻辑。正如开发者注释中所说“I’m not sure how to solve that though?”，这表明他们意识到悬垂引用问题本身并未被根除，但解决panic是当前更紧急和明确的步骤。<p>在实现细节上，PR做了两处修改。首先，在<code>ViewportNode</code>结构体的文档注释中添加了说明，明确告知其他开发者“Despawning the camera entity will leave a viewport node with an invalid camera.”。这是一种良好的实践，通过文档来沟通组件的预期行为和潜在陷阱。其次，在系统逻辑中将<code>camera_query.get(viewport.camera).unwrap()</code>替换为：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(render_target) </span><span style=color:#ed9366>=</span><span> camera_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(viewport</span><span style=color:#ed9366>.</span><span>camera) </span><span style=color:#fa6e32>else </span><span>{
</span><span>    </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>}</span><span style=color:#61676ccc>;
</span></code></pre><p>这个改动很小，但意义重大。它把系统从“遇到意外状态就崩溃”转变为“遇到意外状态就跳过，保持运行”。这种模式在游戏引擎这种需要高度稳定性的系统中很常见。<p>值得注意的是，开发者特意提到系统中还存在另一个<code>unwrap</code>调用（在<code>let Some(image_handle) = render_target.as_image() else { ... }</code>之后的那一处），但他们选择不在此PR中修改。这是一个明智的工程判断。那个<code>unwrap</code>可能对应着另一种错误情况（例如，渲染目标资源本身出了问题），它可能仍然是一个有价值的、用于捕获配置错误的断言。将这两个修改分开，使得每个PR的变更范围（scope）更小、目的更单一，便于代码审查和问题追踪。<p>最终，这个修复提升了Bevy UI模块的健壮性。它允许开发者更自由地操作实体生命周期（尤其是在编辑器或调试场景中），而不会触发意外的崩溃。这个案例也体现了在ECS系统中处理实体间引用时需要特别注意生命周期同步问题，单纯的ID引用并不能提供自动的引用有效性保障。<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    subgraph "实体 (Entity) 关系"
</span><span>        VN[ViewportNode 组件]
</span><span>        VN -- `camera` 字段持有 ID --> CE[Camera 实体]
</span><span>        CE -- 拥有 --> CC[Camera 组件]
</span><span>        CC -- 引用 --> RT[RenderTarget]
</span><span>        RT -- 指向 --> IMG[Image 资源]
</span><span>    end
</span><span>
</span><span>    subgraph "系统 (System): update_viewport_render_target_size"
</span><span>        SYS[系统逻辑]
</span><span>        SYS -- 1. 遍历查询 --> Q_VN[Query<(&ViewportNode, &ComputedNode)>]
</span><span>        SYS -- 2. 查询 Camera --> Q_C[Query<&Camera>]
</span><span>        Q_C -- 3. 获取 RenderTarget --> RT
</span><span>        SYS -- 4. 更新尺寸 --> IMG
</span><span>    end
</span><span>
</span><span>    CE -. 被 Despawn .-> X((实体消失))
</span><span>    VN -. 导致 .-> DR[悬垂引用 Dangling Reference]
</span><span>    DR -. 之前: 引发 .-> PANIC[Panic via .unwrap()]
</span><span>    DR -. 现在: 被 .-> HANDLE[处理：`if let Ok` 跳过]
</span><span>    HANDLE --> SYS
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=wen-jian-crates-bevy-ui-src-widget-viewport-rs-8-2>文件: <code>crates/bevy_ui/src/widget/viewport.rs</code> (+8/-2)</h3><ol><li><p><strong>修改了什么及原因</strong>:</p> <ul><li>为<code>ViewportNode::camera</code>字段的文档添加了关于despawn摄像头会导致无效引用的说明。<li>修改了<code>update_viewport_render_target_size</code>系统函数，将可能panic的<code>.unwrap()</code>调用替换为安全的错误处理，当摄像头实体不存在时跳过当前节点。</ul><li><p><strong>关键代码片段</strong>:</p> <ul><li><strong>文档更新</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 修改前：
</span><span style=color:#abb0b6;font-style:italic>/// Note that removing the [`ViewportNode`] component will not despawn this entity.
</span><span style=color:#abb0b6;font-style:italic>// 修改后：
</span><span style=color:#abb0b6;font-style:italic>/// Note: Removing the [`ViewportNode`] component will not despawn this
</span><span style=color:#abb0b6;font-style:italic>/// entity.
</span><span style=color:#abb0b6;font-style:italic>///
</span><span style=color:#abb0b6;font-style:italic>/// Note: Despawning the camera entity will leave a viewport node with an
</span><span style=color:#abb0b6;font-style:italic>/// invalid camera.
</span></code></pre><li><strong>核心逻辑修复</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 修改前：
</span><span style=color:#fa6e32>let</span><span> render_target </span><span style=color:#ed9366>=</span><span> camera_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(viewport</span><span style=color:#ed9366>.</span><span>camera)</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// 修改后：
</span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(render_target) </span><span style=color:#ed9366>=</span><span> camera_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(viewport</span><span style=color:#ed9366>.</span><span>camera) </span><span style=color:#fa6e32>else </span><span>{
</span><span>    </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>}</span><span style=color:#61676ccc>;
</span></code></pre></ul><li><p><strong>与PR目的的关系</strong>: 文档修改明确了组件的行为和限制，有助于其他开发者理解潜在问题。代码逻辑的修改直接解决了PR的核心目标：避免在despawn摄像头时发生panic，使系统在遇到无效引用时能够优雅地跳过处理。</p></ol><h2 id=further-reading>Further Reading</h2><ul><li><strong>Bevy ECS 官方手册 - 实体与组件</strong>: 深入了解实体、组件以及查询（Query）的工作原理。<li><strong>Rust 错误处理 (<code>Result</code>, <code>Option</code>, <code>unwrap</code>, <code>?</code> 运算符)</strong>: 理解Rust中处理可能失败操作的不同模式及其适用场景。<li><strong>游戏引擎中的健壮性编程 (Robust Programming)</strong>: 了解在实时交互系统中如何设计容错机制，避免单一错误导致整个系统崩溃。<li><strong>实体生命周期管理</strong>: 学习在ECS架构中管理具有依赖关系的实体生命周期的常见模式与挑战。</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-01/pr_22575.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>