<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22668 Fix timestamp queries for DLSS
        
    </title><meta content="#22668 Fix timestamp queries for DLSS" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-01/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-01-24</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-01/pr-22668-zh-cn-20260124>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=fix-timestamp-queries-for-dlss>Fix timestamp queries for DLSS</h2><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix timestamp queries for DLSS<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22668<li><strong>Author</strong>: JMS55<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, S-Ready-For-Final-Review<li><strong>Created</strong>: 2026-01-23T16:55:58Z<li><strong>Merged</strong>: 2026-01-24T19:47:40Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>Timestamp queries have never worked for DLSS because I setup them up wrong when I initially wrote the code. This fixes it (and adds DLSS-RR time to the Solari example).<p>Basically we need to put the timestamp start on the command buffer before DLSS, and then the timestamp end on the command buffer right after DLSS.<p>Debug groups had to be removed because I can’t use them across different command encoders.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a long-standing issue in Bevy’s DLSS (Deep Learning Super Sampling) integration where timestamp queries for performance profiling were not functioning correctly. The root cause was incorrect placement of timestamp markers in the command buffer sequence, combined with debug group usage that interfered with multi-encoder workflows.<p>The problem emerged from how DLSS operations work within Bevy’s render graph architecture. When DLSS runs, it creates its own command buffer separate from Bevy’s main command encoder. The original implementation placed timestamp start/end markers on Bevy’s command encoder, but these markers needed to be on the actual command buffer where DLSS executes. This meant performance measurements for DLSS operations were always invalid.<p>The solution involved two key changes. First, the code needed to ensure timestamp markers were placed correctly relative to the DLSS command buffer creation. Second, debug groups had to be removed because they cannot span multiple command encoders - an architectural constraint that wasn’t initially accounted for.<p>Looking at the implementation, the fix is straightforward but reveals important insights about GPU command buffer management. In the <code>DlssNode</code> implementation, the original code structure was:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before - incorrect placement
</span><span style=color:#fa6e32>let</span><span> time_span </span><span style=color:#ed9366>=</span><span> diagnostics</span><span style=color:#ed9366>.</span><span style=color:#f07171>time_span</span><span>(command_encoder</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"dlss_super_resolution"</span><span>)</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> dlss_command_buffer </span><span style=color:#ed9366>=</span><span> dlss_context</span><span style=color:#ed9366>.</span><span style=color:#f07171>render</span><span>(</span><span style=color:#ed9366>...</span><span>)</span><span style=color:#61676ccc>;
</span><span>time_span</span><span style=color:#ed9366>.</span><span style=color:#f07171>end</span><span>(command_encoder)</span><span style=color:#61676ccc>;
</span></code></pre><p>The issue here is that <code>time_span.end(command_encoder)</code> places the end timestamp on Bevy’s command encoder, not on the DLSS command buffer. The corrected version ensures both timestamps are on the appropriate command buffer:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// After - correct placement
</span><span style=color:#fa6e32>let</span><span> time_span </span><span style=color:#ed9366>=</span><span> diagnostics</span><span style=color:#ed9366>.</span><span style=color:#f07171>time_span</span><span>(command_encoder</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"dlss_super_resolution"</span><span>)</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> dlss_command_buffer </span><span style=color:#ed9366>=</span><span> dlss_context</span><span style=color:#ed9366>.</span><span style=color:#f07171>render</span><span>(</span><span style=color:#ed9366>...</span><span>)</span><span style=color:#61676ccc>;
</span><span>render_context</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_command_buffer</span><span>(dlss_command_buffer)</span><span style=color:#61676ccc>;
</span><span>time_span</span><span style=color:#ed9366>.</span><span style=color:#f07171>end</span><span>(render_context</span><span style=color:#ed9366>.</span><span style=color:#f07171>command_encoder</span><span>())</span><span style=color:#61676ccc>;
</span></code></pre><p>The key insight is that <code>dlss_context.render()</code> internally uses the provided command encoder to create a new command buffer. The start timestamp needs to be on that same encoder before DLSS begins, and the end timestamp must be on it after DLSS completes. This ensures both timestamps are in the same command buffer sequence.<p>The removal of debug groups (<code>push_debug_group</code>/<code>pop_debug_group</code>) was necessary because debug groups in graphics APIs like Vulkan and DirectX 12 cannot span multiple command encoders. Since DLSS creates its own command buffer (and thus its own encoder), attempting to use debug groups across this boundary would cause validation errors or undefined behavior.<p>The documentation in <code>diagnostic/mod.rs</code> was also updated to clarify that the encoder passed to <code>time_span.end()</code> doesn’t strictly need to be the same instance, but should be the same logical encoder (or pass) to ensure timestamps are properly paired. This is important for future developers working with multi-encoder rendering patterns.<p>The impact of this fix is significant for performance profiling in Bevy applications using DLSS. Developers can now accurately measure GPU time spent in DLSS super resolution and ray reconstruction passes, enabling proper performance optimization and bottleneck identification. The Solari example was updated to display these measurements, replacing the previous “TODO” placeholder.<p>This fix demonstrates several important concepts in modern graphics programming: proper command buffer synchronization, the limitations of debug groups across encoder boundaries, and the importance of understanding how third-party libraries (like NVIDIA’s DLSS SDK) integrate with custom rendering pipelines.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Bevy Render Graph] --> B[DlssNode Execution]
</span><span>    B --> C[Obtain Command Encoder]
</span><span>    C --> D[Insert Start Timestamp]
</span><span>    D --> E[Call DLSS Render]
</span><span>    E --> F[DLSS Creates Command Buffer]
</span><span>    F --> G[Add Command Buffer to Context]
</span><span>    G --> H[Insert End Timestamp]
</span><span>    H --> I[Continue Render Graph]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ol><li><p><strong>File:</strong> <code>crates/bevy_anti_alias/src/dlss/node.rs</code></p> <p><strong>Changes:</strong> Fixed timestamp query placement for both DLSS super resolution and ray reconstruction features. Removed debug groups that couldn’t span command encoders.</p> <p><strong>Code Snippet (Super Resolution):</strong></p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>command_encoder</span><span style=color:#ed9366>.</span><span style=color:#f07171>push_debug_group</span><span>(</span><span style=color:#86b300>"dlss_super_resolution"</span><span>)</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> time_span </span><span style=color:#ed9366>=</span><span> diagnostics</span><span style=color:#ed9366>.</span><span style=color:#f07171>time_span</span><span>(command_encoder</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"dlss_super_resolution"</span><span>)</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let mut</span><span> dlss_context </span><span style=color:#ed9366>=</span><span> dlss_context</span><span style=color:#ed9366>.</span><span>context</span><span style=color:#ed9366>.</span><span style=color:#f07171>lock</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> dlss_command_buffer </span><span style=color:#ed9366>=</span><span> dlss_context</span><span style=color:#ed9366>.</span><span style=color:#f07171>render</span><span>(render_parameters</span><span style=color:#61676ccc>,</span><span> command_encoder</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>adapter)</span><span style=color:#61676ccc>;
</span><span>time_span</span><span style=color:#ed9366>.</span><span style=color:#f07171>end</span><span>(command_encoder)</span><span style=color:#61676ccc>;
</span><span>command_encoder</span><span style=color:#ed9366>.</span><span style=color:#f07171>pop_debug_group</span><span>()</span><span style=color:#61676ccc>;
</span><span>render_context</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_command_buffer</span><span>(dlss_command_buffer)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> time_span </span><span style=color:#ed9366>=</span><span> diagnostics</span><span style=color:#ed9366>.</span><span style=color:#f07171>time_span</span><span>(command_encoder</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"dlss_super_resolution"</span><span>)</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let mut</span><span> dlss_context </span><span style=color:#ed9366>=</span><span> dlss_context</span><span style=color:#ed9366>.</span><span>context</span><span style=color:#ed9366>.</span><span style=color:#f07171>lock</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> dlss_command_buffer </span><span style=color:#ed9366>=</span><span> dlss_context</span><span style=color:#ed9366>.</span><span style=color:#f07171>render</span><span>(render_parameters</span><span style=color:#61676ccc>,</span><span> command_encoder</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>adapter)</span><span style=color:#61676ccc>;
</span><span>render_context</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_command_buffer</span><span>(dlss_command_buffer)</span><span style=color:#61676ccc>;
</span><span>time_span</span><span style=color:#ed9366>.</span><span style=color:#f07171>end</span><span>(render_context</span><span style=color:#ed9366>.</span><span style=color:#f07171>command_encoder</span><span>())</span><span style=color:#61676ccc>;
</span></code></pre> <p><strong>Relation to PR:</strong> This is the core fix ensuring timestamp queries work correctly with DLSS command buffers.</p><li><p><strong>File:</strong> <code>crates/bevy_render/src/diagnostic/mod.rs</code></p> <p><strong>Changes:</strong> Updated documentation to clarify encoder requirements for timestamp queries.</p> <p><strong>Code Snippet:</strong></p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#abb0b6;font-style:italic>/// End the span. You have to provide the same encoder which was used to begin the span.
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#abb0b6;font-style:italic>/// End the span.
</span></code></pre> <p><strong>Relation to PR:</strong> Clarifies that while the encoder should be logically the same (same command buffer sequence), it doesn’t need to be the exact same instance.</p><li><p><strong>File:</strong> <code>examples/3d/solari.rs</code></p> <p><strong>Changes:</strong> Added DLSS ray reconstruction timing to the performance display.</p> <p><strong>Code Snippet:</strong></p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>text</span><span style=color:#ed9366>.</span><span style=color:#f07171>push_str</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#f07171>format!</span><span>(</span><span style=color:#86b300>"{:17}     TODO</span><span style=color:#4cbf99>\n</span><span style=color:#86b300>"</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"DLSS-RR"</span><span>))</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>(add_diagnostic)(</span><span style=color:#86b300>"DLSS-RR"</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"render/dlss_ray_reconstruction/elapsed_gpu"</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre> <p><strong>Relation to PR:</strong> Demonstrates the fix working by showing actual DLSS timing data instead of placeholder text.</p></ol><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://vulkan-tutorial.com/Drawing_a_triangle/Drawing/Command_buffers target=_blank>Vulkan Command Buffers and Synchronization</a><li><a rel="noopener nofollow noreferrer" href=https://docs.microsoft.com/en-us/windows/win32/direct3d12/recording-command-lists-and-bundles target=_blank>DirectX 12 Command Lists and Bundles</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/docs/plugins_guidelines.md#render-graph target=_blank>Bevy Render Graph Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/NVIDIA/DLSS target=_blank>NVIDIA DLSS SDK Documentation</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-01/pr_22668.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>