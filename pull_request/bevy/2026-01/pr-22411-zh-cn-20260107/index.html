<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22411 Fix shader crash in `apply_fog
        
    </title><meta content="#22411 Fix shader crash in `apply_fog" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-01/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-01-07</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2026-01/pr-22411-en-20260107>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=biao-ti>标题</h1><h2 id=ji-ben-xin-xi>基本信息</h2><ul><li><strong>标题</strong>: Fix shader crash in <code>apply_fog</code><li><strong>PR链接</strong>: https://github.com/bevyengine/bevy/pull/22411<li><strong>作者</strong>: aevyrie<li><strong>状态</strong>: 已合并<li><strong>标签</strong>: 无<li><strong>创建时间</strong>: 2026-01-07T07:30:43Z<li><strong>合并时间</strong>: 2026-01-07T09:04:03Z<li><strong>合并人</strong>: superdump</ul><h2 id=miao-shu-fan-yi>描述翻译</h2><p>修复 #22406 中报告的问题。<h3 id=jie-jue-fang-an>解决方案</h3><p>向函数中传递缺失的片段坐标（fragment coordinate）参数。<h3 id=ce-shi>测试</h3><p>延迟渲染（deferred）和大气雾（atmospheric fog）示例不再出现故障。<h2 id=ben-ci-pr-de-ji-shu-fen-xi>本次 PR 的技术分析</h2><p>这是一个典型的着色器参数传递错误修复案例。问题出现在 Bevy 的物理渲染（PBR）着色器中，具体在 <code>apply_fog</code> 函数实现上。<h3 id=wen-ti-gen-yin-fen-xi>问题根因分析</h3><p>在最初的实现中，<code>apply_fog</code> 函数被设计为需要片段坐标（fragment coordinate）来支持雾效计算中的阴影采样。然而，在函数的参数列表中，这个必需的 <code>frag_coord_xy</code> 参数被遗漏了。<p>当 <code>DISTANCE_FOG</code> 宏被定义，且启用雾效的材质需要调用 <code>apply_fog</code> 函数时，<code>shadows::fetch_directional_shadow</code> 函数需要一个 <code>vec2&LTf32></code> 类型的片段坐标参数来进行阴影贴图采样。原始代码试图使用 <code>in.frag_coord.xy</code>，但在 <code>apply_fog</code> 函数的上下文中，<code>in</code> 结构体并不可用。<p>这是一个典型的跨函数参数传递不完整的问题。虽然 <code>apply_fog</code> 函数内部需要这个参数，但调用方没有提供，而函数签名也没有声明需要这个参数。<h3 id=jie-jue-fang-an-shi-xian>解决方案实现</h3><p>修复方案直接明了：更新 <code>apply_fog</code> 函数的签名，添加缺失的 <code>frag_coord_xy: vec2&LTf32></code> 参数，同时在所有调用站点更新参数传递。<p>具体更改包括：<ol><li>修改 <code>apply_fog</code> 函数签名，添加 <code>frag_coord_xy: vec2&LTf32></code> 参数<li>在函数内部，将 <code>shadows::fetch_directional_shadow</code> 调用的第四个参数从 <code>in.frag_coord.xy</code> 改为传入的 <code>frag_coord_xy</code><li>在 <code>main_pass_post_lighting_processing</code> 函数中调用 <code>apply_fog</code> 时，传递正确的片段坐标 <code>pbr_input.frag_coord.xy</code></ol><p>这种修复方式遵循了 WGSL 着色语言的标准参数传递模式。通过显式声明所有必需的参数，确保函数在不同上下文中的可移植性和正确性。<h3 id=ji-shu-xi-jie-shuo-ming>技术细节说明</h3><p>在 Bevy 的渲染管线中，雾效计算需要访问多个空间坐标：<ul><li><code>fragment_world_position</code>: 片段在世界空间中的位置<li><code>view_world_position</code>: 摄像机在世界空间中的位置<li><code>frag_coord_xy</code>: 片段在屏幕空间中的坐标（用于阴影采样）</ul><p><code>shadows::fetch_directional_shadow</code> 函数需要屏幕空间坐标来查询阴影贴图。这是实现基于屏幕空间的阴影技术（screen-space shadows）的标准做法，可以高效地确定当前片段是否处于阴影中。<p>从工程角度看，这个问题的出现暴露了着色器开发中的一个常见陷阱：当函数实现需要访问特定上下文中的变量时，必须确保这些变量通过参数显式传递，而不是隐式依赖外部作用域。在 WGSL 中，没有全局变量（除了 uniform 和 storage 资源），因此参数传递是函数间数据交换的唯一方式。<h3 id=ying-xiang-fan-wei>影响范围</h3><p>这个修复解决了两个关键示例的崩溃问题：<ul><li><strong>延迟渲染示例</strong>：在延迟渲染路径中，雾效计算需要正确的参数传递<li><strong>大气雾示例</strong>：专门展示大气散射和雾效的示例，直接依赖 <code>apply_fog</code> 函数</ul><p>虽然问题表现为示例崩溃，但这个修复实际上影响所有使用 <code>DISTANCE_FOG</code> 功能并启用了雾效的材质。没有这个修复，任何试图使用雾效的场景都可能遇到着色器编译错误或运行时错误。<h3 id=dai-ma-zhi-liang-kao-liang>代码质量考量</h3><p>从代码维护角度，这个修复采用了最小修改原则（minimal change principle）：<ul><li>只修改必要的地方<li>保持函数接口的一致性<li>不引入不必要的重构</ul><p>这种保守的修复方式对于着色器代码特别重要，因为着色器编译错误通常难以调试，且微小的语法错误就会导致整个渲染管线失败。<h2 id=ke-shi-hua-guan-xi>可视化关系</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[main_pass_post_lighting_processing] --> B[调用 apply_fog]
</span><span>    B --> C[需要 fragment_world_position]
</span><span>    B --> D[需要 view_world_position]
</span><span>    B --> E[需要 frag_coord_xy]
</span><span>    E --> F[shadows::fetch_directional_shadow]
</span><span>    F --> G[阴影贴图采样]
</span><span>    
</span><span>    style B fill:#e1f5fe
</span><span>    style E fill:#fff3e0
</span></code></pre><h2 id=guan-jian-wen-jian-bian-geng>关键文件变更</h2><h3 id=crates-bevy-pbr-src-render-pbr-functions-wgsl-15-3><code>crates/bevy_pbr/src/render/pbr_functions.wgsl</code> (+15/-3)</h3><p>这个文件包含 Bevy 的物理渲染着色器函数。具体更改发生在雾效计算相关的函数中。<p><strong>修改前:</strong><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>fn apply_fog(fog_params: mesh_view_types::Fog, input_color: vec4&LTf32>, fragment_world_position: vec3&LTf32>, view_world_position: vec3&LTf32>) -> vec4&LTf32> {
</span><span>    // ...
</span><span>    shadow = shadows::fetch_directional_shadow(i, fragment_world_position_vec4, view_direction_normal, view_z, in.frag_coord.xy);
</span><span>    // ...
</span><span>}
</span><span>
</span><span>// 调用处
</span><span>output_color = apply_fog(view_bindings::fog, output_color, pbr_input.world_position.xyz, view_bindings::view.world_position.xyz);
</span></code></pre><p><strong>修改后:</strong><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>fn apply_fog(
</span><span>    fog_params: mesh_view_types::Fog,
</span><span>    input_color: vec4&LTf32>,
</span><span>    fragment_world_position: vec3&LTf32>,
</span><span>    view_world_position: vec3&LTf32>,
</span><span>    frag_coord_xy: vec2&LTf32>,  // 新增参数
</span><span>) -> vec4&LTf32> {
</span><span>    // ...
</span><span>    shadow = shadows::fetch_directional_shadow(i, fragment_world_position_vec4, view_direction_normal, view_z, frag_coord_xy);  // 使用传入的参数
</span><span>    // ...
</span><span>}
</span><span>
</span><span>// 调用处
</span><span>output_color = apply_fog(
</span><span>    view_bindings::fog,
</span><span>    output_color,
</span><span>    pbr_input.world_position.xyz,
</span><span>    view_bindings::view.world_position.xyz,
</span><span>    pbr_input.frag_coord.xy,  // 传递片段坐标
</span><span>);
</span></code></pre><p><strong>更改说明:</strong><ol><li>函数签名中添加了 <code>frag_coord_xy: vec2&LTf32></code> 参数<li>内部调用 <code>shadows::fetch_directional_shadow</code> 时使用传入的 <code>frag_coord_xy</code> 而不是不存在的 <code>in.frag_coord.xy</code><li>调用站点现在显式传递 <code>pbr_input.frag_coord.xy</code> 作为参数</ol><h2 id=yan-shen-yue-du>延伸阅读</h2><ol><li><strong>WGSL 着色语言规范</strong>: <a rel="noopener nofollow noreferrer" href=https://www.w3.org/TR/WGSL/ target=_blank>WebGPU Shading Language</a><li><strong>Bevy 渲染管线文档</strong>: <a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/rendering/pipeline.html target=_blank>Bevy Render Pipeline</a><li><strong>基于屏幕空间的阴影技术</strong>: <a rel="noopener nofollow noreferrer" href=https://learnopengl.com/Guest-Articles/2021/Scene/Screen-Space-Shadows target=_blank>Screen Space Shadows</a><li><strong>延迟渲染中的雾效实现</strong>: <a rel="noopener nofollow noreferrer" href=https://lettier.github.io/3d-game-shaders-for-beginners/fog.html target=_blank>Fog in Deferred Rendering</a></ol><h1 id=wan-zheng-dai-ma-chai-yi>完整代码差异</h1><pre style=color:#61676c;background-color:#fafafa><code><span>diff --git a/crates/bevy_pbr/src/render/pbr_functions.wgsl b/crates/bevy_pbr/src/render/pbr_functions.wgsl
</span><span>index f62d85c155b33..c53820ab0ba0a 100644
</span><span>--- a/crates/bevy_pbr/src/render/pbr_functions.wgsl
</span><span>+++ b/crates/bevy_pbr/src/render/pbr_functions.wgsl
</span><span>@@ -761,7 +761,13 @@ fn apply_pbr_lighting(
</span><span> #endif // PREPASS_FRAGMENT
</span><span> 
</span><span> #ifdef DISTANCE_FOG
</span><span>-fn apply_fog(fog_params: mesh_view_types::Fog, input_color: vec4&LTf32>, fragment_world_position: vec3&LTf32>, view_world_position: vec3&LTf32>) -> vec4&LTf32> {
</span><span>+fn apply_fog(
</span><span>+    fog_params: mesh_view_types::Fog,
</span><span>+    input_color: vec4&LTf32>,
</span><span>+    fragment_world_position: vec3&LTf32>,
</span><span>+    view_world_position: vec3&LTf32>,
</span><span>+    frag_coord_xy: vec2&LTf32>,
</span><span>+) -> vec4&LTf32> {
</span><span>     let view_to_world = fragment_world_position.xyz - view_world_position.xyz;
</span><span> 
</span><span>     // `length()` is used here instead of just `view_to_world.z` since that produces more
</span><span>@@ -795,7 +801,7 @@ fn apply_fog(fog_params: mesh_view_types::Fog, input_color: vec4&LTf32>, fragment_
</span><span>             // Sample shadow map to attenuate inscattering in shadowed areas
</span><span>             var shadow: f32 = 1.0;
</span><span>             if ((light.flags & mesh_view_types::DIRECTIONAL_LIGHT_FLAGS_SHADOWS_ENABLED_BIT) != 0u) {
</span><span>-                shadow = shadows::fetch_directional_shadow(i, fragment_world_position_vec4, view_direction_normal, view_z, in.frag_coord.xy);
</span><span>+                shadow = shadows::fetch_directional_shadow(i, fragment_world_position_vec4, view_direction_normal, view_z, frag_coord_xy);
</span><span>             }
</span><span>             scattering += scattering_contribution * shadow;
</span><span>         }
</span><span>@@ -878,7 +884,13 @@ fn main_pass_post_lighting_processing(
</span><span> #ifdef DISTANCE_FOG
</span><span>     // fog
</span><span>     if ((pbr_input.material.flags & pbr_types::STANDARD_MATERIAL_FLAGS_FOG_ENABLED_BIT) != 0u) {
</span><span>-        output_color = apply_fog(view_bindings::fog, output_color, pbr_input.world_position.xyz, view_bindings::view.world_position.xyz);
</span><span>+        output_color = apply_fog(
</span><span>+            view_bindings::fog,
</span><span>+            output_color,
</span><span>+            pbr_input.world_position.xyz,
</span><span>+            view_bindings::view.world_position.xyz,
</span><span>+            pbr_input.frag_coord.xy,
</span><span>+        );
</span><span>     }
</span><span> #endif  // DISTANCE_FOG
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-01/pr_22411.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>