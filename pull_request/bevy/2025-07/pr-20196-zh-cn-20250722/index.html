<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20196 Clean up `NodeId` kind fetching
        
    </title><meta content="#20196 Clean up `NodeId` kind fetching" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-07/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-07-22</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2025-07/pr-20196-en-20250722>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h3 id=clean-up-nodeid-kind-fetching>Clean up <code>NodeId</code> kind fetching</h3><h4 id=ji-ben-xin-xi>基本信息</h4><ul><li><strong>标题</strong>: Clean up <code>NodeId</code> kind fetching<li><strong>PR链接</strong>: https://github.com/bevyengine/bevy/pull/20196<li><strong>作者</strong>: ItsDoot<li><strong>状态</strong>: 已合并<li><strong>标签</strong>: D-Trivial, A-ECS, C-Code-Quality, S-Ready-For-Final-Review, D-Domain-Agnostic<li><strong>创建时间</strong>: 2025-07-19T08:49:34Z<li><strong>合并时间</strong>: 2025-07-21T23:31:55Z<li><strong>合并人</strong>: alice-i-cecile</ul><h4 id=miao-shu-fan-yi>描述翻译</h4><p><strong>Objective</strong><ul><li>#20115 的一部分</ul><p>我们实际上不需要依赖 <code>ScheduleGraph</code> 来获取节点的类型(kind)，因此将其移至新创建的 trait。<p><strong>Solution</strong><ul><li>移除 <code>ScheduleGraph::get_node_kind</code>，改为添加 <code>GraphNodeId::kind</code><li>将 <code>GraphNodeId</code> 移到与 <code>DiGraph</code>/<code>UnGraph</code>/<code>Graph</code> 相同的文件中<li>为保持对称性，为 <code>SystemSetKey</code> 实现 <code>GraphNodeId</code></ul><p>无需迁移指南，因为 <code>get_node_kind</code> 是私有函数。<p><strong>Testing</strong> 复用现有测试。<hr><h3 id=ji-shu-fen-xi-bao-gao>技术分析报告</h3><h4 id=wen-ti-bei-jing>问题背景</h4><p>在 Bevy ECS 的调度图(schedule graph)实现中，获取节点类型（如区分 system 或 system set）是通过 <code>ScheduleGraph::get_node_kind</code> 方法完成的。这种方法存在两个问题：<ol><li>不必要的耦合：获取节点类型本质上是节点自身的属性，却依赖外部容器 <code>ScheduleGraph</code><li>代码冗余：相同逻辑在多个地方重复实现（如错误消息生成）</ol><p>原实现片段：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// crates/bevy_ecs/src/schedule/schedule.rs
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>get_node_kind</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>id</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>NodeId) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'static str </span><span>{
</span><span>    </span><span style=color:#fa6e32>match</span><span> id {
</span><span>        NodeId</span><span style=color:#ed9366>::</span><span>System(</span><span style=color:#ed9366>_</span><span>) </span><span style=color:#ed9366>=> </span><span style=color:#86b300>"system"</span><span style=color:#61676ccc>,
</span><span>        NodeId</span><span style=color:#ed9366>::</span><span>Set(</span><span style=color:#ed9366>_</span><span>) </span><span style=color:#ed9366>=> </span><span style=color:#86b300>"system set"</span><span style=color:#61676ccc>,
</span><span>    }
</span><span>}
</span></code></pre><h4 id=jie-jue-fang-an>解决方案</h4><p>核心思路是将节点类型查询行为内聚到节点自身：<ol><li>在 <code>GraphNodeId</code> trait 添加 <code>kind()</code> 方法<li>为所有节点类型实现该方法<li>移除原本分散的 <code>get_node_kind</code> 实现</ol><p>关键修改点：<ul><li>将类型查询逻辑下放到具体节点类型<li>消除对 <code>ScheduleGraph</code> 的不必要依赖<li>保持 <code>SystemKey</code> 和 <code>SystemSetKey</code> 的对称实现</ul><h4 id=ju-ti-shi-xian>具体实现</h4><p><strong>1. 重构 GraphNodeId trait</strong> 将 trait 迁移到 graph_map.rs 并添加 kind 方法：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// crates/bevy_ecs/src/schedule/graph/graph_map.rs
</span><span style=color:#fa6e32>pub trait </span><span style=color:#399ee6>GraphNodeId</span><span>: Copy + Eq + Hash + Ord + Debug {
</span><span>    </span><span style=color:#ed9366>...
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>kind</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'static str</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p><strong>2. 实现节点类型查询</strong> 为不同节点类型提供具体实现：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// crates/bevy_ecs/src/schedule/node.rs
</span><span style=color:#fa6e32>impl </span><span>GraphNodeId </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>SystemKey </span><span>{
</span><span>    </span><span style=color:#ed9366>...
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>kind</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'static str </span><span>{
</span><span>        </span><span style=color:#86b300>"system"
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#fa6e32>impl </span><span>GraphNodeId </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>SystemSetKey </span><span>{
</span><span>    </span><span style=color:#ed9366>...
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>kind</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'static str </span><span>{
</span><span>        </span><span style=color:#86b300>"system set"
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#fa6e32>impl </span><span>GraphNodeId </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>NodeId </span><span>{
</span><span>    </span><span style=color:#ed9366>...
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>kind</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'static str </span><span>{
</span><span>        </span><span style=color:#fa6e32>match </span><span style=color:#55b4d4;font-style:italic>self </span><span>{
</span><span>            NodeId</span><span style=color:#ed9366>::</span><span>System(n) </span><span style=color:#ed9366>=></span><span> n</span><span style=color:#ed9366>.</span><span style=color:#f07171>kind</span><span>()</span><span style=color:#61676ccc>,
</span><span>            NodeId</span><span style=color:#ed9366>::</span><span>Set(n) </span><span style=color:#ed9366>=></span><span> n</span><span style=color:#ed9366>.</span><span style=color:#f07171>kind</span><span>()</span><span style=color:#61676ccc>,
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre><p><strong>3. 移除旧实现</strong> 删除原本的辅助方法和文件：<pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>// crates/bevy_ecs/src/schedule/schedule.rs
</span><span style=color:#f07171>- fn get_node_kind(&self, id: &NodeId) -> &'static str {
</span><span style=color:#f07171>-     match id {
</span><span style=color:#f07171>-         NodeId::System(_) => "system",
</span><span style=color:#f07171>-         NodeId::Set(_) => "system set",
</span><span style=color:#f07171>-     }
</span><span style=color:#f07171>- }
</span></code></pre><p><strong>4. 调用点改造</strong> 所有使用点改为直接调用 trait 方法：<pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>// 错误消息生成
</span><span>writeln!(
</span><span>    message,
</span><span>    " -- {} `{}` cannot be child of set `{}`, longer path exists",
</span><span style=color:#f07171>-    self.get_node_kind(child),
</span><span style=color:#86b300>+    child.kind(),
</span><span>    self.get_node_name(child),
</span><span>    self.get_node_name(parent),
</span><span>)
</span></code></pre><h4 id=gong-cheng-jia-zhi>工程价值</h4><ol><li><strong>降低耦合度</strong>：节点类型查询不再依赖图结构<li><strong>提高内聚性</strong>：节点行为封装在对应实现中<li><strong>消除冗余</strong>：删除 16 行重复逻辑代码<li><strong>扩展性</strong>：新增节点类型只需实现 trait 即可<li><strong>对称设计</strong>：<code>SystemSetKey</code> 获得与 <code>SystemKey</code> 一致的处理</ol><h4 id=ji-shu-dong-cha>技术洞察</h4><p>此修改展示了 Rust trait 的典型应用场景：<ol><li>将行为抽象为接口（<code>GraphNodeId</code>）<li>为具体类型提供默认实现（<code>kind()</code>）<li>通过 trait bound 约束类型能力</ol><p>特别值得注意的是对枚举类型 <code>NodeId</code> 的处理技巧：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>match </span><span style=color:#55b4d4;font-style:italic>self </span><span>{
</span><span>    NodeId</span><span style=color:#ed9366>::</span><span>System(n) </span><span style=color:#ed9366>=></span><span> n</span><span style=color:#ed9366>.</span><span style=color:#f07171>kind</span><span>()</span><span style=color:#61676ccc>,  </span><span style=color:#abb0b6;font-style:italic>// 委托给内部类型实现
</span><span>    NodeId</span><span style=color:#ed9366>::</span><span>Set(n) </span><span style=color:#ed9366>=></span><span> n</span><span style=color:#ed9366>.</span><span style=color:#f07171>kind</span><span>()</span><span style=color:#61676ccc>,
</span><span>}
</span></code></pre><p>这种模式避免了在枚举层级重复实现，符合 DRY 原则。<hr><h3 id=zu-jian-guan-xi-tu>组件关系图</h3><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[GraphNodeId trait] --> B[SystemKey]
</span><span>    A --> C[SystemSetKey]
</span><span>    A --> D[NodeId]
</span><span>    D -->|委托| B
</span><span>    D -->|委托| C
</span><span>    E[ScheduleGraph] -. 移除依赖 .-> A
</span></code></pre><hr><h3 id=guan-jian-wen-jian-bian-geng>关键文件变更</h3><p><strong>1. graph_map.rs (+23/-5)</strong><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span style=color:#86b300>+ pub trait GraphNodeId: Copy + Eq + Hash + Ord + Debug {
</span><span style=color:#86b300>+     ...
</span><span style=color:#86b300>+     fn kind(&self) -> &'static str;
</span><span style=color:#86b300>+ }
</span></code></pre><p><strong>2. node.rs (+20/-0)</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>impl </span><span>GraphNodeId </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>SystemKey </span><span>{
</span><span>    </span><span style=color:#ed9366>...
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>kind</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'static str </span><span>{
</span><span>        </span><span style=color:#86b300>"system"
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#fa6e32>impl </span><span>GraphNodeId </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>SystemSetKey </span><span>{
</span><span>    </span><span style=color:#ed9366>...
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>kind</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'static str </span><span>{
</span><span>        </span><span style=color:#86b300>"system set"
</span><span>    }
</span><span>}
</span></code></pre><p><strong>3. schedule.rs (+4/-14)</strong><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span style=color:#f07171>- fn get_node_kind(&self, id: &NodeId) -> &'static str {
</span><span style=color:#f07171>-     match id {
</span><span style=color:#f07171>-         NodeId::System(_) => "system",
</span><span style=color:#f07171>-         NodeId::Set(_) => "system set",
</span><span style=color:#f07171>-     }
</span><span style=color:#f07171>- }
</span></code></pre><p><strong>4. node.rs (删除文件)(+0/-16)</strong><br> 原文件内容：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub trait </span><span style=color:#399ee6>GraphNodeId</span><span>: Copy + Eq + Hash + Ord + Debug {
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Adjacent</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Copy </span><span style=color:#ed9366>+</span><span> Debug </span><span style=color:#ed9366>+ </span><span style=color:#55b4d4;font-style:italic>From</span><span><(</span><span style=color:#fa6e32>Self</span><span>, Direction)> </span><span style=color:#ed9366>+ </span><span style=color:#55b4d4;font-style:italic>Into</span><span><(</span><span style=color:#fa6e32>Self</span><span>, Direction)></span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Edge</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Copy </span><span style=color:#ed9366>+ </span><span style=color:#55b4d4;font-style:italic>Eq </span><span style=color:#ed9366>+</span><span> Hash </span><span style=color:#ed9366>+</span><span> Debug </span><span style=color:#ed9366>+ </span><span style=color:#55b4d4;font-style:italic>From</span><span><(</span><span style=color:#fa6e32>Self</span><span>, </span><span style=color:#fa6e32>Self</span><span>)> </span><span style=color:#ed9366>+ </span><span style=color:#55b4d4;font-style:italic>Into</span><span><(</span><span style=color:#fa6e32>Self</span><span>, </span><span style=color:#fa6e32>Self</span><span>)></span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p><strong>5. tarjan_scc.rs (+4/-5)</strong><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span style=color:#f07171>- use crate::schedule::graph::node::GraphNodeId;
</span><span style=color:#f07171>- use super::DiGraph;
</span><span style=color:#86b300>+ use crate::schedule::graph::{DiGraph, GraphNodeId};
</span></code></pre><hr><h3 id=kuo-zhan-yue-du>扩展阅读</h3><ol><li>Rust trait 设计指南：https://doc.rust-lang.org/book/ch10-02-traits.html<li>Bevy ECS 调度系统文档：https://bevyengine.org/learn/book/getting-started/ecs/<li>面向接口编程原则：https://en.wikipedia.org/wiki/Interface-based_programming</ol><hr><h3 id=wan-zheng-dai-ma-bian-geng>完整代码变更</h3><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_ecs/src/schedule/graph/graph_map.rs b/crates/bevy_ecs/src/schedule/graph/graph_map.rs
</span><span>index a2a5b0801e009..09f3a1df353be 100644
</span><span style=color:#c594c5>--- a/crates/bevy_ecs/src/schedule/graph/graph_map.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_ecs/src/schedule/graph/graph_map.rs
</span><span style=color:#c594c5>@@ -5,18 +5,36 @@
</span><span> //! [`petgraph`]: https://docs.rs/petgraph/0.6.5/petgraph/
</span><span> 
</span><span> use alloc::vec::Vec;
</span><span style=color:#f07171>-use bevy_platform::{collections::HashSet, hash::FixedHasher};
</span><span> use core::{
</span><span style=color:#f07171>-    fmt,
</span><span style=color:#86b300>+    fmt::{self, Debug},
</span><span>     hash::{BuildHasher, Hash},
</span><span> };
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+use bevy_platform::{collections::HashSet, hash::FixedHasher};
</span><span> use indexmap::IndexMap;
</span><span> use smallvec::SmallVec;
</span><span> 
</span><span style=color:#f07171>-use crate::schedule::graph::node::GraphNodeId;
</span><span style=color:#f07171>-
</span><span> use Direction::{Incoming, Outgoing};
</span><span> 
</span><span style=color:#86b300>+/// Types that can be used as node identifiers in a [`DiGraph`]/[`UnGraph`].
</span><span style=color:#86b300>+///
</span><span style=color:#86b300>+/// [`DiGraph`]: crate::schedule::graph::DiGraph
</span><span style=color:#86b300>+/// [`UnGraph`]: crate::schedule::graph::UnGraph
</span><span style=color:#86b300>+pub trait GraphNodeId: Copy + Eq + Hash + Ord + Debug {
</span><span style=color:#86b300>+    /// The type that packs and unpacks this [`GraphNodeId`] with a [`Direction`].
</span><span style=color:#86b300>+    /// This is used to save space in the graph's adjacency list.
</span><span style=color:#86b300>+    type Adjacent: Copy + Debug + From<(Self, Direction)> + Into<(Self, Direction)>;
</span><span style=color:#86b300>+    /// The type that packs and unpacks this [`GraphNodeId`] with another
</span><span style=color:#86b300>+    /// [`GraphNodeId`]. This is used to save space in the graph's edge list.
</span><span style=color:#86b300>+    type Edge: Copy + Eq + Hash + Debug + From<(Self, Self)> + Into<(Self, Self)>;
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+    /// Name of the kind of this node id.
</span><span style=color:#86b300>+    ///
</span><span style=color:#86b300>+    /// For structs, this should return a human-readable name of the struct.
</span><span style=color:#86b300>+    /// For enums, this should return a human-readable name of the enum variant.
</span><span style=color:#86b300>+    fn kind(&self) -> &'static str;
</span><span style=color:#86b300>+}
</span><span style=color:#86b300>+
</span><span> /// A `Graph` with undirected edges of some [`GraphNodeId`] `N`.
</span><span> ///
</span><span> /// For example, an edge between *1* and *2* is equivalent to an edge between
</span><span style=color:#c594c5>@@ -55,7 +73,7 @@ </span><span style=color:#399ee6>where
</span><span>     edges: HashSet&LTN::Edge, S>,
</span><span> }
</span><span> 
</span><span style=color:#f07171>-impl&LTconst DIRECTED: bool, N: GraphNodeId, S: BuildHasher> fmt::Debug for Graph&LTDIRECTED, N, S> {
</span><span style=color:#86b300>+impl&LTconst DIRECTED: bool, N: GraphNodeId, S: BuildHasher> Debug for Graph&LTDIRECTED, N, S> {
</span><span>     fn fmt(&self, f: &mut fmt::Formatter) -> fmt::Result {
</span><span>         self.nodes.fmt(f)
</span><span>     }
</span><span>diff --git a/crates/bevy_ecs/src/schedule/graph/mod.rs b/crates/bevy_ecs/src/schedule/graph/mod.rs
</span><span>index a88034a6a7fdb..0ad0190b031ab 100644
</span><span style=color:#c594c5>--- a/crates/bevy_ecs/src/schedule/graph/mod.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_ecs/src/schedule/graph/mod.rs
</span><span style=color:#c594c5>@@ -13,11 +13,9 @@ </span><span style=color:#399ee6>use fixedbitset::FixedBitSet;
</span><span> use crate::schedule::set::*;
</span><span> 
</span><span> mod graph_map;
</span><span style=color:#f07171>-mod node;
</span><span> mod tarjan_scc;
</span><span> 
</span><span style=color:#f07171>-pub use graph_map::{DiGraph, Direction, UnGraph};
</span><span style=color:#f07171>-pub use node::GraphNodeId;
</span><span style=color:#86b300>+pub use graph_map::{DiGraph, Direction, GraphNodeId, UnGraph};
</span><span> 
</span><span> /// Specifies what kind of edge should be added to the dependency graph.
</span><span> #[derive(Debug, Clone, Copy, Eq, PartialEq, PartialOrd, Ord, Hash)]
</span><span>diff --git a/crates/bevy_ecs/src/schedule/graph/node.rs b/crates/bevy_ecs/src/schedule/graph/node.rs
</span><span>deleted file mode 100644
</span><span>index c3ab19c9da31d..0000000000000
</span><span style=color:#c594c5>--- a/crates/bevy_ecs/src/schedule/graph/node.rs
</span><span style=color:#c594c5>+++ /dev/null
</span><span style=color:#c594c5>@@ -1,16 +0,0 @@
</span><span style=color:#f07171>-use core::{fmt::Debug, hash::Hash};
</span><span style=color:#f07171>-
</span><span style=color:#f07171>-use crate::schedule::graph::Direction;
</span><span style=color:#f07171>-
</span><span style=color:#f07171>-/// Types that can be used as node identifiers in a [`DiGraph`]/[`UnGraph`].
</span><span style=color:#f07171>-///
</span><span style=color:#f07171>-/// [`DiGraph`]: crate::schedule::graph::DiGraph
</span><span style=color:#f07171>-/// [`UnGraph`]: crate::schedule::graph::UnGraph
</span><span style=color:#f07171>-pub trait GraphNodeId: Copy + Eq + Hash + Ord + Debug {
</span><span style=color:#f07171>-    /// The type that packs and unpacks this [`GraphNodeId`] with a [`Direction`].
</span><span style=color:#f07171>-    /// This is used to save space in the graph's adjacency list.
</span><span style=color:#f07171>-    type Adjacent: Copy + Debug + From<(Self, Direction)> + Into<(Self, Direction)>;
</span><span style=color:#f07171>-    /// The type that packs and unpacks this [`GraphNodeId`] with another
</span><span style=color:#f07171>-    /// [`GraphNodeId`]. This is used to save space in the graph's edge list.
</span><span style=color:#f07171>-    type Edge: Copy + Eq + Hash + Debug + From<(Self, Self)> + Into<(Self, Self)>;
</span><span style=color:#f07171>-}
</span><span>diff --git a/crates/bevy_ecs/src/schedule/graph/tarjan_scc.rs b/crates/bevy_ecs/src/schedule/graph/tarjan_scc.rs
</span><span>index 309ec321baa03..23584cab95f38 100644
</span><span style=color:#c594c5>--- a/crates/bevy_ecs/src/schedule/graph/tarjan_scc.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_ecs/src/schedule/graph/tarjan_scc.rs
</span><span style=color:#c594c5>@@ -1,11 +1,10 @@
</span><span style=color:#f07171>-use crate::schedule::graph::node::GraphNodeId;
</span><span style=color:#f07171>-
</span><span style=color:#f07171>-use super::DiGraph;
</span><span> use alloc::vec::Vec;
</span><span style=color:#f07171>-use core::hash::BuildHasher;
</span><span style=color:#f07171>-use core::num::NonZeroUsize;
</span><span style=color:#86b300>+use core::{hash::BuildHasher, num::NonZeroUsize};
</span><span style=color:#86b300>+
</span><span> use smallvec::SmallVec;
</span><span> 
</span><span style=color:#86b300>+use crate::schedule::graph::{DiGraph, GraphNodeId};
</span><span style=color:#86b300>+
</span><span> /// Create an iterator over *strongly connected components* using Algorithm 3 in
</span><span> /// [A Space-Efficient Algorithm for Finding Strongly Connected Components][1] by David J. Pierce,
</span><span> /// which is a memory-efficient variation of [Tarjan's algorithm][2].
</span><span>diff --git a/crates/bevy_ecs/src/schedule/node.rs b/crates/bevy_ecs/src/schedule/node.rs
</span><span>index 36005cf0c9ee8..75c5c71ae8ce8 100644
</span><span style=color:#c594c5>--- a/crates/bevy_ecs/src/schedule/node.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_ecs/src/schedule/node.rs
</span><span style=color:#c594c5>@@ -258,6 +258,19 @@ </span><span style=color:#399ee6>new_key_type! {
</span><span> impl GraphNodeId for SystemKey {
</span><span>     type Adjacent = (SystemKey, Direction);
</span><span>     type Edge = (SystemKey, SystemKey);
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+    fn kind(&self) -> &'static str {
</span><span style=color:#86b300>+        "system"
</span><span style=color:#86b300>+    }
</span><span style=color:#86b300>+}
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+impl GraphNodeId for SystemSetKey {
</span><span style=color:#86b300>+    type Adjacent = (SystemSetKey, Direction);
</span><span style=color:#86b300>+    type Edge = (SystemSetKey, SystemSetKey);
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+    fn kind(&self) -> &'static str {
</span><span style=color:#86b300>+        "system set"
</span><span style=color:#86b300>+    }
</span><span> }
</span><span> 
</span><span> impl TryFrom&LTNodeId> for SystemKey {
</span><span style=color:#c594c5>@@ -324,6 +337,13 @@ </span><span style=color:#399ee6>impl NodeId {
</span><span> impl GraphNodeId for NodeId {
</span><span>     type Adjacent = CompactNodeIdAndDirection;
</span><span>     type Edge = CompactNodeIdPair;
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+    fn kind(&self) -> &'static str {
</span><span style=color:#86b300>+        match self {
</span><span style=color:#86b300>+            NodeId::System(n) => n.kind(),
</span><span style=color:#86b300>+            NodeId::Set(n) => n.kind(),
</span><span style=color:#86b300>+        }
</span><span style=color:#86b300>+    }
</span><span> }
</span><span> 
</span><span> impl From&LTSystemKey> for NodeId {
</span><span>diff --git a/crates/bevy_ecs/src/schedule/schedule.rs b/crates/bevy_ecs/src/schedule/schedule.rs
</span><span>index 6a13e6c4ff22c..8404ccf350935 100644
</span><span style=color:#c594c5>--- a/crates/bevy_ecs/src/schedule/schedule.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_ecs/src/schedule/schedule.rs
</span><span style=color:#c594c5>@@ -1443,13 +1443,6 @@ </span><span style=color:#399ee6>impl ScheduleGraph {
</span><span>         )
</span><span>     }
</span><span> 
</span><span style=color:#f07171>-    fn get_node_kind(&self, id: &NodeId) -> &'static str {
</span><span style=color:#f07171>-        match id {
</span><span style=color:#f07171>-            NodeId::System(_) => "system",
</span><span style=color:#f07171>-            NodeId::Set(_) => "system set",
</span><span style=color:#f07171>-        }
</span><span style=color:#f07171>-    }
</span><span style=color:#f07171>-
</span><span>     /// If [`ScheduleBuildSettings::hierarchy_detection`] is [`LogLevel::Ignore`] this check
</span><span>     /// is skipped.
</span><span>     fn optionally_check_hierarchy_conflicts(
</span><span style=color:#c594c5>@@ -1481,7 +1474,7 @@ </span><span style=color:#399ee6>impl ScheduleGraph {
</span><span>             writeln!(
</span><span>                 message,
</span><span>                 " -- {} `{}` cannot be child of set `{}`, longer path exists",
</span><span style=color:#f07171>-                self.get_node_kind(child),
</span><span style=color:#86b300>+                child.kind(),
</span><span>                 self.get_node_name(child),
</span><span>                 self.get_node_name(parent),
</span><span>             )
</span><span style=color:#c594c5>@@ -1585,12 +1578,9 @@ </span><span style=color:#399ee6>impl ScheduleGraph {
</span><span>     ) -> String {
</span><span>         let mut message = format!("schedule has {} before/after cycle(s):\n", cycles.len());
</span><span>         for (i, cycle) in cycles.iter().enumerate() {
</span><span style=color:#f07171>-            let mut names = cycle.iter().map(|&id| {
</span><span style=color:#f07171>-                (
</span><span style=color:#f07171>-                    self.get_node_kind(&id.into()),
</span><span style=color:#f07171>-                    self.get_node_name(&id.into()),
</span><span style=color:#f07171>-                )
</span><span style=color:#f07171>-            });
</span><span style=color:#86b300>+            let mut names = cycle
</span><span style=color:#86b300>+                .iter()
</span><span style=color:#86b300>+                .map(|&id| (id.into().kind(), self.get_node_name(&id.into())));
</span><span>             let (first_kind, first_name) = names.next().unwrap();
</span><span>             writeln!(
</span><span>                 message,
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-07/pr_20196.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>