<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19929 bevy_reflect: Avoid trait bounds on non-generic types
        
    </title><meta content="#19929 bevy_reflect: Avoid trait bounds on non-generic types" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-07/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-07-07</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-07/pr-19929-zh-cn-20250707>中文</a></div></div><div class=pr-content><h1 id=technical-report-pr-19929-bevy-reflect-avoid-trait-bounds-on-non-generic-types>Technical Report: PR #19929 - bevy_reflect: Avoid trait bounds on non-generic types</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: bevy_reflect: Avoid trait bounds on non-generic types<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19929<li><strong>Author</strong>: nnethercote<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Performance, C-Code-Quality, S-Ready-For-Final-Review, A-Reflection, X-Uncontroversial, D-Macros<li><strong>Created</strong>: 2025-07-03T00:45:16Z<li><strong>Merged</strong>: 2025-07-07T20:14:33Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>All the derived reflection methods currently have multiple trait bounds on non-generic field types, which serve no purpose. The are emitted because “emit bounds on all fields” is easier than “emit bounds on fields that need them”. But improving things isn’t too hard.<p>Similarly, lots of useless <code>Any + Send + Sync</code> bounds exist on non-generic types.<p>Helps a lot with #19873.<h2 id=solution>Solution</h2><p>Remove the unnecessary bounds by only emitting them if the relevant type is generic.<h2 id=testing>Testing</h2><p>I used <code>cargo expand</code> to confirm the unnecessary bounds are no longer produced.<p><code>-Zmacro-stats</code> output tells me this reduces the size of the <code>Reflect</code> code produced for <code>bevy_ui</code> by 21.2%.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=problem-identification>Problem Identification</h3><p>The Bevy reflection system’s derive macros were generating unnecessary trait bounds in <code>where</code> clauses. Specifically:<ol><li>Non-generic field types received reflection trait bounds (<code>TypePath</code>, <code>FromReflect</code>, etc.) even though they didn’t require them<li>Non-generic types received <code>Any + Send + Sync</code> bounds that served no purpose</ol><p>This happened because the macro implementation took a simpler approach of applying bounds to all fields rather than selectively applying them only where needed. While functional, this caused:<ul><li>Code bloat in derived implementations<li>Longer compile times<li>Potential confusion about actual requirements</ul><p>The problem was particularly noticeable in large projects like <code>bevy_ui</code>, where macro expansion size increased significantly due to these redundant bounds.<h3 id=solution-approach>Solution Approach</h3><p>The solution involved modifying the <code>bevy_reflect</code> derive macro to conditionally apply bounds:<ol><li><p>For the <code>Self</code> type:</p> <ul><li>Add <code>Any + Send + Sync</code> only if the type is generic over types<li>Add <code>'static</code> bound only if generic over lifetimes but not types<li>Add no bounds for non-generic types</ul><li><p>For field types:</p> <ul><li>Only apply reflection bounds if the field type contains any of the struct’s generic type parameters<li>Use token stream analysis to detect generic field types</ul></ol><p>Additionally, we removed redundant <code>Any + Send + Sync</code> bounds from atomic type implementations in <code>core/sync.rs</code> since these types are non-generic.<h3 id=implementation-details>Implementation Details</h3><p>The core changes occurred in the <code>where_clause_options.rs</code> file where we:<ol><li>Replaced the unconditional <code>required_bounds</code> with conditional logic<li>Added token stream analysis to detect generic field types<li>Refactored the <code>where</code> clause generation to: <ul><li>Preserve existing user-defined bounds<li>Conditionally add <code>Self</code> bounds<li>Conditionally add field bounds</ul></ol><p>For atomic types in <code>sync.rs</code>, we removed the redundant <code>where T: Any + Send + Sync</code> constraints since atomic types are concrete and non-generic.<h3 id=technical-insights>Technical Insights</h3><p>The key innovation was the <code>is_any_ident_in_token_stream</code> function that determines if a field type is generic by:<ol><li>Collecting all type parameter identifiers from the struct<li>Scanning the field type’s token stream for these identifiers<li>Only applying bounds if any identifiers are found</ol><p>This approach avoids complex type analysis while correctly identifying when a field type depends on generic parameters. The implementation makes pragmatic tradeoffs between precision and complexity.<h3 id=impact-and-benefits>Impact and Benefits</h3><ul><li><strong>21.2% reduction</strong> in generated <code>Reflect</code> code size for <code>bevy_ui</code><li>Cleaner, more focused trait bounds in derived implementations<li>Reduced compile times due to smaller macro expansions<li>Maintained backward compatibility with existing reflection attributes<li>Sets foundation for further reflection optimizations (#19873)</ul><p>The changes demonstrate how selective trait bound application can significantly reduce generated code size without sacrificing functionality.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Reflection Derive Macro] --> B{Is Type Generic?}
</span><span>    B -->|Yes| C[Add Any + Send + Sync]
</span><span>    B -->|Lifetimes Only| D[Add 'static bound]
</span><span>    B -->|No| E[No Self bounds]
</span><span>    A --> F{For Each Field}
</span><span>    F --> G{Field Type Generic?}
</span><span>    G -->|Yes| H[Add Reflection Bounds]
</span><span>    G -->|No| I[No Field Bounds]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=1-crates-bevy-reflect-derive-src-where-clause-options-rs-107-53>1. <code>crates/bevy_reflect/derive/src/where_clause_options.rs</code> (+107/-53)</h3><p><strong>Purpose:</strong> Implements conditional trait bound generation for reflection derives.<p><strong>Key Changes:</strong><ul><li>Added type genericity detection for <code>Self</code> bounds<li>Implemented token-based generic field detection<li>Removed unconditional <code>required_bounds</code></ul><p><strong>Code Snippet (Conditional Self Bounds):</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let</span><span> generics </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>meta</span><span style=color:#ed9366>.</span><span style=color:#f07171>type_path</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>generics</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>if</span><span> generics</span><span style=color:#ed9366>.</span><span style=color:#f07171>type_params</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>next</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_some</span><span>() {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Generic over types? We need `Any + Send + Sync`.
</span><span>    </span><span style=color:#fa6e32>let</span><span> this </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>meta</span><span style=color:#ed9366>.</span><span style=color:#f07171>type_path</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>true_type</span><span>()</span><span style=color:#61676ccc>;
</span><span>    generic_where_clause</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend</span><span>(</span><span style=color:#f07171>quote! </span><span>{ </span><span style=color:#ed9366>#</span><span>this</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>#</span><span>FQAny </span><span style=color:#ed9366>+ #</span><span>FQSend </span><span style=color:#ed9366>+ #</span><span>FQSync</span><span style=color:#61676ccc>, </span><span>})</span><span style=color:#61676ccc>;
</span><span>} </span><span style=color:#fa6e32>else if</span><span> generics</span><span style=color:#ed9366>.</span><span style=color:#f07171>lifetimes</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>next</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_some</span><span>() {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Generic only over lifetimes? We need `'static`.
</span><span>    </span><span style=color:#fa6e32>let</span><span> this </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>meta</span><span style=color:#ed9366>.</span><span style=color:#f07171>type_path</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>true_type</span><span>()</span><span style=color:#61676ccc>;
</span><span>    generic_where_clause</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend</span><span>(</span><span style=color:#f07171>quote! </span><span>{ </span><span style=color:#ed9366>#</span><span>this</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>'static</span><span style=color:#61676ccc>, </span><span>})</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p><strong>Code Snippet (Generic Field Detection):</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>fn </span><span style=color:#f29718>is_any_ident_in_token_stream</span><span>(</span><span style=color:#ff8f40>idents</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>[Ident], </span><span style=color:#ff8f40>token_stream</span><span style=color:#61676ccc>:</span><span> TokenStream) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>bool </span><span>{
</span><span>    </span><span style=color:#fa6e32>for</span><span> token_tree </span><span style=color:#ed9366>in</span><span> token_stream {
</span><span>        </span><span style=color:#fa6e32>match</span><span> token_tree {
</span><span>            TokenTree</span><span style=color:#ed9366>::</span><span>Ident(ident) </span><span style=color:#ed9366>=> </span><span>{
</span><span>                </span><span style=color:#fa6e32>if</span><span> idents</span><span style=color:#ed9366>.</span><span style=color:#f07171>contains</span><span>(</span><span style=color:#ed9366>&</span><span>ident) {
</span><span>                    </span><span style=color:#fa6e32>return </span><span style=color:#ff8f40>true</span><span style=color:#61676ccc>;
</span><span>                }
</span><span>            }
</span><span>            TokenTree</span><span style=color:#ed9366>::</span><span>Group(group) </span><span style=color:#ed9366>=> </span><span>{
</span><span>                </span><span style=color:#fa6e32>if </span><span style=color:#f07171>is_any_ident_in_token_stream</span><span>(idents</span><span style=color:#61676ccc>,</span><span> group</span><span style=color:#ed9366>.</span><span style=color:#f07171>stream</span><span>()) {
</span><span>                    </span><span style=color:#fa6e32>return </span><span style=color:#ff8f40>true</span><span style=color:#61676ccc>;
</span><span>                }
</span><span>            }
</span><span>            TokenTree</span><span style=color:#ed9366>::</span><span>Punct(</span><span style=color:#ed9366>_</span><span>) </span><span style=color:#ed9366>| </span><span>TokenTree</span><span style=color:#ed9366>::</span><span>Literal(</span><span style=color:#ed9366>_</span><span>) </span><span style=color:#ed9366>=> </span><span>{}
</span><span>        }
</span><span>    }
</span><span>    </span><span style=color:#ff8f40>false
</span><span>}
</span></code></pre><h3 id=2-crates-bevy-reflect-src-impls-core-sync-rs-5-18>2. <code>crates/bevy_reflect/src/impls/core/sync.rs</code> (+5/-18)</h3><p><strong>Purpose:</strong> Remove redundant bounds from atomic type implementations.<p><strong>Key Changes:</strong><ul><li>Eliminated <code>where T: Any + Send + Sync</code> constraints<li>Simplified trait implementations for atomic types</ul><p><strong>Code Snippet (Before):</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>impl </span><span>GetTypeRegistration </span><span style=color:#fa6e32>for </span><span>$ty
</span><span style=color:#fa6e32>where
</span><span>    $ty</span><span style=color:#61676ccc>:</span><span> Any + Send + Sync,
</span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Implementation
</span><span>}
</span></code></pre><p><strong>Code Snippet (After):</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>impl </span><span>GetTypeRegistration </span><span style=color:#fa6e32>for </span><span>$ty {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Implementation without unnecessary bounds
</span><span>}
</span></code></pre><h3 id=3-crates-bevy-reflect-derive-src-lib-rs-5-5>3. <code>crates/bevy_reflect/derive/src/lib.rs</code> (+5/-5)</h3><p><strong>Purpose:</strong> Updated documentation to reflect new where clause behavior.<p><strong>Code Snippet (Documentation Update):</strong><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span style=color:#f07171>- /// //   Self: Any + Send + Sync,
</span><span style=color:#f07171>- /// //   Vec&LTFoo>: FromReflect + TypePath,
</span><span style=color:#86b300>+ /// //   Foo&LTT, U>: Any + Send + Sync,
</span><span style=color:#86b300>+ /// //   Vec&LTFoo>: FromReflect + ...,
</span></code></pre><h3 id=4-crates-bevy-reflect-src-lib-rs-5-0>4. <code>crates/bevy_reflect/src/lib.rs</code> (+5/-0)</h3><p><strong>Purpose:</strong> Added dead code allowances for test structs.<p><strong>Code Snippet:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>expect</span><span>(dead_code</span><span style=color:#61676ccc>,</span><span> reason </span><span style=color:#ed9366>= </span><span style=color:#86b300>"Bar is never constructed"</span><span>)]
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/reference/procedural-macros.html target=_blank>Rust Procedural Macros Guide</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/proc-macro2/latest/proc_macro2/struct.TokenStream.html target=_blank>TokenStream Processing</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_reflect/latest/bevy_reflect/ target=_blank>Bevy Reflection Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/rust-lang/api-guidelines/discussions/29 target=_blank>Trait Bound Optimization Patterns</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-07/pr_19929.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>