<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19902 bevy_reflect: remove unnecessary `const _` around `TypePath` impl
        
    </title><meta content="#19902 bevy_reflect: remove unnecessary `const _` around `TypePath` impl" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-07/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-07-13</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-07/pr-19902-zh-cn-20250713>中文</a></div></div><div class=pr-content><h2 id=title>Title</h2><p>bevy_reflect: remove unnecessary <code>const _</code> around <code>TypePath</code> impl<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: bevy_reflect: remove unnecessary <code>const _</code> around <code>TypePath</code> impl<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19902<li><strong>Author</strong>: nnethercote<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Performance, S-Ready-For-Final-Review, A-Reflection, D-Straightforward, D-Macros<li><strong>Created</strong>: 2025-07-01T06:59:25Z<li><strong>Merged</strong>: 2025-07-13T22:59:05Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Derived <code>TypePath</code> impls have a <code>const _</code> block in order to hold a <code>use alloc::string::ToString</code> import. But that import is useless.<p>Avoiding it helps with https://github.com/bevyengine/bevy/issues/19873.<h2 id=solution>Solution</h2><p>Remove the <code>use</code> and <code>const _</code>.<h2 id=testing>Testing</h2><p>I used cargo expand to confirm the <code>const _ </code> is no longer produced.<p><code>-Zmacro-stats</code> output tells me this reduces the size of the <code>Reflect</code> code produced for <code>bevy_ui</code> from 1_880_486 bytes to 1_859_634 bytes, a 1.1% drop.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This pull request addresses a minor but impactful inefficiency in Bevy’s reflection system. The core issue was in the code generation for derived <code>TypePath</code> implementations, which contained an unused import statement wrapped in a <code>const _</code> block. This construction served no functional purpose but added unnecessary bloat to the generated code.<p>The problem originated from how the <code>bevy_reflect</code> derive macro generated implementations for the <code>TypePath</code> trait. The macro produced code that looked like this:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>const </span><span style=color:#ed9366>_</span><span style=color:#61676ccc>: </span><span>() </span><span style=color:#ed9366>= </span><span>{
</span><span>    </span><span style=color:#fa6e32>extern crate</span><span> alloc</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>use </span><span>alloc</span><span style=color:#ed9366>::</span><span>string</span><span style=color:#ed9366>::</span><span>ToString</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#fa6e32>impl </span><span>... {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// TypePath methods
</span><span>    }
</span><span>}</span><span style=color:#61676ccc>;
</span></code></pre><p>The <code>const _</code> block was originally intended to scope the <code>alloc</code> import and prevent namespace pollution. However, the <code>ToString</code> import inside it was never actually used in the implementation. This meant every derived <code>TypePath</code> implementation included dead code - the unused import and its containing block.<p>The solution was straightforward: remove both the unused <code>use alloc::string::ToString</code> statement and the surrounding <code>const _</code> block. This simplification changed the generated code to a direct implementation:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>impl </span><span>... {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// TypePath methods
</span><span>}
</span></code></pre><p>This change has concrete benefits for code size and compilation efficiency. When using <code>cargo expand</code> to inspect macro output, the author confirmed the <code>const _</code> block was eliminated. More importantly, measurements with <code>-Zmacro-stats</code> showed the generated reflection code for <code>bevy_ui</code> decreased from 1,880,486 bytes to 1,859,634 bytes - a 1.1% reduction. While this seems modest, it accumulates across all reflection-heavy projects using Bevy, helping address binary bloat concerns like those tracked in issue #19873.<p>The change required no complex engineering decisions since the removed code was demonstrably dead. The implementation maintains identical functionality while producing cleaner, more efficient output. This demonstrates how small optimizations in foundational systems like reflection can yield measurable improvements throughout the engine.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[TypePath Derive Macro] --> B[Generates Code]
</span><span>    B --> C[Original: const block + unused import]
</span><span>    B --> D[Optimized: Direct impl block]
</span><span>    D --> E[Smaller Code Size]
</span><span>    D --> F[Faster Compilation]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-reflect-derive-src-impls-typed-rs>crates/bevy_reflect/derive/src/impls/typed.rs</h3><p><strong>Changes</strong>: Removed unnecessary <code>const _</code> block and unused import from <code>TypePath</code> derive implementation<br> <strong>Why</strong>: The code was dead and contributed to binary bloat<br> <strong>Impact</strong>: Reduces generated code size by ~1.1% for reflection-heavy crates<p><strong>Code Comparison</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#f07171>quote! </span><span>{
</span><span>    </span><span style=color:#ed9366>#</span><span>primitive_assert
</span><span>
</span><span>    </span><span style=color:#fa6e32>const </span><span style=color:#ed9366>_</span><span style=color:#61676ccc>: </span><span>() </span><span style=color:#ed9366>= </span><span>{
</span><span>        </span><span style=color:#fa6e32>extern crate</span><span> alloc</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#fa6e32>use </span><span>alloc</span><span style=color:#ed9366>::</span><span>string</span><span style=color:#ed9366>::</span><span>ToString</span><span style=color:#61676ccc>;
</span><span>
</span><span>        </span><span style=color:#fa6e32>impl </span><span>#</span><span style=color:#399ee6>impl_generics</span><span> #</span><span style=color:#399ee6>bevy_reflect_path</span><span>::</span><span style=color:#399ee6>TypePath</span><span> ... {
</span><span>            </span><span style=color:#abb0b6;font-style:italic>// methods
</span><span>        }
</span><span>    }</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#f07171>quote! </span><span>{
</span><span>    </span><span style=color:#ed9366>#</span><span>primitive_assert
</span><span>
</span><span>    </span><span style=color:#fa6e32>impl </span><span>#</span><span style=color:#399ee6>impl_generics</span><span> #</span><span style=color:#399ee6>bevy_reflect_path</span><span>::</span><span style=color:#399ee6>TypePath</span><span> ... {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// methods
</span><span>    }
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/reference/items/constant-items.html target=_blank>Rust <code>const _</code> blocks</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/migration-guides/0.12-to-0.13/#reflect-changes target=_blank>Bevy Reflection System</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/dtolnay/cargo-expand target=_blank>cargo expand utility</a><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/unstable-book/compiler-flags/macro-stats.html target=_blank>Macro Expansion Statistics</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-07/pr_19902.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>