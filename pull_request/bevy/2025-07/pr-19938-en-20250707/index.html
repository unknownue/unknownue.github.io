<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19938 Skip allocation of zero size meshes
        
    </title><meta content="#19938 Skip allocation of zero size meshes" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-07/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-07-07</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-07/pr-19938-zh-cn-20250707>中文</a></div></div><div class=pr-content><h2 id=skip-allocation-of-zero-size-meshes>Skip allocation of zero size meshes</h2><h3 id=basic-information>Basic Information</h3><ul><li><strong>Title</strong>: Skip allocation of zero size meshes<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19938<li><strong>Author</strong>: kerstop<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, S-Ready-For-Final-Review, O-WebGL2, D-Straightforward<li><strong>Created</strong>: 2025-07-03T19:07:46Z<li><strong>Merged</strong>: 2025-07-07T02:52:16Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h3 id=description-translation>Description Translation</h3><p><strong>Objective</strong><p>Fixes #16525<br> Fixes #19710<p><strong>Solution</strong><p>Not allocating a mesh if it is empty.<p><strong>Testing</strong><p>I tested using the following minimum repro from #16525<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>use </span><span>bevy</span><span style=color:#ed9366>::</span><span>{asset</span><span style=color:#ed9366>::</span><span>RenderAssetUsages</span><span style=color:#61676ccc>, </span><span>prelude</span><span style=color:#ed9366>::*</span><span style=color:#61676ccc>, </span><span>render</span><span style=color:#ed9366>::</span><span>mesh</span><span style=color:#ed9366>::</span><span>PrimitiveTopology}</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>main</span><span>() {
</span><span>    App</span><span style=color:#ed9366>::</span><span>new()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>add_plugins</span><span>(DefaultPlugins)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(Startup</span><span style=color:#61676ccc>,</span><span> setup)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>run</span><span>()</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>setup</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>meshes</span><span style=color:#61676ccc>: </span><span>ResMut&LTAssets&LTMesh>>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>materials</span><span style=color:#61676ccc>: </span><span>ResMut&LTAssets&LTColorMaterial>>,
</span><span>) {
</span><span>    commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>(Camera2d)</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#fa6e32>let</span><span> mesh </span><span style=color:#ed9366>= </span><span>Mesh</span><span style=color:#ed9366>::</span><span>new(
</span><span>        PrimitiveTopology</span><span style=color:#ed9366>::</span><span>TriangleList</span><span style=color:#61676ccc>,
</span><span>        RenderAssetUsages</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>,
</span><span>    )</span><span style=color:#61676ccc>;
</span><span>
</span><span>    commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((
</span><span>        Mesh2d(meshes</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(mesh))</span><span style=color:#61676ccc>,
</span><span>        MeshMaterial2d(materials</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(Color</span><span style=color:#ed9366>::</span><span>hsl(</span><span style=color:#ff8f40>180.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.95</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.7</span><span>)))</span><span style=color:#61676ccc>,
</span><span>    ))</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>I was able to test on webgl2 and windows native and the issue seems to be resolved. I am not familiar with how mesh rendering works and feel like just skipping meshes should cause issues but I did not notice any.<h3 id=the-story-of-this-pull-request>The Story of This Pull Request</h3><p>The problem originated when users attempted to create meshes with no vertex data. This scenario occurs when developers initialize meshes without vertices, either intentionally or through incomplete mesh generation. In WebGL2 environments, attempting to allocate GPU buffers for such zero-size meshes triggered validation errors because WebGL requires buffer sizes to be at least 1 byte. This violated WebGL’s specification and crashed applications (#16525). Additionally, allocating resources for empty meshes wasted CPU cycles and GPU resources without providing any renderable output (#19710).<p>The solution implements a straightforward guard clause during mesh allocation. Before committing any resources, we now check if the vertex buffer size equals zero. If true, we skip the allocation process entirely. This approach solves both problems: it prevents WebGL errors by avoiding invalid API calls, and eliminates unnecessary resource allocation for empty meshes. The change is minimal and localized to the mesh allocation routine.<p>Here’s how the implementation works: First, we compute the vertex buffer size from the mesh data. If the size equals zero, we immediately continue to the next mesh without further processing. Only meshes with non-zero vertex buffers proceed to allocation. This logic handles all cases where a mesh lacks vertices, whether due to empty geometry or incomplete initialization.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let</span><span> vertex_buffer_size </span><span style=color:#ed9366>=</span><span> mesh</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_vertex_buffer_size</span><span>() </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>u64</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>if</span><span> vertex_buffer_size </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0 </span><span>{
</span><span>    </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>The change required minimal modification because it leverages existing data flow. The <code>get_vertex_buffer_size()</code> method already provided the necessary information, so we simply added an early exit point. This maintains the existing allocation logic for valid meshes while cleanly handling the zero-size case.<p>Performance-wise, this optimization reduces GPU memory fragmentation and avoids unnecessary buffer operations. For applications generating many procedural meshes, this prevents wasted cycles on empty geometry. The solution also maintains backward compatibility since valid meshes process identically.<p>Testing confirmed the fix resolves the WebGL crash while maintaining correct rendering behavior on native platforms. The provided reproduction case - creating an empty mesh with <code>PrimitiveTopology::TriangleList</code> - no longer causes crashes. Since empty meshes contribute nothing to rendered output, skipping them doesn’t affect scene composition.<h3 id=visual-representation>Visual Representation</h3><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Mesh Allocation Process] --> B{Vertex Buffer Size == 0?}
</span><span>    B -->|Yes| C[Skip Allocation]
</span><span>    B -->|No| D[Allocate GPU Resources]
</span><span>    D --> E[Proceed with Rendering]
</span></code></pre><h3 id=key-files-changed>Key Files Changed</h3><p><strong>crates/bevy_render/src/mesh/allocator.rs</strong><br> Added guard clause to skip allocation for zero-size vertex buffers.<p>Before:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>for </span><span>(mesh_id</span><span style=color:#61676ccc>,</span><span> mesh) </span><span style=color:#ed9366>in &</span><span>extracted_meshes</span><span style=color:#ed9366>.</span><span>extracted {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Allocate vertex data. Note that we can only pack mesh vertex data
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// together if the platform supports it.
</span><span>    </span><span style=color:#fa6e32>let</span><span> vertex_element_layout </span><span style=color:#ed9366>= </span><span>ElementLayout</span><span style=color:#ed9366>::</span><span>vertex(mesh_vertex_buffer_layouts</span><span style=color:#61676ccc>,</span><span> mesh)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>if </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>general_vertex_slabs_supported {
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>allocate</span><span>(
</span><span>            mesh_id</span><span style=color:#61676ccc>,
</span><span>            mesh</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_vertex_buffer_size</span><span>() </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>u64</span><span style=color:#61676ccc>,
</span><span>            vertex_element_layout</span><span style=color:#61676ccc>,
</span><span>            </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> slabs_to_grow</span><span style=color:#61676ccc>,
</span><span>            mesh_allocator_settings</span><span style=color:#61676ccc>,
</span></code></pre><p>After:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>for </span><span>(mesh_id</span><span style=color:#61676ccc>,</span><span> mesh) </span><span style=color:#ed9366>in &</span><span>extracted_meshes</span><span style=color:#ed9366>.</span><span>extracted {
</span><span>    </span><span style=color:#fa6e32>let</span><span> vertex_buffer_size </span><span style=color:#ed9366>=</span><span> mesh</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_vertex_buffer_size</span><span>() </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>u64</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>if</span><span> vertex_buffer_size </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0 </span><span>{
</span><span>        </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Allocate vertex data. Note that we can only pack mesh vertex data
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// together if the platform supports it.
</span><span>    </span><span style=color:#fa6e32>let</span><span> vertex_element_layout </span><span style=color:#ed9366>= </span><span>ElementLayout</span><span style=color:#ed9366>::</span><span>vertex(mesh_vertex_buffer_layouts</span><span style=color:#61676ccc>,</span><span> mesh)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>if </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>general_vertex_slabs_supported {
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>allocate</span><span>(
</span><span>            mesh_id</span><span style=color:#61676ccc>,
</span><span>            vertex_buffer_size</span><span style=color:#61676ccc>,
</span><span>            vertex_element_layout</span><span style=color:#61676ccc>,
</span><span>            </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> slabs_to_grow</span><span style=color:#61676ccc>,
</span><span>            mesh_allocator_settings</span><span style=color:#61676ccc>,
</span></code></pre><h3 id=further-reading>Further Reading</h3><ol><li><a rel="noopener nofollow noreferrer" href=https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext/bufferData target=_blank>WebGL bufferData specification</a> - Documents size requirements causing the original crash<li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/render/mesh/struct.Mesh.html target=_blank>Bevy Mesh documentation</a> - Details mesh structure and vertex attributes<li><a rel="noopener nofollow noreferrer" href=https://webglfundamentals.org/webgl/lessons/webgl-best-practices.html target=_blank>WebGL best practices</a> - General optimization guidelines for WebGL contexts</ol><h3 id=full-code-diff>Full Code Diff</h3><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_render/src/mesh/allocator.rs b/crates/bevy_render/src/mesh/allocator.rs
</span><span>index c171cf3957d96..bbdb543116b6e 100644
</span><span style=color:#c594c5>--- a/crates/bevy_render/src/mesh/allocator.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_render/src/mesh/allocator.rs
</span><span style=color:#c594c5>@@ -452,13 +452,17 @@ </span><span style=color:#399ee6>impl MeshAllocator {
</span><span> 
</span><span>         // Allocate.
</span><span>         for (mesh_id, mesh) in &extracted_meshes.extracted {
</span><span style=color:#86b300>+            let vertex_buffer_size = mesh.get_vertex_buffer_size() as u64;
</span><span style=color:#86b300>+            if vertex_buffer_size == 0 {
</span><span style=color:#86b300>+                continue;
</span><span style=color:#86b300>+            }
</span><span>             // Allocate vertex data. Note that we can only pack mesh vertex data
</span><span>             // together if the platform supports it.
</span><span>             let vertex_element_layout = ElementLayout::vertex(mesh_vertex_buffer_layouts, mesh);
</span><span>             if self.general_vertex_slabs_supported {
</span><span>                 self.allocate(
</span><span>                     mesh_id,
</span><span style=color:#f07171>-                    mesh.get_vertex_buffer_size() as u64,
</span><span style=color:#86b300>+                    vertex_buffer_size,
</span><span>                     vertex_element_layout,
</span><span>                     &mut slabs_to_grow,
</span><span>                     mesh_allocator_settings,
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-07/pr_19938.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>