<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #17976 Material, mesh, skin extraction optimization
        
    </title><meta content="#17976 Material, mesh, skin extraction optimization" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-07/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-07-09</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-07/pr-17976-zh-cn-20250709>中文</a></div></div><div class=pr-content><h2 id=material-mesh-skin-extraction-optimization>Material, Mesh, Skin Extraction Optimization</h2><h3 id=basic-information>Basic Information</h3><ul><li><strong>Title</strong>: Material, mesh, skin extraction optimization<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/17976<li><strong>Author</strong>: brianreavis<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, C-Performance, S-Needs-Review<li><strong>Created</strong>: 2025-02-21T19:31:34Z<li><strong>Merged</strong>: 2025-07-09T06:43:40Z<li><strong>Merged By</strong>: superdump</ul><h3 id=description-translation>Description Translation</h3><h4 id=objective>Objective</h4><p>The extraction systems for materials, meshes, and skins previously iterated over <code>RemovedComponents&LTViewVisibility></code> in addition to more specific variants like <code>RemovedComponents&LTMeshMaterial3d&LTM>></code>. This caused each system to loop through and check many irrelevant despawned entities—sometimes multiple times. With many material types, this overhead added up and became noticeable in frames with many despawns.</p><img alt="Screenshot 2025-02-21 at 10 28 01 AM" src=https://github.com/user-attachments/assets/63fec1c9-232c-45f6-9150-daf8751ecf85 width=1091><h4 id=solution>Solution</h4><p>This PR removes superfluous <code>RemovedComponents</code> iteration for <code>ViewVisibility</code> and <code>GlobalTransform</code>, ensuring that we only iterate over the most specific <code>RemovedComponents</code> relevant to the system (e.g., material components, mesh components). This is guaranteed to match what the system originally collected.<h4 id=before-red-after-yellow>Before (red) / After (yellow):</h4><img alt="Screenshot 2025-02-21 at 10 46 17 AM" src=https://github.com/user-attachments/assets/0e06b06d-7e91-4da5-a919-b843eb442a72 width=838> Log plot to highlight the long tail that this PR is addressing. <hr><h3 id=the-story-of-this-pull-request>The Story of This Pull Request</h3><p>The extraction systems for materials, meshes, and skins were causing performance issues due to inefficient handling of despawned entities. Each system was processing multiple removal queries for different component types, including both specific render components and more general components like <code>ViewVisibility</code> and <code>GlobalTransform</code>. This resulted in redundant iterations over irrelevant entities, particularly noticeable in scenes with high entity turnover.<p>The core problem stemmed from how removal detection was implemented. Extraction systems were using chains of removal queries like:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>for</span><span> entity </span><span style=color:#ed9366>in</span><span> removed_visibilities_query
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>chain</span><span>(removed_global_transforms_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>())
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>chain</span><span>(removed_meshes_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>())
</span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Processing logic
</span><span>}
</span></code></pre><p>This approach caused three performance issues:<ol><li>Multiple queries were processed even when only one was relevant<li>The same entity might appear in multiple removal queries<li>Systems processed despawned entities that weren’t relevant to their specific responsibilities</ol><p>The solution refactors these systems to only process the most specific removal query relevant to their functionality. For example, the mesh extraction system now only checks for removed <code>Mesh3d</code> components instead of also checking <code>ViewVisibility</code> and <code>GlobalTransform</code> removals. This works because:<ul><li>Removal of a specific render component (like <code>Mesh3d</code>) already implies the entity is no longer relevant<li>More general component removals don’t necessarily indicate the entity should be removed from render systems<li>This avoids duplicate processing of the same entity across multiple removal queries</ul><p>The changes affect four key extraction systems across the rendering pipeline:<ol><li>Material instance cleanup now uses <code>RemovedComponents&LTMesh3d></code> instead of <code>RemovedComponents&LTViewVisibility></code><li>Mesh extraction only checks <code>RemovedComponents&LTMesh3d></code><li>Skin extraction only checks <code>RemovedComponents&LTSkinnedMesh></code><li>2D material extraction only checks <code>RemovedComponents&LTMeshMaterial2d></code></ol><p>The implementation maintains correctness through two key mechanisms:<ol><li>Systems still process all relevant entities through their primary queries<li>Removal cleanup only happens when a component is actually removed, not when related components change<li>The change preserves existing logic for handling re-added components in the same frame</ol><p>Performance measurements show significant improvement, particularly in scenes with many despawning entities. The before/after comparison demonstrates reduced frame times and elimination of the long tail in extraction system execution times.<h3 id=visual-representation>Visual Representation</h3><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Material Extraction] --> B[RemovedComponents&LTMesh3d>]
</span><span>    C[Mesh Extraction] --> D[RemovedComponents&LTMesh3d>]
</span><span>    E[Skin Extraction] --> F[RemovedComponents&LTSkinnedMesh>]
</span><span>    G[Mesh2D Material] --> H[RemovedComponents&LTMeshMaterial2d>]
</span></code></pre><h3 id=key-files-changed>Key Files Changed</h3><h4 id=1-crates-bevy-pbr-src-render-mesh-rs>1. <code>crates/bevy_pbr/src/render/mesh.rs</code></h4><ul><li><strong>Purpose</strong>: Optimizes mesh extraction by removing unnecessary removal queries<li><strong>Changes</strong>: <ul><li>Removed <code>RemovedComponents&LTViewVisibility></code> and <code>RemovedComponents&LTGlobalTransform></code> queries<li>Simplified removal processing to only use <code>RemovedComponents&LTMesh3d></code></ul><li><strong>Code Comparison</strong>:</ul><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>pub fn extract_meshes_for_gpu_building(
</span><span>    // ...
</span><span style=color:#f07171>-    mut removed_visibilities_query: Extract&LTRemovedComponents&LTViewVisibility>>,
</span><span style=color:#f07171>-    mut removed_global_transforms_query: Extract&LTRemovedComponents&LTGlobalTransform>>,
</span><span>     mut removed_meshes_query: Extract&LTRemovedComponents&LTMesh3d>>,
</span><span>     // ...
</span><span> ) {
</span><span>     // ...
</span><span style=color:#f07171>-    for entity in removed_visibilities_query
</span><span style=color:#f07171>-        .read()
</span><span style=color:#f07171>-        .chain(removed_global_transforms_query.read())
</span><span style=color:#f07171>-        .chain(removed_meshes_query.read())
</span><span style=color:#f07171>-    {
</span><span style=color:#86b300>+    for entity in removed_meshes_query.read() {
</span><span>         // Removal processing logic
</span><span>     }
</span><span> }
</span></code></pre><h4 id=2-crates-bevy-pbr-src-render-skin-rs>2. <code>crates/bevy_pbr/src/render/skin.rs</code></h4><ul><li><strong>Purpose</strong>: Optimizes skin extraction by removing unnecessary removal queries<li><strong>Changes</strong>: <ul><li>Removed <code>RemovedComponents&LTViewVisibility></code> query<li>Simplified removal processing to only use <code>RemovedComponents&LTSkinnedMesh></code></ul><li><strong>Code Comparison</strong>:</ul><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>pub fn extract_skins(
</span><span>     // ...
</span><span style=color:#f07171>-    mut removed_visibilities_query: Extract&LTRemovedComponents&LTViewVisibility>>,
</span><span>     mut removed_skinned_meshes_query: Extract&LTRemovedComponents&LTSkinnedMesh>>,
</span><span> ) {
</span><span>     // ...
</span><span style=color:#f07171>-    for skinned_mesh_entity in removed_visibilities_query
</span><span style=color:#f07171>-        .read()
</span><span style=color:#f07171>-        .chain(removed_skinned_meshes_query.read())
</span><span style=color:#f07171>-    {
</span><span style=color:#86b300>+    for skinned_mesh_entity in removed_skinned_meshes_query.read() {
</span><span>         // Removal processing logic
</span><span>     }
</span><span> }
</span></code></pre><h4 id=3-crates-bevy-sprite-src-mesh2d-material-rs>3. <code>crates/bevy_sprite/src/mesh2d/material.rs</code></h4><ul><li><strong>Purpose</strong>: Optimizes 2D material extraction by removing unnecessary removal queries<li><strong>Changes</strong>: <ul><li>Removed <code>RemovedComponents&LTViewVisibility></code> query<li>Simplified removal processing to only use <code>RemovedComponents&LTMeshMaterial2d&LTM>></code></ul><li><strong>Code Comparison</strong>:</ul><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>pub fn extract_mesh_materials_2d&LTM: Material2d>(
</span><span>     // ...
</span><span style=color:#f07171>-    mut removed_visibilities_query: Extract&LTRemovedComponents&LTViewVisibility>>,
</span><span>     mut removed_materials_query: Extract&LTRemovedComponents&LTMeshMaterial2d&LTM>>>,
</span><span> ) {
</span><span>     // ...
</span><span style=color:#f07171>-    for entity in removed_visibilities_query
</span><span style=color:#f07171>-        .read()
</span><span style=color:#f07171>-        .chain(removed_materials_query.read())
</span><span style=color:#f07171>-    {
</span><span style=color:#86b300>+    for entity in removed_materials_query.read() {
</span><span>         // Removal processing logic
</span><span>     }
</span><span> }
</span></code></pre><h4 id=4-crates-bevy-pbr-src-material-rs>4. <code>crates/bevy_pbr/src/material.rs</code></h4><ul><li><strong>Purpose</strong>: Optimizes material instance cleanup<li><strong>Changes</strong>: <ul><li>Switched from <code>RemovedComponents&LTViewVisibility></code> to <code>RemovedComponents&LTMesh3d></code><li>More accurate tracking of when material instances should be cleaned up</ul><li><strong>Code Comparison</strong>:</ul><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>fn late_sweep_material_instances(
</span><span>     mut material_instances: ResMut&LTRenderMaterialInstances>,
</span><span style=color:#f07171>-    mut removed_visibilities_query: Extract&LTRemovedComponents&LTViewVisibility>>,
</span><span style=color:#86b300>+    mut removed_meshes_query: Extract&LTRemovedComponents&LTMesh3d>>,
</span><span> ) {
</span><span>     // ...
</span><span style=color:#f07171>-    for entity in removed_visibilities_query.read() {
</span><span style=color:#86b300>+    for entity in removed_meshes_query.read() {
</span><span>         if let Entry::Occupied(occupied_entry) = material_instances.instances.entry(entity.into()) {
</span><span>             // Cleanup logic
</span><span>         }
</span><span>     }
</span><span> }
</span></code></pre><h3 id=further-reading>Further Reading</h3><ol><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_ecs/latest/bevy_ecs/removal/struct.RemovedComponents.html target=_blank>Bevy ECS: Removal Detection Documentation</a> - Official docs for removal detection<li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/programming/system-param.html target=_blank>System Query Parameters in Bevy</a> - Guide to different query types<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/crates/bevy_render/src/renderer/mod.rs target=_blank>Bevy Render Pipeline Architecture</a> - Source code for render pipeline</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-07/pr_17976.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>