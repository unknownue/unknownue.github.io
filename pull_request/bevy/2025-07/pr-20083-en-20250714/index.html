<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20083
        
    </title><meta content=#20083 property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-07/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-07-14</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-07/pr-20083-zh-cn-20250714>中文</a></div></div><div class=pr-content><h2 id=technical-analysis-of-pr-20083-fix-ambientlight-affects-lightmapped-meshes-not-working>Technical Analysis of PR #20083: Fix AmbientLight::affects_lightmapped_meshes not working</h2><h3 id=the-problem-and-context>The Problem and Context</h3><p>The core issue addressed in this PR stems from how Bevy handles ambient light calculations for lightmapped meshes. When using lightmapped materials (where lighting information is pre-baked into textures), the <code>AmbientLight::affects_lightmapped_meshes</code> setting wasn’t being respected in the forward renderer. This caused ambient light to always affect lightmapped meshes, potentially resulting in double-counting of ambient light contributions (since ambient light might already be baked into the lightmap). This behavior contradicted the setting’s intended purpose of allowing artists to control whether runtime ambient light should affect lightmapped objects.<h3 id=the-solution-approach>The Solution Approach</h3><p>The fix required modifying how ambient light calculations are conditionally applied in Bevy’s physically based rendering (PBR) shader. The solution involves:<ol><li>Adding conditional logic to skip ambient light contributions when rendering lightmapped meshes with <code>affects_lightmapped_meshes</code> disabled<li>Cleaning up unused shader variables to make space for the new control flag<li>Passing the ambient light setting to the shader via the <code>Lights</code> uniform struct</ol><p>The implementation specifically targets the forward renderer, as implementing this for deferred rendering would require more extensive changes to the g-buffer format.<h3 id=the-implementation>The Implementation</h3><p>The changes occur in two WGSL shader files. First, in <code>mesh_view_types.wgsl</code>, we clean up unused environment map variables and add the new control flag:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>struct Lights {
</span><span>    // ... existing fields ...
</span><span>    environment_map_smallest_specular_mip_level: u32,
</span><span>    environment_map_intensity: f32,
</span><span>};
</span><span>
</span><span>// After:
</span><span>struct Lights {
</span><span>    // ... existing fields ...
</span><span>    ambient_light_affects_lightmapped_meshes: u32
</span><span>};
</span></code></pre><p>This modification removes two unused variables (<code>environment_map_smallest_specular_mip_level</code> and <code>environment_map_intensity</code>) that weren’t referenced in either WGSL or Rust code, freeing up space for the new <code>ambient_light_affects_lightmapped_meshes</code> flag.<p>The core logic change happens in <code>pbr_functions.wgsl</code> where we conditionally apply ambient light:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>indirect_light += ambient::ambient_light(...);
</span><span>
</span><span>// After:
</span><span>#ifdef LIGHTMAP
</span><span>let enable_ambient = view_bindings::lights.ambient_light_affects_lightmapped_meshes != 0u;
</span><span>#else
</span><span>let enable_ambient = true;
</span><span>#endif
</span><span>
</span><span>if (enable_ambient) {
</span><span>    indirect_light += ambient::ambient_light(...);
</span><span>}
</span></code></pre><p>This change:<ol><li>Checks if the current material has a lightmap (via <code>LIGHTMAP</code> define)<li>Reads the ambient light setting from the uniform buffer<li>Only applies ambient light contributions when either: <ul><li>The mesh isn’t lightmapped, OR<li>The mesh is lightmapped AND <code>affects_lightmapped_meshes</code> is enabled</ul></ol><h3 id=technical-insights>Technical Insights</h3><p>The implementation demonstrates several sound engineering practices:<ol><li><strong>Conditional Compilation</strong>: Uses <code>#ifdef</code> to avoid runtime branching costs when lightmaps aren’t used<li><strong>Data Packing</strong>: Replaces unused uniform variables with needed functionality without increasing struct size<li><strong>Backward Compatibility</strong>: Maintains existing behavior for non-lightmapped meshes<li><strong>Explicit Control</strong>: Uses unsigned integer flags (0/1) for unambiguous state transmission</ol><p>The PR leaves an important technical question unresolved: whether ambient light should be conditionally applied when <code>DIFFUSE_TRANSMISSION</code> is enabled. This requires further investigation into how transmitted light interacts with ambient contributions.<h3 id=the-impact>The Impact</h3><p>These changes achieve the intended behavior:<ol><li>Lightmapped meshes now properly respect <code>affects_lightmapped_meshes</code><li>Non-lightmapped meshes continue receiving ambient light normally<li>The fix is contained to shader code with minimal CPU-side changes<li>Unused variables are cleaned up, reducing potential confusion</ol><p>As demonstrated in the PR’s comparison images, meshes without lightmaps now correctly receive ambient light while lightmapped meshes can exclude it when desired. This gives artists precise control over ambient lighting contributions.<pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[AmbientLight] --> B{affects_lightmapped_meshes?}
</span><span>    B -->|Yes| C[Apply ambient to all meshes]
</span><span>    B -->|No| D[Apply ambient only to&LTbr>non-lightmapped meshes]
</span><span>    D --> E[Lightmapped Mesh]
</span><span>    D --> F[Non-Lightmapped Mesh]
</span></code></pre><h3 id=key-files-changed>Key Files Changed</h3><p><strong>crates/bevy_pbr/src/render/mesh_view_types.wgsl</strong><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>struct Lights {
</span><span>    cluster_factors: vec4&LTf32>,
</span><span>    n_directional_lights: u32,
</span><span>    spot_light_shadowmap_offset: i32,
</span><span>    environment_map_smallest_specular_mip_level: u32,
</span><span>    environment_map_intensity: f32,
</span><span>};
</span><span>
</span><span>// After:
</span><span>struct Lights {
</span><span>    cluster_factors: vec4&LTf32>,
</span><span>    n_directional_lights: u32,
</span><span>    spot_light_shadowmap_offset: i32,
</span><span>    ambient_light_affects_lightmapped_meshes: u32
</span><span>};
</span></code></pre><p>This change replaces unused environment map properties with the new ambient light control flag, maintaining struct size while adding needed functionality.<p><strong>crates/bevy_pbr/src/render/pbr_functions.wgsl</strong><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>indirect_light += ambient::ambient_light(...);
</span><span>
</span><span>// After:
</span><span>#ifdef LIGHTMAP
</span><span>    let enable_ambient = view_bindings::lights.ambient_light_affects_lightmapped_meshes != 0u;
</span><span>#else
</span><span>    let enable_ambient = true;
</span><span>#endif
</span><span>if (enable_ambient) {
</span><span>    indirect_light += ambient::ambient_light(...);
</span><span>}
</span></code></pre><p>This implements the core conditional logic, skipping ambient light calculations for lightmapped meshes when requested.<h3 id=further-reading>Further Reading</h3><ol><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/getting-started/features/#pbr target=_blank>Bevy PBR Shading Model</a><li><a rel="noopener nofollow noreferrer" href=https://developer.nvidia.com/gpugems/gpugems2/part-iii-high-quality-rendering/chapter-10-real-time-global-illumination-lightmaps target=_blank>Lightmapping Techniques</a><li><a rel="noopener nofollow noreferrer" href=https://gpuweb.github.io/gpuweb/wgsl/ target=_blank>WGSL Shader Language Specification</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-07/pr_20083.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>