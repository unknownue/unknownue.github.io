<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20113 Fixing Visibility Handling in Solari's ReSTIR DI Implementation
        
    </title><meta content="#20113 Fixing Visibility Handling in Solari's ReSTIR DI Implementation" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-07/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-07-13</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-07/pr-20113-zh-cn-20250713>中文</a></div></div><div class=pr-content><h2 id=title-fixing-visibility-handling-in-solari-s-restir-di-implementation>Title: Fixing Visibility Handling in Solari’s ReSTIR DI Implementation</h2><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix visibility (re)use in Solari DI<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20113<li><strong>Author</strong>: JMS55<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: D-Trivial, A-Rendering, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-07-13T18:04:04Z<li><strong>Merged</strong>: 2025-07-13T19:52:11Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p><strong>Objective</strong> Fixes the re(use) of visibility in Solari’s ReSTIR DI.<p>The paper I based things off of didn’t (seem) to use visibility in their resampling https://yusuketokuyoshi.com/papers/2024/Efficient_Visibility_Reuse_for_Real-time_ReSTIR_(Supplementary_Document).pdf, only shading, but factoring it into the resampling improves things a lot.<p><strong>Showcase</strong> Before: <img alt=image height=1500 src=https://github.com/user-attachments/assets/15fa7941-ab68-47bc-9bbc-42ca55359046 width=2564><p>After: <img alt=image height=1500 src=https://github.com/user-attachments/assets/6fe52ed0-7832-41c1-b1cd-e8c8d9825e51 width=2564><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=the-problem-and-context>The Problem and Context</h3><p>The PR addresses incorrect visibility handling in Solari’s ReSTIR DI (Direct Illumination) implementation. The original implementation applied visibility too early in the sampling pipeline - during initial reservoir generation. This conflicted with the reference paper’s approach which only applied visibility during shading, not resampling. The premature visibility application caused suboptimal sample weighting during spatio-temporal reuse, resulting in noisy renders with visible artifacts.<h3 id=the-solution-approach>The Solution Approach</h3><p>The solution relocates visibility application from the reservoir generation phase to the target function evaluation phase. This aligns with the observation that factoring visibility into resampling significantly improves results. The implementation:<ol><li>Removes visibility multiplication during initial reservoir generation<li>Applies visibility when calculating the target function<li>Fixes neighbor pixel ID calculation to use floating-point precision</ol><h3 id=the-implementation>The Implementation</h3><p>The changes are minimal but impactful. In <code>restir_di.wgsl</code>, visibility multiplication was removed from reservoir generation and added to the target function:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before reservoir generation:
</span><span>reservoir.unbiased_contribution_weight *= reservoir.visibility;
</span><span>
</span><span>// After removal:
</span></code></pre><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before target function:
</span><span>let light_contribution = calculate_light_contribution(...).radiance;
</span><span>
</span><span>// After target function:
</span><span>let light_contribution = calculate_light_contribution(...).radiance * reservoir.visibility;
</span></code></pre><p>This change ensures visibility is considered during reservoir merging and resampling operations. Additionally, neighbor pixel selection was updated to use floating-point math for better precision:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>var spatial_id = vec2&LTi32>(center_pixel_id) + vec2&LTi32>(sample_disk(...));
</span><span>spatial_id = clamp(spatial_id, vec2(0i), vec2&LTi32>(view.viewport.zw) - 1i);
</span><span>
</span><span>// After:
</span><span>var spatial_id = vec2&LTf32>(center_pixel_id) + sample_disk(...);
</span><span>spatial_id = clamp(spatial_id, vec2(0.0), view.viewport.zw - 1.0);
</span></code></pre><h3 id=technical-insights>Technical Insights</h3><p>The key insight is that visibility should be part of the target function evaluation rather than applied prematurely to reservoir weights. This allows the resampling algorithm to properly weight samples based on both their radiance contribution and visibility. The floating-point fix in neighbor selection prevents integer truncation errors during spatial reuse.<h3 id=the-impact>The Impact</h3><p>The changes significantly improve rendering quality by:<ol><li>Reducing noise in shadowed areas<li>Improving sample weighting during spatio-temporal reuse<li>Fixing precision issues in neighbor selection The before/after images demonstrate substantially cleaner results with better shadow definition and reduced artifacts. The solution maintains real-time performance while improving visual quality.</ol><h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[Initial Reservoir Generation] -->|Stores sample data| B[Temporal Reuse]
</span><span>    B --> C[Spatial Reuse]
</span><span>    C --> D[Target Function Evaluation]
</span><span>    D -->|Uses visibility| E[Final Shading]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ol><li><strong>crates/bevy_solari/src/realtime/restir_di.wgsl</strong> <ul><li>Fixed visibility handling in ReSTIR DI implementation<li>Updated neighbor pixel selection to use floating-point math</ul></ol><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before reservoir generation:
</span><span>reservoir.unbiased_contribution_weight *= reservoir.visibility;
</span><span>
</span><span>// After reservoir generation:
</span><span>// (visibility multiplication removed)
</span><span>
</span><span>// Before target function:
</span><span>let light_contribution = calculate_light_contribution(...).radiance;
</span><span>
</span><span>// After target function:
</span><span>let light_contribution = calculate_light_contribution(...).radiance * reservoir.visibility;
</span><span>
</span><span>// Before neighbor selection:
</span><span>var spatial_id = vec2&LTi32>(center_pixel_id) + vec2&LTi32>(...);
</span><span>
</span><span>// After neighbor selection:
</span><span>var spatial_id = vec2&LTf32>(center_pixel_id) + ...;
</span></code></pre><ol start=2><li><strong>crates/bevy_solari/src/realtime/restir_gi.wgsl</strong> <ul><li>Fixed neighbor pixel selection in GI implementation</ul></ol><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before neighbor selection:
</span><span>var spatial_id = vec2&LTi32>(center_pixel_id) + vec2&LTi32>(...);
</span><span>
</span><span>// After neighbor selection:
</span><span>var spatial_id = vec2&LTf32>(center_pixel_id) + ...;
</span></code></pre><ol start=3><li><strong>release-content/release-notes/bevy_solari.md</strong> <ul><li>Added PR reference to release notes</ul></ol><pre class=language-markdown data-lang=markdown style=color:#61676c;background-color:#fafafa><code class=language-markdown data-lang=markdown><span>// Before:
</span><span>pull_requests: [19058, 19620, 19790, 20020]
</span><span>
</span><span>// After:
</span><span>pull_requests: [19058, 19620, 19790, 20020, 20113]
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://research.nvidia.com/sites/default/files/pubs/2020-07_Spatiotemporal-reservoir-resampling/ReSTIR.pdf target=_blank>ReSTIR Paper</a><li><a rel="noopener nofollow noreferrer" href=https://yusuketokuyoshi.com/papers/2024/Efficient_Visibility_Reuse_for_Real-time_ReSTIR_(Supplementary_Document).pdf target=_blank>Efficient Visibility Reuse Paper</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/next/render/ target=_blank>Bevy Rendering Architecture</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-07/pr_20113.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>