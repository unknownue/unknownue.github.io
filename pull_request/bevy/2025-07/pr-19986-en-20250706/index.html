<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19986 Rename light visibility class
        
    </title><meta content="#19986 Rename light visibility class" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-07/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-07-06</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-07/pr-19986-zh-cn-20250706>中文</a></div></div><div class=pr-content><h1 id=rename-light-visibility-class>Rename light visibility class</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Rename light visibility class<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19986<li><strong>Author</strong>: atlv24<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, C-Code-Quality, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-07-06T18:08:49Z<li><strong>Merged</strong>: 2025-07-06T19:23:40Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>prepare bevy_light for split<li>make struct named better<li>put it where it belongs</ul><h2 id=solution>Solution</h2><ul><li>do those things</ul><h2 id=testing>Testing</h2><ul><li>3d_scene, lighting</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a naming inconsistency in Bevy’s rendering code related to visibility classification for clustered objects. The <code>LightVisibilityClass</code> struct was originally created to manage visibility for light sources within the clustering system. However, when clustered decals were added to the engine, they reused this same visibility class since they also needed to participate in the clustering process. This revealed that the name <code>LightVisibilityClass</code> was misleading because it wasn’t exclusively used for lights anymore.<p>The core problem was that a visibility class designed specifically for lights was being used for other clusterable objects like decals. This naming mismatch created confusion about the actual purpose of the class and made the code less maintainable. The class needed a more accurate name reflecting its actual function in the clustering system.<p>The solution involved renaming <code>LightVisibilityClass</code> to <code>ClusterVisibilityClass</code> and relocating it to the clustering module where it logically belongs. This change required updating all references to the old name across multiple files. The new name clearly indicates that this visibility class is for any object that participates in clustering, not just lights.<p>In the implementation, we first removed the original <code>LightVisibilityClass</code> definition from <code>light/mod.rs</code> and created a new <code>ClusterVisibilityClass</code> in <code>cluster/mod.rs</code>. This new location makes more sense since clustering logic is centralized in this module. We then updated all components that previously used <code>LightVisibilityClass</code> to reference <code>ClusterVisibilityClass</code> instead.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before in cluster/mod.rs
</span><span style=color:#fa6e32>use crate</span><span style=color:#ed9366>::</span><span>LightVisibilityClass</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After in cluster/mod.rs
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>ClusterVisibilityClass</span><span style=color:#61676ccc>;
</span></code></pre><p>The components affected included:<ul><li><code>ClusteredDecal</code><li><code>DirectionalLight</code><li><code>PointLight</code><li><code>SpotLight</code></ul><p>For each, we updated the <code>on_add</code> visibility class handler:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before for PointLight
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>component</span><span>(on_add </span><span style=color:#ed9366>=</span><span> visibility::add_visibility_class::&LTLightVisibilityClass>)]
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After for PointLight
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>component</span><span>(on_add </span><span style=color:#ed9366>=</span><span> visibility::add_visibility_class::&LTClusterVisibilityClass>)]
</span></code></pre><p>Additionally, we improved module organization by:<ol><li>Moving cluster-related imports (<code>ClusterableObjectCounts</code>, <code>Clusters</code>, <code>GlobalClusterSettings</code>) out of light modules<li>Adjusting visibility modifiers to properly expose the new <code>ClusterVisibilityClass</code><li>Adding documentation comments to clarify the purpose of the visibility class</ol><p>These changes don’t modify runtime behavior but significantly improve code clarity. The new name accurately reflects that this visibility class is for any clusterable object (lights and decals), not just lights. This makes the codebase more maintainable and reduces cognitive load when working with the clustering system.<p>Finally, we added a migration guide (<code>LightVisibilityClass_rename.md</code>) to document this change for users who might be referencing the old name in their projects. The guide explains that clustered decals revealed the misnamed visibility class and clarifies its new purpose.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Cluster System] --> B[ClusterVisibilityClass]
</span><span>    B --> C[Point Lights]
</span><span>    B --> D[Spot Lights]
</span><span>    B --> E[Directional Lights]
</span><span>    B --> F[Clustered Decals]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ol><li><p><strong>crates/bevy_pbr/src/cluster/mod.rs</strong> (+6/-2)<br> Added new <code>ClusterVisibilityClass</code> and removed old import<br> Key changes:</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>use crate</span><span style=color:#ed9366>::</span><span>LightVisibilityClass</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>ClusterVisibilityClass</span><span style=color:#61676ccc>;
</span></code></pre><li><p><strong>crates/bevy_pbr/src/light/mod.rs</strong> (+9/-13)<br> Removed <code>LightVisibilityClass</code> and reorganized module structure<br> Key changes:</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>LightVisibilityClass</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#abb0b6;font-style:italic>// (struct removed entirely)
</span></code></pre><li><p><strong>crates/bevy_pbr/src/light/point_light.rs</strong> (+2/-2)<br> Updated visibility class reference<br> Key changes:</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>component</span><span>(on_add </span><span style=color:#ed9366>=</span><span> visibility::add_visibility_class::&LTLightVisibilityClass>)]
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>component</span><span>(on_add </span><span style=color:#ed9366>=</span><span> visibility::add_visibility_class::&LTClusterVisibilityClass>)]
</span></code></pre><li><p><strong>release-content/migration-guides/LightVisibilityClass_rename.md</strong> (+8/-0)<br> Added migration documentation<br> Key content:</p> <pre class=language-markdown data-lang=markdown style=color:#61676c;background-color:#fafafa><code class=language-markdown data-lang=markdown><span>When clustered decals were added, they used </span><span style=color:#ed9366;background-color:#61676c10>`LightVisibilityClass`</span><span> to share the clustering infrastructure.
</span><span>This revealed that this visibility class wasn't really about lights, but about clustering.
</span><span>It has been renamed to </span><span style=color:#ed9366;background-color:#61676c10>`ClusterVisibilityClass`</span><span> and moved to live alongside clustering-specific types.
</span></code></pre></ol><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/render/view/visibility/index.html target=_blank>Bevy Visibility System Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Entity_component_system target=_blank>Entity Component System Pattern</a><li><a rel="noopener nofollow noreferrer" href=https://www.gamedeveloper.com/rendering/clustered-shading target=_blank>Rendering Cluster Techniques</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-07/pr_19986.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>