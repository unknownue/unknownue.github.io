<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19935 Observer trigger refactor
        
    </title><meta content="#19935 Observer trigger refactor" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-07/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-07-05</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-07/pr-19935-zh-cn-20250705>中文</a></div></div><div class=pr-content><h1 id=observer-trigger-refactor-introducing-eventkey-for-clearer-event-identification>Observer Trigger Refactor: Introducing EventKey for Clearer Event Identification</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Observer trigger refactor<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19935<li><strong>Author</strong>: Zeophlite<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-ECS, C-Code-Quality, S-Ready-For-Final-Review, M-Needs-Release-Note<li><strong>Created</strong>: 2025-07-03T16:12:43Z<li><strong>Merged</strong>: 2025-07-04T16:47:14Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>The usage of ComponentId is quite confusing: events are not components. By newtyping this, we can prevent stupid mistakes, avoid leaking internal details and make the code clearer for users and engine devs reading it.<li>Adopts https://github.com/bevyengine/bevy/pull/19755</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=the-problem-and-context>The Problem and Context</h3><p>The core issue stemmed from Bevy’s internal use of <code>ComponentId</code> to identify events in its observer system. While technically functional, this approach created conceptual confusion since events are fundamentally different from components. Using the same identifier type for both domains made the code harder to understand and increased the risk of misuse. Developers might mistakenly treat events as components or pass component IDs where event identifiers were expected. This abstraction leakage also made the codebase less maintainable by exposing implementation details that should remain internal to the event system.<h3 id=the-solution-approach>The Solution Approach</h3><p>The solution introduces a new type <code>EventKey</code> that wraps a <code>ComponentId</code> while providing a semantically accurate abstraction for event identification. This type-safe wrapper clearly distinguishes events from components at the type level while maintaining the existing internal representation. The implementation follows these key steps:<ol><li>Create <code>EventKey</code> as a newtype wrapper around <code>ComponentId</code><li>Update the <code>Event</code> trait to use <code>EventKey</code> instead of <code>ComponentId</code><li>Refactor all observer-related systems to accept <code>EventKey</code><li>Preserve existing functionality while improving type safety</ol><p>This approach maintains compatibility with the existing event infrastructure while providing clearer semantics. No performance impact is expected since the newtype wrapper is zero-cost at runtime.<h3 id=the-implementation>The Implementation</h3><p>The implementation systematically replaces <code>ComponentId</code> with <code>EventKey</code> throughout Bevy’s event and observer systems. The <code>Event</code> trait methods <code>register_component_id</code> and <code>component_id</code> are renamed to <code>register_event_key</code> and <code>event_key</code> respectively, returning <code>EventKey</code> instead of <code>ComponentId</code>. Lifecycle event constants (ADD, INSERT, etc.) are updated to use <code>EventKey</code>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub const </span><span style=color:#ff8f40>ADD</span><span style=color:#61676ccc>:</span><span> ComponentId </span><span style=color:#ed9366>= </span><span>ComponentId</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ff8f40>0</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub const </span><span style=color:#ff8f40>ADD</span><span style=color:#61676ccc>:</span><span> EventKey </span><span style=color:#ed9366>=</span><span> EventKey(ComponentId</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ff8f40>0</span><span>))</span><span style=color:#61676ccc>;
</span></code></pre><p>The <code>ObserverDescriptor</code> struct now stores events as <code>Vec&LTEventKey></code> instead of <code>Vec&LTComponentId></code>, making its purpose clearer. The <code>Observers</code> struct’s cache now maps <code>EventKey</code> to observers rather than <code>ComponentId</code>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>cache</span><span style=color:#61676ccc>: </span><span>HashMap&LTComponentId, CachedObservers>
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>cache</span><span style=color:#61676ccc>: </span><span>HashMap&LTEventKey, CachedObservers>
</span></code></pre><p>All observer triggering functions now accept <code>EventKey</code> instead of <code>ComponentId</code>, including critical methods like <code>invoke</code> in the centralized storage and <code>trigger_observers</code> in the deferred world. The <code>ObserverTrigger</code> struct also replaces its <code>event_type</code> field with <code>event_key</code>.<h3 id=technical-insights>Technical Insights</h3><p>The <code>EventKey</code> implementation includes a helper method to access the underlying <code>ComponentId</code> when needed for internal operations:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>impl </span><span style=color:#399ee6>EventKey </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>component_id</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-></span><span> ComponentId {
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0
</span><span>    }
</span><span>}
</span></code></pre><p>This preserves the existing internal representation while providing a clean abstraction boundary. The PR leverages Rust’s type system to enforce proper usage patterns - developers can no longer accidentally pass a component ID where an event identifier is expected. The changes are comprehensive but focused, affecting approximately 12 files with consistent replacement patterns.<h3 id=the-impact>The Impact</h3><p>This refactor significantly improves code clarity and type safety in Bevy’s event system. By distinguishing event identifiers from component identifiers:<ol><li>The code becomes more self-documenting<li>Potential misuse errors are caught at compile time<li>Internal implementation details are better encapsulated<li>Future extensions to the event system have a clearer foundation</ol><p>The changes are backward-compatible with existing event usage patterns. While primarily an internal refactor, this improvement makes the codebase more approachable for both engine maintainers and users extending the event system.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    E[Event System] --> K[EventKey]
</span><span>    K --> O[Observer System]
</span><span>    O --> C[Centralized Storage]
</span><span>    O --> D[Distributed Storage]
</span><span>    C --> T[Trigger Execution]
</span><span>    D --> T
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ecs-src-event-base-rs><code>crates/bevy_ecs/src/event/base.rs</code></h3><p>Introduced <code>EventKey</code> and updated the <code>Event</code> trait methods. Key changes:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>register_component_id</span><span>(</span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> World) </span><span style=color:#61676ccc>-></span><span> ComponentId { </span><span style=color:#ed9366>... </span><span>}
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>component_id</span><span>(</span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>World) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTComponentId> { </span><span style=color:#ed9366>... </span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>register_event_key</span><span>(</span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> World) </span><span style=color:#61676ccc>-></span><span> EventKey { </span><span style=color:#ed9366>... </span><span>}
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>event_key</span><span>(</span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>World) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTEventKey> { </span><span style=color:#ed9366>... </span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// New type:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Debug</span><span style=color:#61676ccc>,</span><span> Copy</span><span style=color:#61676ccc>,</span><span> Clone</span><span style=color:#61676ccc>,</span><span> Hash</span><span style=color:#61676ccc>,</span><span> Ord</span><span style=color:#61676ccc>,</span><span> PartialOrd</span><span style=color:#61676ccc>,</span><span> Eq</span><span style=color:#61676ccc>,</span><span> PartialEq)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>EventKey</span><span>(pub(crate) ComponentId)</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-ecs-src-lifecycle-rs><code>crates/bevy_ecs/src/lifecycle.rs</code></h3><p>Updated lifecycle event constants to use <code>EventKey</code>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub const </span><span style=color:#ff8f40>ADD</span><span style=color:#61676ccc>:</span><span> ComponentId </span><span style=color:#ed9366>= </span><span>ComponentId</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ff8f40>0</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub const </span><span style=color:#ff8f40>ADD</span><span style=color:#61676ccc>:</span><span> EventKey </span><span style=color:#ed9366>=</span><span> EventKey(ComponentId</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ff8f40>0</span><span>))</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-ecs-src-observer-centralized-storage-rs><code>crates/bevy_ecs/src/observer/centralized_storage.rs</code></h3><p>Refactored observer storage to use <code>EventKey</code>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>cache</span><span style=color:#61676ccc>: </span><span>HashMap&LTComponentId, CachedObservers>
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>get_observers_mut</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>event_type</span><span style=color:#61676ccc>:</span><span> ComponentId) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> CachedObservers
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>cache</span><span style=color:#61676ccc>: </span><span>HashMap&LTEventKey, CachedObservers>
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>get_observers_mut</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>event_key</span><span style=color:#61676ccc>:</span><span> EventKey) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> CachedObservers
</span></code></pre><h3 id=crates-bevy-ecs-src-observer-mod-rs><code>crates/bevy_ecs/src/observer/mod.rs</code></h3><p>Updated trigger methods to use <code>EventKey</code>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>world</span><span style=color:#ed9366>.</span><span style=color:#f07171>trigger_observers</span><span>(event_id</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>...</span><span>)
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>world</span><span style=color:#ed9366>.</span><span style=color:#f07171>trigger_observers</span><span>(event_key</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>...</span><span>)
</span></code></pre><h3 id=crates-bevy-ecs-src-observer-system-param-rs><code>crates/bevy_ecs/src/observer/system_param.rs</code></h3><p>Updated the <code>ObserverTrigger</code> struct:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub</span><span> event_type</span><span style=color:#61676ccc>:</span><span> ComponentId</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub</span><span> event_key</span><span style=color:#61676ccc>:</span><span> EventKey</span><span style=color:#61676ccc>,
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/rust-by-example/generics/new_types.html target=_blank>Newtype Pattern in Rust</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_ecs/latest/bevy_ecs/event/index.html target=_blank>Bevy ECS Events Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/pull/19755 target=_blank>Related PR #19755: Observer System Refactor</a><li><a rel="noopener nofollow noreferrer" href=https://rust-lang.github.io/api-guidelines/type-safety.html#newtypes-provide-static-distinctions-c-newtype target=_blank>Rust API Guidelines on Newtypes</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-07/pr_19935.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>