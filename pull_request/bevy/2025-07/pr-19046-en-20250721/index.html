<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19046 Allow entities to be added to a relationship using the new spawn api (remade)
        
    </title><meta content="#19046 Allow entities to be added to a relationship using the new spawn api (remade)" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-07/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-07-21</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-07/pr-19046-zh-cn-20250721>中文</a></div></div><div class=pr-content><h3 id=allow-entities-to-be-added-to-a-relationship-using-the-new-spawn-api-remade>Allow entities to be added to a relationship using the new spawn api (remade)</h3><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Allow entities to be added to a relationship using the new spawn api (remade)<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19046<li><strong>Author</strong>: Freyja-moth<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-ECS, C-Usability, S-Ready-For-Final-Review, X-Contentious<li><strong>Created</strong>: 2025-05-03T16:57:21Z<li><strong>Merged</strong>: 2025-07-21T22:40:20Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Reopens #18961<h2 id=solution>Solution</h2><p>Copy the code<h2 id=testing>Testing</h2><p>It worked in the previous pull request<h2 id=showcase>Showcase</h2><p>See #18961<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=the-problem-and-context>The Problem and Context</h3><p>The ECS spawn API previously lacked a straightforward way to add existing entities to relationships during entity spawning. This limitation forced developers to manually add relationships after spawning entities, resulting in boilerplate code and potential consistency issues. The problem was particularly noticeable in hierarchical entity setups where some child entities might be pre-existing.<h3 id=the-solution-approach>The Solution Approach</h3><p>This PR introduces two new types implementing the <code>SpawnableList</code> trait: <code>WithRelated</code> for adding multiple existing entities and <code>WithOneRelated</code> for adding a single existing entity. These complement the existing <code>Spawn</code>, <code>SpawnIter</code>, and <code>SpawnWith</code> types, completing the API surface for relationship management during spawning. The implementation maintains API consistency by integrating seamlessly with the existing <code>SpawnRelated</code> system.<h3 id=the-implementation>The Implementation</h3><p>The core changes add two new structs and their implementations:<ol><li><strong><code>WithRelated</code></strong> accepts an iterator of existing entities and adds them to a relationship:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>WithRelated</span><span>&LTI>(pub I)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>impl</span><span>&LTR</span><span style=color:#61676ccc>:</span><span> Relationship, I</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Iterator</span><span>&LTItem = Entity>> SpawnableList&LTR> </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>WithRelated</span><span>&LTI> {
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>spawn</span><span>(</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> World, </span><span style=color:#ff8f40>entity</span><span style=color:#61676ccc>:</span><span> Entity) {
</span><span>        world
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>entity_mut</span><span>(entity)
</span><span>            </span><span style=color:#ed9366>.</span><span>add_related</span><span style=color:#ed9366>::</span><span>&LTR>(</span><span style=color:#ed9366>&</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0.</span><span>collect</span><span style=color:#ed9366>::</span><span><</span><span style=color:#55b4d4;font-style:italic>Vec</span><span><</span><span style=color:#ed9366>_</span><span>>>())</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><ol start=2><li><strong><code>WithOneRelated</code></strong> handles single-entity relationships more efficiently:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>WithOneRelated</span><span>(pub Entity)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>impl</span><span>&LTR</span><span style=color:#61676ccc>:</span><span> Relationship> SpawnableList&LTR> </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>WithOneRelated </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>spawn</span><span>(</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> World, </span><span style=color:#ff8f40>entity</span><span style=color:#61676ccc>:</span><span> Entity) {
</span><span>        world</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity_mut</span><span>(entity)</span><span style=color:#ed9366>.</span><span>add_one_related</span><span style=color:#ed9366>::</span><span>&LTR>(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0</span><span>)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><h3 id=technical-insights>Technical Insights</h3><p>The implementation leverages existing relationship methods (<code>add_related</code> and <code>add_one_related</code>) to ensure consistent behavior. Size hints are implemented to help with pre-allocation optimizations. The PR includes comprehensive doc examples showing practical usage patterns:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Adding multiple existing entities as children
</span><span>Children</span><span style=color:#ed9366>::</span><span>spawn(WithRelated([child2</span><span style=color:#61676ccc>,</span><span> child3]</span><span style=color:#ed9366>.</span><span style=color:#f07171>into_iter</span><span>()))
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Adding a single existing entity
</span><span>Children</span><span style=color:#ed9366>::</span><span>spawn(WithOneRelated(child1))
</span></code></pre><h3 id=the-impact>The Impact</h3><p>This change completes the relationship spawning API, allowing all common relationship patterns to be expressed during entity creation. Developers can now:<ol><li>Spawn new entities with relationships<li>Add existing entities to relationships<li>Mix both approaches in a single operation</ol><p>The addition resolves the original issue (#18961) while maintaining backward compatibility and API consistency.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[SpawnableList] --> B[Spawn]
</span><span>    A --> C[SpawnIter]
</span><span>    A --> D[SpawnWith]
</span><span>    A --> E[WithRelated]
</span><span>    A --> F[WithOneRelated]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ecs-src-spawn-rs><code>crates/bevy_ecs/src/spawn.rs</code></h3><p>Added new structs and implementations:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// New struct definition
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>WithRelated</span><span>&LTI>(pub I)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>impl</span><span>&LTR</span><span style=color:#61676ccc>:</span><span> Relationship, I</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Iterator</span><span>&LTItem = Entity>> SpawnableList&LTR> </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>WithRelated</span><span>&LTI> {
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>spawn</span><span>(</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> World, </span><span style=color:#ff8f40>entity</span><span style=color:#61676ccc>:</span><span> Entity) {
</span><span>        world
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>entity_mut</span><span>(entity)
</span><span>            </span><span style=color:#ed9366>.</span><span>add_related</span><span style=color:#ed9366>::</span><span>&LTR>(</span><span style=color:#ed9366>&</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0.</span><span>collect</span><span style=color:#ed9366>::</span><span><</span><span style=color:#55b4d4;font-style:italic>Vec</span><span><</span><span style=color:#ed9366>_</span><span>>>())</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>WithOneRelated</span><span>(pub Entity)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>impl</span><span>&LTR</span><span style=color:#61676ccc>:</span><span> Relationship> SpawnableList&LTR> </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>WithOneRelated </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>spawn</span><span>(</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> World, </span><span style=color:#ff8f40>entity</span><span style=color:#61676ccc>:</span><span> Entity) {
</span><span>        world</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity_mut</span><span>(entity)</span><span style=color:#ed9366>.</span><span>add_one_related</span><span style=color:#ed9366>::</span><span>&LTR>(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0</span><span>)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><p>Updated documentation references:<pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span style=color:#f07171>- /// See [`Spawn`], [`SpawnIter`], and [`SpawnWith`] for usage examples.
</span><span style=color:#86b300>+ /// See [`Spawn`], [`SpawnIter`], [`SpawnWith`], [`WithRelated`] and [`WithOneRelated`] for usage examples.
</span></code></pre><p>Added comprehensive unit tests:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>with_related</span><span>() {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Tests adding multiple existing entities
</span><span>}
</span><span>
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>with_one_related</span><span>() {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Tests adding single existing entity
</span><span>}
</span></code></pre><h3 id=crates-bevy-ecs-src-lib-rs><code>crates/bevy_ecs/src/lib.rs</code></h3><p>Updated prelude exports:<pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span style=color:#f07171>- spawn::{Spawn, SpawnRelated},
</span><span style=color:#86b300>+ spawn::{Spawn, SpawnIter, SpawnRelated, SpawnWith, WithOneRelated, WithRelated},
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_ecs/latest/bevy_ecs/relationship/index.html target=_blank>Bevy ECS Relationships Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/issues/18959 target=_blank>Original Issue Discussion</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_ecs/latest/bevy_ecs/spawn/trait.SpawnableList.html target=_blank>SpawnableList Trait Reference</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-07/pr_19046.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>