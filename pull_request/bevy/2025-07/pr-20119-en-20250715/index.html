<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20119 Improve node encapsulation in `ScheduleGraph`
        
    </title><meta content="#20119 Improve node encapsulation in `ScheduleGraph`" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-07/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-07-15</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-07/pr-20119-zh-cn-20250715>中文</a></div></div><div class=pr-content><h2 id=analysis-of-pr-20119-improve-node-encapsulation-in-schedulegraph>Analysis of PR #20119: Improve node encapsulation in <code>ScheduleGraph</code></h2><h3 id=basic-information>Basic Information</h3><ul><li><strong>Title</strong>: Improve node encapsulation in <code>ScheduleGraph</code><li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20119<li><strong>Author</strong>: ItsDoot<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-ECS, C-Code-Quality, C-Usability, S-Ready-For-Final-Review, M-Needs-Migration-Guide, D-Modest<li><strong>Created</strong>: 2025-07-13T22:30:29Z<li><strong>Merged</strong>: 2025-07-15T06:50:09Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h3 id=the-story-of-this-pull-request>The Story of This Pull Request</h3><h4 id=the-problem-and-context>The Problem and Context</h4><p>The <code>ScheduleGraph</code> struct in Bevy’s ECS module had become increasingly complex, directly managing several distinct concerns:<ol><li>Storage of systems and their conditions<li>Storage of system sets and their conditions<li>Tracking uninitialized nodes<li>Managing graph relationships</ol><p>This violated the single responsibility principle and made the code difficult to maintain. Direct field access throughout the codebase created tight coupling, and the initialization logic for systems/sets was intertwined with graph management. The lack of encapsulation made it challenging to modify or extend schedule functionality.<h4 id=the-solution-approach>The Solution Approach</h4><p>The solution centered on encapsulating related functionality into dedicated structs:<ol><li>Create <code>Systems</code> struct to manage system storage and initialization<li>Create <code>SystemSets</code> struct to manage system set storage and initialization<li>Move node-related types (<code>SystemNode</code>, <code>SystemWithAccess</code>, etc.) to a new module<li>Remove direct field access from <code>ScheduleGraph</code> in favor of encapsulated APIs</ol><p>Key engineering decisions:<ul><li>Maintained existing slotmap-based storage for systems/sets<li>Split initialization tracking between <code>Systems</code> and <code>SystemSets</code><li>Kept public fields on <code>ScheduleGraph</code> for direct access to the new structs<li>Preserved existing graph algorithms while cleaning up their implementation</ul><h4 id=the-implementation>The Implementation</h4><p>The core changes involved extracting system and system set management from <code>ScheduleGraph</code>:<p><strong>New <code>node.rs</code> module</strong> (+615 LOC)<br> This file introduces the key data structures:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>Systems </span><span>{
</span><span>    nodes</span><span style=color:#61676ccc>: </span><span>SlotMap&LTSystemKey, SystemNode>,
</span><span>    conditions</span><span style=color:#61676ccc>: </span><span>SecondaryMap&LTSystemKey, </span><span style=color:#55b4d4;font-style:italic>Vec</span><span>&LTConditionWithAccess>>,
</span><span>    uninit</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Vec</span><span>&LTSystemKey>,
</span><span>}
</span><span>
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>SystemSets </span><span>{
</span><span>    sets</span><span style=color:#61676ccc>: </span><span>SlotMap&LTSystemSetKey, InternedSystemSet>,
</span><span>    conditions</span><span style=color:#61676ccc>: </span><span>SecondaryMap&LTSystemSetKey, </span><span style=color:#55b4d4;font-style:italic>Vec</span><span>&LTConditionWithAccess>>,
</span><span>    ids</span><span style=color:#61676ccc>: </span><span>HashMap&LTInternedSystemSet, SystemSetKey>,
</span><span>    uninit</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Vec</span><span>&LTUninitializedSet>,
</span><span>}
</span></code></pre><p>Both structs provide methods for insertion, initialization, and access:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Systems API example
</span><span style=color:#fa6e32>impl </span><span style=color:#399ee6>Systems </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>insert</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>system</span><span style=color:#61676ccc>:</span><span> ScheduleSystem, </span><span style=color:#ff8f40>conditions</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Vec</span><span><</span><span style=color:#f51818>.</span><span>..>) </span><span style=color:#61676ccc>-></span><span> SystemKey {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// Insertion logic with deferred initialization
</span><span>    }
</span><span>    
</span><span>    </span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>initialize</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> World) {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// Initialize pending systems
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// SystemSets API example
</span><span style=color:#fa6e32>impl </span><span style=color:#399ee6>SystemSets </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>insert</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>set</span><span style=color:#61676ccc>:</span><span> InternedSystemSet, </span><span style=color:#ff8f40>new_conditions</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Vec</span><span><</span><span style=color:#f51818>.</span><span>..>) </span><span style=color:#61676ccc>-></span><span> SystemSetKey {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// Insertion with condition tracking
</span><span>    }
</span><span>}
</span></code></pre><p><strong>Refactored <code>schedule.rs</code></strong> (-256 net LOC)<br> <code>ScheduleGraph</code> now delegates to the new structs:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>ScheduleGraph </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>systems</span><span style=color:#61676ccc>:</span><span> Systems,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>system_sets</span><span style=color:#61676ccc>:</span><span> SystemSets,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...other fields (hierarchy, dependency, etc.)...
</span><span>}
</span><span>
</span><span style=color:#fa6e32>impl </span><span style=color:#399ee6>ScheduleGraph </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>initialize</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> World) {
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>systems</span><span style=color:#ed9366>.</span><span style=color:#f07171>initialize</span><span>(world)</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>system_sets</span><span style=color:#ed9366>.</span><span style=color:#f07171>initialize</span><span>(world)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>    
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Removed 15+ helper methods now provided by Systems/SystemSets
</span><span>}
</span></code></pre><p><strong>Migration Guide Update</strong><br> Replaced <code>schedule_slotmaps.md</code> with <code>schedule_cleanup.md</code> (+37/-34 LOC) to document:<ul><li>New key types (<code>SystemKey</code>, <code>SystemSetKey</code>)<li>Removed accessor methods<li>Updated initialization patterns</ul><p><strong>Executor Updates</strong><br> Modified executor implementations to use new access patterns:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>if </span><span style=color:#f07171>is_apply_deferred</span><span>(</span><span style=color:#ed9366>&</span><span>graph</span><span style=color:#ed9366>.</span><span>systems[key]</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#ed9366>.</span><span>system)
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>if </span><span style=color:#f07171>is_apply_deferred</span><span>(</span><span style=color:#ed9366>&</span><span>graph</span><span style=color:#ed9366>.</span><span>systems[key])
</span></code></pre><h4 id=technical-insights>Technical Insights</h4><p>The refactoring provides several technical benefits:<ol><li><strong>Encapsulation</strong>: Each struct manages its own state and initialization<li><strong>Cohesion</strong>: Related functionality is colocated (e.g., system initialization)<li><strong>Reduced Coupling</strong>: Graph algorithms no longer directly manipulate system state<li><strong>Testability</strong>: New structs include dedicated unit tests<li><strong>Maintainability</strong>: 30% reduction in <code>schedule.rs</code> complexity</ol><p>The initialization process is now more efficient because:<ul><li>Systems and sets initialize independently<li>Condition ranges are tracked precisely<li>Redundant initialization checks are eliminated</ul><h4 id=the-impact>The Impact</h4><p>These changes significantly improve the schedule code’s maintainability while preserving existing behavior. The encapsulation makes future enhancements like dynamic schedule modification more feasible. The migration guide ensures existing uses of schedule APIs can adapt to the new structure.<h3 id=visual-representation>Visual Representation</h3><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    SG[ScheduleGraph] --> Systems
</span><span>    SG --> SystemSets
</span><span>    Systems --> SystemNode
</span><span>    Systems --> Conditions
</span><span>    SystemSets --> SystemSet
</span><span>    SystemSets --> SetConditions
</span></code></pre><h3 id=key-files-changed>Key Files Changed</h3><ol><li><p><code>crates/bevy_ecs/src/schedule/node.rs</code> (+615/-0)<br> New module containing:</p> <ul><li><code>Systems</code>/<code>SystemSets</code> implementations<li>Node types (<code>SystemNode</code>, <code>SystemWithAccess</code>)<li>Unit tests</ul><li><p><code>crates/bevy_ecs/src/schedule/schedule.rs</code> (+41/-297)<br> Major refactor of <code>ScheduleGraph</code>:</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub</span><span> systems</span><span style=color:#61676ccc>: </span><span>SlotMap&LTSystemKey, SystemNode></span><span style=color:#61676ccc>,
</span><span style=color:#fa6e32>pub</span><span> system_conditions</span><span style=color:#61676ccc>: </span><span>SecondaryMap<</span><span style=color:#f51818>.</span><span style=color:#ed9366>..></span><span style=color:#61676ccc>,
</span><span>system_sets</span><span style=color:#61676ccc>:</span><span> OldSystemSets</span><span style=color:#61676ccc>,
</span><span>uninit</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Vec</span><span>&LTUninitializedId></span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub</span><span> systems</span><span style=color:#61676ccc>:</span><span> Systems</span><span style=color:#61676ccc>,
</span><span style=color:#fa6e32>pub</span><span> system_sets</span><span style=color:#61676ccc>:</span><span> SystemSets</span><span style=color:#61676ccc>,
</span></code></pre><li><p><code>release-content/migration-guides/schedule_cleanup.md</code> (+37/-0)<br> New migration guide explaining:</p> <ul><li>New key types<li>Removed methods<li>Access pattern changes</ul><li><p><code>release-content/migration-guides/schedule_slotmaps.md</code> (+0/-34)<br> Deleted outdated migration guide</p><li><p><code>crates/bevy_ecs/src/schedule/auto_insert_apply_deferred.rs</code> (+9/-12)<br> Updated to use new APIs:</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#ed9366>!</span><span>graph</span><span style=color:#ed9366>.</span><span>system_conditions[key]</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_empty</span><span>()
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>graph</span><span style=color:#ed9366>.</span><span>systems</span><span style=color:#ed9366>.</span><span style=color:#f07171>has_conditions</span><span>(key)
</span></code></pre></ol><h3 id=further-reading>Further Reading</h3><ol><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/slotmap/latest/slotmap/ target=_blank>SlotMap documentation</a> - Underlying storage mechanism<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/ecs/ target=_blank>Bevy ECS architecture</a> - Overall context<li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Encapsulation_(computer_programming) target=_blank>Encapsulation principles</a> - Design rationale<li>Original issue: <a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/issues/20115 target=_blank>#20115</a> - Larger initiative</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-07/pr_20119.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>