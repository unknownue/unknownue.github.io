<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20195
        
    </title><meta content=#20195 property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-07/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-07-22</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-07/pr-20195-zh-cn-20250722>中文</a></div></div><div class=pr-content><h2 id=analysis-of-pr-20195-use-renderstartup-for-copydeferredlightingidpipeline>Analysis of PR #20195: Use <code>RenderStartup</code> for <code>CopyDeferredLightingIdPipeline</code></h2><h3 id=the-story-of-this-pull-request>The Story of This Pull Request</h3><p>This PR addresses a specific segfault that occurred under Linux/Vulkan/llvmpipe configurations when terminating the application while pipelines were being compiled in parallel. The root cause was a thread safety issue in LLVM’s <code>atexit</code> handlers during concurrent pipeline compilation. The primary objective was to migrate <code>CopyDeferredLightingIdPipeline</code> initialization to the <code>RenderStartup</code> schedule as part of #19887, but the solution also required specific test modifications to prevent the segfault.<p>The problem manifested as consistent segfaults in CI runs, particularly in the <code>ambiguity_detection</code> test. Investigation revealed that pipeline compilation threads were still active during application termination when using the llvmpipe driver. This PR implements two key changes: First, it converts the <code>FromWorld</code> implementation to a <code>RenderStartup</code> system like other render resources. Second, it modifies the problematic test to force synchronous pipeline compilation and disable pipelined rendering, ensuring all rendering operations complete before test termination.<p>The implementation follows Bevy’s established pattern for render resource initialization. The <code>CopyDeferredLightingIdPipeline</code> resource creation was moved from a <code>FromWorld</code> impl to a dedicated system in <code>RenderStartup</code>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before (FromWorld impl):
</span><span style=color:#fa6e32>impl </span><span>FromWorld </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>CopyDeferredLightingIdPipeline </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>from_world</span><span>(</span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> World) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// Resource initialization code
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After (RenderStartup system):
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>init_copy_deferred_lighting_id_pipeline</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands,
</span><span>    </span><span style=color:#ff8f40>render_device</span><span style=color:#61676ccc>: </span><span>Res&LTRenderDevice>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other dependencies
</span><span>) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Initialization logic
</span><span>    commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_resource</span><span>(CopyDeferredLightingIdPipeline { </span><span style=color:#ed9366>... </span><span>})</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>This change improves consistency with other render resources and provides more explicit control over initialization timing. The system uses standard ECS queries to access necessary resources like <code>RenderDevice</code> and <code>PipelineCache</code>, making dependencies explicit and improving testability.<p>For the test fix, we modified the ambiguity detection test to configure rendering for synchronous operation:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_plugins</span><span>(
</span><span>    DefaultPlugins
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>build</span><span>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>set</span><span>(RenderPlugin {
</span><span>            synchronous_pipeline_compilation</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>true</span><span style=color:#61676ccc>,
</span><span>            </span><span style=color:#ed9366>..</span><span style=color:#55b4d4;font-style:italic>Default</span><span style=color:#ed9366>::</span><span>default()
</span><span>        })
</span><span>        </span><span style=color:#ed9366>.</span><span>disable</span><span style=color:#ed9366>::</span><span>&LTPipelinedRenderingPlugin>()</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><p>The <code>synchronous_pipeline_compilation</code> setting ensures the render thread blocks on pipeline compilation rather than processing it asynchronously. Disabling <code>PipelinedRenderingPlugin</code> guarantees the test doesn’t terminate while render operations are still in progress. These changes prevent the race condition between pipeline compilation and application termination that caused the segfault.<p>The PR also updates the render startup migration guide to include the newly migrated resource, maintaining documentation consistency. After these changes, extensive testing confirmed the segfault no longer occurs in the previously problematic Linux/Vulkan/llvmpipe environment.<h3 id=visual-representation>Visual Representation</h3><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[CopyDeferredLightingIdPlugin] --> B[RenderStartup System]
</span><span>    B --> C[Init Pipeline Resource]
</span><span>    D[Ambiguity Test] --> E[Enable Sync Compilation]
</span><span>    D --> F[Disable Pipelined Rendering]
</span><span>    C --> G[Prevent Segfault]
</span><span>    E --> G
</span><span>    F --> G
</span></code></pre><h3 id=key-files-changed>Key Files Changed</h3><ol><li><p><strong>crates/bevy_core_pipeline/src/deferred/copy_lighting_id.rs</strong> (+47/-54)<br> Migrated pipeline initialization to <code>RenderStartup</code> schedule:</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>finish</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>app</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> App) {
</span><span>    render_app</span><span style=color:#ed9366>.</span><span>init_resource</span><span style=color:#ed9366>::</span><span>&LTCopyDeferredLightingIdPipeline>()</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>build</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>app</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> App) {
</span><span>    render_app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(RenderStartup</span><span style=color:#61676ccc>,</span><span> init_copy_deferred_lighting_id_pipeline)</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// New initialization system:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>init_copy_deferred_lighting_id_pipeline</span><span>(...) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Uses explicit dependencies via system parameters
</span><span>    commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_resource</span><span>(CopyDeferredLightingIdPipeline { </span><span style=color:#ed9366>... </span><span>})</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><li><p><strong>tests/ecs/ambiguity_detection.rs</strong> (+16/-12)<br> Modified test configuration to prevent segfault:</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_plugins</span><span>(DefaultPlugins)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_plugins</span><span>(DefaultPlugins</span><span style=color:#ed9366>.</span><span style=color:#f07171>build</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>set</span><span>(RenderPlugin {
</span><span>        synchronous_pipeline_compilation</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>true</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#ed9366>..
</span><span>    })
</span><span>    </span><span style=color:#ed9366>.</span><span>disable</span><span style=color:#ed9366>::</span><span>&LTPipelinedRenderingPlugin>()
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><li><p><strong>release-content/migration-guides/render_startup.md</strong> (+1/-0)<br> Updated migration documentation:</p> <pre class=language-markdown data-lang=markdown style=color:#61676c;background-color:#fafafa><code class=language-markdown data-lang=markdown><span style=color:#4cbf99>- </span><span style=color:#ed9366;background-color:#61676c10>`CopyDeferredLightingIdPipeline`</span><span>
</span></code></pre></ol><h3 id=further-reading>Further Reading</h3><ol><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/issues/19887 target=_blank>Bevy Render Startup Migration</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/docs/plugins/pipelined_rendering.md target=_blank>Bevy Pipelined Rendering Architecture</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/getting-started/shaders/ target=_blank>WGSL Shader Compilation in Bevy</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-07/pr_20195.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>