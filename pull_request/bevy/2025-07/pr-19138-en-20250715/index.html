<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19138 ReadOnlySystem diagnostics and type alias
        
    </title><meta content="#19138 ReadOnlySystem diagnostics and type alias" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-07/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-07-15</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-07/pr-19138-zh-cn-20250715>中文</a></div></div><div class=pr-content><h2 id=readonlysystem-diagnostics-and-type-alias>ReadOnlySystem diagnostics and type alias</h2><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: ReadOnlySystem diagnostics and type alias<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19138<li><strong>Author</strong>: ItsDoot<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-ECS, C-Usability, S-Ready-For-Final-Review, D-Straightforward<li><strong>Created</strong>: 2025-05-09T07:53:30Z<li><strong>Merged</strong>: 2025-07-15T00:35:25Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Improve usability of read-only systems.</ul><h2 id=solution>Solution</h2><ul><li>Added <code>on_unimplemented</code> diagnostics for types/functions that aren’t read-only systems.<li>Added <code>BoxedReadOnlySystem</code> type alias, similar to <code>BoxedSystem</code>.</ul><h2 id=testing>Testing</h2><p>Can/should we test these diagnostics?<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>In Bevy’s ECS architecture, read-only systems play a critical role in enabling parallel execution. Systems implementing the <code>ReadOnlySystem</code> trait guarantee they won’t mutate the <code>World</code> state, allowing the scheduler to safely execute them concurrently with other read-only systems. However, two usability issues existed in the previous implementation.<p>First, when developers accidentally used a mutable system where a read-only system was required, the compiler errors were generic and unhelpful. The error messages didn’t clearly indicate that the issue was specifically about the read-only constraint, making debugging unnecessarily difficult. For example:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before PR: Generic error when passing mutable system to read-only context
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>mutable_system</span><span>(</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>query</span><span style=color:#61676ccc>: </span><span>Query<</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> Transform>) { </span><span style=color:#abb0b6;font-style:italic>/* ... */ </span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Scheduling code expecting read-only system
</span><span>schedule</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(mutable_system</span><span style=color:#ed9366>.</span><span style=color:#f07171>into_readonly_system</span><span>())</span><span style=color:#61676ccc>;
</span></code></pre><p>Second, while Bevy provided <code>BoxedSystem</code> for dynamically typed systems, there was no equivalent for read-only systems. This forced developers to use verbose type declarations when working with collections of boxed read-only systems:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before PR: No concise way to box read-only systems
</span><span style=color:#fa6e32>let</span><span> systems</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Vec</span><span><</span><span style=color:#55b4d4;font-style:italic>Box</span><span>&LTdyn ReadOnlySystem&LTIn = (), Out = ()>>> </span><span style=color:#ed9366>= </span><span style=color:#f07171>vec!</span><span>[
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Box</span><span style=color:#ed9366>::</span><span>new(system_a)</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Box</span><span style=color:#ed9366>::</span><span>new(system_b)
</span><span>]</span><span style=color:#61676ccc>;
</span></code></pre><p>To address these issues, the PR implemented two targeted improvements. The first change adds custom diagnostics to the <code>ReadOnlySystem</code> trait using Rust’s <code>on_unimplemented</code> attribute. This attribute generates clearer error messages when a type fails to implement the trait:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>diagnostic</span><span>::</span><span style=color:#f29718>on_unimplemented</span><span>(
</span><span>    message </span><span style=color:#ed9366>= </span><span style=color:#86b300>"`{Self}` is not a read-only system"</span><span style=color:#61676ccc>,
</span><span>    label </span><span style=color:#ed9366>= </span><span style=color:#86b300>"invalid read-only system"
</span><span>)]
</span><span style=color:#fa6e32>pub unsafe trait </span><span style=color:#399ee6>ReadOnlySystem</span><span>: System {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... existing trait methods ...
</span><span>}
</span></code></pre><p>Now when a mutable system is used incorrectly, the compiler explicitly states: “<code>{SystemType}</code> is not a read-only system” with the label “invalid read-only system”. This immediate feedback helps developers quickly identify and fix the root cause.<p>The second change introduces a <code>BoxedReadOnlySystem</code> type alias that mirrors the existing <code>BoxedSystem</code> pattern:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub type </span><span style=color:#399ee6>BoxedReadOnlySystem</span><span style=color:#ed9366><</span><span>In </span><span style=color:#ed9366>= </span><span>()</span><span style=color:#61676ccc>,</span><span> Out </span><span style=color:#ed9366>= </span><span>()</span><span style=color:#ed9366>> = </span><span style=color:#55b4d4;font-style:italic>Box</span><span>&LTdyn ReadOnlySystem&LTIn = In, Out = Out>></span><span style=color:#61676ccc>;
</span></code></pre><p>This allows more concise and readable code when working with boxed read-only systems:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// After PR: Cleaner boxed read-only system usage
</span><span style=color:#fa6e32>let</span><span> systems</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Vec</span><span>&LTBoxedReadOnlySystem> </span><span style=color:#ed9366>= </span><span style=color:#f07171>vec!</span><span>[
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Box</span><span style=color:#ed9366>::</span><span>new(system_a)</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Box</span><span style=color:#ed9366>::</span><span>new(system_b)
</span><span>]</span><span style=color:#61676ccc>;
</span></code></pre><p>Both changes are intentionally minimal and non-breaking. They follow existing patterns in Bevy’s ECS implementation while significantly improving developer experience. The diagnostics improvement helps catch mistakes earlier in development, while the type alias reduces boilerplate and improves code readability when working with dynamic system collections.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    S[System] -->|extends| RS[ReadOnlySystem]
</span><span>    RS -.->|custom diagnostics| E[Compiler Errors]
</span><span>    RS -->|aliased| BRS[BoxedReadOnlySystem]
</span><span>    S -->|aliased| BS[BoxedSystem]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ol><li><code>crates/bevy_ecs/src/system/system.rs</code> <ul><li>Added diagnostic attributes to <code>ReadOnlySystem</code><li>Created new type alias <code>BoxedReadOnlySystem</code></ul></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: No diagnostics or type alias
</span><span style=color:#fa6e32>pub unsafe trait </span><span style=color:#399ee6>ReadOnlySystem</span><span>: System {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>}
</span><span>
</span><span style=color:#fa6e32>pub type </span><span style=color:#399ee6>BoxedSystem</span><span style=color:#ed9366><</span><span>In </span><span style=color:#ed9366>= </span><span>()</span><span style=color:#61676ccc>,</span><span> Out </span><span style=color:#ed9366>= </span><span>()</span><span style=color:#ed9366>> = </span><span style=color:#55b4d4;font-style:italic>Box</span><span>&LTdyn System&LTIn = In, Out = Out>></span><span style=color:#61676ccc>;
</span></code></pre><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// After: Added diagnostics and type alias
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>diagnostic</span><span>::</span><span style=color:#f29718>on_unimplemented</span><span>(
</span><span>    message </span><span style=color:#ed9366>= </span><span style=color:#86b300>"`{Self}` is not a read-only system"</span><span style=color:#61676ccc>,
</span><span>    label </span><span style=color:#ed9366>= </span><span style=color:#86b300>"invalid read-only system"
</span><span>)]
</span><span style=color:#fa6e32>pub unsafe trait </span><span style=color:#399ee6>ReadOnlySystem</span><span>: System {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>}
</span><span>
</span><span style=color:#fa6e32>pub type </span><span style=color:#399ee6>BoxedSystem</span><span style=color:#ed9366><</span><span>In </span><span style=color:#ed9366>= </span><span>()</span><span style=color:#61676ccc>,</span><span> Out </span><span style=color:#ed9366>= </span><span>()</span><span style=color:#ed9366>> = </span><span style=color:#55b4d4;font-style:italic>Box</span><span>&LTdyn System&LTIn = In, Out = Out>></span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>/// A convenience type alias for a boxed [`ReadOnlySystem`] trait object.
</span><span style=color:#fa6e32>pub type </span><span style=color:#399ee6>BoxedReadOnlySystem</span><span style=color:#ed9366><</span><span>In </span><span style=color:#ed9366>= </span><span>()</span><span style=color:#61676ccc>,</span><span> Out </span><span style=color:#ed9366>= </span><span>()</span><span style=color:#ed9366>> = </span><span style=color:#55b4d4;font-style:italic>Box</span><span>&LTdyn ReadOnlySystem&LTIn = In, Out = Out>></span><span style=color:#61676ccc>;
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/rustc/diagnostics/diagnostics.html#the-on_unimplemented-attribute target=_blank>Rust’s <code>on_unimplemented</code> attribute</a> (unstable feature)<li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_ecs/latest/bevy_ecs/system/trait.System.html target=_blank>Bevy ECS System Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/migration-guides/0.12-to-0.13/#parallel-query-iteration target=_blank>Bevy Parallel Query Execution</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-07/pr_19138.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>