<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20085 Add `max_history_length` to `EntityCountDiagnosticsPlugin`
        
    </title><meta content="#20085 Add `max_history_length` to `EntityCountDiagnosticsPlugin`" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-07/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-07-12</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-07/pr-20085-zh-cn-20250712>中文</a></div></div><div class=pr-content><h1 id=analysis-of-pr-20085-add-max-history-length-to-entitycountdiagnosticsplugin>Analysis of PR #20085: Add <code>max_history_length</code> to <code>EntityCountDiagnosticsPlugin</code></h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Add <code>max_history_length</code> to <code>EntityCountDiagnosticsPlugin</code><li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20085<li><strong>Author</strong>: onbjerg<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Diagnostics, S-Needs-Review<li><strong>Created</strong>: 2025-07-11T14:18:04Z<li><strong>Merged</strong>: 2025-07-12T23:20:21Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>I was building out a diagnostics panel in egui when I noticed that I could specify the max history length for the <code>FrameTimeDiagnosticsPlugin</code>, but not for the <code>EntityCountDiagnosticsPlugin</code>. The objective was to harmonize the two, making the diagnostic history length configurable for both.<h2 id=solution>Solution</h2><p>I added a <code>EntityCountDiagnosticsPlugin::new</code>, and a <code>Default</code> impl that matches <code>FrameTimeDiagnosticsPlugin</code>.<p>This is a breaking change, given the plugin had no fields previously.<h2 id=testing>Testing</h2><p>I did not test this.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=the-problem-and-context>The Problem and Context</h3><p>While developing a diagnostics panel using egui, the author noticed an inconsistency in Bevy’s diagnostic plugins. The <code>FrameTimeDiagnosticsPlugin</code> allowed configuration of its history length through its constructor and <code>max_history_length</code> parameter, but the <code>EntityCountDiagnosticsPlugin</code> lacked this capability. This limitation prevented developers from controlling how much historical entity count data would be retained, which was particularly important for diagnostic visualization tools that need to display trends over time. The absence of this feature created an unnecessary inconsistency between similar diagnostic plugins.<h3 id=the-solution-approach>The Solution Approach</h3><p>To address this gap, the author implemented a parallel configuration approach for both plugins. The solution involved:<ol><li>Adding a <code>max_history_length</code> parameter to <code>EntityCountDiagnosticsPlugin</code><li>Implementing a constructor (<code>::new()</code>) to initialize this parameter<li>Providing a <code>Default</code> implementation that uses the existing <code>DEFAULT_MAX_HISTORY_LENGTH</code> constant<li>Propagating the configured value to the diagnostic registration<li>Updating usage examples to match the new initialization pattern</ol><p>This approach maintained consistency with Bevy’s existing diagnostic plugin patterns while providing the same level of configurability for both plugins. The implementation intentionally mirrors the structure of <code>FrameTimeDiagnosticsPlugin</code> to maintain API consistency across diagnostic utilities.<h3 id=the-implementation>The Implementation</h3><p>The core change modifies the <code>EntityCountDiagnosticsPlugin</code> struct to include a <code>max_history_length</code> field. Previously, this plugin was a zero-sized type (unit struct), but it now contains configuration data:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Default)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>EntityCountDiagnosticsPlugin</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>EntityCountDiagnosticsPlugin </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>max_history_length</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize</span><span>,
</span><span>}
</span></code></pre><p>The plugin now uses the standard pattern seen in other Bevy diagnostics plugins by providing explicit initialization methods:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>impl </span><span>Default </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>EntityCountDiagnosticsPlugin </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>default</span><span>() </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>        </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ff8f40>DEFAULT_MAX_HISTORY_LENGTH</span><span>)
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#fa6e32>impl </span><span style=color:#399ee6>EntityCountDiagnosticsPlugin </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>new</span><span>(</span><span style=color:#ff8f40>max_history_length</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>        </span><span style=color:#fa6e32>Self </span><span>{ max_history_length }
</span><span>    }
</span><span>}
</span></code></pre><p>During plugin initialization, the configured history length is applied to the diagnostic:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>register_diagnostic</span><span>(
</span><span>    Diagnostic</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ENTITY_COUNT</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>with_max_history_length</span><span>(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>max_history_length)</span><span style=color:#61676ccc>,
</span><span>)
</span></code></pre><p>This change propagates the configuration to the diagnostic system, ensuring the entity count history buffer uses the specified size.<h3 id=technical-insights>Technical Insights</h3><p>The implementation uses Bevy’s existing diagnostic extension pattern where:<ol><li><code>Diagnostic::new()</code> creates a basic diagnostic<li><code>.with_max_history_length()</code> configures its history buffer<li><code>register_diagnostic()</code> adds it to the app’s diagnostics collection</ol><p>The <code>DEFAULT_MAX_HISTORY_LENGTH</code> constant (imported from the same crate) ensures consistency with other diagnostics that use the same default value. This approach maintains the established convention while making the configuration explicit.<h3 id=the-impact>The Impact</h3><p>This change:<ol><li>Harmonizes the API between <code>EntityCountDiagnosticsPlugin</code> and <code>FrameTimeDiagnosticsPlugin</code><li>Allows developers to control the history retention for entity count diagnostics<li>Enables more consistent diagnostic visualization in tools like egui panels<li>Fixes an API inconsistency in Bevy’s diagnostics system</ol><p>As noted in the PR description, this is a breaking change since it converts a unit struct to a struct with a field. Existing code using <code>EntityCountDiagnosticsPlugin</code> without initialization will break and must be updated to use <code>EntityCountDiagnosticsPlugin::default()</code> or explicitly configure the history length.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[EntityCountDiagnosticsPlugin] --> B[Diagnostic Registration]
</span><span>    B --> C[History Buffer]
</span><span>    D[FrameTimeDiagnosticsPlugin] --> B
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-diagnostic-src-entity-count-diagnostics-plugin-rs-24-5><code>crates/bevy_diagnostic/src/entity_count_diagnostics_plugin.rs</code> (+24/-5)</h3><p><strong>Changes</strong>: Added configuration options to control diagnostic history length<br> <strong>Why</strong>: To match the capabilities of FrameTimeDiagnosticsPlugin and allow history length configuration<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Default)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>EntityCountDiagnosticsPlugin</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>EntityCountDiagnosticsPlugin </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>max_history_length</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize</span><span>,
</span><span>}
</span><span>
</span><span style=color:#fa6e32>impl </span><span>Default </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>EntityCountDiagnosticsPlugin </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>default</span><span>() </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>        </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ff8f40>DEFAULT_MAX_HISTORY_LENGTH</span><span>)
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#fa6e32>impl </span><span style=color:#399ee6>EntityCountDiagnosticsPlugin </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>new</span><span>(</span><span style=color:#ff8f40>max_history_length</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>        </span><span style=color:#fa6e32>Self </span><span>{ max_history_length }
</span><span>    }
</span><span>}
</span></code></pre><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>register_diagnostic</span><span>(Diagnostic</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ENTITY_COUNT</span><span>))
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>register_diagnostic</span><span>(
</span><span>    Diagnostic</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ENTITY_COUNT</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>with_max_history_length</span><span>(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>max_history_length)</span><span style=color:#61676ccc>,
</span><span>)
</span></code></pre><h3 id=examples-diagnostics-log-diagnostics-rs-1-1><code>examples/diagnostics/log_diagnostics.rs</code> (+1/-1)</h3><p><strong>Changes</strong>: Updated example to use the new initialization pattern<br> <strong>Why</strong>: To demonstrate the updated API usage after the breaking change<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>EntityCountDiagnosticsPlugin</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>EntityCountDiagnosticsPlugin</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>,
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/diagnostic/index.html target=_blank>Bevy Diagnostics Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/crates/bevy_diagnostic/src/frame_time_diagnostics_plugin.rs target=_blank>FrameTimeDiagnosticsPlugin Source</a><li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/programming/plugins.html target=_blank>Bevy Plugin System</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-07/pr_20085.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>