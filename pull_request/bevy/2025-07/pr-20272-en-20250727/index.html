<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20272 Fix spotlight basis
        
    </title><meta content="#20272 Fix spotlight basis" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-07/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-07-27</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-07/pr-20272-zh-cn-20250727>中文</a></div></div><div class=pr-content><h1 id=analysis-pr-20272-fix-spotlight-basis>Analysis: PR #20272 - Fix Spotlight Basis</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix spotlight basis<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20272<li><strong>Author</strong>: atlv24<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, C-Code-Quality, S-Ready-For-Final-Review, P-Regression, D-Shaders, M-Deliberate-Rendering-Change<li><strong>Created</strong>: 2025-07-24T14:42:33Z<li><strong>Merged</strong>: 2025-07-25T12:05:19Z<li><strong>Merged By</strong>: superdump</ul><h2 id=description>Description</h2><h1 id=objective>Objective</h1><ul><li>Fix a visual regression introduced by #20191 where there’s a slight green line in lighting example between cube and plane</ul><p>bestRanar:<blockquote><p>I know some minor shadow differences were expected after https://github.com/bevyengine/bevy/pull/20191 But the new green line below the front face of the cube in lighting seems interesting. Is that expected? https://pixel-eagle.com/project/b25a040a-a980-4602-b90c-d480ab84076d/run/11500/compare/11494?screenshot=3D+Rendering/lighting.png</blockquote><h2 id=solution>Solution</h2><p>It turns out, I accidentally unflipped the x and y axis in the basis construction of spotlights to actually match the JCGT paper. This wasn’t something I realized at the time, but its just a handedness flip. This means that the handedness flip Aceeri was asking about in #20191 which I just extracted from the orthonormalize implementation was just there to correct for a mistranslation in the original implementation, probably.<p>So this means we can just yeet it, because two handedness flips means none at all. And indeed, removing the extra flip fixes the regression. So now the code is more straightforward and understandable and it works :D<p>Most of the diff is updating the comments to reflect this new knowledge.<h2 id=testing>Testing</h2><ul><li>lighting example</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=the-problem-and-context>The Problem and Context</h3><p>After merging PR #20191, users noticed a visual regression in Bevy’s lighting example - a subtle green line appeared between the cube and plane surfaces. This was unexpected since #20191 primarily focused on shadow improvements. The regression was confirmed through visual comparison tools showing the artifact in lighting rendering.<p>The root cause was traced to how spotlight basis matrices were constructed. PR #20191 had modified the orthonormalization process to better match the JCGT paper’s method, but inadvertently introduced a handedness inconsistency. The original implementation contained a handedness flip to compensate for an earlier mistranslation. By “fixing” the implementation to match the paper, we ended up with two opposing handedness flips that canceled each other out. Removing one flip (as done in #20191) left the system with an incorrect single flip.<h3 id=the-solution-approach>The Solution Approach</h3><p>The solution was straightforward once the double-flip situation was understood. Since two opposing handedness flips effectively cancel each other, removing the remaining explicit flip would maintain correct rendering while simplifying the code. This approach:<ol><li>Eliminates unnecessary matrix operations<li>Aligns both CPU and GPU implementations<li>Reduces code complexity<li>Maintains visual correctness</ol><p>The key insight was recognizing that the original flip wasn’t needed - it only existed to compensate for an earlier implementation error. By removing it entirely, we achieve a cleaner implementation that matches the paper’s intended behavior.<h3 id=the-implementation>The Implementation</h3><p>The changes focused on three main areas:<ol><li><strong>Rust spotlight matrix generation</strong>: Removed the explicit handedness flip in <code>spot_light_world_from_view</code><li><strong>WGSL shader logic</strong>: Removed the equivalent flip in shadow calculation<li><strong>Documentation</strong>: Updated comments to reflect the corrected basis construction</ol><p>The Rust and shader implementations needed to stay perfectly synchronized since they both construct orthonormal bases using the same mathematical approach. The changes ensure both sides use identical right-handed basis construction without additional flips.<h3 id=technical-insights>Technical Insights</h3><p>The orthonormalization process follows the method from <a rel="noopener nofollow noreferrer" href=https://jcgt.org/published/0006/01/01/paper.pdf target=_blank>“Building an Orthonormal Basis, Revisited” (JCGT paper)</a>. The core algorithm efficiently constructs an orthonormal basis from a single vector (typically the forward direction) using branchless operations suitable for GPU execution.<p>The key realization was that the original Bevy implementation contained two compensating transformations:<ol><li>An unintentional basis flip from early implementation choices<li>An explicit flip added later to correct it</ol><p>This PR removes both, leaving only the correct basis construction. The solution demonstrates how understanding historical context can reveal opportunities to simplify complex code.<h3 id=the-impact>The Impact</h3><p>These changes:<ol><li>Fixed the visual regression in the lighting example<li>Simplified spotlight basis calculation by removing unnecessary operations<li>Improved code maintainability by removing special-case handling<li>Enhanced consistency between CPU and GPU implementations<li>Provided clearer documentation of the basis construction process</ol><p>The fix was verified by testing the lighting example and confirming the green artifact disappeared. The changes also make future modifications to lighting calculations less error-prone by reducing implementation complexity.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[SpotLight Basis Calculation] --> B[Rust Implementation]
</span><span>    A --> C[WGSL Shader Implementation]
</span><span>    B --> D[orthonormalize function]
</span><span>    C --> D
</span><span>    D --> E[JCGT Paper Algorithm]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=1-crates-bevy-light-src-spot-light-rs-2-6>1. <code>crates/bevy_light/src/spot_light.rs</code> (+2/-6)</h3><p><strong>Purpose:</strong> Remove handedness flip from spotlight matrix generation<br> <strong>Key Changes:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#abb0b6;font-style:italic>/// Constructs a left-handed orthonormal basis with translation...
</span><span style=color:#abb0b6;font-style:italic>/// This is a handedness-inverted version of [`orthonormalize`]...
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>spot_light_world_from_view</span><span>(</span><span style=color:#ff8f40>transform</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>GlobalTransform) </span><span style=color:#61676ccc>-></span><span> Mat4 {
</span><span>    </span><span style=color:#fa6e32>let</span><span> basis </span><span style=color:#ed9366>= </span><span style=color:#f07171>orthonormalize</span><span>(fwd_dir)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> mat </span><span style=color:#ed9366>= </span><span>Mat4</span><span style=color:#ed9366>::</span><span>from_mat3(basis)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// handedness flip
</span><span>    mat</span><span style=color:#ed9366>.</span><span>x_axis </span><span style=color:#ed9366>= -</span><span>mat</span><span style=color:#ed9366>.</span><span>x_axis</span><span style=color:#61676ccc>;
</span><span>    mat</span><span style=color:#ed9366>.</span><span>w_axis </span><span style=color:#ed9366>=</span><span> transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>translation</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend</span><span>(</span><span style=color:#ff8f40>1.0</span><span>)</span><span style=color:#61676ccc>;
</span><span>    mat
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#abb0b6;font-style:italic>/// Constructs a right-handed orthonormal basis with translation...
</span><span style=color:#abb0b6;font-style:italic>/// This is a version of [`orthonormalize`] which also includes translation.
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>spot_light_world_from_view</span><span>(</span><span style=color:#ff8f40>transform</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>GlobalTransform) </span><span style=color:#61676ccc>-></span><span> Mat4 {
</span><span>    </span><span style=color:#fa6e32>let</span><span> basis </span><span style=color:#ed9366>= </span><span style=color:#f07171>orthonormalize</span><span>(fwd_dir)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> mat </span><span style=color:#ed9366>= </span><span>Mat4</span><span style=color:#ed9366>::</span><span>from_mat3(basis)</span><span style=color:#61676ccc>;
</span><span>    mat</span><span style=color:#ed9366>.</span><span>w_axis </span><span style=color:#ed9366>=</span><span> transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>translation</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend</span><span>(</span><span style=color:#ff8f40>1.0</span><span>)</span><span style=color:#61676ccc>;
</span><span>    mat
</span><span>}
</span></code></pre><p>The explicit handedness flip (<code>mat.x_axis = -mat.x_axis</code>) was removed, and comments updated to reflect the right-handed basis.<h3 id=2-crates-bevy-pbr-src-render-shadows-wgsl-1-16>2. <code>crates/bevy_pbr/src/render/shadows.wgsl</code> (+1/-16)</h3><p><strong>Purpose:</strong> Remove equivalent handedness flip from shader code<br> <strong>Key Changes:</strong><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>fn spot_light_world_from_view(z_basis: vec3&LTf32>) -> mat3x3&LTf32> {
</span><span>    var basis = orthonormalize(z_basis);
</span><span>    basis[0] = -basis[0];
</span><span>    return basis;
</span><span>}
</span><span>
</span><span>// After: (Function completely removed)
</span><span>
</span><span>// Usage in fetch_spot_shadow:
</span><span>// Before:
</span><span>let light_inv_rot = spot_light_world_from_view(fwd);
</span><span>
</span><span>// After:
</span><span>let light_inv_rot = orthonormalize(fwd);
</span></code></pre><p>The custom basis function with flip was removed entirely, replaced by direct use of the standard orthonormalize function.<h3 id=3-crates-bevy-render-src-maths-wgsl-2-0>3. <code>crates/bevy_render/src/maths.wgsl</code> (+2/-0)</h3><p><strong>Purpose:</strong> Add comment emphasizing implementation consistency<br> <strong>Key Changes:</strong><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Added comment:
</span><span>// the construction of the orthonormal basis up and right vectors here needs to precisely match the rust
</span><span>// implementation in bevy_light/spot_light.rs:spot_light_world_from_view
</span><span>fn orthonormalize(z_basis: vec3&LTf32>) -> mat3x3&LTf32> {
</span><span>    // ... existing implementation ...
</span><span>}
</span></code></pre><p>This comment reinforces the critical need for identical implementations between Rust and WGSL code.<h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://jcgt.org/published/0006/01/01/paper.pdf target=_blank>Building an Orthonormal Basis, Revisited (JCGT Paper)</a> - The basis construction algorithm<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/pull/20191 target=_blank>Original Regression PR #20191</a> - Changes that introduced the visual artifact<li><a href="https://pixel-eagle.com/project/b25a040a-a980-4602-b90c-d480ab84076d/run/11500/compare/11494?screenshot=3D+Rendering/lighting.png" rel="noopener nofollow noreferrer" target=_blank>Visual Comparison of Regression</a> - Shows the green line artifact<li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Right-hand_rule#Coordinates target=_blank>Coordinate System Handedness in Computer Graphics</a> - Fundamentals of coordinate systems</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-07/pr_20272.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>