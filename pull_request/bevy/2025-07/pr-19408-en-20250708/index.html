<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19408 Clean up several miscellaneous uses of `weak_handle`.
        
    </title><meta content="#19408 Clean up several miscellaneous uses of `weak_handle`." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-07/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-07-08</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-07/pr-19408-zh-cn-20250708>中文</a></div></div><div class=pr-content><h3 id=clean-up-weak-handle-usage-in-rendering-pipelines>Clean Up Weak Handle Usage in Rendering Pipelines</h3><h4 id=basic-information>Basic Information</h4><ul><li><strong>Title</strong>: Clean up several miscellaneous uses of <code>weak_handle</code>.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19408<li><strong>Author</strong>: andriyDev<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, A-Assets, S-Ready-For-Final-Review, D-Modest<li><strong>Created</strong>: 2025-05-28T07:36:06Z<li><strong>Merged</strong>: 2025-07-08T07:05:24Z<li><strong>Merged By</strong>: superdump</ul><h4 id=description-translation>Description Translation</h4><p>The original description is in English, so it’s included as-is:<pre style=color:#61676c;background-color:#fafafa><code><span># Objective
</span><span>
</span><span>- Related to #19024.
</span><span>
</span><span>## Solution
</span><span>
</span><span>- This is a mix of several ways to get rid of weak handles. The primary strategy is putting strong asset handles in resources that the rendering code clones into its pipelines (or whatever).
</span><span>- This does not handle every remaining case, but we are slowly clearing them out.
</span><span>
</span><span>## Testing
</span><span>
</span><span>- `anti_aliasing` example still works.
</span><span>- `fog_volumes` example still works.
</span></code></pre><hr><h3 id=the-story-of-this-pull-request>The Story of This Pull Request</h3><h4 id=the-problem-and-context>The Problem and Context</h4><p>Bevy’s rendering pipelines previously used <code>uuid_handle</code> to create weak handles for assets like shaders, lookup textures, and meshes. These weak handles only contained UUIDs without guaranteeing asset availability, which could cause runtime failures if assets weren’t properly loaded. This approach conflicted with Bevy’s asset management system, where strong handles ensure assets are loaded and managed correctly. The goal was to replace these weak handles with strong handles stored in resources for reliability and consistency.<h4 id=the-solution-approach>The Solution Approach</h4><p>The primary strategy involved:<ol><li>Replacing <code>uuid_handle</code> constants with resources storing strong handles<li>Loading assets via <code>load_embedded_asset</code> during app initialization<li>Accessing handles through resources in rendering systems This ensures assets are properly tracked by Bevy’s asset system. Alternatives like global handles were considered but rejected in favor of resource-based storage for better encapsulation and compatibility with Bevy’s ECS architecture.</ol><h4 id=the-implementation>The Implementation</h4><p>Changes were made across multiple rendering modules:<p><strong>SMAA Anti-Aliasing</strong><br> Replaced hardcoded LUT handles with a resource:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Weak handles
</span><span style=color:#fa6e32>const </span><span style=color:#ff8f40>SMAA_AREA_LUT_TEXTURE_HANDLE</span><span style=color:#61676ccc>: </span><span>Handle&LTImage> </span><span style=color:#ed9366>= 
</span><span>    </span><span style=color:#f07171>uuid_handle!</span><span>(</span><span style=color:#86b300>"569c4d67-c7fa-4958-b1af-0836023603c0"</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Resource with strong handles
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Resource)]
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>SmaaLuts </span><span>{
</span><span>    area_lut</span><span style=color:#61676ccc>: </span><span>Handle&LTImage>,
</span><span>    search_lut</span><span style=color:#61676ccc>: </span><span>Handle&LTImage>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Initialization
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"smaa_luts"</span><span>)]
</span><span style=color:#fa6e32>let</span><span> smaa_luts </span><span style=color:#ed9366>=</span><span> SmaaLuts {
</span><span>    area_lut</span><span style=color:#61676ccc>: </span><span style=color:#f07171>load_embedded_asset!</span><span>(app</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"SMAAAreaLUT.ktx2"</span><span>)</span><span style=color:#61676ccc>,
</span><span>    search_lut</span><span style=color:#61676ccc>: </span><span style=color:#f07171>load_embedded_asset!</span><span>(app</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"SMAASearchLUT.ktx2"</span><span>)</span><span style=color:#61676ccc>,
</span><span>}</span><span style=color:#61676ccc>;
</span></code></pre><p><strong>Mip Generation</strong><br> Converted shader handle to a resource:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Global weak handle
</span><span style=color:#fa6e32>pub const </span><span style=color:#ff8f40>DOWNSAMPLE_DEPTH_SHADER_HANDLE</span><span style=color:#61676ccc>: </span><span>Handle&LTShader> </span><span style=color:#ed9366>= 
</span><span>    </span><span style=color:#f07171>uuid_handle!</span><span>(</span><span style=color:#86b300>"a09a149e-5922-4fa4-9170-3c1a13065364"</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Resource-based handle
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Resource</span><span style=color:#61676ccc>,</span><span> Deref)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>DownsampleDepthShader</span><span>(Handle&LTShader>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Pipeline now stores shader handle
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>DownsampleDepthPipeline </span><span>{
</span><span>    shader</span><span style=color:#61676ccc>: </span><span>Handle&LTShader>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>}
</span></code></pre><p><strong>Chromatic Aberration</strong><br> Made LUT optional with fallback to default:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Required handle
</span><span style=color:#fa6e32>pub</span><span> color_lut</span><span style=color:#61676ccc>: </span><span>Handle&LTImage></span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Optional with resource fallback
</span><span style=color:#fa6e32>pub</span><span> color_lut</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTHandle&LTImage>></span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Usage in rendering
</span><span style=color:#fa6e32>let</span><span> default_lut </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span>resource</span><span style=color:#ed9366>::</span><span>&LTDefaultChromaticAberrationLut>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> handle </span><span style=color:#ed9366>=</span><span> chromatic_aberration</span><span style=color:#ed9366>.</span><span>color_lut</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_ref</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_or</span><span>(</span><span style=color:#ed9366>&</span><span>default_lut</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><p><strong>Volumetric Fog</strong><br> Replaced global mesh handles with a resource:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Global weak handles
</span><span style=color:#fa6e32>pub const </span><span style=color:#ff8f40>PLANE_MESH</span><span style=color:#61676ccc>: </span><span>Handle&LTMesh> </span><span style=color:#ed9366>= 
</span><span>    </span><span style=color:#f07171>uuid_handle!</span><span>(</span><span style=color:#86b300>"92523617-c708-4fd0-b42f-ceb4300c930b"</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Resource storage
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Resource)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>FogAssets </span><span>{
</span><span>    plane_mesh</span><span style=color:#61676ccc>: </span><span>Handle&LTMesh>,
</span><span>    cube_mesh</span><span style=color:#61676ccc>: </span><span>Handle&LTMesh>,
</span><span>}
</span></code></pre><p><strong>Mesh2D Example</strong><br> Updated custom pipeline to use resource-stored shader:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Global shader handle
</span><span style=color:#fa6e32>pub const </span><span style=color:#ff8f40>COLORED_MESH2D_SHADER_HANDLE</span><span style=color:#61676ccc>: </span><span>Handle&LTShader> </span><span style=color:#ed9366>= 
</span><span>    </span><span style=color:#f07171>uuid_handle!</span><span>(</span><span style=color:#86b300>"f48b148f-7373-4638-9900-392b3b3ccc66"</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Resource-managed handle
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Resource)]
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>ColoredMesh2dShader</span><span>(Handle&LTShader>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>ColoredMesh2dPipeline </span><span>{
</span><span>    shader</span><span style=color:#61676ccc>: </span><span>Handle&LTShader>, 
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>}
</span></code></pre><h4 id=technical-insights>Technical Insights</h4><p>Key technical aspects:<ol><li><strong>Resource-Based Handles</strong>: Assets are now loaded during app setup and stored in resources, ensuring they exist when rendering systems execute<li><strong>Fallback Patterns</strong>: Optional handles (e.g., chromatic aberration LUT) with default resources simplify API usage<li><strong>Asset Loading</strong>: <code>load_embedded_asset</code> replaces manual buffer loading, leveraging Bevy’s asset system<li><strong>Pipeline Specialization</strong>: Pipelines now reference shader handles directly from resources instead of global constants</ol><p>Performance impact is neutral - handle resolution is similar, but with stronger guarantees of asset availability. This pattern also enables future optimizations like asset hot-reloading.<h4 id=the-impact>The Impact</h4><ul><li><strong>Reliability</strong>: Eliminates runtime failures from missing assets<li><strong>Consistency</strong>: Unifies asset handling across rendering pipelines<li><strong>Maintainability</strong>: Resources clearly define asset dependencies<li><strong>Flexibility</strong>: Optional handles allow customization without boilerplate<li><strong>Testing</strong>: Verified working with <code>anti_aliasing</code> and <code>fog_volumes</code> examples</ul><p>The changes demonstrate Bevy’s best practices for asset handling, showing how to safely manage GPU resources within the ECS paradigm. Future work can extend this pattern to remaining weak handle uses.<hr><h3 id=visual-representation>Visual Representation</h3><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[App Initialization] --> B[Load Embedded Assets]
</span><span>    B --> C[Store Handles in Resources]
</span><span>    C --> D[Rendering Systems]
</span><span>    D --> E[Access Resources for Handles]
</span><span>    E --> F[Render Pipelines]
</span></code></pre><hr><h3 id=key-files-changed>Key Files Changed</h3><h4 id=crates-bevy-anti-aliasing-src-smaa-mod-rs-31-53>crates/bevy_anti_aliasing/src/smaa/mod.rs (+31/-53)</h4><p>Replaced weak LUT handles with resource-managed handles:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Weak handles
</span><span style=color:#fa6e32>const </span><span style=color:#ff8f40>SMAA_AREA_LUT_TEXTURE_HANDLE</span><span style=color:#61676ccc>: </span><span>Handle&LTImage> </span><span style=color:#ed9366>= ...</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>const </span><span style=color:#ff8f40>SMAA_SEARCH_LUT_TEXTURE_HANDLE</span><span style=color:#61676ccc>: </span><span>Handle&LTImage> </span><span style=color:#ed9366>= ...</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Resource storage
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Resource)]
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>SmaaLuts </span><span>{
</span><span>    area_lut</span><span style=color:#61676ccc>: </span><span>Handle&LTImage>,
</span><span>    search_lut</span><span style=color:#61676ccc>: </span><span>Handle&LTImage>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Usage in system
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>prepare_smaa_bind_groups</span><span>(
</span><span>    </span><span style=color:#ff8f40>smaa_luts</span><span style=color:#61676ccc>: </span><span>Res&LTSmaaLuts>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>) {
</span><span>    images</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#ed9366>&</span><span>smaa_luts</span><span style=color:#ed9366>.</span><span>search_lut)</span><span style=color:#61676ccc>,
</span><span>    images</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#ed9366>&</span><span>smaa_luts</span><span style=color:#ed9366>.</span><span>area_lut)</span><span style=color:#61676ccc>,
</span><span>}
</span></code></pre><h4 id=crates-bevy-core-pipeline-src-experimental-mip-generation-mod-rs-31-16>crates/bevy_core_pipeline/src/experimental/mip_generation/mod.rs (+31/-16)</h4><p>Converted shader handle to resource:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Global weak handle
</span><span style=color:#fa6e32>pub const </span><span style=color:#ff8f40>DOWNSAMPLE_DEPTH_SHADER_HANDLE</span><span style=color:#61676ccc>: </span><span>Handle&LTShader> </span><span style=color:#ed9366>= ...</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Resource-based handle
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Resource</span><span style=color:#61676ccc>,</span><span> Deref)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>DownsampleDepthShader</span><span>(Handle&LTShader>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Pipeline initialization
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>create_downsample_depth_pipelines</span><span>(
</span><span>    </span><span style=color:#ff8f40>downsample_depth_shader</span><span style=color:#61676ccc>: </span><span>Res&LTDownsampleDepthShader>,
</span><span>) {
</span><span>    DownsampleDepthPipeline</span><span style=color:#ed9366>::</span><span>new(
</span><span>        layout</span><span style=color:#61676ccc>, 
</span><span>        downsample_depth_shader</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0.</span><span style=color:#f07171>clone</span><span>()
</span><span>    )
</span><span>}
</span></code></pre><h4 id=crates-bevy-core-pipeline-src-post-process-mod-rs-29-30>crates/bevy_core_pipeline/src/post_process/mod.rs (+29/-30)</h4><p>Made chromatic aberration LUT optional:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Required handle
</span><span style=color:#fa6e32>pub</span><span> color_lut</span><span style=color:#61676ccc>: </span><span>Handle&LTImage></span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Optional with default
</span><span style=color:#fa6e32>pub</span><span> color_lut</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTHandle&LTImage>></span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Resource for default LUT
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Resource)]
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>DefaultChromaticAberrationLut</span><span>(Handle&LTImage>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Fallback logic
</span><span style=color:#fa6e32>let</span><span> default_lut </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span>resource</span><span style=color:#ed9366>::</span><span>&LTDefaultChromaticAberrationLut>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> lut </span><span style=color:#ed9366>=</span><span> chromatic_aberration</span><span style=color:#ed9366>.</span><span>color_lut</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_ref</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_or</span><span>(</span><span style=color:#ed9366>&</span><span>default_lut</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><h4 id=crates-bevy-pbr-src-volumetric-fog-render-rs-8-18>crates/bevy_pbr/src/volumetric_fog/render.rs (+8/-18)</h4><p>Replaced global mesh handles with resource:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Global weak handles
</span><span style=color:#fa6e32>pub const </span><span style=color:#ff8f40>PLANE_MESH</span><span style=color:#61676ccc>: </span><span>Handle&LTMesh> </span><span style=color:#ed9366>= ...</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>pub const </span><span style=color:#ff8f40>CUBE_MESH</span><span style=color:#61676ccc>: </span><span>Handle&LTMesh> </span><span style=color:#ed9366>= ...</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Resource storage
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Resource)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>FogAssets </span><span>{
</span><span>    plane_mesh</span><span style=color:#61676ccc>: </span><span>Handle&LTMesh>,
</span><span>    cube_mesh</span><span style=color:#61676ccc>: </span><span>Handle&LTMesh>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Usage
</span><span style=color:#fa6e32>let</span><span> fog_assets </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span>resource</span><span style=color:#ed9366>::</span><span>&LTFogAssets>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> mesh_handle </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>if</span><span> exterior {
</span><span>    fog_assets</span><span style=color:#ed9366>.</span><span>cube_mesh</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()
</span><span>} </span><span style=color:#fa6e32>else </span><span>{
</span><span>    fog_assets</span><span style=color:#ed9366>.</span><span>plane_mesh</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()
</span><span>}</span><span style=color:#61676ccc>;
</span></code></pre><h4 id=examples-2d-mesh2d-manual-rs-15-10>examples/2d/mesh2d_manual.rs (+15/-10)</h4><p>Updated custom pipeline to use resource-stored shader:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Global weak handle
</span><span style=color:#fa6e32>pub const </span><span style=color:#ff8f40>COLORED_MESH2D_SHADER_HANDLE</span><span style=color:#61676ccc>: </span><span>Handle&LTShader> </span><span style=color:#ed9366>= ...</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Resource-managed handle
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Resource)]
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>ColoredMesh2dShader</span><span>(Handle&LTShader>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>ColoredMesh2dPipeline </span><span>{
</span><span>    shader</span><span style=color:#61676ccc>: </span><span>Handle&LTShader>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Pipeline setup
</span><span style=color:#fa6e32>impl </span><span>SpecializedRenderPipeline </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>ColoredMesh2dPipeline </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>specialize</span><span>(...) </span><span style=color:#61676ccc>-></span><span> RenderPipelineDescriptor {
</span><span>        vertex</span><span style=color:#61676ccc>:</span><span> VertexState {
</span><span>            shader</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>shader</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#61676ccc>,
</span><span>            </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre><hr><h3 id=further-reading>Further Reading</h3><ol><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_asset/latest/bevy_asset/ target=_blank>Bevy Asset System Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/features/assets.html target=_blank>Handling Assets in ECS</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/docs/plugins_guidelines.md#render-pipelines target=_blank>Render Pipeline Specialization</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/pull/19024 target=_blank>PR #19024: Remove Weak Handles</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-07/pr_19408.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>