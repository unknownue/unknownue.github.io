<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20052 Refactoring Orthonormal Basis Construction for Shadow Cubemap Sampling
        
    </title><meta content="#20052 Refactoring Orthonormal Basis Construction for Shadow Cubemap Sampling" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-07/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-07-11</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-07/pr-20052-zh-cn-20250711>中文</a></div></div><div class=pr-content><h2 id=title-refactoring-orthonormal-basis-construction-for-shadow-cubemap-sampling>Title: Refactoring Orthonormal Basis Construction for Shadow Cubemap Sampling</h2><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Factor out up-choice in shadow cubemap sampling orthonormalize<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20052<li><strong>Author</strong>: atlv24<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, D-Trivial, A-Rendering, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-07-09T04:39:29Z<li><strong>Merged</strong>: 2025-07-11T12:38:54Z<li><strong>Merged By</strong>: superdump</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Another step towards unifying our orthonormal basis construction #20050<li>Preserve behavior but fix a bug. Unification will be a followup after these two PRs and will need more thorough testing.</ul><h2 id=solution>Solution</h2><ul><li>Make shadow cubemap sampling orthonormalize have the same function signature as the other orthonormal basis functions in bevy</ul><h2 id=testing>Testing</h2><ul><li>3d_scene + lighting examples</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The PR addresses duplicated logic in shadow cubemap sampling functions that handled degenerate cases during orthonormal basis construction. Three functions in <code>shadow_sampling.wgsl</code> (<code>sample_shadow_cubemap_gaussian</code>, <code>sample_shadow_cubemap_jittered</code>, and <code>search_for_blockers_in_shadow_cubemap</code>) each contained identical code for selecting an appropriate “up” vector when creating an orthonormal basis. This redundant implementation violated DRY principles and differed from the centralized <code>orthonormalize</code> function in <code>maths.wgsl</code>.<p>The core issue was that these shadow sampling functions manually handled the degenerate case where the light direction was nearly parallel to the default up vector (0,1,0). When the dot product between these vectors exceeded 0.99, they switched to an alternative up vector (1,0,0) to prevent basis degeneracy. This logic was copy-pasted across multiple locations.<p>The solution refactors this degenerate case handling into the existing <code>orthonormalize</code> function. Previously, <code>orthonormalize</code> required two parameters: an unnormalized Z vector and an up vector. The modified version simplifies the signature to accept only a normalized Z vector while encapsulating the up-vector selection logic internally. This change:<ol><li>Centralizes the degenerate case handling<li>Eliminates duplicate code in shadow sampling functions<li>Maintains identical runtime behavior<li>Prepares for future basis unification work (#20050)</ol><p>The implementation modifies <code>orthonormalize</code> to internally choose an appropriate up vector when the default (0,1,0) is too close to the Z-axis. The basis construction now follows:<ol><li>Start with default up vector (0,1,0)<li>Check dot product against normalized Z vector<li>Switch to (1,0,0) if |dot product| > 0.99<li>Compute X basis via cross(Z, up)<li>Compute Y basis via cross(Z, X)</ol><p>This approach ensures the resulting basis remains orthonormal even when the Z vector aligns with world-up. The shadow sampling functions now simply call <code>orthonormalize(normalize(light_local))</code> instead of replicating the up-vector selection.<p>Testing confirmed identical rendering output in the 3d_scene and lighting examples, validating that the refactor preserves behavior while eliminating redundancy. The changes also fix a subtle bug where the original implementation used <code>dot(up, normalize(light_local)) > 0.99</code> without absolute value, potentially missing near-negative alignments.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[shadow_sampling.wgsl] -->|calls| B[orthonormalize]
</span><span>    C[maths.wgsl] -->|implements| B
</span><span>    B --> D[Handle degenerate case]
</span><span>    D --> E[Construct orthonormal basis]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-pbr-src-render-shadow-sampling-wgsl>crates/bevy_pbr/src/render/shadow_sampling.wgsl</h3><p><strong>Changes:</strong> Removed duplicate up-vector selection logic from three shadow sampling functions <strong>Why:</strong> To centralize basis construction in <code>orthonormalize</code> and eliminate code duplication <strong>Relation to PR:</strong> Implements the consumer side of the unified basis API<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>var up = vec3(0.0, 1.0, 0.0);
</span><span>if (dot(up, normalize(light_local)) > 0.99) {
</span><span>    up = vec3(1.0, 0.0, 0.0);   // Avoid creating a degenerate basis.
</span><span>}
</span><span>let basis = orthonormalize(light_local, up) * scale * distance_to_light;
</span><span>
</span><span>// After:
</span><span>let basis = orthonormalize(normalize(light_local)) * scale * distance_to_light;
</span></code></pre><h3 id=crates-bevy-render-src-maths-wgsl>crates/bevy_render/src/maths.wgsl</h3><p><strong>Changes:</strong> Refactored orthonormalize to handle up-vector selection internally <strong>Why:</strong> To create a unified basis construction API that automatically handles degenerate cases <strong>Relation to PR:</strong> Provides the centralized implementation for orthonormal basis construction<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>fn orthonormalize(z_unnormalized: vec3&LTf32>, up: vec3&LTf32>) -> mat3x3&LTf32> {
</span><span>    let z_basis = normalize(z_unnormalized);
</span><span>    let x_basis = normalize(cross(z_basis, up));
</span><span>    let y_basis = cross(z_basis, x_basis);
</span><span>    return mat3x3(x_basis, y_basis, z_basis);
</span><span>}
</span><span>
</span><span>// After:
</span><span>fn orthonormalize(z_normalized: vec3&LTf32>) -> mat3x3&LTf32> {
</span><span>    var up = vec3(0.0, 1.0, 0.0);
</span><span>    if (abs(dot(up, z_normalized)) > 0.99) {
</span><span>        up = vec3(1.0, 0.0, 0.0); // Avoid creating a degenerate basis.
</span><span>    }
</span><span>    let x_basis = normalize(cross(z_normalized, up));
</span><span>    let y_basis = cross(z_normalized, x_basis);
</span><span>    return mat3x3(x_basis, y_basis, z_normalized);
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://math.stackexchange.com/a/1849294 target=_blank>Gram-Schmidt Orthonormalization Process</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/getting-started/rendering/ target=_blank>Bevy Rendering Architecture</a><li><a rel="noopener nofollow noreferrer" href=https://www.w3.org/TR/WGSL/ target=_blank>WGSL Language Specification</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-07/pr_20052.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>