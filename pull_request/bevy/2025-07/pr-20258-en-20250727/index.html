<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20258 Fix observers' access to relationship data during `despawn_related`
        
    </title><meta content="#20258 Fix observers' access to relationship data during `despawn_related`" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-07/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-07-27</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-07/pr-20258-zh-cn-20250727>中文</a></div></div><div class=pr-content><h2 id=technical-analysis-pr-20258-fix-observers-access-to-relationship-data-during-despawn-related>Technical Analysis: PR #20258 - Fix observers’ access to relationship data during <code>despawn_related</code></h2><h3 id=basic-information>Basic Information</h3><ul><li><strong>Title</strong>: Fix observers’ access to relationship data during <code>despawn_related</code><li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20258<li><strong>Author</strong>: muddxyii<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-ECS, S-Ready-For-Final-Review, X-Uncontroversial, D-Straightforward<li><strong>Created</strong>: 2025-07-23T03:09:48Z<li><strong>Merged</strong>: 2025-07-27T17:23:45Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h3 id=description-translation>Description Translation</h3><h1 id=objective>Objective</h1><ul><li>Fix issue where observers cannot access relationship data during <code>despawn_related</code><li>Fixes #20106</ul><h2 id=solution>Solution</h2><ul><li>Changed <code>despawn_related</code> to use <code>get()</code> instead of <code>take()</code> to preserve relationship components during the despawn process<li>Collect entities into a vector before despawning to ensure the relationship data remains accessible to observers and hooks</ul><h2 id=testing>Testing</h2><ul><li>Added test <code>despawn_related_observers_can_access_relationship_data</code> that reproduces the issue scenario</ul><h3 id=the-story-of-this-pull-request>The Story of This Pull Request</h3><h4 id=the-problem-and-context>The Problem and Context</h4><p>The <code>despawn_related</code> method in Bevy’s ECS had a subtle bug affecting observers. When despawning child entities of a parent, the method used <code>take()</code> to remove the <code>Children</code> component from the parent entity before despawning the children. This premature removal prevented observers from accessing relationship data during despawn operations, as the component containing the relationship information was no longer present. This violated the expectation that relationship data should remain accessible throughout entity lifecycle events, particularly for systems like observers that rely on this data for correct operation.<p>The issue manifested in scenarios where observers needed to inspect parent-child relationships during child despawning. Since the parent’s <code>Children</code> component was removed first, any observer logic requiring access to relationship data would fail or behave unexpectedly, breaking legitimate use cases that depended on this information.<h4 id=the-solution-approach>The Solution Approach</h4><p>The core fix involves modifying how we access the relationship component during despawn operations. Instead of removing the component with <code>take()</code>, we now access it immutably with <code>get()</code>, leaving it intact during the despawn process. This preserves the relationship data for any observers that might be triggered during child despawning.<p>A key insight was recognizing that we need to decouple the data access from the despawning operation. By collecting the child entities into a separate vector before despawning, we ensure:<ol><li>Relationship data remains accessible throughout the operation<li>We avoid mutating the relationship component while iterating<li>Observers can reliably access relationship data in their hooks</ol><p>This approach maintains the original functionality while fixing the observer access issue. No alternatives were seriously considered since this solution directly addresses the root cause with minimal overhead.<h4 id=the-implementation>The Implementation</h4><p>The implementation modifies the <code>despawn_related</code> method to preserve relationship data during despawn operations:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(sources) </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>take</span><span style=color:#ed9366>::</span><span>&LTS>() {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>world_scope</span><span>(|</span><span style=color:#ff8f40>world</span><span>| {
</span><span>        </span><span style=color:#fa6e32>for</span><span> entity </span><span style=color:#ed9366>in</span><span> sources</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>() {
</span><span>            </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(entity_mut) </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_entity_mut</span><span>(entity) {
</span><span>                entity_mut</span><span style=color:#ed9366>.</span><span style=color:#f07171>despawn</span><span>()</span><span style=color:#61676ccc>;
</span><span>            }
</span><span>        }
</span><span>    })</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(sources) </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>get</span><span style=color:#ed9366>::</span><span>&LTS>() {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Collect to defer removal, preserving data for observers
</span><span>    </span><span style=color:#fa6e32>let</span><span> sources </span><span style=color:#ed9366>=</span><span> sources</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>()</span><span style=color:#ed9366>.</span><span>collect</span><span style=color:#ed9366>::</span><span><</span><span style=color:#55b4d4;font-style:italic>Vec</span><span><</span><span style=color:#ed9366>_</span><span>>>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>world_scope</span><span>(|</span><span style=color:#ff8f40>world</span><span>| {
</span><span>        </span><span style=color:#fa6e32>for</span><span> entity </span><span style=color:#ed9366>in</span><span> sources {
</span><span>            </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(entity_mut) </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_entity_mut</span><span>(entity) {
</span><span>                entity_mut</span><span style=color:#ed9366>.</span><span style=color:#f07171>despawn</span><span>()</span><span style=color:#61676ccc>;
</span><span>            }</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>    })</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>The critical changes are:<ol><li>Replaced <code>take()</code> with <code>get()</code> to avoid removing the relationship component<li>Added collection of child entities into a vector before despawning<li>Maintained the scoped despawning logic within <code>world_scope</code></ol><p>The solution effectively defers component removal while maintaining the despawning behavior. By collecting the entities first, we avoid mutating the relationship component during iteration while ensuring all child entities are correctly processed.<h4 id=verification-through-testing>Verification Through Testing</h4><p>A new test was added to verify the fix and prevent regressions. The test creates a parent-child relationship with an observer that checks for the existence of relationship data during despawn:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>despawn_related_observers_can_access_relationship_data</span><span>() {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... (setup code)
</span><span>    world</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_observer</span><span>(
</span><span>        </span><span style=color:#fa6e32>move </span><span style=color:#ed9366>|</span><span>trigger</span><span style=color:#61676ccc>: </span><span>On&LTReplace, MyComponent></span><span style=color:#61676ccc>,
</span><span>              has_relationship</span><span style=color:#61676ccc>: </span><span>Query&LTHas&LTChildOf>></span><span style=color:#61676ccc>,
</span><span>              </span><span style=color:#fa6e32>mut</span><span> results</span><span style=color:#61676ccc>: </span><span>Query<</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> ObserverResult></span><span style=color:#ed9366>| </span><span>{
</span><span>            </span><span style=color:#fa6e32>let</span><span> entity </span><span style=color:#ed9366>=</span><span> trigger</span><span style=color:#ed9366>.</span><span style=color:#f07171>target</span><span>()</span><span style=color:#61676ccc>;
</span><span>            </span><span style=color:#fa6e32>if</span><span> has_relationship</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(entity)</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_or</span><span>(</span><span style=color:#ff8f40>false</span><span>) {
</span><span>                results</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_mut</span><span>(result_entity)</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#ed9366>.</span><span>success </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>true</span><span style=color:#61676ccc>;
</span><span>            }
</span><span>        }</span><span style=color:#61676ccc>,
</span><span>    )</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#fa6e32>let</span><span> parent </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn_empty</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>id</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> _child </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((MyComponent</span><span style=color:#61676ccc>,</span><span> ChildOf(parent)))</span><span style=color:#ed9366>.</span><span style=color:#f07171>id</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span>    world</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity_mut</span><span>(parent)</span><span style=color:#ed9366>.</span><span>despawn_related</span><span style=color:#ed9366>::</span><span>&LTChildren>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#f07171>assert!</span><span>(world</span><span style=color:#ed9366>.</span><span>get</span><span style=color:#ed9366>::</span><span>&LTObserverResult>(result_entity)</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#ed9366>.</span><span>success)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>This test confirms that observers can successfully access relationship data (via <code>Has&LTChildOf></code>) during the despawn operation, which would fail without the fix.<h4 id=technical-insights>Technical Insights</h4><p>The solution demonstrates several important ECS patterns:<ol><li><strong>Lifecycle Timing</strong>: Components should remain valid throughout related operations<li><strong>Observer Safety</strong>: Data accessed by observers must outlive the operations triggering them<li><strong>Borrow Management</strong>: Collecting entities before mutation avoids simultaneous access and mutation</ol><p>The change has minimal performance impact since collecting entities into a vector is O(n) and the number of children is typically small. The memory overhead is negligible as we’re only storing entity IDs.<h4 id=the-impact>The Impact</h4><p>This fix resolves a subtle but important inconsistency in Bevy’s ECS relationship handling. Observers can now reliably access relationship data during despawn operations, enabling correct behavior for systems that:<ul><li>Clean up related resources<li>Maintain external indices<li>Implement dependency tracking<li>Enforce relationship invariants</ul><p>The change maintains backward compatibility while fixing a clear behavioral bug. The solution is localized to a single method with minimal risk of side effects.<h3 id=visual-representation>Visual Representation</h3><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    P[Parent Entity] -- Children --> C[Children Component]
</span><span>    C -- Contains --> E1[Child Entity 1]
</span><span>    C -- Contains --> E2[Child Entity 2]
</span><span>    E1 -- ChildOf --> P
</span><span>    E2 -- ChildOf --> P
</span><span>    
</span><span>    style C fill:#9f9,stroke:#333,stroke-width:2px
</span></code></pre><p>The diagram shows:<ul><li>Green: <code>Children</code> component preserved during despawn<li>Solid arrows: Relationships maintained during operation<li>Dashed arrows: Data access patterns during despawn</ul><h3 id=key-files-changed>Key Files Changed</h3><h4 id=crates-bevy-ecs-src-relationship-related-methods-rs><code>crates/bevy_ecs/src/relationship/related_methods.rs</code></h4><p><strong>Purpose</strong>: Fix observer access to relationship data during despawn operations<p><strong>Key Changes</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(sources) </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>take</span><span style=color:#ed9366>::</span><span>&LTS>() {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>world_scope</span><span>(|</span><span style=color:#ff8f40>world</span><span>| {
</span><span>        </span><span style=color:#fa6e32>for</span><span> entity </span><span style=color:#ed9366>in</span><span> sources</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>() {
</span><span>            </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(entity_mut) </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_entity_mut</span><span>(entity) {
</span><span>                entity_mut</span><span style=color:#ed9366>.</span><span style=color:#f07171>despawn</span><span>()</span><span style=color:#61676ccc>;
</span><span>            }
</span><span>        }
</span><span>    })</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(sources) </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>get</span><span style=color:#ed9366>::</span><span>&LTS>() {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// We have to collect here to defer removal, allowing observers and hooks to see this data
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// before it is finally removed.
</span><span>    </span><span style=color:#fa6e32>let</span><span> sources </span><span style=color:#ed9366>=</span><span> sources</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>()</span><span style=color:#ed9366>.</span><span>collect</span><span style=color:#ed9366>::</span><span><</span><span style=color:#55b4d4;font-style:italic>Vec</span><span><</span><span style=color:#ed9366>_</span><span>>>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>world_scope</span><span>(|</span><span style=color:#ff8f40>world</span><span>| {
</span><span>        </span><span style=color:#fa6e32>for</span><span> entity </span><span style=color:#ed9366>in</span><span> sources {
</span><span>            </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(entity_mut) </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_entity_mut</span><span>(entity) {
</span><span>                entity_mut</span><span style=color:#ed9366>.</span><span style=color:#f07171>despawn</span><span>()</span><span style=color:#61676ccc>;
</span><span>            }</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>    })</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p><strong>Added Test</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>despawn_related_observers_can_access_relationship_data</span><span>() {
</span><span>    </span><span style=color:#fa6e32>use crate</span><span style=color:#ed9366>::</span><span>lifecycle</span><span style=color:#ed9366>::</span><span>Replace</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>use crate</span><span style=color:#ed9366>::</span><span>observer</span><span style=color:#ed9366>::</span><span>On</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>use crate</span><span style=color:#ed9366>::</span><span>prelude</span><span style=color:#ed9366>::</span><span>Has</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>use crate</span><span style=color:#ed9366>::</span><span>system</span><span style=color:#ed9366>::</span><span>Query</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component)]
</span><span>    </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>MyComponent</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component</span><span style=color:#61676ccc>,</span><span> Default)]
</span><span>    </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>ObserverResult </span><span>{
</span><span>        success</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>bool</span><span>,
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> world </span><span style=color:#ed9366>= </span><span>World</span><span style=color:#ed9366>::</span><span>new()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> result_entity </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>(ObserverResult</span><span style=color:#ed9366>::</span><span>default())</span><span style=color:#ed9366>.</span><span style=color:#f07171>id</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span>    world</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_observer</span><span>(
</span><span>        </span><span style=color:#fa6e32>move </span><span style=color:#ed9366>|</span><span>trigger</span><span style=color:#61676ccc>: </span><span>On&LTReplace, MyComponent></span><span style=color:#61676ccc>,
</span><span>              has_relationship</span><span style=color:#61676ccc>: </span><span>Query&LTHas&LTChildOf>></span><span style=color:#61676ccc>,
</span><span>              </span><span style=color:#fa6e32>mut</span><span> results</span><span style=color:#61676ccc>: </span><span>Query<</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> ObserverResult></span><span style=color:#ed9366>| </span><span>{
</span><span>            </span><span style=color:#fa6e32>let</span><span> entity </span><span style=color:#ed9366>=</span><span> trigger</span><span style=color:#ed9366>.</span><span style=color:#f07171>target</span><span>()</span><span style=color:#61676ccc>;
</span><span>            </span><span style=color:#fa6e32>if</span><span> has_relationship</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(entity)</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_or</span><span>(</span><span style=color:#ff8f40>false</span><span>) {
</span><span>                results</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_mut</span><span>(result_entity)</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#ed9366>.</span><span>success </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>true</span><span style=color:#61676ccc>;
</span><span>            }
</span><span>        }</span><span style=color:#61676ccc>,
</span><span>    )</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#fa6e32>let</span><span> parent </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn_empty</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>id</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> _child </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((MyComponent</span><span style=color:#61676ccc>,</span><span> ChildOf(parent)))</span><span style=color:#ed9366>.</span><span style=color:#f07171>id</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span>    world</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity_mut</span><span>(parent)</span><span style=color:#ed9366>.</span><span>despawn_related</span><span style=color:#ed9366>::</span><span>&LTChildren>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#f07171>assert!</span><span>(world</span><span style=color:#ed9366>.</span><span>get</span><span style=color:#ed9366>::</span><span>&LTObserverResult>(result_entity)</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#ed9366>.</span><span>success)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=further-reading>Further Reading</h3><ol><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/ecs/relationships/ target=_blank>Bevy ECS Relationships Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://gameprogrammingpatterns.com/observer.html target=_blank>Observer Pattern in ECS Systems</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/SanderMertens/ecs-faq target=_blank>Entity Component System Best Practices</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/issues/20106 target=_blank>Original Issue #20106</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-07/pr_20258.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>