<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20234 Observer tests contain unnecessary calls to world.flush()
        
    </title><meta content="#20234 Observer tests contain unnecessary calls to world.flush()" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-07/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-07-22</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2025-07/pr-20234-en-20250722>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=observer-tests-contain-unnecessary-calls-to-world-flush>Observer tests contain unnecessary calls to world.flush()</h1><h2 id=ji-ben-xin-xi>基本信息</h2><ul><li><strong>标题</strong>: Observer tests contain unnecessary calls to world.flush()<li><strong>PR 链接</strong>: https://github.com/bevyengine/bevy/pull/20234<li><strong>作者</strong>: shirokoff<li><strong>状态</strong>: 已合并<li><strong>标签</strong>: A-ECS, C-Code-Quality, S-Ready-For-Final-Review<li><strong>创建时间</strong>: 2025-07-21T22:23:43Z<li><strong>合并时间</strong>: 2025-07-22T00:09:00Z<li><strong>合并者</strong>: alice-i-cecile</ul><h2 id=miao-shu-fan-yi>描述翻译</h2><h3 id=mu-biao>目标</h3><ul><li>清理 Observer 测试中不必要的 world.flush() 调用</ul><h2 id=ben-pr-de-ji-shu-fen-xi>本 PR 的技术分析</h2><p>在 Bevy 的 ECS 模块中，Observer 测试包含多个冗余的 <code>world.flush()</code> 调用。这些调用最初是为了解决 Observer 注册机制的特殊行为：当使用 <code>world.add_observer()</code> 注册观察者时，该方法返回 <code>WorldEntityMut</code> 类型，而该类型不会自动触发命令队列的刷新（flush）。开发者因此在测试中添加了显式的 <code>world.flush()</code> 调用，确保观察者能及时响应后续事件。<p>然而，进一步分析发现这些 flush 调用实际上是不必要的。测试中的后续操作（如 <code>entity.insert()</code> 或 <code>world.trigger()</code>）本身就会触发状态更新，使显式 flush 成为冗余操作。这些多余的调用增加了测试代码的噪音，可能误导开发者以为它们是必需的。<p>PR 的解决方案直接明了：系统性地删除所有测试中不必要的 <code>world.flush()</code> 调用。修改涉及多个测试用例，包括：<ol><li>组件添加/删除观察者测试<li>事件触发观察者测试<li>事件传播层次结构测试<li>观察者排序验证测试</ol><p>关键修改模式是在 Observer 注册后和事件触发前删除 flush 调用。例如在事件触发测试中：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 修改前：
</span><span>world</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_observer</span><span>(|</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>trigger</span><span style=color:#61676ccc>: </span><span>On&LTEventWithData>| trigger</span><span style=color:#ed9366>.</span><span style=color:#f07171>event_mut</span><span>()</span><span style=color:#ed9366>.</span><span>counter </span><span style=color:#ed9366>+= </span><span style=color:#ff8f40>1</span><span>)</span><span style=color:#61676ccc>;
</span><span>world</span><span style=color:#ed9366>.</span><span style=color:#f07171>flush</span><span>()</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// 不必要的调用
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 修改后：
</span><span>world</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_observer</span><span>(|</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>trigger</span><span style=color:#61676ccc>: </span><span>On&LTEventWithData>| trigger</span><span style=color:#ed9366>.</span><span style=color:#f07171>event_mut</span><span>()</span><span style=color:#ed9366>.</span><span>counter </span><span style=color:#ed9366>+= </span><span style=color:#ff8f40>1</span><span>)</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// flush 调用已删除
</span></code></pre><p>特别值得注意的是删除了带有 TODO 注释的 flush 调用，这些注释原本解释为何需要临时添加 flush：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 删除的代码片段：
</span><span style=color:#abb0b6;font-style:italic>// TODO: ideally this flush is not necessary, but right now observe() returns WorldEntityMut
</span><span style=color:#abb0b6;font-style:italic>// and therefore does not automatically flush.
</span><span>world</span><span style=color:#ed9366>.</span><span style=color:#f07171>flush</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><p>这些删除证实了最初的疑虑——这些 flush 确实只是临时方案而非必需。<p>修改后所有测试保持通过，证明：<ol><li>Observer 注册机制在无显式 flush 时仍能正常工作<li>事件触发和组件变更操作隐式处理了状态同步<li>测试逻辑不依赖这些中间 flush 操作</ol><p>技术层面需注意两点：<ol><li><code>WorldEntityMut</code> 的刷新行为：其不自动 flush 的特性仍需注意<li>测试隔离性：每个测试使用独立 World 实例，删除 flush 不影响其他测试</ol><h2 id=ke-shi-hua-guan-xi>可视化关系</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Observer 测试] --> B[world.add_observer()]
</span><span>    B --> C[world.flush() 调用]
</span><span>    C --> D{是否必要？}
</span><span>    D -->|否| E[删除冗余调用]
</span><span>    D -->|是| F[保留]
</span><span>    E --> G[验证测试通过]
</span></code></pre><h2 id=guan-jian-wen-jian-bian-geng>关键文件变更</h2><h3 id=crates-bevy-ecs-src-observer-mod-rs><code>crates/bevy_ecs/src/observer/mod.rs</code></h3><p><strong>变更描述</strong>：删除测试模块中所有不必要的 <code>world.flush()</code> 调用，清理冗余代码<p><strong>代码片段示例</strong>：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 修改前：
</span><span>world</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_observer</span><span>(|_: On<</span><span style=color:#ff8f40>Remove</span><span style=color:#61676ccc>,</span><span> A></span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>res</span><span style=color:#61676ccc>: </span><span>ResMut&LTOrder>| res</span><span style=color:#ed9366>.</span><span style=color:#f07171>observed</span><span>(</span><span style=color:#86b300>"remove"</span><span>))</span><span style=color:#61676ccc>;
</span><span>world</span><span style=color:#ed9366>.</span><span style=color:#f07171>flush</span><span>()</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// 不必要的调用
</span><span>
</span><span style=color:#fa6e32>let mut</span><span> entity </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity_mut</span><span>(entity)</span><span style=color:#61676ccc>;
</span><span>entity</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(A)</span><span style=color:#61676ccc>;
</span><span>entity</span><span style=color:#ed9366>.</span><span style=color:#f07171>flush</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 修改后：
</span><span>world</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_observer</span><span>(|_: On<</span><span style=color:#ff8f40>Remove</span><span style=color:#61676ccc>,</span><span> A></span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>res</span><span style=color:#61676ccc>: </span><span>ResMut&LTOrder>| res</span><span style=color:#ed9366>.</span><span style=color:#f07171>observed</span><span>(</span><span style=color:#86b300>"remove"</span><span>))</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>let mut</span><span> entity </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity_mut</span><span>(entity)</span><span style=color:#61676ccc>;
</span><span>entity</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(A)</span><span style=color:#61676ccc>;
</span><span>entity</span><span style=color:#ed9366>.</span><span style=color:#f07171>flush</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><p><strong>影响范围</strong>：共修改 73 处删除，8 处添加，主要涉及：<ul><li>组件变更观察者测试<li>事件触发机制测试<li>层级传播测试<li>观察者排序验证</ul><h2 id=jin-yi-bu-yue-du>进一步阅读</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_ecs/latest/bevy_ecs/observer/index.html target=_blank>Bevy ECS 观察者文档</a><li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/programming/commands.html target=_blank>命令队列与 flush 机制</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/docs/plugins_guidelines.md#testing target=_blank>测试中的 ECS 模式</a></ul><h2 id=wan-zheng-dai-ma-chai-yi>完整代码差异</h2><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_ecs/src/observer/mod.rs b/crates/bevy_ecs/src/observer/mod.rs
</span><span>index 574f6ca257dea..4f3d210110d9b 100644
</span><span style=color:#c594c5>--- a/crates/bevy_ecs/src/observer/mod.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_ecs/src/observer/mod.rs
</span><span style=color:#c594c5>@@ -630,10 +630,6 @@ </span><span style=color:#399ee6>mod tests {
</span><span>         });
</span><span>         world.add_observer(|_: On&LTRemove, A>, mut res: ResMut&LTOrder>| res.observed("remove"));
</span><span> 
</span><span style=color:#f07171>-        // TODO: ideally this flush is not necessary, but right now observe() returns WorldEntityMut
</span><span style=color:#f07171>-        // and therefore does not automatically flush.
</span><span style=color:#f07171>-        world.flush();
</span><span style=color:#f07171>-
</span><span>         let mut entity = world.entity_mut(entity);
</span><span>         entity.insert(A);
</span><span>         entity.flush();
</span><span style=color:#c594c5>@@ -684,9 +680,6 @@ </span><span style=color:#399ee6>mod tests {
</span><span>         world.add_observer(|mut trigger: On&LTEventWithData>| trigger.event_mut().counter += 1);
</span><span>         world.add_observer(|mut trigger: On&LTEventWithData>| trigger.event_mut().counter += 2);
</span><span>         world.add_observer(|mut trigger: On&LTEventWithData>| trigger.event_mut().counter += 4);
</span><span style=color:#f07171>-        // This flush is required for the last observer to be called when triggering the event,
</span><span style=color:#f07171>-        // due to `World::add_observer` returning `WorldEntityMut`.
</span><span style=color:#f07171>-        world.flush();
</span><span> 
</span><span>         let mut event = EventWithData { counter: 0 };
</span><span>         world.trigger_ref(&mut event);
</span><span style=color:#c594c5>@@ -706,9 +699,6 @@ </span><span style=color:#399ee6>mod tests {
</span><span>         world.add_observer(|mut trigger: On&LTEventWithData, A>| {
</span><span>             trigger.event_mut().counter += 4;
</span><span>         });
</span><span style=color:#f07171>-        // This flush is required for the last observer to be called when triggering the event,
</span><span style=color:#f07171>-        // due to `World::add_observer` returning `WorldEntityMut`.
</span><span style=color:#f07171>-        world.flush();
</span><span> 
</span><span>         let mut event = EventWithData { counter: 0 };
</span><span>         let component_a = world.register_component::&LTA>();
</span><span style=color:#c594c5>@@ -766,7 +756,6 @@ </span><span style=color:#399ee6>mod tests {
</span><span> 
</span><span>         let entity = world.spawn(A).id();
</span><span>         world.entity_mut(entity).insert(B);
</span><span style=color:#f07171>-        world.flush();
</span><span>         assert_eq!(vec!["add_ab", "add_ab"], world.resource::&LTOrder>().0);
</span><span>     }
</span><span> 
</span><span style=color:#c594c5>@@ -833,11 +822,7 @@ </span><span style=color:#399ee6>mod tests {
</span><span>             res.observed("event_a");
</span><span>         });
</span><span> 
</span><span style=color:#f07171>-        // TODO: ideally this flush is not necessary, but right now observe() returns WorldEntityMut
</span><span style=color:#f07171>-        // and therefore does not automatically flush.
</span><span style=color:#f07171>-        world.flush();
</span><span>         world.trigger(EventA);
</span><span style=color:#f07171>-        world.flush();
</span><span>         assert_eq!(vec!["event_a"], world.resource::&LTOrder>().0);
</span><span>     }
</span><span> 
</span><span style=color:#c594c5>@@ -860,11 +845,7 @@ </span><span style=color:#399ee6>mod tests {
</span><span>             res.observed("a_2");
</span><span>         });
</span><span> 
</span><span style=color:#f07171>-        // TODO: ideally this flush is not necessary, but right now observe() returns WorldEntityMut
</span><span style=color:#f07171>-        // and therefore does not automatically flush.
</span><span style=color:#f07171>-        world.flush();
</span><span>         world.trigger_targets(EventA, entity);
</span><span style=color:#f07171>-        world.flush();
</span><span>         assert_eq!(vec!["a_2", "a_1"], world.resource::&LTOrder>().0);
</span><span>     }
</span><span> 
</span><span style=color:#c594c5>@@ -904,26 +885,20 @@ </span><span style=color:#399ee6>mod tests {
</span><span>              mut res: ResMut&LTR>| res.0 += 1000000,
</span><span>         );
</span><span> 
</span><span style=color:#f07171>-        // WorldEntityMut does not automatically flush.
</span><span style=color:#f07171>-        world.flush();
</span><span style=color:#f07171>-
</span><span>         // trigger for an entity and a component
</span><span>         world.trigger_targets(EventA, (entity_1, component_a));
</span><span style=color:#f07171>-        world.flush();
</span><span>         // only observer that doesn't trigger is the one only watching entity_2
</span><span>         assert_eq!(1111101, world.resource::&LTR>().0);
</span><span>         world.resource_mut::&LTR>().0 = 0;
</span><span> 
</span><span>         // trigger for both entities, but no components: trigger once per entity target
</span><span>         world.trigger_targets(EventA, (entity_1, entity_2));
</span><span style=color:#f07171>-        world.flush();
</span><span>         // only the observer that doesn't require components triggers - once per entity
</span><span>         assert_eq!(200, world.resource::&LTR>().0);
</span><span>         world.resource_mut::&LTR>().0 = 0;
</span><span> 
</span><span>         // trigger for both components, but no entities: trigger once
</span><span>         world.trigger_targets(EventA, (component_a, component_b));
</span><span style=color:#f07171>-        world.flush();
</span><span>         // all component observers trigger, entities are not observed
</span><span>         assert_eq!(1111100, world.resource::&LTR>().0);
</span><span>         world.resource_mut::&LTR>().0 = 0;
</span><span style=color:#c594c5>@@ -931,7 +906,6 @@ </span><span style=color:#399ee6>mod tests {
</span><span>         // trigger for both entities and both components: trigger once per entity target
</span><span>         // we only get 2222211 because a given observer can trigger only once per entity target
</span><span>         world.trigger_targets(EventA, ((component_a, component_b), (entity_1, entity_2)));
</span><span style=color:#f07171>-        world.flush();
</span><span>         assert_eq!(2222211, world.resource::&LTR>().0);
</span><span>         world.resource_mut::&LTR>().0 = 0;
</span><span> 
</span><span style=color:#c594c5>@@ -940,7 +914,6 @@ </span><span style=color:#399ee6>mod tests {
</span><span>             EventA,
</span><span>             (component_a, component_b, (component_a, component_b)),
</span><span>         );
</span><span style=color:#f07171>-        world.flush();
</span><span>         // the duplicate components in the tuple don't cause multiple triggers
</span><span>         assert_eq!(1111100, world.resource::&LTR>().0);
</span><span>         world.resource_mut::&LTR>().0 = 0;
</span><span style=color:#c594c5>@@ -955,7 +928,6 @@ </span><span style=color:#399ee6>mod tests {
</span><span>                 ((component_a, component_b), (component_a, component_b)),
</span><span>             ),
</span><span>         );
</span><span style=color:#f07171>-        world.flush();
</span><span>         // the duplicate components in the tuple don't cause multiple triggers
</span><span>         assert_eq!(1111100, world.resource::&LTR>().0);
</span><span>         world.resource_mut::&LTR>().0 = 0;
</span><span style=color:#c594c5>@@ -975,7 +947,6 @@ </span><span style=color:#399ee6>mod tests {
</span><span>                 ),
</span><span>             ),
</span><span>         );
</span><span style=color:#f07171>-        world.flush();
</span><span>         // the duplicate components in the tuple don't cause multiple triggers
</span><span>         assert_eq!(1111100, world.resource::&LTR>().0);
</span><span>         world.resource_mut::&LTR>().0 = 0;
</span><span style=color:#c594c5>@@ -1000,7 +971,6 @@ </span><span style=color:#399ee6>mod tests {
</span><span>         let entity = entity.flush();
</span><span> 
</span><span>         world.trigger_targets(EventA, entity);
</span><span style=color:#f07171>-        world.flush();
</span><span>         assert_eq!(vec!["event_a"], world.resource::&LTOrder>().0);
</span><span>     }
</span><span> 
</span><span style=color:#c594c5>@@ -1052,11 +1022,8 @@ </span><span style=color:#399ee6>mod tests {
</span><span>             },
</span><span>         );
</span><span> 
</span><span style=color:#f07171>-        // TODO: ideally this flush is not necessary, but right now observe() returns EntityWorldMut
</span><span style=color:#f07171>-        // and therefore does not automatically flush.
</span><span style=color:#f07171>-        world.flush();
</span><span>         world.trigger_targets(EventPropagating, child);
</span><span style=color:#f07171>-        world.flush();
</span><span style=color:#86b300>+
</span><span>         assert_eq!(vec!["child", "parent"], world.resource::&LTOrder>().0);
</span><span>     }
</span><span> 
</span><span style=color:#c594c5>@@ -1079,11 +1046,8 @@ </span><span style=color:#399ee6>mod tests {
</span><span>             })
</span><span>             .id();
</span><span> 
</span><span style=color:#f07171>-        // TODO: ideally this flush is not necessary, but right now observe() returns WorldEntityMut
</span><span style=color:#f07171>-        // and therefore does not automatically flush.
</span><span style=color:#f07171>-        world.flush();
</span><span>         world.trigger_targets(EventPropagating, [child, child]);
</span><span style=color:#f07171>-        world.flush();
</span><span style=color:#86b300>+
</span><span>         assert_eq!(
</span><span>             vec!["child", "parent", "child", "parent"],
</span><span>             world.resource::&LTOrder>().0
</span><span style=color:#c594c5>@@ -1109,11 +1073,7 @@ </span><span style=color:#399ee6>mod tests {
</span><span>             })
</span><span>             .id();
</span><span> 
</span><span style=color:#f07171>-        // TODO: ideally this flush is not necessary, but right now observe() returns WorldEntityMut
</span><span style=color:#f07171>-        // and therefore does not automatically flush.
</span><span style=color:#f07171>-        world.flush();
</span><span>         world.trigger_targets(EventPropagating, [child, parent]);
</span><span style=color:#f07171>-        world.flush();
</span><span>         assert_eq!(
</span><span>             vec!["child", "parent", "parent"],
</span><span>             world.resource::&LTOrder>().0
</span><span style=color:#c594c5>@@ -1142,11 +1102,8 @@ </span><span style=color:#399ee6>mod tests {
</span><span>             )
</span><span>             .id();
</span><span> 
</span><span style=color:#f07171>-        // TODO: ideally this flush is not necessary, but right now observe() returns WorldEntityMut
</span><span style=color:#f07171>-        // and therefore does not automatically flush.
</span><span style=color:#f07171>-        world.flush();
</span><span>         world.trigger_targets(EventPropagating, child);
</span><span style=color:#f07171>-        world.flush();
</span><span style=color:#86b300>+
</span><span>         assert_eq!(vec!["child"], world.resource::&LTOrder>().0);
</span><span>     }
</span><span> 
</span><span style=color:#c594c5>@@ -1176,11 +1133,8 @@ </span><span style=color:#399ee6>mod tests {
</span><span>             })
</span><span>             .id();
</span><span> 
</span><span style=color:#f07171>-        // TODO: ideally this flush is not necessary, but right now observe() returns WorldEntityMut
</span><span style=color:#f07171>-        // and therefore does not automatically flush.
</span><span style=color:#f07171>-        world.flush();
</span><span>         world.trigger_targets(EventPropagating, [child_a, child_b]);
</span><span style=color:#f07171>-        world.flush();
</span><span style=color:#86b300>+
</span><span>         assert_eq!(
</span><span>             vec!["child_a", "parent", "child_b", "parent"],
</span><span>             world.resource::&LTOrder>().0
</span><span style=color:#c594c5>@@ -1199,11 +1153,7 @@ </span><span style=color:#399ee6>mod tests {
</span><span>             })
</span><span>             .id();
</span><span> 
</span><span style=color:#f07171>-        // TODO: ideally this flush is not necessary, but right now observe() returns WorldEntityMut
</span><span style=color:#f07171>-        // and therefore does not automatically flush.
</span><span style=color:#f07171>-        world.flush();
</span><span>         world.trigger_targets(EventPropagating, entity);
</span><span style=color:#f07171>-        world.flush();
</span><span>         assert_eq!(vec!["event"], world.resource::&LTOrder>().0);
</span><span>     }
</span><span> 
</span><span style=color:#c594c5>@@ -1243,11 +1193,8 @@ </span><span style=color:#399ee6>mod tests {
</span><span>             })
</span><span>             .id();
</span><span> 
</span><span style=color:#f07171>-        // TODO: ideally this flush is not necessary, but right now observe() returns WorldEntityMut
</span><span style=color:#f07171>-        // and therefore does not automatically flush.
</span><span style=color:#f07171>-        world.flush();
</span><span>         world.trigger_targets(EventPropagating, [child_a, child_b]);
</span><span style=color:#f07171>-        world.flush();
</span><span style=color:#86b300>+
</span><span>         assert_eq!(
</span><span>             vec!["child_a", "child_b", "parent_b"],
</span><span>             world.resource::&LTOrder>().0
</span><span style=color:#c594c5>@@ -1267,11 +1214,8 @@ </span><span style=color:#399ee6>mod tests {
</span><span>         let parent = world.spawn(ChildOf(grandparent)).id();
</span><span>         let child = world.spawn(ChildOf(parent)).id();
</span><span> 
</span><span style=color:#f07171>-        // TODO: ideally this flush is not necessary, but right now observe() returns WorldEntityMut
</span><span style=color:#f07171>-        // and therefore does not automatically flush.
</span><span style=color:#f07171>-        world.flush();
</span><span>         world.trigger_targets(EventPropagating, child);
</span><span style=color:#f07171>-        world.flush();
</span><span style=color:#86b300>+
</span><span>         assert_eq!(vec!["event", "event", "event"], world.resource::&LTOrder>().0);
</span><span>     }
</span><span> 
</span><span style=color:#c594c5>@@ -1292,11 +1236,8 @@ </span><span style=color:#399ee6>mod tests {
</span><span>         let parent = world.spawn(ChildOf(grandparent)).id();
</span><span>         let child = world.spawn((A, ChildOf(parent))).id();
</span><span> 
</span><span style=color:#f07171>-        // TODO: ideally this flush is not necessary, but right now observe() returns WorldEntityMut
</span><span style=color:#f07171>-        // and therefore does not automatically flush.
</span><span style=color:#f07171>-        world.flush();
</span><span>         world.trigger_targets(EventPropagating, child);
</span><span style=color:#f07171>-        world.flush();
</span><span style=color:#86b300>+
</span><span>         assert_eq!(vec!["event", "event"], world.resource::&LTOrder>().0);
</span><span>     }
</span><span> 
</span><span style=color:#c594c5>@@ -1314,7 +1255,6 @@ </span><span style=color:#399ee6>mod tests {
</span><span>         let mut world = World::new();
</span><span>         world.add_observer(on_add);
</span><span>         world.spawn(A);
</span><span style=color:#f07171>-        world.flush();
</span><span>     }
</span><span> 
</span><span>     // Regression test for https://github.com/bevyengine/bevy/issues/14467
</span><span style=color:#c594c5>@@ -1367,9 +1307,7 @@ </span><span style=color:#399ee6>mod tests {
</span><span>                 params.p1().insert_resource(ResA);
</span><span>             },
</span><span>         );
</span><span style=color:#f07171>-        // TODO: ideally this flush is not necessary, but right now observe() returns WorldEntityMut
</span><span style=color:#f07171>-        // and therefore does not automatically flush.
</span><span style=color:#f07171>-        world.flush();
</span><span style=color:#86b300>+
</span><span>         world.trigger(EventA);
</span><span>         world.flush();
</span><span> 
</span><span style=color:#c594c5>@@ -1405,7 +1343,6 @@ </span><span style=color:#399ee6>mod tests {
</span><span>             assert_eq!(trigger.caller(), caller);
</span><span>         });
</span><span>         world.commands().spawn(Component).clear();
</span><span style=color:#f07171>-        world.flush();
</span><span>     }
</span><span> 
</span><span>     #[test]
</span><span style=color:#c594c5>@@ -1425,14 +1362,12 @@ </span><span style=color:#399ee6>mod tests {
</span><span>                 }
</span><span>             },
</span><span>         );
</span><span style=color:#f07171>-        world.flush();
</span><span> 
</span><span>         world.trigger_targets(EventA, [a_id, b_id]);
</span><span>         world.trigger_targets(EventA, a_id);
</span><span>         world.trigger_targets(EventA, b_id);
</span><span>         world.trigger_targets(EventA, [a_id, b_id]);
</span><span>         world.trigger_targets(EventA, a_id);
</span><span style=color:#f07171>-        world.flush();
</span><span> 
</span><span>         let counter = world.resource::&LTCounter>();
</span><span>         assert_eq!(4, *counter.0.get(&a_id).unwrap());
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-07/pr_20234.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>