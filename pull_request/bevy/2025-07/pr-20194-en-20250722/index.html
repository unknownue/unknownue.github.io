<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20194 RenderStartup for screen space reflections
        
    </title><meta content="#20194 RenderStartup for screen space reflections" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-07/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-07-22</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-07/pr-20194-zh-cn-20250722>中文</a></div></div><div class=pr-content><h2 id=renderstartup-for-screen-space-reflections-technical-analysis>RenderStartup for Screen Space Reflections: Technical Analysis</h2><h3 id=basic-information>Basic Information</h3><ul><li><strong>Title</strong>: RenderStartup for screen space reflections<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20194<li><strong>Author</strong>: andriyDev<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, C-Code-Quality, S-Ready-For-Final-Review, D-Straightforward<li><strong>Created</strong>: 2025-07-19T05:49:32Z<li><strong>Merged</strong>: 2025-07-21T23:20:24Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h3 id=description-translation>Description Translation</h3><h1 id=objective>Objective</h1><ul><li>Progress towards #19887.</ul><h2 id=solution>Solution</h2><ul><li>Convert <code>FromWorld</code> impls to systems in <code>RenderStartup</code>.<li>Add a system to conditionally add render graph edges (if a particular node exists).</ul><h2 id=testing>Testing</h2><ul><li>Ran the <code>ssr</code> example and it still works.</ul><h3 id=the-story-of-this-pull-request>The Story of This Pull Request</h3><p>The screen space reflections (SSR) implementation was using the <code>FromWorld</code> pattern for pipeline initialization, which didn’t align with Bevy’s newer system-based architecture. This PR migrates the SSR setup to use the <code>RenderStartup</code> schedule, improving consistency and maintainability.<p>The core issue was that <code>ScreenSpaceReflectionsPipeline</code> was being initialized through a <code>FromWorld</code> implementation. This pattern creates resources directly from the world during plugin setup, which bypasses Bevy’s system scheduling and makes the initialization process less flexible. The solution involved converting this setup into a proper system that runs during the <code>RenderStartup</code> schedule.<p>Additionally, the render graph edge setup was moved from the plugin’s <code>finish</code> method to a dedicated system. This change improves conditional logic handling by checking for the existence of the deferred lighting pass node at runtime rather than during plugin initialization. The new approach uses the render graph’s current state to determine if edges should be added:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>fn </span><span style=color:#f29718>add_screen_space_reflections_render_graph_edges</span><span>(</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>render_graph</span><span style=color:#61676ccc>: </span><span>ResMut&LTRenderGraph>) {
</span><span>    </span><span style=color:#fa6e32>let</span><span> subgraph </span><span style=color:#ed9366>=</span><span> render_graph</span><span style=color:#ed9366>.</span><span style=color:#f07171>sub_graph_mut</span><span>(Core3d)</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    subgraph</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_node_edge</span><span>(NodePbr</span><span style=color:#ed9366>::</span><span>ScreenSpaceReflections</span><span style=color:#61676ccc>, </span><span>Node3d</span><span style=color:#ed9366>::</span><span>MainOpaquePass)</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#fa6e32>if</span><span> subgraph
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>get_node_state</span><span>(NodePbr</span><span style=color:#ed9366>::</span><span>DeferredLightingPass)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>is_ok</span><span>()
</span><span>    {
</span><span>        subgraph</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_node_edge</span><span>(
</span><span>            NodePbr</span><span style=color:#ed9366>::</span><span>DeferredLightingPass</span><span style=color:#61676ccc>,
</span><span>            NodePbr</span><span style=color:#ed9366>::</span><span>ScreenSpaceReflections</span><span style=color:#61676ccc>,
</span><span>        )</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><p>The pipeline initialization was refactored from a <code>FromWorld</code> impl to a system that uses standard Bevy resources and commands:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>init_screen_space_reflections_pipeline</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands,
</span><span>    </span><span style=color:#ff8f40>render_device</span><span style=color:#61676ccc>: </span><span>Res&LTRenderDevice>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...other dependencies...
</span><span>) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Bind group layout creation
</span><span>    </span><span style=color:#fa6e32>let</span><span> bind_group_layout </span><span style=color:#ed9366>=</span><span> render_device</span><span style=color:#ed9366>.</span><span style=color:#f07171>create_bind_group_layout</span><span>(</span><span style=color:#abb0b6;font-style:italic>/* ... */</span><span>)</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Sampler creation
</span><span>    </span><span style=color:#fa6e32>let</span><span> color_sampler </span><span style=color:#ed9366>=</span><span> render_device</span><span style=color:#ed9366>.</span><span style=color:#f07171>create_sampler</span><span>(</span><span style=color:#abb0b6;font-style:italic>/* ... */</span><span>)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...other samplers...
</span><span>    
</span><span>    commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_resource</span><span>(ScreenSpaceReflectionsPipeline {
</span><span>        mesh_view_layouts</span><span style=color:#61676ccc>:</span><span> mesh_view_layouts</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#61676ccc>,
</span><span>        color_sampler</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ...other fields...
</span><span>        fragment_shader</span><span style=color:#61676ccc>: </span><span style=color:#f07171>load_embedded_asset!</span><span>(asset_server</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_ref</span><span>()</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"ssr.wgsl"</span><span>)</span><span style=color:#61676ccc>,
</span><span>    })</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>This change aligns SSR with Bevy’s established patterns, making the code more consistent and easier to maintain. The migration guide was updated to reflect that <code>ScreenSpaceReflectionsPipeline</code> is now initialized in <code>RenderStartup</code>.<p>Testing confirmed the <code>ssr</code> example continues to function correctly after these changes. The PR represents a straightforward quality improvement that progresses Bevy toward eliminating <code>FromWorld</code> usage (#19887) without altering SSR’s core functionality.<h3 id=visual-representation>Visual Representation</h3><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[RenderStartup Schedule] --> B[init_screen_space_reflections_pipeline]
</span><span>    A --> C[add_screen_space_reflections_render_graph_edges]
</span><span>    B --> D[ScreenSpaceReflectionsPipeline Resource]
</span><span>    C --> E[RenderGraph Edges]
</span></code></pre><h3 id=key-files-changed>Key Files Changed</h3><ol><li><code>crates/bevy_pbr/src/ssr/mod.rs</code> <ul><li>Converted pipeline setup from <code>FromWorld</code> to <code>RenderStartup</code> system<li>Moved render graph edge creation to dedicated system<li>Removed plugin <code>finish</code> method</ul></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>impl </span><span>FromWorld </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>ScreenSpaceReflectionsPipeline </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>from_world</span><span>(</span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> World) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// Resource initialization directly from world
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>init_screen_space_reflections_pipeline</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands,
</span><span>    </span><span style=color:#ff8f40>render_device</span><span style=color:#61676ccc>: </span><span>Res&LTRenderDevice>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...dependencies...
</span><span>) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// System-based resource initialization
</span><span>    commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_resource</span><span>(ScreenSpaceReflectionsPipeline { </span><span style=color:#abb0b6;font-style:italic>/* ... */ </span><span>})</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><ol start=2><li><code>release-content/migration-guides/render_startup.md</code> <ul><li>Added <code>ScreenSpaceReflectionsPipeline</code> to resources initialized in <code>RenderStartup</code></ul></ol><pre class=language-markdown data-lang=markdown style=color:#61676c;background-color:#fafafa><code class=language-markdown data-lang=markdown><span style=color:#4cbf99>+ - </span><span style=color:#ed9366;background-color:#61676c10>`ScreenSpaceReflectionsPipeline`</span><span>
</span></code></pre><h3 id=further-reading>Further Reading</h3><ol><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/release-content/migration-guides/render_startup.md target=_blank>Bevy RenderStartup Migration Guide</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_ecs/latest/bevy_ecs/schedule/index.html target=_blank>Bevy ECS Schedules Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/crates/bevy_render/src/render_graph/mod.rs target=_blank>Bevy Render Graph Architecture</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-07/pr_20194.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>