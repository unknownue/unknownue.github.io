<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20020 Solari initial GI
        
    </title><meta content="#20020 Solari initial GI" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-07/>‚Üê Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-07-13</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-07/pr-20020-zh-cn-20250713>‰∏≠Êñá</a></div></div><div class=pr-content><h1 id=technical-analysis-of-pr-20020-solari-initial-gi>Technical Analysis of PR #20020: Solari initial GI</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Solari initial GI<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20020<li><strong>Author</strong>: JMS55<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Feature, A-Rendering, S-Ready-For-Final-Review, M-Needs-Release-Note<li><strong>Created</strong>: 2025-07-07T20:59:24Z<li><strong>Merged</strong>: 2025-07-13T17:42:51Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Add 1-bounce RT GI</ul><h2 id=solution>Solution</h2><ul><li>Implement a very very basic version of ReSTIR GI https://d1qx31qr3h6wln.cloudfront.net/publications/ReSTIR%20GI.pdf<li>Pretty much a copy of the ReSTIR DI code, but adjusted for GI.<li>Didn‚Äôt implement add more spatial samples, or do anything needed for better quality.<li>Didn‚Äôt try to improve perf at all yet (it‚Äôs actually faster than DI though, unfortunately üòÖ)<li>Didn‚Äôt spend any time cleaning up the shared abstractions between DI/GI</ul><hr><h2 id=showcase>Showcase</h2><img alt=image height=1500 src=https://github.com/user-attachments/assets/1ff7be1c-7d7d-4e53-8aa6-bcec1553db3f width=2564><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=the-problem-and-context>The Problem and Context</h3><p>Bevy‚Äôs experimental raytraced lighting system (Solari) previously only implemented direct illumination (DI) using ReSTIR techniques. While this provided realistic direct lighting, it lacked global illumination (GI) - the critical effect where light bounces off surfaces to illuminate other objects. Without GI, scenes appeared flat and lacked realistic light interactions between objects. This PR addresses that gap by implementing a basic 1-bounce global illumination solution.<p>The technical challenge involved adapting the existing ReSTIR DI implementation to handle indirect lighting while maintaining real-time performance constraints. The solution needed to integrate with Bevy‚Äôs existing rendering pipeline and resource management systems without disrupting existing functionality.<h3 id=the-solution-approach>The Solution Approach</h3><p>The implementation follows the ReSTIR GI paper, adapting the existing ReSTIR DI codebase for indirect illumination. The approach maintains the same two-pass structure (initial/temporal and spatial/shade) but with significant modifications for GI-specific requirements:<ol><li><strong>Separate pipelines</strong>: Created distinct compute pipelines for DI and GI to handle their different sampling requirements<li><strong>New reservoir structure</strong>: Designed a new reservoir format to store GI-specific sample data (position, normal, radiance)<li><strong>Visibility handling</strong>: Implemented point-to-point visibility tracing for spatial reuse<li><strong>Jacobian adjustments</strong>: Added geometric correction factors for spatial resampling</ol><p>The implementation prioritizes getting a functional foundation in place over optimization or quality improvements, explicitly deferring those to future work.<h3 id=the-implementation>The Implementation</h3><p>The core implementation adds a new <code>restir_gi.wgsl</code> shader with 310 lines of new WGSL code. The GI algorithm works in two compute passes:<ol><li><strong>Initial and Temporal Pass</strong>: <ul><li>Generates initial samples by tracing rays in random hemispherical directions<li>Reuses samples from previous frames using motion vectors<li>Combines current and temporal samples using reservoir merging</ul></ol><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Initial sample generation
</span><span>let ray_direction = sample_uniform_hemisphere(world_normal, rng);
</span><span>let ray_hit = trace_ray(world_position, ray_direction, RAY_T_MIN, RAY_T_MAX, RAY_FLAG_NONE);
</span><span>let sample_point = resolve_ray_hit_full(ray_hit);
</span></code></pre><ol start=2><li><strong>Spatial and Shade Pass</strong>: <ul><li>Gathers samples from neighboring pixels<li>Applies Jacobian corrections for geometric consistency<li>Computes final radiance contribution</ul></ol><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Jacobian correction
</span><span>let jacobian = (phi_r * ql * ql) / (phi_q * rl * rl);
</span><span>spatial_reservoir.unbiased_contribution_weight *= jacobian;
</span></code></pre><p>The node system was extended to manage four distinct compute pipelines (DI initial/temporal, DI spatial/shade, GI initial/temporal, GI spatial/shade). Resource preparation was updated to create separate buffer sets for DI and GI reservoirs with different struct sizes (32 bytes for DI, 48 bytes for GI).<h3 id=technical-insights>Technical Insights</h3><p>Key technical aspects of the implementation:<ol><li><strong>Reservoir Differences</strong>: <ul><li>DI reservoirs store light samples (LightSample struct)<li>GI reservoirs store surface samples (position, normal, radiance)<li>GI requires additional fields (confidence_weight, unbiased_contribution_weight)</ul></ol><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// DI Reservoir (32 bytes)
</span><span>struct Reservoir {
</span><span>    sample: LightSample,
</span><span>    weight_sum: f32,
</span><span>    visibility: f32,
</span><span>    M: f32,
</span><span>    W: f32,
</span><span>}
</span><span>
</span><span>// GI Reservoir (48 bytes)
</span><span>struct Reservoir {
</span><span>    sample_point_world_position: vec3&LTf32>,
</span><span>    weight_sum: f32,
</span><span>    radiance: vec3&LTf32>,
</span><span>    confidence_weight: f32,
</span><span>    sample_point_world_normal: vec3&LTf32>,
</span><span>    unbiased_contribution_weight: f32,
</span><span>}
</span></code></pre><ol start=2><li><strong>Visibility Handling</strong>: <ul><li>DI uses single-ray visibility checks<li>GI requires point-to-point visibility between surfaces<li>Added <code>trace_point_visibility</code> function to handle this</ul></ol><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>fn trace_point_visibility(ray_origin: vec3&LTf32>, point: vec3&LTf32>) -> f32 {
</span><span>    let ray = point - ray_origin;
</span><span>    let dist = length(ray);
</span><span>    let ray_direction = ray / dist;
</span><span>    // ... trace ray between points
</span><span>}
</span></code></pre><ol start=3><li><strong>Sampling Differences</strong>: <ul><li>DI samples light sources directly<li>GI samples hemispherical directions and collects surface hits<li>Added <code>sample_uniform_hemisphere</code> for GI initial sampling</ul></ol><h3 id=the-impact>The Impact</h3><p>This PR adds foundational global illumination capabilities to Bevy‚Äôs rendering system:<ol><li><strong>New rendering feature</strong>: 1-bounce real-time global illumination<li><strong>Performance characteristics</strong>: Initial implementation is unoptimized but functional<li><strong>Architectural changes</strong>: <ul><li>Extended pipeline with GI-specific stages<li>Added new resource types (GI reservoirs)<li>Modified sampling infrastructure</ul></ol><p>The implementation leaves several areas for future improvement:<ul><li>Quality enhancements (more spatial samples, better denoising)<li>Performance optimization<li>Abstraction sharing between DI/GI systems<li>Multi-bounce GI support</ul><h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[SolariLightingNode] --> B[DI Initial/Temporal]
</span><span>    A --> C[DI Spatial/Shade]
</span><span>    A --> D[GI Initial/Temporal]
</span><span>    A --> E[GI Spatial/Shade]
</span><span>    B --> C
</span><span>    D --> E
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ol><li><code>crates/bevy_solari/src/realtime/restir_gi.wgsl</code> (+310/-0) <ul><li>Implements core GI algorithm with initial/temporal and spatial/shade passes<li>Adds GI-specific reservoir structure and merging logic<li>Implements Jacobian corrections for spatial reuse</ul></ol><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Key GI reservoir merge logic
</span><span>fn merge_reservoirs(...) -> ReservoirMergeResult {
</span><span>    // ... reservoir combination logic
</span><span>    let jacobian = (phi_r * ql * ql) / (phi_q * rl * rl);
</span><span>    return select(jacobian, 0.0, isinf(jacobian) || isnan(jacobian));
</span><span>}
</span></code></pre><ol start=2><li><code>crates/bevy_solari/src/realtime/node.rs</code> (+77/-17) <ul><li>Adds separate compute pipelines for GI<li>Extends bind groups to include GI reservoirs<li>Dispatches all four compute passes (2 DI + 2 GI)</ul></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Pipeline setup for GI
</span><span style=color:#fa6e32>let</span><span> gi_initial_and_temporal_pipeline </span><span style=color:#ed9366>=</span><span> pipeline_cache</span><span style=color:#ed9366>.</span><span style=color:#f07171>queue_compute_pipeline</span><span>(
</span><span>    ComputePipelineDescriptor {
</span><span>        label</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#86b300>"solari_lighting_gi_initial_and_temporal_pipeline"</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>())</span><span style=color:#61676ccc>,
</span><span>        shader</span><span style=color:#61676ccc>: </span><span style=color:#f07171>load_embedded_asset!</span><span>(world</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"restir_gi.wgsl"</span><span>)</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>    }
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><ol start=3><li><code>crates/bevy_solari/src/realtime/prepare.rs</code> (+32/-13) <ul><li>Creates separate buffer sets for DI and GI reservoirs<li>Uses different struct sizes for DI (32B) and GI (48B) reservoirs</ul></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// GI buffer creation
</span><span style=color:#fa6e32>let</span><span> gi_reservoirs_a </span><span style=color:#ed9366>=</span><span> render_device</span><span style=color:#ed9366>.</span><span style=color:#f07171>create_buffer</span><span>(</span><span style=color:#ed9366>&</span><span>BufferDescriptor {
</span><span>    label</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#86b300>"solari_lighting_gi_reservoirs_a"</span><span>)</span><span style=color:#61676ccc>,
</span><span>    size</span><span style=color:#61676ccc>: </span><span>(view_size</span><span style=color:#ed9366>.</span><span>x </span><span style=color:#ed9366>*</span><span> view_size</span><span style=color:#ed9366>.</span><span>y) </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>u64 </span><span style=color:#ed9366>* </span><span style=color:#ff8f40>GI_RESERVOIR_STRUCT_SIZE</span><span style=color:#61676ccc>, </span><span style=color:#abb0b6;font-style:italic>// 48 bytes
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>})</span><span style=color:#61676ccc>;
</span></code></pre><ol start=4><li><code>crates/bevy_solari/src/realtime/restir_di.wgsl</code> (+24/-19) <ul><li>Adjusts binding indices to accommodate new GI resources<li>Adds explicit checks for temporal sample validity</ul></ol><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Updated binding indices
</span><span>@group(1) @binding(5) var gbuffer: texture_2d&LTu32>;
</span><span>@group(1) @binding(6) var depth_buffer: texture_depth_2d;
</span></code></pre><ol start=5><li><code>crates/bevy_solari/src/scene/sampling.wgsl</code> (+26/-5) <ul><li>Adds uniform hemisphere sampling for GI<li>Modifies light sampling to return inverse PDF<li>Implements point-to-point visibility tracing</ul></ol><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// New sampling function for GI
</span><span>fn sample_uniform_hemisphere(normal: vec3&LTf32>, rng: ptr&LTfunction, u32>) -> vec3&LTf32> {
</span><span>    let cos_theta = rand_f(rng);
</span><span>    let phi = PI_2 * rand_f(rng);
</span><span>    // ... compute direction
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://d1qx31qr3h6wln.cloudfront.net/publications/ReSTIR%20GI.pdf target=_blank>ReSTIR GI Paper</a> - Original paper describing the algorithm<li><a rel="noopener nofollow noreferrer" href=https://intro-to-restir.cwyman.org/presentations/2023ReSTIR_Course_Notes.pdf target=_blank>ReSTIR Course Notes</a> - Comprehensive introduction to ReSTIR techniques<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/rendering/ target=_blank>Bevy Rendering Documentation</a> - Bevy‚Äôs rendering concepts</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-07/pr_20020.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>