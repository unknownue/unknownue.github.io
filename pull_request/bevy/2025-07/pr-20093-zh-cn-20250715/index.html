<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20093 Improved UI scrolling support and bug fixes
        
    </title><meta content="#20093 Improved UI scrolling support and bug fixes" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-07/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-07-15</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2025-07/pr-20093-en-20250715>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=improved-ui-scrolling-support-and-bug-fixes>Improved UI scrolling support and bug fixes</h1><h2 id=ji-ben-xin-xi>基本信息</h2><ul><li><strong>标题</strong>: Improved UI scrolling support and bug fixes<li><strong>PR链接</strong>: https://github.com/bevyengine/bevy/pull/20093<li><strong>作者</strong>: ickshonpe<li><strong>状态</strong>: MERGED<li><strong>标签</strong>: C-Bug, C-Feature, A-UI, S-Ready-For-Final-Review, M-Needs-Migration-Guide, M-Needs-Release-Note<li><strong>创建时间</strong>: 2025-07-11T20:47:18Z<li><strong>合并时间</strong>: 2025-07-15T17:53:56Z<li><strong>合并者</strong>: alice-i-cecile</ul><h2 id=miao-shu-fan-yi>描述翻译</h2><h3 id=mu-biao-objective>目标 (Objective)</h3><h4 id=mu-biao>目标</h4><ul><li>阻止布局更新覆盖 <code>ScrollPosition</code><li>让 <code>ScrollPosition</code> 尊重缩放因子 (scale factor)<li>当 <code>OverflowAxis::Scroll</code> 被设置时，自动为滚动条在轴向上分配空间</ul><h4 id=fei-mu-biao>非目标</h4><ul><li>支持 overflow-auto（我原以为Taffy已有此功能，但显然是我记错了）<li>实现任何滚动条小部件 (widget)<li>稳定性（由于不需要支持overflow-auto，暂不需要）<li>未来可能会添加 <code>ScrollbarWidth</code> 枚举以更接近CSS API（提供auto/narrow/none选项）。目前 <code>scrollbar_width</code> 只是与Taffy API匹配的 <code>f32</code></ul><h3 id=jie-jue-fang-an-solution>解决方案 (Solution)</h3><ul><li>布局更新不再覆盖 <code>ScrollPosition</code> 的值<li>在 <code>Node</code> 中添加了字段 <code>scrollbar_width: f32</code>。该值被发送给 <code>Taffy</code>，后者将根据需要自动在布局中为滚动条分配此宽度的空间<li>在 <code>ComputedNode</code> 中添加了字段 <code>scrollbar_width: f32</code> 和 <code>scroll_position: Vec2</code>。这些在布局期间自动更新<li><code>ScrollPosition</code> 现在会考虑缩放因子<li><code>ui_layout_system</code> 不再自动为每个UI节点实体添加 <code>ScrollPosition</code>。如果每个节点都需要它，应将其设为 <code>Node</code> 的必需字段（或直接作为字段）</ul><h3 id=ce-shi-testing>测试 (Testing)</h3><p>用于测试的示例：<ul><li><code>scrollbars</code> 示例，应与之前一样工作<li>新示例 <code>drag_to_scroll</code><li><code>scroll</code> 示例，该示例会自动为左侧滚动列表的滚动条分配空间。尚未实现实际滚动条，因此目前只会看到空隙</ul><h2 id=zhe-ge-prde-gu-shi>这个PR的故事</h2><h3 id=wen-ti-yu-bei-jing>问题与背景</h3><p>在Bevy的UI系统中，滚动(scrolling)功能存在三个核心问题。首先，布局更新会覆盖用户设置的 <code>ScrollPosition</code> 值，导致滚动位置在布局计算后被意外重置。其次，<code>ScrollPosition</code> 没有考虑UI缩放因子，导致在高DPI显示器或缩放UI时滚动位置计算错误。第三，当设置 <code>OverflowAxis::Scroll</code> 时，系统没有为滚动条预留空间，导致内容被滚动条遮挡。<p>这些问题直接影响了需要精确滚动控制的UI场景。例如，在可滚动列表中，用户设置的滚动位置可能在UI更新后丢失；在缩放UI时，滚动位置可能无法正确映射到内容位置；在需要显示滚动条时，内容区域会被意外裁剪。<h3 id=jie-jue-fang-an>解决方案</h3><p>开发者采取了系统化的方法解决这些问题：<ol><li>停止布局系统覆盖 <code>ScrollPosition</code>，改将计算后的滚动位置存储在 <code>ComputedNode</code> 中<li>在布局计算中引入缩放因子校正<li>添加 <code>scrollbar_width</code> 属性，让Taffy布局引擎自动为滚动条分配空间<li>重构滚动位置计算逻辑，使用逻辑像素(logical pixels)而非物理像素(physical pixels)</ol><p>关键决策包括：<ul><li>选择在 <code>ComputedNode</code> 而非 <code>Node</code> 中存储运行时计算的滚动位置，因为这是派生数据<li>直接修改Taffy样式而非在Bevy侧处理滚动条空间分配，保持与底层布局引擎一致<li>使用逻辑像素单位统一滚动位置计算，与UI系统的其他尺寸处理保持一致</ul><h3 id=shi-xian-xi-jie>实现细节</h3><p>核心修改集中在布局系统和节点结构：<ol><li><p><strong><code>Node</code> 结构增强</strong>：</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// crates/bevy_ui/src/ui_node.rs
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>Node </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>    </span><span style=color:#fa6e32>pub </span><span>scrollbar_width</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>, </span><span style=color:#abb0b6;font-style:italic>// 新增字段
</span><span>}
</span></code></pre> <p>新字段允许开发者指定滚动条宽度，该值会被传递到Taffy</p><li><p><strong><code>ComputedNode</code> 扩展</strong>：</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>ComputedNode </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>    </span><span style=color:#fa6e32>pub </span><span>scrollbar_size</span><span style=color:#61676ccc>:</span><span> Vec2,    </span><span style=color:#abb0b6;font-style:italic>// 新增：滚动条占用空间
</span><span>    </span><span style=color:#fa6e32>pub </span><span>scroll_position</span><span style=color:#61676ccc>:</span><span> Vec2,   </span><span style=color:#abb0b6;font-style:italic>// 新增：计算后的滚动位置
</span><span>}
</span></code></pre> <p>这些字段由布局系统自动填充，提供运行时计算的滚动信息</p><li><p><strong>布局系统重构</strong>：</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// crates/bevy_ui/src/layout/mod.rs
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>update_uinode_geometry_recursive</span><span>(
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 移除了Commands参数
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 存储滚动条尺寸
</span><span>    node</span><span style=color:#ed9366>.</span><span style=color:#f07171>bypass_change_detection</span><span>()</span><span style=color:#ed9366>.</span><span>scrollbar_size </span><span style=color:#ed9366>=
</span><span>        Vec2</span><span style=color:#ed9366>::</span><span>new(layout</span><span style=color:#ed9366>.</span><span>scrollbar_size</span><span style=color:#ed9366>.</span><span>width</span><span style=color:#61676ccc>,</span><span> layout</span><span style=color:#ed9366>.</span><span>scrollbar_size</span><span style=color:#ed9366>.</span><span>height)</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 计算逻辑像素滚动位置（考虑缩放因子）
</span><span>    </span><span style=color:#fa6e32>let</span><span> scroll_position</span><span style=color:#61676ccc>:</span><span> Vec2 </span><span style=color:#ed9366>= </span><span style=color:#abb0b6;font-style:italic>/* 计算逻辑 */</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 计算最大滚动范围（包含滚动条空间）
</span><span>    </span><span style=color:#fa6e32>let</span><span> max_possible_offset </span><span style=color:#ed9366>= 
</span><span>        (content_size </span><span style=color:#ed9366>-</span><span> layout_size </span><span style=color:#ed9366>+</span><span> node</span><span style=color:#ed9366>.</span><span>scrollbar_size)</span><span style=color:#ed9366>.</span><span style=color:#f07171>max</span><span>(Vec2</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ZERO</span><span>)</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 存储最终滚动位置到ComputedNode
</span><span>    node</span><span style=color:#ed9366>.</span><span style=color:#f07171>bypass_change_detection</span><span>()</span><span style=color:#ed9366>.</span><span>scroll_position </span><span style=color:#ed9366>=</span><span> physical_scroll_position</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre> <p>关键改进：</p> <ul><li>不再使用ECS命令更新 <code>ScrollPosition</code> 组件<li>滚动位置计算现在考虑缩放因子 (<code>inverse_target_scale_factor</code>)<li>最大滚动范围计算包含滚动条占用的空间</ul><li><p><strong>裁剪系统适配</strong>：</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// crates/bevy_ui/src/update.rs
</span><span>clip_rect</span><span style=color:#ed9366>.</span><span>max</span><span style=color:#ed9366>.</span><span>x </span><span style=color:#ed9366>-=</span><span> clip_inset</span><span style=color:#ed9366>.</span><span>right </span><span style=color:#ed9366>+</span><span> computed_node</span><span style=color:#ed9366>.</span><span>scrollbar_size</span><span style=color:#ed9366>.</span><span>x</span><span style=color:#61676ccc>;
</span><span>clip_rect</span><span style=color:#ed9366>.</span><span>max</span><span style=color:#ed9366>.</span><span>y </span><span style=color:#ed9366>-=</span><span> clip_inset</span><span style=color:#ed9366>.</span><span>bottom </span><span style=color:#ed9366>+</span><span> computed_node</span><span style=color:#ed9366>.</span><span>scrollbar_size</span><span style=color:#ed9366>.</span><span>y</span><span style=color:#61676ccc>;
</span></code></pre> <p>裁剪区域现在会减去滚动条占用的空间，防止内容被错误裁剪</p></ol><h3 id=ji-shu-dong-cha>技术洞察</h3><ol><li><p><strong>滚动位置存储策略</strong>：<br> 将 <code>scroll_position</code> 移至 <code>ComputedNode</code> 是明智的设计选择。这避免了ECS组件更新的开销，并保持布局数据在单一结构中，提高数据局部性</p><li><p><strong>单位一致性</strong>：<br> 统一使用逻辑像素单位处理滚动位置解决了缩放问题。转换公式为：<br> <code>物理位置 = 逻辑位置 × 缩放因子</code><br> 这确保了滚动行为在不同DPI和UI缩放设置下保持一致</p><li><p><strong>Taffy集成</strong>：<br> 通过直接设置 <code>scrollbar_width</code> 的Taffy样式属性（在 <code>from_node</code> 函数中），Bevy有效利用了底层布局引擎的能力：</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>scrollbar_width</span><span style=color:#61676ccc>:</span><span> node</span><span style=color:#ed9366>.</span><span>scrollbar_width </span><span style=color:#ed9366>*</span><span> context</span><span style=color:#ed9366>.</span><span>scale_factor
</span></code></pre> <p>这种设计保持了Bevy UI与Taffy的松耦合，同时获得精确的布局控制</p><li><p><strong>变更检测优化</strong>：<br> 使用 <code>bypass_change_detection()</code> 直接修改 <code>ComputedNode</code> 避免了不必要的变更检测触发，这对高频更新的布局系统尤为重要</p></ol><h3 id=ying-xiang>影响</h3><p>这些修改直接解决了报告的问题：<ol><li>用户设置的 <code>ScrollPosition</code> 不再被布局系统覆盖<li>滚动位置现在正确处理UI缩放<li>设置 <code>OverflowAxis::Scroll</code> 时会自动预留滚动条空间<li>新增 <code>drag_to_scroll</code> 示例演示了完整的拖动滚动交互</ol><p>迁移注意事项：<ul><li><code>ScrollPosition</code> 现在使用逻辑像素单位<li>开发者需要在需要滚动的节点显式添加 <code>ScrollPosition</code> 组件<li>现有项目需更新滚动位置处理逻辑以适应新的单位系统</ul><h2 id=shi-jue-biao-shi>视觉表示</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Node] -->|添加字段| B[scrollbar_width]
</span><span>    C[ComputedNode] -->|添加字段| D[scrollbar_size]
</span><span>    C -->|添加字段| E[scroll_position]
</span><span>    F[ui_layout_system] -->|读取/设置| C
</span><span>    F -->|使用| G[Taffy布局引擎]
</span><span>    G -->|返回布局数据| F
</span><span>    H[裁剪系统] -->|使用| D
</span><span>    I[用户交互] -->|设置| J[ScrollPosition组件]
</span><span>    F -->|尊重但不修改| J
</span></code></pre><h2 id=guan-jian-wen-jian-bian-geng>关键文件变更</h2><h3 id=crates-bevy-ui-src-ui-node-rs-14-0><code>crates/bevy_ui/src/ui_node.rs</code> (+14/-0)</h3><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 在Node结构体中新增字段
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>Node </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>    </span><span style=color:#fa6e32>pub </span><span>scrollbar_width</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 在ComputedNode结构体中新增字段
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>ComputedNode </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>    </span><span style=color:#fa6e32>pub </span><span>scrollbar_size</span><span style=color:#61676ccc>:</span><span> Vec2,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>scroll_position</span><span style=color:#61676ccc>:</span><span> Vec2,
</span><span>}
</span></code></pre><p><strong>变更原因</strong>：为支持滚动条空间分配和滚动位置存储添加必要字段<h3 id=crates-bevy-ui-src-layout-mod-rs-11-19><code>crates/bevy_ui/src/layout/mod.rs</code> (+11/-19)</h3><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 修改前：
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>update_uinode_geometry_recursive</span><span>(
</span><span>    </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> Commands, </span><span style=color:#abb0b6;font-style:italic>// 需要Commands参数
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>    </span><span style=color:#fa6e32>if</span><span> clamped_scroll_position </span><span style=color:#ed9366>!=</span><span> scroll_position {
</span><span>        commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(entity)</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(ScrollPosition(clamped_scroll_position))</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 修改后：
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>update_uinode_geometry_recursive</span><span>(
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 移除了Commands参数
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>    node</span><span style=color:#ed9366>.</span><span style=color:#f07171>bypass_change_detection</span><span>()</span><span style=color:#ed9366>.</span><span>scrollbar_size </span><span style=color:#ed9366>= </span><span style=color:#abb0b6;font-style:italic>/* 计算值 */</span><span style=color:#61676ccc>;
</span><span>    node</span><span style=color:#ed9366>.</span><span style=color:#f07171>bypass_change_detection</span><span>()</span><span style=color:#ed9366>.</span><span>scroll_position </span><span style=color:#ed9366>= </span><span style=color:#abb0b6;font-style:italic>/* 计算值 */</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p><strong>变更原因</strong>：重构滚动位置处理逻辑，不再通过ECS命令更新组件，改为直接存储到ComputedNode<h3 id=examples-ui-drag-to-scroll-rs-120-0><code>examples/ui/drag_to_scroll.rs</code> (+120/-0)</h3><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 新示例演示拖动滚动功能
</span><span>commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((
</span><span>    Node {
</span><span>        overflow</span><span style=color:#61676ccc>: </span><span>Overflow</span><span style=color:#ed9366>::</span><span>scroll()</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#ed9366>..</span><span style=color:#55b4d4;font-style:italic>Default</span><span style=color:#ed9366>::</span><span>default()
</span><span>    }</span><span style=color:#61676ccc>,
</span><span>    ScrollPosition(Vec2</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ZERO</span><span>)</span><span style=color:#61676ccc>,
</span><span>    ScrollableNode</span><span style=color:#61676ccc>,
</span><span>))</span><span style=color:#ed9366>.</span><span style=color:#f07171>observe</span><span>(
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 处理拖动事件更新滚动位置
</span><span>    </span><span style=color:#ed9366>|</span><span>drag</span><span style=color:#61676ccc>: </span><span>On&LTPointer&LTDrag>></span><span style=color:#61676ccc>,</span><span> ui_scale</span><span style=color:#61676ccc>: </span><span>Res&LTUiScale></span><span style=color:#61676ccc>,
</span><span>     </span><span style=color:#fa6e32>mut</span><span> scroll_position_query</span><span style=color:#61676ccc>: </span><span>Query<(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> ScrollPosition, </span><span style=color:#ed9366>&</span><span>ScrollStart)></span><span style=color:#ed9366>| </span><span>{
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// 计算新滚动位置
</span><span>        scroll_position</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0 </span><span style=color:#ed9366>= </span><span>(start</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0 </span><span style=color:#ed9366>-</span><span> drag</span><span style=color:#ed9366>.</span><span>distance </span><span style=color:#ed9366>/</span><span> ui_scale</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>max</span><span>(Vec2</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ZERO</span><span>)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>)
</span></code></pre><p><strong>变更原因</strong>：提供完整的使用示例，演示如何实现拖动滚动功能，同时验证缩放因子处理<h3 id=crates-bevy-ui-src-update-rs-4-4><code>crates/bevy_ui/src/update.rs</code> (+4/-4)</h3><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 修改裁剪计算考虑滚动条空间
</span><span style=color:#abb0b6;font-style:italic>// 修改前：
</span><span>clip_rect</span><span style=color:#ed9366>.</span><span>max</span><span style=color:#ed9366>.</span><span>x </span><span style=color:#ed9366>-=</span><span> clip_inset</span><span style=color:#ed9366>.</span><span>right</span><span style=color:#61676ccc>;
</span><span>clip_rect</span><span style=color:#ed9366>.</span><span>max</span><span style=color:#ed9366>.</span><span>y </span><span style=color:#ed9366>-=</span><span> clip_inset</span><span style=color:#ed9366>.</span><span>bottom</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 修改后：
</span><span>clip_rect</span><span style=color:#ed9366>.</span><span>max</span><span style=color:#ed9366>.</span><span>x </span><span style=color:#ed9366>-=</span><span> clip_inset</span><span style=color:#ed9366>.</span><span>right </span><span style=color:#ed9366>+</span><span> computed_node</span><span style=color:#ed9366>.</span><span>scrollbar_size</span><span style=color:#ed9366>.</span><span>x</span><span style=color:#61676ccc>;
</span><span>clip_rect</span><span style=color:#ed9366>.</span><span>max</span><span style=color:#ed9366>.</span><span>y </span><span style=color:#ed9366>-=</span><span> clip_inset</span><span style=color:#ed9366>.</span><span>bottom </span><span style=color:#ed9366>+</span><span> computed_node</span><span style=color:#ed9366>.</span><span>scrollbar_size</span><span style=color:#ed9366>.</span><span>y</span><span style=color:#61676ccc>;
</span></code></pre><p><strong>变更原因</strong>：确保裁剪区域正确计算，避免内容被滚动条遮挡<h3 id=release-content-migration-guides-ui-scroll-position-is-now-logical-md-5-0><code>release-content/migration-guides/UI_scroll_position_is_now_logical.md</code> (+5/-0)</h3><pre class=language-markdown data-lang=markdown style=color:#61676c;background-color:#fafafa><code class=language-markdown data-lang=markdown><span style=color:#abb0b6;background-color:#61676c10;font-weight:700>---
</span><span>title: </span><span style=color:#ed9366;background-color:#61676c10>`ScrollPosition`</span><span> 现在使用逻辑像素单位且布局更新不再覆盖它
</span><span>pull_requests: [20093]
</span><span style=color:#fa6e32;font-weight:700>---
</span><span style=color:#ed9366;background-color:#61676c10>`ScrollPosition`</span><span> 在布局更新期间不再被覆盖。计算后的滚动位置现在存储于</span><span style=color:#ed9366;background-color:#61676c10>`ComputedNode`</span><span>的新字段</span><span style=color:#ed9366;background-color:#61676c10>`scroll_position`</span><span>中
</span></code></pre><p><strong>变更原因</strong>：提供迁移指南，帮助用户适应滚动位置处理的变化<h2 id=kuo-zhan-yue-du>扩展阅读</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://crates.io/crates/taffy target=_blank>Taffy布局引擎文档</a> - 了解Bevy使用的底层布局系统<li><a rel="noopener nofollow noreferrer" href=https://developer.mozilla.org/en-US/docs/Web/CSS/overflow target=_blank>CSS Overflow属性</a> - 理解overflow: scroll行为的标准实现<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/features/ui/ target=_blank>Bevy UI系统架构</a> - 官方UI系统概览<li><a rel="noopener nofollow noreferrer" href=https://developer.apple.com/design/human-interface-guidelines/ios/visual-design/adaptivity-and-layout/ target=_blank>逻辑像素与物理像素</a> - 理解不同DPI环境下的尺寸处理</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-07/pr_20093.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>