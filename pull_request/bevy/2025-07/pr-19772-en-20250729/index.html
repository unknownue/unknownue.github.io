<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19772 Fix intermittent drag-and-drop freezing on Windows
        
    </title><meta content="#19772 Fix intermittent drag-and-drop freezing on Windows" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-07/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-07-29</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-07/pr-19772-zh-cn-20250729>中文</a></div></div><div class=pr-content><h3 id=fix-intermittent-drag-and-drop-freezing-on-windows>Fix intermittent drag-and-drop freezing on Windows</h3><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix intermittent drag-and-drop freezing on Windows<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19772<li><strong>Author</strong>: zachbateman<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Windowing, O-Windows, S-Ready-For-Final-Review, P-Regression<li><strong>Created</strong>: 2025-06-21T20:34:42Z<li><strong>Merged</strong>: 2025-07-29T21:29:18Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Fixes #19030.<p>Since Bevy 0.15.3, there has been a bug on Windows where drag-and-drop will occasionally freeze the application where the only fix is to resize the window.<h2 id=solution>Solution</h2><p>This adds a check for any window events being received when determining if a redraw is requested—specifically on Windows. A drag-and-drop event sets the <code>self.window_event_received</code> flag to true.<p>For non-Windows platforms, <code>self.redraw_requested(event_loop)</code> is always called, but the Windows-specific branch has checks that for some reason sometimes don’t properly handle a drag-and-drop event (and maybe other types of events?).<p>I also tried replacing all of the <code>WINIT_WINDOWS.with_borrow(...)</code> with just <code>self.redraw_requested(event_loop)</code>, and that fixes the problem too (and then matches the non-Windows behavior), but I assume the Windows-specific checks are otherwise there for a reason.<p><strong>Note</strong>: I’m not sure why the freeze only sometimes occurred. This change fixes the specific drag-and-drop freeze problem, but there may be some sort of deeper bug/issue causing the strange behavior in the first place.<h2 id=testing>Testing</h2><p>I could replicate the intermittent freeze on Windows 11 in the drag-and-drop example, and this change seems to fully fix that problem.<hr><h2 id=showcase>Showcase</h2><p>Here is the existing intermittent freeze in action before the fix. While there is nothing in the drag-and-drop example window, the whole application is completely frozen until the window is resized.<p>https://github.com/user-attachments/assets/0d64b21c-a843-4b4e-8b6c-8bc5d6f9dfbe<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h4 id=problem-identification>Problem Identification</h4><p>The core issue addressed in this PR (#19772) was an intermittent application freeze during drag-and-drop operations on Windows systems. Since Bevy 0.15.3, users reported that drag-and-drop interactions would occasionally cause the application to lock up completely. The only workaround was manually resizing the window, which was clearly unacceptable for production use. This was identified as a regression (P-Regression label) affecting specifically Windows windowing (O-Windows, A-Windowing).<p>The root cause was traced to how Bevy’s winit integration handled redraw requests after window events. On Windows, the event loop wasn’t being properly woken up when drag-and-drop events occurred. This happened because the condition for requesting redraws didn’t account for window events like drag-and-drop, leaving the application in a frozen state until another event (like window resize) forced a redraw.<h4 id=solution-approach>Solution Approach</h4><p>The solution modifies the redraw condition logic to include a check for <code>window_event_received</code> - a flag that’s set whenever any window event occurs. This ensures drag-and-drop events properly trigger redraw requests. The developer considered a more extensive change (removing Windows-specific redraw checks entirely to match non-Windows behavior) but opted for the minimal targeted fix to avoid potential side effects from broader architectural changes.<p>The implementation specifically:<ol><li>Leverages the existing <code>window_event_received</code> flag set during window event processing<li>Adds this flag to the conditional that determines whether to request a redraw<li>Maintains all other existing conditions (startup updates, headless mode, etc.)</ol><h4 id=technical-implementation>Technical Implementation</h4><p>The change is isolated to the Windows-specific event handling branch in <code>state.rs</code>. The key modification expands the conditional that determines when to request a redraw:<pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>if !exiting
</span><span style=color:#f07171>-    && (self.startup_forced_updates > 0 || headless || all_invisible || reactive)
</span><span style=color:#86b300>+    && (self.startup_forced_updates > 0
</span><span style=color:#86b300>+        || headless
</span><span style=color:#86b300>+        || all_invisible
</span><span style=color:#86b300>+        || reactive
</span><span style=color:#86b300>+        || self.window_event_received)
</span></code></pre><p>This change ensures that when any window event (including drag-and-drop) occurs (<code>window_event_received = true</code>), the application will request a redraw through <code>self.redraw_requested(event_loop)</code>. The flag is reset at the start of each frame, ensuring subsequent events will trigger new redraws.<h4 id=technical-insights>Technical Insights</h4><p>The fix works because:<ol><li>Drag-and-drop events are processed as window events in winit<li>These events don’t inherently request redraws in Bevy’s Windows event handling<li>The <code>window_event_received</code> flag acts as a proxy for “window state has changed”<li>Including it in the redraw condition forces the event loop to process pending events</ol><p>The intermittent nature of the bug suggests Windows event sequencing or timing dependencies. While this fix addresses the symptom, further investigation might be needed to understand why Windows requires this additional trigger when other platforms don’t.<h4 id=impact-and-testing>Impact and Testing</h4><p>The change resolves the specific drag-and-drop freeze while maintaining existing optimization conditions. Testing confirmed:<ol><li>Reproduction of freeze in drag-and-drop example (Windows 11)<li>Complete resolution after applying the fix<li>No observable performance regression</ol><p>The minimal change scope reduces risk while solving a critical user-facing issue. It preserves the existing Windows-specific redraw optimizations while closing the gap for window events that require immediate processing.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Window Event\n(e.g. Drag-and-Drop)] --> B[Set window_event_received=true]
</span><span>    B --> C{Redraw Condition Check}
</span><span>    C -->|Condition Met| D[Request Redraw]
</span><span>    D --> E[Event Loop Processes Events]
</span><span>    E --> F[Reset window_event_received]
</span><span>    C -->|Condition Not Met| G[Application Freezes]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-winit-src-state-rs><code>crates/bevy_winit/src/state.rs</code></h3><p><strong>Changes</strong>: Added <code>window_event_received</code> to redraw condition<br> <strong>Purpose</strong>: Ensures drag-and-drop events properly trigger redraw requests on Windows<br> <strong>Relation to PR</strong>: Core fix for intermittent freeze issue<p><strong>Code Diff</strong>:<pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span style=color:#c594c5>@@ -529,7 +529,11 @@ </span><span style=color:#399ee6>impl&LTT: BufferedEvent> ApplicationHandler&LTT> for WinitAppRunnerState&LTT> {
</span><span>                     .iter()
</span><span>                     .all(|(_, w)| !w.is_visible().unwrap_or(false));
</span><span>                 if !exiting
</span><span style=color:#f07171>-                    && (self.startup_forced_updates > 0 || headless || all_invisible || reactive)
</span><span style=color:#86b300>+                    && (self.startup_forced_updates > 0
</span><span style=color:#86b300>+                        || headless
</span><span style=color:#86b300>+                        || all_invisible
</span><span style=color:#86b300>+                        || reactive
</span><span style=color:#86b300>+                        || self.window_event_received)
</span><span>                 {
</span><span>                     self.redraw_requested(event_loop);
</span><span>                 }
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/winit/latest/winit/event/enum.WindowEvent.html target=_blank>winit WindowEvent documentation</a> - Details window event types including drag-and-drop<li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_winit/latest/bevy_winit/struct.WinitSettings.html#method.with_redraw_requested target=_blank>Bevy RedrawRequested documentation</a> - How Bevy handles redraw requests<li><a rel="noopener nofollow noreferrer" href=https://learn.microsoft.com/en-us/windows/win32/winmsg/about-messages-and-message-queues target=_blank>Windows message loop architecture</a> - Background on Windows event handling<li>Original issue: <a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/issues/19030 target=_blank>#19030</a> - Detailed bug reports and discussion</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-07/pr_19772.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>