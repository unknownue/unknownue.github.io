<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20199 Remove extraneous h parameter for D_GGX
        
    </title><meta content="#20199 Remove extraneous h parameter for D_GGX" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-07/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-07-19</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-07/pr-20199-zh-cn-20250719>中文</a></div></div><div class=pr-content><h1 id=remove-extraneous-h-parameter-for-d-ggx>Remove extraneous h parameter for D_GGX</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Remove extraneous h parameter for D_GGX<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20199<li><strong>Author</strong>: JMS55<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: D-Trivial, A-Rendering, C-Code-Quality<li><strong>Created</strong>: 2025-07-19T15:42:19Z<li><strong>Merged</strong>: 2025-07-19T18:35:51Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><p>Remove an unused function parameter.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The PR addresses a straightforward code quality issue in Bevy’s physically based rendering (PBR) implementation. During routine shader maintenance, the author noticed that the <code>D_GGX</code> function in the PBR lighting calculations contained an unused parameter. This function computes the GGX normal distribution function, a core component of the PBR specular BRDF.<p>The <code>h</code> parameter (representing the half-vector) was present in the function signature but never actually used in the implementation. This extraneous parameter added unnecessary complexity to the shader code and could confuse developers working on the rendering pipeline. Since shader code needs to be highly optimized and maintainable, removing dead parameters helps reduce cognitive load and prevents potential misuse.<p>The solution was simple and non-disruptive: remove the unused <code>h</code> parameter from the <code>D_GGX</code> function signature and update all call sites to stop passing this argument. This change required modifications to three lines of WGSL shader code. The function’s mathematical implementation remained unchanged since the unused parameter didn’t affect the output.<p>The implementation demonstrates good code hygiene practices. By removing dead parameters:<ol><li>The function signature more accurately reflects its actual dependencies<li>Call sites become simpler with fewer arguments to pass<li>Future maintenance becomes easier with reduced surface area for errors<li>Shader execution remains identical since the parameter wasn’t used</ol><p>The change is safe because it doesn’t alter the rendering mathematics. The GGX distribution calculation only requires the roughness and NdotH (cosine of angle between normal and half-vector) parameters, not the full half-vector itself. This aligns with the standard GGX formulation where the distribution depends only on the angle, not the vector components.<p>This cleanup improves code clarity without affecting rendering output. It was quickly reviewed and merged as a trivial but valuable code quality improvement.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    D_GGX[Function: D_GGX&LTbr>Computes GGX distribution] -->|Called by| specular[specular function]
</span><span>    D_GGX -->|Called by| specular_clearcoat[specular_clearcoat function]
</span><span>    style D_GGX stroke:#338,stroke-width:2px
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=file-crates-bevy-pbr-src-render-pbr-lighting-wgsl>File: crates/bevy_pbr/src/render/pbr_lighting.wgsl</h3><p>This file contains the core WGSL shader code for PBR lighting calculations. The changes remove an unused parameter from the D_GGX normal distribution function.<h4 id=key-changes>Key Changes:</h4><ol><li><strong>Function signature update</strong>:</ol><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>fn D_GGX(roughness: f32, NdotH: f32, h: vec3&LTf32>) -> f32 {
</span><span>    // Implementation...
</span><span>}
</span><span>
</span><span>// After:
</span><span>fn D_GGX(roughness: f32, NdotH: f32) -> f32 {
</span><span>    // Same implementation without 'h' parameter
</span><span>}
</span></code></pre><ol start=2><li><strong>Call site updates in specular functions</strong>:</ol><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>let D = D_GGX(roughness, NdotH, H);
</span><span>
</span><span>// After:
</span><span>let D = D_GGX(roughness, NdotH);
</span></code></pre><ol start=3><li><strong>Removed variable declarations</strong>:</ol><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Removed from both specular and specular_clearcoat:
</span><span>let H = (*derived_input).H;
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://google.github.io/filament/Filament.html target=_blank>Filament PBR Documentation</a> - Reference implementation of GGX distribution<li><a rel="noopener nofollow noreferrer" href=https://www.pbr-book.org/ target=_blank>Physically Based Rendering: From Theory to Implementation</a> - Comprehensive resource on PBR theory<li><a rel="noopener nofollow noreferrer" href=https://gpuweb.github.io/gpuweb/wgsl/ target=_blank>WGSL Specification</a> - Official WebGPU Shading Language docs</ol><h2 id=full-code-diff>Full Code Diff</h2><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_pbr/src/render/pbr_lighting.wgsl b/crates/bevy_pbr/src/render/pbr_lighting.wgsl
</span><span>index 6bc24d8af01d6..09329b900750b 100644
</span><span style=color:#c594c5>--- a/crates/bevy_pbr/src/render/pbr_lighting.wgsl
</span><span style=color:#c594c5>+++ b/crates/bevy_pbr/src/render/pbr_lighting.wgsl
</span><span style=color:#c594c5>@@ -137,7 +137,7 @@ </span><span style=color:#399ee6>fn getDistanceAttenuation(distanceSquare: f32, inverseRangeSquared: f32) -> f32
</span><span> 
</span><span> // Simple implementation, has precision problems when using fp16 instead of fp32
</span><span> // see https://google.github.io/filament/Filament.html#listing_speculardfp16
</span><span style=color:#f07171>-fn D_GGX(roughness: f32, NdotH: f32, h: vec3&LTf32>) -> f32 {
</span><span style=color:#86b300>+fn D_GGX(roughness: f32, NdotH: f32) -> f32 {
</span><span>     let oneMinusNdotHSquared = 1.0 - NdotH * NdotH;
</span><span>     let a = NdotH * roughness;
</span><span>     let k = roughness / (oneMinusNdotHSquared + a * a);
</span><span style=color:#c594c5>@@ -313,13 +313,12 @@ </span><span style=color:#399ee6>fn specular(
</span><span>     let roughness = (*input).layers[LAYER_BASE].roughness;
</span><span>     let NdotV = (*input).layers[LAYER_BASE].NdotV;
</span><span>     let F0 = (*input).F0_;
</span><span style=color:#f07171>-    let H = (*derived_input).H;
</span><span>     let NdotL = (*derived_input).NdotL;
</span><span>     let NdotH = (*derived_input).NdotH;
</span><span>     let LdotH = (*derived_input).LdotH;
</span><span> 
</span><span>     // Calculate distribution.
</span><span style=color:#f07171>-    let D = D_GGX(roughness, NdotH, H);
</span><span style=color:#86b300>+    let D = D_GGX(roughness, NdotH);
</span><span>     // Calculate visibility.
</span><span>     let V = V_SmithGGXCorrelated(roughness, NdotV, NdotL);
</span><span>     // Calculate the Fresnel term.
</span><span style=color:#c594c5>@@ -343,12 +342,11 @@ </span><span style=color:#399ee6>fn specular_clearcoat(
</span><span> ) -> vec2&LTf32> {
</span><span>     // Unpack.
</span><span>     let roughness = (*input).layers[LAYER_CLEARCOAT].roughness;
</span><span style=color:#f07171>-    let H = (*derived_input).H;
</span><span>     let NdotH = (*derived_input).NdotH;
</span><span>     let LdotH = (*derived_input).LdotH;
</span><span> 
</span><span>     // Calculate distribution.
</span><span style=color:#f07171>-    let Dc = D_GGX(roughness, NdotH, H);
</span><span style=color:#86b300>+    let Dc = D_GGX(roughness, NdotH);
</span><span>     // Calculate visibility.
</span><span>     let Vc = V_Kelemen(LdotH);
</span><span>     // Calculate the Fresnel term.
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-07/pr_20199.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>