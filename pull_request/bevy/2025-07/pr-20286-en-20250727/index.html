<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20286 Fix webgl2
        
    </title><meta content="#20286 Fix webgl2" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-07/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-07-27</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-07/pr-20286-zh-cn-20250727>中文</a></div></div><div class=pr-content><h1 id=fix-webgl2>Fix webgl2</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix webgl2<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20286<li><strong>Author</strong>: atlv24<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, P-Crash, S-Ready-For-Final-Review, P-Regression, O-WebGL2<li><strong>Created</strong>: 2025-07-25T14:55:37Z<li><strong>Merged</strong>: 2025-07-27T20:01:21Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>https://github.com/bevyengine/bevy/pull/19076#issuecomment-3116832714 broke webgl2 and bloated binary size by a megabyte<li>Fixes #20276</ul><h2 id=solution>Solution</h2><ul><li>Don’t embed stbn.ktx2, just load it for now<li>Gate gen env maps by limit checks<li>Extract a plugin to do this cleanly<li>Only load stbn.ktx2 when its needed</ul><h2 id=testing>Testing</h2><ul><li>reflection_probes example<li>someone please test webgl2</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a regression introduced by #19076 that broke WebGL2 support and increased binary size by approximately 1MB. The root cause was the unconditional embedding of the stbn.ktx2 blue noise texture used for environment map generation. Since WebGL2 doesn’t support compute shaders or storage textures required for environment map generation, this caused crashes. Additionally, embedding the 1MB texture bloated binary sizes for all users regardless of whether they used environment maps.<p>The solution involves three main technical changes. First, we replace unconditional embedding with conditional loading of the blue noise texture. The texture is now only loaded when the <code>bluenoise_texture</code> feature is enabled, which is controlled through Cargo.toml:<pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span># Cargo.toml
</span><span>[features]
</span><span style=color:#86b300>+bluenoise_texture = [
</span><span style=color:#86b300>+  "bevy_internal/bluenoise_texture",
</span><span style=color:#86b300>+  "ktx2",
</span><span style=color:#86b300>+  "bevy_image/zstd",
</span><span style=color:#86b300>+]
</span></code></pre><p>In the PBR plugin initialization, we now check for hardware capabilities before initializing environment map generation systems. We first verify if the render world already has the Bluenoise resource to avoid duplicate loading:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// In PbrPlugin build()
</span><span style=color:#fa6e32>let</span><span> has_bluenoise </span><span style=color:#ed9366>=</span><span> app</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_sub_app</span><span>(RenderApp)</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_some_and</span><span>(|</span><span style=color:#ff8f40>render_app</span><span>| 
</span><span>    render_app</span><span style=color:#ed9366>.</span><span style=color:#f07171>world</span><span>()</span><span style=color:#ed9366>.</span><span>is_resource_added</span><span style=color:#ed9366>::</span><span>&LTBluenoise>()
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><p>If the resource doesn’t exist, we conditionally load the texture based on the feature flag. When the feature is enabled, we decode the embedded KTX2 texture. Otherwise, we generate a 1x1 magenta placeholder texture:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>has_bluenoise {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> images </span><span style=color:#ed9366>=</span><span> app</span><span style=color:#ed9366>.</span><span style=color:#f07171>world_mut</span><span>()</span><span style=color:#ed9366>.</span><span>resource_mut</span><span style=color:#ed9366>::</span><span>&LTAssets&LTImage>>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"bluenoise_texture"</span><span>)]
</span><span>    </span><span style=color:#fa6e32>let</span><span> handle </span><span style=color:#ed9366>= </span><span>{
</span><span>        </span><span style=color:#fa6e32>let</span><span> image </span><span style=color:#ed9366>= </span><span>Image</span><span style=color:#ed9366>::</span><span>from_buffer(
</span><span>            </span><span style=color:#f07171>include_bytes!</span><span>(</span><span style=color:#86b300>"bluenoise/stbn.ktx2"</span><span>)</span><span style=color:#61676ccc>,
</span><span>            ImageType</span><span style=color:#ed9366>::</span><span>Extension(</span><span style=color:#86b300>"ktx2"</span><span>)</span><span style=color:#61676ccc>,
</span><span>            CompressedImageFormats</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>NONE</span><span style=color:#61676ccc>,
</span><span>            </span><span style=color:#ff8f40>false</span><span style=color:#61676ccc>,
</span><span>            ImageSampler</span><span style=color:#ed9366>::</span><span>Default</span><span style=color:#61676ccc>,
</span><span>            RenderAssetUsages</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>RENDER_WORLD</span><span style=color:#61676ccc>,
</span><span>        )</span><span style=color:#61676ccc>;
</span><span>        images</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(image)
</span><span>    }</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(</span><span style=color:#f29718>not</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"bluenoise_texture"</span><span>))]
</span><span>    </span><span style=color:#fa6e32>let</span><span> handle </span><span style=color:#ed9366>=</span><span> images</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(</span><span style=color:#f07171>stbn_placeholder</span><span>())</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>The second key change extracts environment map generation into a dedicated plugin (<code>EnvironmentMapGenerationPlugin</code>). This plugin performs hardware capability checks during initialization to ensure compute shader support exists before setting up systems:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>impl </span><span>Plugin </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>EnvironmentMapGenerationPlugin </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>finish</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>app</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> App) {
</span><span>        </span><span style=color:#fa6e32>let</span><span> render_app </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>match</span><span> app</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_sub_app_mut</span><span>(RenderApp) {
</span><span>            </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(app) </span><span style=color:#ed9366>=></span><span> app</span><span style=color:#61676ccc>,
</span><span>            </span><span style=color:#55b4d4;font-style:italic>None </span><span style=color:#ed9366>=> </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>,
</span><span>        }</span><span style=color:#61676ccc>;
</span><span>        
</span><span>        </span><span style=color:#fa6e32>let</span><span> adapter </span><span style=color:#ed9366>=</span><span> render_app</span><span style=color:#ed9366>.</span><span style=color:#f07171>world</span><span>()</span><span style=color:#ed9366>.</span><span>resource</span><span style=color:#ed9366>::</span><span>&LTRenderAdapter>()</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#fa6e32>let</span><span> device </span><span style=color:#ed9366>=</span><span> render_app</span><span style=color:#ed9366>.</span><span style=color:#f07171>world</span><span>()</span><span style=color:#ed9366>.</span><span>resource</span><span style=color:#ed9366>::</span><span>&LTRenderDevice>()</span><span style=color:#61676ccc>;
</span><span>        
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// Check storage texture support (required for cubemap SPD)
</span><span>        </span><span style=color:#fa6e32>let</span><span> limit_support </span><span style=color:#ed9366>=</span><span> device</span><span style=color:#ed9366>.</span><span style=color:#f07171>limits</span><span>()</span><span style=color:#ed9366>.</span><span>max_storage_textures_per_shader_stage </span><span style=color:#ed9366>>= </span><span style=color:#ff8f40>6
</span><span>            </span><span style=color:#ed9366>&&</span><span> device</span><span style=color:#ed9366>.</span><span style=color:#f07171>limits</span><span>()</span><span style=color:#ed9366>.</span><span>max_compute_workgroup_storage_size </span><span style=color:#ed9366>!= </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;
</span><span>            
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// Check compute shader support
</span><span>        </span><span style=color:#fa6e32>let</span><span> downlevel_support </span><span style=color:#ed9366>=</span><span> adapter</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_downlevel_capabilities</span><span>()
</span><span>            </span><span style=color:#ed9366>.</span><span>flags
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>contains</span><span>(DownlevelFlags</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>COMPUTE_SHADERS</span><span>)</span><span style=color:#61676ccc>;
</span><span>            
</span><span>        </span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>limit_support </span><span style=color:#ed9366>|| !</span><span>downlevel_support {
</span><span>            </span><span style=color:#f07171>info!</span><span>(</span><span style=color:#86b300>"Disabling EnvironmentMapGenerationPlugin..."</span><span>)</span><span style=color:#61676ccc>;
</span><span>            </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>        
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// Proceed with system setup if supported
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>    }
</span><span>}
</span></code></pre><p>Third, we modify the environment filtering shader to provide a fallback when the blue noise texture isn’t available. This uses a simple pseudo-random number generator instead of sampling from the texture:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// environment_filter.wgsl
</span><span>#ifdef HAS_BLUE_NOISE
</span><span>// Original blue noise sampling
</span><span>#else
</span><span>// Fallback PRNG
</span><span>fn sample_noise(pixel_coords: vec2u) -> vec4f {
</span><span>    var rng_state: u32 = (pixel_coords.x * 3966231743u) ^ 
</span><span>                         (pixel_coords.y * 3928936651u);
</span><span>    let rnd = rand_vec2f(&rng_state);
</span><span>    return vec4f(rnd, 0.0, 0.0);
</span><span>}
</span><span>#endif
</span></code></pre><p>The <code>HAS_BLUE_NOISE</code> define is set during pipeline creation when the feature is enabled:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// In pipeline setup
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"bluenoise_texture"</span><span>)]
</span><span>shader_defs</span><span style=color:#ed9366>.</span><span style=color:#f07171>push</span><span>(ShaderDefVal</span><span style=color:#ed9366>::</span><span>Int(</span><span style=color:#86b300>"HAS_BLUE_NOISE"</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>1</span><span>))</span><span style=color:#61676ccc>;
</span></code></pre><p>These changes collectively fix the WebGL2 crash by skipping environment map initialization on unsupported platforms, reduce binary size by ~1MB when not using the feature, and maintain functionality for users who need environment maps. The solution demonstrates good practice in conditional resource loading, hardware capability checks, and graceful fallbacks for unsupported platforms.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[PbrPlugin] --> B[Check Bluenoise Resource]
</span><span>    B -->|Missing| C[Load Texture]
</span><span>    C --> D{bluenoise_texture feature?}
</span><span>    D -->|Yes| E[Load stbn.ktx2]
</span><span>    D -->|No| F[Create Placeholder]
</span><span>    A --> G[EnvironmentMapGenerationPlugin]
</span><span>    G --> H{Compute Supported?}
</span><span>    H -->|Yes| I[Initialize Systems]
</span><span>    H -->|No| J[Skip Initialization]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-pbr-src-lib-rs-60-9><code>crates/bevy_pbr/src/lib.rs</code> (+60/-9)</h3><p>Modified texture loading logic to conditionally include stbn.ktx2 based on feature flag. Added placeholder texture generation for fallback.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Unconditional embedding
</span><span style=color:#f07171>embedded_asset!</span><span>(app</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"stbn.ktx2"</span><span>)</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> bluenoise_texture </span><span style=color:#ed9366>= </span><span style=color:#f07171>load_embedded_asset!</span><span>(app</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"stbn.ktx2"</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Conditional loading
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"bluenoise_texture"</span><span>)]
</span><span style=color:#fa6e32>let</span><span> handle </span><span style=color:#ed9366>= </span><span>{ </span><span style=color:#abb0b6;font-style:italic>/* load KTX2 */ </span><span>}</span><span style=color:#61676ccc>;
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(</span><span style=color:#f29718>not</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"bluenoise_texture"</span><span>))]
</span><span style=color:#fa6e32>let</span><span> handle </span><span style=color:#ed9366>=</span><span> images</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(</span><span style=color:#f07171>stbn_placeholder</span><span>())</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-pbr-src-light-probe-generate-rs-97-8><code>crates/bevy_pbr/src/light_probe/generate.rs</code> (+97/-8)</h3><p>Extracted environment map generation into a plugin with hardware capability checks.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// New plugin structure
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>EnvironmentMapGenerationPlugin</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>impl </span><span>Plugin </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>EnvironmentMapGenerationPlugin </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>finish</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>app</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> App) {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// Hardware capability checks
</span><span>        </span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span style=color:#f07171>device_supports_compute</span><span>(render_app) {
</span><span>            </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// Skip initialization
</span><span>        }
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// Setup systems and render graph...
</span><span>    }
</span><span>}
</span></code></pre><h3 id=crates-bevy-pbr-src-light-probe-mod-rs-11-54><code>crates/bevy_pbr/src/light_probe/mod.rs</code> (+11/-54)</h3><p>Integrated the new environment map generation plugin and removed redundant setup code.<pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span> impl Plugin for LightProbePlugin {
</span><span>     fn build(&self, app: &mut App) {
</span><span style=color:#f07171>-        // Old environment map setup code
</span><span style=color:#86b300>+        app.add_plugins(EnvironmentMapGenerationPlugin);
</span><span>     }
</span><span> }
</span></code></pre><h3 id=crates-bevy-pbr-src-light-probe-environment-filter-wgsl-10-1><code>crates/bevy_pbr/src/light_probe/environment_filter.wgsl</code> (+10/-1)</h3><p>Added conditional compilation for blue noise sampling with fallback PRNG.<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before: Single implementation
</span><span>fn sample_noise(pixel_coords: vec2u) -> vec4f { /* ... */ }
</span><span>
</span><span>// After: Conditional implementation
</span><span>#ifdef HAS_BLUE_NOISE
</span><span>// Blue noise sampling
</span><span>#else
</span><span>// PRNG fallback
</span><span>#endif
</span></code></pre><h3 id=cargo-toml-7-0><code>Cargo.toml</code> (+7/-0)</h3><p>Added feature flag for conditional inclusion of blue noise texture.<pre class=language-toml data-lang=toml style=color:#61676c;background-color:#fafafa><code class=language-toml data-lang=toml><span>[</span><span style=color:#399ee6>features</span><span>]
</span><span style=color:#399ee6>bluenoise_texture </span><span>= [
</span><span>  </span><span style=color:#86b300>"bevy_internal/bluenoise_texture"</span><span style=color:#61676ccc>,
</span><span>  </span><span style=color:#86b300>"ktx2"</span><span style=color:#61676ccc>,
</span><span>  </span><span style=color:#86b300>"bevy_image/zstd"</span><span style=color:#61676ccc>,
</span><span>]
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://www.khronos.org/registry/webgl/specs/latest/2.0/ target=_blank>WebGL 2.0 Specification</a> - Reference for WebGL2 capabilities<li><a rel="noopener nofollow noreferrer" href=https://gpuweb.github.io/gpuweb/wgsl/ target=_blank>WGSL Shader Language</a> - WebGPU Shading Language documentation<li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/reference/conditional-compilation.html target=_blank>Conditional Compilation in Rust</a> - Official Rust documentation on <code>#[cfg]</code> attributes<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/getting-started/rendering/ target=_blank>Bevy Render Pipeline Architecture</a> - Overview of Bevy’s rendering system</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-07/pr_20286.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>