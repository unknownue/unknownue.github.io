<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19357 SpatialListener now requires a Transform
        
    </title><meta content="#19357 SpatialListener now requires a Transform" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-07/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-07-07</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-07/pr-19357-zh-cn-20250707>中文</a></div></div><div class=pr-content><h2 id=spatiallistener-now-requires-a-transform>SpatialListener now requires a Transform</h2><h3 id=basic-information>Basic Information</h3><ul><li><strong>Title</strong>: SpatialListener now requires a Transform<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19357<li><strong>Author</strong>: Wuketuke<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-ECS, A-Audio, C-Usability, S-Ready-For-Final-Review, D-Straightforward<li><strong>Created</strong>: 2025-05-24T14:40:42Z<li><strong>Merged</strong>: 2025-07-07T20:08:16Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h3 id=description-translation>Description Translation</h3><p>I noticed that the <code>SpatialListener</code> asks to have a <code>Transform</code> attached. It seemed weird that we didnt just use a require macro, so i went ahead and did that.<br> I also tweaked the system that plays audio to use a <code>&GlobalTransform</code> instead of an <code>Option<&GlobalTransform></code><h3 id=the-story-of-this-pull-request>The Story of This Pull Request</h3><p>The PR addresses inconsistencies in Bevy’s audio system regarding component requirements and data handling. The core issue was that <code>SpatialListener</code> documentation stated it needed a <code>Transform</code> component, but this requirement wasn’t enforced in code. This created a potential runtime error scenario where audio systems could fail if the transform was missing.<p>First, the PR enforces the transform requirement using Bevy’s <code>#[require]</code> attribute macro. This automatically adds a <code>Transform</code> component if missing and ensures queries including <code>SpatialListener</code> will always have a transform available. The documentation was updated to clarify this requirement:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component</span><span style=color:#61676ccc>,</span><span> Clone</span><span style=color:#61676ccc>,</span><span> Debug</span><span style=color:#61676ccc>,</span><span> Reflect)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>reflect</span><span>(Clone</span><span style=color:#61676ccc>,</span><span> Default</span><span style=color:#61676ccc>,</span><span> Component</span><span style=color:#61676ccc>,</span><span> Debug)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>SpatialListener </span><span>{ ... }
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component</span><span style=color:#61676ccc>,</span><span> Clone</span><span style=color:#61676ccc>,</span><span> Debug</span><span style=color:#61676ccc>,</span><span> Reflect)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>require</span><span>(Transform)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>reflect</span><span>(Clone</span><span style=color:#61676ccc>,</span><span> Default</span><span style=color:#61676ccc>,</span><span> Component</span><span style=color:#61676ccc>,</span><span> Debug)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>SpatialListener </span><span>{ ... }
</span></code></pre><p>Second, the audio playback system was modified to leverage this new guarantee. Previously, it handled transforms as optional and fell back to zero coordinates with a warning when missing. This created unnecessary branching and potential unexpected behavior. The PR simplifies the system by requiring a <code>GlobalTransform</code> reference instead of an <code>Option</code>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#ed9366>&</span><span>GlobalTransform>
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#ed9366>&</span><span>GlobalTransform
</span></code></pre><p>The fallback code was completely removed since the transform requirement is now guaranteed at the component level. This also eliminated a warning that would log when transforms were missing:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Removed code:
</span><span style=color:#fa6e32>let</span><span> emitter_translation </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(emitter_transform) </span><span style=color:#ed9366>=</span><span> maybe_emitter_transform {
</span><span>    (emitter_transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>translation</span><span>() </span><span style=color:#ed9366>*</span><span> scale)</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()
</span><span>} </span><span style=color:#fa6e32>else </span><span>{
</span><span>    </span><span style=color:#f07171>warn!</span><span>(</span><span style=color:#86b300>"Spatial AudioPlayer with no GlobalTransform component. Using zero."</span><span>)</span><span style=color:#61676ccc>;
</span><span>    Vec3</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ZERO</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()
</span><span>}</span><span style=color:#61676ccc>;
</span></code></pre><p>These changes improve data consistency by ensuring spatial audio calculations always have valid position data. The component requirement is now explicit in the type system rather than just documentation. This eliminates an entire class of potential runtime errors related to missing transforms.<p>The PR also included minor documentation improvements for better clarity, such as converting comments to use Markdown links for API references and clarifying playback behavior constraints.<h3 id=visual-representation>Visual Representation</h3><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    SpatialListener -- requires --> Transform
</span><span>    Transform -- propagates to --> GlobalTransform
</span><span>    AudioSystem -- consumes --> GlobalTransform
</span></code></pre><h3 id=key-files-changed>Key Files Changed</h3><ol><li><strong>crates/bevy_audio/src/audio.rs</strong> (+18/-16)<br> Enforced transform requirement and improved documentation</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component</span><span style=color:#61676ccc>,</span><span> Clone</span><span style=color:#61676ccc>,</span><span> Debug</span><span style=color:#61676ccc>,</span><span> Reflect)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>reflect</span><span>(Clone</span><span style=color:#61676ccc>,</span><span> Default</span><span style=color:#61676ccc>,</span><span> Component</span><span style=color:#61676ccc>,</span><span> Debug)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>SpatialListener </span><span>{ ... }
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component</span><span style=color:#61676ccc>,</span><span> Clone</span><span style=color:#61676ccc>,</span><span> Debug</span><span style=color:#61676ccc>,</span><span> Reflect)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>require</span><span>(Transform)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>reflect</span><span>(Clone</span><span style=color:#61676ccc>,</span><span> Default</span><span style=color:#61676ccc>,</span><span> Component</span><span style=color:#61676ccc>,</span><span> Debug)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>SpatialListener </span><span>{ ... }
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Documentation improvements:
</span><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#abb0b6;font-style:italic>/// This must be accompanied by `Transform` and `GlobalTransform`.
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#abb0b6;font-style:italic>/// This is accompanied by [`Transform`] and [`GlobalTransform`].
</span></code></pre><ol start=2><li><strong>crates/bevy_audio/src/audio_output.rs</strong> (+3/-10)<br> Simplified audio system by removing optional transform handling</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Query change:
</span><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#ed9366>&</span><span>GlobalTransform>
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#ed9366>&</span><span>GlobalTransform
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Removed fallback logic:
</span><span style=color:#ed9366>- </span><span style=color:#fa6e32>let</span><span> emitter_translation </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(emitter_transform) </span><span style=color:#ed9366>=</span><span> maybe_emitter_transform {
</span><span style=color:#ed9366>-     </span><span>(emitter_transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>translation</span><span>() </span><span style=color:#ed9366>*</span><span> scale)</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()
</span><span style=color:#ed9366>- </span><span>} </span><span style=color:#fa6e32>else </span><span>{
</span><span style=color:#ed9366>-     </span><span style=color:#f07171>warn!</span><span>(</span><span style=color:#86b300>"Spatial AudioPlayer with no GlobalTransform component. Using zero."</span><span>)</span><span style=color:#61676ccc>;
</span><span style=color:#ed9366>-     </span><span>Vec3</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ZERO</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()
</span><span style=color:#ed9366>- </span><span>}</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=further-reading>Further Reading</h3><ol><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_ecs/latest/bevy_ecs/query/trait.QueryFilter.html#method.require target=_blank>Bevy ECS Require Components</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/getting-started/transform/ target=_blank>Bevy Transform System</a><li><a rel="noopener nofollow noreferrer" href=https://developer.mozilla.org/en-US/docs/Web/API/Web_Audio_API/Web_audio_spatialization_basics target=_blank>Spatial Audio Concepts</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-07/pr_19357.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>