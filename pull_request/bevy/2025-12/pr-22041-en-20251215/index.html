<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22041 Use mesh bounds center for transparent/transmissive sorting
        
    </title><meta content="#22041 Use mesh bounds center for transparent/transmissive sorting" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-15</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22041-zh-cn-20251215>中文</a></div></div><div class=pr-content><h1 id=use-mesh-bounds-center-for-transparent-transmissive-sorting>Use mesh bounds center for transparent/transmissive sorting</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Use mesh bounds center for transparent/transmissive sorting<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22041<li><strong>Author</strong>: venhelhardt<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, S-Ready-For-Final-Review, D-Modest<li><strong>Created</strong>: 2025-12-05T23:14:50Z<li><strong>Merged</strong>: 2025-12-14T22:32:54Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description>Description</h2><p>Transparent and transmissive phases previously used the instance translation from GlobalTransform as the sort position. This breaks down when mesh geometry is authored in “world-like” coordinates and the instance transform is identity or near-identity (common in building/CAD-style content). In such cases multiple transparent instances end up with the same translation and produce incorrect draw order.<p>This change introduces sorting based on the world-space center of the mesh bounds instead of the raw translation. The local bounds center is stored per mesh/instance and transformed by the instance’s world transform when building sort keys. This adds a small amount of per-mesh/instance data but produces much more correct transparent and transmissive rendering in real-world scenes.<h1 id=objective>Objective</h1><p>Currently, transparent and transmissive render phases in Bevy sort instances using the translation from GlobalTransform. This works only if the mesh origin is a good proxy for the geometry position. In many real-world cases (especially CAD/architecture-like content), the mesh data is authored in “world-like” coordinates and the instance <code>Transform</code> is identity. In such setups, sorting by translation produces incorrect draw order for transparent/transmissive objects.<p>I propose switching the sorting key from <code>GlobalTransform.translation</code> to the world-space center of the mesh bounds for each instance.<h2 id=solution>Solution</h2><p>Instead of using <code>GlobalTransform.translation</code> as the sort position for transparent/transmissive phases, use the world-space center of the mesh bounds:<ol><li>Store the local-space bounds center for each render mesh (e.g. in something like <code>RenderMeshInstanceShared</code> as <code>center: Vec3</code> derived from the mesh <code>Aabb</code>).<li>For each instance, compute the world-space center by applying the instance transform.<li>Use this world-space center as the position for distance / depth computation in view space when building sort keys for transparent and transmissive phases.</ol><p>This way:<ul><li>Sorting respects the actual spatial position of the geometry<li>Instances with baked-in “world-like” coordinates inside the mesh are handled correctly<li>Draw order for transparent objects becomes much more stable and visually correct in real scenes</ul><p>The main trade-offs:<ul><li>Adding a Vec3 center in <code>RenderMeshInstanceShared</code> (typically +12 or +16 bytes depending on alignment),<li>For each instance, we need to transform the local bounds center into world space to compute the sort key.</ul><h3 id=alternative-approach-and-its-drawbacks>Alternative approach and its drawbacks</h3><p>In theory, this could be fixed by <strong>baking</strong> meshes so that:<ul><li>The mesh is recentered around its local bounding box center, and<li>The instance <code>Transform</code> is adjusted to move it back into place.</ul><p>However, this has several drawbacks:<ul><li>Requires modifying vertex data for each mesh (expensive and error-prone)<li>Requires either duplicating meshes or introducing one-off edits, which is bad for instancing and memory<li>Complicates asset workflows (tools, exporters, pipelines)<li>Still does not address dynamic or procedurally generated content</ul><p>In practice, this is not a scalable or convenient solution.<h3 id=secondary-issue-unstable-ordering-when-depth-is-equal>Secondary issue: unstable ordering when depth is equal</h3><p>There is another related problem with the current sorting: when two transparent/transmissive instances end up with the same view-space depth (for example, their centers project onto the same depth plane), the resulting draw order becomes unstable. This leads to visible flickering, because the internal order of <code>RenderEntity</code> items is not guaranteed to be stable between frames.<p>In practice this happens quite easily, especially when multiple transparent instances share the same or very similar sort depth, and their relative order in the extracted render list can change frame to frame.<p>To address this, I suggest extending the sort key with a deterministic tie-breaker, for example the entity’s main index. Conceptually, the sort key would become:<ul><li>primary: view-space depth (or distance),<li>secondary: stable per-entity index</ul><p>This ensures that instances with the same depth keep a consistent draw order across frames, removing flickering while preserving the intended depth-based sorting behavior.<h2 id=testing>Testing</h2><ul><li>Did you test these changes? If so, how?</ul><pre class=language-sh data-lang=sh style=color:#61676c;background-color:#fafafa><code class=language-sh data-lang=sh><span style=color:#f29718>cargo</span><span> run</span><span style=color:#ff8f40> -p</span><span> ci</span><span style=color:#ed9366> --</span><span> test
</span><span style=color:#f29718>cargo</span><span> run</span><span style=color:#ff8f40> -p</span><span> ci</span><span style=color:#ed9366> --</span><span> doc
</span><span style=color:#f29718>cargo</span><span> run</span><span style=color:#ff8f40> -p</span><span> ci</span><span style=color:#ed9366> --</span><span> compile
</span></code></pre><ul><li>Are there any parts that need more testing? Not sure<li>How can other people (reviewers) test your changes? Is there anything specific they need to know? Run this “example”</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>use </span><span>bevy</span><span style=color:#ed9366>::</span><span>{
</span><span>    camera_controller</span><span style=color:#ed9366>::</span><span>free_camera</span><span style=color:#ed9366>::</span><span>{FreeCamera</span><span style=color:#61676ccc>,</span><span> FreeCameraPlugin}</span><span style=color:#61676ccc>,
</span><span>    prelude</span><span style=color:#ed9366>::*</span><span style=color:#61676ccc>,
</span><span>}</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>main</span><span>() {
</span><span>    App</span><span style=color:#ed9366>::</span><span>new()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>add_plugins</span><span>(DefaultPlugins)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>add_plugins</span><span>(FreeCameraPlugin)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(Startup</span><span style=color:#61676ccc>,</span><span> setup)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(Update</span><span style=color:#61676ccc>,</span><span> view_orient)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>run</span><span>()</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>setup</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>meshes</span><span style=color:#61676ccc>: </span><span>ResMut&LTAssets&LTMesh>>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>materials</span><span style=color:#61676ccc>: </span><span>ResMut&LTAssets&LTStandardMaterial>>,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>let</span><span> material </span><span style=color:#ed9366>=</span><span> materials</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(StandardMaterial {
</span><span>        base_color</span><span style=color:#61676ccc>: </span><span>Color</span><span style=color:#ed9366>::</span><span>srgb_u8(</span><span style=color:#ff8f40>150</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>250</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>150</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>with_alpha</span><span>(</span><span style=color:#ff8f40>0.7</span><span>)</span><span style=color:#61676ccc>,
</span><span>        alpha_mode</span><span style=color:#61676ccc>: </span><span>AlphaMode</span><span style=color:#ed9366>::</span><span>Blend</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#ed9366>..</span><span style=color:#f07171>default</span><span>()
</span><span>    })</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> mesh </span><span style=color:#ed9366>= </span><span>Cuboid</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ff8f40>3.</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>3.</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>1.</span><span>)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>mesh</span><span>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>build</span><span>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>translated_by</span><span>(Vec3</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ff8f40>1.5</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>1.5</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.5</span><span>))</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Cuboids grids
</span><span>    </span><span style=color:#fa6e32>for</span><span> k </span><span style=color:#ed9366>in -</span><span style=color:#ff8f40>1</span><span style=color:#ed9366>..=</span><span style=color:#ff8f40>0 </span><span>{
</span><span>        </span><span style=color:#fa6e32>let</span><span> z_offset </span><span style=color:#ed9366>=</span><span> k </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32 </span><span style=color:#ed9366>* </span><span style=color:#ff8f40>3.</span><span style=color:#61676ccc>;
</span><span>
</span><span>        </span><span style=color:#fa6e32>for</span><span> i </span><span style=color:#ed9366>in </span><span style=color:#ff8f40>0</span><span style=color:#ed9366>..</span><span style=color:#ff8f40>3 </span><span>{
</span><span>            </span><span style=color:#fa6e32>let</span><span> x_offset </span><span style=color:#ed9366>=</span><span> i </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32 </span><span style=color:#ed9366>* </span><span style=color:#ff8f40>3.25</span><span style=color:#61676ccc>;
</span><span>
</span><span>            </span><span style=color:#fa6e32>for</span><span> j </span><span style=color:#ed9366>in </span><span style=color:#ff8f40>0</span><span style=color:#ed9366>..</span><span style=color:#ff8f40>3 </span><span>{
</span><span>                </span><span style=color:#fa6e32>let</span><span> y_offset </span><span style=color:#ed9366>=</span><span> j </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32 </span><span style=color:#ed9366>* </span><span style=color:#ff8f40>3.25</span><span style=color:#61676ccc>;
</span><span>
</span><span>                commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((
</span><span>                    Mesh3d(
</span><span>                        meshes</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(
</span><span>                            mesh</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()
</span><span>                                </span><span style=color:#ed9366>.</span><span style=color:#f07171>translated_by</span><span>(Vec3</span><span style=color:#ed9366>::</span><span>new(x_offset</span><span style=color:#61676ccc>,</span><span> y_offset</span><span style=color:#61676ccc>,</span><span> z_offset))</span><span style=color:#61676ccc>,
</span><span>                        )</span><span style=color:#61676ccc>,
</span><span>                    )</span><span style=color:#61676ccc>,
</span><span>                    MeshMaterial3d(material</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>())</span><span style=color:#61676ccc>,
</span><span>                ))</span><span style=color:#61676ccc>;
</span><span>            }
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Cuboids at the center share the same position and are equidistant from the camera
</span><span>    {
</span><span>        commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((
</span><span>            Mesh3d(meshes</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(mesh</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>translated_by</span><span>(Vec3</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ff8f40>3.25</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>3.25</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>3.</span><span>))))</span><span style=color:#61676ccc>,
</span><span>            MeshMaterial3d(material</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>())</span><span style=color:#61676ccc>,
</span><span>        ))</span><span style=color:#61676ccc>;
</span><span>        commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((
</span><span>            Mesh3d(meshes</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(mesh</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>translated_by</span><span>(Vec3</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ff8f40>3.25</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>3.25</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>3.</span><span>))))</span><span style=color:#61676ccc>,
</span><span>            MeshMaterial3d(materials</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(StandardMaterial {
</span><span>                base_color</span><span style=color:#61676ccc>: </span><span>Color</span><span style=color:#ed9366>::</span><span>srgb_u8(</span><span style=color:#ff8f40>150</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>150</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>250</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>with_alpha</span><span>(</span><span style=color:#ff8f40>0.6</span><span>)</span><span style=color:#61676ccc>,
</span><span>                alpha_mode</span><span style=color:#61676ccc>: </span><span>AlphaMode</span><span style=color:#ed9366>::</span><span>Blend</span><span style=color:#61676ccc>,
</span><span>                </span><span style=color:#ed9366>..</span><span style=color:#f07171>default</span><span>()
</span><span>            }))</span><span style=color:#61676ccc>,
</span><span>        ))</span><span style=color:#61676ccc>;
</span><span>        commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((
</span><span>            Mesh3d(meshes</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(mesh</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>translated_by</span><span>(Vec3</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ff8f40>3.25</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>3.25</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>3.</span><span>))))</span><span style=color:#61676ccc>,
</span><span>            MeshMaterial3d(materials</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(StandardMaterial {
</span><span>                base_color</span><span style=color:#61676ccc>: </span><span>Color</span><span style=color:#ed9366>::</span><span>srgb_u8(</span><span style=color:#ff8f40>250</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>150</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>150</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>with_alpha</span><span>(</span><span style=color:#ff8f40>0.5</span><span>)</span><span style=color:#61676ccc>,
</span><span>                alpha_mode</span><span style=color:#61676ccc>: </span><span>AlphaMode</span><span style=color:#ed9366>::</span><span>Blend</span><span style=color:#61676ccc>,
</span><span>                </span><span style=color:#ed9366>..</span><span style=color:#f07171>default</span><span>()
</span><span>            }))</span><span style=color:#61676ccc>,
</span><span>        ))</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>
</span><span>    commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((PointLight</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>, </span><span>Transform</span><span style=color:#ed9366>::</span><span>from_xyz(</span><span style=color:#ed9366>-</span><span style=color:#ff8f40>3.</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>10.</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>4.5</span><span>)))</span><span style=color:#61676ccc>;
</span><span>    commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((
</span><span>        Camera3d</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>,
</span><span>        Transform</span><span style=color:#ed9366>::</span><span>from_xyz(</span><span style=color:#ed9366>-</span><span style=color:#ff8f40>3.</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>12.</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>15.</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>looking_at</span><span>(Vec3</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ff8f40>4.75</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>4.75</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.</span><span>)</span><span style=color:#61676ccc>, </span><span>Vec3</span><span style=color:#ed9366>::</span><span>Y)</span><span style=color:#61676ccc>,
</span><span>        FreeCamera</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>,
</span><span>    ))</span><span style=color:#61676ccc>;
</span><span>    commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((
</span><span>        Node {
</span><span>            position_type</span><span style=color:#61676ccc>: </span><span>PositionType</span><span style=color:#ed9366>::</span><span>Absolute</span><span style=color:#61676ccc>,
</span><span>            padding</span><span style=color:#61676ccc>: </span><span>UiRect</span><span style=color:#ed9366>::</span><span>all(</span><span style=color:#f07171>px</span><span>(</span><span style=color:#ff8f40>10</span><span>))</span><span style=color:#61676ccc>,
</span><span>            </span><span style=color:#ed9366>..</span><span style=color:#f07171>default</span><span>()
</span><span>        }</span><span style=color:#61676ccc>,
</span><span>        GlobalZIndex(</span><span style=color:#fa6e32>i32</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>MAX</span><span>)</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#f07171>children!</span><span>[(
</span><span>            Text</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>,
</span><span>            </span><span style=color:#f07171>children!</span><span>[
</span><span>                (TextSpan</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#86b300>"1 - 3D view</span><span style=color:#4cbf99>\n</span><span style=color:#86b300>"</span><span>))</span><span style=color:#61676ccc>,
</span><span>                (TextSpan</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#86b300>"2 - Front view</span><span style=color:#4cbf99>\n</span><span style=color:#86b300>"</span><span>))</span><span style=color:#61676ccc>,
</span><span>                (TextSpan</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#86b300>"3 - Top view</span><span style=color:#4cbf99>\n</span><span style=color:#86b300>"</span><span>))</span><span style=color:#61676ccc>,
</span><span>                (TextSpan</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#86b300>"4 - Right view</span><span style=color:#4cbf99>\n</span><span style=color:#86b300>"</span><span>))</span><span style=color:#61676ccc>,
</span><span>            ]
</span><span>        )]</span><span style=color:#61676ccc>,
</span><span>    ))</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>view_orient</span><span>(
</span><span>    </span><span style=color:#ff8f40>input</span><span style=color:#61676ccc>: </span><span>Res&LTButtonInput&LTKeyCode>>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>camera_xform</span><span style=color:#61676ccc>: </span><span>Single<</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> Transform, With&LTCamera>>,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>let</span><span> xform </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>if</span><span> input</span><span style=color:#ed9366>.</span><span style=color:#f07171>just_pressed</span><span>(KeyCode</span><span style=color:#ed9366>::</span><span>Digit1) {
</span><span>        </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(Transform</span><span style=color:#ed9366>::</span><span>from_xyz(</span><span style=color:#ed9366>-</span><span style=color:#ff8f40>3.</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>12.</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>15.</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>looking_at</span><span>(Vec3</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ff8f40>4.75</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>4.75</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.</span><span>)</span><span style=color:#61676ccc>, </span><span>Vec3</span><span style=color:#ed9366>::</span><span>Y))
</span><span>    } </span><span style=color:#fa6e32>else if</span><span> input</span><span style=color:#ed9366>.</span><span style=color:#f07171>just_pressed</span><span>(KeyCode</span><span style=color:#ed9366>::</span><span>Digit2) {
</span><span>        </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(Transform</span><span style=color:#ed9366>::</span><span>from_xyz(</span><span style=color:#ff8f40>4.75</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>4.75</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>15.</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>looking_at</span><span>(Vec3</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ff8f40>4.75</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>4.75</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.</span><span>)</span><span style=color:#61676ccc>, </span><span>Vec3</span><span style=color:#ed9366>::</span><span>Y))
</span><span>    } </span><span style=color:#fa6e32>else if</span><span> input</span><span style=color:#ed9366>.</span><span style=color:#f07171>just_pressed</span><span>(KeyCode</span><span style=color:#ed9366>::</span><span>Digit3) {
</span><span>        </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(Transform</span><span style=color:#ed9366>::</span><span>from_xyz(</span><span style=color:#ff8f40>4.75</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>18.</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>-</span><span style=color:#ff8f40>1.</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>looking_at</span><span>(Vec3</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ff8f40>4.75</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>-</span><span style=color:#ff8f40>1.</span><span>)</span><span style=color:#61676ccc>, </span><span>Vec3</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>NEG_Z</span><span>))
</span><span>    } </span><span style=color:#fa6e32>else if</span><span> input</span><span style=color:#ed9366>.</span><span style=color:#f07171>just_pressed</span><span>(KeyCode</span><span style=color:#ed9366>::</span><span>Digit4) {
</span><span>        </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(Transform</span><span style=color:#ed9366>::</span><span>from_xyz(</span><span style=color:#ed9366>-</span><span style=color:#ff8f40>15.</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>4.75</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>-</span><span style=color:#ff8f40>1.</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>looking_at</span><span>(Vec3</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ff8f40>0.</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>4.75</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>-</span><span style=color:#ff8f40>1.</span><span>)</span><span style=color:#61676ccc>, </span><span>Vec3</span><span style=color:#ed9366>::</span><span>Y))
</span><span>    } </span><span style=color:#fa6e32>else </span><span>{
</span><span>        </span><span style=color:#55b4d4;font-style:italic>None
</span><span>    }</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(xform) </span><span style=color:#ed9366>=</span><span> xform {
</span><span>        camera_xform</span><span style=color:#ed9366>.</span><span style=color:#f07171>set_if_neq</span><span>(xform)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><ul><li>If relevant, what platforms did you test these changes on, and are there any important ones you can’t test? MacOS</ul><hr><h2 id=showcase>Showcase</h2><p>In my tests with building models (windows, glass, etc.), switching from translation-based sorting to bounds-center-based sorting noticeably improves the visual result. Transparent surfaces that were previously fighting or blending incorrectly now render in a much more expected order.<h3 id=current>Current:</h3><p>https://youtu.be/WjDjPAoKK6w<h3 id=sort-by-aabb-center>Sort by aabb center:</h3><p>https://youtu.be/-Sl4GOXp_vQ<h3 id=sort-by-aabb-center-tie-breaker>Sort by aabb center + tie breaker:</h3><p>https://youtu.be/0aQhkSKxECo<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a specific but important problem in Bevy’s rendering pipeline: transparent and transmissive rendering phases were sorting objects based on the translation component of their transform, which doesn’t work correctly for meshes that are authored with their geometry already positioned in world space.<p>The core issue occurs in common workflows like CAD or architectural modeling, where meshes are often authored with their geometry already positioned in world coordinates. In these cases, multiple mesh instances might have identity transforms (or transforms that only handle rotation/scale), causing them to share the same translation value. When Bevy sorts transparent objects by translation alone, these meshes get arbitrary draw order, leading to visual artifacts where transparent surfaces blend incorrectly.<p>The solution changes the sorting key from the raw translation to the world-space center of the mesh’s axis-aligned bounding box (AABB). This approach better represents the actual position of the geometry in the scene, rather than relying on the transform’s translation component which may not correlate with the mesh’s visual position.<p>The implementation follows a clear path through the codebase:<p>First, the <code>RenderMeshInstanceShared</code> struct needed to store the local-space center of the mesh bounds. This is computed from the mesh’s AABB and stored as a <code>Vec3</code>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// In crates/bevy_pbr/src/render/mesh.rs
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>RenderMeshInstanceShared </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... existing fields
</span><span>    </span><span style=color:#fa6e32>pub </span><span>center</span><span style=color:#61676ccc>:</span><span> Vec3,
</span><span>}
</span></code></pre><p>The center is computed when creating the shared instance data. The constructor now takes an optional AABB parameter:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>new</span><span>(
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other parameters
</span><span>    </span><span style=color:#ff8f40>aabb</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#ed9366>&</span><span>Aabb>,
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... existing code
</span><span>    center</span><span style=color:#61676ccc>:</span><span> aabb</span><span style=color:#ed9366>.</span><span style=color:#f07171>map_or</span><span>(Vec3</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ZERO</span><span style=color:#61676ccc>, </span><span>|</span><span style=color:#ff8f40>aabb</span><span>| aabb</span><span style=color:#ed9366>.</span><span>center</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>())</span><span style=color:#61676ccc>,
</span><span>}
</span></code></pre><p>For CPU-side rendering, the world-space center is computed on demand when building render queue data by transforming the local center through the instance’s world transform:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>fn </span><span style=color:#f29718>render_mesh_queue_data</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>entity</span><span style=color:#61676ccc>:</span><span> MainEntity) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTRenderMeshQueueData<'</span><span style=color:#ed9366>_</span><span>>> {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#ed9366>&</span><span>entity)</span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|</span><span style=color:#ff8f40>render_mesh_instance</span><span>| {
</span><span>        </span><span style=color:#fa6e32>let</span><span> world_from_local </span><span style=color:#ed9366>= &</span><span>render_mesh_instance</span><span style=color:#ed9366>.</span><span>transforms</span><span style=color:#ed9366>.</span><span>world_from_local</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#fa6e32>let</span><span> center </span><span style=color:#ed9366>=</span><span> world_from_local
</span><span>            </span><span style=color:#ed9366>.</span><span>matrix3
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>mul_vec3</span><span>(render_mesh_instance</span><span style=color:#ed9366>.</span><span>shared</span><span style=color:#ed9366>.</span><span>center)
</span><span>            </span><span style=color:#ed9366>+</span><span> world_from_local</span><span style=color:#ed9366>.</span><span>translation</span><span style=color:#61676ccc>;
</span><span>
</span><span>        RenderMeshQueueData {
</span><span>            shared</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>render_mesh_instance</span><span style=color:#ed9366>.</span><span>shared</span><span style=color:#61676ccc>,
</span><span>            center</span><span style=color:#61676ccc>,
</span><span>            current_uniform_index</span><span style=color:#61676ccc>: </span><span>InputUniformIndex</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>,
</span><span>        }
</span><span>    })
</span><span>}
</span></code></pre><p>For GPU-side rendering, the world-space center is computed during mesh extraction and stored directly in the GPU instance data:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let</span><span> world_from_local </span><span style=color:#ed9366>= &</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>world_from_local</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> center </span><span style=color:#ed9366>=
</span><span>    world_from_local</span><span style=color:#ed9366>.</span><span>matrix3</span><span style=color:#ed9366>.</span><span style=color:#f07171>mul_vec3</span><span>(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>shared</span><span style=color:#ed9366>.</span><span>center) </span><span style=color:#ed9366>+</span><span> world_from_local</span><span style=color:#ed9366>.</span><span>translation</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Later used when creating RenderMeshInstanceGpu
</span><span>RenderMeshInstanceGpu {
</span><span>    shared</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>shared</span><span style=color:#61676ccc>,
</span><span>    center</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other fields
</span><span>}
</span></code></pre><p>The rangefinder utility is simplified to work with any world-space position, not just translations or full transforms:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: two methods for different inputs
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>distance_translation</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>translation</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>Vec3) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>f32
</span><span>pub fn distance(</span><span style=color:#ed9366>&</span><span>self, transform: </span><span style=color:#ed9366>&</span><span>Mat4) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>f32
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: one method for world-space positions
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>distance</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>position</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>Vec3) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>f32 </span><span>{
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>view_from_world_row_2</span><span style=color:#ed9366>.</span><span style=color:#f07171>dot</span><span>(position</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend</span><span>(</span><span style=color:#ff8f40>1.0</span><span>))
</span><span>}
</span></code></pre><p>Finally, the material queueing systems are updated to use the new center field instead of translation:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// In crates/bevy_pbr/src/material.rs
</span><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> distance </span><span style=color:#ed9366>=</span><span> rangefinder</span><span style=color:#ed9366>.</span><span style=color:#f07171>distance_translation</span><span>(</span><span style=color:#ed9366>&</span><span>mesh_instance</span><span style=color:#ed9366>.</span><span>translation)
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> distance </span><span style=color:#ed9366>=</span><span> rangefinder</span><span style=color:#ed9366>.</span><span style=color:#f07171>distance</span><span>(</span><span style=color:#ed9366>&</span><span>mesh_instance</span><span style=color:#ed9366>.</span><span>center)
</span></code></pre><p>The changes also update two example files that were using the old <code>distance_translation</code> method, demonstrating that external code using the rangefinder needs to adapt to the new API.<p>An important consideration in this PR is the trade-off between accuracy and memory/performance. Storing an additional <code>Vec3</code> per mesh instance adds 12-16 bytes of memory overhead, and computing the world-space center requires a matrix transformation. However, for transparent and transmissive rendering where correct sorting is visually critical, this is a reasonable trade-off.<p>The PR also mentions a secondary issue: when multiple transparent objects have the same depth value, their draw order becomes unstable between frames, causing flickering. While not implemented in this PR, the author suggests adding a deterministic tie-breaker (like entity index) to the sort key as a future improvement.<p>From an architectural perspective, this change improves the separation of concerns: the rendering system now uses a geometrically meaningful position for sorting rather than relying on a transform component that may not correspond to visual position. This makes the system more robust to different asset authoring workflows.<p>The testing approach is thorough, with the author providing a complete example that demonstrates both the problem and solution. The YouTube links in the PR description show clear visual improvements, with transparent objects rendering in the correct depth order after the changes.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Mesh AABB] --> B[Local Center&LTbr/>Vec3 in RenderMeshInstanceShared]
</span><span>    B --> C[CPU Path: Transform on-demand]
</span><span>    B --> D[GPU Path: Transform during extraction]
</span><span>    C --> E[RenderMeshQueueData.center]
</span><span>    D --> F[RenderMeshInstanceGpu.center]
</span><span>    E --> G[Transparent/Transmissive Sorting]
</span><span>    F --> G
</span><span>    G --> H[Correct Depth-based Draw Order]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-pbr-src-render-mesh-rs-41-13><code>crates/bevy_pbr/src/render/mesh.rs</code> (+41/-13)</h3><p>This file contains the core structural changes. The main modifications include:<ul><li>Adding <code>center: Vec3</code> field to <code>RenderMeshInstanceShared</code> to store local-space bounds center<li>Replacing <code>translation: Vec3</code> with <code>center: Vec3</code> in <code>RenderMeshInstanceGpu</code> and <code>RenderMeshQueueData</code><li>Updating constructors to compute and store the center from mesh AABB<li>Modifying data extraction paths to compute world-space center for both CPU and GPU rendering</ul><p>Key code changes:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before in RenderMeshInstanceGpu:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>RenderMeshInstanceGpu </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>shared</span><span style=color:#61676ccc>:</span><span> RenderMeshInstanceShared,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>translation</span><span style=color:#61676ccc>:</span><span> Vec3,  </span><span style=color:#abb0b6;font-style:italic>// Only translation kept for sorting
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>RenderMeshInstanceGpu </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>shared</span><span style=color:#61676ccc>:</span><span> RenderMeshInstanceShared,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>center</span><span style=color:#61676ccc>:</span><span> Vec3,  </span><span style=color:#abb0b6;font-style:italic>// World-space center for sorting
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>}
</span></code></pre><h3 id=crates-bevy-render-src-render-phase-rangefinder-rs-8-19><code>crates/bevy_render/src/render_phase/rangefinder.rs</code> (+8/-19)</h3><p>This file simplifies the rangefinder API to work with world-space positions:<ul><li>Removes <code>distance_translation</code> and the <code>distance</code> method that took a <code>Mat4</code><li>Adds a single <code>distance</code> method that takes a <code>Vec3</code> (world position)</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: two methods
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>distance_translation</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>translation</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>Vec3) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>f32
</span><span>pub fn distance(</span><span style=color:#ed9366>&</span><span>self, transform: </span><span style=color:#ed9366>&</span><span>Mat4) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>f32
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: one unified method
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>distance</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>position</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>Vec3) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>f32 </span><span>{
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>view_from_world_row_2</span><span style=color:#ed9366>.</span><span style=color:#f07171>dot</span><span>(position</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend</span><span>(</span><span style=color:#ff8f40>1.0</span><span>))
</span><span>}
</span></code></pre><h3 id=crates-bevy-pbr-src-material-rs-2-2><code>crates/bevy_pbr/src/material.rs</code> (+2/-2)</h3><p>Updates the transparent and transmissive material queueing to use the new center-based sorting:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> distance </span><span style=color:#ed9366>=</span><span> rangefinder</span><span style=color:#ed9366>.</span><span style=color:#f07171>distance_translation</span><span>(</span><span style=color:#ed9366>&</span><span>mesh_instance</span><span style=color:#ed9366>.</span><span>translation)
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> distance </span><span style=color:#ed9366>=</span><span> rangefinder</span><span style=color:#ed9366>.</span><span style=color:#f07171>distance</span><span>(</span><span style=color:#ed9366>&</span><span>mesh_instance</span><span style=color:#ed9366>.</span><span>center)
</span></code></pre><h3 id=examples-shader-advanced-custom-render-phase-rs-1-1><code>examples/shader_advanced/custom_render_phase.rs</code> (+1/-1)</h3><h3 id=examples-shader-advanced-custom-shader-instancing-rs-1-1><code>examples/shader_advanced/custom_shader_instancing.rs</code> (+1/-1)</h3><p>These example files are updated to use the new <code>distance</code> method with the <code>center</code> field instead of the old <code>distance_translation</code> method with <code>translation</code>.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/rendering/ target=_blank>Bevy Rendering Pipeline Documentation</a> - Understand Bevy’s render graph and phases<li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Z-order target=_blank>Depth Sorting in Computer Graphics</a> - Background on depth-based rendering<li><a rel="noopener nofollow noreferrer" href=https://www.khronos.org/opengl/wiki/Transparency_Sorting target=_blank>Transparency Sorting Algorithms</a> - Common approaches to transparent object rendering<li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Bounding_volume target=_blank>Axis-Aligned Bounding Boxes</a> - Using AABBs for spatial calculations<li><a rel="noopener nofollow noreferrer" href=https://www.scratchapixel.com/lessons/3d-basic-rendering/perspective-and-orthographic-projection-matrix/ target=_blank>View-Projection Matrices</a> - How view-space depth is calculated from world positions</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22041.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>