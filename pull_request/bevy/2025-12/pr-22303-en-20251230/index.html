<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22303 bevy_render: dropped texture view is not Drop in wasm
        
    </title><meta content="#22303 bevy_render: dropped texture view is not Drop in wasm" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-30</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22303-zh-cn-20251230>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: bevy_render: dropped texture view is not Drop in wasm<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22303<li><strong>Author</strong>: mockersf<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, C-Code-Quality, O-Web, S-Ready-For-Review<li><strong>Created</strong>: 2025-12-29T18:22:12Z<li><strong>Merged</strong>: 2025-12-30T02:01:08Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li><code>cargo clippy --no-deps --package bevy_render --target wasm32-unknown-unknown</code> fails:</ul><pre style=color:#61676c;background-color:#fafafa><code><span>warning: call to `std::mem::drop` with a value that does not implement `Drop`. Dropping such a type only extends its contained lifetimes
</span><span>   --> crates/bevy_render/src/view/window/mod.rs:416:13
</span><span>    |
</span><span>416 |             drop(window.swap_chain_texture_view.take());
</span><span>    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
</span><span>    |
</span><span>note: argument has type `std::option::Option&LTrender_resource::texture::TextureView>`
</span><span>   --> crates/bevy_render/src/view/window/mod.rs:416:18
</span><span>    |
</span><span>416 |             drop(window.swap_chain_texture_view.take());
</span><span>    |                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
</span><span>    = help: for further information visit https://rust-lang.github.io/rust-clippy/rust-1.92.0/index.html#drop_non_drop
</span><span>    = note: `#[warn(clippy::drop_non_drop)]` on by default
</span><span>
</span><span>warning: `bevy_render` (lib) generated 1 warning
</span></code></pre><h2 id=solution>Solution</h2><ul><li>Expect the lint in wasm. It’s not an actual problem, and special casing for wasm wouldn’t be better</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a straightforward but important issue with the Bevy rendering engine’s WebAssembly target. During routine maintenance, the developer ran clippy with the wasm32 target and discovered a warning that prevented clean builds. The warning indicated that <code>TextureView</code> doesn’t implement the <code>Drop</code> trait on WebAssembly, making the explicit <code>drop()</code> call unnecessary from a lint perspective.<p>The problem occurs in the window surface creation code. When Bevy needs to recreate swap chain surfaces, it properly cleans up the old textures by dropping them. The code uses <code>drop(window.swap_chain_texture.take())</code> followed by <code>drop(window.swap_chain_texture_view.take())</code>. On native platforms, these types implement <code>Drop</code> to properly release GPU resources. However, on WebAssembly, <code>TextureView</code> doesn’t implement <code>Drop</code> because WebGPU resources in wasm are managed differently - they’re automatically cleaned up by JavaScript’s garbage collection.<p>From a technical standpoint, this isn’t a bug in the runtime behavior. The <code>drop()</code> call on wasm essentially becomes a no-op that just extends the value’s lifetime until the end of the scope. The code is still correct because:<ol><li>The <code>take()</code> operation moves the value out of the <code>Option</code>, leaving <code>None</code> in its place<li>Calling <code>drop()</code> on the moved-out value ensures it’s destroyed immediately (on native) or lets it go out of scope (on wasm)<li>The warning is purely a lint issue, not a functional problem</ol><p>The developer considered several approaches to fix this. One option was to conditionally compile the <code>drop()</code> call only for non-wasm targets using <code>#[cfg(not(target_arch = "wasm32"))]</code>. Another was to use <code>let _ = window.swap_chain_texture_view.take();</code> instead of <code>drop()</code>. However, both approaches would make the code less consistent and potentially more confusing.<p>The chosen solution uses Rust’s <code>cfg_attr</code> directive with <code>expect</code> to suppress the clippy warning specifically for wasm32 targets while keeping the code structure identical across all platforms. This approach maintains code consistency and readability while documenting why the warning is expected. The <code>expect</code> attribute is preferable to <code>allow</code> because it requires a reason and shows up in clippy output, making it clear this is an intentional suppression.<p>This fix demonstrates good Rust practice: when dealing with platform-specific differences, use attributes to handle lints rather than changing the code structure. The <code>cfg_attr</code> approach keeps the code visually identical across platforms, which helps maintainability. Future developers working on this code won’t need to understand why wasm has different drop semantics - the attribute provides that documentation inline.<p>The implementation shows awareness of WebGPU’s architectural differences between native and web targets. On native platforms, explicit resource management is required, while on the web, resources are managed by the browser’s JavaScript runtime. This distinction is common in cross-platform graphics code and handling it gracefully is important for a game engine like Bevy that targets multiple platforms.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Window Surface Recreation] --> B[Drop swap_chain_texture]
</span><span>    A --> C[Drop swap_chain_texture_view]
</span><span>    C --> D{Native Platform?}
</span><span>    D -->|Yes| E[TextureView implements Drop]
</span><span>    D -->|No (Wasm)| F[TextureView doesn't implement Drop]
</span><span>    F --> G[Clippy warns drop_non_drop]
</span><span>    G --> H[Suppress with #[expect]]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-render-src-view-window-mod-rs-4-0><code>crates/bevy_render/src/view/window/mod.rs</code> (+4/-0)</h3><p>This file contains the window surface management code for Bevy’s renderer. The change adds a conditional attribute to suppress a clippy warning specifically for WebAssembly targets.<p><strong>Key modification:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before the change:
</span><span style=color:#f07171>drop</span><span>(window</span><span style=color:#ed9366>.</span><span>swap_chain_texture</span><span style=color:#ed9366>.</span><span style=color:#f07171>take</span><span>())</span><span style=color:#61676ccc>;
</span><span style=color:#f07171>drop</span><span>(window</span><span style=color:#ed9366>.</span><span>swap_chain_texture_view</span><span style=color:#ed9366>.</span><span style=color:#f07171>take</span><span>())</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After the change:
</span><span style=color:#f07171>drop</span><span>(window</span><span style=color:#ed9366>.</span><span>swap_chain_texture</span><span style=color:#ed9366>.</span><span style=color:#f07171>take</span><span>())</span><span style=color:#61676ccc>;
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg_attr</span><span>(
</span><span>    target_arch </span><span style=color:#ed9366>= </span><span style=color:#86b300>"wasm32"</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#f29718>expect</span><span>(clippy::drop_non_drop</span><span style=color:#61676ccc>,</span><span> reason </span><span style=color:#ed9366>= </span><span style=color:#86b300>"texture views are not drop on wasm"</span><span>)
</span><span>)]
</span><span style=color:#f07171>drop</span><span>(window</span><span style=color:#ed9366>.</span><span>swap_chain_texture_view</span><span style=color:#ed9366>.</span><span style=color:#f07171>take</span><span>())</span><span style=color:#61676ccc>;
</span></code></pre><p><strong>Why this change was made:</strong><ol><li>The <code>TextureView</code> type doesn’t implement <code>Drop</code> on WebAssembly targets<li>The explicit <code>drop()</code> call is still semantically correct (it moves the value out of scope)<li>The warning was preventing clean clippy runs for wasm32 targets<li>The attribute approach maintains code consistency across platforms while documenting the platform-specific behavior</ol><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://rust-lang.github.io/rust-clippy/rust-1.92.0/index.html#drop_non_drop target=_blank>Rust Clippy: drop_non_drop</a> - Documentation for the specific clippy lint<li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/reference/conditional-compilation.html target=_blank>Rust Conditional Compilation</a> - How to use <code>cfg</code> and <code>cfg_attr</code> attributes<li><a rel="noopener nofollow noreferrer" href=https://www.w3.org/TR/webgpu/ target=_blank>WebGPU and WASM Resource Management</a> - WebGPU specification showing how resources are managed in web environments<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/getting-started/setup/#wasm-webassembly target=_blank>Bevy WebAssembly Support</a> - Bevy’s documentation on WebAssembly target setup<li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/std/ops/trait.Drop.html target=_blank>Rust’s Drop Trait</a> - Understanding how resource cleanup works in Rust</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22303.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>