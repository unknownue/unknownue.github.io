<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22159 Prevent the transaction log for a bevy_asset test from writing to the file system.
        
    </title><meta content="#22159 Prevent the transaction log for a bevy_asset test from writing to the file system." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-17</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22159-zh-cn-20251217>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p><strong>Prevent the transaction log for a bevy_asset test from writing to the file system.</strong><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Prevent the transaction log for a bevy_asset test from writing to the file system.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22159<li><strong>Author</strong>: andriyDev<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Assets, S-Ready-For-Final-Review, C-Testing, D-Straightforward<li><strong>Created</strong>: 2025-12-17T01:50:33Z<li><strong>Merged</strong>: 2025-12-17T19:25:39Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>bevy_asset tests are writing to the filesystem!</ul><h2 id=solution>Solution</h2><ul><li>Share the impl of <code>create_app</code> with more tests.<li>Set the transaction log for this one test to also use the fake transasction log (same thing as #21476).</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The issue was straightforward: a unit test in the Bevy asset system was writing to the actual filesystem during test execution. This is problematic for several reasons. Tests that write to the filesystem can create side effects that affect other tests, leave temporary files that need cleanup, and generally violate the principle of test isolation. In continuous integration environments, this can cause flaky tests or permission issues.<p>The problem was identified in a specific test within the asset processor module. The asset processor uses a transaction log to track processing operations, and by default, this log writes to disk. During testing, we want to avoid any actual filesystem I/O.<p>The solution approached this from two angles. First, the PR expanded the use of an existing helper function called <code>create_app()</code> that was already designed to create test applications with safe configurations. This function was originally defined in <code>lib.rs</code> but was only scoped to that module’s tests. The fix made this function <code>pub(crate)</code> so it could be shared across multiple test modules.<p>Second, the PR specifically addressed the transaction log issue by ensuring that the problematic test used a fake transaction log implementation. This was done by extracting the existing fake transaction log implementation into a reusable function and calling it in the test setup.<p>Looking at the code changes, the pattern becomes clear. In <code>lib.rs</code>, the <code>create_app()</code> function was updated to be publicly accessible within the crate. More importantly, it configures the <code>AssetPlugin</code> with specific overrides that disable filesystem interactions:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>create_app</span><span>() </span><span style=color:#61676ccc>-> </span><span>(App, Dir) {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> app </span><span style=color:#ed9366>= </span><span>App</span><span style=color:#ed9366>::</span><span>new()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> dir </span><span style=color:#ed9366>= </span><span>Dir</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> dir_clone </span><span style=color:#ed9366>=</span><span> dir</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    app</span><span style=color:#ed9366>.</span><span style=color:#f07171>register_asset_source</span><span>(
</span><span>        AssetSourceId</span><span style=color:#ed9366>::</span><span>Default</span><span style=color:#61676ccc>,
</span><span>        AssetSourceBuilder</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#fa6e32>move </span><span style=color:#ed9366>|| </span><span style=color:#55b4d4;font-style:italic>Box</span><span style=color:#ed9366>::</span><span>new(MemoryAssetReader { root</span><span style=color:#61676ccc>:</span><span> dir_clone</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>() }))</span><span style=color:#61676ccc>,
</span><span>    )
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>add_plugins</span><span>((
</span><span>        TaskPoolPlugin</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>,
</span><span>        AssetPlugin {
</span><span>            watch_for_changes_override</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#ff8f40>false</span><span>)</span><span style=color:#61676ccc>,
</span><span>            use_asset_processor_override</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#ff8f40>false</span><span>)</span><span style=color:#61676ccc>,
</span><span>            </span><span style=color:#ed9366>..</span><span style=color:#55b4d4;font-style:italic>Default</span><span style=color:#ed9366>::</span><span>default()
</span><span>        }</span><span style=color:#61676ccc>,
</span><span>        DiagnosticsPlugin</span><span style=color:#61676ccc>,
</span><span>    ))</span><span style=color:#61676ccc>;
</span><span>    (app</span><span style=color:#61676ccc>,</span><span> dir)
</span><span>}
</span></code></pre><p>The key configuration here is <code>watch_for_changes_override: Some(false)</code> and <code>use_asset_processor_override: Some(false)</code>. These settings prevent the asset system from watching for file changes and using the asset processor, both of which would involve filesystem access.<p>Several test modules were then updated to use this shared <code>create_app()</code> function instead of creating their own App instances with the default <code>AssetPlugin</code>. The changes in <code>asset_changed.rs</code>, <code>handle.rs</code>, and <code>reflect.rs</code> show this pattern consistently: tests that previously created their own App with <code>AssetPlugin::default()</code> now use <code>create_app().0</code> to get a pre-configured App instance.<p>The more complex part of the fix was in <code>processor/tests.rs</code>. Here, a test called <code>only_reprocesses_wrong_hash_on_startup</code> was still writing to the filesystem because it was using a transaction log. The solution was to extract the existing fake transaction log implementation into a helper function and apply it to this test:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>fn </span><span style=color:#f29718>set_fake_transaction_log</span><span>(</span><span style=color:#ff8f40>app</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> App) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>/// A dummy transaction log factory that just creates [`FakeTransactionLog`].
</span><span>    </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>FakeTransactionLogFactory</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#fa6e32>impl </span><span>ProcessorTransactionLogFactory </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>FakeTransactionLogFactory </span><span>{
</span><span>        </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>read</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span>BoxedFuture<'</span><span style=color:#ed9366>_</span><span>, </span><span style=color:#55b4d4;font-style:italic>Result</span><span><</span><span style=color:#55b4d4;font-style:italic>Vec</span><span>&LTLogEntry>, BevyError>> {
</span><span>            </span><span style=color:#55b4d4;font-style:italic>Box</span><span style=color:#ed9366>::</span><span>pin(async </span><span style=color:#fa6e32>move </span><span>{ </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(</span><span style=color:#f07171>vec!</span><span>[]) })
</span><span>        }
</span><span>        
</span><span>        </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>create_new_log</span><span>(
</span><span>            </span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>,
</span><span>        ) </span><span style=color:#61676ccc>-> </span><span>BoxedFuture<'</span><span style=color:#ed9366>_</span><span>, </span><span style=color:#55b4d4;font-style:italic>Result</span><span><</span><span style=color:#55b4d4;font-style:italic>Box</span><span>&LTdyn ProcessorTransactionLog>, BevyError>> {
</span><span>            </span><span style=color:#55b4d4;font-style:italic>Box</span><span style=color:#ed9366>::</span><span>pin(async </span><span style=color:#fa6e32>move </span><span>{ </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(</span><span style=color:#55b4d4;font-style:italic>Box</span><span style=color:#ed9366>::</span><span>new(FakeTransactionLog) </span><span style=color:#ed9366>as _</span><span>) })
</span><span>        }
</span><span>    }
</span><span>    
</span><span>    </span><span style=color:#abb0b6;font-style:italic>/// A dummy transaction log that just drops every log.
</span><span>    </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>FakeTransactionLog</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#fa6e32>impl </span><span>ProcessorTransactionLog </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>FakeTransactionLog </span><span>{
</span><span>        </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>begin_processing</span><span><</span><span style=color:#fa6e32>'a</span><span>>(
</span><span>            </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'a mut </span><span style=color:#ff8f40>self</span><span>,
</span><span>            </span><span style=color:#ff8f40>_asset</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'a </span><span>AssetPath<'</span><span style=color:#ed9366>_</span><span>>,
</span><span>        ) </span><span style=color:#61676ccc>-> </span><span>BoxedFuture<</span><span style=color:#fa6e32>'a</span><span>, </span><span style=color:#55b4d4;font-style:italic>Result</span><span><(), BevyError>> {
</span><span>            </span><span style=color:#55b4d4;font-style:italic>Box</span><span style=color:#ed9366>::</span><span>pin(async </span><span style=color:#fa6e32>move </span><span>{ </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(()) })
</span><span>        }
</span><span>        
</span><span>        </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>end_processing</span><span><</span><span style=color:#fa6e32>'a</span><span>>(
</span><span>            </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'a mut </span><span style=color:#ff8f40>self</span><span>,
</span><span>            </span><span style=color:#ff8f40>_asset</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'a </span><span>AssetPath<'</span><span style=color:#ed9366>_</span><span>>,
</span><span>        ) </span><span style=color:#61676ccc>-> </span><span>BoxedFuture<</span><span style=color:#fa6e32>'a</span><span>, </span><span style=color:#55b4d4;font-style:italic>Result</span><span><(), BevyError>> {
</span><span>            </span><span style=color:#55b4d4;font-style:italic>Box</span><span style=color:#ed9366>::</span><span>pin(async </span><span style=color:#fa6e32>move </span><span>{ </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(()) })
</span><span>        }
</span><span>        
</span><span>        </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>unrecoverable</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span>BoxedFuture<'</span><span style=color:#ed9366>_</span><span>, </span><span style=color:#55b4d4;font-style:italic>Result</span><span><(), BevyError>> {
</span><span>            </span><span style=color:#55b4d4;font-style:italic>Box</span><span style=color:#ed9366>::</span><span>pin(async </span><span style=color:#fa6e32>move </span><span>{ </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(()) })
</span><span>        }
</span><span>    }
</span><span>    
</span><span>    app</span><span style=color:#ed9366>.</span><span style=color:#f07171>world</span><span>()
</span><span>        </span><span style=color:#ed9366>.</span><span>resource</span><span style=color:#ed9366>::</span><span>&LTAssetProcessor>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>data</span><span>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>set_log_factory</span><span>(</span><span style=color:#55b4d4;font-style:italic>Box</span><span style=color:#ed9366>::</span><span>new(FakeTransactionLogFactory))
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>This fake transaction log implements the required traits but does nothing - it returns empty results and succeeds on all operations without touching the filesystem. The function is then called in two places: in the existing <code>create_app_with_asset_processor</code> function and in the specific test that was causing the problem.<p>The technical insight here is about test design in systems that normally interact with external resources. The pattern of creating fake implementations (like the <code>FakeTransactionLog</code>) is standard practice for unit testing. What’s notable in this PR is the systematic approach: rather than just fixing the one problematic test, the developer also shared existing infrastructure (<code>create_app()</code>) to prevent similar issues in other tests.<p>From an architectural perspective, this change improves test reliability and performance. Tests that don’t touch the filesystem run faster and are more predictable. It also demonstrates good software engineering practice: when you find a bug in one test, look for similar patterns in other tests that might have the same issue.<p>The impact is straightforward: more reliable tests that don’t have side effects on the filesystem. This makes the test suite more suitable for continuous integration environments and prevents intermittent test failures caused by filesystem state.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Test modules needing App setup] --> B[create_app() helper]
</span><span>    B --> C[MemoryAssetReader]
</span><span>    B --> D[AssetPlugin with overrides]
</span><span>    D --> E[watch_for_changes_override: false]
</span><span>    D --> F[use_asset_processor_override: false]
</span><span>    G[processor/tests.rs] --> H[set_fake_transaction_log()]
</span><span>    H --> I[FakeTransactionLogFactory]
</span><span>    I --> J[FakeTransactionLog]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-asset-src-lib-rs-32-4><code>crates/bevy_asset/src/lib.rs</code> (+32/-4)</h3><p>This file contains the main change: making the <code>create_app()</code> function <code>pub(crate)</code> and updating its configuration. The function now properly configures the <code>AssetPlugin</code> to avoid filesystem access.<p><strong>Key change:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>create_app</span><span>() </span><span style=color:#61676ccc>-> </span><span>(App, Dir) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... implementation with default AssetPlugin
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>create_app</span><span>() </span><span style=color:#61676ccc>-> </span><span>(App, Dir) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... implementation with AssetPlugin configured to avoid filesystem access
</span><span>    AssetPlugin {
</span><span>        watch_for_changes_override</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#ff8f40>false</span><span>)</span><span style=color:#61676ccc>,
</span><span>        use_asset_processor_override</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#ff8f40>false</span><span>)</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#ed9366>..</span><span style=color:#55b4d4;font-style:italic>Default</span><span style=color:#ed9366>::</span><span>default()
</span><span>    }</span><span style=color:#61676ccc>,
</span><span>}
</span></code></pre><h3 id=crates-bevy-asset-src-processor-tests-rs-53-45><code>crates/bevy_asset/src/processor/tests.rs</code> (+53/-45)</h3><p>This file contains the extraction of the fake transaction log into a helper function and its application to the problematic test.<p><strong>Key change:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// New helper function extracted from existing code:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>set_fake_transaction_log</span><span>(</span><span style=color:#ff8f40>app</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> App) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Implementation of FakeTransactionLogFactory and FakeTransactionLog
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Called in the existing function:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>create_app_with_asset_processor</span><span>(</span><span style=color:#ff8f40>extra_sources</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>[String]) </span><span style=color:#61676ccc>-></span><span> AppWithProcessor {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... setup code
</span><span>    </span><span style=color:#f07171>set_fake_transaction_log</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> app)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// And in the specific test:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>only_reprocesses_wrong_hash_on_startup</span><span>() {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> app </span><span style=color:#ed9366>= </span><span>App</span><span style=color:#ed9366>::</span><span>new()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... setup
</span><span>    </span><span style=color:#f07171>set_fake_transaction_log</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> app)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... rest of test
</span><span>}
</span></code></pre><h3 id=crates-bevy-asset-src-asset-changed-rs-9-12><code>crates/bevy_asset/src/asset_changed.rs</code> (+9/-12)</h3><p>Updated tests to use the shared <code>create_app()</code> function instead of creating their own App with default plugins.<p><strong>Key change:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>run_app</span><span>&LTMarker>(</span><span style=color:#ff8f40>system</span><span style=color:#61676ccc>:</span><span> impl IntoSystem<(), (), Marker>) {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> app </span><span style=color:#ed9366>= </span><span>App</span><span style=color:#ed9366>::</span><span>new()</span><span style=color:#61676ccc>;
</span><span>    app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_plugins</span><span>((TaskPoolPlugin</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>, </span><span>AssetPlugin</span><span style=color:#ed9366>::</span><span>default()))
</span><span>        </span><span style=color:#ed9366>.</span><span>init_asset</span><span style=color:#ed9366>::</span><span>&LTMyAsset>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(Update</span><span style=color:#61676ccc>,</span><span> system)</span><span style=color:#61676ccc>;
</span><span>    app</span><span style=color:#ed9366>.</span><span style=color:#f07171>update</span><span>()</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>run_app</span><span>&LTMarker>(</span><span style=color:#ff8f40>system</span><span style=color:#61676ccc>:</span><span> impl IntoSystem<(), (), Marker>) {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> app </span><span style=color:#ed9366>= </span><span style=color:#f07171>create_app</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;
</span><span>    app</span><span style=color:#ed9366>.</span><span>init_asset</span><span style=color:#ed9366>::</span><span>&LTMyAsset>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(Update</span><span style=color:#61676ccc>,</span><span> system)</span><span style=color:#61676ccc>;
</span><span>    app</span><span style=color:#ed9366>.</span><span style=color:#f07171>update</span><span>()</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=crates-bevy-asset-src-handle-rs-5-5-and-crates-bevy-asset-src-reflect-rs-3-5><code>crates/bevy_asset/src/handle.rs</code> (+5/-5) and <code>crates/bevy_asset/src/reflect.rs</code> (+3/-5)</h3><p>Similar updates to use <code>create_app()</code> instead of creating App instances with default plugins.<h2 id=further-reading>Further Reading</h2><ol><li><p><strong>Bevy Asset System Documentation</strong>: The Bevy book’s section on assets provides context for how the asset system works: https://bevyengine.org/learn/book/features/assets/</p><li><p><strong>Test Isolation Patterns</strong>: Martin Fowler’s article on test isolation discusses why avoiding filesystem access in tests is important: https://martinfowler.com/bliki/UnitTest.html</p><li><p><strong>Mock Objects in Rust</strong>: The Rust programming language doesn’t have built-in mocking frameworks like some other languages, but patterns like the fake implementation shown here are common. The “mockall” crate is a popular choice for more complex mocking needs.</p><li><p><strong>Previous Related PR</strong>: PR #21476 mentioned in the description shows a similar fix for transaction logs in tests, establishing a pattern that this PR follows.</p><li><p><strong>Bevy Plugin System</strong>: Understanding how Bevy plugins work is helpful for understanding the configuration changes in this PR: https://bevyengine.org/learn/book/plugins/</p></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22159.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>