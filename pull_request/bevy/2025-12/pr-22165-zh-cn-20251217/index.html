<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22165 Add name to pass span to make the error better
        
    </title><meta content="#22165 Add name to pass span to make the error better" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-17</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2025-12/pr-22165-en-20251217>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=title>Title</h1><p>PR #22165: 为渲染诊断错误信息添加 Pass 名称，提升调试体验<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Add name to pass span to make the error better<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22165<li><strong>Author</strong>: atlv24<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, C-Usability, S-Ready-For-For-Review, D-Straightforward<li><strong>Created</strong>: 2025-12-17T14:03:42Z<li><strong>Merged</strong>: 2025-12-17T19:12:15Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p><strong>目标</strong><ul><li>错误信息非常模糊</ul><p><strong>解决方案</strong><ul><li>名称使用 Cow，因此我们可以零成本克隆并传递给错误格式化。</ul><p><strong>测试</strong><ul><li>我使用此功能调试了 #22164</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>这个 PR 源于开发者在调试另一个问题时遇到的实际痛点。在调试 #22164 的过程中，作者发现渲染诊断系统中的错误信息不够具体，导致定位问题效率低下。<p>Bevy 渲染系统包含一个诊断模块（diagnostic），用于跟踪渲染过程中各个 Pass（渲染阶段）的执行时间。系统使用 <code>PassSpanGuard</code> 来记录一个 Pass 的开始和结束。这个守卫实现了 Drop trait，其设计初衷是：如果守卫在离开作用域时没有被显式调用 <code>end()</code> 方法，说明开发者忘记了结束这个 Pass 的时间记录，这通常是一个编程错误，因此会触发 panic。<p><strong>问题所在</strong> 修改前的 <code>PassSpanGuard</code> 在 panic 时仅提示 “PassSpanScope::end was never called”。这个错误信息是泛泛的，没有指出是哪个具体的 Pass 出了问题。在复杂的渲染管线中，可能有多个 Pass 同时被记录，当这个 panic 发生时，开发者需要额外的时间和努力去回溯代码，找出具体是哪个 Pass 的守卫没有正确结束。<p><strong>解决方案分析</strong> PR 作者采用了直接且成本较低的方案。关键在于 <code>PassSpanGuard</code> 的创建是通过 <code>RecordDiagnostics::pass_span</code> 方法，该方法已经接收了一个表示 Pass 名称的参数 <code>name</code>，其类型为 <code>Into&LTCow<'static, str>></code>。<code>Cow</code>（写时复制）是一个智能指针，可以高效地处理字符串的所有权和借用。<p>解决方案的核心步骤是：<ol><li>在 <code>pass_span</code> 方法内部，将传入的 <code>name</code> 转换为 <code>Cow<'static, str></code> 后，进行一次克隆（<code>clone()</code>）。<li>将克隆后的名称存储在新建的 <code>PassSpanGuard</code> 结构体中。<li>在 <code>PassSpanGuard</code> 的 <code>Drop</code> 实现中，将存储的名称插入到 panic 信息中。</ol><p><strong>技术细节与考量</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 修改前
</span><span style=color:#f07171>panic!</span><span>(</span><span style=color:#86b300>"PassSpanScope::end was never called"</span><span>)
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 修改后
</span><span style=color:#f07171>panic!</span><span>(</span><span style=color:#86b300>"PassSpanGuard::end was never called for {}"</span><span style=color:#61676ccc>, </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>name)
</span></code></pre><p>这里有几个值得注意的工程决策：<ol><li><strong>零成本克隆的利用</strong>：由于 <code>name</code> 是 <code>Cow<'static, str></code> 类型，对其调用 <code>.clone()</code> 通常是低成本的。如果 <code>Cow</code> 内部是 <code>Borrowed(&'static str)</code>，克隆只是复制指针；如果是 <code>Owned(String)</code>，则会克隆字符串。考虑到 Pass 名称通常是静态字符串字面量，大部分情况下开销极小。<li><strong>错误信息精确性</strong>：新的错误信息直接包含了出问题的 Pass 名称，使得开发者能够立即定位到问题代码段，显著提升调试效率。<li><strong>错误文本修正</strong>：作者在修改 panic 信息时，还修正了一个小错误：将 “PassSpanScope” 更正为 “PassSpanGuard”，与实际结构体名称保持一致，提高了代码的一致性。</ol><p>这个改动虽然很小，但体现了良好的软件工程实践：<strong>让错误信息具有可操作性</strong>。它直接解决了开发者在实际工作中遇到的痛点，改善了 API 的用户体验（UX），并且实现方式简洁、高效，几乎没有引入额外的运行时开销。这种改进对于提高大型、复杂系统（如游戏引擎）的开发效率和可维护性具有重要意义。<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[开发者调用 RecordDiagnostics::pass_span] --> B[创建 PassSpanGuard]
</span><span>    B --> C{守卫是否正常调用 .end()?}
</span><span>    C -->|是| D[正常结束，记录时间]
</span><span>    C -->|否，守卫被 Drop| E[触发 Panic]
</span><span>    E --> F[输出包含 Pass 名称的错误信息]
</span><span>    F --> G[开发者快速定位问题代码]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>crates/bevy_render/src/diagnostic/mod.rs</strong> (+5/-2) 这个文件是渲染诊断系统的核心，负责性能测量和时间记录。<ol><li><strong>修改点 1：<code>RecordDiagnostics::pass_span</code> 方法</strong> <ul><li><strong>目的</strong>：捕获并存储 Pass 名称到守卫中。<li><strong>实现</strong>：将传入的 <code>name</code> 克隆一份，一份用于开始记录，一份存入守卫。</ul></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>pass_span</span><span>&LTP, N>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>pass</span><span style=color:#61676ccc>:</span><span> P, </span><span style=color:#ff8f40>name</span><span style=color:#61676ccc>:</span><span> N) </span><span style=color:#61676ccc>-> </span><span>PassSpanGuard<'</span><span style=color:#ed9366>_</span><span>, </span><span style=color:#fa6e32>Self</span><span>, P>
</span><span style=color:#fa6e32>where
</span><span>    P</span><span style=color:#61676ccc>:</span><span> Pass,
</span><span>    N</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Into</span><span>&LTCow<</span><span style=color:#fa6e32>'static</span><span>, </span><span style=color:#fa6e32>str</span><span>>>,
</span><span>{
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>begin_pass_span</span><span>(pass</span><span style=color:#61676ccc>,</span><span> name</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>())</span><span style=color:#61676ccc>;
</span><span>    PassSpanGuard {
</span><span>        recorder</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#61676ccc>,
</span><span>        marker</span><span style=color:#61676ccc>:</span><span> PhantomData</span><span style=color:#61676ccc>,
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>pass_span</span><span>&LTP, N>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>pass</span><span style=color:#61676ccc>:</span><span> P, </span><span style=color:#ff8f40>name</span><span style=color:#61676ccc>:</span><span> N) </span><span style=color:#61676ccc>-> </span><span>PassSpanGuard<'</span><span style=color:#ed9366>_</span><span>, </span><span style=color:#fa6e32>Self</span><span>, P>
</span><span style=color:#fa6e32>where
</span><span>    P</span><span style=color:#61676ccc>:</span><span> Pass,
</span><span>    N</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Into</span><span>&LTCow<</span><span style=color:#fa6e32>'static</span><span>, </span><span style=color:#fa6e32>str</span><span>>>,
</span><span>{
</span><span>    </span><span style=color:#fa6e32>let</span><span> name </span><span style=color:#ed9366>=</span><span> name</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>begin_pass_span</span><span>(pass</span><span style=color:#61676ccc>,</span><span> name</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>())</span><span style=color:#61676ccc>;
</span><span>    PassSpanGuard {
</span><span>        recorder</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#61676ccc>,
</span><span>        name</span><span style=color:#61676ccc>,
</span><span>        marker</span><span style=color:#61676ccc>:</span><span> PhantomData</span><span style=color:#61676ccc>,
</span><span>    }
</span><span>}
</span></code></pre><ol start=2><li><strong>修改点 2：<code>PassSpanGuard</code> 结构体</strong> <ul><li><strong>目的</strong>：为守卫添加存储 Pass 名称的能力。<li><strong>实现</strong>：新增 <code>name: Cow<'static, str></code> 字段。</ul></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 新增字段
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>PassSpanGuard</span><span><</span><span style=color:#fa6e32>'a</span><span>, R</span><span style=color:#61676ccc>: </span><span style=color:#f51818>?</span><span>Sized, P> {
</span><span>    recorder</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'a</span><span> R,
</span><span>    name</span><span style=color:#61676ccc>: </span><span>Cow<</span><span style=color:#fa6e32>'static</span><span>, </span><span style=color:#fa6e32>str</span><span>>, </span><span style=color:#abb0b6;font-style:italic>// 新增
</span><span>    marker</span><span style=color:#61676ccc>: </span><span>PhantomData&LTP>,
</span><span>}
</span></code></pre><ol start=3><li><strong>修改点 3：<code>Drop for PassSpanGuard</code> 实现</strong> <ul><li><strong>目的</strong>：在 panic 信息中包含具体是哪个 Pass 未正确结束。<li><strong>实现</strong>：在 panic 宏中格式化输出 <code>self.name</code>。</ul></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>impl</span><span>&LTR</span><span style=color:#61676ccc>: </span><span style=color:#f51818>?</span><span style=color:#399ee6>Sized</span><span>, </span><span style=color:#399ee6>P</span><span>> </span><span style=color:#399ee6>Drop for PassSpanGuard</span><span><'</span><span style=color:#ed9366>_</span><span>, R, P> {
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>drop</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>) {
</span><span>        </span><span style=color:#f07171>panic!</span><span>(</span><span style=color:#86b300>"PassSpanScope::end was never called"</span><span>)
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>impl</span><span>&LTR</span><span style=color:#61676ccc>: </span><span style=color:#f51818>?</span><span style=color:#399ee6>Sized</span><span>, </span><span style=color:#399ee6>P</span><span>> </span><span style=color:#399ee6>Drop for PassSpanGuard</span><span><'</span><span style=color:#ed9366>_</span><span>, R, P> {
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>drop</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>) {
</span><span>        </span><span style=color:#f07171>panic!</span><span>(</span><span style=color:#86b300>"PassSpanGuard::end was never called for {}"</span><span style=color:#61676ccc>, </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>name)
</span><span>    }
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><strong>Rust 中的 Cow 类型</strong>：<code>std::borrow::Cow</code> 官方文档，了解其写时复制语义和高效处理字符串的策略。<li><strong>RAII 模式与 Drop trait</strong>：理解 Rust 中资源获取即初始化的模式，以及 Drop trait 如何确保资源清理。<li><strong>Bevy 渲染管线架构</strong>：深入了解 Bevy 的 ECS 架构和渲染管线中 Pass 的概念及其作用。<li><strong>Effective Error Messages</strong>：关于如何设计对开发者友好的错误信息的通用准则和实践。</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22165.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>