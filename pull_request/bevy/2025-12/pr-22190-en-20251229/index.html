<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22190 Fix 3d gizmo pipeline when atmosphere present
        
    </title><meta content="#22190 Fix 3d gizmo pipeline when atmosphere present" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-29</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22190-zh-cn-20251229>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=fix-3d-gizmo-pipeline-when-atmosphere-present>Fix 3d gizmo pipeline when atmosphere present</h2><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix 3d gizmo pipeline when atmosphere present<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22190<li><strong>Author</strong>: mate-h<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, S-Ready-For-Final-Review, D-Straightforward<li><strong>Created</strong>: 2025-12-18T21:16:26Z<li><strong>Merged</strong>: 2025-12-29T20:05:48Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><p>The PR description is in English and reads as follows:<h1 id=objective>Objective</h1><ul><li>Fixes https://github.com/bevyengine/bevy/issues/21784</ul><h2 id=solution>Solution</h2><ul><li>Add missing atmosphere pipeline key in the gizmo pipeline.</ul><h2 id=testing>Testing</h2><ul><li>Ran the 3d gizmo example with local changes to add the atmosphere to the camera and a directional light</ul><hr><h2 id=showcase>Showcase</h2><img alt="Screenshot 2025-12-18 at 1 15 53 PM" height=752 src=https://github.com/user-attachments/assets/746c6801-4d1e-4745-9fcb-3e66d5cf7097 width=1287><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a bug in Bevy’s 3D gizmo rendering pipeline when atmosphere rendering is enabled. The issue was reported in GitHub issue #21784, where users experienced rendering problems with 3D gizmos in scenes that included atmospheric effects.<p>The core problem was that the gizmo rendering pipeline wasn’t accounting for whether the camera view had an atmosphere component. When rendering gizmos, the system queries various view components to determine the correct rendering pipeline configuration. This configuration is built using a <code>MeshPipelineKey</code> bitmask that encodes various rendering features and settings. The atmosphere feature is one of these settings, but the gizmo pipeline wasn’t checking for it.<p>The implementation follows a pattern already established in other parts of the rendering system. The <code>queue_line_gizmos_3d</code> function needed to include <code>ExtractedAtmosphere</code> in its query to determine if the current view has an atmosphere, and then set the corresponding <code>MeshPipelineKey::ATMOSPHERE</code> flag in the view key.<p>The fix is minimal and focused: it adds the missing component check and flag setting without changing any other behavior. This approach aligns with how other rendering features like motion vectors, depth prepass, and order-independent transparency are handled in the same function.<p>From a technical perspective, this bug demonstrates the importance of consistency when handling rendering pipeline keys. The <code>MeshPipelineKey</code> acts as a configuration bitmask that must include all relevant features for correct shader selection and rendering behavior. When a new feature like atmosphere rendering is added to the engine, all rendering pipelines that use the mesh pipeline need to be updated to handle it.<p>The impact of this fix is straightforward: 3D gizmos now render correctly in scenes with atmospheric effects. Without this fix, the rendering pipeline would use an incorrect configuration, potentially leading to shader compilation errors, incorrect rendering, or crashes when atmosphere is enabled.<p>The testing approach described in the PR is pragmatic: the author modified the 3D gizmo example to include atmosphere components on the camera and a directional light, then verified that the gizmos rendered correctly. This is sufficient for this type of fix since it’s adding missing functionality rather than changing existing behavior.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Camera View Entity] --> B{Component Query}
</span><span>    B --> C[ExtractedAtmosphere]
</span><span>    B --> D[NormalPrepass]
</span><span>    B --> E[DepthPrepass]
</span><span>    B --> F[MotionVectorPrepass]
</span><span>    B --> G[DeferredPrepass]
</span><span>    B --> H[OITSettings]
</span><span>    
</span><span>    C --> I[MeshPipelineKey Assembly]
</span><span>    D --> I
</span><span>    E --> I
</span><span>    F --> I
</span><span>    G --> I
</span><span>    H --> I
</span><span>    
</span><span>    I --> J[Final Pipeline Key]
</span><span>    J --> K[Gizmo Rendering]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-gizmos-render-src-pipeline-3d-rs-7-2><code>crates/bevy_gizmos_render/src/pipeline_3d.rs</code> (+7/-2)</h3><p>This is the only file modified in the PR. The changes add support for atmosphere rendering in the 3D gizmo pipeline.<p><strong>Key changes:</strong><ol><li><strong>Import addition</strong>: Added <code>ExtractedAtmosphere</code> to the imports from <code>bevy_pbr</code><li><strong>Query update</strong>: Modified the view query to include <code>Has&LTExtractedAtmosphere></code><li><strong>Pipeline key update</strong>: Added logic to set the <code>ATMOSPHERE</code> bit in the <code>MeshPipelineKey</code> when atmosphere is present</ol><p><strong>Code snippets:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Import section (line 25)
</span><span style=color:#fa6e32>use </span><span>bevy_pbr</span><span style=color:#ed9366>::</span><span>{MeshPipeline</span><span style=color:#61676ccc>,</span><span> MeshPipelineKey</span><span style=color:#61676ccc>,</span><span> SetMeshViewBindGroup}</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Import section (line 25)
</span><span style=color:#fa6e32>use </span><span>bevy_pbr</span><span style=color:#ed9366>::</span><span>{ExtractedAtmosphere</span><span style=color:#61676ccc>,</span><span> MeshPipeline</span><span style=color:#61676ccc>,</span><span> MeshPipelineKey</span><span style=color:#61676ccc>,</span><span> SetMeshViewBindGroup}</span><span style=color:#61676ccc>;
</span></code></pre><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: View query (lines 305-313)
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>queue_line_gizmos_3d</span><span>(
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other parameters ...
</span><span>    </span><span style=color:#ff8f40>views</span><span style=color:#61676ccc>: </span><span>Query<(
</span><span>        // ... other view components ...
</span><span>        Has&LTMotionVectorPrepass>,
</span><span>        Has&LTDeferredPrepass>,
</span><span>        Has&LTOrderIndependentTransparencySettings>,
</span><span>    )>,
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><(), BevyError> {
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: View query (lines 305-314)
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>queue_line_gizmos_3d</span><span>(
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other parameters ...
</span><span>    </span><span style=color:#ff8f40>views</span><span style=color:#61676ccc>: </span><span>Query<(
</span><span>        // ... other view components ...
</span><span>        Has&LTMotionVectorPrepass>,
</span><span>        Has&LTDeferredPrepass>,
</span><span>        Has&LTOrderIndependentTransparencySettings>,
</span><span>        Has&LTExtractedAtmosphere>,
</span><span>    )>,
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><(), BevyError> {
</span></code></pre><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Pipeline key assembly (lines 318-324)
</span><span style=color:#fa6e32>for </span><span>(
</span><span>    view</span><span style=color:#61676ccc>,
</span><span>    msaa</span><span style=color:#61676ccc>,
</span><span>    render_layers</span><span style=color:#61676ccc>,
</span><span>    (normal_prepass</span><span style=color:#61676ccc>,</span><span> depth_prepass</span><span style=color:#61676ccc>,</span><span> motion_vector_prepass</span><span style=color:#61676ccc>,</span><span> deferred_prepass</span><span style=color:#61676ccc>,</span><span> oit)</span><span style=color:#61676ccc>,
</span><span>) </span><span style=color:#ed9366>in &</span><span>views
</span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other code ...
</span><span>    
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Pipeline key assembly (lines 347-351)
</span><span>    </span><span style=color:#fa6e32>if</span><span> oit {
</span><span>        view_key </span><span style=color:#ed9366>|= </span><span>MeshPipelineKey</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>OIT_ENABLED</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>    
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// No atmosphere handling
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Pipeline key assembly (lines 318-325)
</span><span style=color:#fa6e32>for </span><span>(
</span><span>    view</span><span style=color:#61676ccc>,
</span><span>    msaa</span><span style=color:#61676ccc>,
</span><span>    render_layers</span><span style=color:#61676ccc>,
</span><span>    (normal_prepass</span><span style=color:#61676ccc>,</span><span> depth_prepass</span><span style=color:#61676ccc>,</span><span> motion_vector_prepass</span><span style=color:#61676ccc>,</span><span> deferred_prepass</span><span style=color:#61676ccc>,</span><span> oit</span><span style=color:#61676ccc>,</span><span> atmosphere)</span><span style=color:#61676ccc>,
</span><span>) </span><span style=color:#ed9366>in &</span><span>views
</span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other code ...
</span><span>    
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Pipeline key assembly (lines 347-356)
</span><span>    </span><span style=color:#fa6e32>if</span><span> oit {
</span><span>        view_key </span><span style=color:#ed9366>|= </span><span>MeshPipelineKey</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>OIT_ENABLED</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#fa6e32>if</span><span> atmosphere {
</span><span>        view_key </span><span style=color:#ed9366>|= </span><span>MeshPipelineKey</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ATMOSPHERE</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/rendering/pipelines/ target=_blank>Bevy Rendering Pipeline Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_pbr/latest/bevy_pbr/struct.MeshPipelineKey.html target=_blank>MeshPipelineKey API Reference</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/examples/3d/atmospheric_scattering.rs target=_blank>Atmospheric Scattering in Bevy</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/crates/bevy_gizmos/src/lib.rs target=_blank>Bevy Gizmos System</a></ul><h2 id=full-code-diff>Full Code Diff</h2><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_gizmos_render/src/pipeline_3d.rs b/crates/bevy_gizmos_render/src/pipeline_3d.rs
</span><span>index 00fda49ee587b..d2731f9d62d3f 100644
</span><span style=color:#c594c5>--- a/crates/bevy_gizmos_render/src/pipeline_3d.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_gizmos_render/src/pipeline_3d.rs
</span><span style=color:#c594c5>@@ -22,7 +22,7 @@ </span><span style=color:#399ee6>use bevy_ecs::{
</span><span>     system::{Commands, Query, Res, ResMut},
</span><span> };
</span><span> use bevy_image::BevyDefault as _;
</span><span style=color:#f07171>-use bevy_pbr::{MeshPipeline, MeshPipelineKey, SetMeshViewBindGroup};
</span><span style=color:#86b300>+use bevy_pbr::{ExtractedAtmosphere, MeshPipeline, MeshPipelineKey, SetMeshViewBindGroup};
</span><span> use bevy_render::{
</span><span>     render_asset::{prepare_assets, RenderAssets},
</span><span>     render_phase::{
</span><span style=color:#c594c5>@@ -305,6 +305,7 @@ </span><span style=color:#399ee6>fn queue_line_gizmos_3d(
</span><span>             Has&LTMotionVectorPrepass>,
</span><span>             Has&LTDeferredPrepass>,
</span><span>             Has&LTOrderIndependentTransparencySettings>,
</span><span style=color:#86b300>+            Has&LTExtractedAtmosphere>,
</span><span>         ),
</span><span>     )>,
</span><span> ) -> Result<(), BevyError> {
</span><span style=color:#c594c5>@@ -318,7 +319,7 @@ </span><span style=color:#399ee6>fn queue_line_gizmos_3d(
</span><span>         view,
</span><span>         msaa,
</span><span>         render_layers,
</span><span style=color:#f07171>-        (normal_prepass, depth_prepass, motion_vector_prepass, deferred_prepass, oit),
</span><span style=color:#86b300>+        (normal_prepass, depth_prepass, motion_vector_prepass, deferred_prepass, oit, atmosphere),
</span><span>     ) in &views
</span><span>     {
</span><span>         let Some(transparent_phase) = transparent_render_phases.get_mut(&view.retained_view_entity)
</span><span style=color:#c594c5>@@ -351,6 +352,10 @@ </span><span style=color:#399ee6>fn queue_line_gizmos_3d(
</span><span>             view_key |= MeshPipelineKey::OIT_ENABLED;
</span><span>         }
</span><span> 
</span><span style=color:#86b300>+        if atmosphere {
</span><span style=color:#86b300>+            view_key |= MeshPipelineKey::ATMOSPHERE;
</span><span style=color:#86b300>+        }
</span><span style=color:#86b300>+
</span><span>         for (entity, main_entity, config) in &line_gizmos {
</span><span>             if !config.render_layers.intersects(render_layers) {
</span><span>                 continue;
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22190.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>