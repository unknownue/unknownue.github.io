<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22077 Fix undefined behavior in screenshots on WASM
        
    </title><meta content="#22077 Fix undefined behavior in screenshots on WASM" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-09</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22077-zh-cn-20251209>中文</a></div></div><div class=pr-content><h1 id=fix-undefined-behavior-in-screenshots-on-wasm>Fix undefined behavior in screenshots on WASM</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix undefined behavior in screenshots on WASM<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22077<li><strong>Author</strong>: kristoff3r<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, D-Trivial, O-Web, P-Unsound, S-Needs-Review<li><strong>Created</strong>: 2025-12-09T16:02:44Z<li><strong>Merged</strong>: 2025-12-09T18:33:58Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Currently the screenshot example on https://bevy.org/examples/window/screenshot/ gives invalid PNG files when I tried it. Looking at them they have some of the right bytes, but also a bunch of garbage. The example works on native.<p>I narrowed it down to the one unsafe block in sight (thanks Rust!). I don’t fully understand why the code stopped working or if it was ever valid, but in the meantime since it was written a safe API has been added, and using it made the problem go away.<h2 id=solution>Solution</h2><p>Bump <code>js-sys</code>, use the safe API.<h2 id=testing>Testing</h2><p>I ran the example with <code>bevy run --example screenshot web</code><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a specific WebAssembly issue where screenshot functionality was producing corrupted PNG files. The problem manifested when running the screenshot example on WASM targets, while native builds continued to work correctly. The developer investigating this issue took a systematic approach: they reproduced the problem, examined the corrupted output, and then methodically traced it to the only unsafe code block in the relevant code path.<p>The issue was in the WebAssembly-specific implementation of screenshot saving. The original code used <code>js_sys::Uint8Array::view()</code> to create a JavaScript <code>Uint8Array</code> that directly referenced Rust memory. This approach is inherently unsafe because it creates a view into Rust-managed memory that JavaScript can access. The problem arises from Rust’s ownership model: once the Rust <code>Vec&LTu8></code> containing the image data goes out of scope and is dropped, the JavaScript view becomes a dangling pointer, leading to undefined behavior when JavaScript tries to access that memory.<p>The developer discovered that since the original code was written, <code>js-sys</code> had added a safer alternative: <code>Uint8Array::new_from_slice()</code>. This method creates a copy of the data in JavaScript-managed memory instead of creating a view into Rust memory. While copying data has a performance cost, it eliminates the memory safety issues and ensures the screenshot functionality works reliably on WASM.<p>The fix was straightforward but important: update the <code>js-sys</code> dependency to a version that includes the safe API (0.3.83), then replace the unsafe <code>view()</code> call with the safe <code>new_from_slice()</code> method. This change demonstrates a common pattern in Rust WebAssembly development: prefer safe APIs that properly manage memory boundaries between Rust and JavaScript, even when they involve data copying.<p>The implementation highlights an important principle in systems programming: when working with foreign function interfaces or different memory spaces, explicit copying is often safer than sharing memory, especially when the lifetime of data is difficult to coordinate across language boundaries.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[Rust Screenshot Code] --> B[Create PNG in Vec&LTu8>]
</span><span>    B --> C[Old: Unsafe view() into Rust memory]
</span><span>    B --> D[New: Safe copy to JS memory]
</span><span>    C --> E[Corrupted PNG due to UB]
</span><span>    D --> F[Valid PNG file]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-render-cargo-toml><code>crates/bevy_render/Cargo.toml</code></h3><p><strong>Change</strong>: Updated <code>js-sys</code> dependency from “0.3” to “0.3.83” for WASM targets.<p><strong>Why</strong>: The newer version includes the <code>new_from_slice()</code> method which provides a safe alternative to the unsafe <code>view()</code> method used in the screenshot code.<pre class=language-toml data-lang=toml style=color:#61676c;background-color:#fafafa><code class=language-toml data-lang=toml><span style=color:#abb0b6;font-style:italic># File: crates/bevy_render/Cargo.toml
</span><span style=color:#abb0b6;font-style:italic># Before:
</span><span>[</span><span style=color:#399ee6>target</span><span style=color:#61676ccc>.</span><span style=color:#86b300>'cfg(target_arch = "wasm32")'</span><span style=color:#61676ccc>.</span><span style=color:#399ee6>dependencies</span><span>]
</span><span style=color:#399ee6>js-sys </span><span>= </span><span style=color:#86b300>"0.3"
</span><span>
</span><span style=color:#abb0b6;font-style:italic># After:
</span><span>[</span><span style=color:#399ee6>target</span><span style=color:#61676ccc>.</span><span style=color:#86b300>'cfg(target_arch = "wasm32")'</span><span style=color:#61676ccc>.</span><span style=color:#399ee6>dependencies</span><span>]
</span><span style=color:#399ee6>js-sys </span><span>= </span><span style=color:#86b300>"0.3.83"
</span></code></pre><h3 id=crates-bevy-render-src-view-window-screenshot-rs><code>crates/bevy_render/src/view/window/screenshot.rs</code></h3><p><strong>Change</strong>: Replaced unsafe <code>js_sys::Uint8Array::view()</code> with safe <code>js_sys::Uint8Array::new_from_slice()</code>.<p><strong>Why</strong>: The <code>view()</code> method creates a JavaScript view into Rust memory, which becomes invalid when the Rust data is dropped, causing undefined behavior. The <code>new_from_slice()</code> method copies the data to JavaScript-managed memory, ensuring it remains valid.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// File: crates/bevy_render/src/view/window/screenshot.rs
</span><span style=color:#abb0b6;font-style:italic>// Before (unsafe):
</span><span style=color:#fa6e32>let</span><span> parts </span><span style=color:#ed9366>= </span><span>js_sys</span><span style=color:#ed9366>::</span><span>Array</span><span style=color:#ed9366>::</span><span>of1(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>unsafe </span><span>{
</span><span>    js_sys</span><span style=color:#ed9366>::</span><span>Uint8Array</span><span style=color:#ed9366>::</span><span>view(image_buffer</span><span style=color:#ed9366>.</span><span style=color:#f07171>into_inner</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_bytes</span><span>())
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()
</span><span>})</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After (safe):
</span><span style=color:#fa6e32>let</span><span> parts </span><span style=color:#ed9366>= </span><span>js_sys</span><span style=color:#ed9366>::</span><span>Array</span><span style=color:#ed9366>::</span><span>of1(
</span><span>    </span><span style=color:#ed9366>&</span><span>js_sys</span><span style=color:#ed9366>::</span><span>Uint8Array</span><span style=color:#ed9366>::</span><span>new_from_slice(
</span><span>        image_buffer</span><span style=color:#ed9366>.</span><span style=color:#f07171>into_inner</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_bytes</span><span>()</span><span style=color:#61676ccc>,
</span><span>    )
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><p><strong>Technical Detail</strong>: The key difference is memory management:<ul><li><code>view()</code>: Creates a view without copying data. The JavaScript array references the Rust <code>Vec&LTu8></code> memory directly.<li><code>new_from_slice()</code>: Copies the data from Rust memory to JavaScript memory, creating independent ownership.</ul><h2 id=further-reading>Further Reading</h2><ol><li><strong>Rust and WebAssembly Book</strong>: https://rustwasm.github.io/docs/book/<li><strong>js-sys crate documentation</strong>: https://docs.rs/js-sys/latest/js_sys/<li><strong>Rustonomicon - Working with Unsafe Code</strong>: https://doc.rust-lang.org/nomicon/<li><strong>WebAssembly Memory Model</strong>: https://webassembly.github.io/spec/core/syntax/modules.html#memories<li><strong>Bevy WebAssembly Guide</strong>: https://github.com/bevyengine/bevy/blob/main/examples/README.md#wasm</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22077.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>