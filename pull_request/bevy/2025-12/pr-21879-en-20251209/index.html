<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21879 Fix shader compilation fail when using visibility range
        
    </title><meta content="#21879 Fix shader compilation fail when using visibility range" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-09</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-21879-zh-cn-20251209>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>Fix shader compilation fail when using visibility range<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix shader compilation fail when using visibility range<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21879<li><strong>Author</strong>: newDINO<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, S-Ready-For-Final-Review, D-Straightforward, D-Shaders<li><strong>Created</strong>: 2025-11-18T07:46:21Z<li><strong>Merged</strong>: 2025-12-09T05:45:42Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>When using both deferred rendering and visibility range, shader <code>pbr.wgsl</code> can’t be compiled because <code>pbr_functions</code> is not imported.<p>The issue can be reproduced by using <code>DefaultOpaqueRendererMethod::deferred()</code> and adding <code>DeferredPrepass</code> to camera at the visibility_range example.<h2 id=solution>Solution</h2><p>Import <code>pbr_functions</code> when using <code>PREPASS_PIPELINE</code>.<h2 id=testing>Testing</h2><p>I tested on visibility_range and deferred_rendering example. However, importing something usually doesn’t break anything.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a shader compilation failure that occurs when combining two specific rendering features in the Bevy game engine: deferred rendering and visibility range. The issue was straightforward but revealed an interesting edge case in how shader modules manage their dependencies.<p>The problem manifested when developers enabled both deferred rendering (using <code>DefaultOpaqueRendererMethod::deferred()</code>) and visibility range features together. In this configuration, the PBR (Physically Based Rendering) shader (<code>pbr.wgsl</code>) would fail to compile with an error indicating that <code>pbr_functions</code> was not imported. This was reproducible in the visibility_range example by simply adding the <code>DeferredPrepass</code> component to the camera.<p>Looking at the shader code structure, Bevy uses conditional compilation via preprocessor-style directives (<code>#ifdef</code>) to include different code paths based on active rendering features. The <code>pbr.wgsl</code> file had two main import paths:<ol><li>When <code>PREPASS_PIPELINE</code> was defined (for deferred rendering), it imported a specific set of modules<li>Otherwise, it imported a different set that included <code>pbr_functions</code></ol><p>The issue arose because the visibility range dithering functionality - which requires the <code>visibility_range_dither</code> function from <code>pbr_functions</code> - was conditionally compiled when <code>VISIBILITY_RANGE_DITHER</code> was defined, but this function wasn’t available in the deferred rendering import path.<p>The solution was elegant in its simplicity. Rather than restructuring the entire import system or duplicating function definitions, the fix added a targeted import specifically for the visibility range functionality when it was needed. The implementation added:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>#ifdef VISIBILITY_RANGE_DITHER
</span><span>#import bevy_pbr::pbr_functions::visibility_range_dither;
</span><span>#endif
</span></code></pre><p>This conditional import ensured that when visibility range dithering was active, the required function would be available regardless of whether the shader was compiled for forward or deferred rendering. The corresponding function call was also updated to reference the directly imported function rather than going through the <code>pbr_functions</code> module prefix.<p>The change demonstrates a common pattern in shader programming where careful management of dependencies is necessary due to the different compilation paths. By adding a minimal, targeted import, the fix resolved the compilation error without affecting other rendering paths or adding unnecessary dependencies to shaders that don’t use visibility range functionality.<p>From an architectural perspective, this fix highlights the importance of considering all possible feature combinations when designing conditional compilation systems. While forward and deferred rendering paths might seem mutually exclusive, features like visibility range can be orthogonal and need to work with both. The solution shows good engineering judgment by addressing the specific missing dependency rather than over-engineering a broader solution.<p>The impact of this fix is that developers can now safely combine deferred rendering with visibility range functionality without encountering shader compilation errors. This resolves what would otherwise be a blocking issue for games wanting to use both performance-enhancing rendering techniques.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[pbr.wgsl Shader] --> B{PREPASS_PIPELINE?};
</span><span>    B -->|Yes| C[Deferred Rendering Path];
</span><span>    B -->|No| D[Forward Rendering Path];
</span><span>    C --> E{VISIBILITY_RANGE_DITHER?};
</span><span>    D --> F{VISIBILITY_RANGE_DITHER?};
</span><span>    E -->|Yes| G[Import pbr_functions::visibility_range_dither];
</span><span>    F -->|Yes| H[Import pbr_functions::visibility_range_dither];
</span><span>    E -->|No| I[No additional import];
</span><span>    F -->|No| J[No additional import];
</span><span>    G --> K[Call visibility_range_dither];
</span><span>    H --> K;
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>File: <code>crates/bevy_pbr/src/render/pbr.wgsl</code></strong><p>This is the main PBR shader file where the compilation error occurred. The changes fix a missing import dependency when both deferred rendering and visibility range features are enabled together.<p><strong>Key modifications:</strong><ol><li><strong>Added conditional import for visibility range dithering:</strong></ol><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before: No import for pbr_functions when VISIBILITY_RANGE_DITHER is defined
</span><span>// (in the PREPASS_PIPELINE code path)
</span><span>
</span><span>// After: Added targeted import
</span><span>#ifdef VISIBILITY_RANGE_DITHER
</span><span>#import bevy_pbr::pbr_functions::visibility_range_dither;
</span><span>#endif
</span></code></pre><ol start=2><li><strong>Updated function call to use directly imported function:</strong></ol><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before: Called through pbr_functions module
</span><span>#ifdef VISIBILITY_RANGE_DITHER
</span><span>    pbr_functions::visibility_range_dither(in.position, in.visibility_range_dither);
</span><span>#endif
</span><span>
</span><span>// After: Calls directly imported function
</span><span>#ifdef VISIBILITY_RANGE_DITHER
</span><span>    visibility_range_dither(in.position, in.visibility_range_dither);
</span><span>#endif
</span></code></pre><p><strong>Why these changes matter:</strong><ul><li>The conditional import ensures the <code>visibility_range_dither</code> function is available in both forward and deferred rendering paths<li>The direct function call eliminates the dependency on the <code>pbr_functions</code> module being fully imported in the deferred rendering path<li>This maintains clean separation of concerns while fixing the compilation error</ul><h2 id=further-reading>Further Reading</h2><p>For those interested in understanding the broader context:<ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/getting-started/rendering/pbr/ target=_blank>Bevy’s PBR Rendering Documentation</a> - Overview of Bevy’s physically-based rendering system<li><a rel="noopener nofollow noreferrer" href=https://www.w3.org/TR/WGSL/ target=_blank>WGSL Shader Language Specification</a> - The WebGPU Shading Language used by Bevy<li><a rel="noopener nofollow noreferrer" href=https://learnopengl.com/Advanced-Lighting/Deferred-Shading target=_blank>Deferred Rendering vs Forward Rendering</a> - Technical comparison of rendering approaches<li><a rel="noopener nofollow noreferrer" href=https://advances.realtimerendering.com/s2015/2015_02_04_Dynamic_Visibility_Driven_Rendering.pdf target=_blank>Visibility Buffer Techniques</a> - Advanced visibility techniques in modern rendering</ul><h1 id=full-code-diff>Full Code Diff</h1><pre style=color:#61676c;background-color:#fafafa><code><span>diff --git a/crates/bevy_pbr/src/render/pbr.wgsl b/crates/bevy_pbr/src/render/pbr.wgsl
</span><span>index 1722ab9d91940..e4d8fe63791d7 100644
</span><span>--- a/crates/bevy_pbr/src/render/pbr.wgsl
</span><span>+++ b/crates/bevy_pbr/src/render/pbr.wgsl
</span><span>@@ -13,12 +13,15 @@
</span><span> #else
</span><span> #import bevy_pbr::{
</span><span>     forward_io::{VertexOutput, FragmentOutput},
</span><span>-    pbr_functions,
</span><span>     pbr_functions::{apply_pbr_lighting, main_pass_post_lighting_processing},
</span><span>     pbr_types::STANDARD_MATERIAL_FLAGS_UNLIT_BIT,
</span><span> }
</span><span> #endif
</span><span> 
</span><span>+#ifdef VISIBILITY_RANGE_DITHER
</span><span>+#import bevy_pbr::pbr_functions::visibility_range_dither;
</span><span>+#endif
</span><span>+
</span><span> #ifdef MESHLET_MESH_MATERIAL_PASS
</span><span> #import bevy_pbr::meshlet_visibility_buffer_resolve::resolve_vertex_output
</span><span> #endif
</span><span>@@ -50,7 +53,7 @@ fn fragment(
</span><span>     // If we're in the crossfade section of a visibility range, conditionally
</span><span>     // discard the fragment according to the visibility pattern.
</span><span> #ifdef VISIBILITY_RANGE_DITHER
</span><span>-    pbr_functions::visibility_range_dither(in.position, in.visibility_range_dither);
</span><span>+    visibility_range_dither(in.position, in.visibility_range_dither);
</span><span> #endif
</span><span> 
</span><span> #ifdef FORWARD_DECAL
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_21879.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>