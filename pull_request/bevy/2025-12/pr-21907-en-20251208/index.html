<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21907 Solari: Improve specular GI
        
    </title><meta content="#21907 Solari: Improve specular GI" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-08</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-21907-zh-cn-20251208>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Solari: Improve specular GI<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21907<li><strong>Author</strong>: JMS55<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, S-Ready-For-Final-Review, D-Complex, C-Refinement<li><strong>Created</strong>: 2025-11-21T19:47:20Z<li><strong>Merged</strong>: 2025-12-07T23:57:22Z<li><strong>Merged By</strong>: james7132</ul><h2 id=description-translation>Description Translation</h2><p>Go back to only sampling the world cache for rough and non-first-bounce surfaces, but sample direct lighting when that doesn’t happen.<p>Mainline <img alt=image height=1875 src=https://github.com/user-attachments/assets/1247d357-d190-4fdc-a7b3-396d42478b99 width=3206><p>This PR <img alt=image height=1875 src=https://github.com/user-attachments/assets/927bca68-4cac-4aef-87d5-dce079eb54af width=3206><p>Pathtraced reference <img alt=image height=1875 src=https://github.com/user-attachments/assets/d6668bde-521c-47c7-b4d5-0ba6c8db5cc8 width=3206><p>Fixes https://github.com/bevyengine/bevy/issues/21967.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a problem with the specular global illumination (GI) implementation in Bevy’s Solari renderer. The issue was that the previous implementation had an overly simplistic approach to handling multiple importance sampling (MIS) and path termination decisions for glossy surfaces, which resulted in visual artifacts and energy loss compared to a path-traced reference.<p>The core problem stemmed from how the renderer decided when to use the world cache (a precomputed lighting cache) versus performing direct lighting calculations. Previously, the system would sample the world cache for all surfaces with roughness greater than 0.1, regardless of whether it was the first bounce or not. This approach missed important direct lighting contributions for moderately glossy surfaces and didn’t properly handle MIS weights between different sampling strategies.<p>The solution involved three key changes: refining the roughness thresholds for cache usage, properly implementing MIS for both emissive and direct lighting contributions, and fixing a subtle bug in the light sampling probability calculation.<p>In the <code>specular_gi.wgsl</code> file, the developer introduced two new roughness thresholds: <code>DIFFUSE_GI_REUSE_ROUGHNESS_THRESHOLD</code> (0.4) and <code>WORLD_CACHE_TERMINATION_ROUGHNESS_THRESHOLD</code> (0.4). These values replaced the previous hardcoded 0.1 threshold, allowing moderately rough surfaces to benefit from both direct lighting calculations and the world cache. The logic now follows a more principled approach:<ul><li>For very rough surfaces (roughness > 0.4), reuse the ReSTIR GI reservoir<li>For moderately rough surfaces, sample direct lighting via next event estimation (NEE)<li>Only terminate paths in the world cache for rough surfaces after the first bounce</ul><p>The implementation properly handles MIS weights between BRDF sampling and light sampling. Two new helper functions were added: <code>emissive_mis_weight</code> for weighting emissive surface contributions and <code>nee_mis_weight</code> for weighting direct lighting contributions. These functions use the power heuristic to balance between the probability of sampling a direction via the BRDF versus sampling a light source.<p>A related fix was made in the pathtracer to ensure consistency. The <code>random_light_pdf</code> function was renamed to <code>random_emissive_light_pdf</code> and its calculation was corrected to properly account for the probability of hitting an emissive triangle. Additionally, the direct lighting calculation now checks the <code>brdf_rays_can_hit</code> flag before computing MIS weights, preventing incorrect weighting when BRDF rays cannot hit the sampled light.<p>The changes in <code>sampling.wgsl</code> include an optimization for nearly mirror-like surfaces (roughness ≤ 0.01), where the sampling function now returns the perfect reflection direction instead of performing expensive VNDF sampling. This is both mathematically correct and performance beneficial.<p>The result is a specular GI implementation that more closely matches the path-traced reference, with better handling of glossy surfaces and proper energy conservation. The render shows improved specular highlights and more accurate indirect lighting for materials with moderate roughness.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Specular GI Shader] --> B{Roughness Check}
</span><span>    B -->|Roughness > 0.4| C[Reuse ReSTIR GI Reservoir]
</span><span>    B -->|Roughness ≤ 0.4| D[Trace Glossy Path]
</span><span>    D --> E{First Bounce?}
</span><span>    E -->|Yes| F[Sample GGX VNDF for next bounce]
</span><span>    E -->|No| G{Roughness > 0.4?}
</span><span>    G -->|Yes| H[Terminate in World Cache]
</span><span>    G -->|No| I[Sample Direct Lighting + World Cache]
</span><span>    
</span><span>    J[Light Sampling] --> K{BRDF Rays Can Hit?}
</span><span>    K -->|Yes| L[Compute MIS Weight]
</span><span>    K -->|No| M[Weight = 1.0]
</span><span>    
</span><span>    F --> N[Update Throughput]
</span><span>    N --> D
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-solari-src-realtime-specular-gi-wgsl-56-13><code>crates/bevy_solari/src/realtime/specular_gi.wgsl</code> (+56/-13)</h3><p>This file contains the main changes to the specular GI shader. The key modifications include:<ol><li>Introducing roughness threshold constants for better control over when to use different lighting strategies<li>Refactoring the <code>trace_glossy_path</code> function to properly handle MIS weights and direct lighting<li>Adding helper functions for computing MIS weights for emissive surfaces and next event estimation</ol><p>Key code changes:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before: Hardcoded threshold of 0.1
</span><span>if surface.material.roughness > 0.1 {
</span><span>    // Reuse GI reservoir
</span><span>}
</span><span>
</span><span>// After: Configurable threshold
</span><span>const DIFFUSE_GI_REUSE_ROUGHNESS_THRESHOLD: f32 = 0.4;
</span><span>if surface.material.roughness > DIFFUSE_GI_REUSE_ROUGHNESS_THRESHOLD {
</span><span>    // Reuse GI reservoir
</span><span>}
</span><span>
</span><span>// New helper function for emissive MIS weighting
</span><span>fn emissive_mis_weight(p_bounce: f32, ray_hit: ResolvedRayHitFull, previous_surface_perfectly_specular: bool) -> f32 {
</span><span>    if previous_surface_perfectly_specular { return 1.0; }
</span><span>    
</span><span>    let p_light = random_emissive_light_pdf(ray_hit);
</span><span>    return power_heuristic(p_bounce, p_light);
</span><span>}
</span></code></pre><h3 id=crates-bevy-solari-src-pathtracer-pathtracer-wgsl-9-4><code>crates/bevy_solari/src/pathtracer/pathtracer.wgsl</code> (+9/-4)</h3><p>This file updates the pathtracer to use the corrected light PDF calculation and properly handle the <code>brdf_rays_can_hit</code> flag for MIS weights.<p>Key code changes:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before: Using old function name and simple MIS weight calculation
</span><span>let p_light = random_light_pdf(ray_hit);
</span><span>mis_weight = power_heuristic(p_bounce, p_light);
</span><span>
</span><span>// After: Using corrected function name
</span><span>let p_light = random_emissive_light_pdf(ray_hit);
</span><span>mis_weight = power_heuristic(p_bounce, p_light);
</span><span>
</span><span>// New check for brdf_rays_can_hit flag
</span><span>mis_weight = 1.0;
</span><span>if direct_lighting.brdf_rays_can_hit {
</span><span>    let pdf_of_bounce = brdf_pdf(wo, direct_lighting.wi, ray_hit);
</span><span>    mis_weight = power_heuristic(1.0 / direct_lighting.inverse_pdf, pdf_of_bounce);
</span><span>}
</span></code></pre><h3 id=crates-bevy-solari-src-scene-sampling-wgsl-8-4><code>crates/bevy_solari/src/scene/sampling.wgsl</code> (+8/-4)</h3><p>This file contains improvements to the sampling functions, including an optimization for near-mirror surfaces and a correction to the emissive light PDF calculation.<p>Key code changes:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Optimization for near-mirror surfaces
</span><span>fn sample_ggx_vndf(wi_tangent: vec3&LTf32>, roughness: f32, rng: ptr&LTfunction, u32>) -> vec3&LTf32> {
</span><span>    if roughness <= 0.01 {
</span><span>        return vec3(-wi_tangent.xy, wi_tangent.z);
</span><span>    }
</span><span>    // ... rest of the function
</span><span>}
</span><span>
</span><span>// Corrected PDF calculation for emissive lights
</span><span>fn random_emissive_light_pdf(hit: ResolvedRayHitFull) -> f32 {
</span><span>    let light_count = arrayLength(&light_sources);
</span><span>    return 1.0 / (f32(light_count) * f32(hit.triangle_count) * hit.triangle_area);
</span><span>}
</span><span>
</span><span>// Added brdf_rays_can_hit flag to LightContribution struct
</span><span>struct LightContribution {
</span><span>    radiance: vec3&LTf32>,
</span><span>    inverse_pdf: f32,
</span><span>    wi: vec3&LTf32>,
</span><span>    brdf_rays_can_hit: bool,
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><strong>Multiple Importance Sampling (MIS)</strong>: Eric Veach’s PhD thesis “Robust Monte Carlo Methods for Light Transport Simulation” provides the foundational theory for MIS and the power heuristic used in this PR.<li><strong>GGX VNDF Sampling</strong>: The paper “Bounded VNDF Sampling for Smith-GGX Reflections” by Heitz et al. describes the sampling technique used for glossy surfaces.<li><strong>ReSTIR GI</strong>: The original ReSTIR GI paper “Spatiotemporal reservoir resampling for real-time ray tracing with dynamic direct lighting” by Bitterli et al. explains the technique used for diffuse GI reuse.<li><strong>Physically Based Rendering</strong>: The PBRT book by Matt Pharr, Wenzel Jakob, and Greg Humphreys covers the fundamental concepts of light transport and importance sampling.</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_21907.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>