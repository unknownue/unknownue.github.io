<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21982 Fix unsound `&EntityMutExcept` to `FilteredEntityMut` conversion
        
    </title><meta content="#21982 Fix unsound `&EntityMutExcept` to `FilteredEntityMut` conversion" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-07</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-21982-zh-cn-20251207>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix unsound <code>&EntityMutExcept</code> to <code>FilteredEntityMut</code> conversion<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21982<li><strong>Author</strong>: ItsDoot<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, D-Trivial, A-ECS, S-Ready-For-Final-Review, P-Unsound<li><strong>Created</strong>: 2025-11-30T11:11:07Z<li><strong>Merged</strong>: 2025-12-07T19:10:07Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><p>This is already in English, so including the original description exactly as-is:<h1 id=objective>Objective</h1><p>Fix an effectively <code>& &mut</code> -> <code>&mut</code> conversion.<h2 id=solution>Solution</h2><p>Switch it to <code>&mut &mut</code> -> <code>&mut</code>.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a soundness issue in Bevy’s ECS (Entity Component System) where a type conversion was incorrectly allowing immutable references to produce mutable handles. The problem was subtle but critical for maintaining Rust’s borrowing guarantees.<p><strong>The Problem and Context</strong><p>In Bevy’s ECS, <code>EntityMutExcept</code> is a type that provides mutable access to an entity while excluding access to certain components (specified by a <code>Bundle</code>). This is useful when you need to work with an entity but want to ensure you don’t accidentally modify specific components. The <code>FilteredEntityMut</code> type is a more general mutable entity handle that can filter component access based on arbitrary conditions.<p>The issue was in the <code>From</code> implementation that allowed converting a shared reference (<code>&EntityMutExcept</code>) into a <code>FilteredEntityMut</code>. This created a soundness violation because:<ul><li><code>EntityMutExcept</code> internally contains mutable access to entity data<li>Taking an immutable reference (<code>&EntityMutExcept</code>) doesn’t guarantee exclusive access to the underlying entity<li>Converting this to <code>FilteredEntityMut</code> would then allow mutable operations through what was originally an immutable reference</ul><p>In Rust terms, this was effectively trying to convert <code>& &mut T</code> into <code>&mut T</code>, which violates Rust’s borrowing rules. The compiler’s borrow checker might not catch this because the conversion happens through trait implementations rather than direct type conversions.<p><strong>The Solution Approach</strong><p>The fix is straightforward and correct: change the <code>From</code> implementation to require a mutable reference (<code>&mut EntityMutExcept</code>) instead of an immutable reference. This ensures that when you convert to a <code>FilteredEntityMut</code>, you must already have exclusive mutable access to the <code>EntityMutExcept</code>, which then properly transfers that exclusivity to the <code>FilteredEntityMut</code>.<p>This aligns with Rust’s ownership and borrowing principles:<ul><li>If you have an immutable reference, you can only perform immutable operations<li>If you need to perform mutable operations, you need a mutable reference<li>Converting between handle types shouldn’t bypass these guarantees</ul><p><strong>The Implementation</strong><p>The implementation change is minimal but critical. In <code>crates/bevy_ecs/src/world/entity_access/except.rs</code>, the <code>From</code> implementation for <code>FilteredEntityMut</code> was changed from accepting <code>&EntityMutExcept</code> to accepting <code>&mut EntityMutExcept</code>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Unsound conversion from immutable reference
</span><span style=color:#fa6e32>impl</span><span><</span><span style=color:#fa6e32>'w</span><span>, </span><span style=color:#fa6e32>'s</span><span>, B</span><span style=color:#61676ccc>:</span><span> Bundle> </span><span style=color:#55b4d4;font-style:italic>From</span><span><</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'w </span><span>EntityMutExcept<'</span><span style=color:#ed9366>_</span><span>, </span><span style=color:#fa6e32>'s</span><span>, B>> </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>FilteredEntityMut</span><span><</span><span style=color:#fa6e32>'w</span><span>, </span><span style=color:#fa6e32>'s</span><span>> {
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>from</span><span>(</span><span style=color:#ff8f40>value</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'w </span><span>EntityMutExcept<'</span><span style=color:#ed9366>_</span><span>, </span><span style=color:#fa6e32>'s</span><span>, B>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// SAFETY:
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// - The FilteredEntityMut has the same component access as the given EntityMutExcept.
</span><span>        </span><span style=color:#fa6e32>unsafe </span><span>{ FilteredEntityMut</span><span style=color:#ed9366>::</span><span>new(value</span><span style=color:#ed9366>.</span><span>entity</span><span style=color:#61676ccc>,</span><span> value</span><span style=color:#ed9366>.</span><span>access) }
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Sound conversion requiring mutable reference
</span><span style=color:#fa6e32>impl</span><span><</span><span style=color:#fa6e32>'w</span><span>, </span><span style=color:#fa6e32>'s</span><span>, B</span><span style=color:#61676ccc>:</span><span> Bundle> </span><span style=color:#55b4d4;font-style:italic>From</span><span><</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'w mut </span><span>EntityMutExcept<'</span><span style=color:#ed9366>_</span><span>, </span><span style=color:#fa6e32>'s</span><span>, B>> </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>FilteredEntityMut</span><span><</span><span style=color:#fa6e32>'w</span><span>, </span><span style=color:#fa6e32>'s</span><span>> {
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>from</span><span>(</span><span style=color:#ff8f40>value</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'w mut </span><span>EntityMutExcept<'</span><span style=color:#ed9366>_</span><span>, </span><span style=color:#fa6e32>'s</span><span>, B>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// SAFETY:
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// - The FilteredEntityMut has the same component access as the given EntityMutExcept.
</span><span>        </span><span style=color:#fa6e32>unsafe </span><span>{ FilteredEntityMut</span><span style=color:#ed9366>::</span><span>new(value</span><span style=color:#ed9366>.</span><span>entity</span><span style=color:#61676ccc>,</span><span> value</span><span style=color:#ed9366>.</span><span>access) }
</span><span>    }
</span><span>}
</span></code></pre><p>The safety comment remains valid because the safety invariants of <code>FilteredEntityMut::new</code> don’t depend on whether the input reference is mutable or immutable. What changes is the soundness of the conversion itself - by requiring a mutable reference, we ensure proper exclusivity.<p><strong>Technical Insights</strong><p>This fix demonstrates several important Rust concepts:<ol><li><p><strong>Reference Mutability and Aliasing</strong>: Rust’s borrow checker prevents data races by enforcing that either you have one mutable reference or multiple immutable references, but not both. The original code violated this by allowing mutable access through what appeared to be an immutable reference path.</p><li><p><strong>Type Conversions and Safety</strong>: Even when using <code>unsafe</code> blocks for performance or implementation reasons, the public API must maintain Rust’s safety guarantees. The <code>unsafe</code> block here is for creating the <code>FilteredEntityMut</code>, but the conversion trait implementation itself must ensure proper preconditions.</p><li><p><strong>Entity Component System Patterns</strong>: In ECS systems, entity handles often need to propagate access permissions correctly. This fix ensures that access control flows properly through the conversion chain.</p></ol><p><strong>The Impact</strong><p>This fix prevents potential undefined behavior in code that uses <code>EntityMutExcept</code> and converts it to <code>FilteredEntityMut</code>. Without this fix, concurrent systems could potentially have mutable access to the same entity data, leading to data races or other memory safety issues.<p>The impact is primarily on code correctness rather than performance or features. Code that was previously using the conversion with immutable references will now need to use mutable references, which may require adjusting call sites to ensure proper borrowing. This is a breaking change for that specific API usage, but necessary for soundness.<p>The labels on the PR tell the story: it’s marked as a bug (<code>C-Bug</code>), trivial in implementation complexity (<code>D-Trivial</code>), related to ECS (<code>A-ECS</code>), and most importantly, addressing unsoundness (<code>P-Unsound</code>). Unsoundness fixes are typically high priority in Rust projects because they affect the fundamental safety guarantees of the language.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[&EntityMutExcept] -->|Previously: Unsound| B[FilteredEntityMut&LTbr/>(mutable access)]
</span><span>    C[&mut EntityMutExcept] -->|Now: Sound| B
</span><span>    
</span><span>    style A stroke:#f66,stroke-width:2px
</span><span>    style C stroke:#6f6,stroke-width:2px
</span><span>    style B stroke:#333,stroke-width:2px
</span></code></pre><p>This diagram shows the problematic conversion path (in red) that was fixed, and the correct conversion path (in green) that now properly requires mutable access.<h2 id=key-files-changed>Key Files Changed</h2><p><strong>File: <code>crates/bevy_ecs/src/world/entity_access/except.rs</code></strong><ul><li><strong>Change</strong>: Modified the <code>From<&EntityMutExcept></code> implementation to <code>From<&mut EntityMutExcept></code> for <code>FilteredEntityMut</code><li><strong>Reason</strong>: To fix a soundness issue where immutable references could be converted to mutable handles<li><strong>Impact</strong>: Ensures proper borrowing rules are maintained when converting between entity handle types</ul><p><strong>Code Change:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before (unsound):
</span><span style=color:#fa6e32>impl</span><span><</span><span style=color:#fa6e32>'w</span><span>, </span><span style=color:#fa6e32>'s</span><span>, B</span><span style=color:#61676ccc>:</span><span> Bundle> </span><span style=color:#55b4d4;font-style:italic>From</span><span><</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'w </span><span>EntityMutExcept<'</span><span style=color:#ed9366>_</span><span>, </span><span style=color:#fa6e32>'s</span><span>, B>> </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>FilteredEntityMut</span><span><</span><span style=color:#fa6e32>'w</span><span>, </span><span style=color:#fa6e32>'s</span><span>> {
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>from</span><span>(</span><span style=color:#ff8f40>value</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'w </span><span>EntityMutExcept<'</span><span style=color:#ed9366>_</span><span>, </span><span style=color:#fa6e32>'s</span><span>, B>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// SAFETY:
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// - The FilteredEntityMut has the same component access as the given EntityMutExcept.
</span><span>        </span><span style=color:#fa6e32>unsafe </span><span>{ FilteredEntityMut</span><span style=color:#ed9366>::</span><span>new(value</span><span style=color:#ed9366>.</span><span>entity</span><span style=color:#61676ccc>,</span><span> value</span><span style=color:#ed9366>.</span><span>access) }
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After (sound):
</span><span style=color:#fa6e32>impl</span><span><</span><span style=color:#fa6e32>'w</span><span>, </span><span style=color:#fa6e32>'s</span><span>, B</span><span style=color:#61676ccc>:</span><span> Bundle> </span><span style=color:#55b4d4;font-style:italic>From</span><span><</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'w mut </span><span>EntityMutExcept<'</span><span style=color:#ed9366>_</span><span>, </span><span style=color:#fa6e32>'s</span><span>, B>> </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>FilteredEntityMut</span><span><</span><span style=color:#fa6e32>'w</span><span>, </span><span style=color:#fa6e32>'s</span><span>> {
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>from</span><span>(</span><span style=color:#ff8f40>value</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'w mut </span><span>EntityMutExcept<'</span><span style=color:#ed9366>_</span><span>, </span><span style=color:#fa6e32>'s</span><span>, B>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// SAFETY:
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// - The FilteredEntityMut has the same component access as the given EntityMutExcept.
</span><span>        </span><span style=color:#fa6e32>unsafe </span><span>{ FilteredEntityMut</span><span style=color:#ed9366>::</span><span>new(value</span><span style=color:#ed9366>.</span><span>entity</span><span style=color:#61676ccc>,</span><span> value</span><span style=color:#ed9366>.</span><span>access) }
</span><span>    }
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><p><strong>Rustonomicon - Subtyping and Variance</strong>: https://doc.rust-lang.org/nomicon/subtyping.html</p> <ul><li>Explains Rust’s type system rules around references and mutability</ul><li><p><strong>The Rust Reference - Unsafety</strong>: https://doc.rust-lang.org/reference/unsafety.html</p> <ul><li>Details what constitutes unsafe code and the responsibilities of unsafe blocks</ul><li><p><strong>Bevy ECS Documentation - Entity References</strong>: https://bevyengine.org/learn/ecs/entity-references/</p> <ul><li>Bevy’s documentation on entity handles and access patterns</ul><li><p><strong>Rust API Guidelines - Type Conversions</strong>: https://rust-lang.github.io/api-guidelines/naming.html#conversions-use-as_-to_-into_-conventions-c-conv</p> <ul><li>Best practices for implementing conversion traits in Rust</ul><li><p><strong>Common Rust Lifetime Misconceptions</strong>: https://github.com/pretzelhammer/rust-blog/blob/master/posts/common-rust-lifetime-misconceptions.md</p> <ul><li>Helpful for understanding common pitfalls with references and lifetimes</ul></ol><h1 id=full-code-diff>Full Code Diff</h1><pre style=color:#61676c;background-color:#fafafa><code><span>diff --git a/crates/bevy_ecs/src/world/entity_access/except.rs b/crates/bevy_ecs/src/world/entity_access/except.rs
</span><span>index 92d372e26bd81..6a2261dbf2186 100644
</span><span>--- a/crates/bevy_ecs/src/world/entity_access/except.rs
</span><span>+++ b/crates/bevy_ecs/src/world/entity_access/except.rs
</span><span>@@ -429,8 +429,8 @@ where
</span><span>     }
</span><span> }
</span><span> 
</span><span>-impl<'w, 's, B: Bundle> From<&'w EntityMutExcept<'_, 's, B>> for FilteredEntityMut<'w, 's> {
</span><span>-    fn from(value: &'w EntityMutExcept<'_, 's, B>) -> Self {
</span><span>+impl<'w, 's, B: Bundle> From<&'w mut EntityMutExcept<'_, 's, B>> for FilteredEntityMut<'w, 's> {
</span><span>+    fn from(value: &'w mut EntityMutExcept<'_, 's, B>) -> Self {
</span><span>         // SAFETY:
</span><span>         // - The FilteredEntityMut has the same component access as the given EntityMutExcept.
</span><span>         unsafe { FilteredEntityMut::new(value.entity, value.access) }
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_21982.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>