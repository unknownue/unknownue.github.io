<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22014 Doc trivial ecs unsafe
        
    </title><meta content="#22014 Doc trivial ecs unsafe" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-15</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22014-zh-cn-20251215>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>Doc trivial ecs unsafe<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Doc trivial ecs unsafe<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22014<li><strong>Author</strong>: hymm<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Docs, A-ECS, S-Ready-For-Final-Review, D-Straightforward, D-Unsafe<li><strong>Created</strong>: 2025-12-02T23:36:48Z<li><strong>Merged</strong>: 2025-12-15T02:40:43Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Trying to doc most of the unsafe in the ecs crate so we can turn on <code>unsafe_op_in_unsafe_fn</code>.</ul><h2 id=solution>Solution</h2><ul><li>Unfortunately reviewing the unsafe docs will probably not be trivial if we try to do it all in one pr. There are 400+ warnings when you turn on the lint. So we need to break it up as much as possible as reviewing the safety contracts in some cases isn’t the easiest.<li>This pr includes two types of unsafe blocks. <ol><li>Blocks that already had safety comments, but were missing the <code>unsafe {}</code> block.<li>Unsafe functions that have the same safety contract as their unsafe parent function and are very short. (Usually just the call to the function).</ol></ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The Bevy ECS codebase contains a significant amount of unsafe Rust code necessary for performance and implementing core systems. However, the project had been running with the <code>unsafe_op_in_unsafe_fn</code> lint disabled, which meant that unsafe operations inside unsafe functions didn’t require explicit unsafe blocks. This made it harder to visually identify which specific operations within an unsafe function were actually unsafe.<p>The goal was to enable this lint to improve code safety and maintainability, but doing so revealed over 400 warnings. Attempting to fix all of them in a single PR would have been overwhelming for reviewers, as each unsafe block requires careful analysis of its safety contract. The developer therefore adopted a pragmatic approach: break the work into manageable chunks starting with the simplest cases.<p>This PR represents the first step in that process, focusing on two specific categories of warnings that could be addressed with minimal risk:<p>First, the PR fixes instances where safety comments existed but the corresponding <code>unsafe {}</code> block was missing. These were essentially documentation errors where the code already communicated why an operation was safe, but didn’t follow Rust’s explicit unsafe block requirement for the <code>unsafe_op_in_unsafe_fn</code> lint.<p>Second, the PR addresses unsafe functions that delegate to another unsafe function with identical safety requirements. These are typically one-line functions that just call a parent unsafe function. Wrapping these calls in explicit unsafe blocks makes it clear they’re propagating the same safety contract.<p>The implementation approach is straightforward but systematic. For each warning, the developer examined the existing safety comment and the function’s implementation to verify that the safety requirements were properly documented and that adding the explicit unsafe block wouldn’t change the function’s behavior. This required understanding the ECS system’s internal invariants and how different components interact.<p>One important consideration was handling edge cases like zero-length tuples in macros. The PR includes <code>#[allow(unused_unsafe)]</code> annotations with clear explanations for these cases, demonstrating attention to detail while maintaining the macro’s generality. For example:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>allow</span><span>(
</span><span>    unused_unsafe</span><span style=color:#61676ccc>,
</span><span>    reason </span><span style=color:#ed9366>= </span><span style=color:#86b300>"Zero-length tuples will generate a function body equivalent to `()`; however, this macro is meant for all applicable tuples, and as such it makes no sense to rewrite it just for that case."
</span><span>)]
</span><span style=color:#abb0b6;font-style:italic>// SAFETY: Caller ensures requirements for calling `apply_effect` are met.
</span><span style=color:#fa6e32>unsafe </span><span>{
</span><span>    </span><span style=color:#ed9366>$</span><span>( $name</span><span style=color:#ed9366>::</span><span>apply_effect($alias</span><span style=color:#61676ccc>,</span><span> entity)</span><span style=color:#61676ccc>; </span><span>)</span><span style=color:#ed9366>*
</span><span>}
</span></code></pre><p>The changes span the entire ECS crate, touching systems, queries, storage, bundles, and world access patterns. Each modification follows the same pattern: identify an unsafe operation, verify the existing safety documentation is correct, and wrap it in an explicit unsafe block. The consistency of this approach makes the PR easy to review despite touching many files.<p>This work is foundational for enabling stricter unsafe code linting in Bevy. By starting with the simplest cases, the developer establishes a pattern for future PRs while immediately reducing the warning count. The changes also improve the code’s readability by making unsafe operations more explicit, which helps developers quickly identify which parts of the code require careful safety analysis.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Unsafe ECS Operations] --> B{Has Safety Comment?}
</span><span>    B -->|Yes| C[Add explicit unsafe block]
</span><span>    B -->|No| D[Future PR]
</span><span>    A --> E{Simple delegate function?}
</span><span>    E -->|Yes| F[Wrap call in unsafe block]
</span><span>    E -->|No| D
</span><span>    C --> G[Reduced Warning Count]
</span><span>    F --> G
</span><span>    G --> H[Enable unsafe_op_in_unsafe_fn]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ecs-src-system-system-param-rs-51-19><code>crates/bevy_ecs/src/system/system_param.rs</code> (+51/-19)</h3><p>This file contains the system parameter implementations, which extensively use unsafe code for performance. The changes mainly add explicit unsafe blocks around calls to <code>validate_param</code> and <code>get_param</code> methods in various system parameter implementations (tuples, Option, Result, Vec, etc.).<p><strong>Key modification:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>inline</span><span>]
</span><span style=color:#fa6e32>unsafe fn </span><span style=color:#f29718>get_param</span><span>(
</span><span>    </span><span style=color:#ff8f40>state</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'s mut Self</span><span style=color:#ed9366>::</span><span>State,
</span><span>    </span><span style=color:#ff8f40>system_meta</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>SystemMeta,
</span><span>    </span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>: </span><span>UnsafeWorldCell<</span><span style=color:#fa6e32>'world</span><span>>,
</span><span>    </span><span style=color:#ff8f40>change_tick</span><span style=color:#61676ccc>:</span><span> Tick,
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Item<</span><span style=color:#fa6e32>'world</span><span>, </span><span style=color:#fa6e32>'state</span><span>> {
</span><span>    T</span><span style=color:#ed9366>::</span><span>validate_param(state</span><span style=color:#61676ccc>,</span><span> system_meta</span><span style=color:#61676ccc>,</span><span> world)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>ok</span><span>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|()| T</span><span style=color:#ed9366>::</span><span>get_param(state</span><span style=color:#61676ccc>,</span><span> system_meta</span><span style=color:#61676ccc>,</span><span> world</span><span style=color:#61676ccc>,</span><span> change_tick))
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>inline</span><span>]
</span><span style=color:#fa6e32>unsafe fn </span><span style=color:#f29718>get_param</span><span>(
</span><span>    </span><span style=color:#ff8f40>state</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'s mut Self</span><span style=color:#ed9366>::</span><span>State,
</span><span>    </span><span style=color:#ff8f40>system_meta</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>SystemMeta,
</span><span>    </span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>: </span><span>UnsafeWorldCell<</span><span style=color:#fa6e32>'world</span><span>>,
</span><span>    </span><span style=color:#ff8f40>change_tick</span><span style=color:#61676ccc>:</span><span> Tick,
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Item<</span><span style=color:#fa6e32>'world</span><span>, </span><span style=color:#fa6e32>'state</span><span>> {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// SAFETY: Upheld by caller
</span><span>    </span><span style=color:#fa6e32>unsafe </span><span>{
</span><span>        T</span><span style=color:#ed9366>::</span><span>validate_param(state</span><span style=color:#61676ccc>,</span><span> system_meta</span><span style=color:#61676ccc>,</span><span> world)
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>ok</span><span>()
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|()| T</span><span style=color:#ed9366>::</span><span>get_param(state</span><span style=color:#61676ccc>,</span><span> system_meta</span><span style=color:#61676ccc>,</span><span> world</span><span style=color:#61676ccc>,</span><span> change_tick))
</span><span>    }
</span><span>}
</span></code></pre><h3 id=crates-bevy-ecs-src-world-entity-access-world-mut-rs-20-11><code>crates/bevy_ecs/src/world/entity_access/world_mut.rs</code> (+20/-11)</h3><p>This file handles mutable world access for entities. The changes add unsafe blocks around operations that fetch or manipulate entity components, ensuring that each unsafe operation is explicitly marked.<p><strong>Key modification:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub unsafe fn </span><span style=color:#f29718>insert_by_id</span><span>(
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>,
</span><span>    </span><span style=color:#ff8f40>component_id</span><span style=color:#61676ccc>:</span><span> ComponentId,
</span><span>    </span><span style=color:#ff8f40>component</span><span style=color:#61676ccc>: </span><span>OwningPtr<'</span><span style=color:#ed9366>_</span><span>>,
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut Self </span><span>{
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_by_id_with_caller</span><span>(
</span><span>        component_id</span><span style=color:#61676ccc>,
</span><span>        component</span><span style=color:#61676ccc>,
</span><span>        InsertMode</span><span style=color:#ed9366>::</span><span>Replace</span><span style=color:#61676ccc>,
</span><span>        MaybeLocation</span><span style=color:#ed9366>::</span><span>caller()</span><span style=color:#61676ccc>,
</span><span>        RelationshipHookMode</span><span style=color:#ed9366>::</span><span>Run</span><span style=color:#61676ccc>,
</span><span>    )
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub unsafe fn </span><span style=color:#f29718>insert_by_id</span><span>(
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>,
</span><span>    </span><span style=color:#ff8f40>component_id</span><span style=color:#61676ccc>:</span><span> ComponentId,
</span><span>    </span><span style=color:#ff8f40>component</span><span style=color:#61676ccc>: </span><span>OwningPtr<'</span><span style=color:#ed9366>_</span><span>>,
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut Self </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// SAFETY: Upheld by caller
</span><span>    </span><span style=color:#fa6e32>unsafe </span><span>{
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_by_id_with_caller</span><span>(
</span><span>            component_id</span><span style=color:#61676ccc>,
</span><span>            component</span><span style=color:#61676ccc>,
</span><span>            InsertMode</span><span style=color:#ed9366>::</span><span>Replace</span><span style=color:#61676ccc>,
</span><span>            MaybeLocation</span><span style=color:#ed9366>::</span><span>caller()</span><span style=color:#61676ccc>,
</span><span>            RelationshipHookMode</span><span style=color:#ed9366>::</span><span>Run</span><span style=color:#61676ccc>,
</span><span>        )
</span><span>    }
</span><span>}
</span></code></pre><h3 id=crates-bevy-ecs-src-system-commands-mod-rs-17-11><code>crates/bevy_ecs/src/system/commands/mod.rs</code> (+17/-11)</h3><p>The commands system uses unsafe code for efficient command queue management. The changes wrap unsafe system parameter operations in explicit blocks.<p><strong>Key modification:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>inline</span><span>]
</span><span style=color:#fa6e32>unsafe fn </span><span style=color:#f29718>get_param</span><span>(
</span><span>    </span><span style=color:#ff8f40>state</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'s mut Self</span><span style=color:#ed9366>::</span><span>State,
</span><span>    </span><span style=color:#ff8f40>system_meta</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>SystemMeta,
</span><span>    </span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>: </span><span>UnsafeWorldCell<</span><span style=color:#fa6e32>'w</span><span>>,
</span><span>    </span><span style=color:#ff8f40>change_tick</span><span style=color:#61676ccc>: </span><span>bevy_ecs</span><span style=color:#ed9366>::</span><span>change_detection</span><span style=color:#ed9366>::</span><span>Tick,
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Item<</span><span style=color:#fa6e32>'w</span><span>, </span><span style=color:#fa6e32>'s</span><span>> {
</span><span>    </span><span style=color:#fa6e32>let</span><span> params </span><span style=color:#ed9366>= </span><span><__StructFieldsAlias </span><span style=color:#ed9366>as </span><span>bevy_ecs</span><span style=color:#ed9366>::</span><span>system</span><span style=color:#ed9366>::</span><span>SystemParam></span><span style=color:#ed9366>::</span><span>get_param(
</span><span>        </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> state</span><span style=color:#ed9366>.</span><span>state</span><span style=color:#61676ccc>,
</span><span>        system_meta</span><span style=color:#61676ccc>,
</span><span>        world</span><span style=color:#61676ccc>,
</span><span>        change_tick</span><span style=color:#61676ccc>,
</span><span>    )</span><span style=color:#61676ccc>;
</span><span>    Commands {
</span><span>        queue</span><span style=color:#61676ccc>: </span><span>InternalQueue</span><span style=color:#ed9366>::</span><span>CommandQueue(params</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0</span><span>)</span><span style=color:#61676ccc>,
</span><span>        allocator</span><span style=color:#61676ccc>:</span><span> params</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>,
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>inline</span><span>]
</span><span style=color:#fa6e32>unsafe fn </span><span style=color:#f29718>get_param</span><span>(
</span><span>    </span><span style=color:#ff8f40>state</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'s mut Self</span><span style=color:#ed9366>::</span><span>State,
</span><span>    </span><span style=color:#ff8f40>system_meta</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>SystemMeta,
</span><span>    </span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>: </span><span>UnsafeWorldCell<</span><span style=color:#fa6e32>'w</span><span>>,
</span><span>    </span><span style=color:#ff8f40>change_tick</span><span style=color:#61676ccc>: </span><span>bevy_ecs</span><span style=color:#ed9366>::</span><span>change_detection</span><span style=color:#ed9366>::</span><span>Tick,
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Item<</span><span style=color:#fa6e32>'w</span><span>, </span><span style=color:#fa6e32>'s</span><span>> {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// SAFETY: Upheld by caller
</span><span>    </span><span style=color:#fa6e32>let</span><span> params </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>unsafe </span><span>{
</span><span>        </span><span style=color:#ed9366><</span><span>__StructFieldsAlias </span><span style=color:#ed9366>as </span><span>bevy_ecs</span><span style=color:#ed9366>::</span><span>system</span><span style=color:#ed9366>::</span><span>SystemParam</span><span style=color:#ed9366>>::</span><span>get_param(
</span><span>            </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> state</span><span style=color:#ed9366>.</span><span>state</span><span style=color:#61676ccc>,
</span><span>            system_meta</span><span style=color:#61676ccc>,
</span><span>            world</span><span style=color:#61676ccc>,
</span><span>            change_tick</span><span style=color:#61676ccc>,
</span><span>        )
</span><span>    }</span><span style=color:#61676ccc>;
</span><span>    Commands {
</span><span>        queue</span><span style=color:#61676ccc>: </span><span>InternalQueue</span><span style=color:#ed9366>::</span><span>CommandQueue(params</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0</span><span>)</span><span style=color:#61676ccc>,
</span><span>        allocator</span><span style=color:#61676ccc>:</span><span> params</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>,
</span><span>    }
</span><span>}
</span></code></pre><h3 id=crates-bevy-ecs-src-component-required-rs-13-10><code>crates/bevy_ecs/src/component/required.rs</code> (+13/-10)</h3><p>This file manages component requirement relationships. The changes add unsafe blocks around scope operations that require careful validation of component IDs.<p><strong>Key modification:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#abb0b6;font-style:italic>// SAFETY: the caller guarantees that `requiree` is valid in `self`.
</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>required_components_scope</span><span>(requiree</span><span style=color:#61676ccc>, </span><span>|</span><span style=color:#ff8f40>this</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>required_components</span><span>| {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// SAFETY: the caller guarantees that `required` is valid for type `R` in `self`
</span><span>    </span><span style=color:#fa6e32>unsafe </span><span>{ required_components</span><span style=color:#ed9366>.</span><span style=color:#f07171>register_by_id</span><span>(required</span><span style=color:#61676ccc>,</span><span> this</span><span style=color:#61676ccc>,</span><span> constructor) }</span><span style=color:#61676ccc>;
</span><span>})</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#abb0b6;font-style:italic>// SAFETY: the caller guarantees that `requiree` is valid in `self`.
</span><span style=color:#fa6e32>unsafe </span><span>{
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>required_components_scope</span><span>(requiree</span><span style=color:#61676ccc>, </span><span>|</span><span style=color:#ff8f40>this</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>required_components</span><span>| {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// SAFETY: the caller guarantees that `required` is valid for type `R` in `self`
</span><span>        required_components</span><span style=color:#ed9366>.</span><span style=color:#f07171>register_by_id</span><span>(required</span><span style=color:#61676ccc>,</span><span> this</span><span style=color:#61676ccc>,</span><span> constructor)</span><span style=color:#61676ccc>;
</span><span>    })</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=crates-bevy-ecs-src-bundle-impls-rs-14-2><code>crates/bevy_ecs/src/bundle/impls.rs</code> (+14/-2)</h3><p>This file implements bundle functionality using macros. The changes add unsafe blocks within tuple implementations, with special handling for zero-length tuples.<p><strong>Key modification:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#abb0b6;font-style:italic>// SAFETY: Caller ensures requirements for calling `get_components` are met.
</span><span style=color:#ed9366>$</span><span>( $name</span><span style=color:#ed9366>::</span><span>get_components($alias</span><span style=color:#61676ccc>,</span><span> func)</span><span style=color:#61676ccc>; </span><span>)</span><span style=color:#ed9366>*
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>allow</span><span>(
</span><span>    unused_unsafe</span><span style=color:#61676ccc>,
</span><span>    reason </span><span style=color:#ed9366>= </span><span style=color:#86b300>"Zero-length tuples will generate a function body equivalatent to (); however, this macro is meant for all applicable tuples, and as such it makes no sense to rewrite it just for that case."
</span><span>)]
</span><span style=color:#abb0b6;font-style:italic>// SAFETY: Caller ensures requirements for calling `get_components` are met.
</span><span style=color:#fa6e32>unsafe </span><span>{
</span><span>    </span><span style=color:#ed9366>$</span><span>( $name</span><span style=color:#ed9366>::</span><span>get_components($alias</span><span style=color:#61676ccc>,</span><span> func)</span><span style=color:#61676ccc>; </span><span>)</span><span style=color:#ed9366>*
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li>Rustonomicon: https://doc.rust-lang.org/nomicon/<li>Rust Unsafe Code Guidelines: https://rust-lang.github.io/unsafe-code-guidelines/<li>Bevy ECS Architecture: https://bevyengine.org/learn/book/plugins/ecs/<li>Rust <code>unsafe_op_in_unsafe_fn</code> lint documentation: https://doc.rust-lang.org/rustc/lints/listing/allowed-by-default.html#unsafe-op-in-unsafe-fn</ol><h1 id=full-code-diff>Full Code Diff</h1><p><em>(Note: The full diff is included in the original request but omitted here for brevity. The key changes are documented above.)</em></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22014.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>