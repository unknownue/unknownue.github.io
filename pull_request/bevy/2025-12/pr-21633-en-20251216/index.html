<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21633 Implement `TryStableInterpolate`.
        
    </title><meta content="#21633 Implement `TryStableInterpolate`." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-16</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-21633-zh-cn-20251216>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Implement <code>TryStableInterpolate</code>.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21633<li><strong>Author</strong>: viridia<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Feature, A-UI, S-Ready-For-Final-Review, A-Animation, A-Math<li><strong>Created</strong>: 2025-10-23T03:31:08Z<li><strong>Merged</strong>: 2025-12-16T05:43:14Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>Fixes: #20579<h2 id=testing>Testing</h2><ul><li>Doc test<li>Also tested extensively in a separate repo, however that code was not carried over (yet).</ul><p>Note: Because docs.rs was down, I could not validate the doc link urls.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=the-problem-and-context>The Problem and Context</h3><p>The Bevy engine’s animation system needed a way to handle interpolation between values that might not always be compatible. The existing <code>StableInterpolate</code> trait worked well for numeric types and simple structs, but it couldn’t handle types like <code>Val</code> from <code>bevy_ui</code> or <code>Color</code> from <code>bevy_color</code> when they represented different units or color spaces.<p>For <code>Val</code>, which represents different measurement units (pixels, percentages, viewport units, etc.), interpolating between <code>Val::Px(10)</code> and <code>Val::Percent(50)</code> doesn’t make mathematical sense. Similarly for <code>Color</code>, which has multiple color space representations (RGB, HSL, Lab, etc.), interpolating between different color spaces requires conversion that might be expensive or produce unexpected results.<p>Issue #20579 highlighted this limitation, where developers wanted to animate UI elements but couldn’t use the existing interpolation infrastructure because <code>Val</code> didn’t implement <code>StableInterpolate</code>. The challenge was to provide a way to attempt interpolation that could gracefully handle incompatible cases.<h3 id=the-solution-approach>The Solution Approach</h3><p>The solution introduced a new trait called <code>TryStableInterpolate</code> that provides fallible interpolation. Instead of requiring all interpolations to succeed, this trait returns a <code>Result</code> that can indicate when interpolation fails due to incompatible units or representations. This approach has several advantages:<ol><li>It allows animation systems to attempt interpolation and handle failure gracefully<li>It provides a clear boundary between always-interpolable types and conditionally-interpolable types<li>It maintains backward compatibility through a blanket implementation for existing <code>StableInterpolate</code> types</ol><p>The key insight was that animation systems don’t necessarily need all interpolations to succeed. When interpolation fails, the system can simply “snap” to the target value, which is often acceptable behavior for UI animations and transitions.<h3 id=the-implementation>The Implementation</h3><p>The implementation consists of three main parts:<p>First, in <code>bevy_math</code>, the new <code>TryStableInterpolate</code> trait is defined:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub trait </span><span style=color:#399ee6>TryStableInterpolate</span><span>: Clone {
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Error</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>try_interpolate_stable</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>other</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>Self</span><span>, </span><span style=color:#ff8f40>t</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><</span><span style=color:#fa6e32>Self</span><span>, </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Error></span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>A blanket implementation is provided for all types that already implement <code>StableInterpolate</code>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>impl</span><span>&LTT</span><span style=color:#61676ccc>:</span><span> StableInterpolate> TryStableInterpolate </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>T </span><span>{
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Error </span><span style=color:#ed9366>=</span><span> Infallible</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>try_interpolate_stable</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>other</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>Self</span><span>, </span><span style=color:#ff8f40>t</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><</span><span style=color:#fa6e32>Self</span><span>, </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Error> {
</span><span>        </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>interpolate_stable</span><span>(other</span><span style=color:#61676ccc>,</span><span> t))
</span><span>    }
</span><span>}
</span></code></pre><p>This ensures that all existing code using <code>StableInterpolate</code> automatically gets a <code>TryStableInterpolate</code> implementation that never fails.<p>Second, the <code>Val</code> type in <code>bevy_ui</code> gets an implementation that only succeeds when both values use the same unit:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>impl </span><span>TryStableInterpolate </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>Val </span><span>{
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Error </span><span style=color:#ed9366>=</span><span> MismatchedUnitsError</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>try_interpolate_stable</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>other</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>Self</span><span>, </span><span style=color:#ff8f40>t</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><</span><span style=color:#fa6e32>Self</span><span>, </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Error> {
</span><span>        </span><span style=color:#fa6e32>match </span><span>(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#61676ccc>,</span><span> other) {
</span><span>            (Val</span><span style=color:#ed9366>::</span><span>Px(a)</span><span style=color:#61676ccc>, </span><span>Val</span><span style=color:#ed9366>::</span><span>Px(b)) </span><span style=color:#ed9366>=> </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(Val</span><span style=color:#ed9366>::</span><span>Px(a</span><span style=color:#ed9366>.</span><span style=color:#f07171>interpolate_stable</span><span>(b</span><span style=color:#61676ccc>,</span><span> t)))</span><span style=color:#61676ccc>,
</span><span>            (Val</span><span style=color:#ed9366>::</span><span>Percent(a)</span><span style=color:#61676ccc>, </span><span>Val</span><span style=color:#ed9366>::</span><span>Percent(b)) </span><span style=color:#ed9366>=> </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(Val</span><span style=color:#ed9366>::</span><span>Percent(a</span><span style=color:#ed9366>.</span><span style=color:#f07171>interpolate_stable</span><span>(b</span><span style=color:#61676ccc>,</span><span> t)))</span><span style=color:#61676ccc>,
</span><span>            </span><span style=color:#abb0b6;font-style:italic>// ... other unit matches
</span><span>            </span><span style=color:#ed9366>_ => </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(MismatchedUnitsError)</span><span style=color:#61676ccc>,
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre><p>This pattern ensures type safety by checking at runtime that both values are in compatible units before attempting interpolation.<p>Third, the <code>Color</code> type gets a similar implementation that only interpolates within the same color space:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>impl </span><span>TryStableInterpolate </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>Color </span><span>{
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Error </span><span style=color:#ed9366>=</span><span> MismatchedUnitsError</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>try_interpolate_stable</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>other</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>Self</span><span>, </span><span style=color:#ff8f40>t</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><</span><span style=color:#fa6e32>Self</span><span>, </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Error> {
</span><span>        </span><span style=color:#fa6e32>match </span><span>(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#61676ccc>,</span><span> other) {
</span><span>            (Color</span><span style=color:#ed9366>::</span><span>Srgba(a)</span><span style=color:#61676ccc>, </span><span>Color</span><span style=color:#ed9366>::</span><span>Srgba(b)) </span><span style=color:#ed9366>=> </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(Color</span><span style=color:#ed9366>::</span><span>Srgba(a</span><span style=color:#ed9366>.</span><span style=color:#f07171>mix</span><span>(b</span><span style=color:#61676ccc>,</span><span> t)))</span><span style=color:#61676ccc>,
</span><span>            (Color</span><span style=color:#ed9366>::</span><span>LinearRgba(a)</span><span style=color:#61676ccc>, </span><span>Color</span><span style=color:#ed9366>::</span><span>LinearRgba(b)) </span><span style=color:#ed9366>=> </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(Color</span><span style=color:#ed9366>::</span><span>LinearRgba(a</span><span style=color:#ed9366>.</span><span style=color:#f07171>mix</span><span>(b</span><span style=color:#61676ccc>,</span><span> t)))</span><span style=color:#61676ccc>,
</span><span>            </span><span style=color:#abb0b6;font-style:italic>// ... other color space matches
</span><span>            </span><span style=color:#ed9366>_ => </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(MismatchedUnitsError)</span><span style=color:#61676ccc>,
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre><h3 id=technical-insights>Technical Insights</h3><p>The design uses Rust’s type system effectively. The <code>MismatchedUnitsError</code> type provides a clear error case without requiring complex error hierarchies. Using <code>Infallible</code> for the blanket implementation ensures that types implementing <code>StableInterpolate</code> can be used in contexts expecting <code>TryStableInterpolate</code> without any runtime overhead for error checking.<p>The match statement pattern in the implementations for <code>Val</code> and <code>Color</code> is verbose but provides compile-time safety that all variants are handled. This approach is more maintainable than trying to use a generic conversion approach that might have subtle bugs.<p>One important design decision was to not automatically convert between different units or color spaces. While Bevy’s <code>Color</code> type has mixing methods that can convert between color spaces, those conversions are expensive and can produce unexpected visual results. The <code>TryStableInterpolate</code> implementation takes a more conservative approach, requiring explicit conversion by the caller if needed.<h3 id=the-impact>The Impact</h3><p>This change enables UI animations that were previously impossible. Animation systems can now attempt to interpolate <code>Val</code> values and gracefully handle cases where interpolation fails. This is particularly useful for responsive UI design where elements might switch between different measurement units based on screen size.<p>The implementation also sets a pattern for handling fallible operations in Bevy’s trait system. Other areas of the codebase could adopt similar patterns for operations that might fail under certain conditions.<p>From a performance perspective, the match statement overhead is minimal, and the blanket implementation for <code>StableInterpolate</code> types has zero runtime cost since it uses <code>Infallible</code>. This makes the trait suitable for use in performance-critical animation systems.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[StableInterpolate] -->|Blanket implementation| B[TryStableInterpolate&LTbr/>Error = Infallible]
</span><span>    C[Val] -->|Implements| D[TryStableInterpolate&LTbr/>Error = MismatchedUnitsError]
</span><span>    E[Color] -->|Implements| D
</span><span>    F[MismatchedUnitsError] -->|Returned by| C
</span><span>    F -->|Returned by| E
</span><span>    
</span><span>    subgraph "Always Succeeds"
</span><span>    B
</span><span>    end
</span><span>    
</span><span>    subgraph "May Fail"
</span><span>    C
</span><span>    E
</span><span>    end
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-math-src-common-traits-rs-53-1><code>crates/bevy_math/src/common_traits.rs</code> (+53/-1)</h3><p>This file defines the new <code>TryStableInterpolate</code> trait and provides the blanket implementation for <code>StableInterpolate</code> types. The key addition is:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub trait </span><span style=color:#399ee6>TryStableInterpolate</span><span>: Clone {
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Error</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>try_interpolate_stable</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>other</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>Self</span><span>, </span><span style=color:#ff8f40>t</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><</span><span style=color:#fa6e32>Self</span><span>, </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Error></span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#fa6e32>impl</span><span>&LTT</span><span style=color:#61676ccc>:</span><span> StableInterpolate> TryStableInterpolate </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>T </span><span>{
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Error </span><span style=color:#ed9366>=</span><span> Infallible</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>try_interpolate_stable</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>other</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>Self</span><span>, </span><span style=color:#ff8f40>t</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><</span><span style=color:#fa6e32>Self</span><span>, </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Error> {
</span><span>        </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>interpolate_stable</span><span>(other</span><span style=color:#61676ccc>,</span><span> t))
</span><span>    }
</span><span>}
</span></code></pre><h3 id=crates-bevy-ui-src-geometry-rs-25-1><code>crates/bevy_ui/src/geometry.rs</code> (+25/-1)</h3><p>This file implements <code>TryStableInterpolate</code> for the <code>Val</code> enum. The implementation checks that both values use the same unit before interpolating:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>impl </span><span>TryStableInterpolate </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>Val </span><span>{
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Error </span><span style=color:#ed9366>=</span><span> MismatchedUnitsError</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>try_interpolate_stable</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>other</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>Self</span><span>, </span><span style=color:#ff8f40>t</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><</span><span style=color:#fa6e32>Self</span><span>, </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Error> {
</span><span>        </span><span style=color:#fa6e32>match </span><span>(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#61676ccc>,</span><span> other) {
</span><span>            (Val</span><span style=color:#ed9366>::</span><span>Px(a)</span><span style=color:#61676ccc>, </span><span>Val</span><span style=color:#ed9366>::</span><span>Px(b)) </span><span style=color:#ed9366>=> </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(Val</span><span style=color:#ed9366>::</span><span>Px(a</span><span style=color:#ed9366>.</span><span style=color:#f07171>interpolate_stable</span><span>(b</span><span style=color:#61676ccc>,</span><span> t)))</span><span style=color:#61676ccc>,
</span><span>            (Val</span><span style=color:#ed9366>::</span><span>Percent(a)</span><span style=color:#61676ccc>, </span><span>Val</span><span style=color:#ed9366>::</span><span>Percent(b)) </span><span style=color:#ed9366>=> </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(Val</span><span style=color:#ed9366>::</span><span>Percent(a</span><span style=color:#ed9366>.</span><span style=color:#f07171>interpolate_stable</span><span>(b</span><span style=color:#61676ccc>,</span><span> t)))</span><span style=color:#61676ccc>,
</span><span>            (Val</span><span style=color:#ed9366>::</span><span>Vw(a)</span><span style=color:#61676ccc>, </span><span>Val</span><span style=color:#ed9366>::</span><span>Vw(b)) </span><span style=color:#ed9366>=> </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(Val</span><span style=color:#ed9366>::</span><span>Vw(a</span><span style=color:#ed9366>.</span><span style=color:#f07171>interpolate_stable</span><span>(b</span><span style=color:#61676ccc>,</span><span> t)))</span><span style=color:#61676ccc>,
</span><span>            (Val</span><span style=color:#ed9366>::</span><span>Vh(a)</span><span style=color:#61676ccc>, </span><span>Val</span><span style=color:#ed9366>::</span><span>Vh(b)) </span><span style=color:#ed9366>=> </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(Val</span><span style=color:#ed9366>::</span><span>Vh(a</span><span style=color:#ed9366>.</span><span style=color:#f07171>interpolate_stable</span><span>(b</span><span style=color:#61676ccc>,</span><span> t)))</span><span style=color:#61676ccc>,
</span><span>            (Val</span><span style=color:#ed9366>::</span><span>VMin(a)</span><span style=color:#61676ccc>, </span><span>Val</span><span style=color:#ed9366>::</span><span>VMin(b)) </span><span style=color:#ed9366>=> </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(Val</span><span style=color:#ed9366>::</span><span>VMin(a</span><span style=color:#ed9366>.</span><span style=color:#f07171>interpolate_stable</span><span>(b</span><span style=color:#61676ccc>,</span><span> t)))</span><span style=color:#61676ccc>,
</span><span>            (Val</span><span style=color:#ed9366>::</span><span>VMax(a)</span><span style=color:#61676ccc>, </span><span>Val</span><span style=color:#ed9366>::</span><span>VMax(b)) </span><span style=color:#ed9366>=> </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(Val</span><span style=color:#ed9366>::</span><span>VMax(a</span><span style=color:#ed9366>.</span><span style=color:#f07171>interpolate_stable</span><span>(b</span><span style=color:#61676ccc>,</span><span> t)))</span><span style=color:#61676ccc>,
</span><span>            (Val</span><span style=color:#ed9366>::</span><span>Auto</span><span style=color:#61676ccc>, </span><span>Val</span><span style=color:#ed9366>::</span><span>Auto) </span><span style=color:#ed9366>=> </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(Val</span><span style=color:#ed9366>::</span><span>Auto)</span><span style=color:#61676ccc>,
</span><span>            </span><span style=color:#ed9366>_ => </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(MismatchedUnitsError)</span><span style=color:#61676ccc>,
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre><h3 id=crates-bevy-color-src-color-rs-21-0><code>crates/bevy_color/src/color.rs</code> (+21/-0)</h3><p>This file implements <code>TryStableInterpolate</code> for the <code>Color</code> enum. Similar to <code>Val</code>, it only interpolates within the same color space:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>impl </span><span>TryStableInterpolate </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>Color </span><span>{
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Error </span><span style=color:#ed9366>=</span><span> MismatchedUnitsError</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>try_interpolate_stable</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>other</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>Self</span><span>, </span><span style=color:#ff8f40>t</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><</span><span style=color:#fa6e32>Self</span><span>, </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Error> {
</span><span>        </span><span style=color:#fa6e32>match </span><span>(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#61676ccc>,</span><span> other) {
</span><span>            (Color</span><span style=color:#ed9366>::</span><span>Srgba(a)</span><span style=color:#61676ccc>, </span><span>Color</span><span style=color:#ed9366>::</span><span>Srgba(b)) </span><span style=color:#ed9366>=> </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(Color</span><span style=color:#ed9366>::</span><span>Srgba(a</span><span style=color:#ed9366>.</span><span style=color:#f07171>mix</span><span>(b</span><span style=color:#61676ccc>,</span><span> t)))</span><span style=color:#61676ccc>,
</span><span>            (Color</span><span style=color:#ed9366>::</span><span>LinearRgba(a)</span><span style=color:#61676ccc>, </span><span>Color</span><span style=color:#ed9366>::</span><span>LinearRgba(b)) </span><span style=color:#ed9366>=> </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(Color</span><span style=color:#ed9366>::</span><span>LinearRgba(a</span><span style=color:#ed9366>.</span><span style=color:#f07171>mix</span><span>(b</span><span style=color:#61676ccc>,</span><span> t)))</span><span style=color:#61676ccc>,
</span><span>            (Color</span><span style=color:#ed9366>::</span><span>Hsla(a)</span><span style=color:#61676ccc>, </span><span>Color</span><span style=color:#ed9366>::</span><span>Hsla(b)) </span><span style=color:#ed9366>=> </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(Color</span><span style=color:#ed9366>::</span><span>Hsla(a</span><span style=color:#ed9366>.</span><span style=color:#f07171>mix</span><span>(b</span><span style=color:#61676ccc>,</span><span> t)))</span><span style=color:#61676ccc>,
</span><span>            (Color</span><span style=color:#ed9366>::</span><span>Hsva(a)</span><span style=color:#61676ccc>, </span><span>Color</span><span style=color:#ed9366>::</span><span>Hsva(b)) </span><span style=color:#ed9366>=> </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(Color</span><span style=color:#ed9366>::</span><span>Hsva(a</span><span style=color:#ed9366>.</span><span style=color:#f07171>mix</span><span>(b</span><span style=color:#61676ccc>,</span><span> t)))</span><span style=color:#61676ccc>,
</span><span>            (Color</span><span style=color:#ed9366>::</span><span>Hwba(a)</span><span style=color:#61676ccc>, </span><span>Color</span><span style=color:#ed9366>::</span><span>Hwba(b)) </span><span style=color:#ed9366>=> </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(Color</span><span style=color:#ed9366>::</span><span>Hwba(a</span><span style=color:#ed9366>.</span><span style=color:#f07171>mix</span><span>(b</span><span style=color:#61676ccc>,</span><span> t)))</span><span style=color:#61676ccc>,
</span><span>            (Color</span><span style=color:#ed9366>::</span><span>Laba(a)</span><span style=color:#61676ccc>, </span><span>Color</span><span style=color:#ed9366>::</span><span>Laba(b)) </span><span style=color:#ed9366>=> </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(Color</span><span style=color:#ed9366>::</span><span>Laba(a</span><span style=color:#ed9366>.</span><span style=color:#f07171>mix</span><span>(b</span><span style=color:#61676ccc>,</span><span> t)))</span><span style=color:#61676ccc>,
</span><span>            (Color</span><span style=color:#ed9366>::</span><span>Lcha(a)</span><span style=color:#61676ccc>, </span><span>Color</span><span style=color:#ed9366>::</span><span>Lcha(b)) </span><span style=color:#ed9366>=> </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(Color</span><span style=color:#ed9366>::</span><span>Lcha(a</span><span style=color:#ed9366>.</span><span style=color:#f07171>mix</span><span>(b</span><span style=color:#61676ccc>,</span><span> t)))</span><span style=color:#61676ccc>,
</span><span>            (Color</span><span style=color:#ed9366>::</span><span>Oklaba(a)</span><span style=color:#61676ccc>, </span><span>Color</span><span style=color:#ed9366>::</span><span>Oklaba(b)) </span><span style=color:#ed9366>=> </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(Color</span><span style=color:#ed9366>::</span><span>Oklaba(a</span><span style=color:#ed9366>.</span><span style=color:#f07171>mix</span><span>(b</span><span style=color:#61676ccc>,</span><span> t)))</span><span style=color:#61676ccc>,
</span><span>            (Color</span><span style=color:#ed9366>::</span><span>Oklcha(a)</span><span style=color:#61676ccc>, </span><span>Color</span><span style=color:#ed9366>::</span><span>Oklcha(b)) </span><span style=color:#ed9366>=> </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(Color</span><span style=color:#ed9366>::</span><span>Oklcha(a</span><span style=color:#ed9366>.</span><span style=color:#f07171>mix</span><span>(b</span><span style=color:#61676ccc>,</span><span> t)))</span><span style=color:#61676ccc>,
</span><span>            (Color</span><span style=color:#ed9366>::</span><span>Xyza(a)</span><span style=color:#61676ccc>, </span><span>Color</span><span style=color:#ed9366>::</span><span>Xyza(b)) </span><span style=color:#ed9366>=> </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(Color</span><span style=color:#ed9366>::</span><span>Xyza(a</span><span style=color:#ed9366>.</span><span style=color:#f07171>mix</span><span>(b</span><span style=color:#61676ccc>,</span><span> t)))</span><span style=color:#61676ccc>,
</span><span>            </span><span style=color:#ed9366>_ => </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(MismatchedUnitsError)</span><span style=color:#61676ccc>,
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre><h3 id=release-content-release-notes-fallible-interpolation-md-26-0><code>release-content/release-notes/fallible_interpolation.md</code> (+26/-0)</h3><p>This file adds release notes documenting the new feature:<pre class=language-markdown data-lang=markdown style=color:#61676c;background-color:#fafafa><code class=language-markdown data-lang=markdown><span style=color:#abb0b6;background-color:#61676c10;font-weight:700>---
</span><span>title: Fallible Interpolation
</span><span>authors: ["@viridia"]
</span><span>pull_requests: [21633]
</span><span style=color:#fa6e32;font-weight:700>---
</span><span>
</span><span style=color:#fa6e32;font-weight:700>## </span><span style=color:#399ee6;font-weight:700>Fallible Interpolation
</span><span>
</span><span>The </span><span style=color:#ed9366;background-color:#61676c10>`StableInterpolate`</span><span> trait is great, but sadly there's one important type that it doesn't work
</span><span>with: The </span><span style=color:#ed9366;background-color:#61676c10>`Val`</span><span> type from </span><span style=color:#ed9366;background-color:#61676c10>`bevy_ui`</span><span>. The reason is that </span><span style=color:#ed9366;background-color:#61676c10>`Val`</span><span> is an enum, representing different
</span><span>length units such as pixels and percentages, and it's not generally possible or even meaningful to
</span><span>try and interpolate between different units.
</span><span>
</span><span>However, the use cases for wanting to animate </span><span style=color:#ed9366;background-color:#61676c10>`Val`</span><span> don't require mixing units: often we just want
</span><span>to slide or stretch the length of a widget such as a toggle switch. We can do this so long as we
</span><span>check at runtime that both interpolation control points are in the same units.
</span><span>
</span><span>The new </span><span style=color:#ed9366;background-color:#61676c10>`TryStableInterpolate`</span><span> trait introduces the idea of interpolation that can fail, by returning
</span><span>a </span><span style=color:#ed9366;background-color:#61676c10>`Result`</span><span>. Note that "failure" in this case is not necessarily bad: it just means that the
</span><span>animation player will need to modify the parameter in some other way, such as "snapping" or
</span><span>"jumping" to the new keyframe without smoothly interpolating. This lets us create complex animations
</span><span>that incorporate both kinds of parameters: ones that interpolate, and ones that don't.
</span><span>
</span><span>There's a blanket implementation of </span><span style=color:#ed9366;background-color:#61676c10>`TryStableInterpolate`</span><span> for all types that impl
</span><span style=color:#ed9366;background-color:#61676c10>`StableInterpolate`</span><span>, and these can never fail. There are additional impls for </span><span style=color:#ed9366;background-color:#61676c10>`Color`</span><span> and </span><span style=color:#ed9366;background-color:#61676c10>`Val`</span><span>
</span><span>which can fail if the control points are not in the same units / color space.
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/book/ch09-00-error-handling.html target=_blank>Rust Book: Error Handling</a> - For understanding the <code>Result</code> type and error handling patterns used in this PR<li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/reference/items/implementations.html#blanket-implementations target=_blank>Rust Reference: Blanket Implementations</a> - For understanding how the blanket implementation for <code>StableInterpolate</code> types works<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/next/animations/ target=_blank>Bevy Animation System Documentation</a> - For context on how this trait fits into Bevy’s animation system<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/next/ui/ target=_blank>Bevy UI System</a> - For understanding the <code>Val</code> type and UI layout system</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_21633.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>