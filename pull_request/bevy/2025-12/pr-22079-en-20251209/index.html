<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22079 Use insert_debug_marker instead of debug_group
        
    </title><meta content="#22079 Use insert_debug_marker instead of debug_group" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-09</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22079-zh-cn-20251209>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Use insert_debug_marker instead of debug_group<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22079<li><strong>Author</strong>: IceSentry<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: D-Trivial, A-Rendering, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-12-09T18:03:01Z<li><strong>Merged</strong>: 2025-12-09T19:02:17Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><p><strong>Objective</strong><ul><li>wgpu 27 changed debug_group validation which breaks the camera debug_group</ul><p><strong>Solution</strong><ul><li>Use insert_debug_marker until we find an alternative to using a debug_group</ul><p><strong>Testing</strong><ul><li>I tested my change with the wgpu 27 branch</ul><p><strong>Showcase</strong> Unfortunately, this means we lose the nice groupings for each camera but we can still see each marker when a camera is being rendered</p><img alt=ngfx-ui_0ejTHJqRDH height=147 src=https://github.com/user-attachments/assets/c5c3f697-fc63-450f-af43-7c6ba3e6e18d width=540><img alt=ngfx-ui_yCBEtE0i1E height=109 src=https://github.com/user-attachments/assets/7c29774c-1dda-4ca9-a9e4-37454f33ca04 width=548><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a compatibility issue that arose from a validation change in wgpu version 27. The core problem was that Bevy’s rendering system was using debug groups to mark the beginning and end of camera rendering operations in performance profiling tools. These debug groups were implemented using <code>push_debug_group</code> and <code>pop_debug_group</code> methods on the command encoder.<p>With the release of wgpu 27, the validation rules for debug groups were tightened. Specifically, the change made it impossible to have a debug group that spans multiple command encoders. This broke Bevy’s camera debug groups because the render graph execution could potentially involve multiple command encoders.<p>The developer, IceSentry, identified that the issue originated from wgpu PR #8048, which introduced stricter validation for debug groups. The immediate solution was to replace the problematic <code>push_debug_group</code>/<code>pop_debug_group</code> calls with <code>insert_debug_marker</code> calls instead.<p>The technical difference between these two approaches is significant. Debug groups create a hierarchical structure in profiling tools, allowing developers to collapse and expand sections of work. Debug markers, on the other hand, are simple timestamped labels that don’t create hierarchical nesting. While debug markers are less visually organized in profiling tools, they don’t have the same validation constraints as debug groups.<p>The implementation change was straightforward but had important implications for the developer experience. In the modified code, instead of pushing a debug group at the start of a camera render and popping it at the end, the code now inserts a “Start {debug_group}” marker at the beginning and an “End {debug_group}” marker at the conclusion. This maintains the ability to identify when specific cameras are being rendered in profiling tools, though without the hierarchical grouping that was previously available.<p>The trade-off here is clear: compatibility with wgpu 27 was prioritized over the organizational benefits of debug groups. The solution is explicitly marked as a workaround with a TODO comment indicating that a more permanent solution should be found later. This is a pragmatic approach - when facing a breaking change in a critical dependency like wgpu, it’s often necessary to implement a minimal fix to restore functionality while deferring a more elegant solution for future consideration.<p>From an engineering perspective, this change demonstrates good practice in dependency management. When upstream dependencies introduce breaking changes, downstream projects need to adapt quickly. The solution here minimizes code changes while maintaining core functionality. The author also properly tested the change with the wgpu 27 branch before submitting the PR, which is essential when dealing with compatibility issues.<p>The visual examples provided in the PR description clearly show the difference in profiling output. With debug groups, camera renders would appear as nested, collapsible sections. With debug markers, each camera render appears as individual labeled entries in the timeline. While less organized, the markers still provide the essential information needed for performance analysis.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[wgpu 27 Validation Change] --> B[Breaks Camera Debug Groups]
</span><span>    B --> C[Replace push/pop_debug_group]
</span><span>    C --> D[Use insert_debug_marker]
</span><span>    D --> E[Maintain Compatibility]
</span><span>    D --> F[Lose Hierarchical Grouping]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-render-src-renderer-graph-runner-rs-11-3><code>crates/bevy_render/src/renderer/graph_runner.rs</code> (+11/-3)</h3><p>This file contains the main rendering graph execution logic. The changes replace debug group operations with debug markers to maintain compatibility with wgpu 27’s stricter validation rules.<p><strong>Key modifications:</strong><ol><li>At the start of graph execution, instead of pushing a debug group, the code now inserts a debug marker:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(debug_group) </span><span style=color:#ed9366>=</span><span> debug_group</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_ref</span><span>() {
</span><span>    render_context
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>command_encoder</span><span>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>push_debug_group</span><span>(debug_group)</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(debug_group) </span><span style=color:#ed9366>=</span><span> debug_group</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_ref</span><span>() {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// wgpu 27 changed the debug_group validation which makes it impossible to have
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// a debug_group that spans multiple command encoders.
</span><span>    </span><span style=color:#abb0b6;font-style:italic>//
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// &LThttps://github.com/gfx-rs/wgpu/pull/8048>
</span><span>    </span><span style=color:#abb0b6;font-style:italic>//
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// For now, we use a debug_marker as a workaround
</span><span>    render_context
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>command_encoder</span><span>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_debug_marker</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#f07171>format!</span><span>(</span><span style=color:#86b300>"Start </span><span style=color:#ff8f40>{debug_group}</span><span style=color:#86b300>"</span><span>))</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><ol start=2><li>At the end of graph execution, instead of popping the debug group, the code now inserts an ending debug marker:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>if</span><span> debug_group</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_some</span><span>() {
</span><span>    render_context</span><span style=color:#ed9366>.</span><span style=color:#f07171>command_encoder</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>pop_debug_group</span><span>()</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(debug_group) </span><span style=color:#ed9366>=</span><span> debug_group {
</span><span>    render_context
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>command_encoder</span><span>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_debug_marker</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#f07171>format!</span><span>(</span><span style=color:#86b300>"End </span><span style=color:#ff8f40>{debug_group}</span><span style=color:#86b300>"</span><span>))</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>The changes are minimal but important for maintaining compatibility with the updated wgpu dependency. The comments clearly document why the change was necessary and reference the upstream wgpu PR that caused the issue.<h2 id=further-reading>Further Reading</h2><ol><li><strong>wgpu Debug Groups Documentation</strong>: Understanding the limitations and proper usage of debug groups in wgpu<li><strong>Rendering Profiling Tools</strong>: How to use tools like RenderDoc and NVIDIA Nsight Graphics for GPU performance analysis<li><strong>Command Encoder Patterns</strong>: Best practices for organizing rendering commands in modern graphics APIs<li><strong>wgpu PR #8048</strong>: The upstream change that introduced the stricter validation (referenced in the code comments)</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22079.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>