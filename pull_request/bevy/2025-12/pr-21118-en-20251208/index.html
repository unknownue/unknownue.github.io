<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21118 clear animation evaluator stack
        
    </title><meta content="#21118 clear animation evaluator stack" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-08</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-21118-zh-cn-20251208>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: clear animation evaluator stack<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21118<li><strong>Author</strong>: robtfm<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, S-Ready-For-Final-Review, A-Animation, X-Uncontroversial, D-Straightforward<li><strong>Created</strong>: 2025-09-18T14:09:55Z<li><strong>Merged</strong>: 2025-12-08T21:57:05Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>A large complex animation (2642 curves over 62 joints) causes serious residual noise on joints after it stops playing. here i start the animation then quickly cancel it:<p>https://github.com/user-attachments/assets/9552d69e-bb10-400f-94a6-c93d301c689b<p>this also seems to affect entities that are animated, but not by the player that fires the large animation, which is really bizarre (here i do not cancel it):<p>https://github.com/user-attachments/assets/a0d99df5-f53d-4ff0-9cf1-87a0e78b8abd<h2 id=solution>Solution</h2><p>debugging i found that the curve evaluator stack is growing unbounded while the complex animation is playing (100k items after a second or two) and is not cleared after the animation is stopped / replaced, so i tried clearing the evaluator stack and that seems to fix it.<p>i have no idea if this fix is sensible or if the root of the issue is elsewhere. i don’t see any knockon ill-effects but can’t be sure there aren’t any. i do not understand this code at all and it’s hard to get a clear picture of what it’s trying to do, so hopefully somebody who does understand it can diagnose better.<p>i attached the gltf containing the animation that causes the issue but i can’t give a simple repro - in my code i have to retarget the animation onto an avatar which isn’t included in the animation gltf (i can provide an example for that if anybody wants it).<p><a rel="noopener nofollow noreferrer" href=https://github.com/user-attachments/files/22408365/bafybeicoja22tkr2rxpccmwh74yehnurgolias77reztd2kuhtvsn2luue.glb.zip target=_blank>bafybeicoja22tkr2rxpccmwh74yehnurgolias77reztd2kuhtvsn2luue.glb.zip</a><h2 id=testing>Testing</h2><p>no<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>A developer encountered a critical bug in Bevy’s animation system when working with complex animations. The issue manifested as serious residual noise on joints after animations stopped playing. Specifically, a large animation with 2642 curves over 62 joints caused visual artifacts that persisted even after the animation was canceled. Even more concerning, this bug seemed to affect entities that weren’t directly animated by the problematic animation player, suggesting a systemic issue in the animation system.<p>The developer started investigating by reproducing the issue with two test cases. The first case showed an animation being started and quickly canceled, leaving joints in an incorrect state. The second case demonstrated the animation affecting unrelated entities, which was particularly concerning for game development where animation state isolation is crucial.<p>Through debugging, the developer discovered that the animation curve evaluator’s internal stack was growing unbounded during animation playback. For complex animations, this stack could accumulate over 100,000 items in just a few seconds. More critically, this stack was never cleared after animations stopped or were replaced, leaving residual data that continued to affect animation evaluations.<p>The root cause appeared to be in the <code>AnimationCurveEvaluator</code> implementation for <code>AnimatableCurveEvaluator</code>. The system was designed to use a stack-based approach for evaluating animation curves, but it failed to properly clean up this stack after completing evaluations. This memory leak of sorts in the evaluation state caused subsequent animations to be evaluated incorrectly, leading to the observed visual artifacts.<p>The fix was straightforward but required careful consideration. The developer added a single line to clear the evaluator stack after completing the evaluation:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>evaluator</span><span style=color:#ed9366>.</span><span>stack</span><span style=color:#ed9366>.</span><span style=color:#f07171>clear</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><p>This line was inserted in the <code>evaluate</code> method of the <code>AnimationCurveEvaluator</code> implementation for <code>AnimatableCurveEvaluator</code>, specifically after the final value was popped from the stack but before returning from the evaluation.<p>The developer acknowledged that while this fix resolved the immediate issue, there might be deeper architectural problems in the animation system. The code was complex and difficult to understand, making it hard to determine if this was the optimal solution or merely a workaround for a more fundamental design flaw. However, given that the fix eliminated the visual artifacts without apparent side effects, it was proposed as a practical solution.<p>This case highlights a common pattern in complex systems: memory or state that persists beyond its intended lifetime can cause subtle bugs that are difficult to diagnose. The stack-based evaluation approach is efficient for certain types of animation curve calculations but requires careful state management to prevent cross-contamination between different animation evaluations.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Animation Player] --> B[AnimationCurveEvaluator]
</span><span>    B --> C[AnimatableCurveEvaluator]
</span><span>    C --> D[Internal Evaluation Stack]
</span><span>    D --> E{Stack cleared?}
</span><span>    E -->|No| F[Residual noise on joints]
</span><span>    E -->|Yes| G[Clean animation state]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ol><li><strong>File</strong>: <code>crates/bevy_animation/src/animation_curves.rs</code></ol><p><strong>Description</strong>: This file contains the implementation of animation curve evaluation. The change adds a single line to clear the internal evaluation stack after completing an animation curve evaluation, preventing residual stack data from affecting subsequent animations.<p><strong>Code Change</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>impl</span><span>&LTA</span><span style=color:#61676ccc>:</span><span> Animatable> AnimationCurveEvaluator </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>AnimatableCurveEvaluator</span><span>&LTA> {
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>evaluate</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><(), AnimationError> {
</span><span>        </span><span style=color:#fa6e32>let </span><span style=color:#ed9366>_ = </span><span style=color:#55b4d4;font-style:italic>self
</span><span>            </span><span style=color:#ed9366>.</span><span>evaluator
</span><span>            </span><span style=color:#ed9366>.</span><span>stack
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>pop</span><span>()
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>ok_or_else</span><span>(inconsistent</span><span style=color:#ed9366>::</span><span>&LTAnimatableCurveEvaluator&LTA>>)</span><span style=color:#ed9366>?
</span><span>            </span><span style=color:#ed9366>.</span><span>value</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(())
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>impl</span><span>&LTA</span><span style=color:#61676ccc>:</span><span> Animatable> AnimationCurveEvaluator </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>AnimatableCurveEvaluator</span><span>&LTA> {
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>evaluate</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><(), AnimationError> {
</span><span>        </span><span style=color:#fa6e32>let </span><span style=color:#ed9366>_ = </span><span style=color:#55b4d4;font-style:italic>self
</span><span>            </span><span style=color:#ed9366>.</span><span>evaluator
</span><span>            </span><span style=color:#ed9366>.</span><span>stack
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>pop</span><span>()
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>ok_or_else</span><span>(inconsistent</span><span style=color:#ed9366>::</span><span>&LTAnimatableCurveEvaluator&LTA>>)</span><span style=color:#ed9366>?
</span><span>            </span><span style=color:#ed9366>.</span><span>value</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>evaluator</span><span style=color:#ed9366>.</span><span>stack</span><span style=color:#ed9366>.</span><span style=color:#f07171>clear</span><span>()</span><span style=color:#61676ccc>;  </span><span style=color:#abb0b6;font-style:italic>// Added line
</span><span>        </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(())
</span><span>    }
</span><span>}
</span></code></pre><p><strong>Relationship to PR Purpose</strong>: This change directly addresses the root cause of the bug by ensuring that the evaluation stack is cleared after each animation evaluation, preventing residual data from accumulating and causing visual artifacts.<h2 id=further-reading>Further Reading</h2><ol><li><strong>Bevy Animation System Documentation</strong>: For understanding Bevy’s animation architecture and how curve evaluation fits into the larger system<li><strong>Stack-Based Evaluation Patterns</strong>: Research on stack-based evaluation algorithms commonly used in animation and procedural generation systems<li><strong>Memory Management in Game Engines</strong>: Understanding how game engines manage state and memory to prevent cross-contamination between systems<li><strong>Animation Retargeting</strong>: The developer mentioned retargeting animations, which is a complex topic in character animation systems<li><strong>GLTF Animation Format</strong>: Understanding how complex animations are structured in the GLTF format used in the test case</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_21118.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>