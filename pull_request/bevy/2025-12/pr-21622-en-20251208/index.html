<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21622 :bug: Fixes PropagateStop and PropagateOver
        
    </title><meta content="#21622 :bug: Fixes PropagateStop and PropagateOver" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>‚Üê Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-08</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-21622-zh-cn-20251208>‰∏≠Êñá</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=bug-fixes-for-propagatestop-and-propagateover-components>Bug Fixes for PropagateStop and PropagateOver Components</h2><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: üêõ Fixes PropagateStop and PropagateOver<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21622<li><strong>Author</strong>: ekwoka<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-ECS, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-10-21T16:54:04Z<li><strong>Merged</strong>: 2025-12-08T23:06:55Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description>Description</h2><h1 id=objective>Objective</h1><p>Fixes #21620<p>Ensures <code>PropagateStop</code> works as documented. At it stands, <code>PropagateStop&LTC></code> is described as only preventing its Children from inheriting <code>C</code> but in practice that entity itself would not inherit <code>C</code>.<p>Makes <code>PropagateOver</code> work. It just plain didn‚Äôt work at all.<h2 id=solution>Solution</h2><p>Adjusted the flow to prevent recursively inheriting <code>Inherited</code> when <code>PropagateStop</code> present, as opposed to not accessing <code>PropagateStop</code> entities entirely.<p>Skips applying <code>C</code> when <code>Inherited&LTC></code> and <code>PropagateOver&LTC></code> are on the entity.<h2 id=testing>Testing</h2><p>I updated the tests first to verify the test cases. They were incomplete and didn‚Äôt pass once checking for the proper end state.<p>After verifying those were not functioning, trimmed and adjusted code until it functioned.<h2 id=fuller-explanation>Fuller Explanation</h2><p>To my understanding of the goals (and my implementation) the idea is that the result of these components would be like<pre style=color:#61676c;background-color:#fafafa><code><span>(Propagate&LTC>, Inherited&LTC>, C)
</span><span>  (Inherited&LTC>, C)
</span><span>    (PropagateOver&LTC>, Inherited&LTC>)
</span><span>      (Inherited&LTC>, C)
</span><span>        (PropagateStop&LTC>, Inherited&LTC>, C)
</span></code></pre><p>While the previous (incorrect by my measure) appeared to be<pre style=color:#61676c;background-color:#fafafa><code><span>(Propagate&LTC>, Inherited&LTC>, C)
</span><span>  (Inherited&LTC>, C)
</span><span>    (PropagateOver&LTC>, Inherited&LTC>, C)
</span><span>      (Inherited&LTC>, C)
</span><span>        (PropagateStop&LTC>)
</span></code></pre><p>So of note: The <code>PropagateOver&LTC></code> is still getting <code>Inherited&LTC></code> in this current adjustment. I believe it was doing that before, but I didn‚Äôt fully understand the reasoning for the <code>Inherited&LTC></code> at all? I guess it‚Äôs to properly mark that the <code>C</code> is an inherited one, so maybe I do need to remove it on <code>PropagateOver&LTC></code> as well, to ensure cleanup doesn‚Äôt also remove any separately applied <code>C</code>?<p>I didn‚Äôt look closely at what all the other tests are attempting to test (or if they are correctly testing those) to evaluate if other changes need to be made.<p>if <code>PropagateOver&LTC></code> doesn‚Äôt have <code>Inherited&LTC></code> and is reparented, would it be simple to ensure that its children have their <code>Inherited&LTC></code> removed/updated properly?<p>Looking at the code more, chances are this can be simplified a lot with the use of AncestorIter and DescendentIter, but I am not sure if jumping into a fuller refactor makes sense at this moment as opposed to attempting to fix this immediate issue and following up with a bigger refactor?<p>thoughts?<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses two related bugs in Bevy‚Äôs component propagation system. The system allows components to automatically propagate through entity hierarchies, with control mechanisms like <code>PropagateStop</code> to block propagation and <code>PropagateOver</code> to allow propagation through an entity while preventing it from receiving the propagated component itself.<p>The core issue was that <code>PropagateStop</code> wasn‚Äôt working as documented. According to its intended behavior, an entity with <code>PropagateStop&LTC></code> should still inherit component <code>C</code> from its ancestors, but should prevent that component from propagating further to its children. However, the implementation was incorrectly preventing the entity itself from receiving the component. Additionally, <code>PropagateOver</code> was completely non-functional.<p>The developer‚Äôs approach involved first examining and fixing the test cases to establish correct expected behavior, then systematically adjusting the propagation logic. The key insight was that the system needed to distinguish between entities that should receive inherited components but stop propagation (PropagateStop), versus entities that should allow propagation but not receive the component themselves (PropagateOver).<p>The implementation changes center around two main areas: modifying the propagation logic to handle <code>PropagateStop</code> entities correctly, and fixing the <code>PropagateOver</code> functionality. Previously, the system would skip entities with <code>PropagateStop</code> entirely, preventing them from receiving the inherited component. The fix adjusts the flow so that <code>PropagateStop</code> entities still receive the <code>Inherited&LTC></code> component (which tracks the inherited state) and the actual component <code>C</code>, but their children are excluded from the propagation chain.<p>For <code>PropagateOver</code>, the fix ensures that entities with this component don‚Äôt receive the actual component <code>C</code>, but still pass the inheritance to their children. The system now checks for <code>PropagateOver</code> in the <code>propagate_output</code> system and skips applying the component when both <code>Inherited&LTC></code> and <code>PropagateOver&LTC></code> are present.<p>The changes also include better handling of edge cases like component removal and entity reparenting. A new system <code>update_removed_limit</code> was added to handle cleanup when <code>PropagateOver</code> or <code>PropagateStop</code> components are removed, marking the <code>Inherited</code> component as changed to trigger proper propagation updates.<p>One notable engineering consideration was the decision to keep <code>Inherited&LTC></code> on <code>PropagateOver</code> entities. This maintains consistency in the propagation tracking system and ensures proper cleanup if the entity is reparented later. The developer considered whether to remove <code>Inherited&LTC></code> from <code>PropagateOver</code> entities but decided against it to maintain proper inheritance tracking.<p>The impact of these changes is significant for users relying on component propagation in Bevy. The fixed behavior enables more precise control over how components flow through entity hierarchies, which is essential for building complex UI systems, scene management, and other hierarchical data structures. The comprehensive test suite added with this PR ensures the behavior remains correct through future changes.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Propagate&LTC>] -->|Propagates C| B[Child Entity]
</span><span>    B -->|Propagation continues| C[PropagateOver Entity]
</span><span>    C -->|Inheritance passed through| D[Grandchild Entity]
</span><span>    C -.->|C not applied| C
</span><span>    B -->|Propagation stops| E[PropagateStop Entity]
</span><span>    E -.->|No further propagation| F[Stopped Child]
</span><span>    E -->|C still applied| E
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-app-src-propagate-rs-383-123><code>crates/bevy_app/src/propagate.rs</code> (+383/-123)</h3><p>This file contains the core propagation logic that was modified to fix both bugs. The changes include:<ol><li><p><strong>System reorganization and new system addition</strong>: The system execution order was adjusted and a new system <code>update_removed_limit</code> was added to handle cleanup when propagation control components are removed.</p><li><p><strong>Fixed <code>PropagateStop</code> handling</strong>: The <code>propagate_inherited</code> system now includes <code>PropagateStop&LTC></code> in its query and uses it to decide whether to continue propagation to children.</p></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Query didn't include PropagateStop
</span><span>recurse</span><span style=color:#61676ccc>: </span><span>Query<
</span><span>    (</span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>R</span><span style=color:#ed9366>::</span><span>RelationshipTarget>, </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#ed9366>&</span><span>Inherited&LTC>>),
</span><span>    (Without&LTPropagate&LTC>>, Without&LTPropagateStop&LTC>>, F),
</span><span>></span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Query includes PropagateStop and uses it in logic
</span><span>recurse</span><span style=color:#61676ccc>: </span><span>Query<
</span><span>    (
</span><span>        </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>R</span><span style=color:#ed9366>::</span><span>RelationshipTarget>,
</span><span>        </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#ed9366>&</span><span>Inherited&LTC>>,
</span><span>        </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#ed9366>&</span><span>PropagateStop&LTC>>,
</span><span>    ),
</span><span>    (Without&LTPropagate&LTC>>, F),
</span><span>></span><span style=color:#61676ccc>,
</span></code></pre><ol start=3><li><strong>Fixed <code>PropagateOver</code> handling</strong>: The <code>propagate_output</code> system now checks for <code>PropagateOver</code> and skips applying the component when both <code>Inherited&LTC></code> and <code>PropagateOver&LTC></code> are present.</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: No check for PropagateOver in component removal
</span><span style=color:#fa6e32>for</span><span> removed </span><span style=color:#ed9366>in</span><span> removed</span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>() {
</span><span>    commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(removed)</span><span style=color:#ed9366>.</span><span>remove</span><span style=color:#ed9366>::</span><span>&LTC>()</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Check for PropagateOver before removing C
</span><span style=color:#fa6e32>for</span><span> removed </span><span style=color:#ed9366>in</span><span> removed</span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>() {
</span><span>    </span><span style=color:#fa6e32>if</span><span> skip</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(removed)</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_err</span><span>() {
</span><span>        commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(removed)</span><span style=color:#ed9366>.</span><span>remove</span><span style=color:#ed9366>::</span><span>&LTC>()</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><ol start=4><li><strong>Enhanced test coverage</strong>: The PR adds extensive test cases covering various scenarios including component removal, reparenting, and edge cases with propagation control components.</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Example of new test for PropagateStop removal
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>test_remove_propagate_stop</span><span>() {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> app </span><span style=color:#ed9366>= </span><span>App</span><span style=color:#ed9366>::</span><span>new()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... test setup
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Verifies that removing PropagateStop allows propagation to resume
</span><span>    </span><span style=color:#f07171>assert_eq!</span><span>(
</span><span>        query</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_many</span><span>(app</span><span style=color:#ed9366>.</span><span style=color:#f07171>world</span><span>()</span><span style=color:#61676ccc>, </span><span>[propagate_stop</span><span style=color:#61676ccc>,</span><span> no_propagatee])</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>([</span><span style=color:#ed9366>&</span><span>TestValue(</span><span style=color:#ff8f40>1</span><span>)</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>TestValue(</span><span style=color:#ff8f40>1</span><span>)])
</span><span>    )</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_ecs/latest/bevy_ecs/ target=_blank>Bevy ECS Documentation</a> - For understanding Bevy‚Äôs Entity Component System<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/rfcs/pull/43 target=_blank>Component Inheritance RFC</a> - Background on the component propagation feature<li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_hierarchy/latest/bevy_hierarchy/trait.Relationship.html target=_blank>Relationship Trait Documentation</a> - For understanding how entity relationships work in Bevy</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_21622.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>