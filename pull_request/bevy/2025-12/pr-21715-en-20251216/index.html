<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21715 Deduplicate world_to_view logic
        
    </title><meta content="#21715 Deduplicate world_to_view logic" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-16</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-21715-zh-cn-20251216>中文</a></div></div><div class=pr-content><h1 id=title-deduplicate-world-to-view-logic>Title: Deduplicate world_to_view logic</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Deduplicate world_to_view logic<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21715<li><strong>Author</strong>: Breakdown-Dog<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Code-Quality, X-Contentious, D-Straightforward, S-Needs-Review, A-Camera<li><strong>Created</strong>: 2025-11-02T02:08:08Z<li><strong>Merged</strong>: 2025-12-16T05:47:32Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>The functions logical_viewport_size and physical_viewport_size in camera.rs share a very similar pattern.<li>Refactor code to reduce duplication.</ul><h2 id=solution>Solution</h2><ul><li>extract to a shared function.</ul><h2 id=testing>Testing</h2><ul><li>Ran <code>cargo test</code> and all the tests pass.</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This pull request addresses a common code quality issue: duplication of logic across multiple functions. The author identified that two functions in the camera module, <code>world_to_viewport</code> and <code>world_to_viewport_with_depth</code>, contained nearly identical logic for converting world coordinates to viewport coordinates, with the only difference being the return value.<p>The existing implementation had both functions independently performing the same sequence of operations: retrieving the viewport rectangle, converting world coordinates to Normalized Device Coordinates (NDC), validating the depth range, flipping the Y-axis, and finally mapping NDC coordinates to the viewport. This duplication created maintenance overhead - any change to the coordinate transformation logic would need to be made in two places, increasing the risk of inconsistencies.<p>The solution implemented follows standard refactoring practices: extract the common logic into a shared private function. The author created a new private method called <code>world_to_viewport_core</code> that returns both the viewport position and the depth value. This core function handles all the shared transformation logic and returns a tuple <code>(Vec2, f32)</code> containing the viewport coordinates and the NDC depth.<p>The refactoring maintains the existing public API while eliminating duplication. The <code>world_to_viewport</code> function now calls the core function and extracts just the position component, while <code>world_to_viewport_with_depth</code> calls the same core function and processes the depth component further to convert it to view-space depth.<p>This change demonstrates several sound software engineering principles. First, it follows the DRY (Don’t Repeat Yourself) principle by eliminating duplicate logic. Second, it preserves backward compatibility - the public interface remains unchanged, so existing code continues to work without modification. Third, it improves code maintainability by centralizing the coordinate transformation logic in one place.<p>The implementation also shows careful attention to error handling. Both functions share the same error conditions, which are now handled consistently in the core function. This ensures that edge cases like missing viewport size or coordinates outside the frustum are handled identically in both code paths.<p>From a performance perspective, this refactoring is neutral. The core logic remains the same, and the only additional overhead is the tuple construction and destructuring, which the Rust compiler can optimize effectively. The more important benefit is the reduction in cognitive load for developers maintaining this code - they now need to understand and potentially modify only one implementation of the coordinate transformation.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[world_to_viewport_core] --> B[world_to_viewport]
</span><span>    A --> C[world_to_viewport_with_depth]
</span><span>    
</span><span>    D[World Position] --> A
</span><span>    E[Camera Transform] --> A
</span><span>    
</span><span>    B --> F[Viewport Coordinates Vec2]
</span><span>    C --> G[Viewport Coordinates with Depth Vec3]
</span><span>    
</span><span>    subgraph "Core Logic"
</span><span>        A
</span><span>    end
</span><span>    
</span><span>    subgraph "Public API"
</span><span>        B
</span><span>        C
</span><span>    end
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-camera-src-camera-rs-32-34><code>crates/bevy_camera/src/camera.rs</code> (+32/-34)</h3><p>The changes refactor the coordinate transformation logic in the Camera struct to eliminate duplication between two similar functions.<p><strong>Key Changes:</strong><ol><li><strong>New private method <code>world_to_viewport_core</code></strong>: This function contains the shared logic previously duplicated in both <code>world_to_viewport</code> and <code>world_to_viewport_with_depth</code>.</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// File: crates/bevy_camera/src/camera.rs
</span><span style=color:#abb0b6;font-style:italic>// Before (logic duplicated in two places):
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>world_to_viewport</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, ...) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span>&LTVec2, </span><span style=color:#f51818>.</span><span style=color:#ed9366>..> </span><span>{
</span><span>    </span><span style=color:#fa6e32>let</span><span> target_rect </span><span style=color:#ed9366>= ...</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> ndc_space_coords </span><span style=color:#ed9366>= ...</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Validation and transformation logic
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(viewport_position)
</span><span>}
</span><span>
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>world_to_viewport_with_depth</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, ...) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span>&LTVec3, </span><span style=color:#f51818>.</span><span style=color:#ed9366>..> </span><span>{
</span><span>    </span><span style=color:#fa6e32>let</span><span> target_rect </span><span style=color:#ed9366>= ...</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> ndc_space_coords </span><span style=color:#ed9366>= ...</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Nearly identical validation and transformation logic
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(viewport_position</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend</span><span>(depth))
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After (extracted to shared function):
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>world_to_viewport_core</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, ...) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><(Vec2, </span><span style=color:#fa6e32>f32</span><span>), </span><span style=color:#f51818>.</span><span style=color:#ed9366>..> </span><span>{
</span><span>    </span><span style=color:#fa6e32>let</span><span> target_rect </span><span style=color:#ed9366>= ...</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> ndc_space_coords </span><span style=color:#ed9366>= ...</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Shared validation and transformation logic
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>((viewport_position</span><span style=color:#61676ccc>,</span><span> depth))
</span><span>}
</span><span>
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>world_to_viewport</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, ...) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span>&LTVec2, </span><span style=color:#f51818>.</span><span style=color:#ed9366>..> </span><span>{
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>world_to_viewport_core</span><span>(</span><span style=color:#ed9366>...</span><span>)</span><span style=color:#ed9366>?.</span><span style=color:#ff8f40>0</span><span>)
</span><span>}
</span><span>
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>world_to_viewport_with_depth</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, ...) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span>&LTVec3, </span><span style=color:#f51818>.</span><span style=color:#ed9366>..> </span><span>{
</span><span>    </span><span style=color:#fa6e32>let</span><span> result </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>world_to_viewport_core</span><span>(</span><span style=color:#ed9366>...</span><span>)</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> depth </span><span style=color:#ed9366>= -</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>depth_ndc_to_view_z</span><span>(result</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>1</span><span>)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(result</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0.</span><span style=color:#f07171>extend</span><span>(depth))
</span><span>}
</span></code></pre><ol start=2><li><p><strong>Simplified public functions</strong>: Both public functions now delegate to the core function and handle only their specific return value requirements.</p><li><p><strong>Improved documentation</strong>: The core function includes clear documentation explaining its purpose as shared logic.</p></ol><h2 id=further-reading>Further Reading</h2><ol><li><p><strong>DRY Principle</strong>: The “Don’t Repeat Yourself” principle is a fundamental software engineering concept that emphasizes reducing duplication in code.</p><li><p><strong>Rust API Guidelines</strong>: The Rust API Guidelines provide recommendations for designing Rust APIs, including advice on error handling and code organization.</p><li><p><strong>Refactoring Techniques</strong>: Martin Fowler’s “Refactoring: Improving the Design of Existing Code” covers the “Extract Method” pattern used in this PR.</p><li><p><strong>Bevy Camera System</strong>: The Bevy engine’s camera system documentation explains how coordinate spaces work in 3D rendering.</p><li><p><strong>Coordinate Systems in Computer Graphics</strong>: Understanding the transformation between world space, view space, NDC, and viewport coordinates is essential for 3D graphics programming.</p></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_21715.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>