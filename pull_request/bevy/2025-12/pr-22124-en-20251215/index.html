<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22124 Fix: Clears directional navigation map between rebuilds
        
    </title><meta content="#22124 Fix: Clears directional navigation map between rebuilds" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-15</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22124-zh-cn-20251215>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>Fix: Clears directional navigation map between rebuilds<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix: Clears directional navigation map between rebuilds<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22124<li><strong>Author</strong>: kfc35<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-UI, S-Ready-For-Review, S-Ready-For-Final-Review, D-Straightforward<li><strong>Created</strong>: 2025-12-15T07:14:29Z<li><strong>Merged</strong>: 2025-12-15T21:12:20Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Closes #21949</ul><h2 id=solution>Solution</h2><ul><li>Implements the solution as suggested by 21949. The Directional Navigation Map does not prune any old edges that may be connected to removed Nodes, so we clear the map between rebuilds of the map.</ul><p>(If the more preferable solution figures out what nodes were removed and then calls <code>map.remove_multiple</code> instead, you can feel free to reject this)<h2 id=testing>Testing</h2><ul><li>Did you test these changes? If so, how? I did not test this change, but the reporter of the issue did (via backport to an older version of Bevy). However, the fix is straightforward and explains itself. If you would like an automated test somehow, some pointers to tests that do similar would be welcome.</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>A developer encountered bug #21949 in Bevy’s UI system where directional navigation would fail after UI elements were removed. The issue was that the directional navigation system, which manages focus navigation between UI elements, was accumulating stale connections in its internal data structure.<p>The directional navigation system works by building a graph of navigable UI nodes. When the UI changes, the system needs to rebuild this graph to reflect the current state of the UI. The existing implementation correctly added new connections but never removed old connections to nodes that had been deleted. This resulted in a map containing references to entities that no longer existed, which could cause various navigation failures.<p>The developer analyzed the code and found the root cause in the <code>auto_rebuild_ui_navigation_graph</code> function in <code>directional_navigation.rs</code>. This function is responsible for regenerating the navigation graph when UI elements change. The function collects current UI nodes and generates navigation edges between them, but before this fix, it didn’t clear the existing navigation map first.<p>The solution approach considered two options: either clear the entire map before rebuilding (a simple approach), or track which nodes were removed and only delete their corresponding edges (a more precise approach). The developer implemented the simpler approach of clearing the entire map because it’s straightforward and effective. As noted in the PR description, they acknowledged that a more targeted removal using <code>map.remove_multiple</code> might be preferable, but they left that decision to the maintainers.<p>The implementation adds a single line of code:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// clear the old nav map between rebuilds to ensure any removed entities' edges are pruned
</span><span>directional_nav_map</span><span style=color:#ed9366>.</span><span style=color:#f07171>clear</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><p>This line is placed right before the call to <code>auto_generate_navigation_edges</code>. The timing is important - we need to clear the map after we’ve collected the current nodes but before we generate new edges. This ensures we start with an empty map and only populate it with valid connections to currently existing UI elements.<p>The comment added explains the purpose clearly: “clear the old nav map between rebuilds to ensure any removed entities’ edges are pruned”. This is good practice as it helps future developers understand why the clear operation is necessary.<p>From an architectural perspective, this fix maintains the existing pattern of complete rebuilds rather than incremental updates. The directional navigation system already rebuilds the entire graph when UI changes occur, so clearing the map aligns with this design. The performance impact is minimal because we’re rebuilding the entire map anyway.<p>The testing approach was pragmatic - the issue reporter had already validated the fix by backporting it to an older version of Bevy. Since the change is simple and the bug’s symptoms were clear, additional automated testing wasn’t immediately required, though the developer appropriately offered to add tests if needed.<p>This fix demonstrates a common pattern in game engine UI systems: when maintaining spatial relationships between UI elements, it’s crucial to properly clean up references to removed elements. The lesson here is that data structures tracking entity relationships need explicit cleanup when those entities are destroyed, especially in ECS (Entity Component System) architectures where entity IDs can be reused.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    subgraph "Before Fix"
</span><span>        A[UI Node A] --> B[UI Node B]
</span><span>        C[Removed UI Node C] --> B
</span><span>        B --> C
</span><span>    end
</span><span>    
</span><span>    subgraph "After Fix"
</span><span>        D[auto_rebuild_ui_navigation_graph] --> E[Collect current nodes]
</span><span>        E --> F[Clear navigation map]
</span><span>        F --> G[Generate new edges]
</span><span>        G --> H[Clean navigation graph]
</span><span>        I[UI Node A] --> J[UI Node B]
</span><span>    end
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-input-focus-src-directional-navigation-rs><code>crates/bevy_input_focus/src/directional_navigation.rs</code></h3><p>This is the only file modified in the PR. The change adds a single line to clear the directional navigation map before regenerating navigation edges.<p><strong>Key Change:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before the fix (simplified context):
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>auto_rebuild_ui_navigation_graph</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>directional_nav_map</span><span style=color:#61676ccc>: </span><span>ResMut&LTDirectionalNavigationMap>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other parameters
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>let</span><span> nodes </span><span style=color:#ed9366>=</span><span> query
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|(</span><span style=color:#ff8f40>entity</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>node</span><span>)| NavigationNode {
</span><span>            </span><span style=color:#abb0b6;font-style:italic>// collect nodes
</span><span>        })
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>collect</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Missing: clearing of old navigation map
</span><span>    </span><span style=color:#f07171>auto_generate_navigation_edges</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> directional_nav_map</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>nodes</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>config)</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After the fix:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>auto_rebuild_ui_navigation_graph</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>directional_nav_map</span><span style=color:#61676ccc>: </span><span>ResMut&LTDirectionalNavigationMap>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other parameters
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>let</span><span> nodes </span><span style=color:#ed9366>=</span><span> query
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|(</span><span style=color:#ff8f40>entity</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>node</span><span>)| NavigationNode {
</span><span>            </span><span style=color:#abb0b6;font-style:italic>// collect nodes
</span><span>        })
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>collect</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// clear the old nav map between rebuilds to ensure any removed entities' edges are pruned
</span><span>    directional_nav_map</span><span style=color:#ed9366>.</span><span style=color:#f07171>clear</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#f07171>auto_generate_navigation_edges</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> directional_nav_map</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>nodes</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>config)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>The change is minimal but significant. By adding <code>directional_nav_map.clear()</code>, we ensure that the navigation map only contains edges between currently existing UI nodes. This prevents the accumulation of stale references that could cause navigation failures or crashes when trying to navigate to deleted entities.<h2 id=further-reading>Further Reading</h2><ol><li><p><strong>Bevy UI Navigation System</strong>: The official Bevy documentation on UI and navigation systems would provide context for how directional navigation fits into the larger UI framework.</p><li><p><strong>Entity Component System (ECS) Patterns</strong>: Understanding ECS architecture is crucial for working with Bevy. Resources on ECS best practices, particularly around entity lifecycle management, would be helpful.</p><li><p><strong>Graph Algorithms in Game UI</strong>: For those interested in the underlying algorithms, materials on graph theory as applied to UI navigation (focus traversal, spatial relationships) would provide deeper insight.</p><li><p><strong>Rust Ownership and Borrowing</strong>: Since this fix deals with mutating a resource, understanding Rust’s ownership model and how Bevy’s ECS handles mutable access to components/resources is relevant.</p><li><p><strong>Issue #21949</strong>: Reading the original issue report provides additional context about the symptoms and reproduction steps for the bug that this PR fixes.</p></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22124.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>