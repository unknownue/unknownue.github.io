<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21630 UI text module refactor
        
    </title><meta content="#21630 UI text module refactor" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-02</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-21630-zh-cn-20251202>中文</a></div></div><div class=pr-content><h1 id=ui-text-module-refactor>UI text module refactor</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: UI text module refactor<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21630<li><strong>Author</strong>: ickshonpe<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: D-Trivial, A-UI, C-Code-Quality, S-Ready-For-Final-Review, A-Text<li><strong>Created</strong>: 2025-10-22T20:35:30Z<li><strong>Merged</strong>: 2025-12-02T19:59:11Z<li><strong>Merged By</strong>: cart</ul><h2 id=description-translation>Description Translation</h2><p><strong>Objective</strong><p>The <code>measure_text_system</code> and <code>text_system</code> systems don’t do anything except iterate a query and then delegate to two other functions, <code>create_text_measure</code> and <code>queue_text</code>, respectively. This doesn’t serve any purpose and just makes these systems harder to understand.<p><strong>Solution</strong><p>Flatten the module by moving the code from <code>create_text_measure</code> and <code>queue_text</code> into the systems and remove those functions.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a straightforward code quality issue in Bevy’s UI text rendering system. The developer identified unnecessary abstraction in two key systems responsible for text measurement and text queueing. The problem was that these systems were structured as thin wrappers that did little more than iterate through components and call separate helper functions.<p>Looking at the original code, <code>measure_text_system</code> served as a dispatcher that checked certain conditions and then called <code>create_text_measure</code>, while <code>text_system</code> performed similar dispatching to <code>queue_text</code>. This added an extra layer of indirection without providing meaningful abstraction benefits. Each helper function had a long parameter list, making the code harder to follow and debug.<p>The solution approach was simple and direct: inline the helper functions into their respective systems. This eliminated the unnecessary indirection and made the control flow more linear and easier to understand. The developer recognized that flattening this module would reduce cognitive load for anyone working with the text rendering code.<p>In the implementation, the developer moved the entire logic from <code>create_text_measure</code> into <code>measure_text_system</code> and the logic from <code>queue_text</code> into <code>text_system</code>. Several important changes were made during this refactoring:<ol><li><p><strong>Query pattern updates</strong>: The systems were updated to use mutable references (<code>mut content_size</code>, <code>mut text_flags</code>, etc.) directly in the query pattern instead of using <code>Mut&LTT></code> wrappers. This change simplifies the code and aligns with Bevy’s ECS query patterns.</p><li><p><strong>Control flow restructuring</strong>: The condition checking logic was inverted in both systems. Instead of checking if work should be done and then calling the helper function, the systems now check if work should be <em>skipped</em> and use <code>continue</code> statements to bypass processing. This makes the main logic path more linear.</p><li><p><strong>Error handling preservation</strong>: All existing error handling was preserved during the inlining process. The <code>match</code> statements that handle <code>TextError</code> variants remain unchanged, maintaining the same behavior for font loading errors and fatal text processing errors.</p><li><p><strong>Parameter simplification</strong>: By eliminating the helper functions, numerous parameter passing operations were removed. The systems now access resources and components directly through their query parameters rather than passing them through function calls.</p></ol><p>The technical insight here is about balancing abstraction against clarity. While helper functions can be useful for separating concerns or reusing code, they become counterproductive when they serve only as pass-through functions. In this case, the helper functions were so tightly coupled to their calling systems that they didn’t provide meaningful separation.<p>The impact of this change is primarily on code maintainability. Developers working on the text rendering system will now see all the logic in one place without having to jump between functions. This makes debugging easier and reduces the mental overhead of understanding the system’s control flow. The change doesn’t affect runtime performance since it’s purely structural - the same operations execute in the same order, just without the function call overhead.<p>This refactoring also demonstrates good practice in system design within Bevy’s ECS architecture. By keeping related logic together and minimizing unnecessary abstraction layers, the code becomes more approachable for contributors who need to understand or modify text rendering behavior.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    subgraph "Before Refactoring"
</span><span>        A[measure_text_system] --> B[create_text_measure function]
</span><span>        C[text_system] --> D[queue_text function]
</span><span>    end
</span><span>    
</span><span>    subgraph "After Refactoring"
</span><span>        E[measure_text_system] --> F[Inline measurement logic]
</span><span>        G[text_system] --> H[Inline queueing logic]
</span><span>    end
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ui-src-widget-text-rs-97-152><code>crates/bevy_ui/src/widget/text.rs</code> (+97/-152)</h3><p>This file contains the core text rendering logic for Bevy’s UI system. The changes refactor two main systems to eliminate unnecessary helper functions and flatten the module structure.<p><strong>Key modifications:</strong><ol><li><p><strong>Removal of <code>create_text_measure</code> function</strong>: The function was completely removed and its logic inlined into <code>measure_text_system</code>.</p> <p><strong>Before:</strong></p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>inline</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>create_text_measure</span><span><</span><span style=color:#fa6e32>'a</span><span>>(... very long parameter list ...) {
</span><span>    </span><span style=color:#fa6e32>match</span><span> text_pipeline</span><span style=color:#ed9366>.</span><span style=color:#f07171>create_text_measure</span><span>(</span><span style=color:#ed9366>...</span><span>) {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ... error handling and logic
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>measure_text_system</span><span>(...) {
</span><span>    </span><span style=color:#fa6e32>for </span><span>(</span><span style=color:#ed9366>...</span><span>) </span><span style=color:#ed9366>in &</span><span style=color:#fa6e32>mut</span><span> text_query {
</span><span>        </span><span style=color:#fa6e32>if </span><span style=color:#ed9366>...</span><span> condition </span><span style=color:#ed9366>... </span><span>{
</span><span>            </span><span style=color:#f07171>create_text_measure</span><span>(</span><span style=color:#ed9366>...</span><span> all parameters </span><span style=color:#ed9366>...</span><span>)</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre> <p><strong>After:</strong></p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>measure_text_system</span><span>(...) {
</span><span>    </span><span style=color:#fa6e32>for </span><span>(</span><span style=color:#ed9366>...</span><span>) </span><span style=color:#ed9366>in &</span><span style=color:#fa6e32>mut</span><span> text_query {
</span><span>        </span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>(</span><span style=color:#ed9366>...</span><span> condition </span><span style=color:#ed9366>...</span><span>) {
</span><span>            </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>        
</span><span>        </span><span style=color:#fa6e32>match</span><span> text_pipeline</span><span style=color:#ed9366>.</span><span style=color:#f07171>create_text_measure</span><span>(</span><span style=color:#ed9366>...</span><span>) {
</span><span>            </span><span style=color:#abb0b6;font-style:italic>// ... inlined error handling and logic
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre><li><p><strong>Removal of <code>queue_text</code> function</strong>: Similarly, this function was removed and its logic inlined into <code>text_system</code>.</p> <p><strong>Before:</strong></p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>inline</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>queue_text</span><span>(... very long parameter list ...) {
</span><span>    </span><span style=color:#fa6e32>if</span><span> text_flags</span><span style=color:#ed9366>.</span><span>needs_measure_fn {
</span><span>        </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>    
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... complex text queueing logic
</span><span>}
</span><span>
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>text_system</span><span>(...) {
</span><span>    </span><span style=color:#fa6e32>for </span><span>(entity</span><span style=color:#61676ccc>,</span><span> node</span><span style=color:#61676ccc>,</span><span> block</span><span style=color:#61676ccc>,</span><span> text_layout_info</span><span style=color:#61676ccc>,</span><span> text_flags</span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>mut</span><span> computed) </span><span style=color:#ed9366>in &</span><span style=color:#fa6e32>mut</span><span> text_query {
</span><span>        </span><span style=color:#fa6e32>if</span><span> node</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_changed</span><span>() </span><span style=color:#ed9366>||</span><span> text_flags</span><span style=color:#ed9366>.</span><span>needs_recompute {
</span><span>            </span><span style=color:#f07171>queue_text</span><span>(</span><span style=color:#ed9366>...</span><span> all parameters </span><span style=color:#ed9366>...</span><span>)</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre> <p><strong>After:</strong></p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>text_system</span><span>(...) {
</span><span>    </span><span style=color:#fa6e32>for </span><span>(entity</span><span style=color:#61676ccc>,</span><span> node</span><span style=color:#61676ccc>,</span><span> block</span><span style=color:#61676ccc>,</span><span> text_layout_info</span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>mut</span><span> text_flags</span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>mut</span><span> computed) </span><span style=color:#ed9366>in &</span><span style=color:#fa6e32>mut</span><span> text_query {
</span><span>        </span><span style=color:#fa6e32>if</span><span> text_flags</span><span style=color:#ed9366>.</span><span>needs_measure_fn {
</span><span>            </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>        
</span><span>        </span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>(node</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_changed</span><span>() </span><span style=color:#ed9366>||</span><span> text_flags</span><span style=color:#ed9366>.</span><span>needs_recompute) {
</span><span>            </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>        
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ... inlined text queueing logic
</span><span>    }
</span><span>}
</span></code></pre><li><p><strong>Query pattern updates</strong>: Changed from using <code>Mut&LTT></code> wrappers to mutable references in query patterns.</p> <p><strong>Before:</strong></p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>for </span><span>(entity</span><span style=color:#61676ccc>,</span><span> block</span><span style=color:#61676ccc>,</span><span> content_size</span><span style=color:#61676ccc>,</span><span> text_flags</span><span style=color:#61676ccc>,</span><span> computed</span><span style=color:#61676ccc>,</span><span> computed_target</span><span style=color:#61676ccc>,</span><span> computed_node) </span><span style=color:#ed9366>in &</span><span style=color:#fa6e32>mut</span><span> text_query
</span></code></pre> <p><strong>After:</strong></p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>for </span><span>(
</span><span>    entity</span><span style=color:#61676ccc>,
</span><span>    block</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#fa6e32>mut</span><span> content_size</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#fa6e32>mut</span><span> text_flags</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#fa6e32>mut</span><span> computed</span><span style=color:#61676ccc>,
</span><span>    computed_target</span><span style=color:#61676ccc>,
</span><span>    computed_node</span><span style=color:#61676ccc>,
</span><span>) </span><span style=color:#ed9366>in &</span><span style=color:#fa6e32>mut</span><span> text_query
</span></code></pre></ol><p>These changes relate directly to the PR’s purpose of simplifying the module structure by removing unnecessary indirection. The flattened code is easier to follow because all related logic is colocated, and developers don’t need to trace through multiple function calls to understand the system’s behavior.<h2 id=further-reading>Further Reading</h2><p>For readers interested in learning more about the concepts demonstrated in this PR:<ol><li><p><strong>Bevy ECS Systems</strong>: Understanding how Bevy structures systems and queries is fundamental to working with the engine. The official Bevy ECS guide provides detailed information on system design patterns.</p><li><p><strong>Code Refactoring Techniques</strong>: Martin Fowler’s “Refactoring: Improving the Design of Existing Code” covers various refactoring patterns, including “Inline Function” which is similar to what was done in this PR.</p><li><p><strong>Rust Module Design</strong>: The Rust Book’s chapter on modules discusses how to organize code effectively, including when to split or combine functionality.</p><li><p><strong>UI Text Rendering in Game Engines</strong>: For context on why text rendering systems are complex, research on font rasterization, glyph atlases, and text layout algorithms provides background on the challenges this code addresses.</p><li><p><strong>Bevy Text Pipeline</strong>: The Bevy documentation on the <code>TextPipeline</code> and related components would help understand the broader context of these changes within the engine’s text rendering architecture.</p></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_21630.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>