<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22060 Fix macOS panic when exiting from exclusive fullscreen
        
    </title><meta content="#22060 Fix macOS panic when exiting from exclusive fullscreen" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-08</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22060-zh-cn-20251208>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix macOS panic when exiting from exclusive fullscreen<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22060<li><strong>Author</strong>: natepiano<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Windowing, O-MacOS, S-Needs-Review<li><strong>Created</strong>: 2025-12-08T01:47:18Z<li><strong>Merged</strong>: 2025-12-08T21:33:59Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Fix panic on macOS when exiting an app while in exclusive fullscreen mode.<h2 id=solution>Solution</h2><p>Drop windows from <code>WINIT_WINDOWS</code> TLS in <code>fn exiting</code> before the event loop returns.<p>The panic occurs because:<ol><li><code>WINIT_WINDOWS</code> is stored in TLS<li>Windows are dropped during TLS destruction (after event loop exits)<li>winit’s <code>Window::drop</code> calls <code>set_fullscreen(None)</code> for exclusive fullscreen<li>macOS sends a callback that tries to access TLS already being destroyed</ol><p>By clearing windows in <code>fn exiting</code>, they’re dropped while the event loop is still active, avoiding the TLS access issue.<h2 id=testing>Testing</h2><ul><li>Tested on macOS 26.1 (Sequoia) with M2 Max<li>Run <code>cargo run --example monitor_info</code>, then Cmd+Q to quit<li>Without fix: panic with “cannot access a Thread Local Storage value during or after destruction”<li>With fix: clean exit<li>Windows is unaffected</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a specific, platform-specific crash that occurs on macOS when an application exits while in exclusive fullscreen mode. The problem stems from a subtle interaction between macOS windowing APIs, Rust’s thread-local storage (TLS) destruction order, and the Bevy game engine’s window management.<p>The core issue is a timing problem during application shutdown. When a Bevy application using winit for window management exits, several cleanup steps occur in sequence. Windows are managed in a thread-local data structure called <code>WINIT_WINDOWS</code>, which stores active window handles. During normal cleanup, when the event loop ends and the main thread exits, Rust begins destroying thread-local variables. However, on macOS, when a window in exclusive fullscreen mode is dropped, the winit library attempts to switch the window out of exclusive fullscreen by calling <code>set_fullscreen(None)</code>. This macOS system call triggers an asynchronous callback that needs to access the <code>WINIT_WINDOWS</code> TLS to complete the operation. By this point, Rust is already in the process of destroying TLS, leading to the panic “cannot access a Thread Local Storage value during or after destruction.”<p>The fix is straightforward but carefully targeted. Instead of allowing windows to be dropped during TLS destruction (after the event loop has exited), we proactively clear the windows from the <code>WINIT_WINDOWS</code> TLS in the <code>exiting</code> callback. This callback runs while the event loop is still active, before TLS destruction begins. By dropping the windows at this earlier point in the shutdown sequence, the macOS callbacks can safely access the TLS because it hasn’t started being torn down yet.<p>From an architectural perspective, this solution works within Bevy’s existing event handling pattern. The <code>exiting</code> function is already called by winit as part of the event loop lifecycle, making it the appropriate place to perform cleanup that needs to happen before TLS destruction. The implementation adds just four lines of code that clear the windows collection, allowing them to be dropped immediately rather than during TLS cleanup.<p>The fix demonstrates an important principle in cross-platform Rust development: platform-specific edge cases often emerge from subtle interactions between system APIs, library cleanup routines, and Rust’s ownership/destruction semantics. In this case, the macOS windowing system’s asynchronous callback model conflicts with Rust’s deterministic destruction order. The solution elegantly reconciles these by aligning the window cleanup with the appropriate point in the event loop lifecycle.<p>Testing confirms the fix works as intended. On macOS 26.1 with an M2 Max processor, running the <code>monitor_info</code> example and quitting with Cmd+Q previously caused a panic with the TLS destruction error. With this fix, the application exits cleanly. The change is scoped to only affect macOS behavior—Windows and other platforms remain unaffected because they don’t have the same TLS destruction timing issue with fullscreen exit callbacks.<p>This type of fix is characteristic of low-level windowing system integration work, where platform-specific behaviors must be carefully accounted for. The solution is minimal and surgical, addressing only the specific timing issue without introducing broader architectural changes or affecting other platforms.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Application Exit Initiated] --> B[Event Loop enters exiting phase]
</span><span>    B --> C{WINIT_WINDOWS.clear() called}
</span><span>    C --> D[Windows dropped normally]
</span><span>    D --> E[TLS destruction begins]
</span><span>    E --> F[Clean shutdown]
</span><span>    
</span><span>    G[Original Bug Path] --> H[Event Loop exits]
</span><span>    H --> I[TLS destruction begins]
</span><span>    I --> J[Window.drop() called]
</span><span>    J --> K[macOS callback triggered]
</span><span>    K --> L[TLS access during destruction]
</span><span>    L --> M[PANIC: cannot access TLS]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ul><li><code>crates/bevy_winit/src/state.rs</code> (+4/-0)</ul><p>The only file modified in this PR contains the fix for the macOS panic. The change adds a call to clear the windows from thread-local storage during the <code>exiting</code> callback, ensuring they’re dropped before TLS destruction begins.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// File: crates/bevy_winit/src/state.rs
</span><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>exiting</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>_event_loop</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>ActiveEventLoop) {
</span><span>    </span><span style=color:#fa6e32>let</span><span> world </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>world_mut</span><span>()</span><span style=color:#61676ccc>;
</span><span>    world</span><span style=color:#ed9366>.</span><span style=color:#f07171>clear_all</span><span>()</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>exiting</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>_event_loop</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>ActiveEventLoop) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Drop windows while event loop is still active, before TLS destruction.
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Prevents panic on macOS when exiting from exclusive fullscreen.
</span><span>    </span><span style=color:#ff8f40>WINIT_WINDOWS</span><span style=color:#ed9366>.</span><span style=color:#f07171>with</span><span>(|</span><span style=color:#ff8f40>ww</span><span>| ww</span><span style=color:#ed9366>.</span><span style=color:#f07171>borrow_mut</span><span>()</span><span style=color:#ed9366>.</span><span>windows</span><span style=color:#ed9366>.</span><span style=color:#f07171>clear</span><span>())</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#fa6e32>let</span><span> world </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>world_mut</span><span>()</span><span style=color:#61676ccc>;
</span><span>    world</span><span style=color:#ed9366>.</span><span style=color:#f07171>clear_all</span><span>()</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>The change adds three lines: a comment explaining the purpose, and the actual call to clear the windows from the <code>WINIT_WINDOWS</code> thread-local storage. The <code>WINIT_WINDOWS.with(|ww| ...)</code> pattern accesses the thread-local variable, and <code>ww.borrow_mut().windows.clear()</code> empties the collection of windows, causing them to be dropped immediately. This ensures that when macOS triggers callbacks during window cleanup, the TLS is still accessible.<h2 id=further-reading>Further Reading</h2><ol><li><p><strong>Rust Thread Local Storage Documentation</strong>: The Rust Book’s section on thread-local storage explains how <code>thread_local!</code> macro works and its destruction semantics.</p><li><p><strong>winit Window Management</strong>: The winit crate’s documentation on window lifecycle and platform-specific behaviors, particularly around fullscreen transitions on macOS.</p><li><p><strong>macOS Window Server Programming Guide</strong>: Apple’s documentation on NSWindow and fullscreen transitions, which explains the callback mechanism that triggers during fullscreen exit.</p><li><p><strong>Bevy Winit Integration</strong>: The Bevy engine’s winit integration code for understanding how window management is structured across different platforms.</p><li><p><strong>Memory Safety in Async Callbacks</strong>: Articles on Rust’s approach to memory safety when dealing with asynchronous system callbacks, particularly during cleanup phases.</p></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22060.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>