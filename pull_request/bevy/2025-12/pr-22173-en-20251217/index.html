<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22173 Fix atmosphere lighting issue for below ground geo
        
    </title><meta content="#22173 Fix atmosphere lighting issue for below ground geo" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-17</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22173-zh-cn-20251217>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=fix-atmosphere-lighting-issue-for-below-ground-geo>Fix atmosphere lighting issue for below ground geo</h2><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix atmosphere lighting issue for below ground geo<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22173<li><strong>Author</strong>: mate-h<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, S-Ready-For-Final-Review, D-Straightforward<li><strong>Created</strong>: 2025-12-17T22:03:14Z<li><strong>Merged</strong>: 2025-12-17T23:36:11Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h3 id=objective>Objective</h3><ul><li>Fix atmosphere lighting issue for below ground geo</ul><p>Issue reported in discord channel for <code>rendering-dev</code> by Jondolf@</p><img alt=image height=2111 src=https://github.com/user-attachments/assets/f2768fd5-2e70-46cb-b0f3-b078d115fd33 width=3840><p>Repro on <a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/commit/f8a9f296bf45584feb987d626dbf331ac9b01918 target=_blank>f8a9f29</a><pre class=language-rs data-lang=rs style=color:#61676c;background-color:#fafafa><code class=language-rs data-lang=rs><span style=color:#fa6e32>use </span><span>bevy</span><span style=color:#ed9366>::</span><span>{pbr</span><span style=color:#ed9366>::</span><span>EarthlikeAtmosphere</span><span style=color:#61676ccc>, </span><span>prelude</span><span style=color:#ed9366>::*</span><span>}</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>main</span><span>() {
</span><span>    App</span><span style=color:#ed9366>::</span><span>new()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>add_plugins</span><span>(DefaultPlugins)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(Startup</span><span style=color:#61676ccc>,</span><span> setup)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>run</span><span>()</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>setup</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>meshes</span><span style=color:#61676ccc>: </span><span>ResMut&LTAssets&LTMesh>>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>materials</span><span style=color:#61676ccc>: </span><span>ResMut&LTAssets&LTStandardMaterial>>,
</span><span>    </span><span style=color:#ff8f40>earthlike_atmosphere</span><span style=color:#61676ccc>: </span><span>Res&LTEarthlikeAtmosphere>,
</span><span>) {
</span><span>    commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((
</span><span>        Mesh3d(meshes</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(Capsule3d</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ff8f40>0.5</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>1.0</span><span>)))</span><span style=color:#61676ccc>,
</span><span>        MeshMaterial3d(materials</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(Color</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>WHITE</span><span>))</span><span style=color:#61676ccc>,
</span><span>    ))</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Directional light
</span><span>    commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((
</span><span>        DirectionalLight {
</span><span>            illuminance</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>5000.0</span><span style=color:#61676ccc>,
</span><span>            shadows_enabled</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>true</span><span style=color:#61676ccc>,
</span><span>            </span><span style=color:#ed9366>..</span><span style=color:#f07171>default</span><span>()
</span><span>        }</span><span style=color:#61676ccc>,
</span><span>        Transform</span><span style=color:#ed9366>::</span><span>from_xyz(</span><span style=color:#ff8f40>1.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>2.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>2.0</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>looking_at</span><span>(Vec3</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ZERO</span><span style=color:#61676ccc>, </span><span>Vec3</span><span style=color:#ed9366>::</span><span>Y)</span><span style=color:#61676ccc>,
</span><span>    ))</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Camera and atmosphere
</span><span>    commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((
</span><span>        Camera3d</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>,
</span><span>        earthlike_atmosphere</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>()</span><span style=color:#61676ccc>,
</span><span>        Transform</span><span style=color:#ed9366>::</span><span>from_xyz(</span><span style=color:#ff8f40>10.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>2.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>15.0</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>looking_at</span><span>(Vec3</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ff8f40>0.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.0</span><span>)</span><span style=color:#61676ccc>, </span><span>Vec3</span><span style=color:#ed9366>::</span><span>Y)</span><span style=color:#61676ccc>,
</span><span>    ))</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h2 id=solution>Solution</h2><ul><li>Clamp the position to the ground surface with a small epsilon before calculating occlusion from the planet</ul><h2 id=testing>Testing</h2><ul><li>Ran the atmosphere example with local changes to put geo below-ground</ul><hr><h2 id=showcase>Showcase</h2><p>Before <img alt="Screenshot 2025-12-17 at 1 58 21 PM" height=720 src=https://github.com/user-attachments/assets/f442e0f9-b688-4d16-ad08-d9b3414c8b0f width=1283><p>After</p><img alt="Screenshot 2025-12-17 at 1 57 56 PM" height=719 src=https://github.com/user-attachments/assets/557ea595-3b9d-4fbf-8c94-10377deb046a width=1275><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a specific rendering artifact in Bevy’s physically-based atmosphere system. When geometry is positioned below the planet’s surface in scenes using Earth-like atmospheric scattering, incorrect lighting calculations produce visual artifacts where objects appear unnaturally dark or incorrectly illuminated.<p>The problem was reported in the rendering-dev Discord channel by Jondolf@, who provided both a visual example showing the issue and a minimal reproduction case. The reproduction code places a simple capsule below ground level in a scene with Earth-like atmosphere rendering enabled. The atmospheric scattering calculations in Bevy’s PBR system weren’t handling sub-surface geometry correctly.<p>At the core of the issue is how atmospheric scattering calculations treat points below the planet’s surface. The atmosphere system needs to compute lighting occlusion based on the line of sight from a point on or above the planet’s surface to the sun. When a point is below the surface, the mathematical model breaks down because atmospheric scattering equations assume you’re looking through atmosphere, not solid ground.<p>The developer identified two places in the rendering pipeline where this needed fixing: camera/view calculations and fragment lighting calculations. Both locations required the same fundamental correction: when computing atmospheric effects for a point, if that point is below the planet’s surface, it should be treated as being on the surface instead.<p>The solution implements this by creating a reusable <code>clamp_to_surface</code> function that takes a position and ensures it’s at or above the planet’s surface with a small epsilon. The epsilon value (<code>EPSILON</code>) is crucial - it prevents numerical precision issues that could cause division by zero or other artifacts when points are exactly at the surface boundary.<p>In the camera/view calculations (<code>get_view_position</code> function), the fix ensures that even if the camera is positioned below ground (which might happen during camera animation or in certain game scenarios), atmospheric rendering calculations use a surface-level position instead. This prevents the camera from seeing incorrect atmospheric effects when looking from underground positions.<p>For fragment lighting calculations, the same clamping is applied to the fragment’s world position before computing atmospheric occlusion. This ensures that objects below ground receive lighting as if they were on the surface, which is physically reasonable since any object truly underground wouldn’t be visible anyway.<p>The implementation demonstrates good code organization by extracting the clamping logic into a reusable function rather than duplicating it. This follows the DRY principle and makes the codebase more maintainable. The function is documented with a clear comment explaining its purpose: “Clamp a position to the planet surface (with a small epsilon) to avoid underground artifacts.”<p>An important technical consideration here is that the fix doesn’t actually move the camera or objects in the scene - it only adjusts the positions used for atmospheric scattering calculations. This means the visual representation of object positions remains accurate, while the atmospheric lighting calculations use corrected positions.<p>The testing approach was straightforward: the developer modified the existing atmosphere example to position geometry below ground and verified that the visual artifacts were resolved. The before-and-after screenshots clearly show the improvement: objects below ground now receive correct atmospheric lighting instead of appearing as dark silhouettes against the sky.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Camera/Geometry Position] --> B{Is below ground?}
</span><span>    B -- Yes --> C[Clamp to surface&LTbr/>with epsilon]
</span><span>    B -- No --> D[Use original position]
</span><span>    C --> E[Atmospheric Scattering&LTbr/>Calculations]
</span><span>    D --> E
</span><span>    E --> F[Final Lighting Output]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ol><li><p><strong><code>crates/bevy_pbr/src/atmosphere/functions.wgsl</code></strong> (+12/-12)</p> <p>This file contains WebGPU Shading Language (WGSL) functions for atmospheric calculations. The change adds a new utility function and refactors an existing one to use it.</p> <p><strong>Key changes:</strong></p> <ul><li>Added <code>clamp_to_surface</code> function that ensures positions are at or above planet surface<li>Refactored <code>get_view_position</code> to use the new utility function</ul> <p><strong>Code snippets:</strong></p> <pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// New function added
</span><span>/// Clamp a position to the planet surface (with a small epsilon) to avoid underground artifacts.
</span><span>fn clamp_to_surface(atmosphere: Atmosphere, position: vec3&LTf32>) -> vec3&LTf32> {
</span><span>    let min_radius = atmosphere.bottom_radius + EPSILON;
</span><span>    let r = length(position);
</span><span>    if r < min_radius {
</span><span>        let up = normalize(position);
</span><span>        return up * min_radius;
</span><span>    }
</span><span>    return position;
</span><span>}
</span><span>
</span><span>// Updated function
</span><span>fn get_view_position() -> vec3&LTf32> {
</span><span>    var world_pos = view.world_position * settings.scene_units_to_m + vec3(0.0, atmosphere.bottom_radius, 0.0);
</span><span>    return clamp_to_surface(atmosphere, world_pos);  // Now uses the utility function
</span><span>}
</span></code></pre><li><p><strong><code>crates/bevy_pbr/src/render/pbr_lighting.wgsl</code></strong> (+4/-3)</p> <p>This file handles PBR lighting calculations including atmospheric effects. The change applies the same clamping logic to fragment positions during lighting calculations.</p> <p><strong>Key changes:</strong></p> <ul><li>Added import for the new <code>clamp_to_surface</code> function<li>Applied position clamping before atmospheric occlusion calculations</ul> <p><strong>Code snippets:</strong></p> <pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Updated import
</span><span>#import bevy_pbr::{
</span><span>    mesh_view_types::POINT_LIGHT_FLAGS_SPOT_LIGHT_Y_NEGATIVE,
</span><span>    mesh_view_bindings as view_bindings,
</span><span>    atmosphere::functions::{calculate_visible_sun_ratio, clamp_to_surface},  // Added clamp_to_surface
</span><span>    atmosphere::bruneton_functions::transmittance_lut_r_mu_to_uv,
</span><span>}
</span><span>
</span><span>// Updated position handling in lighting calculations
</span><span>let O = vec3(0.0, atmosphere.bottom_radius, 0.0);
</span><span>let P_scaled = P * vec3(view_bindings::atmosphere_data.settings.scene_units_to_m);
</span><span>let P_as = P_scaled + O;
</span><span>let P_clamped = clamp_to_surface(atmosphere, P_as);  // New: clamp position
</span><span>let r = length(P_clamped);                           // Now uses clamped position
</span><span>let local_up = normalize(P_clamped);                 // Now uses clamped position
</span></code></pre></ol><h2 id=further-reading>Further Reading</h2><ol><li><strong>Bevy’s PBR and Atmosphere Documentation</strong>: For understanding Bevy’s physically-based rendering pipeline and atmospheric scattering implementation<li><strong>WebGPU Shading Language (WGSL) Specification</strong>: For understanding the shader language used in these changes<li><strong>Bruneton’s Precomputed Atmospheric Scattering</strong>: The original paper that describes the atmospheric model Bevy implements (referenced in the code as <code>bruneton_functions</code>)<li><strong>Numerical Stability in Graphics Programming</strong>: For understanding why epsilon values are important in floating-point calculations<li><strong>Bevy’s Rendering Architecture</strong>: To understand how shader functions fit into Bevy’s overall rendering system</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22173.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>