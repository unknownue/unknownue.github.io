<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22075 Simplify `ui_picking`'s camera search
        
    </title><meta content="#22075 Simplify `ui_picking`'s camera search" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-09</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22075-zh-cn-20251209>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>Simplify <code>ui_picking</code>’s camera search<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Simplify <code>ui_picking</code>’s camera search<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22075<li><strong>Author</strong>: ickshonpe<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: D-Trivial, A-UI, C-Code-Quality, S-Ready-For-Final-Review, A-Picking<li><strong>Created</strong>: 2025-12-09T11:25:08Z<li><strong>Merged</strong>: 2025-12-09T18:33:58Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>In <code>ui_picking</code> the camera_query iterator is run through multiple filters and maps, which could be replaced by a single filter. Also camera_query retrieves the <code>Camera</code> component but then it is thrown away and queried for again.<h2 id=solution>Solution</h2><ul><li>Just collapse all the maps and filters into one <code>filter</code>.<li>Only query for <code>Camera</code> once and keep the result, remove the second query.</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The <code>ui_picking</code> function in Bevy’s UI system handles determining which UI elements are under the pointer for interaction. A key part of this process involves finding cameras that can see the render target where the pointer is located. The original implementation had a performance inefficiency and unnecessary complexity in how it filtered and processed camera entities.<p>The problem was straightforward but subtle. The code was using a chain of iterator operations - <code>filter</code>, <code>map</code>, <code>filter_map</code>, another <code>filter</code>, and another <code>map</code> - to process camera entities. This created multiple intermediate iterator stages that didn’t add value. More importantly, the implementation was querying for camera data twice: once in the initial query that started the iterator chain, and then again inside the loop for each camera entity using <code>camera_query.get(camera)</code>. This double querying was unnecessary overhead since the camera data was already available from the initial query.<p>The solution took a more direct approach by consolidating all the filtering logic into a single <code>filter</code> operation. The key insight was that all the transformation steps in the original chain could be expressed as conditional checks in one filter. Instead of transforming data through multiple stages and then querying again, the new implementation keeps the camera component from the initial query and uses it directly.<p>Here’s the technical transformation: the original code was normalizing camera targets, checking them against the pointer’s target, and then extracting camera entities. The new implementation does all these checks in one filter predicate that:<ol><li>Checks if camera markers are required (via <code>settings.require_markers</code>)<li>Normalizes the camera target and compares it with the pointer’s target using <code>is_some_and</code><li>Returns <code>true</code> only when all conditions are satisfied</ol><p>This change eliminates the second query entirely. Inside the loop, the code now directly uses the <code>camera</code> component that was already retrieved in the filter, rather than querying for it again. This is more efficient and also makes the code easier to understand since the data flow is more linear.<p>The performance improvement comes from two factors: eliminating the second query per camera entity, and reducing iterator overhead by collapsing multiple operations into one. While the impact might be small for typical use cases, this optimization follows good practice for ECS (Entity Component System) patterns where avoiding redundant queries is important for maintaining performance as entity counts grow.<p>The architectural implication is that this change better aligns with Bevy’s ECS philosophy of processing components efficiently in queries. By keeping components from the initial query and using them directly, the code follows the pattern of “query once, use many times” that’s optimal for ECS systems.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Camera Query Iterator] --> B[Original: Multi-stage Processing]
</span><span>    A --> C[New: Single Filter]
</span><span>    
</span><span>    B --> D[Filter: require_markers]
</span><span>    B --> E[Map: normalize target]
</span><span>    B --> F[FilterMap: target existence]
</span><span>    B --> G[Filter: target match]
</span><span>    B --> H[Map: extract entity]
</span><span>    H --> I[Second Query: get Camera]
</span><span>    
</span><span>    C --> J[Single Filter: All conditions]
</span><span>    C --> K[Direct Camera access]
</span><span>    
</span><span>    I --> L[Process pointer position]
</span><span>    K --> L
</span><span>    
</span><span>    style B stroke:#f66,stroke-width:2px
</span><span>    style C stroke:#6f6,stroke-width:2px
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>File: <code>crates/bevy_ui/src/picking_backend.rs</code></strong> (+10/-19)<p>This file contains the <code>ui_picking</code> system which handles UI element picking (determining which UI elements are under the pointer). The changes refactor how cameras are filtered and processed for pointer position calculations.<p><strong>Before:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>for</span><span> camera </span><span style=color:#ed9366>in</span><span> camera_query
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>filter</span><span>(|(_</span><span style=color:#61676ccc>,</span><span> _</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>cam_can_pick</span><span>)| </span><span style=color:#ed9366>!</span><span>settings</span><span style=color:#ed9366>.</span><span>require_markers </span><span style=color:#ed9366>|| *</span><span>cam_can_pick)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|(</span><span style=color:#ff8f40>entity</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>camera</span><span style=color:#61676ccc>,</span><span> _)| {
</span><span>        (
</span><span>            entity</span><span style=color:#61676ccc>,
</span><span>            camera</span><span style=color:#ed9366>.</span><span>target</span><span style=color:#ed9366>.</span><span style=color:#f07171>normalize</span><span>(primary_window</span><span style=color:#ed9366>.</span><span style=color:#f07171>single</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>ok</span><span>())</span><span style=color:#61676ccc>,
</span><span>        )
</span><span>    })
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>filter_map</span><span>(|(</span><span style=color:#ff8f40>entity</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>target</span><span>)| </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(entity)</span><span style=color:#ed9366>.</span><span style=color:#f07171>zip</span><span>(target))
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>filter</span><span>(|(</span><span style=color:#ff8f40>_entity</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>target</span><span>)| target </span><span style=color:#ed9366>== &</span><span>pointer_location</span><span style=color:#ed9366>.</span><span>target)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|(</span><span style=color:#ff8f40>cam_entity</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>_target</span><span>)| cam_entity)
</span><span>{
</span><span>    </span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>((</span><span style=color:#ed9366>_</span><span style=color:#61676ccc>,</span><span> camera_data</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>_</span><span>)) </span><span style=color:#ed9366>=</span><span> camera_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(camera) </span><span style=color:#fa6e32>else </span><span>{
</span><span>        </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>    }</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> pointer_pos </span><span style=color:#ed9366>=
</span><span>        pointer_location</span><span style=color:#ed9366>.</span><span>position </span><span style=color:#ed9366>*</span><span> camera_data</span><span style=color:#ed9366>.</span><span style=color:#f07171>target_scaling_factor</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_or</span><span>(</span><span style=color:#ff8f40>1.</span><span>)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... rest of processing
</span><span>}
</span></code></pre><p><strong>After:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>for </span><span>(entity</span><span style=color:#61676ccc>,</span><span> camera</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>_</span><span>) </span><span style=color:#ed9366>in</span><span> camera_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>filter</span><span>(|(_</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>camera</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>cam_can_pick</span><span>)| {
</span><span>    (</span><span style=color:#ed9366>!</span><span>settings</span><span style=color:#ed9366>.</span><span>require_markers </span><span style=color:#ed9366>|| *</span><span>cam_can_pick)
</span><span>        </span><span style=color:#ed9366>&&</span><span> camera
</span><span>            </span><span style=color:#ed9366>.</span><span>target
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>normalize</span><span>(primary_window</span><span style=color:#ed9366>.</span><span style=color:#f07171>single</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>ok</span><span>())
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>is_some_and</span><span>(|</span><span style=color:#ff8f40>target</span><span>| target </span><span style=color:#ed9366>==</span><span> pointer_location</span><span style=color:#ed9366>.</span><span>target)
</span><span>}) {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> pointer_pos </span><span style=color:#ed9366>=
</span><span>        pointer_location</span><span style=color:#ed9366>.</span><span>position </span><span style=color:#ed9366>*</span><span> camera</span><span style=color:#ed9366>.</span><span style=color:#f07171>target_scaling_factor</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_or</span><span>(</span><span style=color:#ff8f40>1.</span><span>)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... rest of processing
</span><span>}
</span></code></pre><p>The key changes:<ol><li><strong>Collapsed iterator chain</strong>: Multiple <code>filter</code>, <code>map</code>, <code>filter_map</code> operations replaced with a single <code>filter</code> that combines all conditions<li><strong>Eliminated second query</strong>: No more <code>camera_query.get(camera)</code> call inside the loop<li><strong>Direct component access</strong>: The <code>camera</code> component is used directly from the filtered iterator<li><strong>Simplified logic</strong>: The normalization and comparison are done inline using <code>is_some_and</code></ol><h2 id=further-reading>Further Reading</h2><ol><li><p><strong>Bevy ECS Query Documentation</strong>: Understanding how Bevy’s query system works is essential for writing efficient systems</p> <ul><li>https://bevyengine.org/learn/quick-start/ecs/</ul><li><p><strong>Iterator Methods in Rust</strong>: The PR uses various iterator methods (<code>filter</code>, <code>map</code>, <code>filter_map</code>, <code>is_some_and</code>)</p> <ul><li>https://doc.rust-lang.org/std/iter/trait.Iterator.html</ul><li><p><strong>Rust’s <code>is_some_and</code> Method</strong>: This method was stabilized in Rust 1.70 and provides a concise way to check and use <code>Option</code> values</p> <ul><li>https://doc.rust-lang.org/std/option/enum.Option.html#method.is_some_and</ul><li><p><strong>Bevy UI Picking System</strong>: Understanding the broader context of UI picking in Bevy</p> <ul><li>Source code: <code>crates/bevy_ui/src/picking_backend.rs</code></ul><li><p><strong>Performance Optimization Patterns in ECS</strong>: Techniques for writing efficient ECS systems</p> <ul><li>Avoid redundant queries<li>Minimize iterator allocations<li>Process components in batches when possible</ul></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22075.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>