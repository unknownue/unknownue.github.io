<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21630 UI text module refactor
        
    </title><meta content="#21630 UI text module refactor" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-02</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2025-12/pr-21630-en-20251202>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=ui-text-module-refactor>UI text module refactor</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: UI text module refactor<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21630<li><strong>Author</strong>: ickshonpe<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: D-Trivial, A-UI, C-Code-Quality, S-Ready-For-Final-Review, A-Text<li><strong>Created</strong>: 2025-10-22T20:35:30Z<li><strong>Merged</strong>: 2025-12-02T19:59:11Z<li><strong>Merged By</strong>: cart</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p><code>measure_text_system</code> 和 <code>text_system</code> 这两个系统除了遍历查询（query）并分别委托给另外两个函数 <code>create_text_measure</code> 和 <code>queue_text</code> 之外，没有做任何其他事情。这没有任何实际用途，只会让这些系统更难理解。<h2 id=solution>Solution</h2><p>通过将 <code>create_text_measure</code> 和 <code>queue_text</code> 中的代码移入相应的系统，并移除这两个函数，来扁平化（flatten）模块结构。<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>这个PR的核心是一个直接的代码重构，旨在简化Bevy引擎UI模块中文本处理系统的结构。问题在于现有的 <code>measure_text_system</code> 和 <code>text_system</code> 这两个系统（system）设计得过于间接。它们的主要作用只是作为包装器，遍历查询结果，然后将所有参数传递给独立的辅助函数 <code>create_text_measure</code> 和 <code>queue_text</code>。这种设计增加了不必要的抽象层级，使得理解数据流和控制流变得复杂。开发者需要在这三个地方（系统函数和两个辅助函数）之间跳转才能理解完整的逻辑，这降低了代码的可读性和可维护性。<p>开发者采取的解决方案是代码内联（inlining）。通过将 <code>create_text_measure</code> 和 <code>queue_text</code> 的函数体直接移动到它们各自被调用的系统函数内部，从而消除这个间接层。这种扁平化处理使得每个系统的逻辑自包含（self-contained），所有相关的状态变更和错误处理都集中在同一个代码块中，更易于跟踪。<p>具体实现涉及两个主要变更。首先，在 <code>measure_text_system</code> 中，原本调用 <code>create_text_measure</code> 函数的代码块被替换为该函数体的内容。重构还引入了一个逻辑优化：原函数在满足条件时被调用，重构后改为在<strong>不满足</strong>条件时使用 <code>continue</code> 跳过当前迭代，这使逻辑更加清晰。代码直接与 <code>text_pipeline.create_text_measure</code> 交互，并根据其返回的 <code>Result</code> 来设置 <code>content_size</code>（内容尺寸）和更新 <code>text_flags</code>（文本标志位）。<p>其次，在 <code>text_system</code> 中，<code>queue_text</code> 的函数体被内联。这里也增加了一个早期退出检查（<code>if text_flags.needs_measure_fn</code>），这原本在 <code>queue_text</code> 函数内部，现在提前到系统循环的开始处，可以避免不必要的后续计算。核心逻辑变为直接调用 <code>text_pipeline.queue_text</code> 并处理其结果。一个值得注意的细节是，成功处理文本后，用于更新 <code>text_layout_info.scale_factor</code> 和 <code>size</code> 的代码现在直接使用系统查询中获取的 <code>node</code> 组件数据，而不是通过函数参数传递，这减少了参数传递的复杂度。<p>从技术角度来看，这次重构并没有改变任何功能或算法，纯粹是代码组织结构（code organization）的优化。它移除了两个仅用作“传递（pass-through）”的辅助函数，减少了模块的总行数（从文件差异可见，+97/-152）。这种重构降低了认知负担（cognitive load），因为开发者现在只需阅读系统函数本身就能理解完整的文本测量和排队逻辑。此外，内联后，与文本处理相关的所有状态突变（如设置 <code>text_flags.needs_recompute</code>）都发生在同一个作用域内，使得数据流（data flow）更加明显，有助于防止因状态更新遗漏或顺序错误而导致的bug。<p>这次改动的影响是积极的，它使代码库更加整洁，符合保持代码简单直接（keeping code simple and straightforward）的工程原则。对于Bevy这样一个游戏引擎项目，确保核心系统易于理解和调试至关重要。从这次重构中可以学到，当辅助函数除了转发参数外没有其他明确职责（如复用逻辑、提供不同接口）时，将其内联到调用方通常是更好的选择，这能减少不必要的抽象并提高代码的透明度。<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    subgraph "重构前 (Before Refactor)"
</span><span>        A[measure_text_system] --> B[create_text_measure 函数]
</span><span>        C[text_system] --> D[queue_text 函数]
</span><span>        B --> E[TextPipeline]
</span><span>        D --> E
</span><span>    end
</span><span>
</span><span>    subgraph "重构后 (After Refactor)"
</span><span>        F[measure_text_system] --> G[直接调用 TextPipeline]
</span><span>        H[text_system] --> G
</span><span>    end
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>crates/bevy_ui/src/widget/text.rs</strong> (+97/-152) 这是此PR中唯一被修改的文件。改动主要包括删除两个独立的辅助函数（<code>create_text_measure</code> 和 <code>queue_text</code>），并将它们的逻辑直接内联到对应的系统函数（<code>measure_text_system</code> 和 <code>text_system</code>）中。这使得代码逻辑更加集中，减少了不必要的间接调用层。<p>关键修改示例：<ol><li><strong><code>measure_text_system</code> 的重构</strong>： <ul><li>之前：系统遍历查询，在条件满足时调用 <code>create_text_measure</code> 辅助函数。<li>之后：系统包含所有逻辑，直接处理 <code>text_pipeline.create_text_measure</code> 的调用和结果。</ul></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 重构前（简化示意）：
</span><span style=color:#fa6e32>for </span><span style=color:#ed9366>... in &</span><span style=color:#fa6e32>mut</span><span> text_query {
</span><span>    </span><span style=color:#fa6e32>if</span><span> condition {
</span><span>        </span><span style=color:#f07171>create_text_measure</span><span>(entity</span><span style=color:#61676ccc>,</span><span> fonts</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>...</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> text_pipeline</span><span style=color:#61676ccc>,</span><span> content_size</span><span style=color:#61676ccc>,</span><span> text_flags</span><span style=color:#61676ccc>,</span><span> computed</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>...</span><span>)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 重构后（关键部分）：
</span><span style=color:#fa6e32>for </span><span>(</span><span style=color:#ed9366>...</span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>mut</span><span> content_size</span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>mut</span><span> text_flags</span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>mut</span><span> computed</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>...</span><span>) </span><span style=color:#ed9366>in &</span><span style=color:#fa6e32>mut</span><span> text_query {
</span><span>    </span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>condition {
</span><span>        </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>    </span><span style=color:#fa6e32>match</span><span> text_pipeline</span><span style=color:#ed9366>.</span><span style=color:#f07171>create_text_measure</span><span>(entity</span><span style=color:#61676ccc>,</span><span> fonts</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_ref</span><span>()</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>...</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>block</span><span style=color:#61676ccc>,</span><span> computed</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_mut</span><span>()</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>...</span><span>) {
</span><span>        </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(measure) </span><span style=color:#ed9366>=> </span><span>{
</span><span>            </span><span style=color:#abb0b6;font-style:italic>// 直接设置 content_size 和 text_flags
</span><span>            </span><span style=color:#fa6e32>if</span><span> block</span><span style=color:#ed9366>.</span><span>linebreak </span><span style=color:#ed9366>== </span><span>LineBreak</span><span style=color:#ed9366>::</span><span>NoWrap {
</span><span>                content_size</span><span style=color:#ed9366>.</span><span style=color:#f07171>set</span><span>(NodeMeasure</span><span style=color:#ed9366>::</span><span>Fixed(FixedMeasure { size</span><span style=color:#61676ccc>:</span><span> measure</span><span style=color:#ed9366>.</span><span>max }))</span><span style=color:#61676ccc>;
</span><span>            } </span><span style=color:#fa6e32>else </span><span>{
</span><span>                content_size</span><span style=color:#ed9366>.</span><span style=color:#f07171>set</span><span>(NodeMeasure</span><span style=color:#ed9366>::</span><span>Text(TextMeasure { info</span><span style=color:#61676ccc>:</span><span> measure }))</span><span style=color:#61676ccc>;
</span><span>            }
</span><span>            text_flags</span><span style=color:#ed9366>.</span><span>needs_measure_fn </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>false</span><span style=color:#61676ccc>;
</span><span>            text_flags</span><span style=color:#ed9366>.</span><span>needs_recompute </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>true</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>        </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(TextError</span><span style=color:#ed9366>::</span><span>NoSuchFont) </span><span style=color:#ed9366>=> </span><span>{
</span><span>            text_flags</span><span style=color:#ed9366>.</span><span>needs_measure_fn </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>true</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ... 其他错误处理
</span><span>    }
</span><span>}
</span></code></pre><ol start=2><li><strong><code>text_system</code> 的重构</strong>： <ul><li>之前：系统调用 <code>queue_text</code> 辅助函数。<li>之后：系统直接包含排队逻辑和错误处理。</ul></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 重构后逻辑的核心部分：
</span><span style=color:#fa6e32>for </span><span>(entity</span><span style=color:#61676ccc>,</span><span> node</span><span style=color:#61676ccc>,</span><span> block</span><span style=color:#61676ccc>,</span><span> text_layout_info</span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>mut</span><span> text_flags</span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>mut</span><span> computed) </span><span style=color:#ed9366>in &</span><span style=color:#fa6e32>mut</span><span> text_query {
</span><span>    </span><span style=color:#fa6e32>if</span><span> text_flags</span><span style=color:#ed9366>.</span><span>needs_measure_fn {
</span><span>        </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>    </span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>(node</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_changed</span><span>() </span><span style=color:#ed9366>||</span><span> text_flags</span><span style=color:#ed9366>.</span><span>needs_recompute) {
</span><span>        </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#fa6e32>let</span><span> physical_node_size </span><span style=color:#ed9366>= ...</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// 直接计算
</span><span>    </span><span style=color:#fa6e32>let</span><span> text_layout_info </span><span style=color:#ed9366>=</span><span> text_layout_info</span><span style=color:#ed9366>.</span><span style=color:#f07171>into_inner</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>match</span><span> text_pipeline</span><span style=color:#ed9366>.</span><span style=color:#f07171>queue_text</span><span>(text_layout_info</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>fonts</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>...</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> computed</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>...</span><span>) {
</span><span>        </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(()) </span><span style=color:#ed9366>=> </span><span>{
</span><span>            </span><span style=color:#abb0b6;font-style:italic>// 直接更新 text_layout_info 和 flags
</span><span>            text_layout_info</span><span style=color:#ed9366>.</span><span>scale_factor </span><span style=color:#ed9366>=</span><span> node</span><span style=color:#ed9366>.</span><span>inverse_scale_factor</span><span style=color:#ed9366>.</span><span style=color:#f07171>recip</span><span>()</span><span style=color:#61676ccc>;
</span><span>            text_layout_info</span><span style=color:#ed9366>.</span><span>size </span><span style=color:#ed9366>*=</span><span> node</span><span style=color:#ed9366>.</span><span>inverse_scale_factor</span><span style=color:#61676ccc>;
</span><span>            text_flags</span><span style=color:#ed9366>.</span><span>needs_recompute </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>false</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ... 错误处理
</span><span>    }
</span><span>}
</span></code></pre><ol start=3><li><strong>被移除的函数</strong>： 文件中原有的 <code>create_text_measure</code> 和 <code>queue_text</code> 函数定义被完全删除。</ol><h2 id=further-reading>Further Reading</h2><ul><li><strong>Bevy ECS 官方手册 - 系统（Systems）</strong>: https://bevyengine.org/learn/book/next/programming/ecs/systems 有助于理解 <code>measure_text_system</code> 和 <code>text_system</code> 在 Bevy 的实体组件系统（ECS）架构中的角色。<li><strong>代码重构：内联函数（Inline Method）</strong>: 这是 Martin Fowler 在《重构：改善既有代码的设计》中提出的一个经典重构手法。此PR是此手法的一个典型应用场景。<li><strong>Rust 编程语言：闭包与代码组织</strong>: 虽然此PR没有使用闭包，但理解何时将代码组织为独立函数、何时内联，是编写清晰 Rust 代码的重要部分。Rust 官方教程中关于函数和模块的章节提供了基础。</ul><h1 id=full-code-diff>Full Code Diff</h1><p>diff –git a/crates/bevy_ui/src/widget/text.rs b/crates/bevy_ui/src/widget/text.rs index d604bc6977cd9..c84b463ddf3cb 100644 — a/crates/bevy_ui/src/widget/text.rs +++ b/crates/bevy_ui/src/widget/text.rs @@ -12,7 +12,7 @@ use bevy_ecs::{ query::With, reflect::ReflectComponent, system::{Query, Res, ResMut},<ul><li>world::{Mut, Ref},</ul><ul><li>world::Ref, }; use bevy_image::prelude::*; use bevy_math::Vec2; @@ -223,55 +223,6 @@ impl Measure for TextMeasure { } }</ul><p>-#[inline] -fn create_text_measure<’a>(<ul><li>entity: Entity,<li>fonts: &Assets<font>, <li>scale_factor: f64,</li> <li>spans: impl Iterator&LTItem = (Entity, usize, &’a str, &’a TextFont, Color, LineHeight)>,</li> <li>block: Ref<textlayout>, <li>text_pipeline: &mut TextPipeline,</li> <li>mut content_size: Mut<contentsize>, <li>mut text_flags: Mut<textnodeflags>, <li>mut computed: Mut<computedtextblock>, <li>font_system: &mut CosmicFontSystem, -) {</li> <li>match text_pipeline.create_text_measure(</li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>   entity,
</span></code></pre></li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>   fonts,
</span></code></pre></li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>   spans,
</span></code></pre></li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>   scale_factor,
</span></code></pre></li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>   &block,
</span></code></pre></li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>   computed.as_mut(),
</span></code></pre></li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>   font_system,
</span></code></pre></li> <li>) {</li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>   Ok(measure) => {
</span></code></pre></li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>       if block.linebreak == LineBreak::NoWrap {
</span></code></pre></li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>           content_size.set(NodeMeasure::Fixed(FixedMeasure { size: measure.max }));
</span></code></pre></li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>       } else {
</span></code></pre></li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>           content_size.set(NodeMeasure::Text(TextMeasure { info: measure }));
</span></code></pre></li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>       }
</span></code></pre></li> <li></li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>       // Text measure func created successfully, so set `TextNodeFlags` to schedule a recompute
</span></code></pre></li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>       text_flags.needs_measure_fn = false;
</span></code></pre></li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>       text_flags.needs_recompute = true;
</span></code></pre></li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>   }
</span></code></pre></li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>   Err(TextError::NoSuchFont) => {
</span></code></pre></li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>       // Try again next frame
</span></code></pre></li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>       text_flags.needs_measure_fn = true;
</span></code></pre></li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>   }
</span></code></pre></li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>   Err(
</span></code></pre></li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>       e @ (TextError::FailedToAddGlyph(_)
</span></code></pre></li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>       | TextError::FailedToGetGlyphImage(_)
</span></code></pre></li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>       | TextError::MissingAtlasLayout
</span></code></pre></li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>       | TextError::MissingAtlasTexture
</span></code></pre></li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>       | TextError::InconsistentAtlasState),
</span></code></pre></li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>   ) => {
</span></code></pre></li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>       panic!("Fatal error when processing text: {e}.");
</span></code></pre></li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>   }
</span></code></pre></li> <li>}; -}</li> <li></li> <p>/// Generates a new [<code>Measure</code>] for a text node on changes to its [<code>Text</code>] component. /// /// A <code>Measure</code> is used by the UI’s layout algorithm to determine the appropriate amount of space @@ -300,98 +251,61 @@ pub fn measure_text_system( mut text_pipeline: ResMut<textpipeline>, mut font_system: ResMut<cosmicfontsystem>, ) { <ul><li>for (entity, block, content_size, text_flags, computed, computed_target, computed_node) in<li><pre style=color:#61676c;background-color:#fafafa><code><span>   &mut text_query
</span></code></pre></ul> <ul><li>for (<li><pre style=color:#61676c;background-color:#fafafa><code><span>   entity,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   block,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   mut content_size,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   mut text_flags,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   mut computed,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   computed_target,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   computed_node,
</span></code></pre><li>) in &mut text_query { // Note: the ComputedTextBlock::needs_rerender bool is cleared in create_text_measure(). // 1e-5 epsilon to ignore tiny scale factor float errors</ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>   if 1e-5
</span></code></pre></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>   if !(1e-5
</span><span>       < (computed_target.scale_factor() - computed_node.inverse_scale_factor.recip()).abs()
</span><span>       || computed.needs_rerender()
</span><span>       || text_flags.needs_measure_fn
</span></code></pre></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>       || content_size.is_added()
</span></code></pre></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>       || content_size.is_added())
</span><span>   {
</span></code></pre></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>       create_text_measure(
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           entity,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           &fonts,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           computed_target.scale_factor.into(),
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           text_reader.iter(entity),
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           block,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           &mut text_pipeline,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           content_size,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           text_flags,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           computed,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           &mut font_system,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       );
</span></code></pre></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>       continue;
</span><span>   }
</span></code></pre></ul> <ul><li>} -}<li></ul> <p>-#[inline] -fn queue_text(</p> <ul><li><p>entity: Entity,</p><li><p>fonts: &Assets<font>, <li><p>text_pipeline: &mut TextPipeline,</p></li> <li><p>font_atlas_set: &mut FontAtlasSet,</p></li> <li><p>texture_atlases: &mut Assets<textureatlaslayout>, <li><p>textures: &mut Assets<image>, <li><p>scale_factor: f32,</p></li> <li><p>inverse_scale_factor: f32,</p></li> <li><p>block: &TextLayout,</p></li> <li><p>node: Ref<computednode>, <li><p>mut text_flags: Mut<textnodeflags>, <li><p>text_layout_info: Mut<textlayoutinfo>, <li><p>computed: &mut ComputedTextBlock,</p></li> <li><p>text_reader: &mut TextUiReader,</p></li> <li><p>font_system: &mut CosmicFontSystem,</p></li> <li><p>swash_cache: &mut SwashCache, -) {</p></li> <li><p>// Skip the text node if it is waiting for a new measure func</p></li> <li><p>if text_flags.needs_measure_fn {</p></li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>   return;
</span></code></pre></li> <li><p>}</p></li> <li><p>let physical_node_size = if block.linebreak == LineBreak::NoWrap {</p></li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>   // With `NoWrap` set, no constraints are placed on the width of the text.
</span></code></pre></li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>   TextBounds::UNBOUNDED
</span></code></pre></li> <li><p>} else {</p></li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>   // `scale_factor` is already multiplied by `UiScale`
</span></code></pre></li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>   TextBounds::new(node.unrounded_size.x, node.unrounded_size.y)
</span></code></pre></li> <li><p>};</p></li> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>   match text_pipeline.create_text_measure(
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       entity,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       fonts.as_ref(),
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       text_reader.iter(entity),
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       computed_target.scale_factor.into(),
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       &block,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       computed.as_mut(),
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       &mut font_system,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   ) {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       Ok(measure) => {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           if block.linebreak == LineBreak::NoWrap {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>               content_size.set(NodeMeasure::Fixed(FixedMeasure { size: measure.max }));
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           } else {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>               content_size.set(NodeMeasure::Text(TextMeasure { info: measure }));
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           }
</span></code></pre></ul> <ul><li>let text_layout_info = text_layout_info.into_inner();<li>match text_pipeline.queue_text(<li><pre style=color:#61676c;background-color:#fafafa><code><span>   text_layout_info,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   fonts,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   text_reader.iter(entity),
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   scale_factor.into(),
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   block,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   physical_node_size,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   font_atlas_set,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   texture_atlases,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   textures,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   computed,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   font_system,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   swash_cache,
</span></code></pre><li>) {<li><pre style=color:#61676c;background-color:#fafafa><code><span>   Err(TextError::NoSuchFont) => {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       // There was an error processing the text layout, try again next frame
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       text_flags.needs_recompute = true;
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   }
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   Err(
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       e @ (TextError::FailedToAddGlyph(_)
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       | TextError::FailedToGetGlyphImage(_)
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       | TextError::MissingAtlasLayout
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       | TextError::MissingAtlasTexture
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       | TextError::InconsistentAtlasState),
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   ) => {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       panic!("Fatal error when processing text: {e}.");
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   }
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   Ok(()) => {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       text_layout_info.scale_factor = scale_factor;
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       text_layout_info.size *= inverse_scale_factor;
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       text_flags.needs_recompute = false;
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   }
</span></code></pre></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>           // Text measure func created successfully, so set `TextNodeFlags` to schedule a recompute
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           text_flags.needs_measure_fn = false;
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           text_flags.needs_recompute = true;
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       }
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       Err(TextError::NoSuchFont) => {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           // Try again next frame
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           text_flags.needs_measure_fn = true;
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       }
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       Err(
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           e @ (TextError::FailedToAddGlyph(_)
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           | TextError::FailedToGetGlyphImage(_)
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           | TextError::MissingAtlasLayout
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           | TextError::MissingAtlasTexture
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           | TextError::InconsistentAtlasState),
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       ) => {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           panic!("Fatal error when processing text: {e}.");
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       }
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   };
</span></code></pre> } }</ul> <p>@@ -421,26 +335,57 @@ pub fn text_system( mut font_system: ResMut<cosmicfontsystem>, mut swash_cache: ResMut<swashcache>, ) { <ul><li>for (entity, node, block, text_layout_info, text_flags, mut computed) in &mut text_query {<li><pre style=color:#61676c;background-color:#fafafa><code><span>   if node.is_changed() || text_flags.needs_recompute {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       queue_text(
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           entity,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           &fonts,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           &mut text_pipeline,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           &mut font_atlas_set,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           &mut texture_atlases,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           &mut textures,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           node.inverse_scale_factor.recip(),
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           node.inverse_scale_factor,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           block,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           node,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           text_flags,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           text_layout_info,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           computed.as_mut(),
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           &mut text_reader,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           &mut font_system,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           &mut swash_cache,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       );
</span></code></pre></ul> <ul><li>for (entity, node, block, text_layout_info, mut text_flags, mut computed) in &mut text_query {<li><pre style=color:#61676c;background-color:#fafafa><code><span>   // Skip the text node if it is waiting for a new measure func
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   if text_flags.needs_measure_fn {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       continue;
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   }
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   if !(node.is_changed() || text_flags.needs_recompute) {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       continue;
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   }
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   let physical_node_size = if block.linebreak == LineBreak::NoWrap {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       // With `NoWrap` set, no constraints are placed on the width of the text.
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       TextBounds::UNBOUNDED
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   } else {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       // `scale_factor` is already multiplied by `UiScale`
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       TextBounds::new(node.unrounded_size.x, node.unrounded_size.y)
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   };
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   let text_layout_info = text_layout_info.into_inner();
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   match text_pipeline.queue_text(
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       text_layout_info,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       &fonts,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       text_reader.iter(entity),
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       node.inverse_scale_factor.recip() as f64,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       block,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       physical_node_size,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       &mut font_atlas_set,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       &mut texture_atlases,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       &mut textures,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       &mut computed,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       &mut font_system,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       &mut swash_cache,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   ) {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       Err(TextError::NoSuchFont) => {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           // There was an error processing the text layout, try again next frame
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           text_flags.needs_recompute = true;
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       }
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       Err(
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           e @ (TextError::FailedToAddGlyph(_)
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           | TextError::FailedToGetGlyphImage(_)
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           | TextError::MissingAtlasLayout
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           | TextError::MissingAtlasTexture
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           | TextError::InconsistentAtlasState),
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       ) => {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           panic!("Fatal error when processing text: {e}.");
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       }
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       Ok(()) => {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           text_layout_info.scale_factor = node.inverse_scale_factor.recip();
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           text_layout_info.size *= node.inverse_scale_factor;
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           text_flags.needs_recompute = false;
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       }
</span><span>   }
</span></code></pre> } }</ul>    <div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_21630.patch id=patch-info style=display:none></div>  <div class=bottom-spacer></div> 