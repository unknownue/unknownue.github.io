<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22105 Make it possible to statically construct gizmo buffers
        
    </title><meta content="#22105 Make it possible to statically construct gizmo buffers" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-14</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22105-zh-cn-20251214>中文</a></div></div><div class=pr-content><h1 id=make-it-possible-to-statically-construct-gizmo-buffers>Make it possible to statically construct gizmo buffers</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Make it possible to statically construct gizmo buffers<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22105<li><strong>Author</strong>: atlv24<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: D-Trivial, S-Ready-For-Final-Review, A-Gizmos<li><strong>Created</strong>: 2025-12-13T09:32:13Z<li><strong>Merged</strong>: 2025-12-14T21:47:22Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>statically construct gizmo buffers for some shenanigans</ul><h2 id=solution>Solution</h2><ul><li>expose a const constructor</ul><h2 id=testing>Testing</h2><ul><li></ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a specific technical limitation in the Bevy engine’s gizmo system. The developer needed to create <code>GizmoBuffer</code> instances at compile time using static/const contexts, but the struct only had a <code>Default</code> implementation that couldn’t be used in const contexts due to its reliance on non-const operations.<p>The problem is straightforward: the <code>GizmoBuffer</code> struct, which stores geometric data for drawing debug visualizations (gizmos), could only be constructed using runtime initialization. This prevented developers from creating pre-initialized buffers in static or const contexts, which are useful for certain optimization patterns and advanced use cases.<p>The solution implements a clean, minimal approach: adding a <code>const fn new()</code> method to <code>GizmoBuffer</code>. This method returns an empty buffer with default settings, specifically setting <code>enabled: true</code> and initializing empty vectors for positions, colors, and indices. The existing <code>Default</code> implementation is then updated to delegate to this new constructor, maintaining consistency while adding the const capability.<p>From an implementation perspective, the changes are intentionally minimal. The new <code>const fn new()</code> method is defined in an <code>impl</code> block for <code>GizmoBuffer&LTConfig, Clear></code>, where both type parameters have appropriate bounds (<code>Config: GizmoConfigGroup</code> and <code>Clear: 'static + Send + Sync</code>). The constructor initializes all fields with their default values in a const-safe manner. Notably, <code>Vec::new()</code> is const in stable Rust, allowing this implementation.<p>The impact of this change is primarily in enabling new use patterns. Developers can now create <code>GizmoBuffer</code> instances in static or const contexts, which can be useful for scenarios where buffers need to be pre-initialized with known data or when working with compile-time evaluated data structures. This aligns with Rust’s growing capabilities around const evaluation and compile-time initialization.<p>One technical consideration is that while the buffer itself can now be statically constructed, the vectors it contains are empty by default. For actual use, data would still need to be added at runtime. However, the ability to have the container itself be const is valuable for certain architectural patterns where the container structure needs to exist at compile time, even if its contents are populated later.<p>The change is backward compatible and doesn’t affect existing code. The <code>Default</code> implementation now uses <code>GizmoBuffer::new()</code> internally, which means existing code using <code>GizmoBuffer::default()</code> or <code>Default::default()</code> will work exactly as before, just with the additional benefit of the new const constructor being available for specialized use cases.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[GizmoBuffer struct] --> B[Default::default() method]
</span><span>    A --> C[new() const constructor]
</span><span>    B --> D[Uses new() internally]
</span><span>    C --> E[Enables static/const construction]
</span><span>    E --> F[Compile-time initialization]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-gizmos-src-gizmos-rs-11-0><code>crates/bevy_gizmos/src/gizmos.rs</code> (+11/-0)</h3><p>This file contains the <code>GizmoBuffer</code> struct definition and its implementations. The change adds a <code>const fn new()</code> constructor and updates the <code>Default</code> implementation to use it.<p><strong>Key modifications:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before the Default implementation existed, but new() didn't exist
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: The Default implementation delegates to new()
</span><span style=color:#fa6e32>impl</span><span>&LTConfig, Clear> Default </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>GizmoBuffer</span><span>&LTConfig, Clear>
</span><span style=color:#fa6e32>where
</span><span>    Config</span><span style=color:#61676ccc>:</span><span> GizmoConfigGroup,
</span><span>    Clear</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>'static</span><span> + Send + Sync,
</span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>default</span><span>() </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>        GizmoBuffer</span><span style=color:#ed9366>::</span><span>new()
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: New const constructor added
</span><span style=color:#fa6e32>impl</span><span>&LTConfig, Clear> </span><span style=color:#399ee6>GizmoBuffer</span><span>&LTConfig, Clear>
</span><span style=color:#fa6e32>where
</span><span>    Config</span><span style=color:#61676ccc>:</span><span> GizmoConfigGroup,
</span><span>    Clear</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>'static</span><span> + Send + Sync,
</span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>/// Constructs an empty `GizmoBuffer`.
</span><span>    </span><span style=color:#fa6e32>pub const fn </span><span style=color:#f29718>new</span><span>() </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>        GizmoBuffer {
</span><span>            enabled</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>true</span><span style=color:#61676ccc>,
</span><span>            list_positions</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Vec</span><span style=color:#ed9366>::</span><span>new()</span><span style=color:#61676ccc>,
</span><span>            list_colors</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Vec</span><span style=color:#ed9366>::</span><span>new()</span><span style=color:#61676ccc>,
</span><span>            list_indices</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Vec</span><span style=color:#ed9366>::</span><span>new()</span><span style=color:#61676ccc>,
</span><span>            strip_positions</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Vec</span><span style=color:#ed9366>::</span><span>new()</span><span style=color:#61676ccc>,
</span><span>            strip_colors</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Vec</span><span style=color:#ed9366>::</span><span>new()</span><span style=color:#61676ccc>,
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre><p>The changes are minimal but significant:<ol><li>The <code>Default</code> implementation now calls <code>GizmoBuffer::new()</code> instead of directly constructing the struct<li>A new <code>const fn new()</code> method is added that creates an empty <code>GizmoBuffer</code> with all vectors initialized to empty <code>Vec::new()</code> instances<li>The <code>const</code> qualifier enables this method to be used in compile-time contexts</ol><h2 id=further-reading>Further Reading</h2><ol><li><strong>Rust Const Functions</strong>: The Rust Reference section on const functions explains what operations are allowed in const contexts: https://doc.rust-lang.org/reference/const_eval.html<li><strong>Bevy Gizmos Documentation</strong>: The Bevy engine’s gizmo system documentation provides context on how gizmo buffers are used: https://docs.rs/bevy_gizmos/latest/bevy_gizmos/<li><strong>Static Initialization Patterns</strong>: For understanding why static/const construction is useful, see Rust patterns around lazy_static, OnceCell, and const initialization: https://doc.rust-lang.org/std/keyword.static.html</ol><h1 id=full-code-diff>Full Code Diff</h1><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_gizmos/src/gizmos.rs b/crates/bevy_gizmos/src/gizmos.rs
</span><span>index 3d666cbbf51fe..074a9232e6b79 100644
</span><span style=color:#c594c5>--- a/crates/bevy_gizmos/src/gizmos.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_gizmos/src/gizmos.rs
</span><span style=color:#c594c5>@@ -308,6 +308,17 @@ </span><span style=color:#399ee6>where
</span><span>     Clear: 'static + Send + Sync,
</span><span> {
</span><span>     fn default() -> Self {
</span><span style=color:#86b300>+        GizmoBuffer::new()
</span><span style=color:#86b300>+    }
</span><span style=color:#86b300>+}
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+impl&LTConfig, Clear> GizmoBuffer&LTConfig, Clear>
</span><span style=color:#86b300>+where
</span><span style=color:#86b300>+    Config: GizmoConfigGroup,
</span><span style=color:#86b300>+    Clear: 'static + Send + Sync,
</span><span style=color:#86b300>+{
</span><span style=color:#86b300>+    /// Constructs an empty `GizmoBuffer`.
</span><span style=color:#86b300>+    pub const fn new() -> Self {
</span><span>         GizmoBuffer {
</span><span>             enabled: true,
</span><span>             list_positions: Vec::new(),
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22105.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>