<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22030 Inline register_type_data to cut down on binary size
        
    </title><meta content="#22030 Inline register_type_data to cut down on binary size" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-05</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22030-zh-cn-20251205>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Inline register_type_data to cut down on binary size<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22030<li><strong>Author</strong>: cart<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Performance, S-Ready-For-Final-Review, A-Reflection<li><strong>Created</strong>: 2025-12-04T22:54:25Z<li><strong>Merged</strong>: 2025-12-05T02:56:08Z<li><strong>Merged By</strong>: cart</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>My [TypeData dependencies]<a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/pull/22016 target=_blank>#22016</a> PR regressed native binary size by ~8mb.<p>(thank you <a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/twitcher/ target=_blank>twitcher</a>)</p><img alt=image height=306 src=https://github.com/user-attachments/assets/e6d86c67-33f6-4280-bee4-49771014b678 width=858><h2 id=solution>Solution</h2><ul><li>Inline <code>register_type_data</code>, which restores the original binary size: <ul><li><code>release breakout</code> before #22016: 127.3mb<li><code>release breakout</code> after #22016: 136.4mb<li><code>release breakout</code> after this PR: 127.4mb</ul></ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a binary size regression introduced by a previous change (#22016). The problem was straightforward: adding TypeData dependencies functionality increased the compiled binary size by approximately 8MB, as measured by the <code>twitcher</code> tool which tracks Bevy’s binary size changes.<p>The core issue was that the <code>register_type_data</code> function in the reflection system wasn’t being inlined by the compiler. When this function is called repeatedly during type registration, each call site generates separate machine code for the function body. For a system like Bevy’s reflection that registers many types at startup, this code duplication accumulates and significantly increases binary size.<p>The solution was simple and effective: add the <code>#[inline]</code> attribute to the <code>register_type_data</code> function. This attribute tells the Rust compiler to inline the function body at each call site. While inlining typically increases binary size by duplicating code, in this specific case it actually reduces overall size. The reason is that the function is generic over two type parameters (<code>T</code> and <code>V</code>), and without inlining, the compiler generates a separate copy of the function for each combination of type parameters used throughout the codebase. By marking it as inline, the compiler can perform better cross-call-site optimizations and potentially eliminate redundant code generation.<p>The implementation change is minimal but impactful:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>inline</span><span>]
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>register_type_data</span><span>&LTT</span><span style=color:#61676ccc>:</span><span> TypeData </span><span style=color:#ed9366>+ </span><span>FromType&LTV>, V>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>) {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(T</span><span style=color:#ed9366>::</span><span>from_type())</span><span style=color:#61676ccc>;
</span><span>    T</span><span style=color:#ed9366>::</span><span>insert_dependencies(</span><span style=color:#55b4d4;font-style:italic>self</span><span>)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>The <code>#[inline]</code> attribute is a hint to the compiler, not a command. The compiler may choose to ignore it, but in practice, for small functions like this one (just two method calls), compilers typically respect the hint. The function’s two operations are straightforward: it creates a TypeData instance using <code>T::from_type()</code> and inserts it, then calls <code>T::insert_dependencies(self)</code> to handle any dependent type data registrations.<p>From an architectural perspective, this change doesn’t affect the reflection system’s behavior or API. It’s purely an optimization that reduces binary bloat. The TypeData system allows types to register additional metadata, and this function is a core part of that registration process. By optimizing its code generation, we minimize the overhead of Bevy’s reflection system without changing its functionality.<p>The performance impact is clear from the measurements: the binary size for the <code>release breakout</code> example dropped from 136.4MB back down to 127.4MB, essentially returning to the pre-regression size of 127.3MB. This 8MB reduction represents about 6.6% of the total binary size, a significant improvement for a one-line change.<p>This PR demonstrates an important optimization technique: sometimes adding <code>#[inline]</code> to small, frequently-called generic functions can reduce binary size by allowing the compiler to better optimize across call sites. It also shows the value of continuous binary size monitoring in projects like Bevy, where even seemingly minor changes can have noticeable impacts on distribution size.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Type Registration System] --> B[register_type_data function]
</span><span>    B --> C[Without #[inline]]
</span><span>    B --> D[With #[inline]]
</span><span>    C --> E[Multiple copies generated]
</span><span>    D --> F[Inlined at call sites]
</span><span>    E --> G[Larger binary size: 136.4MB]
</span><span>    F --> H[Smaller binary size: 127.4MB]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-reflect-src-type-registry-rs-1-0><code>crates/bevy_reflect/src/type_registry.rs</code> (+1/-0)</h3><p>This file contains the core type registration system for Bevy’s reflection. The change adds the <code>#[inline]</code> attribute to the <code>register_type_data</code> method.<p><strong>Key Modification:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>register_type_data</span><span>&LTT</span><span style=color:#61676ccc>:</span><span> TypeData </span><span style=color:#ed9366>+ </span><span>FromType&LTV>, V>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>) {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(T</span><span style=color:#ed9366>::</span><span>from_type())</span><span style=color:#61676ccc>;
</span><span>    T</span><span style=color:#ed9366>::</span><span>insert_dependencies(</span><span style=color:#55b4d4;font-style:italic>self</span><span>)</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>inline</span><span>]
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>register_type_data</span><span>&LTT</span><span style=color:#61676ccc>:</span><span> TypeData </span><span style=color:#ed9366>+ </span><span>FromType&LTV>, V>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>) {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(T</span><span style=color:#ed9366>::</span><span>from_type())</span><span style=color:#61676ccc>;
</span><span>    T</span><span style=color:#ed9366>::</span><span>insert_dependencies(</span><span style=color:#55b4d4;font-style:italic>self</span><span>)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>The method signature and implementation remain unchanged. Only the <code>#[inline]</code> attribute is added. This method is part of the <code>TypeRegistration</code> struct’s implementation and is used during type registration to insert type-specific data and its dependencies into the registry.<p>The change relates directly to the PR’s purpose by optimizing code generation for this frequently-called method, reducing binary size without altering functionality.<h2 id=further-reading>Further Reading</h2><ol><li><strong>Rust Inlining Documentation</strong>: The Rust Reference section on inline attributes provides detailed information about when and how to use <code>#[inline]</code> effectively.<li><strong>Bevy Reflection System</strong>: Understanding Bevy’s reflection system helps contextualize why this function is called so frequently during type registration.<li><strong>Compiler Optimization Techniques</strong>: Resources on cross-call-site optimization and code duplication trade-offs in compiled languages.<li><strong>Binary Size Optimization</strong>: General techniques for reducing binary size in Rust applications, including profile-guided optimization and link-time optimization.<li><strong>Previous PR #22016</strong>: The TypeData dependencies PR that introduced the binary size regression, providing context for why this optimization was necessary.</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22030.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>