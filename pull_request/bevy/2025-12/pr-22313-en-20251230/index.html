<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22313 Specular GI MIS
        
    </title><meta content="#22313 Specular GI MIS" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-30</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22313-zh-cn-20251230>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=specular-gi-mis>Specular GI MIS</h2><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Specular GI MIS<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22313<li><strong>Author</strong>: SparkyPotato<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, S-Ready-For-Review, C-Refinement<li><strong>Created</strong>: 2025-12-30T02:31:52Z<li><strong>Merged</strong>: 2025-12-30T21:18:41Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>ReSTIR DI (and other DI algorithms) can’t find light samples that align well with very smooth, specular surfaces. However, specular GI does a trace for these surfaces, which we can use to improve DI.<p>This PR uses the specular GI trace to light the specular lobe for smooth surfaces, disabling DI on the specular lobe for them.<p>This PR: <img alt=image height=1032 src=https://github.com/user-attachments/assets/d7768779-6a57-4226-8d36-eefaf2a27df1 width=1920><p>Previously: <img alt=image height=1032 src=https://github.com/user-attachments/assets/5b408160-a384-4f4b-8ae4-3c89812f75d3 width=1920><p>Reference: <img alt=image height=1032 src=https://github.com/user-attachments/assets/089fdec5-17a4-4277-87b2-dd6d271ba1f6 width=1920><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a fundamental limitation in the Bevy Solari real-time rendering system: ReSTIR DI (Reservoir-based Spatiotemporal Importance Resampling Direct Illumination) struggles with specular surfaces, particularly smooth ones with low roughness. The core issue is that direct illumination algorithms like ReSTIR DI rely on sampling light sources, but for highly specular surfaces, the BRDF lobe is extremely narrow. Finding light samples that align with this narrow lobe through random sampling is statistically unlikely, leading to noisy or missing specular highlights.<p>The developer recognized that while ReSTIR DI has this limitation, the specular GI (Global Illumination) system already performs ray tracing for these surfaces. This presents an opportunity: use the specular GI trace to illuminate the specular lobe for smooth surfaces, effectively bypassing ReSTIR DI’s weakness for this specific case.<p>The implementation follows a clear engineering approach. First, a roughness threshold is established (0.15² = 0.0225) to identify “smooth” surfaces. When a surface’s roughness is below this threshold, the ReSTIR DI shader is modified to only evaluate the diffuse BRDF component, ignoring the specular lobe entirely. This prevents ReSTIR DI from attempting to handle specular reflections for surfaces where it performs poorly.<p>Simultaneously, the specular GI system is enhanced to properly handle this division of labor. The key technical challenge here is Multiple Importance Sampling (MIS) weight adjustment. The system needs to ensure that when specular GI handles the first bounce for smooth surfaces, it takes full responsibility (weight = 1.0), and when ReSTIR DI handles it (for rougher surfaces), specular GI doesn’t contribute to avoid double-counting.<p>The implementation modifies the <code>emissive_mis_weight</code> function in the specular GI shader to check whether this is the first bounce and whether the surface roughness is below the threshold. For the first bounce on smooth surfaces, it returns a weight of 1.0, giving specular GI full responsibility. For the first bounce on rougher surfaces, it returns 0.0, letting ReSTIR DI handle it exclusively. This ensures proper energy conservation and prevents artifacts from overlapping contributions.<p>The changes are minimal and surgical: three files modified with relatively small diffs. The developer also changed the <code>specular_gi.wgsl</code> shader from an embedded asset to a shader library import, which is a minor refactoring that makes the shader constants available to other shaders via the <code>#import</code> system. This is necessary because the <code>restir_di.wgsl</code> shader now needs to access the <code>SPECULAR_GI_FOR_DI_ROUGHNESS_THRESHOLD</code> constant defined in the specular GI shader.<p>From an architectural perspective, this PR demonstrates good separation of concerns. The ReSTIR DI system focuses on what it does well (direct illumination for diffuse and moderately rough surfaces) while delegating the challenging case of smooth specular surfaces to the specular GI system. The MIS weight adjustments ensure the two systems work together coherently without overlap or gaps in coverage.<p>The visual results speak for themselves. The comparison images show that previously, specular highlights on smooth surfaces were noisy and poorly reconstructed by ReSTIR DI alone. With this change, the specular highlights are clean and accurate, closely matching the reference image. This improvement comes with minimal performance overhead since specular GI was already tracing rays for these surfaces; the change simply ensures those traces are properly utilized for direct illumination on smooth surfaces.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Rendering Pipeline] --> B{Surface Roughness}
</span><span>    B -->|≤ 0.0225| C[Specular GI handles specular lobe]
</span><span>    B -->|> 0.0225| D[ReSTIR DI handles both lobes]
</span><span>    C --> E[Clean specular highlights]
</span><span>    D --> F[Standard DI for both lobes]
</span><span>    
</span><span>    subgraph "MIS Weight Adjustment"
</span><span>        G[First bounce?] --> H{Smooth surface?}
</span><span>        H -->|Yes| I[Weight = 1.0]
</span><span>        H -->|No| J[Weight = 0.0]
</span><span>    end
</span><span>    
</span><span>    C -.-> G
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=1-crates-bevy-solari-src-realtime-mod-rs>1. <code>crates/bevy_solari/src/realtime/mod.rs</code></h3><p><strong>Change</strong>: Changed <code>specular_gi.wgsl</code> from <code>embedded_asset!</code> to <code>load_shader_library!</code> <strong>Why</strong>: This allows the specular GI shader to be imported by other shaders, specifically so <code>restir_di.wgsl</code> can access the <code>SPECULAR_GI_FOR_DI_ROUGHNESS_THRESHOLD</code> constant.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#f07171>embedded_asset!</span><span>(app</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"specular_gi.wgsl"</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#f07171>load_shader_library!</span><span>(app</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"specular_gi.wgsl"</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=2-crates-bevy-solari-src-realtime-restir-di-wgsl>2. <code>crates/bevy_solari/src/realtime/restir_di.wgsl</code></h3><p><strong>Change</strong>: Modified BRDF evaluation to use only diffuse component for smooth surfaces <strong>Why</strong>: Prevents ReSTIR DI from trying to handle specular reflections on surfaces where it performs poorly, delegating that work to specular GI.<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>let brdf = evaluate_brdf(surface.world_normal, wo, merge_result.wi, surface.material);
</span><span>
</span><span>// After:
</span><span>var brdf: vec3&LTf32>;
</span><span>// If the surface is very smooth, let specular GI handle the specular lobe
</span><span>if surface.material.roughness <= SPECULAR_GI_FOR_DI_ROUGHNESS_THRESHOLD {
</span><span>    brdf = evaluate_diffuse_brdf(surface.material.base_color, surface.material.metallic);
</span><span>} else {
</span><span>    brdf = evaluate_brdf(surface.world_normal, wo, merge_result.wi, surface.material);
</span><span>}
</span></code></pre><h3 id=3-crates-bevy-solari-src-realtime-specular-gi-wgsl>3. <code>crates/bevy_solari/src/realtime/specular_gi.wgsl</code></h3><p><strong>Changes</strong>:<ol><li>Added import path and exported roughness threshold constant<li>Modified <code>trace_glossy_path</code> to accept initial roughness parameter<li>Updated <code>emissive_mis_weight</code> to handle first bounce MIS weights correctly</ol><p><strong>Why</strong>: These changes enable the specular GI system to properly handle the specular lobe for smooth surfaces with correct MIS weighting.<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Added at top:
</span><span>#define_import_path bevy_solari::specular_gi
</span><span>const SPECULAR_GI_FOR_DI_ROUGHNESS_THRESHOLD: f32 = 0.0225;
</span><span>
</span><span>// Modified function signature:
</span><span>// Before:
</span><span>fn trace_glossy_path(initial_ray_origin: vec3&LTf32>, initial_wi: vec3&LTf32>, initial_p_bounce: f32, a0: f32, rng: ptr&LTfunction, u32>) -> vec3&LTf32>
</span><span>
</span><span>// After:
</span><span>fn trace_glossy_path(initial_ray_origin: vec3&LTf32>, initial_wi: vec3&LTf32>, initial_roughness: f32, initial_p_bounce: f32, a0: f32, rng: ptr&LTfunction, u32>) -> vec3&LTf32>
</span><span>
</span><span>// Updated MIS weight function:
</span><span>// Before:
</span><span>fn emissive_mis_weight(p_bounce: f32, ray_hit: ResolvedRayHitFull, previous_surface_perfectly_specular: bool) -> f32 {
</span><span>    if previous_surface_perfectly_specular { return 1.0; }
</span><span>    let p_light = random_emissive_light_pdf(ray_hit);
</span><span>    return power_heuristic(p_bounce, p_light);
</span><span>}
</span><span>
</span><span>// After:
</span><span>fn emissive_mis_weight(i: u32, initial_roughness: f32, p_bounce: f32, ray_hit: ResolvedRayHitFull, previous_surface_perfectly_specular: bool) -> f32 {
</span><span>    if i != 0u {
</span><span>        if previous_surface_perfectly_specular { return 1.0; }
</span><span>        let p_light = random_emissive_light_pdf(ray_hit);
</span><span>        return power_heuristic(p_bounce, p_light);
</span><span>    } else {
</span><span>        // The first bounce gets MIS weight 0.0 or 1.0 depending on if ReSTIR DI shaded using the specular lobe or not
</span><span>        if initial_roughness <= SPECULAR_GI_FOR_DI_ROUGHNESS_THRESHOLD {
</span><span>            return 1.0;
</span><span>        } else {
</span><span>            return 0.0;
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><strong>ReSTIR DI Paper</strong>: “Spatiotemporal reservoir resampling for real-time ray tracing with dynamic direct lighting” - Explains the core algorithm that this PR works with<li><strong>Multiple Importance Sampling</strong>: Chapter 9 of “Physically Based Rendering: From Theory to Implementation” - Covers the MIS theory used in this PR<li><strong>Bevy Solari Documentation</strong>: The real-time global illumination system in Bevy that this PR modifies<li><strong>BRDF Theory</strong>: Understanding the Cook-Torrance BRDF model helps explain why smooth specular surfaces are challenging for direct illumination algorithms</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22313.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>