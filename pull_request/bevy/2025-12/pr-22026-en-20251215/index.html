<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22026 Replace path canonicalize with our own version.
        
    </title><meta content="#22026 Replace path canonicalize with our own version." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-15</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22026-zh-cn-20251215>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Replace path canonicalize with our own version.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22026<li><strong>Author</strong>: andriyDev<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Assets, S-Ready-For-Final-Review, D-Straightforward<li><strong>Created</strong>: 2025-12-04T05:47:53Z<li><strong>Merged</strong>: 2025-12-14T22:32:54Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Renaming a file does not send a rename event to the asset system, meaning that renamed files are not detected!<li>In #18023 we canonicalized the file path to work with asset folder paths that were relative. However <code>canonicalize</code> only works if the path actually exists! During a rename the old path no longer exists, so <code>canonicalize</code> fails and so we just silently <code>continue</code>.</ul><h2 id=solution>Solution</h2><ul><li>Instead of using <code>canonicalize</code>, we write our own implementation using the <code>std::path::absolute</code> which uses the environment’s current directory to create an absolute path (but doesn’t collapse <code>..</code>), and then use our <code>normalize_path</code> to collapse <code>..</code> into a “canonical path”. <ul><li>The advantage is that this doesn’t interact with the filesystem at all, so <strong>any</strong> path will be able to be resolved - including the file that was renamed (even thought that file path no longer exists).<li>The disadvantage is that this no longer resolves symbolic links - I don’t see this as a big problem since I doubt our behavior makes sense in that case (a sym link will probably just send us out of the assets dir and give us a file path we won’t know how to deal with).</ul></ul><h2 id=testing>Testing</h2><ul><li>I ran the <code>asset_processing</code> example. I made sure that renaming an asset or directory resulted in a rename event.<li>I also tried changing the <code>asset_processing</code> example to use a relative path like #18022. Changes were correctly detected!<li>I also checked that the embedded_watcher feature still works by making sure that one of our embedded shaders were hot-reloaded.</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a critical bug in Bevy’s asset watcher where file rename operations were not being detected. The issue stemmed from how the asset system handles paths during file system events.<p>The problem occurred when the asset watcher tried to process rename events. When a file is renamed, the operating system sends two pieces of information: the old path (which no longer exists) and the new path. In the previous implementation, the code attempted to canonicalize these paths using Rust’s <code>std::fs::canonicalize()</code> method. However, <code>canonicalize()</code> has a significant limitation: it requires the path to actually exist on the filesystem. During a rename operation, the old path doesn’t exist anymore, causing <code>canonicalize()</code> to fail. When this happened, the code would silently continue, effectively dropping the rename event and preventing the asset system from noticing the change.<p>This bug was particularly problematic for developers using hot reloading during development, as renaming assets is a common operation that should trigger asset updates. The issue was introduced in PR #18023, which added canonicalization to handle relative paths in asset folders, but didn’t account for the filesystem dependency of canonicalization.<p>The solution implemented here replaces the filesystem-dependent <code>canonicalize()</code> with a purely computational approach. The new <code>make_absolute_path()</code> function combines two operations: first, it uses <code>std::path::absolute()</code> to convert a path to an absolute form using the current working directory, then it applies Bevy’s existing <code>normalize_path()</code> function to collapse <code>..</code> components. This approach has several advantages:<ol><li><strong>No filesystem interaction</strong>: Since <code>std::path::absolute()</code> doesn’t check if paths exist, it can process paths that refer to files that have been renamed or deleted.<li><strong>Consistent behavior</strong>: The normalization is now purely computational and deterministic, not dependent on the current state of the filesystem.<li><strong>Preserves existing functionality</strong>: The <code>normalize_path()</code> function already handles the path normalization needs, so this is a natural extension of existing infrastructure.</ol><p>There’s one trade-off: this approach no longer resolves symbolic links. The PR author correctly notes that this is acceptable because symbolic links in asset directories would likely cause more problems than they solve. When a symbolic link points outside the asset directory, the asset system wouldn’t know how to handle it properly anyway.<p>The implementation required changes in two key areas. First, the <code>FileWatcher::new()</code> method now uses <code>make_absolute_path()</code> instead of <code>normalize_path().canonicalize()</code>. Second, the event processing logic in <code>new_asset_event_debouncer()</code> was updated to convert all event paths to absolute paths at the start of processing, avoiding repeated filesystem calls and ensuring consistent handling.<p>This change demonstrates an important principle in systems programming: when dealing with filesystem events, you often need to handle paths that refer to non-existent files. The previous implementation assumed all paths would exist, which is a common but incorrect assumption when processing filesystem events that describe state changes.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[File System Events] --> B[Asset Watcher]
</span><span>    B --> C[Path Processing]
</span><span>    C --> D{Path exists on filesystem?}
</span><span>    D -->|Yes| E[Old: canonicalize() works]
</span><span>    D -->|No (e.g., renamed files)| F[New: make_absolute_path() works]
</span><span>    E --> G[Process event]
</span><span>    F --> G
</span><span>    G --> H[Asset System Updates]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-asset-src-io-file-file-watcher-rs-52-55><code>crates/bevy_asset/src/io/file/file_watcher.rs</code> (+52/-55)</h3><p>This file contains the core changes to fix the asset watcher bug. The main modifications include:<ol><li><p><strong>Added <code>make_absolute_path()</code> function</strong>: A new helper function that replaces <code>canonicalize()</code> with a filesystem-independent approach.</p><li><p><strong>Updated <code>FileWatcher::new()</code></strong>: Changed from using <code>normalize_path().canonicalize()</code> to the new <code>make_absolute_path()</code>.</p><li><p><strong>Refactored event processing</strong>: Updated <code>new_asset_event_debouncer()</code> to pre-process all event paths to absolute form at the start of event handling.</p></ol><p>Key code changes:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Using canonicalize() which requires paths to exist
</span><span style=color:#fa6e32>let</span><span> root </span><span style=color:#ed9366>= </span><span style=color:#f07171>normalize_path</span><span>(</span><span style=color:#ed9366>&</span><span>path)</span><span style=color:#ed9366>.</span><span style=color:#f07171>canonicalize</span><span>()</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Using make_absolute_path() which works for non-existent paths
</span><span style=color:#fa6e32>let</span><span> root </span><span style=color:#ed9366>= </span><span style=color:#f07171>make_absolute_path</span><span>(</span><span style=color:#ed9366>&</span><span>path)</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span></code></pre><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// New function: makes paths absolute without filesystem interaction
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>make_absolute_path</span><span>(</span><span style=color:#ff8f40>path</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>Path) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span>&LTPathBuf, std</span><span style=color:#ed9366>::</span><span>io</span><span style=color:#ed9366>::</span><span>Error> {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// We use `normalize` + `absolute` instead of `canonicalize` to avoid reading the filesystem to
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// resolve the path. This also means that paths that no longer exist can still become absolute
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// (e.g., a file that was renamed will have the "old" path no longer exist).
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(</span><span style=color:#f07171>normalize_path</span><span>(</span><span style=color:#ed9366>&</span><span>std</span><span style=color:#ed9366>::</span><span>path</span><span style=color:#ed9366>::</span><span>absolute(path)</span><span style=color:#ed9366>?</span><span>))
</span><span>}
</span></code></pre><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Event processing: paths are made absolute early in the pipeline
</span><span style=color:#fa6e32>let</span><span> paths </span><span style=color:#ed9366>=</span><span> event
</span><span>    </span><span style=color:#ed9366>.</span><span>paths
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(PathBuf</span><span style=color:#ed9366>::</span><span>as_path)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|</span><span style=color:#ff8f40>p</span><span>| {
</span><span>        </span><span style=color:#f07171>make_absolute_path</span><span>(p)</span><span style=color:#ed9366>.</span><span style=color:#f07171>expect</span><span>(</span><span style=color:#86b300>"paths from the debouncer are valid"</span><span>)
</span><span>    })
</span><span>    </span><span style=color:#ed9366>.</span><span>collect</span><span style=color:#ed9366>::</span><span><</span><span style=color:#55b4d4;font-style:italic>Vec</span><span><</span><span style=color:#ed9366>_</span><span>>>()</span><span style=color:#61676ccc>;
</span></code></pre><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// FileEventHandler::get_path no longer tries to canonicalize
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>get_path</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>absolute_path</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>Path) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Option</span><span><(PathBuf, </span><span style=color:#fa6e32>bool</span><span>)> {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Before: absolute_path.canonicalize().ok()?;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// After: Direct use of the already absolute path
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#f07171>get_asset_path</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>root</span><span style=color:#61676ccc>,</span><span> absolute_path))
</span><span>}
</span></code></pre><p>These changes ensure that rename events are properly detected and processed, fixing the original bug while maintaining support for relative paths.<h2 id=further-reading>Further Reading</h2><ol><li><strong>Rust Standard Library Path Documentation</strong>: The <code>std::path</code> module documentation explains the difference between <code>absolute()</code>, <code>canonicalize()</code>, and other path operations.<li><strong>Bevy Asset System Documentation</strong>: Understanding how Bevy’s asset system works with filesystem events and hot reloading.<li><strong>notify crate</strong>: The underlying filesystem notification library used by Bevy, which provides the raw events that this PR processes.<li><strong>PR #18023</strong>: The original PR that introduced canonicalization, providing context for why this change was initially made.<li><strong>Filesystem Event Handling Patterns</strong>: General patterns for handling filesystem events in long-running applications, particularly around edge cases like renames and deletions.</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22026.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>