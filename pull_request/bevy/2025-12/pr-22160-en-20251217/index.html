<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22160 Avoid panicking in unapproved path tests.
        
    </title><meta content="#22160 Avoid panicking in unapproved path tests." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-17</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22160-zh-cn-20251217>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Avoid panicking in unapproved path tests.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22160<li><strong>Author</strong>: andriyDev<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: D-Trivial, A-Assets, S-Ready-For-Final-Review, C-Testing<li><strong>Created</strong>: 2025-12-17T06:50:52Z<li><strong>Merged</strong>: 2025-12-17T19:21:23Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Simplify some tests.</ul><h2 id=solution>Solution</h2><ul><li>Instead of adding systems to an app that conditionally panic, we just access the <code>AssetServer</code> directly in the test and do the loads there.<li>I also added asserts that the assets do actually load eventually.</ul><h2 id=testing>Testing</h2><ul><li>Ran the tests and it works!</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This pull request refactors test code in the Bevy asset system to improve clarity and reliability. The changes focus on tests for unapproved path handling - a security feature in Bevy that controls whether assets can be loaded from paths outside approved directories.<p>The original tests used a pattern where systems were added to the app that would panic if certain conditions weren’t met. Specifically, the tests checked whether assets could be loaded from unapproved paths under different security modes (<code>Forbid</code>, <code>Deny</code>, and <code>Allow</code>). These tests used <code>#[should_panic]</code> annotations and conditional panics within systems to verify the expected behavior.<p>The problem with this approach is that it makes tests more complex than necessary. Tests that rely on panics can be brittle and harder to debug because they don’t provide clear assertion failures. When a panic-based test fails, you get a panic message rather than a descriptive assertion about what went wrong.<p>The solution implemented here simplifies the test structure by directly accessing the <code>AssetServer</code> resource and making assertions on the results. Instead of setting up systems that run in the app’s update schedule, the tests now directly call <code>load()</code> or <code>load_override()</code> on the asset server and check the returned handles. This approach is more direct and easier to understand.<p>Here’s an example of how the tests changed. Previously, for testing the <code>Deny</code> mode, the test looked like this:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>should_panic</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>unapproved_path_deny_should_panic</span><span>() {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> app </span><span style=color:#ed9366>= </span><span style=color:#f07171>unapproved_path_setup</span><span>(UnapprovedPathMode</span><span style=color:#ed9366>::</span><span>Deny)</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>uses_assets</span><span>(</span><span style=color:#ff8f40>_asset</span><span style=color:#61676ccc>: </span><span>ResMut&LTAssets&LTCoolText>>) {}
</span><span>    app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(Update</span><span style=color:#61676ccc>, </span><span>(uses_assets</span><span style=color:#61676ccc>,</span><span> load_a_asset))</span><span style=color:#61676ccc>;
</span><span>
</span><span>    app</span><span style=color:#ed9366>.</span><span style=color:#f07171>world_mut</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>run_schedule</span><span>(Update)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>Now, it’s much simpler and more explicit:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>unapproved_path_deny_does_not_load</span><span>() {
</span><span>    </span><span style=color:#fa6e32>let</span><span> app </span><span style=color:#ed9366>= </span><span style=color:#f07171>unapproved_path_setup</span><span>(UnapprovedPathMode</span><span style=color:#ed9366>::</span><span>Deny)</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#fa6e32>let</span><span> asset_server </span><span style=color:#ed9366>=</span><span> app</span><span style=color:#ed9366>.</span><span style=color:#f07171>world</span><span>()</span><span style=color:#ed9366>.</span><span>resource</span><span style=color:#ed9366>::</span><span>&LTAssetServer>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#f07171>assert_eq!</span><span>(
</span><span>        asset_server</span><span style=color:#ed9366>.</span><span>load</span><span style=color:#ed9366>::</span><span>&LTCoolText>(</span><span style=color:#86b300>"../a.cool.ron"</span><span>)</span><span style=color:#61676ccc>,
</span><span>        Handle</span><span style=color:#ed9366>::</span><span>default()
</span><span>    )</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>The new version directly asserts that loading an unapproved path in <code>Deny</code> mode returns a default handle, which indicates the load was rejected. This is clearer than the previous approach where you had to infer that a panic meant the load was rejected.<p>Another important improvement is the addition of assertions that assets actually load when they’re expected to. The tests for <code>Deny</code> mode with override and <code>Allow</code> mode now include checks that the assets eventually load using <code>run_app_until()</code>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Make sure this asset actually loads.
</span><span style=color:#f07171>run_app_until</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> app</span><span style=color:#61676ccc>, </span><span>|_| asset_server</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_loaded</span><span>(</span><span style=color:#ed9366>&</span><span>handle)</span><span style=color:#ed9366>.</span><span style=color:#f07171>then_some</span><span>(()))</span><span style=color:#61676ccc>;
</span></code></pre><p>This ensures the tests verify not just that a non-default handle is returned, but that the asset loading process completes successfully.<p>The refactoring also fixed a bug in the test setup. The original <code>unapproved_path_setup</code> function initialized the <code>CoolText</code> asset but didn’t register the <code>CoolTextLoader</code>. The new version adds this registration:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>app</span><span style=color:#ed9366>.</span><span>init_asset</span><span style=color:#ed9366>::</span><span>&LTCoolText>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>register_asset_loader</span><span>(CoolTextLoader)</span><span style=color:#61676ccc>;
</span></code></pre><p>This is necessary for the asset loading to work properly in tests.<p>From an engineering perspective, this change demonstrates good testing practices: tests should be simple, direct, and focused on specific behaviors. Avoiding indirection through systems and panics makes tests more maintainable and their failure messages more informative. The use of direct resource access and clear assertions improves test readability and debuggability.<p>The change also shows how Bevy’s ECS architecture enables clean separation between test setup and test logic. By extracting the <code>AssetServer</code> from the app’s world, tests can interact with it directly without needing to set up complex system schedules.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Test Function] --> B[Setup App with UnapprovedPathMode]
</span><span>    B --> C{Direct AssetServer Access}
</span><span>    C --> D[Assert Load Results]
</span><span>    C --> E[Verify Asset Loading Completion]
</span><span>    
</span><span>    subgraph "Modes Tested"
</span><span>        F[Forbid Mode]
</span><span>        G[Deny Mode]
</span><span>        H[Allow Mode]
</span><span>    end
</span><span>    
</span><span>    D --> F
</span><span>    D --> G
</span><span>    D --> H
</span><span>    E --> G
</span><span>    E --> H
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-asset-src-lib-rs-28-37><code>crates/bevy_asset/src/lib.rs</code> (+28/-37)</h3><p>This file contains the test module for the asset system. The changes refactor tests related to unapproved path handling to be simpler and more direct.<p><strong>Key modifications:</strong><ol><li><strong>Removed helper systems</strong>: The <code>load_a_asset</code> and <code>load_a_asset_override</code> helper systems were removed since tests now directly access the <code>AssetServer</code>.</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before (removed):
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>load_a_asset</span><span>(</span><span style=color:#ff8f40>assets</span><span style=color:#61676ccc>: </span><span>Res&LTAssetServer>) {
</span><span>    </span><span style=color:#fa6e32>let</span><span> a </span><span style=color:#ed9366>=</span><span> assets</span><span style=color:#ed9366>.</span><span>load</span><span style=color:#ed9366>::</span><span>&LTCoolText>(</span><span style=color:#86b300>"../a.cool.ron"</span><span>)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>if</span><span> a </span><span style=color:#ed9366>== </span><span>Handle</span><span style=color:#ed9366>::</span><span>default() {
</span><span>        </span><span style=color:#f07171>panic!</span><span>()
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>load_a_asset_override</span><span>(</span><span style=color:#ff8f40>assets</span><span style=color:#61676ccc>: </span><span>Res&LTAssetServer>) {
</span><span>    </span><span style=color:#fa6e32>let</span><span> a </span><span style=color:#ed9366>=</span><span> assets</span><span style=color:#ed9366>.</span><span>load_override</span><span style=color:#ed9366>::</span><span>&LTCoolText>(</span><span style=color:#86b300>"../a.cool.ron"</span><span>)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>if</span><span> a </span><span style=color:#ed9366>== </span><span>Handle</span><span style=color:#ed9366>::</span><span>default() {
</span><span>        </span><span style=color:#f07171>panic!</span><span>()
</span><span>    }
</span><span>}
</span></code></pre><ol start=2><li><strong>Simplified test functions</strong>: Tests now directly access the <code>AssetServer</code> resource and make assertions instead of relying on panics.</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>should_panic</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>unapproved_path_forbid_should_panic</span><span>() {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> app </span><span style=color:#ed9366>= </span><span style=color:#f07171>unapproved_path_setup</span><span>(UnapprovedPathMode</span><span style=color:#ed9366>::</span><span>Forbid)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>uses_assets</span><span>(</span><span style=color:#ff8f40>_asset</span><span style=color:#61676ccc>: </span><span>ResMut&LTAssets&LTCoolText>>) {}
</span><span>    app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(Update</span><span style=color:#61676ccc>, </span><span>(uses_assets</span><span style=color:#61676ccc>,</span><span> load_a_asset_override))</span><span style=color:#61676ccc>;
</span><span>    app</span><span style=color:#ed9366>.</span><span style=color:#f07171>world_mut</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>run_schedule</span><span>(Update)</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>unapproved_path_forbid_does_not_load_even_with_override</span><span>() {
</span><span>    </span><span style=color:#fa6e32>let</span><span> app </span><span style=color:#ed9366>= </span><span style=color:#f07171>unapproved_path_setup</span><span>(UnapprovedPathMode</span><span style=color:#ed9366>::</span><span>Forbid)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> asset_server </span><span style=color:#ed9366>=</span><span> app</span><span style=color:#ed9366>.</span><span style=color:#f07171>world</span><span>()</span><span style=color:#ed9366>.</span><span>resource</span><span style=color:#ed9366>::</span><span>&LTAssetServer>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#f07171>assert_eq!</span><span>(
</span><span>        asset_server</span><span style=color:#ed9366>.</span><span>load_override</span><span style=color:#ed9366>::</span><span>&LTCoolText>(</span><span style=color:#86b300>"../a.cool.ron"</span><span>)</span><span style=color:#61676ccc>,
</span><span>        Handle</span><span style=color:#ed9366>::</span><span>default()
</span><span>    )</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><ol start=3><li><strong>Added asset loading verification</strong>: Tests that expect assets to load now verify the loading completes.</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added to tests that should successfully load assets:
</span><span style=color:#abb0b6;font-style:italic>// Make sure this asset actually loads.
</span><span style=color:#f07171>run_app_until</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> app</span><span style=color:#61676ccc>, </span><span>|_| asset_server</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_loaded</span><span>(</span><span style=color:#ed9366>&</span><span>handle)</span><span style=color:#ed9366>.</span><span style=color:#f07171>then_some</span><span>(()))</span><span style=color:#61676ccc>;
</span></code></pre><ol start=4><li><strong>Fixed test setup</strong>: Added missing asset loader registration.</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>app</span><span style=color:#ed9366>.</span><span>init_asset</span><span style=color:#ed9366>::</span><span>&LTCoolText>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>app</span><span style=color:#ed9366>.</span><span>init_asset</span><span style=color:#ed9366>::</span><span>&LTCoolText>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>register_asset_loader</span><span>(CoolTextLoader)</span><span style=color:#61676ccc>;
</span></code></pre><p>These changes relate to the overall purpose of the PR by making tests simpler, more direct, and more reliable. The removal of panic-based testing in favor of direct assertions improves test clarity and maintainability.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_asset/latest/bevy_asset/ target=_blank>Bevy Asset System Documentation</a> - Official documentation for Bevy’s asset system<li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/book/ch11-01-writing-tests.html target=_blank>Rust Testing Guide</a> - Best practices for writing tests in Rust<li><a rel="noopener nofollow noreferrer" href=https://proptest-rs.github.io/proptest/intro.html target=_blank>Property-based Testing</a> - An alternative testing approach that can complement unit tests<li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/testing/test-app.html target=_blank>Bevy ECS Testing Patterns</a> - Common patterns for testing Bevy ECS systems</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22160.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>