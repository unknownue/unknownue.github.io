<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22264 Add comments explaining why the reloading code is so complex
        
    </title><meta content="#22264 Add comments explaining why the reloading code is so complex" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-29</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22264-zh-cn-20251229>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>Add comments explaining why the reloading code is so complex<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Add comments explaining why the reloading code is so complex<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22264<li><strong>Author</strong>: andriyDev<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Docs, A-Assets, S-Ready-For-Final-Review, D-Modest<li><strong>Created</strong>: 2025-12-25T01:05:44Z<li><strong>Merged</strong>: 2025-12-29T04:57:56Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p><strong>Objective</strong><ul><li>Fixes #21222.</ul><p><strong>Solution</strong><ul><li>Give an explanation, and add a TODO. Note I didn’t write this code, so I’m “guessing” on the rationale - but it’s an educated guess!</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a documentation gap in Bevy’s asset reloading system. The issue (#21222) specifically called out the complexity of the reloading code in <code>AssetServer::reload_asset</code> as being difficult to understand. The author recognized that while they didn’t write the original code, they could provide educated commentary to help future maintainers.<p>Asset reloading in Bevy handles a non-trivial scenario: when a file changes on disk, the engine needs to reload the asset while maintaining any existing handles to it. This becomes particularly complex when dealing with subassets (assets that are part of a larger asset file, like individual sprites in a sprite sheet).<p>The existing implementation in <code>reload_asset</code> follows a two-phase approach. The PR’s documentation clarifies this approach. First, the system attempts to reload the asset for any handles to that path, trying both root assets and subassets. This is the straightforward case where the asset type is known and the appropriate loader can be found.<p>However, there’s an edge case that makes the code more complex. When the root asset has been dropped from memory but its subassets are still in use, the first approach fails because it can’t determine the correct loader type (the root asset’s type is unknown). The second phase handles this by attempting an untyped load, which tries to find the appropriate loader based on the file extension alone.<p>The author adds a critical TODO note pointing out a potential issue: the untyped load might not always use the same loader as the original load, which could lead to incorrect behavior. They suggest storing a mapping from asset index to loader as a future improvement to guarantee consistency.<p>This documentation change is small but significant. By explaining the rationale behind the two-phase approach and identifying a known limitation, it reduces the cognitive load for developers working on or debugging the asset system. The comments serve as both explanation and warning, helping prevent regression when modifications are made to this complex but essential functionality.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[File Changed on Disk] --> B[AssetServer::reload_asset]
</span><span>    B --> C[Phase 1: Try Reload with Known Handles]
</span><span>    C --> D{Success?}
</span><span>    D -->|Yes| E[Reload Complete]
</span><span>    D -->|No| F[Phase 2: Try Untyped Load]
</span><span>    F --> G{Success?}
</span><span>    G -->|Yes| E
</span><span>    G -->|No| H[Reload Failed]
</span><span>    
</span><span>    C --> I[Attempts root assets and subassets]
</span><span>    F --> J[Uses file extension to find loader]
</span><span>    J --> K[Potential issue: May use different loader]
</span><span>    
</span><span>    style C fill:#f9f,stroke:#333,stroke-width:2px
</span><span>    style F fill:#ccf,stroke:#333,stroke-width:2px
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>File: <code>crates/bevy_asset/src/server/mod.rs</code> (+10/-0)</strong> This file contains the <code>AssetServer</code> implementation, specifically the <code>reload_asset</code> method which handles reloading assets when their source files change. The changes add explanatory comments to clarify the two-phase reloading logic and identify a potential issue with loader consistency.<p><strong>Changes:</strong> Two comment blocks were added to explain the two-phase reloading approach:<ol><li><strong>First comment block</strong> (added before the initial reload attempt):</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// First, try to reload the asset for any handles to that path. This will try both
</span><span style=color:#abb0b6;font-style:italic>// root assets and subassets.
</span></code></pre><ol start=2><li><strong>Second comment block</strong> (added before the fallback untyped load):</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// If the above section failed, and there are still living subassets (aka we should
</span><span style=color:#abb0b6;font-style:italic>// reload), then just try doing an untyped load. This helps catch cases where the
</span><span style=color:#abb0b6;font-style:italic>// root asset has been dropped, but all its subassets are still being used (in which
</span><span style=color:#abb0b6;font-style:italic>// case the above section would have tried to find the loader with the root asset's
</span><span style=color:#abb0b6;font-style:italic>// type and loaded it). Hopefully the untyped load will find the right loader and
</span><span style=color:#abb0b6;font-style:italic>// reload all the subassets (though this is not guaranteed).
</span><span style=color:#abb0b6;font-style:italic>// TODO: Make sure we use the same loader as the original load (e.g., by storing a
</span><span style=color:#abb0b6;font-style:italic>// map from asset index to loader).
</span></code></pre><p>These comments clarify that:<ul><li>The first phase attempts to reload using known asset handles and types<li>The second phase is a fallback for cases where the root asset type is unknown (because the root asset was dropped)<li>There’s a potential issue where the untyped load might use a different loader than the original<li>A future improvement could involve storing loader information with assets</ul><p>The code changes don’t modify any logic - they only add documentation. This is appropriate since the issue was about code comprehension rather than functionality.<h2 id=further-reading>Further Reading</h2><ol><li><strong>Bevy Asset System Documentation</strong>: For understanding how Bevy handles asset loading and management<li><strong>Hot Reloading in Game Engines</strong>: General concepts about live asset updates during development<li><strong>Rust Async/Await Patterns</strong>: The reloading code uses async/await for non-blocking file operations<li><strong>Type Erasure in Rust</strong>: Relevant to understanding how untyped loading works with different asset types<li><strong>Observer Pattern</strong>: The asset reloading system follows this pattern, notifying dependent systems of changes</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22264.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>