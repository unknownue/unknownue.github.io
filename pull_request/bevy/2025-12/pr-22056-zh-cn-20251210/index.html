<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22056 Make the ui_surface module public.
        
    </title><meta content="#22056 Make the ui_surface module public." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-10</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2025-12/pr-22056-en-20251210>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Make the ui_surface module public.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22056<li><strong>Author</strong>: IQuick143<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Docs, D-Trivial, A-UI, C-Code-Quality, C-Usability, S-Ready-For-Final-Review, A-Dev-Tools<li><strong>Created</strong>: 2025-12-07T13:32:52Z<li><strong>Merged</strong>: 2025-12-10T00:19:59Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h3 id=mu-biao>目标</h3><ul><li>修复 #17909</ul><h3 id=jie-jue-fang-an>解决方案</h3><ul><li>将 <code>ui_surface</code> 模块设为公有（而不仅仅是 pub(crate)），以便能够通过函数查询并使用 UiSurface。</ul><h3 id=shuo-ming>说明</h3><p>将此模块设为公有可能会破坏封装（特别是它可能允许移除 Resource），但考虑到 ECS 状态的保证相对宽松，我认为（资源存在）这个假设并非任何人都能真正依赖的。<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>这个 PR 的故事始于一个外部开发者（或者说，任何试图与 Bevy 的 UI 系统进行特定交互的人）遇到的一个具体问题。这个问题在 Issue #17909 中被记录。问题的核心是 API 的可访问性：开发者想要通过 <code>World</code> 的 <code>get_resource</code> 或类似的方法查询 <code>UiSurface</code> 资源，但却无法做到，因为定义它的模块 <code>ui_surface</code> 的可见性被限制为 <code>pub(crate)</code>。<p>在 Rust 中，模块可见性是一个关键的访问控制机制。<code>pub(crate)</code> 意味着该模块和其中的公有项（<code>pub</code> items）仅在当前 crate（即 <code>bevy_ui</code> 库）内部可见。对于 crate 外部的代码，包括用户编写的游戏或工具代码，这个模块就像不存在一样。因此，即使 <code>UiSurface</code> 结构体本身被标记为 <code>pub</code>，但由于它位于一个 <code>pub(crate)</code> 的模块内，外部的代码路径无法到达它。这导致了开发者无法编写依赖于查询 <code>UiSurface</code> 资源的系统或逻辑。<p>开发者 <code>IQuick143</code> 提出的解决方案直截了当：将模块的可见性从 <code>pub(crate)</code> 提升到完全公开的 <code>pub</code>。这是一个非常小的、单行的代码变更，但其影响是实质性的。它解除了对 <code>UiSurface</code> 资源的访问封锁，使得它像 Bevy ECS 世界中的其他公共资源一样，可以被用户代码查询、引用和使用。<p>在实现时，开发者考虑到了潜在的副作用。将内部实现细节公开确实存在理论上的风险，例如破坏了模块的封装性。正如 PR 说明中所指出的，最显著的风险是外部代码现在可以随意地 <code>remove</code>（移除）这个资源，这可能会破坏 UI 系统其他部分对其存在的假设。然而，作者做出了一个合理的工程权衡。在 Bevy 基于 ECS 的架构中，资源的生命周期管理本就是动态的，系统不能绝对依赖某个资源在任何时刻都存在。因此，将这个风险与解决用户无法访问一个可能需要的核心 UI 资源所带来的不便相权衡，选择开放访问是合理的。<p>这个更改本身是微小的，但它反映了库设计中的一个常见考量：如何在保持内部灵活性和提供稳定公共 API 之间找到平衡。通过将 <code>ui_surface</code> 模块公开，Bevy 团队承认了 <code>UiSurface</code> 作为 UI 布局管道中一个稳定且有用的组成部分的地位，值得被纳入公共 API 表面。这个改动最终被合并，表明团队认可这个权衡，并优先考虑了用户的功能需求（修复 Issue #17909）和代码的可用性。<h2 id=visual-representation>Visual Representation</h2><p>这个 PR 的核心变更非常聚焦，主要涉及模块可见性的层级变化。<pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    subgraph "crates/bevy_ui/src/layout"
</span><span>        A[mod.rs] --> B[ui_surface 模块]
</span><span>        B --> C[UiSurface 资源]
</span><span>    end
</span><span>
</span><span>    subgraph "外部代码 (用户游戏/工具)"
</span><span>        D[用户系统]
</span><span>    end
</span><span>
</span><span>    style B stroke:#f66,stroke-width:2px
</span><span>    style D stroke:#0a0,stroke-width:2px
</span><span>
</span><span>    linkStyle 1 stroke:#0a0,stroke-width:2px
</span></code></pre><p><strong>图例说明</strong>:<ul><li><strong>实线箭头</strong> 表示模块包含关系。<li><strong>高亮方框</strong>: <ul><li>红色边框 (<code>B</code>) 表示被修改的 <code>ui_surface</code> 模块的可见性从 <code>pub(crate)</code> 变为 <code>pub</code>。<li>绿色边框 (<code>D</code>) 表示外部用户代码。</ul><li><strong>绿色加粗箭头</strong> (<code>C --> D</code>) 表示此次修改后新建立的访问路径：外部代码现在可以直接引用并查询 <code>UiSurface</code> 资源。</ul><h2 id=key-files-changed>Key Files Changed</h2><p>仅有一个文件被修改，但它是解决访问问题的关键。<ul><li><code>crates/bevy_ui/src/layout/mod.rs</code> (+1/-1)</ul><p>这个文件是 <code>bevy_ui</code> crate 中布局模块的根模块文件。它负责导出（<code>pub use</code>）或声明（<code>mod</code>）所有子模块。在这里，对 <code>ui_surface</code> 模块的可见性声明进行了修改。<ol><li><p><strong>修改内容及原因</strong>: 此行修改将 <code>ui_surface</code> 模块的可见性从仅限于当前 crate 内部访问 (<code>pub(crate)</code>) 更改为完全公开 (<code>pub</code>)。这使得依赖 <code>bevy_ui</code> 库的外部代码能够通过路径 <code>bevy_ui::layout::ui_surface</code> 访问到该模块及其内部标记为 <code>pub</code> 的项（最主要的就是 <code>UiSurface</code> 资源）。</p><li><p><strong>代码片段</strong>:</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// File: crates/bevy_ui/src/layout/mod.rs
</span><span style=color:#abb0b6;font-style:italic>// 修改前:
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>mod </span><span style=color:#399ee6>ui_surface</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 修改后:
</span><span style=color:#fa6e32>pub mod </span><span style=color:#399ee6>ui_surface</span><span style=color:#61676ccc>;
</span></code></pre><li><p><strong>与 PR 目标的关联</strong>: 这是实现 PR 描述中“解决方案”部分的唯一且直接的代码变更。通过这一行修改，成功解决了 Issue #17909 中报告的用户无法查询 <code>UiSurface</code> 资源的问题。</p></ol><h2 id=further-reading>Further Reading</h2><ol><li><strong>相关 Issue</strong>: <a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/issues/17909 target=_blank>Issue #17909</a> - 这是本 PR 旨在修复的原始问题。阅读它可以更深入地理解用户遇到的具体场景和需求。<li><strong>Rust 模块与可见性</strong>: Rust 官方书籍中关于 <a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/book/ch07-02-defining-modules-to-control-scope-and-privacy.html target=_blank>模块</a> 和 <a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/book/ch07-03-paths-for-referring-to-an-item-in-the-module-tree.html target=_blank>路径</a> 的章节，可以帮助理解 <code>pub</code>, <code>pub(crate)</code> 等可见性修饰符的确切含义和作用范围。<li><strong>Bevy ECS 资源</strong>: Bevy 官方手册中关于 <a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/0.15/programming/ecs#resources target=_blank>Resources</a> 的部分，解释了资源（Resource）在 Bevy ECS 中是如何存储、访问和管理的，这有助于理解为何查询 <code>UiSurface</code> 是一个合理的需求。</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22056.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>