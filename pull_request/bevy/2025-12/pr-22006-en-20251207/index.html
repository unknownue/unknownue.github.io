<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22006 `TextLayoutInfo::clear`
        
    </title><meta content="#22006 `TextLayoutInfo::clear`" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-07</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22006-zh-cn-20251207>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: <code>TextLayoutInfo::clear</code><li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22006<li><strong>Author</strong>: ickshonpe<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: D-Trivial, S-Ready-For-Final-Review, A-Text<li><strong>Created</strong>: 2025-12-02T13:17:49Z<li><strong>Merged</strong>: 2025-12-07T19:04:50Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><p><strong>Objective</strong><p>Bevy text cosmic text cleanup, add a <code>clear</code> method to <code>TextLayoutInfo</code>.<p><strong>Solution</strong><p>Add a <code>clear</code> method to <code>TextLayoutInfo</code> instead of manual resetting each field<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a small but meaningful code quality issue in Bevy’s text rendering pipeline. The problem was straightforward: in the <code>TextPipeline::prepare</code> method, the code was manually clearing three fields of a <code>TextLayoutInfo</code> struct whenever text needed to be re-rendered. This manual approach, while functional, violated the DRY (Don’t Repeat Yourself) principle and made the code harder to maintain.<p>The context here involves Bevy’s text rendering system using Cosmic Text. When text needs to be prepared for rendering, the pipeline must clear any existing layout information before computing new layout data. The original implementation did this by individually clearing two vectors and resetting a size field:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>layout_info</span><span style=color:#ed9366>.</span><span>glyphs</span><span style=color:#ed9366>.</span><span style=color:#f07171>clear</span><span>()</span><span style=color:#61676ccc>;
</span><span>layout_info</span><span style=color:#ed9366>.</span><span>run_geometry</span><span style=color:#ed9366>.</span><span style=color:#f07171>clear</span><span>()</span><span style=color:#61676ccc>;
</span><span>layout_info</span><span style=color:#ed9366>.</span><span>size </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>Default</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>;
</span></code></pre><p>This approach had several issues. First, it required the caller to know exactly which fields needed to be cleared. Second, if the <code>TextLayoutInfo</code> struct’s internal representation changed in the future (for example, adding new fields that also need clearing), every call site would need to be updated. Third, it missed resetting the <code>scale_factor</code> field to its default value of 1.0, which could lead to subtle bugs if the struct was being reused.<p>The solution was simple but effective: add a <code>clear</code> method to the <code>TextLayoutInfo</code> struct that encapsulates all the clearing logic in one place. The implementation is straightforward:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>clear</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>) {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>scale_factor </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>1.</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>glyphs</span><span style=color:#ed9366>.</span><span style=color:#f07171>clear</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>run_geometry</span><span style=color:#ed9366>.</span><span style=color:#f07171>clear</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>size </span><span style=color:#ed9366>= </span><span>Vec2</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ZERO</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>This method does three things: resets <code>scale_factor</code> to 1.0, clears both vectors (which retains their allocated capacity for future use), and sets the size to <code>Vec2::ZERO</code>. The method is then called from the single location in <code>TextPipeline::prepare</code> where the manual clearing was happening.<p>The engineering trade-off here is minimal. Adding a method adds a small amount of API surface area, but the benefits in terms of code maintainability and correctness outweigh this. The method is <code>pub</code> (public), which is appropriate since <code>TextLayoutInfo</code> is a public struct and other parts of the codebase might want to reuse this clearing logic.<p>An important technical detail to note is how the method handles the vectors. It uses <code>clear()</code> rather than reassigning to empty vectors. This is intentional: <code>clear()</code> retains the allocated capacity of the vectors, which can improve performance when the struct is reused multiple times for text rendering operations of similar size. This is a common optimization pattern in Rust when dealing with reusable buffers.<p>The impact of this change is primarily about code quality and maintainability. While there’s no direct performance improvement (the operations are the same), the change makes the code more robust. If new fields are added to <code>TextLayoutInfo</code> in the future that need clearing, they can be added to the <code>clear</code> method, and all callers will automatically get the correct behavior. This prevents the bug where <code>scale_factor</code> wasn’t being reset in the original manual clearing code.<p>The PR also demonstrates good Rust patterns: encapsulating related operations in methods on the struct they operate on, using <code>Vec::clear()</code> for performance when reusing allocations, and providing explicit default values (<code>Vec2::ZERO</code> instead of <code>Default::default()</code>) for clarity.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[TextPipeline::prepare] --> B[Call TextLayoutInfo::clear]
</span><span>    B --> C[Reset scale_factor to 1.0]
</span><span>    B --> D[Clear glyphs vector]
</span><span>    B --> E[Clear run_geometry vector]
</span><span>    B --> F[Set size to Vec2::ZERO]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>crates/bevy_text/src/pipeline.rs</strong> (+11/-3)<p>This file contains the text rendering pipeline implementation. The changes are minimal but significant:<ol><li><p><strong>Added <code>clear</code> method to <code>TextLayoutInfo</code></strong>: A new method that encapsulates all the logic for resetting the struct’s fields to their default state.</p><li><p><strong>Updated <code>TextPipeline::prepare</code></strong>: Replaced three lines of manual field clearing with a single call to the new <code>clear</code> method.</p></ol><p><strong>Key code changes:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before in TextPipeline::prepare:
</span><span>layout_info</span><span style=color:#ed9366>.</span><span>glyphs</span><span style=color:#ed9366>.</span><span style=color:#f07171>clear</span><span>()</span><span style=color:#61676ccc>;
</span><span>layout_info</span><span style=color:#ed9366>.</span><span>run_geometry</span><span style=color:#ed9366>.</span><span style=color:#f07171>clear</span><span>()</span><span style=color:#61676ccc>;
</span><span>layout_info</span><span style=color:#ed9366>.</span><span>size </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>Default</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After in TextPipeline::prepare:
</span><span>layout_info</span><span style=color:#ed9366>.</span><span style=color:#f07171>clear</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// New method added to TextLayoutInfo:
</span><span style=color:#fa6e32>impl </span><span style=color:#399ee6>TextLayoutInfo </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>/// Clear the layout, retaining capacity
</span><span>    </span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>clear</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>) {
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>scale_factor </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>1.</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>glyphs</span><span style=color:#ed9366>.</span><span style=color:#f07171>clear</span><span>()</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>run_geometry</span><span style=color:#ed9366>.</span><span style=color:#f07171>clear</span><span>()</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>size </span><span style=color:#ed9366>= </span><span>Vec2</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ZERO</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><p>The changes relate to the overall purpose of the PR by centralizing the clearing logic, fixing the missing <code>scale_factor</code> reset, and improving code maintainability.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/std/vec/struct.Vec.html#method.clear target=_blank>Rust Vec::clear() documentation</a> - Explains how <code>clear()</code> retains capacity<li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Don%27t_repeat_yourself target=_blank>DRY Principle</a> - Software development principle about avoiding code duplication<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/ui/text/ target=_blank>Bevy Text Rendering</a> - Bevy’s documentation on text rendering<li><a rel="noopener nofollow noreferrer" href=https://github.com/pop-os/cosmic-text target=_blank>Cosmic Text</a> - The text shaping library used by Bevy</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22006.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>