<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22267 fix decal index selection in light textures
        
    </title><meta content="#22267 fix decal index selection in light textures" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-29</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22267-zh-cn-20251229>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>fix decal index selection in light textures<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: fix decal index selection in light textures<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22267<li><strong>Author</strong>: ChristopherBiscardi<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-12-25T17:04:39Z<li><strong>Merged</strong>: 2025-12-29T18:12:22Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>https://github.com/bevyengine/bevy/pull/22039 changed how many images are associated with a decal. light textures use decal base textures, ignoring the others.<p>fixes #22266<h2 id=solution>Solution</h2><p>use base color texture index<h2 id=testing>Testing</h2><pre style=color:#61676c;background-color:#fafafa><code><span>cargo run --example light_textures --features="pbr_light_textures"
</span></code></pre><h2 id=showcase>Showcase</h2><h3 id=before>before</h3><img alt="screenshot-2025-12-25-at-08 53 17@2x" height=1040 src=https://github.com/user-attachments/assets/77c26920-e7e2-4c96-8a94-275dfbaf759e width=2734><h3 id=after>after</h3><img alt="screenshot-2025-12-25-at-08 57 26@2x" height=1040 src=https://github.com/user-attachments/assets/cb9d9fce-4f7f-4ccf-8da3-560057d2fd2e width=2734><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The problem started with PR #22039, which modified how decals manage their texture associations. Previously, decals had a single <code>image_index</code> field pointing to their texture. After that PR, decals can have multiple textures associated with them—specifically, they now have separate texture indices for base color, normal maps, and other material properties.<p>The issue (#22266) arose because the light rendering code wasn’t updated to match this new structure. The <code>point_light</code>, <code>spot_light</code>, and <code>directional_light</code> functions in the PBR lighting shader were still using the old <code>image_index</code> field to access decal textures. Since light textures should use the base color texture of the decal (not other texture types like normal maps), this caused incorrect texture sampling, resulting in visual artifacts.<p>The solution was straightforward: update all three light functions to use <code>base_color_texture_index</code> instead of <code>image_index</code>. This ensures that light projections use the correct texture from the decal’s multi-texture setup. The fix is minimal—only three lines changed in a single WGSL shader file.<p>This is a classic example of how architectural changes can have downstream effects. When PR #22039 refactored the decal texture system to support multiple texture types, it created a breaking change for any code that assumed a single texture index. The light rendering code was one such consumer that needed updating.<p>The visual differences are significant. In the “before” screenshot, the projected textures appear incorrect—likely showing noise or misaligned patterns because they were sampling from the wrong texture index. The “after” screenshot shows clean, properly projected textures that match the decal’s intended appearance.<p>From an engineering perspective, this fix highlights the importance of understanding data structure dependencies across the codebase. When a core data structure changes (like the decal struct gaining multiple texture indices), all consumers of that structure must be reviewed and updated accordingly. The WGSL shader changes demonstrate how rendering logic in Bevy is split between Rust code and shader code, requiring coordination between both domains.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[PR #22039] --> B[Changes decal texture structure]
</span><span>    B --> C[Adds multiple texture indices]
</span><span>    C --> D[Breaks light rendering]
</span><span>    D --> E[Uses old image_index field]
</span><span>    E --> F[Visual artifacts]
</span><span>    F --> G[PR #22267 fix]
</span><span>    G --> H[Updates shader to use base_color_texture_index]
</span><span>    H --> I[Correct light projections]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-pbr-src-render-pbr-lighting-wgsl-3-3><code>crates/bevy_pbr/src/render/pbr_lighting.wgsl</code> (+3/-3)</h3><p>This WGSL shader file contains the lighting calculations for Bevy’s PBR renderer. The changes update three light functions to use the correct texture index when sampling decal textures for light projections.<p><strong>Key modifications:</strong><p>The pattern is the same in all three functions. Here’s the change in the <code>point_light</code> function:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>let image_index = view_bindings::clustered_decals.decals[(*light).decal_index].image_index;
</span><span>
</span><span>// After:
</span><span>let image_index = view_bindings::clustered_decals.decals[(*light).decal_index].base_color_texture_index;
</span></code></pre><p>The same change appears in <code>spot_light</code> and <code>directional_light</code> functions. Each function now correctly references the base color texture index instead of the generic image index that no longer exists in the expected form after PR #22039.<p>These changes ensure that when lights project decal textures onto surfaces, they sample from the decal’s base color texture rather than potentially incorrect texture indices that could point to normal maps or other material properties.<h2 id=further-reading>Further Reading</h2><ol><li><strong>WGSL Shading Language</strong>: https://www.w3.org/TR/WGSL/<li><strong>Bevy PBR Rendering</strong>: https://bevyengine.org/learn/quick-start/getting-started/rendering/<li><strong>Decals in Rendering</strong>: Technical explanation of decal projection techniques in real-time rendering<li><strong>Texture Arrays and Indices</strong>: How modern graphics APIs manage multiple textures for materials</ol><h1 id=full-code-diff>Full Code Diff</h1><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_pbr/src/render/pbr_lighting.wgsl b/crates/bevy_pbr/src/render/pbr_lighting.wgsl
</span><span>index 6dff89c041a9f..e4724b89c02e3 100644
</span><span style=color:#c594c5>--- a/crates/bevy_pbr/src/render/pbr_lighting.wgsl
</span><span style=color:#c594c5>+++ b/crates/bevy_pbr/src/render/pbr_lighting.wgsl
</span><span style=color:#c594c5>@@ -711,7 +711,7 @@ </span><span style=color:#399ee6>fn point_light(
</span><span>         let relative_position = (view_bindings::clustered_decals.decals[(*light).decal_index].local_from_world * vec4(P, 1.0)).xyz;
</span><span>         let cubemap_type = view_bindings::clustered_decals.decals[(*light).decal_index].tag;
</span><span>         let decal_uv = cubemap_uv(relative_position, cubemap_type);
</span><span style=color:#f07171>-        let image_index = view_bindings::clustered_decals.decals[(*light).decal_index].image_index;
</span><span style=color:#86b300>+        let image_index = view_bindings::clustered_decals.decals[(*light).decal_index].base_color_texture_index;
</span><span> 
</span><span>         texture_sample = textureSampleLevel(
</span><span>             view_bindings::clustered_decal_textures[image_index],
</span><span style=color:#c594c5>@@ -759,7 +759,7 @@ </span><span style=color:#399ee6>fn spot_light(
</span><span>             vec4((*input).P, 1.0)).xyz;
</span><span>         if local_position.z < 0.0 {
</span><span>             let decal_uv = (local_position.xy / (local_position.z * (*light).spot_light_tan_angle)) * vec2(-0.5, 0.5) + 0.5;
</span><span style=color:#f07171>-            let image_index = view_bindings::clustered_decals.decals[(*light).decal_index].image_index;
</span><span style=color:#86b300>+            let image_index = view_bindings::clustered_decals.decals[(*light).decal_index].base_color_texture_index;
</span><span> 
</span><span>             texture_sample = textureSampleLevel(
</span><span>                 view_bindings::clustered_decal_textures[image_index],
</span><span style=color:#c594c5>@@ -840,7 +840,7 @@ </span><span style=color:#399ee6>fn directional_light(
</span><span>         if (view_bindings::clustered_decals.decals[(*light).decal_index].tag != 0u)
</span><span>                 || all(clamp(decal_uv, vec2(0.0), vec2(1.0)) == decal_uv)
</span><span>         {
</span><span style=color:#f07171>-            let image_index = view_bindings::clustered_decals.decals[(*light).decal_index].image_index;
</span><span style=color:#86b300>+            let image_index = view_bindings::clustered_decals.decals[(*light).decal_index].base_color_texture_index;
</span><span> 
</span><span>             texture_sample = textureSampleLevel(
</span><span>                 view_bindings::clustered_decal_textures[image_index],
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22267.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>