<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22028 Increase the number of supported clustered decals if the `PARTIALLY_BOUND_BINDING_ARRAY` `wgpu` feature is present.
        
    </title><meta content="#22028 Increase the number of supported clustered decals if the `PARTIALLY_BOUND_BINDING_ARRAY` `wgpu` feature is present." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-08</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22028-zh-cn-20251208>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Increase the number of supported clustered decals if the <code>PARTIALLY_BOUND_BINDING_ARRAY</code> <code>wgpu</code> feature is present.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22028<li><strong>Author</strong>: pcwalton<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-12-04T16:50:53Z<li><strong>Merged</strong>: 2025-12-08T00:29:56Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><p>The current clustered decal code predates <code>PARTIALLY_BOUND_BINDING_ARRAY</code> support in <code>wgpu</code>. As a result, only 8 clustered decals are allowed in the scene in order to avoid paying a high cost even if no decals of that type are present. This limitation makes Bevy’s current clustered decal support insufficient for many use cases (e.g. bullet holes), so this patch increases the limit from 8 to 1024 if the <code>wgpu</code> features include <code>PARTIALLY_BOUND_BINDING_ARRAY</code>.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a limitation in Bevy’s clustered decal system where only 8 decals could be rendered per view. The limitation existed because the original implementation was written before wgpu supported partially bound binding arrays. Without this feature, binding arrays had to be fully populated to their maximum size even when many slots were unused, which incurred unnecessary overhead. To avoid performance penalties, the developers had set a conservative limit of 8 decals.<p>The problem became apparent in practical scenarios like rendering bullet holes, where many more decals are needed to create convincing visual effects. With only 8 decals available, the system was insufficient for realistic use cases. The solution leverages the now-available <code>PARTIALLY_BOUND_BINDING_ARRAY</code> wgpu feature, which allows binding arrays to be partially populated without requiring unused slots to be filled with placeholder resources.<p>The implementation replaces a hardcoded <code>MAX_VIEW_DECALS</code> constant with a <code>max_view_decals()</code> function that dynamically determines the limit based on the available wgpu features. On platforms supporting partially bound binding arrays, the limit increases to 1024, which provides a reasonable ceiling for most use cases while preventing shaders from becoming too slow with excessive numbers of decals. On platforms without this feature, the limit remains at 8 to maintain performance by avoiding the overhead of padding binding arrays.<p>The changes are minimal but strategic. The <code>get_bind_group_layout_entries()</code> function now calls <code>max_view_decals(render_device)</code> to determine the count for the texture binding array. In the bind group preparation code, the logic for padding the texture views array to its maximum length is now conditional—it only performs padding when <code>PARTIALLY_BOUND_BINDING_ARRAY</code> is not supported. This optimization eliminates unnecessary texture view allocations on platforms that support the feature.<p>The 1024 limit was chosen as a reasonable upper bound that accommodates typical use cases like bullet holes while providing a failsafe to prevent performance degradation. The implementation demonstrates how to conditionally leverage newer GPU features while maintaining backward compatibility with older hardware.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[RenderDevice features check] --> B{PARTIALLY_BOUND_BINDING_ARRAY supported?}
</span><span>    B -->|Yes| C[max_view_decals() returns 1024]
</span><span>    B -->|No| D[max_view_decals() returns 8]
</span><span>    C --> E[Binding array created with 1024 slots]
</span><span>    D --> F[Binding array created with 8 slots]
</span><span>    F --> G[Array padded with fallback textures]
</span><span>    E --> H[No padding needed]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-pbr-src-decal-clustered-rs-33-12><code>crates/bevy_pbr/src/decal/clustered.rs</code> (+33/-12)</h3><p>This file contains the core implementation changes for clustered decals. The modifications replace the hardcoded decal limit with a dynamic one based on GPU capabilities.<p><strong>Key changes:</strong><ol><li><strong>Removed constant and added dynamic function</strong>: The hardcoded <code>MAX_VIEW_DECALS</code> constant was removed and replaced with a <code>max_view_decals()</code> function that checks for the <code>PARTIALLY_BOUND_BINDING_ARRAY</code> feature.</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>const </span><span style=color:#ff8f40>MAX_VIEW_DECALS</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>8</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: (the constant was removed entirely)
</span><span style=color:#abb0b6;font-style:italic>// The functionality moved to the max_view_decals() function
</span></code></pre><ol start=2><li><strong>Updated binding layout creation</strong>: The <code>get_bind_group_layout_entries()</code> function now uses the dynamic limit instead of the hardcoded constant.</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>binding_types</span><span style=color:#ed9366>::</span><span>texture_2d(TextureSampleType</span><span style=color:#ed9366>::</span><span>Float { filterable</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>true </span><span>})
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>count</span><span>(NonZero</span><span style=color:#ed9366>::</span><span><</span><span style=color:#fa6e32>u32</span><span>></span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ff8f40>MAX_VIEW_DECALS </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>u32</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>())</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>binding_types</span><span style=color:#ed9366>::</span><span>texture_2d(TextureSampleType</span><span style=color:#ed9366>::</span><span>Float { filterable</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>true </span><span>})
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>count</span><span>(NonZero</span><span style=color:#ed9366>::</span><span><</span><span style=color:#fa6e32>u32</span><span>></span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#f07171>max_view_decals</span><span>(render_device))</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>())</span><span style=color:#61676ccc>,
</span></code></pre><ol start=3><li><strong>Conditional padding logic</strong>: The padding of texture views to fill the binding array is now conditional based on feature support.</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before (always padded):
</span><span style=color:#fa6e32>while</span><span> texture_views</span><span style=color:#ed9366>.</span><span style=color:#f07171>len</span><span>() </span><span style=color:#ed9366>< </span><span style=color:#ff8f40>MAX_VIEW_DECALS </span><span>{
</span><span>    texture_views</span><span style=color:#ed9366>.</span><span style=color:#f07171>push</span><span>(</span><span style=color:#ed9366>&*</span><span>fallback_image</span><span style=color:#ed9366>.</span><span>d2</span><span style=color:#ed9366>.</span><span>texture_view)</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After (conditional padding):
</span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>render_device
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>features</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>contains</span><span>(WgpuFeatures</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>PARTIALLY_BOUND_BINDING_ARRAY</span><span>)
</span><span>{
</span><span>    </span><span style=color:#fa6e32>let</span><span> max_view_decals </span><span style=color:#ed9366>= </span><span style=color:#f07171>max_view_decals</span><span>(render_device)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>while</span><span> texture_views</span><span style=color:#ed9366>.</span><span style=color:#f07171>len</span><span>() </span><span style=color:#ed9366><</span><span> max_view_decals </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>usize </span><span>{
</span><span>        texture_views</span><span style=color:#ed9366>.</span><span style=color:#f07171>push</span><span>(</span><span style=color:#ed9366>&*</span><span>fallback_image</span><span style=color:#ed9366>.</span><span>d2</span><span style=color:#ed9366>.</span><span>texture_view)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><ol start=4><li><strong>New feature-checking function</strong>: Added the <code>max_view_decals()</code> function that determines the limit based on GPU capabilities.</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>fn </span><span style=color:#f29718>max_view_decals</span><span>(</span><span style=color:#ff8f40>render_device</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>RenderDevice) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>u32 </span><span>{
</span><span>    </span><span style=color:#fa6e32>if</span><span> render_device
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>features</span><span>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>contains</span><span>(WgpuFeatures</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>PARTIALLY_BOUND_BINDING_ARRAY</span><span>)
</span><span>    {
</span><span>        </span><span style=color:#ff8f40>1024
</span><span>    } </span><span style=color:#fa6e32>else </span><span>{
</span><span>        </span><span style=color:#ff8f40>8
</span><span>    }
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><p><strong>WebGPU and wgpu Documentation</strong>:</p> <ul><li><a rel="noopener nofollow noreferrer" href=https://www.w3.org/TR/webgpu/ target=_blank>WebGPU Specification</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/wgpu/latest/wgpu/ target=_blank>wgpu Documentation</a></ul><li><p><strong>Binding Arrays and Partial Binding</strong>:</p> <ul><li><a rel="noopener nofollow noreferrer" href=https://www.w3.org/TR/webgpu/#binding-model target=_blank>WebGPU Binding Model</a><li><a rel="noopener nofollow noreferrer" href=https://registry.khronos.org/vulkan/specs/1.3-extensions/html/vkspec.html#features-partiallyBound target=_blank>Partially Bound Binding Arrays in Vulkan</a></ul><li><p><strong>Clustered Forward Rendering</strong>:</p> <ul><li><a rel="noopener nofollow noreferrer" href=http://www.humus.name/Articles/PracticalClusteredShading.pdf target=_blank>Clustered Shading Presentation</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_pbr/latest/bevy_pbr/ target=_blank>Bevy PBR Documentation</a></ul><li><p><strong>Performance Considerations for Binding Arrays</strong>:</p> <ul><li><a rel="noopener nofollow noreferrer" href=https://developer.nvidia.com/blog/rendering-in-real-time-with-spatiotemporal-reservoir-resampling/ target=_blank>GPU-Driven Rendering Pipelines</a><li><a rel="noopener nofollow noreferrer" href=https://developer.nvidia.com/blog/bindless-texturing-for-deferred-rendering-and-decals/ target=_blank>Bindless Texture Best Practices</a></ul></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22028.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>