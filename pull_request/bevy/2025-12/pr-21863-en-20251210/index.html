<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21863 Fix immediate nested loaded assets not loading their dependencies.
        
    </title><meta content="#21863 Fix immediate nested loaded assets not loading their dependencies." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-10</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-21863-zh-cn-20251210>中文</a></div></div><div class=pr-content><h1 id=fix-immediate-nested-loaded-assets-not-loading-their-dependencies>Fix immediate nested loaded assets not loading their dependencies</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix immediate nested loaded assets not loading their dependencies.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21863<li><strong>Author</strong>: andriyDev<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, D-Trivial, A-Assets, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-11-16T22:00:32Z<li><strong>Merged</strong>: 2025-12-09T23:50:10Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Previously if you loaded an immediate nested asset, it would <strong>not</strong> load any of its dependencies. This means that you could have handles in your asset that would never load.<li>Fixes #20988</ul><h2 id=solution>Solution</h2><ul><li>Propagate loading dependencies to immediate asset loads.<li>I also deduped some test App setup code.</ul><h2 id=testing>Testing</h2><ul><li>Added a test.</ul><p>One case that does have a slightly undesirable effect is when you immediately-load an asset, take some data from it (but no dependency handles), and then drop the immediately-loaded asset. This change will now also initiate a dependency load, even though we won’t use it.<p>However, A) it is much more surprising to have a handle that will never be loaded, B) we should end up cancelling the dependency load once we drop the handle, so we shouldn’t pay too much of the cost of loading.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The asset system in Bevy provides two ways to load assets during asset processing: deferred loading and immediate loading. When an asset loader needs to reference another asset, it typically uses <code>load_context.load(asset_path)</code> for deferred loading, which returns a <code>Handle</code> that will be populated asynchronously. However, sometimes you need to load an asset synchronously within the loading process - for example, when you need data from that asset to construct the current asset. This is done using <code>load_context.loader().immediate().load(asset_path)</code>.<p>The bug in PR #21863 was subtle but significant. When using immediate loading, the dependencies of the immediately-loaded asset were not being loaded. This meant that if you had an asset that immediately-loaded another asset which itself had dependencies, those nested dependencies would never start loading. The result was asset handles that would remain in the “NotLoaded” state indefinitely.<p>Consider this scenario:<ol><li>Asset A (ImmediateNested) loads asset B immediately<li>Asset B (DeferredNested) has a dependency on asset C, loaded with <code>load_context.load("c.txt")</code><li>Without the fix, asset C would never load, even though asset B’s handle to C is valid</ol><p>The root cause was in the <code>LoadContext::immediate()</code> method. When performing an immediate load, it was calling <code>load_internal()</code> with <code>should_load_dependencies: false</code>. This made sense for some contexts like asset preprocessing, but not for the general case of immediate loading during normal asset loading. The fix was straightforward: propagate the current context’s <code>should_load_dependencies</code> flag to the immediate load.<p>However, this change has a trade-off. If you immediately-load an asset, extract some data from it (without keeping dependency handles), and then drop the asset, the system will now also load its dependencies unnecessarily. The PR author acknowledges this but argues it’s acceptable because:<ol><li>It’s more surprising and problematic to have handles that never load<li>The dependency load should be cancelled when the handle is dropped, minimizing the performance impact</ol><p>To ensure the fix worked correctly, a comprehensive test was added that creates a chain of assets: an immediate-loaded asset that references a deferred-loaded asset that has its own dependency. The test verifies that all assets in the chain load correctly.<p>The PR also includes significant test refactoring. Many tests were creating App instances with similar setup code for in-memory asset storage. The author extracted a <code>create_app()</code> helper function that sets up a basic asset app with an in-memory file system, reducing code duplication and making tests more maintainable.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[ImmediateNestedLoader] -->|immediate().load()| B[DeferredNestedLoader]
</span><span>    B -->|load()| C[TrivialLoader]
</span><span>    
</span><span>    D[Before Fix] -->|Problem| E[Dependency C never loads]
</span><span>    F[After Fix] -->|Solution| G[should_load_dependencies: true propagates]
</span><span>    G --> H[All dependencies load correctly]
</span><span>    
</span><span>    I[Asset A] --> J[Asset B]
</span><span>    J --> K[Asset C]
</span><span>    K --> L[All assets load]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=1-crates-bevy-asset-src-loader-rs>1. <code>crates/bevy_asset/src/loader.rs</code></h3><p><strong>What changed</strong>: Modified the <code>load_internal</code> call in the <code>immediate()</code> method to pass through the <code>should_load_dependencies</code> flag from the current context.<p><strong>Why</strong>: To ensure that immediate asset loads trigger dependency loading when appropriate.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// File: crates/bevy_asset/src/loader.rs
</span><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let </span><span>(handle</span><span style=color:#61676ccc>,</span><span> loaded_asset) </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self
</span><span>    </span><span style=color:#ed9366>.</span><span>asset_server
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>load_internal</span><span>(
</span><span>        asset_path</span><span style=color:#61676ccc>,
</span><span>        meta</span><span style=color:#61676ccc>,
</span><span>        loader</span><span style=color:#61676ccc>,
</span><span>        reader</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#ff8f40>false</span><span style=color:#61676ccc>,  </span><span style=color:#abb0b6;font-style:italic>// Hardcoded false - dependencies won't load
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>populate_hashes</span><span style=color:#61676ccc>,
</span><span>    )
</span><span>    </span><span style=color:#ed9366>.</span><span>await</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let </span><span>(handle</span><span style=color:#61676ccc>,</span><span> loaded_asset) </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self
</span><span>    </span><span style=color:#ed9366>.</span><span>asset_server
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>load_internal</span><span>(
</span><span>        asset_path</span><span style=color:#61676ccc>,
</span><span>        meta</span><span style=color:#61676ccc>,
</span><span>        loader</span><span style=color:#61676ccc>,
</span><span>        reader</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>should_load_dependencies</span><span style=color:#61676ccc>,  </span><span style=color:#abb0b6;font-style:italic>// Use context's flag
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>populate_hashes</span><span style=color:#61676ccc>,
</span><span>    )
</span><span>    </span><span style=color:#ed9366>.</span><span>await</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=2-crates-bevy-asset-src-lib-rs>2. <code>crates/bevy_asset/src/lib.rs</code></h3><p><strong>What changed</strong>: Added a new test <code>immediate_nested_asset_loads_dependency</code> and refactored test setup code to reduce duplication.<p><strong>Why</strong>: To verify the fix works correctly and improve test maintainability.<p><strong>Key test addition</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>immediate_nested_asset_loads_dependency</span><span>() {
</span><span>    </span><span style=color:#fa6e32>let </span><span>(</span><span style=color:#fa6e32>mut</span><span> app</span><span style=color:#61676ccc>,</span><span> dir) </span><span style=color:#ed9366>= </span><span style=color:#f07171>create_app</span><span>()</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Test setup with three asset types:
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 1. ImmediateNested - loads DeferredNested immediately
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 2. DeferredNested - loads TestAsset (dependency)
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 3. TestAsset - simple asset
</span><span>    
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... loader implementations ...
</span><span>    
</span><span>    dir</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_asset_text</span><span>(Path</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#86b300>"a.immediate"</span><span>)</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"b.defer"</span><span>)</span><span style=color:#61676ccc>;
</span><span>    dir</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_asset_text</span><span>(Path</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#86b300>"b.defer"</span><span>)</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"c.txt"</span><span>)</span><span style=color:#61676ccc>;
</span><span>    dir</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_asset_text</span><span>(Path</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#86b300>"c.txt"</span><span>)</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"hiya"</span><span>)</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#fa6e32>let</span><span> server </span><span style=color:#ed9366>=</span><span> app</span><span style=color:#ed9366>.</span><span style=color:#f07171>world</span><span>()</span><span style=color:#ed9366>.</span><span>resource</span><span style=color:#ed9366>::</span><span>&LTAssetServer>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> immediate_handle</span><span style=color:#61676ccc>: </span><span>Handle&LTImmediateNested> </span><span style=color:#ed9366>=</span><span> server</span><span style=color:#ed9366>.</span><span style=color:#f07171>load</span><span>(</span><span style=color:#86b300>"a.immediate"</span><span>)</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Run until all assets are loaded
</span><span>    </span><span style=color:#f07171>run_app_until</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> app</span><span style=color:#61676ccc>, </span><span>|</span><span style=color:#ff8f40>world</span><span>| {
</span><span>        </span><span style=color:#fa6e32>let</span><span> immediate_assets </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span>resource</span><span style=color:#ed9366>::</span><span>&LTAssets&LTImmediateNested>>()</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#fa6e32>let</span><span> immediate </span><span style=color:#ed9366>=</span><span> immediate_assets</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#ed9366>&</span><span>immediate_handle)</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span><span>        
</span><span>        </span><span style=color:#fa6e32>let</span><span> test_asset_handle </span><span style=color:#ed9366>=</span><span> immediate</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#61676ccc>;
</span><span>        world
</span><span>            </span><span style=color:#ed9366>.</span><span>resource</span><span style=color:#ed9366>::</span><span>&LTAssets&LTTestAsset>>()
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#ed9366>&</span><span>test_asset_handle)</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span><span>        
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// The immediate asset is loaded, and the asset it got from 
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// its immediate load is also loaded.
</span><span>        </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(())
</span><span>    })</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p><strong>Refactoring</strong>: Created a <code>create_app()</code> helper function that replaces repeated test setup code:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>/// Creates a basic asset app and an in-memory file system.
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>create_app</span><span>() </span><span style=color:#61676ccc>-> </span><span>(App, Dir) {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> app </span><span style=color:#ed9366>= </span><span>App</span><span style=color:#ed9366>::</span><span>new()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> dir </span><span style=color:#ed9366>= </span><span>Dir</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> dir_clone </span><span style=color:#ed9366>=</span><span> dir</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#61676ccc>;
</span><span>    app</span><span style=color:#ed9366>.</span><span style=color:#f07171>register_asset_source</span><span>(
</span><span>        AssetSourceId</span><span style=color:#ed9366>::</span><span>Default</span><span style=color:#61676ccc>,
</span><span>        AssetSourceBuilder</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#fa6e32>move </span><span style=color:#ed9366>|| </span><span>{
</span><span>            </span><span style=color:#55b4d4;font-style:italic>Box</span><span style=color:#ed9366>::</span><span>new(MemoryAssetReader {
</span><span>                root</span><span style=color:#61676ccc>:</span><span> dir_clone</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#61676ccc>,
</span><span>            })
</span><span>        })</span><span style=color:#61676ccc>,
</span><span>    )
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>add_plugins</span><span>((
</span><span>        TaskPoolPlugin</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>,
</span><span>        AssetPlugin</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>,
</span><span>        DiagnosticsPlugin</span><span style=color:#61676ccc>,
</span><span>    ))</span><span style=color:#61676ccc>;
</span><span>    (app</span><span style=color:#61676ccc>,</span><span> dir)
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_asset/latest/bevy_asset/ target=_blank>Bevy Asset System Documentation</a> - Comprehensive guide to Bevy’s asset system<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/issues/20988 target=_blank>Issue #20988</a> - The original bug report that prompted this fix<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/examples/asset/asset_loading.rs target=_blank>Bevy Assets Example</a> - Example showing different asset loading patterns<li><a rel="noopener nofollow noreferrer" href=https://rust-lang.github.io/async-book/ target=_blank>Asynchronous Programming in Rust</a> - Understanding async/await patterns used in asset loaders</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_21863.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>