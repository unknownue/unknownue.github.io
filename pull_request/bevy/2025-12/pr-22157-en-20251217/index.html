<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22157 Revert "Fix: Clears directional navigation map between rebuilds
        
    </title><meta content='#22157 Revert "Fix: Clears directional navigation map between rebuilds' property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-17</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22157-zh-cn-20251217>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>Revert “Fix: Clears directional navigation map between rebuilds”<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Revert “Fix: Clears directional navigation map between rebuilds<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22157<li><strong>Author</strong>: alice-i-cecile<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-UI, P-Regression, S-Needs-Review<li><strong>Created</strong>: 2025-12-17T00:23:13Z<li><strong>Merged</strong>: 2025-12-17T02:49:54Z<li><strong>Merged By</strong>: cart</ul><h2 id=description-translation>Description Translation</h2><p>This reverts commit 545a97d67cdb87237e0bc5f02ecd17ec7e4b5c24, aka #22124.<h1 id=objective>Objective</h1><p>The cure was worse than the disease: losing manual edges is worse than being wrong with redraws.<p>Fixes #22136.<h2 id=solution>Solution</h2><p>For now, we’ll revert, then we’ll look for a better solution. For now, users can get this behavior by manually calling <a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/input_focus/directional_navigation/struct.DirectionalNavigationMap.html#method.clear target=_blank><code>clear</code></a>.<p>Reopens #21949.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR is a straightforward revert of a previous change that introduced a regression. The core issue revolves around the management of a directional navigation map in Bevy’s UI system. This map stores connections (edges) between UI elements to define navigation order, like moving focus from one button to another using arrow keys.<p>The original problem, reported in issue #21949, was that the navigation graph could retain stale edges after UI rebuilds. When entities were removed, their corresponding navigation edges weren’t being cleaned up, which could lead to incorrect navigation behavior.<p>The attempted fix in PR #22124 was to clear the entire <code>DirectionalNavigationMap</code> before each automatic rebuild by calling its <code>clear()</code> method. This approach ensured that any edges from removed entities would be pruned. The change was minimal, adding just two lines to the <code>auto_rebuild_ui_navigation_graph</code> function:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// clear the old nav map between rebuilds to ensure any removed entities' edges are pruned
</span><span>directional_nav_map</span><span style=color:#ed9366>.</span><span style=color:#f07171>clear</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><p>However, this solution had a significant unintended consequence: it also cleared all manually added edges. The UI navigation system supports both automatic edge generation and manual edge addition. Developers use manual edges to define custom navigation flows that the automatic algorithm might not capture correctly. Clearing the entire map on every rebuild meant that any manual configuration was lost, forcing developers to re-add their custom edges constantly. This regression was reported in issue #22136.<p>The developer faced a classic engineering trade-off. The initial fix solved the cleanup problem but broke an important feature. The decision was to revert the change because, in their assessment, “losing manual edges is worse than being wrong with redraws.” The temporary performance or correctness issue from stale edges was deemed less severe than the broken functionality for developers who rely on manual navigation configuration.<p>The revert removes the <code>clear()</code> call, restoring the previous behavior where manual edges persist across rebuilds, but stale edges from removed entities may remain. As noted in the PR description, developers who need the clearing behavior can manually call <code>directional_nav_map.clear()</code> when appropriate for their use case.<p>This situation highlights a common challenge in systems that mix automatic and manual configuration. The automatic rebuild process needs to be aware of which parts of the data structure it owns versus which parts are user-managed. A more sophisticated solution would be required to only clear the automatically generated edges while preserving manual ones, likely involving tracking the origin of each edge. The PR author indicates they will “look for a better solution” after the revert, acknowledging that the current state is a temporary compromise.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Issue #21949: Stale navigation edges persist] --> B[PR #22124: Add clear() before rebuild]
</span><span>    B --> C[Regression #22136: Manual edges are lost]
</span><span>    C --> D[This PR #22157: Revert clear() call]
</span><span>    D --> E[Restores manual edge persistence]
</span><span>    D --> F[Reopens issue #21949]
</span><span>    F --> G[Future: Need smarter edge management]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ul><li><code>crates/bevy_input_focus/src/directional_navigation.rs</code> (+0/-2)</ul><p>This file contains the system that automatically rebuilds the UI navigation graph. The change removes two lines that were clearing the entire directional navigation map before each rebuild.<p><strong>Before the revert:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// clear the old nav map between rebuilds to ensure any removed entities' edges are pruned
</span><span>directional_nav_map</span><span style=color:#ed9366>.</span><span style=color:#f07171>clear</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#f07171>auto_generate_navigation_edges</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> directional_nav_map</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>nodes</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>config)</span><span style=color:#61676ccc>;
</span></code></pre><p><strong>After the revert:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#f07171>auto_generate_navigation_edges</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> directional_nav_map</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>nodes</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>config)</span><span style=color:#61676ccc>;
</span></code></pre><p>The removal of the <code>clear()</code> call means the <code>auto_generate_navigation_edges</code> function now operates on a map that may contain:<ol><li>Previously automatically generated edges (some potentially stale)<li>Manually added edges (which should be preserved)</ol><p>The automatic generation function will overwrite automatic edges but leave manual edges intact. However, the downside is that edges for removed entities won’t be cleaned up unless the automatic regeneration happens to overwrite them.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/ui/focus/index.html target=_blank>Bevy UI Navigation Documentation</a> - Overview of Bevy’s focus and navigation system<li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/input_focus/directional_navigation/struct.DirectionalNavigationMap.html target=_blank>DirectionalNavigationMap API</a> - Details on the navigation map structure and methods<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/issues/21949 target=_blank>Issue #21949</a> - Original issue about stale navigation edges<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/issues/22136 target=_blank>Issue #22136</a> - Regression report about lost manual edges<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/pull/22124 target=_blank>PR #22124</a> - The original fix that introduced the <code>clear()</code> call</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22157.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>