<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21619 bug: Fix stackoverflow on asset reload.
        
    </title><meta content="#21619 bug: Fix stackoverflow on asset reload." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-15</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2025-12/pr-21619-en-20251215>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=title>Title</h1><p>bug: Fix stackoverflow on asset reload.<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: bug: Fix stackoverflow on asset reload.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21619<li><strong>Author</strong>: shanecelis<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Assets, S-Ready-For-Review<li><strong>Created</strong>: 2025-10-21T04:19:25Z<li><strong>Merged</strong>: 2025-12-14T23:46:28Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=mu-biao>目标</h1><p>修复当资产包含其自身路径作为依赖时，资产重载导致的栈溢出（stackoverflow）问题。<h2 id=wen-ti>问题</h2><p>存在一种方法可以通过资产加载器（asset loader）创建循环依赖图（circular dependency graph）。我不知道自己是怎么做到的。我曾尝试创建一个最小复现示例，但未能重现此错误。但我确实可以通过我的项目Nano-9来复现这个错误，复现细节如下。<h2 id=jie-jue-fang-an>解决方案</h2><p>这次提交包含两个修复点：一个在插入点（引入自引用时），另一个在递归点（跟随自引用时）。<h3 id=cha-ru-dian>插入点</h3><p>当资产试图将自己标记为依赖时发出警告，并禁止将其自身作为依赖项插入。<h3 id=di-gui-dian>递归点</h3><p>检查自循环（self loops）。检测到自循环时发出警告并停止循环。<p>很可能如果你在插入点修复了问题，就不必在递归点再担心它。你已经阻止了问题的根源。我保留了两处修复，是为了透明地展示到目前为止我所能看到的问题所在。<h2 id=ce-shi>测试</h2><p>我可以通过我的<a rel="noopener nofollow noreferrer" href=https://github.com/shanecelis/nano-9 target=_blank>Nano-9项目</a>中的一个示例来复现这个错误。我希望它是一个最小示例。它并不是，但我已经将其放在一个分支上来隔离此问题。它使用了我的Bevy分支，版本为v0.16.1加上一个标记为v0.16.1b的提交，这是构建所必需的。此PR是针对Bevy主分支（main branch）进行的修复提交的cherry pick。<p>我可以通过以下步骤复现这个错误：<pre class=language-sh data-lang=sh style=color:#61676c;background-color:#fafafa><code class=language-sh data-lang=sh><span style=color:#f29718>git</span><span> clone</span><span style=color:#ff8f40> -b</span><span> bevy-asset-stackoverflow https://github.com/shanecelis/nano-9.git
</span><span style=color:#f07171>cd</span><span> nano-9
</span><span style=color:#f29718>cargo</span><span> run</span><span style=color:#ff8f40> --example</span><span> sprite</span><span style=color:#ff8f40> --features</span><span> watcher</span><span style=color:#ff8f40> --no-default-features </span><span style=color:#ed9366>&
</span><span style=color:#f29718>touch</span><span> assets/BirdSprite.png
</span></code></pre><p>以下是在macOS 15.6.1，M4 Max上的崩溃报告摘录：<pre style=color:#61676c;background-color:#fafafa><code><span>...
</span><span>Thread 0 Crashed:: main Dispatch queue: com.apple.main-thread
</span><span>0   libsystem_kernel.dylib        	       0x18cc2a388 __pthread_kill + 8
</span><span>1   libsystem_pthread.dylib       	       0x18cc6388c pthread_kill + 296
</span><span>2   libsystem_c.dylib             	       0x18cb6ca3c abort + 124
</span><span>3   sprite                        	       0x10598d09c std::sys::pal::unix::abort_internal::h1edcc850f5dec78e + 12
</span><span>4   sprite                        	       0x10598c5b0 std::process::abort::hffd6db68ff0662a6 + 12
</span><span>5   sprite                        	       0x10580d464 std::sys::pal::unix::stack_overflow::imp::signal_handler::h7b8eae417c5ee98d + 604
</span><span>6   libsystem_platform.dylib      	       0x18cc9d6a4 _sigtramp + 56
</span><span>7   sprite                        	       0x10573f890 _$LT$std..path..Path$u20$as$u20$core..hash..Hash$GT$::hash::h732e05949b6a170e + 136
</span><span>8   sprite                        	       0x10573f890 _$LT$std..path..Path$u20$as$u20$core..hash..Hash$GT$::hash::h732e05949b6a170e + 136
</span><span>9   sprite                        	       0x104d5f278 _$LT$atomicow..CowArc$LT$T$GT$$u20$as$u20$core..hash..Hash$GT$::hash::h6c45383281764a05 + 40
</span><span>10  sprite                        	       0x104ed62d8 _$LT$bevy_asset..path..AssetPath$u20$as$u20$core..hash..Hash$GT$::hash::h11b348528182d76d + 52
</span><span>11  sprite                        	       0x104ded598 hashbrown::map::make_hash::hb7812997186aa817 + 56
</span><span>12  sprite                        	       0x104de8eec hashbrown::map::HashMap$LT$K$C$V$C$S$C$A$GT$::insert::h3a8b107dcf9615e9 + 64
</span><span>13  sprite                        	       0x104da7264 hashbrown::set::HashSet$LT$T$C$S$C$A$GT$::insert::h44e988e7a7752688 + 24
</span><span>14  sprite                        	       0x104e7b15c bevy_platform::collections::hash_set::HashSet$LT$T$C$S$GT$::insert::hb1d23d506d548fcc + 24
</span><span>15  sprite                        	       0x104dba770 bevy_asset::server::handle_internal_asset_events::_$u7b$$u7b$closure$u7d$$u7d$::queue_ancestors::hd1670687bb18ae9f + 216
</span><span>16  sprite                        	       0x104dba780 bevy_asset::server::handle_internal_asset_events::_$u7b$$u7b$closure$u7d$$u7d$::queue_ancestors::hd1670687bb18ae9f + 232
</span><span>17  sprite                        	       0x104dba780 bevy_asset::server::handle_internal_asset_events::_$u7b$$u7b$closure$u7d$$u7d$::queue_ancestors::hd1670687bb18ae9f + 232
</span><span>18  sprite                        	       0x104dba780 bevy_asset::server::handle_internal_asset_events::_$u7b$$u7b$closure$u7d$$u7d$::queue_ancestors::hd1670687bb18ae9f + 232
</span><span>19  sprite                        	       0x104dba780 bevy_asset::server::handle_internal_asset_events::_$u7b$$u7b$closure$u7d$$u7d$::queue_ancestors::hd1670687bb18ae9f + 232
</span><span>...
</span></code></pre><h3 id=yan-zheng-xiu-fu>验证修复</h3><p>修改Nano-9的Cargo文件以使用修复分支：<pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span style=color:#f07171>-bevy = { git = "https://github.com/shanecelis/bevy.git", tag = "v0.16.1b" }
</span><span style=color:#86b300>+bevy = { git = "https://github.com/shanecelis/bevy.git", branch = "fix/asset-reload-overflow" }
</span></code></pre><p>再次运行相同的命令，你将看到一条警告：<pre class=language-sh data-lang=sh style=color:#61676c;background-color:#fafafa><code class=language-sh data-lang=sh><span style=color:#f29718>2025-10-21T04:10:52.348726Z</span><span>  WARN bevy_asset::server::info: Asset </span><span style=color:#86b300>'BirdSprite.png'</span><span> wants to treat itself as a dependency
</span></code></pre><h2 id=ti-dai-fang-an>替代方案</h2><p>这次提交修复了立即出现的栈溢出问题；然而，如果能从一开始就阻止用户创建循环依赖图，那会更好。<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>这个PR解决了一个在Bevy资产系统中可能出现的微妙问题：当资产在其加载过程中试图将自己标记为依赖时，会导致无限递归和最终的栈溢出崩溃。这个问题通常不会在简单的使用场景中出现，但在特定的资产加载器实现中可能被意外触发。<h3 id=wen-ti-de-fa-xian-yu-zhen-duan>问题的发现与诊断</h3><p>开发者shanecelis在开发Nano-9项目时遇到了一个栈溢出崩溃。从崩溃日志中可以看到，堆栈跟踪在<code>queue_ancestors</code>函数中不断重复，表明存在无限递归。通过分析，发现问题出现在资产重载时，当资产将其自身路径作为依赖时，会形成一个循环依赖链，导致在重新加载资产时无限递归地遍历其依赖链。<h3 id=jie-jue-fang-an-de-shuang-zhong-bao-zhang>解决方案的双重保障</h3><p>开发者采用了双重防护策略来解决这个问题，这在软件工程中是一种稳健的做法：<ol><li><strong>在源头阻止</strong>：在资产加载器试图将自身路径添加为依赖时进行检查和阻止<li><strong>在运行时防御</strong>：在依赖遍历逻辑中添加循环检测，作为最后的防线</ol><p>这种双重保护确保了即使在某些边缘情况下第一个防护失败，第二个防护也能防止系统崩溃。<h3 id=shi-xian-xi-jie>实现细节</h3><p>在具体实现中，开发者修改了多个关键位置：<ol><li><strong>在<code>LoadContext::load_direct</code>中</strong>：添加了明确的路径检查，如果请求加载的路径与当前加载的资产路径相同，则返回<code>RequestedSelfPath</code>错误。</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>if </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>asset_path </span><span style=color:#ed9366>==</span><span> path {
</span><span>    </span><span style=color:#fa6e32>return </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(LoadDirectError</span><span style=color:#ed9366>::</span><span>RequestedSelfPath(
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>asset_path</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone_owned</span><span>()</span><span style=color:#61676ccc>,
</span><span>    ))</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><ol start=2><li><strong>在<code>LoadContext::read_asset_bytes</code>中</strong>：修改了依赖记录逻辑，避免将自身路径添加到依赖集合中：</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>if </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>asset_path </span><span style=color:#ed9366>!=</span><span> path {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>loader_dependencies</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(path</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone_owned</span><span>()</span><span style=color:#61676ccc>,</span><span> hash)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><ol start=3><li><p><strong>在加载器构建器中</strong>：对于延迟加载（deferred load）和立即加载（immediate load）两种情况都添加了自引用检查。对于延迟加载，只是记录调试日志而不将自身添加到依赖中；对于立即加载，则直接返回错误。</p><li><p><strong>在资产事件处理器中</strong>：添加了一个防御性的断言（assertion），确保在遍历依赖链时不会遇到自引用。如果断言失败，会提供清晰的错误信息，而不是让程序陷入无限递归。</p></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#f07171>assert_ne!</span><span>(
</span><span>    asset_path</span><span style=color:#61676ccc>,</span><span> dependent</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#86b300>"The asset path `{}` contains itself as a dependent."</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#ed9366>&</span><span>asset_path
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=ce-shi-fu-gai-de-quan-mian-xing>测试覆盖的全面性</h3><p>这个PR的一个重要特点是它包含了全面的测试用例，覆盖了多种可能的情况：<ul><li>立即加载自身路径（应该失败）<li>延迟加载自身路径（应该成功，但产生自引用句柄）<li>读取自身路径的字节（应该成功）<li>未知类型的延迟加载自身路径（应该成功）</ul><p>这些测试不仅验证了修复的有效性，也记录了系统在各种边界情况下的预期行为，为未来的维护提供了清晰的规范。<h3 id=gong-cheng-jue-ce-yu-quan-heng>工程决策与权衡</h3><p>开发者明确指出了他们的工程决策：虽然修复插入点（阻止自引用作为依赖）可能就足够了，但他们保留了递归点的修复作为额外的安全措施。这种透明性对于理解代码意图非常有价值。<p>同时，开发者也指出，更理想的解决方案是从根本上防止用户创建循环依赖图，但这可能需要更复杂的依赖关系检测机制，当前修复是一个更直接、更实用的解决方案。<h3 id=ji-shu-ying-xiang>技术影响</h3><p>这个修复虽然代码量不大，但解决了一个可能导致应用程序崩溃的重要问题。它提高了资产系统的健壮性，防止了因用户编写的资产加载器代码错误而导致的严重崩溃。这种防御性编程模式在其他类似的依赖管理系统中也值得借鉴。<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Asset Loader] -->|load_direct| B[LoadContext]
</span><span>    B -->|check self-reference| C{Is self-path?}
</span><span>    C -->|Yes| D[Return RequestedSelfPath error]
</span><span>    C -->|No| E[Load asset normally]
</span><span>    
</span><span>    F[Asset Reload] -->|queue_ancestors| G{Dependency Graph}
</span><span>    G -->|contains cycle| H[Assertion fails with clear error]
</span><span>    G -->|no cycle| I[Reload dependencies]
</span><span>    
</span><span>    J[Loader Builders] -->|deferred load| K{Is self-path?}
</span><span>    K -->|Yes| L[Debug log, skip dependency insertion]
</span><span>    K -->|No| M[Add to dependencies]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=1-crates-bevy-asset-src-loader-rs-10-1>1. <code>crates/bevy_asset/src/loader.rs</code> (+10/-1)</h3><p><strong>修改目的</strong>：在直接加载资产时添加自引用检查，防止立即加载自身路径导致的循环。<p><strong>关键代码修改</strong>：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 在load_direct方法中添加自引用检查
</span><span style=color:#fa6e32>if </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>asset_path </span><span style=color:#ed9366>==</span><span> path {
</span><span>    </span><span style=color:#fa6e32>return </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(LoadDirectError</span><span style=color:#ed9366>::</span><span>RequestedSelfPath(
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>asset_path</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone_owned</span><span>()</span><span style=color:#61676ccc>,
</span><span>    ))</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 在read_asset_bytes方法中，避免将自身路径添加到依赖
</span><span style=color:#fa6e32>if </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>asset_path </span><span style=color:#ed9366>!=</span><span> path {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>loader_dependencies</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(path</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone_owned</span><span>()</span><span style=color:#61676ccc>,</span><span> hash)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p><strong>与PR目标的关系</strong>：这是防止自引用的第一道防线，确保资产不会尝试立即加载自身。<h3 id=2-crates-bevy-asset-src-loader-builders-rs-25-3>2. <code>crates/bevy_asset/src/loader_builders.rs</code> (+25/-3)</h3><p><strong>修改目的</strong>：在加载器构建器中添加自引用检测，处理延迟加载和立即加载两种情况。<p><strong>关键代码修改</strong>：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 在延迟加载中检查自引用
</span><span style=color:#fa6e32>let</span><span> is_self_path </span><span style=color:#ed9366>= *</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>load_context</span><span style=color:#ed9366>.</span><span style=color:#f07171>path</span><span>() </span><span style=color:#ed9366>==</span><span> path</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>is_self_path {
</span><span>    </span><span style=color:#fa6e32>let</span><span> index </span><span style=color:#ed9366>= </span><span>(</span><span style=color:#ed9366>&</span><span>handle)</span><span style=color:#ed9366>.</span><span style=color:#f07171>try_into</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>load_context</span><span style=color:#ed9366>.</span><span>dependencies</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(index)</span><span style=color:#61676ccc>;
</span><span>} </span><span style=color:#fa6e32>else </span><span>{
</span><span>    </span><span style=color:#f07171>debug!</span><span>(
</span><span>        </span><span style=color:#86b300>"Asset from path `{:?}` loaded its self path"</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>load_context</span><span style=color:#ed9366>.</span><span style=color:#f07171>path</span><span>()
</span><span>    )</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 在立即加载中检查自引用
</span><span style=color:#fa6e32>if </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>load_context</span><span style=color:#ed9366>.</span><span style=color:#f07171>path</span><span>() </span><span style=color:#ed9366>==</span><span> path {
</span><span>    </span><span style=color:#fa6e32>return </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(LoadDirectError</span><span style=color:#ed9366>::</span><span>RequestedSelfPath(path</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()))</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p><strong>与PR目标的关系</strong>：这是插入点的修复，防止资产将自身作为依赖项插入。<h3 id=3-crates-bevy-asset-src-server-mod-rs-7-0>3. <code>crates/bevy_asset/src/server/mod.rs</code> (+7/-0)</h3><p><strong>修改目的</strong>：在资产重载的递归遍历中添加断言，防止因循环依赖导致的栈溢出。<p><strong>关键代码修改</strong>：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#f07171>assert_ne!</span><span>(
</span><span>    asset_path</span><span style=color:#61676ccc>,</span><span> dependent</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#86b300>"The asset path `{}` contains itself as a dependent."</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#ed9366>&</span><span>asset_path
</span><span>)</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// 如果上面的断言失败，下面的代码将会导致栈溢出
</span></code></pre><p><strong>与PR目标的关系</strong>：这是递归点的修复，作为最后一道防线防止无限递归。<h3 id=4-crates-bevy-asset-src-lib-rs-378-0>4. <code>crates/bevy_asset/src/lib.rs</code> (+378/-0)</h3><p><strong>修改目的</strong>：添加全面的测试用例，验证各种自引用场景下的行为。<p><strong>测试覆盖的场景</strong>：<ol><li>立即加载自身路径应该报错<li>延迟加载自身路径应该成功<li>读取自身路径的字节应该成功<li>未知类型的延迟加载自身路径应该成功</ol><p><strong>与PR目标的关系</strong>：确保修复的可靠性和对边界情况的正确处理。<h2 id=further-reading>Further Reading</h2><ol><li><strong>Bevy资产系统文档</strong>：https://bevyengine.org/learn/book/assets/<li><strong>循环依赖检测算法</strong>：了解图论中的环检测算法，如深度优先搜索（DFS）中的颜色标记法<li><strong>防御性编程</strong>：学习如何在关键路径添加断言和检查，提高系统健壮性<li><strong>Rust中的错误处理</strong>：了解Result和Error类型的模式，特别是如何设计清晰的错误类型</ol><h1 id=full-code-diff>Full Code Diff</h1><p>（已在上述分析中包含关键代码修改）</div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_21619.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>