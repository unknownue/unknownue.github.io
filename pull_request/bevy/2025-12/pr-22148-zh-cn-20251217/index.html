<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22148 在 CombinatorSystem 中注册对 DefaultErrorHandler 的读取
        
    </title><meta content="#22148 在 CombinatorSystem 中注册对 DefaultErrorHandler 的读取" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-17</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2025-12/pr-22148-en-20251217>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=title>Title</h1><p>register read on DefaultErrorHandler in CombinatorSystem<h2 id=basic-information>Basic Information</h2><ul><li><strong>标题</strong>: 在 CombinatorSystem 中注册对 DefaultErrorHandler 的读取<li><strong>PR 链接</strong>: https://github.com/bevyengine/bevy/pull/22148<li><strong>作者</strong>: janis-bhm<li><strong>状态</strong>: 已合并<li><strong>标签</strong>: C-Bug, A-ECS, S-Ready-For-Final-Review, P-Unsound<li><strong>创建时间</strong>: 2025-12-16T06:40:25Z<li><strong>合并时间</strong>: 2025-12-17T02:32:30Z<li><strong>合并者</strong>: cart</ul><h2 id=miao-shu-fan-yi>描述翻译</h2><h1 id=mu-biao>目标</h1><p>修复 #22133<h2 id=jie-jue-fang-an>解决方案</h2><p><code>CombinatorSystem</code> 现在在 <code>System::initialize</code> 中注册对 <code>DefaultErrorHandler</code> 资源的读取，正如 @hymm 所建议的。我还决定在该方法中禁用 <code>unsafe_op_in_unsafe_fn</code>，我认为这可以帮助我提前发现这个问题。<h2 id=ce-shi>测试</h2><p>我编写了一个测试，检查 <code>CombinatorSystems</code> 是否仍能可变地访问资源，检查组合系统是否与可变访问资源的系统冲突，并运行这样的调度以允许 miri 捕捉此 PR 修复的错误（最后一点似乎并不成立，但据我所知，这可能是因为即使在执行器可以并行运行的情况下，它实际上也没有并行运行？）。<h2 id=ci-pull-request-de-fen-xi>此 Pull Request 的分析</h2><p>这个 PR 修复了 Bevy ECS 系统中一个关于资源访问权限声明不完整的漏洞。问题出现在 <code>CombinatorSystem</code> 中，当系统执行失败时，它会调用 <code>DefaultErrorHandler</code> 来处理错误，但该系统并没有在初始化时声明对这个资源的读取权限。<h3 id=wen-ti-yu-bei-jing>问题与背景</h3><p>Bevy 的 ECS 调度器使用访问控制（access control）来确定哪些系统可以并行运行。系统需要在 <code>initialize</code> 方法中声明它们将访问哪些组件和资源，这样调度器才能安全地安排并行执行。<code>CombinatorSystem</code> 是一个组合两个系统的特殊系统类型，它在处理错误时需要访问 <code>DefaultErrorHandler</code> 资源。<p>问题的根本原因是：<code>CombinatorSystem</code> 的 <code>run_unsafe</code> 方法会调用 <code>world.0.default_error_handler()</code> 来处理系统执行错误，但该系统的 <code>initialize</code> 方法没有注册对这个资源的读取权限。这导致了未声明的资源访问（undeclared resource access），在调度器尝试并行执行系统时可能引起数据竞争。<h3 id=jie-jue-fang-an-1>解决方案</h3><p>PR 采用了直接的方法：在 <code>CombinatorSystem::initialize</code> 方法中添加对 <code>DefaultErrorHandler</code> 资源的读取注册。具体实现如下：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 我们可能需要在组件系统运行后读取默认错误处理器来报告失败。
</span><span style=color:#fa6e32>let</span><span> error_resource </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span>register_resource</span><span style=color:#ed9366>::</span><span>&LTcrate</span><span style=color:#ed9366>::</span><span>error</span><span style=color:#ed9366>::</span><span>DefaultErrorHandler>()</span><span style=color:#61676ccc>;
</span><span>a_access</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_unfiltered_resource_read</span><span>(error_resource)</span><span style=color:#61676ccc>;
</span></code></pre><p>这个修改确保了 <code>CombinatorSystem</code> 正确声明了它对 <code>DefaultErrorHandler</code> 的读取访问，使得调度器能够正确处理依赖关系。<h3 id=shi-shi-xi-jie>实施细节</h3><ol><li><p><strong>访问注册</strong>：在 <code>initialize</code> 方法中，首先获取两个子系统的访问信息，然后为 <code>DefaultErrorHandler</code> 资源添加无过滤条件的读取访问。</p><li><p><strong>安全性注释</strong>：在 <code>run_unsafe</code> 方法中添加了 <code>#![deny(unsafe_op_in_unsafe_fn)]</code> 属性，强制在 unsafe 函数内部明确标记 unsafe 操作。这有助于开发者更清楚地识别哪些操作需要特别注意安全性。</p><li><p><strong>安全保证</strong>：更新了 <code>run</code> 方法的安全注释，明确指出调用者需要保证没有其他系统会与组合系统或 <code>DefaultErrorHandler</code> 资源产生冲突。</p><li><p><strong>测试验证</strong>：添加了完整的测试用例，验证组合系统能够正确声明对错误处理器的访问，并确保调度器能够检测到潜在的冲突。</p></ol><h3 id=ji-shu-dong-cha>技术洞察</h3><p>这个修复展示了 Bevy ECS 中资源访问声明的重要性。在系统组合模式中，每个系统必须完整声明其所有依赖，包括那些仅在错误处理路径中使用的资源。不完整的声明可能导致调度器做出不安全的并行执行决策。<p><code>CombinatorSystem</code> 的设计需要特别注意，因为它封装了两个子系统，并且可能需要在子系统运行后执行额外的逻辑（如错误处理）。这种设计模式在系统组合中很常见，但需要确保所有访问路径都被正确声明。<h3 id=ying-xiang>影响</h3><p>这个修复解决了一个潜在的数据竞争问题，确保了 Bevy ECS 调度器的正确性。具体影响包括：<ol><li><strong>正确性</strong>：消除了未声明的资源访问，确保调度器能够正确安排系统执行顺序。<li><strong>安全性</strong>：通过添加 <code>unsafe_op_in_unsafe_fn</code> 限制，提高了代码的安全意识。<li><strong>可维护性</strong>：清晰的测试用例为未来的修改提供了验证基准。</ol><p>这个修复虽然代码量不大，但对系统的正确性至关重要。它提醒开发者在设计组合系统时需要仔细考虑所有可能的执行路径和资源访问。<h2 id=ke-shi-hua-biao-shi>可视化表示</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[CombinatorSystem] --> B[子系统 A]
</span><span>    A --> C[子系统 B]
</span><span>    A --> D[DefaultErrorHandler]
</span><span>    
</span><span>    B --> E[组件访问]
</span><span>    C --> F[组件访问]
</span><span>    D --> G[错误处理]
</span><span>    
</span><span>    H[调度器] --> I[访问声明]
</span><span>    I --> J[并行安排]
</span><span>    J --> K[安全执行]
</span></code></pre><h2 id=guan-jian-wen-jian-bian-geng>关键文件变更</h2><h3 id=crates-bevy-ecs-src-system-combinator-rs-55-5><code>crates/bevy_ecs/src/system/combinator.rs</code> (+55/-5)</h3><p>这个文件包含了 <code>CombinatorSystem</code> 的实现，是本次修复的核心。<p><strong>主要变更：</strong><ol><li><strong>在 <code>initialize</code> 方法中添加资源访问注册</strong></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 之前：
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>initialize</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> World) </span><span style=color:#61676ccc>-></span><span> SystemAccess {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> a_access </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>a</span><span style=color:#ed9366>.</span><span style=color:#f07171>initialize</span><span>(world)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> b_access </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>b</span><span style=color:#ed9366>.</span><span style=color:#f07171>initialize</span><span>(world)</span><span style=color:#61676ccc>;
</span><span>    a_access</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend</span><span>(b_access)</span><span style=color:#61676ccc>;
</span><span>    a_access
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 之后：
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>initialize</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> World) </span><span style=color:#61676ccc>-></span><span> SystemAccess {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> a_access </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>a</span><span style=color:#ed9366>.</span><span style=color:#f07171>initialize</span><span>(world)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> b_access </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>b</span><span style=color:#ed9366>.</span><span style=color:#f07171>initialize</span><span>(world)</span><span style=color:#61676ccc>;
</span><span>    a_access</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend</span><span>(b_access)</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// We might need to read the default error handler after the component
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// systems have run to report failures.
</span><span>    </span><span style=color:#fa6e32>let</span><span> error_resource </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span>register_resource</span><span style=color:#ed9366>::</span><span>&LTcrate</span><span style=color:#ed9366>::</span><span>error</span><span style=color:#ed9366>::</span><span>DefaultErrorHandler>()</span><span style=color:#61676ccc>;
</span><span>    a_access</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_unfiltered_resource_read</span><span>(error_resource)</span><span style=color:#61676ccc>;
</span><span>    a_access
</span><span>}
</span></code></pre><ol start=2><li><strong>在 <code>run_unsafe</code> 方法中添加安全属性</strong></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>fn </span><span style=color:#f29718>run_unsafe</span><span>(
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>,
</span><span>    </span><span style=color:#ff8f40>input</span><span style=color:#61676ccc>: </span><span>SystemIn&LTS>,
</span><span>    </span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> PrivateUnsafeWorldCell,
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><</span><span style=color:#fa6e32>S</span><span style=color:#ed9366>::</span><span>Out, RunSystemError> {
</span><span>    </span><span style=color:#61676ccc>#!</span><span>[</span><span style=color:#f29718>deny</span><span>(unsafe_op_in_unsafe_fn)]  </span><span style=color:#abb0b6;font-style:italic>// 新增属性
</span><span>    
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... 原有代码
</span><span>}
</span></code></pre><ol start=3><li><strong>更新错误处理中的安全注释</strong></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 之前：
</span><span style=color:#55b4d4;font-style:italic>Err</span><span>(RunSystemError</span><span style=color:#ed9366>::</span><span>Failed(err)) </span><span style=color:#ed9366>=> </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// let the world's default error handler handle the error if `Failed(_)`
</span><span>    (world</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0.</span><span style=color:#f07171>default_error_handler</span><span>())(
</span><span>        err</span><span style=color:#61676ccc>,
</span><span>        ErrorContext</span><span style=color:#ed9366>::</span><span>System {
</span><span>            name</span><span style=color:#61676ccc>:</span><span> system</span><span style=color:#ed9366>.</span><span style=color:#f07171>name</span><span>()</span><span style=color:#61676ccc>,
</span><span>        }</span><span style=color:#61676ccc>,
</span><span>    )
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 之后：
</span><span style=color:#55b4d4;font-style:italic>Err</span><span>(RunSystemError</span><span style=color:#ed9366>::</span><span>Failed(err)) </span><span style=color:#ed9366>=> </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// let the world's default error handler handle the error if `Failed(_)`
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// SAFETY: We registered access to DefaultErrorHandler in `initialize`.
</span><span>    (</span><span style=color:#fa6e32>unsafe </span><span>{ world</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0.</span><span style=color:#f07171>default_error_handler</span><span>() })(
</span><span>        err</span><span style=color:#61676ccc>,
</span><span>        ErrorContext</span><span style=color:#ed9366>::</span><span>System {
</span><span>            name</span><span style=color:#61676ccc>:</span><span> system</span><span style=color:#ed9366>.</span><span style=color:#f07171>name</span><span>()</span><span style=color:#61676ccc>,
</span><span>        }</span><span style=color:#61676ccc>,
</span><span>    )
</span><span>}
</span></code></pre><ol start=4><li><strong>添加测试验证</strong></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>combinator_with_error_handler_access</span><span>() {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 测试组合系统是否正确声明对错误处理器的访问
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 验证系统不会与自身冲突
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 验证系统会与其他可变访问相同资源的系统冲突
</span><span>}
</span></code></pre><p>这些变更确保了 <code>CombinatorSystem</code> 正确声明其对 <code>DefaultErrorHandler</code> 资源的访问，解决了潜在的未声明资源访问问题。<h2 id=kuo-zhan-yue-du>扩展阅读</h2><ol><li><strong>Bevy ECS 调度器文档</strong>：了解 Bevy 如何安排系统执行和检测冲突<li><strong>Rust 安全编程指南</strong>：深入理解 <code>unsafe</code> 代码的安全模式<li><strong>系统组合模式</strong>：学习如何构建可组合的系统架构<li><strong>数据竞争检测</strong>：了解现代编译器如何帮助检测并发问题</ol><h2 id=wan-zheng-dai-ma-chai-yi>完整代码差异</h2><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_ecs/src/system/combinator.rs b/crates/bevy_ecs/src/system/combinator.rs
</span><span>index e51c49d82e771..0ef463fc45e0d 100644
</span><span style=color:#c594c5>--- a/crates/bevy_ecs/src/system/combinator.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_ecs/src/system/combinator.rs
</span><span style=color:#c594c5>@@ -167,14 +167,17 @@ </span><span style=color:#399ee6>where
</span><span>             input: SystemIn&LTS>,
</span><span>             world: &mut PrivateUnsafeWorldCell,
</span><span>         ) -> Result&LTS::Out, RunSystemError> {
</span><span style=color:#86b300>+            #![deny(unsafe_op_in_unsafe_fn)]
</span><span style=color:#86b300>+
</span><span>             // SAFETY: see comment on `Func::combine` call
</span><span>             match (|| unsafe {
</span><span>                 system.validate_param_unsafe(world.0)?;
</span><span>                 system.run_unsafe(input, world.0)
</span><span>             })() {
</span><span style=color:#86b300>+                // let the world's default error handler handle the error if `Failed(_)`
</span><span>                 Err(RunSystemError::Failed(err)) => {
</span><span style=color:#f07171>-                    // let the world's default error handler handle the error if `Failed(_)`
</span><span style=color:#f07171>-                    (world.0.default_error_handler())(
</span><span style=color:#86b300>+                    // SAFETY: We registered access to DefaultErrorHandler in `initialize`.
</span><span style=color:#86b300>+                    (unsafe { world.0.default_error_handler() })(
</span><span>                         err,
</span><span>                         ErrorContext::System {
</span><span>                             name: system.name(),
</span><span style=color:#c594c5>@@ -198,12 +201,15 @@ </span><span style=color:#399ee6>where
</span><span>             input,
</span><span>             &mut PrivateUnsafeWorldCell(world),
</span><span>             // SAFETY: The world accesses for both underlying systems have been registered,
</span><span style=color:#f07171>-            // so the caller will guarantee that no other systems will conflict with `a` or `b`.
</span><span style=color:#86b300>+            // so the caller will guarantee that no other systems will conflict with (`a` or `b`) and the `DefaultErrorHandler` resource.
</span><span>             // If either system has `is_exclusive()`, then the combined system also has `is_exclusive`.
</span><span>             // Since we require a `combine` to pass in a mutable reference to `world` and that's a private type
</span><span>             // passed to a function as an unbound non-'static generic argument, they can never be called in parallel
</span><span>             // or re-entrantly because that would require forging another instance of `PrivateUnsafeWorldCell`.
</span><span>             // This means that the world accesses in the two closures will not conflict with each other.
</span><span style=color:#86b300>+            // The closure's access to the DefaultErrorHandler does not
</span><span style=color:#86b300>+            // conflict with any potential access to the DefaultErrorHandler by
</span><span style=color:#86b300>+            // the systems since the closures are not run in parallel.
</span><span>             |input, world| unsafe { run_system(&mut self.a, input, world) },
</span><span>             // SAFETY: See the comment above.
</span><span>             |input, world| unsafe { run_system(&mut self.b, input, world) },
</span><span style=color:#c594c5>@@ -244,6 +250,11 @@ </span><span style=color:#399ee6>where
</span><span>         let mut a_access = self.a.initialize(world);
</span><span>         let b_access = self.b.initialize(world);
</span><span>         a_access.extend(b_access);
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+        // We might need to read the default error handler after the component
</span><span style=color:#86b300>+        // systems have run to report failures.
</span><span style=color:#86b300>+        let error_resource = world.register_resource::&LTcrate::error::DefaultErrorHandler>();
</span><span style=color:#86b300>+        a_access.add_unfiltered_resource_read(error_resource);
</span><span>         a_access
</span><span>     }
</span><span> 
</span><span style=color:#c594c5>@@ -481,11 +492,50 @@ </span><span style=color:#399ee6>where
</span><span> 
</span><span> #[cfg(test)]
</span><span> mod tests {
</span><span style=color:#86b300>+    use crate::error::DefaultErrorHandler;
</span><span style=color:#86b300>+    use crate::prelude::*;
</span><span style=color:#86b300>+    use bevy_utils::prelude::DebugName;
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+    use crate::{
</span><span style=color:#86b300>+        schedule::OrMarker,
</span><span style=color:#86b300>+        system::{assert_system_does_not_conflict, CombinatorSystem},
</span><span style=color:#86b300>+    };
</span><span> 
</span><span>     #[test]
</span><span style=color:#f07171>-    fn exclusive_system_piping_is_possible() {
</span><span style=color:#f07171>-        use crate::prelude::*;
</span><span style=color:#86b300>+    fn combinator_with_error_handler_access() {
</span><span style=color:#86b300>+        fn my_system(_: ResMut&LTDefaultErrorHandler>) {}
</span><span style=color:#86b300>+        fn a() -> bool {
</span><span style=color:#86b300>+            true
</span><span style=color:#86b300>+        }
</span><span style=color:#86b300>+        fn b(_: ResMut&LTDefaultErrorHandler>) -> bool {
</span><span style=color:#86b300>+            true
</span><span style=color:#86b300>+        }
</span><span style=color:#86b300>+        fn asdf(_: In&LTbool>) {}
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+        let mut world = World::new();
</span><span style=color:#86b300>+        world.insert_resource(DefaultErrorHandler::default());
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+        let system = CombinatorSystem::&LTOrMarker, _, _>::new(
</span><span style=color:#86b300>+            IntoSystem::into_system(a),
</span><span style=color:#86b300>+            IntoSystem::into_system(b),
</span><span style=color:#86b300>+            DebugName::borrowed("a OR b"),
</span><span style=color:#86b300>+        );
</span><span> 
</span><span style=color:#86b300>+        // `system` should not conflict with itself by mutably accessing the error handler resource.
</span><span style=color:#86b300>+        assert_system_does_not_conflict(system.clone());
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+        let mut schedule = Schedule::default();
</span><span style=color:#86b300>+        schedule.add_systems((my_system, system.pipe(asdf)));
</span><span style=color:#86b300>+        schedule.initialize(&mut world).unwrap();
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+        // `my_system` should conflict with the combinator system because the combinator reads the error handler resource.
</span><span style=color:#86b300>+        assert!(!schedule.graph().conflicting_systems().is_empty());
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+        schedule.run(&mut world);
</span><span style=color:#86b300>+    }
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+    #[test]
</span><span style=color:#86b300>+    fn exclusive_system_piping_is_possible() {
</span><span>         fn my_exclusive_system(_world: &mut World) -> u32 {
</span><span>             1
</span><span>         }
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22148.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>