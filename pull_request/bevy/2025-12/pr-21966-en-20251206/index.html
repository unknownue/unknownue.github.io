<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21966 Don't update the text buffer in `text_system`
        
    </title><meta content="#21966 Don't update the text buffer in `text_system`" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-06</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-21966-zh-cn-20251206>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Don’t update the text buffer in <code>text_system</code><li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21966<li><strong>Author</strong>: ickshonpe<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Performance, A-UI, S-Ready-For-Final-Review, A-Text, D-Modest<li><strong>Created</strong>: 2025-11-28T13:56:36Z<li><strong>Merged</strong>: 2025-12-06T17:33:42Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Text is shaped in <code>measure_text_system</code>. When the schedule reaches <code>text_system</code> there’s no need to reupdate the cosmic-text buffer a second time. <code>text_system</code> should only be updating any stale <code>TextLayoutInfo</code> components.<h2 id=solution>Solution</h2><ul><li>Add a new method <code>update_text_layout_info</code> to <code>TextPipeline</code>. This method updates the given <code>TextLayoutInfo</code> without performing any shaping.<li>Call <code>update_text_layout_info</code> instead of <code>queue_text</code> from <code>text_system</code>.<li>Only query for <code>TextFont</code>, instead of the full <code>TextUiReader</code>.</ul><h1></h1><p>The next step is to remove <code>TextPipeline::queue_text</code>. I didn’t do that here as it’s a fairly large refactor and I have a bunch of other open text PRs I’d like to get merged first.<h2 id=testing>Testing</h2><h4 id=yellow-this-pr-red-main>yellow = this PR, red = main</h4><pre style=color:#61676c;background-color:#fafafa><code><span>cargo run --example many_glyphs --release --features trace_tracy,debug -- --no-text2d --recompute-text
</span></code></pre><img alt="Screenshot 2025-11-28 130411" height=851 src=https://github.com/user-attachments/assets/d21a42bf-8ea9-48b9-8cf3-24f742cb4174 width=1599><pre style=color:#61676c;background-color:#fafafa><code><span>cargo run --example many_buttons --release --features trace_tracy,debug -- --text --respawn
</span></code></pre><img alt="Screenshot 2025-11-28 145240" height=767 src=https://github.com/user-attachments/assets/75d2d989-37fc-4804-9c6d-6056413d91ef width=1597><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a performance inefficiency in Bevy’s text rendering pipeline where text was being reshaped unnecessarily. The issue stemmed from the division of labor between two text-related systems: <code>measure_text_system</code> and <code>text_system</code>.<p>In the existing architecture, <code>measure_text_system</code> was responsible for text shaping—the process of converting text strings into positioned glyphs using the cosmic-text library. This system computed the layout and stored it in a <code>ComputedTextBlock</code> component. Later, <code>text_system</code> would run and call <code>TextPipeline::queue_text()</code>, which would re-perform the entire text shaping process, essentially duplicating the work already done by <code>measure_text_system</code>.<p>The performance impact was significant because text shaping is computationally expensive. It involves parsing font files, calculating glyph positions, handling line breaks, and performing various typographic calculations. Doing this work twice for every text update was wasteful, especially in UI-heavy applications with many text elements.<p>The solution involved separating the text shaping logic from the layout update logic. Instead of modifying the existing <code>queue_text()</code> method, the developer introduced a new method <code>update_text_layout_info()</code> in the <code>TextPipeline</code> struct. This new method accepts a pre-shaped <code>ComputedTextBlock</code> buffer and only updates the <code>TextLayoutInfo</code> component with the glyph positioning and atlas information, without re-shaping the text.<p>Here’s the key insight: <code>text_system</code> doesn’t need to reshape text because <code>measure_text_system</code> has already done that work and stored the results in the <code>ComputedTextBlock</code>. The <code>text_system</code> should only be responsible for taking that pre-shaped buffer and converting it into renderable glyphs with proper atlas coordinates.<p>The implementation of <code>update_text_layout_info()</code> is carefully structured to reuse as much of the existing layout logic as possible while avoiding the expensive reshaping step. It processes the already-laid-out glyphs from the cosmic-text buffer, calculates their final screen positions, and ensures they’re properly added to the texture atlas if needed.<p>An important optimization in this change was simplifying the query in <code>text_system</code>. Previously, the system used <code>TextUiReader</code>, a complex query that iterated through multiple component types. The new implementation only queries for <code>TextFont</code> components, which is sufficient since the text has already been shaped and we only need font information for glyph positioning and atlas management.<p>The performance improvements shown in the Tracy profiles are substantial. In the <code>many_glyphs</code> example, the yellow line (this PR) shows significantly reduced CPU time compared to the red line (main branch). Similar improvements are visible in the <code>many_buttons</code> example. These gains come directly from eliminating the duplicate text shaping work.<p>This change is also architecturally cleaner. It establishes a clear separation of concerns: <code>measure_text_system</code> handles text measurement and shaping, while <code>text_system</code> handles the conversion of shaped text into renderable components. This makes the codebase more maintainable and sets the stage for future optimizations.<p>The PR author noted that the next logical step would be to remove the now-redundant <code>TextPipeline::queue_text()</code> method entirely, but that’s deferred to a future PR to avoid scope creep. This incremental approach is practical—it delivers immediate performance benefits while setting up a cleaner architecture for subsequent improvements.<p>From an engineering perspective, this PR demonstrates good optimization strategy: identify redundant work, separate concerns cleanly, measure the impact, and deliver incremental improvements. The change is relatively small (233 lines added, 53 removed) but delivers significant performance benefits by eliminating an entire category of redundant computation.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    subgraph "Before PR"
</span><span>        A[measure_text_system] --> B[Shapes text]
</span><span>        B --> C[Stores in ComputedTextBlock]
</span><span>        D[text_system] --> E[Calls queue_text]
</span><span>        E --> F[Re-shapes text]
</span><span>        F --> G[Updates TextLayoutInfo]
</span><span>    end
</span><span>    
</span><span>    subgraph "After PR"
</span><span>        H[measure_text_system] --> I[Shapes text]
</span><span>        I --> J[Stores in ComputedTextBlock]
</span><span>        K[text_system] --> L[Calls update_text_layout_info]
</span><span>        L --> M[Uses pre-shaped buffer]
</span><span>        M --> N[Updates TextLayoutInfo]
</span><span>    end
</span><span>    
</span><span>    style F fill:#f99
</span><span>    style M fill:#9f9
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-text-src-pipeline-rs-188-2><code>crates/bevy_text/src/pipeline.rs</code> (+188/-2)</h3><p>This file received the main logic addition: the new <code>update_text_layout_info()</code> method. This method takes a pre-shaped text buffer and updates the layout information without re-shaping.<p>Key changes:<ol><li>Added the <code>update_text_layout_info()</code> method to <code>TextPipeline</code><li>The method signature shows it operates on already-computed data:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>update_text_layout_info</span><span><</span><span style=color:#fa6e32>'a</span><span>>(
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>,
</span><span>    </span><span style=color:#ff8f40>layout_info</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> TextLayoutInfo,
</span><span>    </span><span style=color:#ff8f40>text_font_query</span><span style=color:#61676ccc>: </span><span>Query<</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'a</span><span> TextFont>,
</span><span>    </span><span style=color:#ff8f40>scale_factor</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f64</span><span>,
</span><span>    </span><span style=color:#ff8f40>font_atlas_set</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> FontAtlasSet,
</span><span>    </span><span style=color:#ff8f40>texture_atlases</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span>Assets&LTTextureAtlasLayout>,
</span><span>    </span><span style=color:#ff8f40>textures</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span>Assets&LTImage>,
</span><span>    </span><span style=color:#ff8f40>computed</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> ComputedTextBlock,  </span><span style=color:#abb0b6;font-style:italic>// Pre-shaped buffer
</span><span>    </span><span style=color:#ff8f40>font_system</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> CosmicFontSystem,
</span><span>    </span><span style=color:#ff8f40>swash_cache</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> SwashCache,
</span><span>    </span><span style=color:#ff8f40>bounds</span><span style=color:#61676ccc>:</span><span> TextBounds,
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><(), TextError>
</span></code></pre><ol start=3><li>The method processes glyphs from <code>computed.buffer</code> (which was shaped in <code>measure_text_system</code>) rather than re-shaping text<li>It maintains all the existing glyph positioning, atlas management, and error handling logic</ol><h3 id=crates-bevy-ui-src-widget-text-rs-45-51><code>crates/bevy_ui/src/widget/text.rs</code> (+45/-51)</h3><p>This file contains the <code>text_system</code> function that was modified to use the new method instead of <code>queue_text()</code>.<p>Key changes:<ol><li>Removed unused dependencies (<code>fonts: Res&LTAssets&LTFont>></code>)<li>Changed from <code>TextUiReader</code> to a simpler <code>Query<&TextFont></code><li>Updated to call <code>update_text_layout_info()</code> instead of <code>queue_text()</code>:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>match</span><span> text_pipeline</span><span style=color:#ed9366>.</span><span style=color:#f07171>queue_text</span><span>(
</span><span>    text_layout_info</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#ed9366>&</span><span>fonts</span><span style=color:#61676ccc>,
</span><span>    text_reader</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>(entity)</span><span style=color:#61676ccc>,
</span><span>    node</span><span style=color:#ed9366>.</span><span>inverse_scale_factor</span><span style=color:#ed9366>.</span><span style=color:#f07171>recip</span><span>() </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f64</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other parameters
</span><span>)
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>match</span><span> text_pipeline</span><span style=color:#ed9366>.</span><span style=color:#f07171>update_text_layout_info</span><span>(
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> text_layout_info</span><span style=color:#61676ccc>,
</span><span>    text_font_query</span><span style=color:#61676ccc>,
</span><span>    scale_factor</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other parameters
</span><span>)
</span></code></pre><ol start=4><li>The system now properly checks for changes and skips unnecessary work<li>Error handling remains consistent with the previous implementation</ol><h2 id=further-reading>Further Reading</h2><ol><li><strong>Cosmic-text library</strong>: The text shaping engine used by Bevy - https://github.com/pop-os/cosmic-text<li><strong>Text Shaping concepts</strong>: Understanding how text layout works - https://docs.microsoft.com/en-us/typography/opentype/spec/<li><strong>Bevy UI System</strong>: Documentation on Bevy’s UI architecture - https://bevyengine.org/learn/quick-start/ui/<li><strong>ECS Optimization</strong>: Patterns for optimizing Entity Component Systems - https://github.com/bevyengine/bevy/blob/main/docs/plugins_guidelines.md#optimization</ol><h1 id=full-code-diff>Full Code Diff</h1><p><em>(Included in the original prompt as reference)</em></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_21966.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>