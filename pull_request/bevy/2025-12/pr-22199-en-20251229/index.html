<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22199 Fix separate layers with lines and joints
        
    </title><meta content="#22199 Fix separate layers with lines and joints" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-29</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22199-zh-cn-20251229>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>Fix separate layers with lines and joints<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix separate layers with lines and joints<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22199<li><strong>Author</strong>: yh1970<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, S-Ready-For-Final-Review, A-Gizmos, D-Straightforward<li><strong>Created</strong>: 2025-12-19T16:39:21Z<li><strong>Merged</strong>: 2025-12-29T20:08:43Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Fix #22179<h2 id=solution>Solution</h2><p>Merge the two queue systems into one. The line and joint pairs should be drawn now in their own layers.<h2 id=testing>Testing</h2><p>I ran the 2d_gizmos example.<hr><h2 id=showcase>Showcase</h2><details><summary>Click to view showcase</summary> <p>Before</p> <img alt="Screenshot 2025-12-19 at 17 35 59" height=91 src=https://github.com/user-attachments/assets/6a8b4416-acd9-452e-ae40-6f63f3755b92 width=154> <p>After</p> <img alt="Screenshot 2025-12-19 at 17 35 24" height=91 src=https://github.com/user-attachments/assets/9cf0fa92-0e2e-4953-8adf-6a88d9ebdcb4 width=154></details><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a specific rendering bug in Bevy’s 2D gizmo system where line joints were not being drawn in the correct render layers. The issue (#22179) was reported, and the fix involves refactoring how the rendering queue systems are organized.<p>The problem stemmed from having two separate queue systems: <code>queue_line_gizmos_2d</code> and <code>queue_line_joint_gizmos_2d</code>. These systems were running independently but needed to process the same set of gizmo entities. When they ran separately, they could end up adding render items to different render phases or with different layer configurations, causing the joints to appear incorrectly layered relative to their corresponding lines.<p>The solution is straightforward: merge the two queue systems into a single system that handles both line and joint rendering in the same pass. This ensures that for each gizmo entity, both the line segments and their joints are queued for rendering with consistent render layer settings.<p>Looking at the implementation, the new <code>queue_line_and_joint_gizmos_2d</code> function combines the logic from both previous systems. It now takes both pipeline resources (<code>LineGizmoPipeline</code> and <code>LineJointGizmoPipeline</code>) and their corresponding specialized render pipeline collections. The function retrieves all three draw functions at once: for regular lines, line strips, and line joints.<p>The main loop structure remains similar - it iterates through views and gizmo entities. However, instead of having separate passes for lines and joints, it now processes everything in a single pass per entity. First, it handles the non-strip line vertices (if any), then the strip vertices (if applicable), and finally the joints (if the strip has enough vertices and joints are enabled).<p>This consolidation ensures that the render layer filtering logic (<code>config.render_layers.intersects(render_layers)</code>) is applied consistently. Previously, if the two systems ran at slightly different times or with different state, they might produce inconsistent results. Now, with a single pass, the layer filtering is guaranteed to be the same for both lines and their corresponding joints.<p>The technical approach here follows good software engineering practice: when you have two systems that need to operate on the same data with tight coupling requirements, consolidating them into a single system reduces complexity and eliminates synchronization issues. The refactoring also reduces code duplication, as both the view iteration and entity filtering logic were identical in the two original systems.<p>One important note about performance: while this change consolidates two systems into one, it doesn’t significantly change the computational complexity. Both original systems were already iterating over all views and all gizmo entities. The combined system does the same iterations but processes both lines and joints in the same loop. This might even provide a small performance benefit due to better cache locality and reduced system overhead.<p>The impact of this fix is visually clear in the showcase images. Before the fix, joints could appear incorrectly layered, potentially behind other elements or in the wrong order. After the fix, lines and their joints render together correctly in their designated layers.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[queue_line_and_joint_gizmos_2d system] --> B[For each view]
</span><span>    B --> C[For each gizmo entity]
</span><span>    C --> D{Render layers match?}
</span><span>    D -->|No| E[Skip entity]
</span><span>    D -->|Yes| F[Queue line segments]
</span><span>    F --> G[Queue line strips if applicable]
</span><span>    G --> H{Has joints enabled?}
</span><span>    H -->|Yes| I[Queue joints]
</span><span>    H -->|No| J[Next entity]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-gizmos-render-src-pipeline-2d-rs-21-49><code>crates/bevy_gizmos_render/src/pipeline_2d.rs</code> (+21/-49)</h3><p>This file contains the core rendering logic for 2D gizmos. The changes replace two separate queue systems with a single unified system.<p><strong>Key modifications:</strong><ol><li><strong>Plugin system registration changed:</strong></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(
</span><span>    Render</span><span style=color:#61676ccc>,
</span><span>    (queue_line_gizmos_2d</span><span style=color:#61676ccc>,</span><span> queue_line_joint_gizmos_2d)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>in_set</span><span>(GizmoRenderSystems</span><span style=color:#ed9366>::</span><span>QueueLineGizmos2d)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>after</span><span>(prepare_assets</span><span style=color:#ed9366>::</span><span>&LTGpuLineGizmo>)</span><span style=color:#61676ccc>,
</span><span>)
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(
</span><span>    Render</span><span style=color:#61676ccc>,
</span><span>    queue_line_and_joint_gizmos_2d
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>in_set</span><span>(GizmoRenderSystems</span><span style=color:#ed9366>::</span><span>QueueLineGizmos2d)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>after</span><span>(prepare_assets</span><span style=color:#ed9366>::</span><span>&LTGpuLineGizmo>)</span><span style=color:#61676ccc>,
</span><span>)
</span></code></pre><ol start=2><li><strong>Function signature and resource access expanded:</strong></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before (in queue_line_gizmos_2d):
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>queue_line_gizmos_2d</span><span>(
</span><span>    </span><span style=color:#ff8f40>draw_functions</span><span style=color:#61676ccc>: </span><span>Res&LTDrawFunctions&LTTransparent2d>>,
</span><span>    </span><span style=color:#ff8f40>pipeline</span><span style=color:#61676ccc>: </span><span>Res&LTLineGizmoPipeline>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>pipelines</span><span style=color:#61676ccc>: </span><span>ResMut&LTSpecializedRenderPipelines&LTLineGizmoPipeline>>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other parameters
</span><span>)
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>queue_line_and_joint_gizmos_2d</span><span>(
</span><span>    </span><span style=color:#ff8f40>draw_functions</span><span style=color:#61676ccc>: </span><span>Res&LTDrawFunctions&LTTransparent2d>>,
</span><span>    </span><span style=color:#ff8f40>line_gizmo_pipeline</span><span style=color:#61676ccc>: </span><span>Res&LTLineGizmoPipeline>,
</span><span>    </span><span style=color:#ff8f40>line_joint_gizmo_pipeline</span><span style=color:#61676ccc>: </span><span>Res&LTLineJointGizmoPipeline>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>line_gizmo_pipelines</span><span style=color:#61676ccc>: </span><span>ResMut&LTSpecializedRenderPipelines&LTLineGizmoPipeline>>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>line_joint_gizmo_pipelines</span><span style=color:#61676ccc>: </span><span>ResMut&LTSpecializedRenderPipelines&LTLineJointGizmoPipeline>>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other parameters
</span><span>)
</span></code></pre><ol start=3><li><strong>Draw function retrieval consolidated:</strong></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before (in queue_line_gizmos_2d):
</span><span style=color:#fa6e32>let</span><span> draw_function </span><span style=color:#ed9366>=</span><span> draw_functions</span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>()</span><span style=color:#ed9366>.</span><span>get_id</span><span style=color:#ed9366>::</span><span>&LTDrawLineGizmo2d>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> draw_function_strip </span><span style=color:#ed9366>=</span><span> draw_functions
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span>get_id</span><span style=color:#ed9366>::</span><span>&LTDrawLineGizmo2dStrip>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Before (in queue_line_joint_gizmos_2d):
</span><span style=color:#fa6e32>let</span><span> draw_function </span><span style=color:#ed9366>=</span><span> draw_functions
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span>get_id</span><span style=color:#ed9366>::</span><span>&LTDrawLineJointGizmo2d>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After (all in one place):
</span><span style=color:#fa6e32>let</span><span> draw_function </span><span style=color:#ed9366>=</span><span> draw_functions</span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>()</span><span style=color:#ed9366>.</span><span>get_id</span><span style=color:#ed9366>::</span><span>&LTDrawLineGizmo2d>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> draw_line_function_strip </span><span style=color:#ed9366>=</span><span> draw_functions
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span>get_id</span><span style=color:#ed9366>::</span><span>&LTDrawLineGizmo2dStrip>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> draw_line_joint_function </span><span style=color:#ed9366>=</span><span> draw_functions
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span>get_id</span><span style=color:#ed9366>::</span><span>&LTDrawLineJointGizmo2d>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><ol start=4><li><strong>Processing logic combined in a single loop:</strong> The most significant change is in the main processing loop. Instead of having two separate functions that iterate over views and entities independently, the new function processes lines and joints together:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Inside the entity loop:
</span><span style=color:#abb0b6;font-style:italic>// Draw lines (non-strip)
</span><span style=color:#fa6e32>if</span><span> line_gizmo</span><span style=color:#ed9366>.</span><span>list_vertex_count </span><span style=color:#ed9366>> </span><span style=color:#ff8f40>0 </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... line rendering logic
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Draw line strips
</span><span style=color:#fa6e32>if</span><span> line_gizmo</span><span style=color:#ed9366>.</span><span>strip_vertex_count </span><span style=color:#ed9366>>= </span><span style=color:#ff8f40>2 </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... strip rendering logic
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Draw line joints (only if conditions met)
</span><span style=color:#fa6e32>if</span><span> line_gizmo</span><span style=color:#ed9366>.</span><span>strip_vertex_count </span><span style=color:#ed9366>< </span><span style=color:#ff8f40>3 </span><span style=color:#ed9366>||</span><span> config</span><span style=color:#ed9366>.</span><span>line_joints </span><span style=color:#ed9366>== </span><span>GizmoLineJoint</span><span style=color:#ed9366>::</span><span>None {
</span><span>    </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>}
</span><span style=color:#abb0b6;font-style:italic>// ... joint rendering logic
</span></code></pre><p>This ensures that for each entity, the render layer check happens once, and both lines and joints are processed with consistent state.<h2 id=further-reading>Further Reading</h2><ol><li><strong>Bevy ECS System Scheduling</strong>: Understanding how Bevy schedules systems is crucial for this fix. The Bevy Book’s chapter on Scheduling explains how systems run and when they can access shared resources.<li><strong>Bevy Render Phases</strong>: The concept of render phases and how they organize draw calls is fundamental to understanding the rendering pipeline this PR modifies.<li><strong>Entity Component System Patterns</strong>: This fix exemplifies when to combine systems that operate on the same data vs. keeping them separate for modularity.<li><strong>Graphics Pipeline State Management</strong>: The PR touches on how render state (like which pipeline to use) needs to be consistent across related draw calls.</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22199.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>