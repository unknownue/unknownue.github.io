<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22166 `auto_rebuild_ui_navigation_graph` visibility fix
        
    </title><meta content="#22166 `auto_rebuild_ui_navigation_graph` visibility fix" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-17</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22166-zh-cn-20251217>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: <code>auto_rebuild_ui_navigation_graph</code> visibility fix<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22166<li><strong>Author</strong>: ickshonpe<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Input, A-UI, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-12-17T14:03:50Z<li><strong>Merged</strong>: 2025-12-17T18:53:09Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Fixes #22163<h2 id=solution>Solution</h2><ul><li>Schedule <code>auto_rebuild_ui_navigation_graph</code> after <code>VisibilityPropagate</code> so node visibility is up to date before it runs.<li>In <code>auto_rebuild_ui_navigation_graph</code> rebuild the navigation graphs on changes to <code>InheritedVisibility</code>.</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a bug in Bevy’s UI navigation system where hidden UI elements were incorrectly included in the navigation graph. The issue stems from a timing problem: the system that automatically rebuilds navigation graphs was running before visibility information had been fully propagated through the UI hierarchy.<h3 id=the-problem-and-context>The Problem and Context</h3><p>In Bevy’s UI system, <code>InheritedVisibility</code> components determine whether a UI element is visible by inheriting visibility state from parent elements. The <code>auto_rebuild_ui_navigation_graph</code> system was responsible for automatically generating navigation edges between focusable UI elements when certain components changed, but it had two issues:<ol><li><p><strong>Timing issue</strong>: The system ran in the <code>PostUpdate</code> schedule as part of <code>UiSystems::PostLayout</code>, but visibility propagation (<code>VisibilitySystems::VisibilityPropagate</code>) happens in the same schedule. Without explicit ordering, the navigation graph could be rebuilt using stale visibility data.</p><li><p><strong>Missing dependency</strong>: The system wasn’t monitoring changes to <code>InheritedVisibility</code>, so if only visibility changed (without changes to node geometry or transforms), the navigation graph wouldn’t update to reflect which elements were actually focusable.</p></ol><p>This resulted in hidden UI elements remaining in the navigation graph, which could break keyboard/gamepad navigation as users could navigate to invisible elements that shouldn’t be interactable.<h3 id=the-solution-approach>The Solution Approach</h3><p>The fix involved two coordinated changes to ensure visibility information is always up-to-date when building navigation graphs:<ol><li><p><strong>Schedule ordering</strong>: Explicitly schedule <code>auto_rebuild_ui_navigation_graph</code> to run after <code>VisibilitySystems::VisibilityPropagate</code>. This ensures that by the time navigation graphs are rebuilt, all UI elements have their correct <code>InheritedVisibility</code> values.</p><li><p><strong>Additional change detection</strong>: Add <code>Changed&LTInheritedVisibility></code> to the query that triggers navigation graph rebuilds. This ensures that visibility changes alone are sufficient to trigger a navigation graph update.</p></ol><h3 id=the-implementation>The Implementation</h3><p>The implementation simplifies the visibility checking logic while fixing both issues. Previously, the system had to check both <code>Visibility</code> and <code>InheritedVisibility</code> components, handling multiple cases of explicit and inherited visibility. The new approach relies entirely on <code>InheritedVisibility</code>, which represents the final computed visibility after propagation.<p>Here’s how the system query changed:<p><strong>Before</strong>: The query fetched optional <code>Visibility</code> and optional <code>InheritedVisibility</code> components, requiring complex conditional logic to determine actual visibility state.<p><strong>After</strong>: The query now requires <code>&InheritedVisibility</code> (non-optional), and the filtering logic simply checks <code>inherited_visibility.get()</code> for a boolean visibility result.<p>This simplification is possible because:<ul><li>By running after <code>VisibilityPropagate</code>, <code>InheritedVisibility</code> is guaranteed to be present and up-to-date<li><code>InheritedVisibility.get()</code> returns the final computed visibility after considering both local <code>Visibility</code> and inherited visibility</ul><p>The schedule ordering change uses Bevy’s system ordering API with <code>.after()</code> to explicitly depend on the visibility propagation system.<h3 id=technical-insights>Technical Insights</h3><p>This fix demonstrates important concepts in Bevy’s ECS architecture:<ol><li><p><strong>System ordering</strong>: Bevy’s scheduling system allows explicit dependencies between systems to ensure data dependencies are respected. Without explicit ordering, systems in the same set run in parallel when possible, which can lead to race conditions when one system depends on another’s output.</p><li><p><strong>Visibility propagation</strong>: Bevy uses a two-component system for visibility:</p> <ul><li><code>Visibility</code>: Local visibility state (Visible, Hidden, Inherited)<li><code>InheritedVisibility</code>: Computed visibility after propagation from parents The propagation happens in <code>VisibilityPropagate</code>, which updates <code>InheritedVisibility</code> based on the hierarchy.</ul><li><p><strong>Change detection</strong>: Bevy’s <code>Changed&LTT></code> query filter efficiently detects when components have been modified, allowing systems to run only when relevant data changes. Adding <code>Changed&LTInheritedVisibility></code> ensures the navigation system responds to visibility changes.</p></ol><h3 id=the-impact>The Impact</h3><p>These changes ensure that UI navigation graphs accurately reflect only visible, focusable elements. The fix:<ol><li><strong>Eliminates navigation to hidden elements</strong>: Users can no longer navigate to UI elements that are hidden via visibility settings.<li><strong>Simplifies visibility checking</strong>: The system now uses a single, authoritative source for visibility information.<li><strong>Maintains performance</strong>: By only rebuilding navigation graphs when necessary (including on visibility changes), unnecessary rebuilds are avoided.</ol><p>The fix is minimal and focused, changing only what’s necessary to solve the problem while simplifying the implementation. This approach reduces maintenance burden and makes the system’s behavior more predictable.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Visibility Propagation] --> B[Navigation Graph Rebuild]
</span><span>    C[Node Geometry Changes] --> B
</span><span>    D[Transform Changes] --> B
</span><span>    E[Visibility Changes] --> B
</span><span>    
</span><span>    subgraph "System Execution Order"
</span><span>        V[VisibilityPropagate] --> N[auto_rebuild_ui_navigation_graph]
</span><span>    end
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-input-focus-src-directional-navigation-rs-19-22><code>crates/bevy_input_focus/src/directional_navigation.rs</code> (+19/-22)</h3><p>This file contains the directional navigation system for UI elements. The changes fix visibility handling in automatic navigation graph generation.<p><strong>Key changes:</strong><ol><li><strong>Schedule ordering</strong>: Added explicit ordering to run after visibility propagation</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(
</span><span>    PostUpdate</span><span style=color:#61676ccc>,
</span><span>    auto_rebuild_ui_navigation_graph</span><span style=color:#ed9366>.</span><span style=color:#f07171>in_set</span><span>(UiSystems</span><span style=color:#ed9366>::</span><span>PostLayout)</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(
</span><span>    PostUpdate</span><span style=color:#61676ccc>,
</span><span>    auto_rebuild_ui_navigation_graph
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>in_set</span><span>(UiSystems</span><span style=color:#ed9366>::</span><span>PostLayout)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>after</span><span>(bevy_camera</span><span style=color:#ed9366>::</span><span>visibility</span><span style=color:#ed9366>::</span><span>VisibilitySystems</span><span style=color:#ed9366>::</span><span>VisibilityPropagate)</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><ol start=2><li><strong>Updated query triggers</strong>: Added <code>Changed&LTInheritedVisibility></code> to the change detection query</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>Or<(Added&LTAutoDirectionalNavigation>, Changed&LTComputedNode>, Changed&LTUiGlobalTransform>)></span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>Or<(
</span><span>    Added&LTAutoDirectionalNavigation>,
</span><span>    Changed&LTComputedNode>,
</span><span>    Changed&LTUiGlobalTransform>,
</span><span>    Changed&LTInheritedVisibility>,
</span><span>)></span><span style=color:#61676ccc>,
</span></code></pre><ol start=3><li><strong>Simplified node query</strong>: Removed optional visibility components, now requiring only <code>InheritedVisibility</code></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>(Entity</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>ComputedNode</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>UiGlobalTransform</span><span style=color:#61676ccc>, </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#ed9366>&</span><span>Visibility></span><span style=color:#61676ccc>, </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#ed9366>&</span><span>InheritedVisibility>)
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>(Entity</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>ComputedNode</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>UiGlobalTransform</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>InheritedVisibility)
</span></code></pre><ol start=4><li><strong>Simplified visibility checking</strong>: Replaced complex visibility logic with simple inherited visibility check</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#abb0b6;font-style:italic>// Skip hidden or zero-size nodes
</span><span style=color:#fa6e32>if</span><span> computed</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_empty</span><span>()
</span><span>    </span><span style=color:#ed9366>|| </span><span style=color:#f07171>matches!</span><span>(visibility</span><span style=color:#61676ccc>, </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(Visibility</span><span style=color:#ed9366>::</span><span>Hidden))
</span><span>    </span><span style=color:#ed9366>|| </span><span>(</span><span style=color:#f07171>matches!</span><span>(visibility</span><span style=color:#61676ccc>, </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(Visibility</span><span style=color:#ed9366>::</span><span>Inherited))
</span><span>        </span><span style=color:#ed9366>&& </span><span style=color:#f07171>matches!</span><span>(inherited_visibility</span><span style=color:#61676ccc>, </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#ed9366>&</span><span>InheritedVisibility</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>HIDDEN</span><span>)))
</span><span>{
</span><span>    </span><span style=color:#fa6e32>return </span><span style=color:#55b4d4;font-style:italic>None</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#abb0b6;font-style:italic>// Skip hidden or zero-size nodes
</span><span style=color:#fa6e32>if</span><span> computed</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_empty</span><span>() </span><span style=color:#ed9366>|| !</span><span>inherited_visibility</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>() {
</span><span>    </span><span style=color:#fa6e32>return </span><span style=color:#55b4d4;font-style:italic>None</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>These changes work together to ensure navigation graphs are always built with current visibility information, fixing the bug where hidden elements remained navigable.<h2 id=further-reading>Further Reading</h2><ol><li><p><strong>Bevy Visibility System</strong>: The <a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/render/view/visibility/index.html target=_blank>Bevy documentation on visibility</a> explains how visibility propagation works in the engine.</p><li><p><strong>System Scheduling in Bevy</strong>: The <a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/programming/systems.html target=_blank>Bevy system scheduling guide</a> covers system ordering, sets, and dependencies.</p><li><p><strong>UI Navigation in Bevy</strong>: The <a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/examples/ui/directional_navigation.rs target=_blank>Bevy UI navigation example</a> demonstrates how to use the directional navigation system.</p><li><p><strong>Change Detection in Bevy</strong>: The <a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/ecs/query/struct.Query.html#method.changed target=_blank>Bevy change detection documentation</a> explains how <code>Changed&LTT></code> filters work in queries.</p><li><p><strong>Issue #22163</strong>: The original bug report provides context on the specific problem this PR solves.</p></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22166.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>