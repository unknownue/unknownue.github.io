<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22098 text2d change detection fix
        
    </title><meta content="#22098 text2d change detection fix" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-12</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22098-zh-cn-20251212>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: text2d change detection fix<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22098<li><strong>Author</strong>: ickshonpe<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Performance, S-Ready-For-Final-Review, P-Regression, A-Text<li><strong>Created</strong>: 2025-12-12T19:47:17Z<li><strong>Merged</strong>: 2025-12-12T20:41:36Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><p><strong>Objective</strong><p>Fix performance regression caused by #22051 breaking text2d’s change detection.<p>Fixes #22099.<p><strong>Solution</strong><p>Set the text entity’s <code>ComputedTextBlock::needs_rerender</code> flag to false at the start of <code>update_text_buffer</code> and <code>update_text_layout_info</code>.<p><strong>Testing</strong><pre style=color:#61676c;background-color:#fafafa><code><span>cargo run --example many_text2d --release
</span></code></pre><p>should run about 400x main’s FPS<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a performance regression introduced by a previous change (#22051) that inadvertently broke the change detection mechanism for 2D text rendering. The issue manifested as severe performance degradation in text-heavy scenes, with the <code>many_text2d</code> example dropping to extremely low frame rates.<p>The root cause was a change detection feedback loop. In Bevy’s ECS architecture, systems track component changes to avoid unnecessary work. For text rendering, the <code>ComputedTextBlock</code> component contains a <code>needs_rerender</code> flag that indicates when text content requires re-rendering. The regression occurred because this flag wasn’t being properly reset during the text update pipeline.<p>The solution approach is straightforward but critical: ensure the <code>needs_rerender</code> flag is cleared at the beginning of the text processing functions. This prevents the system from continuously marking text for re-rendering every frame, even when no actual changes have occurred to the text content.<p>Looking at the implementation, the fix adds just two lines of code across two functions in <code>pipeline.rs</code>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// In update_text_buffer function
</span><span>computed</span><span style=color:#ed9366>.</span><span>needs_rerender </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>false</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// In update_text_layout_info function  
</span><span>computed</span><span style=color:#ed9366>.</span><span>needs_rerender </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>false</span><span style=color:#61676ccc>;
</span></code></pre><p>These lines are placed at the start of each function, immediately before any other processing. This placement ensures that the flag is cleared before the system checks whether actual text content has changed. If changes are detected during processing, the flag can be set to true again, triggering a proper re-render.<p>From a technical perspective, this fix demonstrates an important pattern in change detection systems: clearing change flags early in processing pipelines to prevent feedback loops. The <code>needs_rerender</code> flag functions as a form of dirty flag pattern. When text components are modified elsewhere in the system (like changing string content or font properties), they set <code>needs_rerender = true</code>. The text rendering pipeline then processes these changes and should clear the flag after completing the work. The regression occurred because the clearing wasn’t happening, causing the system to think text needed re-rendering every frame.<p>The impact of this fix is significant - restoring performance to approximately 400 times faster for the <code>many_text2d</code> example. This highlights how small changes to change detection logic can have dramatic performance implications in game engines, especially for frequently updated systems like text rendering.<p>This case also illustrates the importance of thorough testing for performance-sensitive changes. The original regression (#22051) likely passed functional tests but introduced a performance regression that only became apparent under load. The fix shows that proper maintenance of change detection state is critical for systems that run every frame.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Text Component Changed] --> B[needs_rerender = true]
</span><span>    B --> C[update_text_buffer/update_text_layout_info called]
</span><span>    C --> D{needs_rerender == true?}
</span><span>    D -->|Yes| E[Clear flag and process text]
</span><span>    D -->|No| F[Skip processing]
</span><span>    E --> G[Render updated text]
</span><span>    
</span><span>    subgraph "Regression Scenario"
</span><span>        H[Flag never cleared] --> I[Always processes]
</span><span>        I --> J[Performance degradation]
</span><span>    end
</span><span>    
</span><span>    subgraph "Fixed Scenario"
</span><span>        K[Flag cleared at start] --> L[Only processes when changed]
</span><span>        L --> M[Optimal performance]
</span><span>    end
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>crates/bevy_text/src/pipeline.rs</strong> (+4/-0)<p>This file contains the text rendering pipeline logic. The changes fix a performance regression by properly resetting change detection flags.<p><strong>Key modifications:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// File: crates/bevy_text/src/pipeline.rs
</span><span style=color:#abb0b6;font-style:italic>// Changes in update_text_buffer function:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>update_text_buffer</span><span>(
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>,
</span><span>    </span><span style=color:#ff8f40>computed</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> ComputedTextBlock,
</span><span>    </span><span style=color:#ff8f40>font_system</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> CosmicFontSystem,
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><(), TextError> {
</span><span>    computed</span><span style=color:#ed9366>.</span><span>needs_rerender </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>false</span><span style=color:#61676ccc>;  </span><span style=color:#abb0b6;font-style:italic>// Added line
</span><span>    
</span><span>    </span><span style=color:#fa6e32>let</span><span> font_system </span><span style=color:#ed9366>= &</span><span style=color:#fa6e32>mut</span><span> font_system</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... rest of the function
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Changes in update_text_layout_info function:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>update_text_layout_info</span><span>(
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>,
</span><span>    </span><span style=color:#ff8f40>layout_info</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> LayoutInfo,
</span><span>    </span><span style=color:#ff8f40>computed</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> ComputedTextBlock,
</span><span>    </span><span style=color:#ff8f40>bounds</span><span style=color:#61676ccc>:</span><span> TextBounds,
</span><span>    </span><span style=color:#ff8f40>justify</span><span style=color:#61676ccc>:</span><span> Justify,
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><(), TextError> {
</span><span>    computed</span><span style=color:#ed9366>.</span><span>needs_rerender </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>false</span><span style=color:#61676ccc>;  </span><span style=color:#abb0b6;font-style:italic>// Added line
</span><span>    
</span><span>    layout_info</span><span style=color:#ed9366>.</span><span>glyphs</span><span style=color:#ed9366>.</span><span style=color:#f07171>clear</span><span>()</span><span style=color:#61676ccc>;
</span><span>    layout_info</span><span style=color:#ed9366>.</span><span>run_geometry</span><span style=color:#ed9366>.</span><span style=color:#f07171>clear</span><span>()</span><span style=color:#61676ccc>;
</span><span>    layout_info</span><span style=color:#ed9366>.</span><span>size </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>Default</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... rest of the function
</span><span>}
</span></code></pre><p>These changes ensure that the <code>needs_rerender</code> flag is cleared at the beginning of text processing functions, preventing a feedback loop where text would be marked for re-rendering every frame regardless of actual changes. The placement at the start of each function is important - it clears any previous change flag before the function determines if new changes need to be processed.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_ecs/latest/bevy_ecs/change_detection/index.html target=_blank>Bevy ECS Change Detection Documentation</a> - Understanding Bevy’s change detection system<li><a rel="noopener nofollow noreferrer" href=https://gameprogrammingpatterns.com/dirty-flag.html target=_blank>Dirty Flag Pattern</a> - Common pattern for optimizing updates<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/tree/main/crates/bevy_text target=_blank>Bevy Text Rendering System</a> - Source code for Bevy’s text rendering<li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/ecs/system/trait.IntoSystem.html target=_blank>Performance Optimization in Game Engines</a> - Bevy’s system optimization patterns</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22098.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>