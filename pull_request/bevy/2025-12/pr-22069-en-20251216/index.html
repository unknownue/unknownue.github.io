<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22069 `spec_v2`: migrate CAS
        
    </title><meta content="#22069 `spec_v2`: migrate CAS" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-16</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22069-zh-cn-20251216>中文</a></div></div><div class=pr-content><h1 id=title-spec-v2-migrate-cas>Title: <code>spec_v2</code>: migrate CAS</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: <code>spec_v2</code>: migrate CAS<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22069<li><strong>Author</strong>: ecoskey<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, C-Code-Quality, S-Ready-For-Final-Review, D-Modest<li><strong>Created</strong>: 2025-12-09T04:34:04Z<li><strong>Merged</strong>: 2025-12-16T05:23:51Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>migrate CAS to <code>spec_v2</code></ul><h2 id=solution>Solution</h2><ul><li>compiles<li>do we have an example for this?</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This pull request migrates the Contrast Adaptive Sharpening (CAS) system in Bevy’s anti-aliasing module from the older specialized pipeline system to the newer <code>spec_v2</code> system. The migration is part of a broader effort to modernize Bevy’s rendering infrastructure by adopting more consistent and maintainable patterns across the codebase.<p>The core issue addressed here is maintaining consistency with other rendering systems in Bevy that have already migrated to <code>spec_v2</code>. The CAS system was still using the older <code>SpecializedRenderPipeline</code> approach, which created inconsistency and made the code harder to understand and maintain. The <code>spec_v2</code> system provides a more structured way to handle pipeline specialization with better error handling and a cleaner separation of concerns.<p>The developer’s approach was straightforward: replace the old <code>SpecializedRenderPipeline</code> implementation with the new <code>Specializer</code> trait and <code>Variants</code> system. This involved several key changes:<ol><li><strong>Removing the old specialized pipeline resource</strong>: The <code>SpecializedRenderPipelines&LTCasPipeline></code> resource was no longer needed and was removed from the render app setup.<li><strong>Restructuring the pipeline data</strong>: The <code>CasPipeline</code> struct was refactored to store a <code>Variants&LTRenderPipeline, CasPipelineSpecializer></code> instead of separate shader components and bind group layouts.<li><strong>Implementing the new Specializer trait</strong>: A new <code>CasPipelineSpecializer</code> struct was created to implement the <code>Specializer&LTRenderPipeline></code> trait, which handles the actual specialization logic based on the pipeline key.<li><strong>Updating the pipeline preparation system</strong>: The <code>prepare_cas_pipelines</code> function was updated to use the new <code>variants.specialize()</code> method and return a <code>Result</code> for better error handling.</ol><p>The technical implementation shows a clear pattern that other Bevy systems follow when migrating to <code>spec_v2</code>. The <code>Variants</code> system acts as a cache for pipeline variants, with the <code>Specializer</code> handling the conversion from a key to a specific pipeline configuration. This separation makes the code more testable and maintainable.<p>One notable aspect of this migration is how it handles shader specialization. In the old system, shader definitions were added to a vector during specialization. In the new system, the <code>fragment_mut()</code> method is used to access and modify the fragment state, including adding shader definitions and setting render targets. This provides a more structured way to modify pipeline configurations.<p>The migration also improves error handling. The <code>prepare_cas_pipelines</code> system now returns a <code>Result<(), BevyError></code>, which allows for proper error propagation. This is a significant improvement over the old system where errors might have been silently ignored.<p>From a performance perspective, this change maintains the same level of efficiency while providing better maintainability. The <code>Variants</code> system internally caches pipeline configurations, so there’s no performance penalty for the added abstraction layer.<p>The impact of this change is primarily internal: it makes the CAS system consistent with other Bevy rendering systems, reduces technical debt, and improves code quality. For users of the Bevy engine, the API remains the same—this is purely an internal refactoring.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[CasPlugin] --> B[init_cas_pipeline system]
</span><span>    A --> C[prepare_cas_pipelines system]
</span><span>    
</span><span>    B --> D[Creates CasPipeline resource]
</span><span>    D --> E[Variants&LTRenderPipeline, CasPipelineSpecializer>]
</span><span>    D --> F[BindGroupLayoutDescriptor]
</span><span>    D --> G[Sampler]
</span><span>    
</span><span>    C --> H[Queries for views with CasUniform]
</span><span>    C --> I[Uses Variants.specialize()]
</span><span>    I --> J[Produces pipeline ID]
</span><span>    J --> K[Inserts ViewCasPipeline component]
</span><span>    
</span><span>    E --> L[CasPipelineSpecializer]
</span><span>    L --> M[Specializer trait implementation]
</span><span>    M --> N[Modifies pipeline descriptor]
</span><span>    N --> O[Sets shader definitions and targets]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-anti-alias-src-contrast-adaptive-sharpening-mod-rs-54-41><code>crates/bevy_anti_alias/src/contrast_adaptive_sharpening/mod.rs</code> (+54/-41)</h3><p>This file contains the main changes for migrating CAS to <code>spec_v2</code>. The changes involve restructuring the pipeline management system to use the new <code>Variants</code> and <code>Specializer</code> patterns.<p><strong>Key modifications:</strong><ol><li><p><strong>Removed old specialized pipeline system imports and resources:</strong></p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>use </span><span>bevy_shader</span><span style=color:#ed9366>::</span><span>Shader</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>use </span><span>bevy_utils</span><span style=color:#ed9366>::</span><span>default</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// In Plugin implementation:
</span><span>render_app
</span><span>    </span><span style=color:#ed9366>.</span><span>init_resource</span><span style=color:#ed9366>::</span><span>&LTSpecializedRenderPipelines&LTCasPipeline>>()
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: (these lines removed)
</span></code></pre><li><p><strong>Restructured CasPipeline struct to use Variants:</strong></p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>CasPipeline </span><span>{
</span><span>    texture_bind_group</span><span style=color:#61676ccc>:</span><span> BindGroupLayoutDescriptor,
</span><span>    sampler</span><span style=color:#61676ccc>:</span><span> Sampler,
</span><span>    fullscreen_shader</span><span style=color:#61676ccc>:</span><span> FullscreenShader,
</span><span>    fragment_shader</span><span style=color:#61676ccc>: </span><span>Handle&LTShader>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>CasPipeline </span><span>{
</span><span>    layout</span><span style=color:#61676ccc>:</span><span> BindGroupLayoutDescriptor,
</span><span>    sampler</span><span style=color:#61676ccc>:</span><span> Sampler,
</span><span>    variants</span><span style=color:#61676ccc>: </span><span>Variants&LTRenderPipeline, CasPipelineSpecializer>,
</span><span>}
</span></code></pre><li><p><strong>Updated pipeline initialization to create Variants:</strong></p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> variants </span><span style=color:#ed9366>= </span><span>Variants</span><span style=color:#ed9366>::</span><span>new(
</span><span>    CasPipelineSpecializer</span><span style=color:#61676ccc>,
</span><span>    RenderPipelineDescriptor {
</span><span>        label</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#86b300>"contrast_adaptive_sharpening"</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>())</span><span style=color:#61676ccc>,
</span><span>        layout</span><span style=color:#61676ccc>: </span><span style=color:#f07171>vec!</span><span>[layout</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()]</span><span style=color:#61676ccc>,
</span><span>        vertex</span><span style=color:#61676ccc>:</span><span> fullscreen_shader</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_vertex_state</span><span>()</span><span style=color:#61676ccc>,
</span><span>        fragment</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(FragmentState {
</span><span>            shader</span><span style=color:#61676ccc>:</span><span> fragment_shader</span><span style=color:#61676ccc>,
</span><span>            </span><span style=color:#ed9366>..</span><span style=color:#55b4d4;font-style:italic>Default</span><span style=color:#ed9366>::</span><span>default()
</span><span>        })</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#ed9366>..</span><span style=color:#55b4d4;font-style:italic>Default</span><span style=color:#ed9366>::</span><span>default()
</span><span>    }</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><li><p><strong>Implemented new Specializer trait instead of SpecializedRenderPipeline:</strong></p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>impl </span><span>SpecializedRenderPipeline </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>CasPipeline </span><span>{
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Key </span><span style=color:#ed9366>=</span><span> CasPipelineKey</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>specialize</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>key</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Key) </span><span style=color:#61676ccc>-></span><span> RenderPipelineDescriptor {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// Old specialization logic
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>CasPipelineSpecializer</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>impl </span><span>Specializer&LTRenderPipeline> </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>CasPipelineSpecializer </span><span>{
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Key </span><span style=color:#ed9366>=</span><span> CasPipelineKey</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>specialize</span><span>(
</span><span>        </span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>,
</span><span>        </span><span style=color:#ff8f40>key</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Key,
</span><span>        </span><span style=color:#ff8f40>descriptor</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span>&LTRenderPipeline </span><span style=color:#ed9366>as</span><span> Specializable></span><span style=color:#ed9366>::</span><span>Descriptor,
</span><span>    ) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span>&LTCanonical<</span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Key>, BevyError> {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// New specialization logic using fragment_mut()
</span><span>    }
</span><span>}
</span></code></pre><li><p><strong>Updated pipeline preparation system to use Variants:</strong></p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>prepare_cas_pipelines</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>pipelines</span><span style=color:#61676ccc>: </span><span>ResMut&LTSpecializedRenderPipelines&LTCasPipeline>>,
</span><span>    </span><span style=color:#ff8f40>sharpening_pipeline</span><span style=color:#61676ccc>: </span><span>Res&LTCasPipeline>,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>let</span><span> pipeline_id </span><span style=color:#ed9366>=</span><span> pipelines</span><span style=color:#ed9366>.</span><span style=color:#f07171>specialize</span><span>(
</span><span>        </span><span style=color:#ed9366>&</span><span>pipeline_cache</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#ed9366>&</span><span>sharpening_pipeline</span><span style=color:#61676ccc>,
</span><span>        CasPipelineKey { </span><span style=color:#ed9366>... </span><span>}</span><span style=color:#61676ccc>,
</span><span>    )</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>prepare_cas_pipelines</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>sharpening_pipeline</span><span style=color:#61676ccc>: </span><span>ResMut&LTCasPipeline>,
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><(), BevyError> {
</span><span>    </span><span style=color:#fa6e32>let</span><span> pipeline_id </span><span style=color:#ed9366>=</span><span> sharpening_pipeline</span><span style=color:#ed9366>.</span><span>variants</span><span style=color:#ed9366>.</span><span style=color:#f07171>specialize</span><span>(
</span><span>        </span><span style=color:#ed9366>&</span><span>pipeline_cache</span><span style=color:#61676ccc>,
</span><span>        CasPipelineKey { </span><span style=color:#ed9366>... </span><span>}</span><span style=color:#61676ccc>,
</span><span>    )</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre></ol><h3 id=crates-bevy-anti-alias-src-contrast-adaptive-sharpening-node-rs-1-1><code>crates/bevy_anti_alias/src/contrast_adaptive_sharpening/node.rs</code> (+1/-1)</h3><p>This file contains a minor update to use the renamed <code>layout</code> field instead of <code>texture_bind_group</code>.<p><strong>Key modification:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#ed9366>&</span><span>pipeline_cache</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_bind_group_layout</span><span>(</span><span style=color:#ed9366>&</span><span>sharpening_pipeline</span><span style=color:#ed9366>.</span><span>texture_bind_group)</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#ed9366>&</span><span>pipeline_cache</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_bind_group_layout</span><span>(</span><span style=color:#ed9366>&</span><span>sharpening_pipeline</span><span style=color:#ed9366>.</span><span>layout)</span><span style=color:#61676ccc>,
</span></code></pre><p>This change is straightforward but important for maintaining consistency with the renamed field in the <code>CasPipeline</code> struct.<h2 id=further-reading>Further Reading</h2><ol><li><strong>Bevy Render Pipeline System</strong>: The Bevy book’s section on rendering and pipelines provides context for understanding how the rendering system works.<li><strong>Specialization in Graphics Pipelines</strong>: For background on why pipeline specialization is important in graphics programming, resources on modern graphics APIs (Vulkan, DirectX 12, Metal) discuss pipeline state objects and specialization constants.<li><strong>Contrast Adaptive Sharpening Algorithm</strong>: The original AMD FidelityFX CAS documentation explains the algorithm being implemented here.<li><strong>Bevy’s spec_v2 Migration</strong>: Other PRs in the Bevy repository that migrated systems to <code>spec_v2</code> can provide additional examples of this pattern.</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22069.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>