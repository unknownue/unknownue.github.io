<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21885 Prevent WebGL builds from crashing on startup when using FpsOverlayPlugin
        
    </title><meta content="#21885 Prevent WebGL builds from crashing on startup when using FpsOverlayPlugin" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-08</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2025-12/pr-21885-en-20251208>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=title-prevent-webgl-builds-from-crashing-on-startup-when-using-fpsoverlayplugin>Title: Prevent WebGL builds from crashing on startup when using FpsOverlayPlugin</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Prevent WebGL builds from crashing on startup when using FpsOverlayPlugin<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21885<li><strong>Author</strong>: it-me-joda<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, O-WebGL2, D-Straightforward, S-Waiting-on-Author<li><strong>Created</strong>: 2025-11-19T18:21:43Z<li><strong>Merged</strong>: 2025-12-08T12:19:16Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=miao-shu-fan-yi>描述翻译</h2><h3 id=mu-biao>目标</h3><ul><li>修复 #21362<li>FrameTimeGraph 使用的材质在 WebGL（而非 WebGPU）环境下会导致崩溃，即使 FrameTimeGraph 被禁用。我们需要在为 WASM 构建时阻止 FrameTimeGraph 被创建。</ul><h3 id=jie-jue-fang-an>解决方案</h3><ul><li>如果构建目标是为仅支持 WebGL 的 WASM，我们跳过 FrameTimeGraph 的创建。此外，如果 FrameTimeGraph 被启用，我们会提供一个警告来告知用户 FrameTimeGraph 在 WebGL 上不受支持。</ul><h3 id=ce-shi>测试</h3><ul><li>我使用了问题报告中提供的复现方法。</ul><h2 id=zhe-ge-prde-gu-shi>这个PR的故事</h2><p>这个PR解决了Bevy开发工具中一个直接影响WebGL平台稳定性的具体问题。用户报告称，在WebGL构建中启动游戏时，如果使用了 <code>FpsOverlayPlugin</code>，游戏会在启动时立即崩溃。值得注意的是，即使覆盖层配置中禁用了帧时间图（FrameTimeGraph），崩溃仍然会发生。<p>问题的根源在于 <code>FpsOverlayPlugin</code> 的初始化逻辑。在 <code>setup</code> 函数中，插件会无条件地为帧时间图创建一个 <code>FrametimeGraphMaterial</code> 材质。这个材质内部使用了 <code>ShaderStorageBuffer</code>，而 Shader Storage Buffer Object (SSBO) 在 WebGL 2.0 中是一个可选特性，并非所有环境都支持。因此，在仅支持WebGL的WASM构建中，尝试创建和使用此材质会导致WebGL上下文错误，进而引发崩溃。<p>从代码来看，之前的逻辑试图通过将UI节点的 <code>display</code> 属性设置为 <code>Display::None</code> 来处理禁用状态。然而，这只是在渲染时隐藏了节点，材质资源本身仍然被创建并添加到 <code>Assets&LTFrametimeGraphMaterial></code> 集合中。材质的创建和其内部缓冲区的初始化，在WebGL环境下就已经触发了不支持的API调用。<p>解决方案采用了条件编译（<code>#[cfg(...)]</code>）来从根本上避免在不受支持的环境中创建问题资源。核心逻辑添加在 <code>crates/bevy_dev_tools/src/fps_overlay.rs</code> 文件的 <code>setup</code> 函数中。<p>首先，代码检查构建目标是否为 <code>wasm32</code> 且未启用 <code>webgpu</code> 特性（这大致等同于“仅WebGL”环境）。如果满足此条件且用户试图启用帧时间图，则通过 <code>tracing::warn!</code> 宏记录一条警告信息，告知用户该功能不受支持。<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(</span><span style=color:#f29718>all</span><span>(target_arch </span><span style=color:#ed9366>= </span><span style=color:#86b300>"wasm32"</span><span style=color:#61676ccc>, </span><span style=color:#f29718>not</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"webgpu"</span><span>)))]
</span><span>{
</span><span>    </span><span style=color:#fa6e32>if</span><span> overlay_config</span><span style=color:#ed9366>.</span><span>frame_time_graph_config</span><span style=color:#ed9366>.</span><span>enabled {
</span><span>        </span><span style=color:#fa6e32>use </span><span>tracing</span><span style=color:#ed9366>::</span><span>warn</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#f07171>warn!</span><span>(</span><span style=color:#86b300>"Frame time graph is not supported with WebGL. Consider if WebGPU is viable for your usecase."</span><span>)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><p>其次，通过另一个条件编译块 <code>#[cfg(not(all(target_arch = "wasm32", not(feature = "webgpu"))))]</code>，将原本创建帧时间图UI节点和材质的所有逻辑包裹起来。这意味着，在“非仅WebGL”的环境下（例如原生目标、或启用WebGPU的WASM目标），原有逻辑正常执行；而在“仅WebGL”的WASM环境下，整个创建代码块被编译器完全移除，确保了相关的材质和缓冲区资源不会被初始化。<p>这是一个直接且有效的修复策略。它没有尝试在运行时动态检测WebGL对SSBO的支持（这可能复杂且不可靠），而是利用了Rust编译时特性系统和条件编译的优点，将不兼容的代码路径在构建阶段就排除掉。<p>为了使条件编译能够正常工作，PR还对Cargo.toml文件进行了必要的修改。在 <code>bevy_dev_tools</code> 的 <code>Cargo.toml</code> 中，新增了 <code>webgl</code> 和 <code>webgpu</code> 两个特性，它们分别依赖于 <code>bevy_render</code> crate 的对应特性。这允许开发者在选择渲染后端时，将选择传递到开发工具中。<pre class=language-toml data-lang=toml style=color:#61676c;background-color:#fafafa><code class=language-toml data-lang=toml><span>[</span><span style=color:#399ee6>features</span><span>]
</span><span style=color:#399ee6>webgl </span><span>= [</span><span style=color:#86b300>"bevy_render/webgl"</span><span>]
</span><span style=color:#399ee6>webgpu </span><span>= [</span><span style=color:#86b300>"bevy_render/webgpu"</span><span>]
</span></code></pre><p>接着，在 <code>bevy_internal</code> 的 <code>Cargo.toml</code> 中，将新定义的 <code>bevy_dev_tools?/webgl</code> 和 <code>bevy_dev_tools?/webgpu</code> 依赖分别添加到全局的 <code>webgl</code> 和 <code>webgpu</code> 特性集合中。这样，当用户通过 <code>bevy</code> 的 <code>features = ["webgl"]</code> 进行构建时，这个特性会自动传递给 <code>bevy_dev_tools</code>，从而激活其内部的 <code>webgl</code> 特性，使得条件编译能够做出正确的判断。<p>这个修复的直接影响是，WebGL构建不会再因为 <code>FpsOverlayPlugin</code> 而崩溃。对于需要帧时间图功能的WebGL用户，他们现在会收到一个明确的警告，而不是一个令人困惑的崩溃。从工程角度看，这个PR展示了如何利用Rust的条件编译来优雅地处理平台特定的功能限制。它也强调了在涉及图形API的代码中，资源创建本身（而不仅仅是资源使用）就可能触发平台兼容性问题，需要在设计插件初始化逻辑时仔细考虑。<h2 id=ke-shi-hua-biao-shi>可视化表示</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    subgraph “构建配置”
</span><span>        A[用户: cargo build --features webgl]
</span><span>        B[用户: cargo build --features webgpu]
</span><span>    end
</span><span>    
</span><span>    A --> C[bevy_internal/webgl 特性启用]
</span><span>    B --> D[bevy_internal/webgpu 特性启用]
</span><span>    
</span><span>    C --> E[bevy_dev_tools/webgl 特性启用]
</span><span>    D --> F[bevy_dev_tools/webgpu 特性启用]
</span><span>    
</span><span>    subgraph “条件编译路径”
</span><span>        E --> G{是 wasm32 且非 webgpu?}
</span><span>        F --> G
</span><span>        
</span><span>        G -->|是 仅WebGL| H[跳过创建 FrameTimeGraph]
</span><span>        G -->|否| I[正常创建 FrameTimeGraph]
</span><span>    end
</span></code></pre><h2 id=guan-jian-wen-jian-bian-geng>关键文件变更</h2><h3 id=1-crates-bevy-dev-tools-src-fps-overlay-rs-39-28>1. <code>crates/bevy_dev_tools/src/fps_overlay.rs</code> (+39/-28)</h3><p><strong>变更描述及原因</strong>：这是实现修复的核心文件。通过添加条件编译逻辑，在WebGL环境下阻止<code>FrameTimeGraph</code>及其关联材质的创建，从而避免使用不受支持的Shader Storage Buffer Object (SSBO)导致崩溃。<p><strong>关键代码修改</strong>：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 修改发生在 setup 函数内，原创建 FrameTimeGraph 的代码被条件编译块包裹。
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 新增：在仅WebGL环境下，如果用户启用了图形，则发出警告。
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(</span><span style=color:#f29718>all</span><span>(target_arch </span><span style=color:#ed9366>= </span><span style=color:#86b300>"wasm32"</span><span style=color:#61676ccc>, </span><span style=color:#f29718>not</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"webgpu"</span><span>)))]
</span><span>{
</span><span>    </span><span style=color:#fa6e32>if</span><span> overlay_config</span><span style=color:#ed9366>.</span><span>frame_time_graph_config</span><span style=color:#ed9366>.</span><span>enabled {
</span><span>        </span><span style=color:#fa6e32>use </span><span>tracing</span><span style=color:#ed9366>::</span><span>warn</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#f07171>warn!</span><span>(</span><span style=color:#86b300>"Frame time graph is not supported with WebGL. Consider if WebGPU is viable for your usecase."</span><span>)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span><span style=color:#abb0b6;font-style:italic>// 新增：仅在非仅WebGL环境下，才执行原有的创建逻辑。
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(</span><span style=color:#f29718>not</span><span>(</span><span style=color:#f29718>all</span><span>(target_arch </span><span style=color:#ed9366>= </span><span style=color:#86b300>"wasm32"</span><span style=color:#61676ccc>, </span><span style=color:#f29718>not</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"webgpu"</span><span>))))]
</span><span>{
</span><span>    </span><span style=color:#fa6e32>let</span><span> font_size </span><span style=color:#ed9366>=</span><span> overlay_config</span><span style=color:#ed9366>.</span><span>text_config</span><span style=color:#ed9366>.</span><span>font_size</span><span style=color:#61676ccc>;
</span><span>    p</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((
</span><span>        Node {
</span><span>            </span><span style=color:#abb0b6;font-style:italic>// ... 原有节点属性
</span><span>        }</span><span style=color:#61676ccc>,
</span><span>        Pickable</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>IGNORE</span><span style=color:#61676ccc>,
</span><span>        MaterialNode</span><span style=color:#ed9366>::</span><span>from(frame_time_graph_materials</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(FrametimeGraphMaterial {
</span><span>            values</span><span style=color:#61676ccc>:</span><span> buffers</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(ShaderStorageBuffer {
</span><span>                </span><span style=color:#abb0b6;font-style:italic>// ... 原有缓冲区初始化
</span><span>            })</span><span style=color:#61676ccc>,
</span><span>            config</span><span style=color:#61676ccc>: </span><span>FrameTimeGraphConfigUniform</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ed9366>...</span><span>)</span><span style=color:#61676ccc>,
</span><span>        }))</span><span style=color:#61676ccc>,
</span><span>        FrameTimeGraph</span><span style=color:#61676ccc>,
</span><span>    ))</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p><strong>与PR目标的关系</strong>：这个修改直接实现了“阻止创建”的目标，通过编译器确保有问题的代码不会出现在WebGL构建产物中。<h3 id=2-crates-bevy-dev-tools-cargo-toml-2-0>2. <code>crates/bevy_dev_tools/Cargo.toml</code> (+2/-0)</h3><p><strong>变更描述及原因</strong>：为<code>bevy_dev_tools</code> crate定义本地特性<code>webgl</code>和<code>webgpu</code>，使其能够感知并传播用户选择的渲染后端。<p><strong>关键代码修改</strong>：<pre class=language-toml data-lang=toml style=color:#61676c;background-color:#fafafa><code class=language-toml data-lang=toml><span>[</span><span style=color:#399ee6>features</span><span>]
</span><span style=color:#399ee6>bevy_ci_testing </span><span>= [</span><span style=color:#86b300>"serde"</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"ron"</span><span>]
</span><span style=color:#399ee6>webgl </span><span>= [</span><span style=color:#86b300>"bevy_render/webgl"</span><span>]  </span><span style=color:#abb0b6;font-style:italic># 新增行
</span><span style=color:#399ee6>webgpu </span><span>= [</span><span style=color:#86b300>"bevy_render/webgpu"</span><span>]  </span><span style=color:#abb0b6;font-style:italic># 新增行
</span></code></pre><p><strong>与PR目标的关系</strong>：使<code>fps_overlay.rs</code>中的条件编译<code>#[cfg(not(feature = "webgpu"))]</code>能够正常工作，依赖<code>bevy_render</code>的对应特性来确定当前激活的后端。<h3 id=3-crates-bevy-internal-cargo-toml-2-0>3. <code>crates/bevy_internal/Cargo.toml</code> (+2/-0)</h3><p><strong>变更描述及原因</strong>：将<code>bevy_dev_tools</code>的新特性整合到<code>bevy</code>主crate的全局特性集合中，确保用户选择<code>bevy</code>的<code>webgl</code>或<code>webgpu</code>特性时，能正确传递到开发工具模块。<p><strong>关键代码修改</strong>：<pre class=language-toml data-lang=toml style=color:#61676c;background-color:#fafafa><code class=language-toml data-lang=toml><span style=color:#399ee6>webgl </span><span>= [
</span><span>  </span><span style=color:#abb0b6;font-style:italic># ... 其他依赖
</span><span>  </span><span style=color:#86b300>"bevy_dev_tools?/webgl"</span><span style=color:#61676ccc>,  </span><span style=color:#abb0b6;font-style:italic># 新增行
</span><span>]
</span><span>
</span><span style=color:#399ee6>webgpu </span><span>= [
</span><span>  </span><span style=color:#abb0b6;font-style:italic># ... 其他依赖
</span><span>  </span><span style=color:#86b300>"bevy_dev_tools?/webgpu"</span><span style=color:#61676ccc>,  </span><span style=color:#abb0b6;font-style:italic># 新增行
</span><span>]
</span></code></pre><p><strong>与PR目标的关系</strong>：确保了整个特性依赖链的完整性，使最终用户无需关心内部crate的细节，只需通过<code>bevy</code>的特性即可控制所有相关模块的行为。<h2 id=yan-shen-yue-du>延伸阅读</h2><ol><li><strong>WebGL 2.0 规范与可选特性</strong>：了解为什么SSBO在WebGL中是可选的，有助于理解此类平台兼容性问题的根本原因。可以查阅<a rel="noopener nofollow noreferrer" href=https://www.khronos.org/registry/webgl/specs/latest/2.0/ target=_blank>WebGL 2.0 Specification</a>中关于可选扩展的部分。<li><strong>Rust 条件编译 (<code>#[cfg]</code>)</strong>：Rust官方文档中关于<a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/reference/conditional-compilation.html target=_blank>条件编译</a>的章节，详细解释了如何基于目标平台、特性等条件来包含或排除代码。<li><strong>Cargo 特性与特性传播</strong>：Cargo手册中关于<a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/cargo/reference/features.html target=_blank>特性</a>的部分，解释了如何定义特性、指定依赖关系以及特性如何在工作区中传递。这对于管理复杂项目的跨平台构建配置至关重要。<li><strong>Bevy 渲染后端抽象</strong>：可以通过Bevy的源码了解其如何抽象不同的渲染后端（如WebGL、WebGPU、Vulkan、DirectX等），以及插件如何适配这些后端。这有助于设计更具普适性的跨平台代码。</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_21885.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>