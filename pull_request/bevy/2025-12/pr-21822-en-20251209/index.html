<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21822 Remove `bevy_ptr::dangling_with_align()` and inline it
        
    </title><meta content="#21822 Remove `bevy_ptr::dangling_with_align()` and inline it" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-09</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-21822-zh-cn-20251209>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Remove <code>bevy_ptr::dangling_with_align()</code> and inline it<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21822<li><strong>Author</strong>: BD103<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Code-Quality, S-Ready-For-Final-Review, M-Migration-Guide, A-Pointers, D-Straightforward, D-Unsafe<li><strong>Created</strong>: 2025-11-13T01:04:03Z<li><strong>Merged</strong>: 2025-12-09T05:34:27Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li><code>bevy_ptr::dangling_with_align()</code> is only used once, in <code>bevy_ecs</code>’s <code>BlobArray::with_capacity()</code>, and it isn’t generally useful outside of the engine’s internals. We can remove the function and inline its implementation into its call site.<li>Additionally, <code>bevy_ptr::dangling_with_align()</code> has a TODO comment that was leftover from https://github.com/bevyengine/bevy/pull/15311#discussion_r1768091379, where it was suggested that <code>dangling_with_align()</code> should use <code>without_provenance()</code>. <ul><li><code>with_addr()</code>, mentioned in the TODO comment, could also be used, but it’s a more roundabout solution. The reason it was mentioned was because the original author thought it would be stabilized before <code>without_provenance()</code>.</ul></ul><h2 id=solution>Solution</h2><ul><li>Remove <code>dangling_with_align()</code>.<li>Replace its usage with <code>NonNull::without_provenance()</code> (since it is now stable and doesn’t require <code>unsafe</code> or pointer math)</ul><h2 id=testing>Testing</h2><ul><li>I ran Miri with strict provenance checking enabled to ensure the behavior is maintained. <ul><li><code>MIRIFLAGS="-Zmiri-strict-provenance" cargo +nightly miri test</code></ul></ul><h2 id=but-what-is-this-provenance-thingy>But what is this provenance thingy?</h2><p><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/stable/std/ptr/index.html#provenance target=_blank>The official docs provide a more in-depth explanation</a>, but basically a pointer is more than just a number referring to a memory address. Pointers have <em>permissions</em> associated with them that track:<ul><li>What set of memory addresses are allowed to be accessed<li>When the pointer is allowed to access those addresses<li>If the pointer is allowed to mutate the memory, or just read it</ul><p>These permissions are pointer provenance. They aren’t stored at runtime, the Rust compiler doesn’t know them at compile time! Miri is the only tool that I know of that tracks provenance, which it uses to ensure pointers adheres to their spatial, temporal, and mutability permissions. That’s why I mentioned Miri in the Testing section. :)<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a straightforward code quality issue. The <code>bevy_ptr::dangling_with_align()</code> function had limited utility—it was only called from one location within the Bevy codebase. When a function has a single caller, inlining it can simplify the API surface and reduce maintenance overhead.<p>The original implementation of <code>dangling_with_align()</code> used manual pointer arithmetic to create a non-null pointer with a specific alignment:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>unsafe </span><span>{ NonNull</span><span style=color:#ed9366>::</span><span>new_unchecked(ptr</span><span style=color:#ed9366>::</span><span>null_mut</span><span style=color:#ed9366>::</span><span><</span><span style=color:#fa6e32>u8</span><span>>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>wrapping_add</span><span>(align</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>())) }
</span></code></pre><p>This approach worked but required <code>unsafe</code> code and was essentially a workaround. The function even contained a TODO comment referencing a desire to use <code>NonNull::with_addr()</code> once it stabilized, as noted in a previous PR discussion.<p>Between the time the function was written and this PR, Rust 1.89 stabilized <code>NonNull::without_provenance()</code>. This method provides a standardized, safe way to create a dangling pointer with a given alignment, making the custom implementation unnecessary.<p>The developer recognized this opportunity and made two key changes:<ol><li>Removed the <code>dangling_with_align()</code> function entirely from <code>bevy_ptr</code><li>Replaced its single usage in <code>BlobArray::with_capacity()</code> with <code>NonNull::without_provenance(align)</code></ol><p>The update required bumping the minimum supported Rust version (MSRV) from 1.88.0 to 1.89.0, as <code>without_provenance()</code> wasn’t stable until Rust 1.89. This version bump is reflected in both the root <code>Cargo.toml</code> and <code>bevy_ecs</code>’s <code>Cargo.toml</code>.<p>To validate the change, the developer ran Miri tests with strict provenance checking enabled. This was important because the new method explicitly deals with pointer provenance—the set of permissions that define what memory a pointer can access, when, and how. While provenance is a compile-time concept that Rust’s compiler doesn’t track at runtime, Miri can simulate it to catch potential pointer misuse. The tests passing confirmed that the new implementation maintains correct behavior.<p>The PR also includes unrelated cleanup in <code>bevy_error.rs</code> where conditional checks were simplified using Rust’s <code>if let</code> chaining syntax (<code>if let ... && ...</code>). While not directly related to the main change, this demonstrates good code hygiene—addressing minor quality issues when touching nearby code.<p>From an engineering perspective, this change demonstrates several good practices:<ul><li>Removing single-use utility functions to reduce API surface area<li>Replacing custom <code>unsafe</code> implementations with standardized, safe alternatives when they become available<li>Properly testing pointer-related changes with appropriate tools (Miri)<li>Maintaining clear documentation through migration guides</ul><p>The migration guide provides a straightforward upgrade path for any external users who might have been using this internal function, though its single usage suggests it was primarily an internal API.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[bevy_ptr::dangling_with_align] -- Used by --> B[BlobArray::with_capacity]
</span><span>    B -- Replaced with --> C[NonNull::without_provenance]
</span><span>    D[Rust 1.89 MSRV] -- Enables --> C
</span><span>    E[Custom unsafe implementation] -- Replaced by --> C
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=1-crates-bevy-ptr-src-lib-rs-0-11>1. <code>crates/bevy_ptr/src/lib.rs</code> (+0/-11)</h3><p><strong>Change</strong>: Complete removal of the <code>dangling_with_align()</code> function. <strong>Why</strong>: The function was only used once and could be replaced with a stable standard library method.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#abb0b6;font-style:italic>/// Creates a dangling pointer with specified alignment.
</span><span style=color:#abb0b6;font-style:italic>/// See [`NonNull::dangling`].
</span><span style=color:#fa6e32>pub const fn </span><span style=color:#f29718>dangling_with_align</span><span>(</span><span style=color:#ff8f40>align</span><span style=color:#61676ccc>:</span><span> NonZeroUsize) </span><span style=color:#61676ccc>-> </span><span>NonNull<</span><span style=color:#fa6e32>u8</span><span>> {
</span><span>    </span><span style=color:#f07171>debug_assert!</span><span>(align</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_power_of_two</span><span>()</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"Alignment must be power of two."</span><span>)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// SAFETY: The pointer will not be null, since it was created
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// from the address of a `NonZero&LTusize>`.
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// TODO: use https://doc.rust-lang.org/std/ptr/struct.NonNull.html#method.with_addr once stabilized
</span><span>    </span><span style=color:#fa6e32>unsafe </span><span>{ NonNull</span><span style=color:#ed9366>::</span><span>new_unchecked(ptr</span><span style=color:#ed9366>::</span><span>null_mut</span><span style=color:#ed9366>::</span><span><</span><span style=color:#fa6e32>u8</span><span>>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>wrapping_add</span><span>(align</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>())) }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#abb0b6;font-style:italic>// Function completely removed
</span></code></pre><h3 id=2-crates-bevy-ecs-src-storage-blob-array-rs-4-1>2. <code>crates/bevy_ecs/src/storage/blob_array.rs</code> (+4/-1)</h3><p><strong>Change</strong>: Replaced the call to <code>dangling_with_align()</code> with <code>NonNull::without_provenance()</code>. <strong>Why</strong>: Uses the now-stable standard library method instead of a custom implementation.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> data </span><span style=color:#ed9366>= </span><span>bevy_ptr</span><span style=color:#ed9366>::</span><span>dangling_with_align(align)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#abb0b6;font-style:italic>// Create a dangling pointer with the given alignment.
</span><span style=color:#fa6e32>let</span><span> data </span><span style=color:#ed9366>= </span><span>NonNull</span><span style=color:#ed9366>::</span><span>without_provenance(align)</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=3-release-content-migration-guides-remove-dangling-with-align-md-14-0>3. <code>release-content/migration-guides/remove_dangling_with_align.md</code> (+14/-0)</h3><p><strong>Change</strong>: Added a new migration guide document. <strong>Why</strong>: To document the removal for users who might have been using this internal API.<pre class=language-markdown data-lang=markdown style=color:#61676c;background-color:#fafafa><code class=language-markdown data-lang=markdown><span style=color:#abb0b6;background-color:#61676c10;font-weight:700>---
</span><span>title: Remove </span><span style=color:#ed9366;background-color:#61676c10>`bevy::ptr::dangling_with_align()`</span><span>
</span><span>pull_requests: [21822]
</span><span style=color:#fa6e32;font-weight:700>---
</span><span>
</span><span style=color:#ed9366;background-color:#61676c10>`bevy::ptr::dangling_with_align()`</span><span> has been removed. Use </span><span style=color:#ed9366;background-color:#61676c10>`NonNull::without_provenance()`</span><span> instead:
</span><span>
</span><span>// Code example showing migration...
</span></code></pre><h3 id=4-cargo-toml-and-crates-bevy-ecs-cargo-toml-1-1-each>4. <code>Cargo.toml</code> and <code>crates/bevy_ecs/Cargo.toml</code> (+1/-1 each)</h3><p><strong>Change</strong>: Updated Rust version requirement from 1.88.0 to 1.89.0. <strong>Why</strong>: <code>NonNull::without_provenance()</code> was stabilized in Rust 1.89.0.<h3 id=5-crates-bevy-ecs-src-error-bevy-error-rs-16-16>5. <code>crates/bevy_ecs/src/error/bevy_error.rs</code> (+16/-16)</h3><p><strong>Change</strong>: Refactored conditionals to use <code>if let</code> chaining syntax. <strong>Why</strong>: Unrelated cleanup that improves code readability while modifying the file.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(line) </span><span style=color:#ed9366>=</span><span> lines</span><span style=color:#ed9366>.</span><span style=color:#f07171>peek</span><span>() {
</span><span>    </span><span style=color:#fa6e32>if </span><span style=color:#ed9366>&</span><span>line[</span><span style=color:#ff8f40>6</span><span style=color:#ed9366>..</span><span>] </span><span style=color:#ed9366>== </span><span style=color:#86b300>"std::backtrace::Backtrace::create" </span><span>{
</span><span>        skip </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>true</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(line) </span><span style=color:#ed9366>=</span><span> lines</span><span style=color:#ed9366>.</span><span style=color:#f07171>peek</span><span>()
</span><span>    </span><span style=color:#ed9366>&& &</span><span>line[</span><span style=color:#ff8f40>6</span><span style=color:#ed9366>..</span><span>] </span><span style=color:#ed9366>== </span><span style=color:#86b300>"std::backtrace::Backtrace::create"
</span><span>{
</span><span>    skip </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>true</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/stable/std/ptr/index.html#provenance target=_blank>Rust Documentation: Pointer Provenance</a> - Official explanation of pointer provenance<li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/stable/std/ptr/struct.NonNull.html#method.without_provenance target=_blank>NonNull::without_provenance() documentation</a> - API reference for the replacement method<li><a rel="noopener nofollow noreferrer" href=https://github.com/rust-lang/miri target=_blank>Miri: Rust’s MIR Interpreter</a> - Tool used for testing pointer-related code<li><a rel="noopener nofollow noreferrer" href=https://blog.rust-lang.org/2025/01/16/Rust-1.89.0.html target=_blank>Rust 1.89.0 Release Notes</a> - Details about stabilization of <code>without_provenance()</code></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_21822.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>