<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22061 Fix flaky asset test, adds todo for a real fix
        
    </title><meta content="#22061 Fix flaky asset test, adds todo for a real fix" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-08</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22061-zh-cn-20251208>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix flaky asset test, adds todo for a real fix<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22061<li><strong>Author</strong>: kfc35<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: D-Trivial, A-Assets, S-Ready-For-Final-Review, C-Testing<li><strong>Created</strong>: 2025-12-08T03:51:18Z<li><strong>Merged</strong>: 2025-12-08T05:18:37Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Unblock pull requests and merges from the failings of this flaky asset test<li>Fixes the flakiness described in #22001</ul><h2 id=solution>Solution</h2><p>Change the assertion to accept both 2 and 3. Add an explaination why, and add a todo to resolve the underlying issue.<p>FYI @andriyDev since I don’t yet feel comfortable messing with the locks, just figured I’d throw this up to reduce confusion about failing builds in the meantime<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This pull request addresses a flaky test in Bevy’s asset processing system that was intermittently failing and blocking development workflows. The issue was reported in #22001 and manifested as non-deterministic test failures in CI pipelines.<p>The test in question, <code>only_reprocesses_wrong_hash_on_startup</code>, verifies that the asset processor correctly handles reprocessing of assets when restarting with modified sources. Specifically, it ensures that only assets with changed sources or changed dependencies get reprocessed, while others maintain their cached hashes. The test uses a mock transformer that counts how many times assets are processed, expecting exactly 2 processing events.<p>However, due to a race condition in the concurrent asset processing system, the <code>dep_changed_asset</code> could be processed twice instead of once - once during initial processing and once when its dependency triggers a re-processing. This non-deterministic behavior caused the test assertion to fail intermittently when it encountered 3 processing events instead of the expected 2.<p>The developer took a pragmatic approach to unblock development workflows. Instead of attempting to fix the underlying concurrency issue immediately (which would require deeper understanding of the locking mechanisms), they adjusted the test assertion to accept both 2 and 3 processing events. This acknowledges the reality of the current implementation while clearly documenting the issue for future resolution.<p>The key insight in this fix is recognizing that the test’s fundamental purpose - verifying that only changed assets get reprocessed - remains valid regardless of whether the reprocessing happens once or twice for the <code>dep_changed_asset</code>. The race condition affects the count but not the correctness of which assets get reprocessed.<p>By adding a comprehensive TODO comment with explicit explanation of why the race condition occurs (“when the initial processing of an asset and the re-processing that its dependency triggers are both able to proceed”), the PR ensures that future developers understand the root cause and can implement a proper fix when ready.<p>This approach demonstrates good engineering judgment: prioritizing unblocking development with a minimal, well-documented change while clearly marking technical debt for future resolution. The solution balances immediate practical needs with long-term maintainability by making the issue visible and understandable to anyone working on the asset processing system.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Flaky Test] --> B{Conditional Failure}
</span><span>    B -->|2 processing events| C[Test Passes]
</span><span>    B -->|3 processing events| D[Test Fails]
</span><span>    
</span><span>    E[Race Condition] --> F{dep_changed_asset processing}
</span><span>    F --> G[Initial processing]
</span><span>    F --> H[Dependency-triggered re-processing]
</span><span>    G & H --> I[Potential double-counting]
</span><span>    
</span><span>    J[PR Fix] --> K[Update Assertion]
</span><span>    K --> L[Accept 2 or 3]
</span><span>    L --> M[Add TODO Comment]
</span><span>    M --> N[Document Race Condition]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>File: <code>crates/bevy_asset/src/processor/tests.rs</code></strong><p><strong>Change Summary:</strong> Modified a flaky test assertion to accept both 2 and 3 processing events instead of only 2, with added documentation explaining the race condition.<p><strong>Before:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#f07171>assert_eq!</span><span>(
</span><span>    </span><span style=color:#ed9366>*</span><span>transformer</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0.</span><span style=color:#f07171>lock</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_or_else</span><span>(PoisonError</span><span style=color:#ed9366>::</span><span>into_inner)</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#ff8f40>2
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><p><strong>After:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let</span><span> num_processes </span><span style=color:#ed9366>= *</span><span>transformer</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0.</span><span style=color:#f07171>lock</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_or_else</span><span>(PoisonError</span><span style=color:#ed9366>::</span><span>into_inner)</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// TODO: assert_eq! (num_processes == 2) only after we prevent double processing assets
</span><span style=color:#abb0b6;font-style:italic>// == 3 happens when the initial processing of an asset and the re-processing that its dependency
</span><span style=color:#abb0b6;font-style:italic>// triggers are both able to proceed. (dep_changed_asset in this case is processed twice)
</span><span style=color:#f07171>assert!</span><span>(num_processes </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>2 </span><span style=color:#ed9366>||</span><span> num_processes </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>3</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><p><strong>Rationale:</strong> The test was failing intermittently due to a race condition where an asset (<code>dep_changed_asset</code>) could be processed twice - once during initial processing and once when its dependency triggers re-processing. Instead of trying to fix the underlying concurrency issue immediately, the PR makes the test robust to this non-deterministic behavior while clearly documenting the issue for future resolution.<h2 id=further-reading>Further Reading</h2><ol><li><strong>Bevy Asset System Documentation</strong>: https://bevyengine.org/learn/quick-start/assets/<li><strong>Rust Concurrency Patterns</strong>: Understanding Rust’s ownership model and concurrency primitives (Mutex, Arc, etc.) is crucial for fixing race conditions like this one<li><strong>Test Flakiness in CI/CD</strong>: This PR demonstrates a common pattern for handling flaky tests - making assertions more flexible while documenting the underlying issue<li><strong>Bevy Issue #22001</strong>: The original issue report that documented the flaky test behavior</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22061.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>