<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20279 UI material z-offset override
        
    </title><meta content="#20279 UI material z-offset override" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-08</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-20279-zh-cn-20251208>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: UI material z-offset override<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20279<li><strong>Author</strong>: ickshonpe<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Feature, D-Trivial, A-UI, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-07-25T00:15:31Z<li><strong>Merged</strong>: 2025-12-08T21:55:16Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>In #20237 the swatch implementation uses a child node to display the foreground color because UI materials have a higher local z offset than everything else.<h2 id=solution>Solution</h2><p>Add a <code>stack_z_offset</code> function to the <code>UiMaterial</code> trait that can be overriden to set a custom z-offset.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a specific rendering ordering issue in Bevy’s UI system. The problem emerged from PR #20237, which implemented a swatch UI component. The developer encountered an issue where UI materials always render with a higher z-offset than regular UI elements, making it impossible to layer child nodes on top of material-based parent elements within the same UI hierarchy.<p>The core issue was architectural: UI materials use a fixed z-offset value (<code>stack_z_offsets::MATERIAL</code>) that places them above all other UI elements in the rendering order. This fixed offset was hardcoded in the rendering pipeline, making it impossible for custom UI materials to control their rendering depth relative to their child nodes.<p>The developer took a clean, minimal approach by adding configurability at the trait level. Rather than changing the rendering pipeline to support dynamic offsets or introducing complex configuration systems, they extended the <code>UiMaterial</code> trait with a new method <code>stack_z_offset()</code> that returns the z-offset for that material type. This maintains the existing default behavior while allowing materials to override the offset when needed.<p>The implementation demonstrates a classic Rust pattern: adding a default trait method that can be overridden by implementors. The <code>UiMaterial</code> trait already had several default methods for shader configuration, so this fits naturally into the existing design. The key insight was that by making this a static method (called with <code>M::stack_z_offset()</code>), each material type can define its own constant offset, maintaining compile-time determinism while providing flexibility.<p>In <code>ui_material.rs</code>, the new trait method provides the default implementation that returns the existing constant:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>fn </span><span style=color:#f29718>stack_z_offset</span><span>() </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>f32 </span><span>{
</span><span>    </span><span style=color:#fa6e32>crate</span><span style=color:#ed9366>::</span><span>stack_z_offsets</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>MATERIAL
</span><span>}
</span></code></pre><p>The real impact comes in <code>ui_material_pipeline.rs</code>, where the rendering system uses this method instead of the hardcoded constant:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>sort_key</span><span style=color:#61676ccc>:</span><span> FloatOrd(extracted_uinode</span><span style=color:#ed9366>.</span><span>stack_index </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32 </span><span style=color:#ed9366>+ </span><span>stack_z_offsets</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>MATERIAL</span><span>)</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>sort_key</span><span style=color:#61676ccc>:</span><span> FloatOrd(extracted_uinode</span><span style=color:#ed9366>.</span><span>stack_index </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32 </span><span style=color:#ed9366>+ </span><span>M</span><span style=color:#ed9366>::</span><span>stack_z_offset())</span><span style=color:#61676ccc>,
</span></code></pre><p>This change is subtle but powerful. It allows UI material authors to control their rendering order relative to child nodes, which was previously impossible. For the swatch example from PR #20237, this means the foreground color can now be implemented directly within the material rather than requiring a separate child node, simplifying the UI hierarchy and improving performance.<p>The solution is elegant because it maintains backward compatibility—existing materials continue to work without modification—while solving a real-world problem that was forcing developers to create workarounds. It also follows Rust’s philosophy of making zero-cost abstractions: the trait method call is statically resolved at compile time, so there’s no runtime overhead compared to the previous hardcoded constant.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[UiMaterial Trait] --> B[stack_z_offset method]
</span><span>    B --> C[Default: returns MATERIAL constant]
</span><span>    B --> D[Can be overridden by implementors]
</span><span>    E[Render Pipeline] --> F[Uses M::stack_z_offset()]
</span><span>    F --> G[Controls rendering order]
</span><span>    G --> H[Enables proper layering with child nodes]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ui-render-src-ui-material-rs-4-0><code>crates/bevy_ui_render/src/ui_material.rs</code> (+4/-0)</h3><ol><li><strong>What changed</strong>: Added a new <code>stack_z_offset()</code> method to the <code>UiMaterial</code> trait with a default implementation that returns the existing <code>MATERIAL</code> constant.<li><strong>Why</strong>: To provide a way for UI materials to customize their z-offset for rendering order.<li><strong>Code snippet</strong>:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>fn </span><span style=color:#f29718>stack_z_offset</span><span>() </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>f32 </span><span>{
</span><span>    </span><span style=color:#fa6e32>crate</span><span style=color:#ed9366>::</span><span>stack_z_offsets</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>MATERIAL
</span><span>}
</span></code></pre><h3 id=crates-bevy-ui-render-src-ui-material-pipeline-rs-1-1><code>crates/bevy_ui_render/src/ui_material_pipeline.rs</code> (+1/-1)</h3><ol><li><strong>What changed</strong>: Modified the rendering pipeline to use the trait method <code>M::stack_z_offset()</code> instead of the hardcoded constant <code>stack_z_offsets::MATERIAL</code>.<li><strong>Why</strong>: To allow each material type to control its own z-offset, enabling proper layering with child UI nodes.<li><strong>Code snippet</strong>:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>sort_key</span><span style=color:#61676ccc>:</span><span> FloatOrd(extracted_uinode</span><span style=color:#ed9366>.</span><span>stack_index </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32 </span><span style=color:#ed9366>+ </span><span>stack_z_offsets</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>MATERIAL</span><span>)</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>sort_key</span><span style=color:#61676ccc>:</span><span> FloatOrd(extracted_uinode</span><span style=color:#ed9366>.</span><span>stack_index </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32 </span><span style=color:#ed9366>+ </span><span>M</span><span style=color:#ed9366>::</span><span>stack_z_offset())</span><span style=color:#61676ccc>,
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_ui_render/latest/bevy_ui_render/ target=_blank>Bevy UI Rendering Documentation</a> - For understanding the UI rendering pipeline<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/next/features/materials/ target=_blank>Bevy Materials System</a> - General information about Bevy’s material system<li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/book/ch10-02-traits.html target=_blank>Rust Trait Default Methods</a> - For understanding how default trait methods work<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/pull/20237 target=_blank>PR #20237</a> - The original swatch implementation that motivated this change</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_20279.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>