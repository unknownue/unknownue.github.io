<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22240 Solari: Fix bug with wrong viewport size under DLSS
        
    </title><meta content="#22240 Solari: Fix bug with wrong viewport size under DLSS" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-29</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22240-zh-cn-20251229>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Solari: Fix bug with wrong viewport size under DLSS<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22240<li><strong>Author</strong>: JMS55<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, S-Ready-For-Final-Review, D-Straightforward<li><strong>Created</strong>: 2025-12-23T00:48:34Z<li><strong>Merged</strong>: 2025-12-29T04:57:08Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>Fix https://github.com/bevyengine/bevy/issues/22200<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a specific bug in the Solari rendering system related to how the viewport dimensions were being accessed during temporal reprojection when DLSS (Deep Learning Super Sampling) is active. The issue manifested as incorrect sampling behavior in the ReSTIR (ReSTIR 指 Resampled Temporal Importance Resampling, 是一种路径采样技术) DI (Direct Illumination) and GI (Global Illumination) passes.<p>The core problem was a mismatch between the viewport size used for pixel permutation and the actual render target size. The Solari system uses a technique called “permuted sampling” to reduce temporal noise. This technique requires knowing the exact dimensions of the render target to correctly map pixel coordinates. The bug occurred because the code was using <code>view.viewport.zw</code> (which represents the full window/viewport size) instead of <code>view.main_pass_viewport.zw</code> (which represents the size of the actual main render pass target, which can be different when upscaling techniques like DLSS or FSR are active).<p>When DLSS is enabled, the engine renders at a lower internal resolution and then upscales. The <code>main_pass_viewport</code> correctly reflects this internal render target size, while the generic <code>viewport</code> might still reflect the final output/window size. Using the wrong size in the <code>permute_pixel</code> function would cause the permutation to index pixels outside the valid range of the render target, leading to incorrect temporal data being fetched and visual artifacts.<p>The fix is straightforward but important: change three occurrences of <code>view.viewport.zw</code> to <code>view.main_pass_viewport.zw</code> in the relevant shader files. This ensures the pixel permutation logic uses the correct dimensions for the buffer it’s actually reading from and writing to.<p>Alongside this main fix, a secondary, minor adjustment was made to a roughness threshold in the GGX VNDF (Visible Normal Distribution Function) sampling routine. The threshold for early exiting the full sampling routine (and returning a perfect reflection) was changed from <code>0.01</code> to <code>0.001</code>. This is an optimization and quality tweak. Materials with a roughness below this threshold are considered essentially perfectly smooth. Using a lower threshold (<code>0.001</code>) means the full, more expensive sampling algorithm will be used for slightly rougher surfaces, which can improve the quality of very sharp reflections by avoiding approximation artifacts that might occur near the old threshold. The change is minimal but aligns with common practice for handling near-zero roughness in PBR (Physically Based Rendering) shaders.<p>Finally, a purely cosmetic change added a blank line in a utility shader for better code organization, which doesn’t affect functionality.<p>The impact of this PR is the correction of potential visual artifacts and incorrect lighting in scenes using Solari’s ReSTIR DI/GI when DLSS or similar dynamic resolution techniques are active. The changes are localized to shader code, so they don’t affect the Rust-side engine API or structure. The fix is essential for ensuring the advanced rendering techniques work correctly under common performance-enhancing upscaling methods.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[DLSS/FSR Enabled] --> B{Viewport Size Mismatch}
</span><span>    B -->|Bug| C[view.viewport.zw]
</span><span>    B -->|Fix| D[view.main_pass_viewport.zw]
</span><span>    C --> E[Incorrect Pixel Permutation]
</span><span>    D --> F[Correct Pixel Permutation]
</span><span>    E --> G[Visual Artifacts in ReSTIR DI/GI]
</span><span>    F --> H[Correct Temporal Reprojection]
</span><span>
</span><span>    I[GGX VNDF Sampling] --> J{Roughness Threshold}
</span><span>    J -->|Old: 0.01| K[Potential Artifacts for Low Roughness]
</span><span>    J -->|New: 0.001| L[Improved Quality for Near-Smooth Surfaces]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ol><li><p><strong>File</strong>: <code>crates/bevy_solari/src/realtime/restir_di.wgsl</code></p> <ul><li><strong>Change</strong>: Updated the viewport size parameter passed to <code>permute_pixel</code> from <code>view.viewport.zw</code> to <code>view.main_pass_viewport.zw</code>.<li><strong>Why</strong>: To use the correct render target dimensions for temporal pixel permutation when DLSS/FSR modifies the internal resolution.<li><strong>Code Snippet</strong>:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>let permuted_temporal_pixel_id = permute_pixel(vec2&LTu32>(temporal_pixel_id_float), constants.frame_index, view.viewport.zw);
</span><span>
</span><span>// After:
</span><span>let permuted_temporal_pixel_id = permute_pixel(vec2&LTu32>(temporal_pixel_id_float), constants.frame_index, view.main_pass_viewport.zw);
</span></code></pre></ul><li><p><strong>File</strong>: <code>crates/bevy_solari/src/realtime/restir_gi.wgsl</code></p> <ul><li><strong>Change</strong>: Identical change as in <code>restir_di.wgsl</code> for the GI pass.<li><strong>Why</strong>: The same bug existed in both DI and GI temporal reprojection logic.<li><strong>Code Snippet</strong>: (Same change as above)</ul><li><p><strong>File</strong>: <code>crates/bevy_solari/src/scene/sampling.wgsl</code></p> <ul><li><strong>Change</strong>: Adjusted the early-exit threshold in <code>sample_ggx_vndf</code> from <code>0.01</code> to <code>0.001</code>.<li><strong>Why</strong>: To improve visual quality for materials with very low roughness (near-mirror surfaces) by using the full sampling algorithm for a broader range, reducing potential artifacts.<li><strong>Code Snippet</strong>:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>if roughness <= 0.01 {
</span><span>
</span><span>// After:
</span><span>if roughness <= 0.001 {
</span></code></pre></ul><li><p><strong>File</strong>: <code>crates/bevy_pbr/src/render/utils.wgsl</code></p> <ul><li><strong>Change</strong>: Added a blank line after the <code>sample_cosine_hemisphere</code> function for better code readability.<li><strong>Why</strong>: Cosmetic/organizational change only.<li><strong>Code Snippet</strong>:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// A blank line was added between functions.
</span><span>fn sample_cosine_hemisphere(...) -> vec3&LTf32> {
</span><span>    // ... function body
</span><span>}
</span><span>// &LT-- This blank line was added
</span><span>fn sample_uniform_hemisphere(...) -> vec3&LTf32> {
</span></code></pre></ul></ol><h2 id=further-reading>Further Reading</h2><ul><li><strong>ReSTIR (Resampled Temporal Importance Resampling)</strong>: The original research paper, “Spatiotemporal reservoir resampling for real-time ray tracing with dynamic direct lighting” <a rel="noopener nofollow noreferrer" href=https://research.nvidia.com/sites/default/files/pubs/2020-07_Spatiotemporal-reservoir-resampling/ReSTIR.pdf target=_blank>[PDF]</a>, provides the foundation for the techniques used in Solari.<li><strong>GGX VNDF Sampling</strong>: The paper “Bounded VNDF Sampling for Smith-GGX Reflections” <a rel="noopener nofollow noreferrer" href=https://gpuopen.com/download/bounded-vndf-sampling-for-smith-ggx-reflections/ target=_blank>[Link]</a> details the sampling algorithm being adjusted in this PR. The provided link in the shader comment is a good starting point.<li><strong>DLSS (Deep Learning Super Sampling)</strong>: NVIDIA’s developer documentation for DLSS explains the concept of rendering at a lower internal resolution and using AI to upsample, which is the context for the <code>main_pass_viewport</code> vs <code>viewport</code> distinction.<li><strong>Bevy Viewport & Render Target Management</strong>: The Bevy engine’s documentation on its rendering architecture, specifically how <code>Viewport</code> and camera projections work, would provide context for why these two viewport size values can differ.</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22240.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>