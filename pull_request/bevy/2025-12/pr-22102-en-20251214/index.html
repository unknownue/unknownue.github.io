<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22102 Solari: Double buffer prepass textures
        
    </title><meta content="#22102 Solari: Double buffer prepass textures" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-14</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22102-zh-cn-20251214>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Solari: Double buffer prepass textures<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22102<li><strong>Author</strong>: JMS55<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-12-13T03:49:13Z<li><strong>Merged</strong>: 2025-12-14T21:49:27Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>Fixes Solari crashing with <code>Partial copy of 0..1600 on X dimension with size 3200 is not supported for the Source texture format Depth32Float with 1 samples</code> after #21746.<p>Also slightly better performance by avoiding the copy.<p>Code is extremely cludgy though, we’re just piling hacks upon hacks for the prepass texture stuff.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This pull request addresses a critical crash in Bevy’s Solari rendering system and introduces a double-buffering mechanism for prepass textures. The issue manifested after a previous change (#21746) and represents a practical optimization to avoid texture copies while fixing a compatibility problem with GPU texture operations.<p>The problem originated in the Solari lighting system, which relies on temporal data from previous frames. Before this PR, Solari would create separate textures to store the previous frame’s g-buffer and depth data, then copy the current frame’s prepass textures into these staging textures at the end of the render pass. This copy operation used <code>command_encoder.copy_texture_to_texture()</code> to transfer data from the prepass textures to dedicated “previous frame” textures.<p>The crash occurred because recent changes in the prepass system removed <code>COPY_SRC</code> usage flags from depth textures in certain configurations. When Solari attempted to copy from these depth textures, it would fail with an error about unsupported partial copies on <code>Depth32Float</code> formatted textures. The error message indicated a mismatch between the copy source range (0..1600) and the texture’s actual size (3200), suggesting the system was attempting to copy only a portion of the texture, which isn’t supported for depth formats.<p>The developer’s solution was to implement double-buffering for prepass textures instead of using explicit copies. This approach maintains two textures for each prepass type (depth and deferred), alternating their use between frames. On even frames, texture A serves as the current frame and texture B as the previous frame; on odd frames, they swap roles. This eliminates the need for explicit copies entirely since the previous frame’s data is already available in the other texture.<p>The implementation required changes across several systems. New marker components were added: <code>DepthPrepassDoubleBuffer</code> and <code>DeferredPrepassDoubleBuffer</code>. These components are automatically added when Solari lighting is enabled and signal that the system should allocate double-buffered textures. The texture preparation system in <code>core_3d/mod.rs</code> was modified to conditionally create two textures instead of one when these components are present.<p>A key design change was the extension of the <code>ColorAttachment</code> struct to include a <code>previous_frame_texture</code> field. This allows the render graph to pass both the current and previous frame’s textures through a single attachment object. The <code>ViewPrepassTextures</code> struct was updated with methods like <code>previous_depth_view()</code> and <code>previous_deferred_view()</code> to access the historical data.<p>In the Solari lighting node, the code was significantly simplified by removing the texture copy operations and the associated texture management. Instead of managing its own separate “previous” textures, Solari now directly uses the double-buffered textures provided by the prepass system. This reduces memory usage, eliminates GPU copy operations, and fixes the compatibility issue.<p>The developer acknowledges in the PR description that this solution is “extremely cludgy” and represents “hacks upon hacks for the prepass texture stuff.” This comment highlights technical debt in Bevy’s rendering architecture, where prepass texture management has evolved through incremental patches rather than a cohesive design. The double-buffering logic is tied to frame count parity checks (<code>frame_count.is_multiple_of(2)</code>), which works but isn’t the most elegant solution.<p>Performance-wise, this change provides a small improvement by removing the texture copy operations, which consume both GPU time and memory bandwidth. The elimination of these copies is particularly beneficial for high-resolution rendering where texture data transfer can be expensive.<p>The fix demonstrates a common pattern in graphics programming: when explicit data transfers become problematic or inefficient, double-buffering often provides a cleaner solution. By maintaining two buffers and alternating their roles, systems can access historical data without expensive copies or synchronization barriers.<p>From an architectural perspective, this PR shows the challenges of evolving a complex rendering pipeline. The prepass system wasn’t originally designed with temporal techniques in mind, leading to workarounds like texture copies that eventually broke. The double-buffering approach integrates better with the existing prepass infrastructure while supporting temporal rendering needs.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[FrameCount Resource] --> B[prepare_prepass_textures system]
</span><span>    C[DepthPrepassDoubleBuffer Component] --> B
</span><span>    D[DeferredPrepassDoubleBuffer Component] --> B
</span><span>    B --> E[Texture Cache]
</span><span>    E --> F[Depth Texture 1]
</span><span>    E --> G[Depth Texture 2]
</span><span>    E --> H[Deferred Texture 1]
</span><span>    E --> I[Deferred Texture 2]
</span><span>    B --> J[ViewPrepassTextures]
</span><span>    F --> K[ColorAttachment.depth.texture]
</span><span>    G --> L[ColorAttachment.depth.previous_frame_texture]
</span><span>    H --> M[ColorAttachment.deferred.texture]
</span><span>    I --> N[ColorAttachment.deferred.previous_frame_texture]
</span><span>    J --> O[SolariLightingNode]
</span><span>    O --> P[Uses previous frame data directly]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-core-pipeline-src-core-3d-mod-rs-123-22><code>crates/bevy_core_pipeline/src/core_3d/mod.rs</code> (+123/-22)</h3><p>This file contains the core implementation of the double-buffering logic. The key changes include:<ol><li>Adding import for <code>FrameCount</code> resource to track frame parity<li>Modifying <code>prepare_prepass_textures</code> to create two textures when double-buffering is enabled<li>Implementing the <code>package_double_buffered_texture</code> helper function to select which texture is current/previous based on frame count</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// File: crates/bevy_core_pipeline/src/core_3d/mod.rs
</span><span style=color:#abb0b6;font-style:italic>// Key change: Texture creation with double-buffering support
</span><span style=color:#fa6e32>let</span><span> cached_depth_texture1 </span><span style=color:#ed9366>=</span><span> depth_prepass</span><span style=color:#ed9366>.</span><span style=color:#f07171>then</span><span>(|| {
</span><span>    depth_textures1
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>entry</span><span>(camera</span><span style=color:#ed9366>.</span><span>target</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>())
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>or_insert_with</span><span>(|| {
</span><span>            </span><span style=color:#fa6e32>let</span><span> descriptor </span><span style=color:#ed9366>=</span><span> TextureDescriptor {
</span><span>                label</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#86b300>"prepass_depth_texture_1"</span><span>)</span><span style=color:#61676ccc>,
</span><span>                size</span><span style=color:#61676ccc>,
</span><span>                mip_level_count</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>,
</span><span>                sample_count</span><span style=color:#61676ccc>:</span><span> msaa</span><span style=color:#ed9366>.</span><span style=color:#f07171>samples</span><span>()</span><span style=color:#61676ccc>,
</span><span>                dimension</span><span style=color:#61676ccc>: </span><span>TextureDimension</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>D2</span><span style=color:#61676ccc>,
</span><span>                format</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>CORE_3D_DEPTH_FORMAT</span><span style=color:#61676ccc>,
</span><span>                usage</span><span style=color:#61676ccc>: </span><span>TextureUsages</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>COPY_DST
</span><span>                    </span><span style=color:#ed9366>| </span><span>TextureUsages</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>RENDER_ATTACHMENT
</span><span>                    </span><span style=color:#ed9366>| </span><span>TextureUsages</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>TEXTURE_BINDING</span><span style=color:#61676ccc>,
</span><span>                view_formats</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>[]</span><span style=color:#61676ccc>,
</span><span>            }</span><span style=color:#61676ccc>;
</span><span>            texture_cache</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#ed9366>&</span><span>render_device</span><span style=color:#61676ccc>,</span><span> descriptor)
</span><span>        })
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()
</span><span>})</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>let</span><span> cached_depth_texture2 </span><span style=color:#ed9366>=</span><span> depth_prepass_double_buffer</span><span style=color:#ed9366>.</span><span style=color:#f07171>then</span><span>(|| {
</span><span>    depth_textures2
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>entry</span><span>(camera</span><span style=color:#ed9366>.</span><span>target</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>())
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>or_insert_with</span><span>(|| {
</span><span>            </span><span style=color:#fa6e32>let</span><span> descriptor </span><span style=color:#ed9366>=</span><span> TextureDescriptor {
</span><span>                label</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#86b300>"prepass_depth_texture_2"</span><span>)</span><span style=color:#61676ccc>,
</span><span>                size</span><span style=color:#61676ccc>,
</span><span>                mip_level_count</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>,
</span><span>                sample_count</span><span style=color:#61676ccc>:</span><span> msaa</span><span style=color:#ed9366>.</span><span style=color:#f07171>samples</span><span>()</span><span style=color:#61676ccc>,
</span><span>                dimension</span><span style=color:#61676ccc>: </span><span>TextureDimension</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>D2</span><span style=color:#61676ccc>,
</span><span>                format</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>CORE_3D_DEPTH_FORMAT</span><span style=color:#61676ccc>,
</span><span>                usage</span><span style=color:#61676ccc>: </span><span>TextureUsages</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>COPY_DST
</span><span>                    </span><span style=color:#ed9366>| </span><span>TextureUsages</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>RENDER_ATTACHMENT
</span><span>                    </span><span style=color:#ed9366>| </span><span>TextureUsages</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>TEXTURE_BINDING</span><span style=color:#61676ccc>,
</span><span>                view_formats</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>[]</span><span style=color:#61676ccc>,
</span><span>            }</span><span style=color:#61676ccc>;
</span><span>            texture_cache</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#ed9366>&</span><span>render_device</span><span style=color:#61676ccc>,</span><span> descriptor)
</span><span>        })
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()
</span><span>})</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-core-pipeline-src-prepass-mod-rs-24-0><code>crates/bevy_core_pipeline/src/prepass/mod.rs</code> (+24/-0)</h3><p>This file defines the new marker components and adds methods to access previous frame textures.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// File: crates/bevy_core_pipeline/src/prepass/mod.rs
</span><span style=color:#abb0b6;font-style:italic>// New component definitions
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component</span><span style=color:#61676ccc>,</span><span> Default</span><span style=color:#61676ccc>,</span><span> Reflect</span><span style=color:#61676ccc>,</span><span> Clone)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>reflect</span><span>(Component</span><span style=color:#61676ccc>,</span><span> Default</span><span style=color:#61676ccc>,</span><span> Clone)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>require</span><span>(DepthPrepass)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>DepthPrepassDoubleBuffer</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component</span><span style=color:#61676ccc>,</span><span> Default</span><span style=color:#61676ccc>,</span><span> Reflect</span><span style=color:#61676ccc>,</span><span> Clone)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>reflect</span><span>(Component</span><span style=color:#61676ccc>,</span><span> Default</span><span style=color:#61676ccc>,</span><span> Clone)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>require</span><span>(DeferredPrepass)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>DeferredPrepassDoubleBuffer</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// New accessor methods
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>previous_depth_view</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#ed9366>&</span><span>TextureView> {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>depth
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>as_ref</span><span>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>and_then</span><span>(|</span><span style=color:#ff8f40>t</span><span>| t</span><span style=color:#ed9366>.</span><span>previous_frame_texture</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_ref</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|</span><span style=color:#ff8f40>t</span><span>| </span><span style=color:#ed9366>&</span><span>t</span><span style=color:#ed9366>.</span><span>default_view))
</span><span>}
</span></code></pre><h3 id=crates-bevy-solari-src-realtime-node-rs-6-28><code>crates/bevy_solari/src/realtime/node.rs</code> (+6/-28)</h3><p>This file removes the texture copy operations that were causing the crash.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// File: crates/bevy_solari/src/realtime/node.rs
</span><span style=color:#abb0b6;font-style:italic>// Before: Texture copy operations that caused the crash
</span><span>command_encoder</span><span style=color:#ed9366>.</span><span style=color:#f07171>copy_texture_to_texture</span><span>(
</span><span>    view_prepass_textures
</span><span>        </span><span style=color:#ed9366>.</span><span>deferred
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()
</span><span>        </span><span style=color:#ed9366>.</span><span>texture
</span><span>        </span><span style=color:#ed9366>.</span><span>texture
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>as_image_copy</span><span>()</span><span style=color:#61676ccc>,
</span><span>    solari_lighting_resources</span><span style=color:#ed9366>.</span><span>previous_gbuffer</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0.</span><span style=color:#f07171>as_image_copy</span><span>()</span><span style=color:#61676ccc>,
</span><span>    solari_lighting_resources</span><span style=color:#ed9366>.</span><span>view_size</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_extents</span><span>()</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span><span>command_encoder</span><span style=color:#ed9366>.</span><span style=color:#f07171>copy_texture_to_texture</span><span>(
</span><span>    view_prepass_textures
</span><span>        </span><span style=color:#ed9366>.</span><span>depth
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()
</span><span>        </span><span style=color:#ed9366>.</span><span>texture
</span><span>        </span><span style=color:#ed9366>.</span><span>texture
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>as_image_copy</span><span>()</span><span style=color:#61676ccc>,
</span><span>    solari_lighting_resources</span><span style=color:#ed9366>.</span><span>previous_depth</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0.</span><span style=color:#f07171>as_image_copy</span><span>()</span><span style=color:#61676ccc>,
</span><span>    solari_lighting_resources</span><span style=color:#ed9366>.</span><span>view_size</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_extents</span><span>()</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: No copy operations - uses double-buffered textures directly
</span><span style=color:#abb0b6;font-style:italic>// The node now accesses previous frame textures via:
</span><span style=color:#abb0b6;font-style:italic>// view_prepass_textures.previous_deferred_view()
</span><span style=color:#abb0b6;font-style:italic>// view_prepass_textures.previous_depth_view()
</span></code></pre><h3 id=crates-bevy-solari-src-realtime-prepare-rs-0-29><code>crates/bevy_solari/src/realtime/prepare.rs</code> (+0/-29)</h3><p>This file removes the creation of separate previous frame textures, since they’re now provided by the prepass system.<h3 id=crates-bevy-solari-src-realtime-mod-rs-12-2><code>crates/bevy_solari/src/realtime/mod.rs</code> (+12/-2)</h3><p>This file updates the <code>SolariLighting</code> component to require the new double-buffer components.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// File: crates/bevy_solari/src/realtime/mod.rs
</span><span style=color:#abb0b6;font-style:italic>// Updated component requirements
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>require</span><span>(
</span><span>    Hdr</span><span style=color:#61676ccc>,
</span><span>    DeferredPrepass</span><span style=color:#61676ccc>,
</span><span>    DepthPrepass</span><span style=color:#61676ccc>,
</span><span>    MotionVectorPrepass</span><span style=color:#61676ccc>,
</span><span>    DeferredPrepassDoubleBuffer</span><span style=color:#61676ccc>,
</span><span>    DepthPrepassDoubleBuffer
</span><span>)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>SolariLighting </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>}
</span></code></pre><h3 id=crates-bevy-render-src-texture-texture-attachment-rs><code>crates/bevy_render/src/texture/texture_attachment.rs</code></h3><p>This file was modified to add the <code>previous_frame_texture</code> field to <code>ColorAttachment</code>, enabling the double-buffering data flow.<h2 id=further-reading>Further Reading</h2><ol><li><strong>Bevy Rendering Documentation</strong>: The Bevy book’s rendering section covers the prepass system and how it integrates with the render graph.<li><strong>Temporal Anti-Aliasing (TAA)</strong>: Solari uses temporal data similar to TAA techniques. Understanding TAA helps explain why previous frame data is needed.<li><strong>GPU Texture Double-Buffering</strong>: This is a common technique in graphics programming to avoid synchronization and copy operations between frames.<li><strong>wgpu Texture Usage Flags</strong>: The <code>TextureUsages</code> enum documentation explains the constraints around different texture operations and why certain formats can’t be copied partially.<li><strong>Bevy PR #21746</strong>: The previous change that removed <code>COPY_SRC</code> usage from prepass textures, which necessitated this fix.</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22102.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>