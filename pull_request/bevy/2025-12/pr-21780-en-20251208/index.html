<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21780 get_components_mut
        
    </title><meta content="#21780 get_components_mut" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-08</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-21780-zh-cn-20251208>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: get_components_mut<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21780<li><strong>Author</strong>: hymm<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Feature, A-ECS, S-Ready-For-Final-Review, M-Release-Note<li><strong>Created</strong>: 2025-11-07T22:39:30Z<li><strong>Merged</strong>: 2025-12-08T23:06:07Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Add a checked version of <code>EntityMut::get_components_mut</code> and <code>EntityWorldMut::get_components_mut</code> that does not allocate</ul><h2 id=solution>Solution</h2><ul><li>Add a iterator over the access type to <code>QueryData</code>. This is then used to iterate over the pairs of access to check if they are compatible or not.</ul><h2 id=testing>Testing</h2><ul><li>Added a unit test</ul><h3 id=bench-checked-vs-unchecked-50000-entities>Bench checked vs unchecked (50000 entities)</h3><table><thead><tr><th>#components<th>unchecked<th>checked<th>times slower<tbody><tr><td>2<td>509 us<td>1123 us<td>2.2x<tr><td>5<td>903 us<td>2902us<td>3.2x<tr><td>10<td>1700 us<td>11424 us<td>6.72x</table><p>so at 10 components each call was taking about 0.22us vs 0.03 us<hr><h2 id=todo>ToDo</h2><ul><li><input checked disabled type=checkbox> add release note<li><input checked disabled type=checkbox> add migration guide<li><input checked disabled type=checkbox> add macro for more benches<li><input checked disabled type=checkbox> add bench results to pr description<li><input disabled type=checkbox> look into if this will help with uncached queries<li><input checked disabled type=checkbox> see if we can optimize it a bit</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a specific gap in Bevy’s Entity Component System (ECS) API: the lack of a safe, non-allocating method to get multiple mutable component references from a single entity. Previously, developers had two options for retrieving multiple components from an entity:<ol><li>Use separate calls to <code>get_mut</code> for each component, which is safe but inefficient for multiple components<li>Use the unsafe <code>get_components_mut_unchecked</code> method, which doesn’t allocate but requires manual verification that no aliasing mutable references are requested</ol><p>The problem with the unsafe approach is that it’s easy to misuse. For example, requesting <code>(&mut T, &mut T)</code> would create two mutable references to the same component, violating Rust’s borrowing rules. The PR author recognized that while the unsafe method provided performance benefits, a safe alternative was needed for everyday use cases where correctness is prioritized over maximum performance.<p>The core challenge was implementing the safety checks without resorting to dynamic allocation. Existing query systems in Bevy already perform similar access conflict checks, but they typically build up <code>FilteredAccess</code> structures that allocate memory. For a simple entity component access operation, this overhead was undesirable.<p>The solution introduced a new abstraction called <code>EcsAccessType</code>, which represents different kinds of ECS access patterns (component read/write, resource read/write, borrowed access from query state, or empty). Each <code>QueryData</code> type now implements an <code>iter_access</code> method that returns an iterator over the access patterns it requires. This allows the system to statically analyze whether a query would create conflicting borrows without needing to allocate any data structures.<p>The implementation follows a straightforward approach: for a given query type <code>Q</code>, collect all its access patterns and compare each pair to ensure compatibility. The algorithm is O(n²) in the number of access patterns, but since typical queries involve only a handful of components, this is acceptable. The implementation includes an optimization for small queries (≤16 access patterns) by using a stack-allocated array instead of iterating twice, which helps reduce overhead for common cases.<p>The performance benchmarks reveal the trade-off clearly: the safe version is 2.2-6.7x slower than the unsafe version, depending on the number of components. At 10 components, each checked call takes about 0.22 microseconds versus 0.03 microseconds for the unchecked version. This overhead is reasonable for many use cases, especially considering the safety guarantees it provides.<p>An important implementation detail is how the access checking integrates with Bevy’s existing query system. The PR modifies the <code>QueryData</code> trait to require an <code>iter_access</code> method, which all existing query types must implement. This was done by:<ol><li>Adding the method to the trait definition<li>Implementing it for all built-in query types (entity references, component references, tuples, etc.)<li>Updating the <code>QueryData</code> derive macro to generate implementations for user-defined query types</ol><p>The new safe API methods (<code>get_components_mut</code> for both <code>EntityMut</code> and <code>EntityWorldMut</code>) simply call the existing unsafe methods after performing the access conflict check via <code>has_conflicts::&LTQ>()</code>. If the check passes, the operation is safe; otherwise, an error is returned.<p>The PR also updates related methods to return <code>Result</code> instead of <code>Option</code> for better error reporting. This change affects <code>get_components</code> (read-only version), <code>get_components_mut_unchecked</code>, and <code>into_components_mut_unchecked</code>, which now return <code>QueryAccessError</code> instead of <code>None</code> when components are missing or unregistered.<p>From an architectural perspective, this change demonstrates how to add runtime safety checks to an existing unsafe API without breaking existing code. The unsafe methods remain available for performance-critical code, while the new safe methods provide a more ergonomic default. The access checking logic is centralized in the new <code>access_iter</code> module, making it reusable for other purposes in the future.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[EntityMut/EntityWorldMut] --> B[get_components_mut]
</span><span>    B --> C[has_conflicts&LTQ>]
</span><span>    C --> D{Access Conflict?}
</span><span>    D -->|No| E[Call get_components_mut_unchecked]
</span><span>    D -->|Yes| F[Return QueryAccessError]
</span><span>    E --> G[Return component references]
</span><span>    
</span><span>    H[QueryData trait] --> I[iter_access method]
</span><span>    I --> J[Access pattern iterator]
</span><span>    J --> K[EcsAccessType enum]
</span><span>    K --> L[Component access]
</span><span>    K --> M[Resource access]
</span><span>    K --> N[Borrowed access]
</span><span>    K --> O[Empty]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ol><li><strong><code>crates/bevy_ecs/src/query/access_iter.rs</code> (+467/-0)</strong> <ul><li>New module containing the core access conflict checking logic<li>Defines <code>EcsAccessType</code> enum representing different access patterns<li>Implements <code>has_conflicts&LTQ></code> function that performs O(n²) pairwise compatibility checks<li>Includes comprehensive unit tests for various access conflict scenarios</ul></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Key code snippet: The core conflict checking logic
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>has_conflicts</span><span>&LTQ</span><span style=color:#61676ccc>:</span><span> QueryData>(</span><span style=color:#ff8f40>components</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>Components) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><(), QueryAccessError> {
</span><span>    </span><span style=color:#fa6e32>const </span><span style=color:#ff8f40>MAX_SIZE</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>16</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(state) </span><span style=color:#ed9366>= </span><span>Q</span><span style=color:#ed9366>::</span><span>get_state(components) </span><span style=color:#fa6e32>else </span><span>{
</span><span>        </span><span style=color:#fa6e32>return </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(QueryAccessError</span><span style=color:#ed9366>::</span><span>ComponentNotRegistered)</span><span style=color:#61676ccc>;
</span><span>    }</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> iter </span><span style=color:#ed9366>= </span><span>Q</span><span style=color:#ed9366>::</span><span>iter_access(</span><span style=color:#ed9366>&</span><span>state)</span><span style=color:#ed9366>.</span><span style=color:#f07171>enumerate</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> size </span><span style=color:#ed9366>=</span><span> iter</span><span style=color:#ed9366>.</span><span style=color:#f07171>size_hint</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>1.</span><span style=color:#f07171>unwrap_or</span><span>(</span><span style=color:#ff8f40>MAX_SIZE</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#fa6e32>if</span><span> size </span><span style=color:#ed9366>> </span><span style=color:#ff8f40>MAX_SIZE </span><span>{
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// Large query: iterate pairwise
</span><span>        </span><span style=color:#fa6e32>for </span><span>(i</span><span style=color:#61676ccc>,</span><span> access) </span><span style=color:#ed9366>in</span><span> iter {
</span><span>            </span><span style=color:#fa6e32>for</span><span> access_other </span><span style=color:#ed9366>in </span><span>Q</span><span style=color:#ed9366>::</span><span>iter_access(</span><span style=color:#ed9366>&</span><span>state)</span><span style=color:#ed9366>.</span><span style=color:#f07171>take</span><span>(i) {
</span><span>                </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(err) </span><span style=color:#ed9366>=</span><span> access</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_compatible</span><span>(access_other) {
</span><span>                    </span><span style=color:#f07171>panic!</span><span>(</span><span style=color:#86b300>"{}"</span><span style=color:#61676ccc>,</span><span> err)</span><span style=color:#61676ccc>;
</span><span>                }
</span><span>            }
</span><span>        }
</span><span>    } </span><span style=color:#fa6e32>else </span><span>{
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// Small query: cache in stack array
</span><span>        </span><span style=color:#fa6e32>let mut</span><span> inner_access </span><span style=color:#ed9366>= </span><span>[EcsAccessType</span><span style=color:#ed9366>::</span><span>Empty</span><span style=color:#61676ccc>; </span><span style=color:#ff8f40>MAX_SIZE</span><span>]</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#fa6e32>for </span><span>(i</span><span style=color:#61676ccc>,</span><span> access) </span><span style=color:#ed9366>in</span><span> iter {
</span><span>            </span><span style=color:#fa6e32>for</span><span> access_other </span><span style=color:#ed9366>in</span><span> inner_access</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>take</span><span>(i) {
</span><span>                </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(err) </span><span style=color:#ed9366>=</span><span> access</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_compatible</span><span>(</span><span style=color:#ed9366>*</span><span>access_other) {
</span><span>                    </span><span style=color:#f07171>panic!</span><span>(</span><span style=color:#86b300>"{}"</span><span style=color:#61676ccc>,</span><span> err)</span><span style=color:#61676ccc>;
</span><span>                }
</span><span>            }
</span><span>            inner_access[i] </span><span style=color:#ed9366>=</span><span> access</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(())
</span><span>}
</span></code></pre><ol start=2><li><strong><code>crates/bevy_ecs/src/query/fetch.rs</code> (+97/-3)</strong> <ul><li>Adds <code>iter_access</code> method to the <code>QueryData</code> trait<li>Implements <code>iter_access</code> for all built-in query types (components, entities, tuples, etc.)<li>Each implementation returns the appropriate <code>EcsAccessType</code> for that query</ul></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Example implementation for &mut T (mutable component reference)
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>iter_access</span><span>(</span><span style=color:#ff8f40>state</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>State) </span><span style=color:#61676ccc>-></span><span> impl </span><span style=color:#55b4d4;font-style:italic>Iterator</span><span>&LTItem = EcsAccessType<'</span><span style=color:#ed9366>_</span><span>>> {
</span><span>    iter</span><span style=color:#ed9366>::</span><span>once(EcsAccessType</span><span style=color:#ed9366>::</span><span>Component(EcsAccessLevel</span><span style=color:#ed9366>::</span><span>Write(</span><span style=color:#ed9366>*</span><span>state)))
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Example implementation for EntityMut (mutable entity reference)
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>iter_access</span><span>(</span><span style=color:#ff8f40>_state</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>State) </span><span style=color:#61676ccc>-></span><span> impl </span><span style=color:#55b4d4;font-style:italic>Iterator</span><span>&LTItem = EcsAccessType<'</span><span style=color:#ed9366>_</span><span>>> {
</span><span>    iter</span><span style=color:#ed9366>::</span><span>once(EcsAccessType</span><span style=color:#ed9366>::</span><span>Component(EcsAccessLevel</span><span style=color:#ed9366>::</span><span>WriteAll))
</span><span>}
</span></code></pre><ol start=3><li><strong><code>crates/bevy_ecs/src/world/entity_access/entity_mut.rs</code> (+91/-5)</strong> <ul><li>Adds new safe <code>get_components_mut</code> method to <code>EntityMut</code><li>Updates existing methods to return <code>Result</code> instead of <code>Option</code><li>Implements the safe method by calling <code>has_conflicts</code> then the unsafe method</ul></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// The new safe method
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>get_components_mut</span><span>&LTQ</span><span style=color:#61676ccc>:</span><span> ReleaseStateQueryData>(
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>,
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><</span><span style=color:#fa6e32>Q</span><span style=color:#ed9366>::</span><span>Item<'</span><span style=color:#ed9366>_</span><span>, </span><span style=color:#fa6e32>'static</span><span>>, QueryAccessError> {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>reborrow</span><span>()</span><span style=color:#ed9366>.</span><span>into_components_mut</span><span style=color:#ed9366>::</span><span>&LTQ>()
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Implementation that performs the check
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>into_components_mut</span><span>&LTQ</span><span style=color:#61676ccc>:</span><span> ReleaseStateQueryData>(
</span><span>    </span><span style=color:#ff8f40>self</span><span>,
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><</span><span style=color:#fa6e32>Q</span><span style=color:#ed9366>::</span><span>Item<</span><span style=color:#fa6e32>'w</span><span>, </span><span style=color:#fa6e32>'static</span><span>>, QueryAccessError> {
</span><span>    has_conflicts</span><span style=color:#ed9366>::</span><span>&LTQ>(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>cell</span><span style=color:#ed9366>.</span><span style=color:#f07171>world</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>components</span><span>())</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// SAFETY: we checked that there were not conflicting components above
</span><span>    </span><span style=color:#fa6e32>unsafe </span><span>{ </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>into_components_mut_unchecked</span><span style=color:#ed9366>::</span><span>&LTQ>() }
</span><span>}
</span></code></pre><ol start=4><li><p><strong><code>crates/bevy_ecs/src/world/entity_access/world_mut.rs</code> (+93/-4)</strong></p> <ul><li>Mirrors the changes in <code>entity_mut.rs</code> for <code>EntityWorldMut</code><li>Adds safe <code>get_components_mut</code> and <code>into_components_mut</code> methods<li>Updates return types from <code>Option</code> to <code>Result</code></ul><li><p><strong><code>benches/benches/bevy_ecs/world/world_get.rs</code> (+64/-1)</strong></p> <ul><li>Adds benchmarks comparing checked vs unchecked versions<li>Uses a macro to generate benchmarks for 2, 5, and 10 components<li>Shows the performance trade-off of the safety checks</ul></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Benchmark macro for different component counts
</span><span style=color:#f07171>macro_rules! </span><span style=color:#399ee6>query_get_components_mut </span><span>{
</span><span>    (</span><span style=color:#ff8f40>$function_name</span><span style=color:#61676ccc>:</span><span style=color:#fa6e32>ident</span><span>, $val:literal) </span><span style=color:#ed9366>=> </span><span>{
</span><span>        </span><span style=color:#fa6e32>pub fn </span><span>$function_name(criterion</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> Criterion) {
</span><span>            </span><span style=color:#abb0b6;font-style:italic>// ... setup code ...
</span><span>            group</span><span style=color:#ed9366>.</span><span style=color:#f07171>bench_function</span><span>(</span><span style=color:#f07171>format!</span><span>(</span><span style=color:#86b300>"</span><span style=color:#ff8f40>{}</span><span style=color:#86b300>_components_</span><span style=color:#ff8f40>{entity_count}</span><span style=color:#86b300>_entities"</span><span style=color:#61676ccc>, </span><span>$val)</span><span style=color:#61676ccc>, </span><span>|</span><span style=color:#ff8f40>bencher</span><span>| {
</span><span>                bencher</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>(|| {
</span><span>                    </span><span style=color:#fa6e32>for</span><span> entity </span><span style=color:#ed9366>in &</span><span>entities {
</span><span>                        </span><span style=color:#f07171>seq!</span><span>(N </span><span style=color:#ed9366>in </span><span style=color:#ff8f40>0</span><span style=color:#ed9366>..</span><span>$val {
</span><span>                            </span><span style=color:#f07171>assert!</span><span>(query
</span><span>                                </span><span style=color:#ed9366>.</span><span style=color:#f07171>get_mut</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> world</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>*</span><span>entity)
</span><span>                                </span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()
</span><span>                                </span><span style=color:#ed9366>.</span><span>get_components_mut</span><span style=color:#ed9366>::</span><span><(
</span><span>                                        #(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span>WideTable&LTN>,)*
</span><span>                                    )>()
</span><span>                                    </span><span style=color:#ed9366>.</span><span style=color:#f07171>is_ok</span><span>())</span><span style=color:#61676ccc>;
</span><span>                        })</span><span style=color:#61676ccc>;
</span><span>                    }
</span><span>                })</span><span style=color:#61676ccc>;
</span><span>            })</span><span style=color:#61676ccc>;
</span><span>            </span><span style=color:#abb0b6;font-style:italic>// ... also benchmark unchecked version ...
</span><span>        }
</span><span>    }</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><ol start=6><li><strong><code>crates/bevy_ecs/macros/src/query_data.rs</code> (modifications)</strong> <ul><li>Updates the <code>QueryData</code> derive macro to generate <code>iter_access</code> implementations<li>The generated code chains iterators from all fields in the query</ul></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Generated code snippet from the macro
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>iter_access</span><span>(
</span><span>    </span><span style=color:#ff8f40>_state</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>State,
</span><span>) </span><span style=color:#61676ccc>-></span><span> impl core</span><span style=color:#ed9366>::</span><span>iter</span><span style=color:#ed9366>::</span><span style=color:#55b4d4;font-style:italic>Iterator</span><span>&LTItem = </span><span style=color:#f51818>#</span><span>path</span><span style=color:#ed9366>::</span><span>query</span><span style=color:#ed9366>::</span><span>EcsAccessType<'</span><span style=color:#ed9366>_</span><span>></span><span style=color:#ed9366>> </span><span>{
</span><span>    core</span><span style=color:#ed9366>::</span><span>iter</span><span style=color:#ed9366>::</span><span>empty() </span><span style=color:#ed9366>#</span><span>(</span><span style=color:#ed9366>.</span><span style=color:#f07171>chain</span><span>(</span><span style=color:#ed9366><#</span><span>field_types</span><span style=color:#ed9366>>::</span><span>iter_access(</span><span style=color:#ed9366>&</span><span>_state</span><span style=color:#ed9366>.#</span><span>field_aliases)))</span><span style=color:#ed9366>*
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><p><strong>Rust Borrow Checker and Aliasing Rules</strong>: Understanding Rust’s rules about mutable references is essential for appreciating why this feature was needed. The Rust Book’s chapter on references and borrowing provides a good foundation.</p><li><p><strong>Bevy ECS Query System</strong>: The official Bevy ECS documentation explains how queries work and the different types of query data available. This PR extends that system with additional safety guarantees.</p><li><p><strong>Performance Optimization in Systems Programming</strong>: The trade-off between safety and performance demonstrated in this PR is a classic concern in systems programming. Resources on zero-cost abstractions and safe systems programming would provide useful context.</p><li><p><strong>Iterator Patterns in Rust</strong>: The implementation makes extensive use of Rust’s iterator patterns, particularly iterator chaining and size hints. The Rust documentation on iterators covers these concepts in detail.</p><li><p><strong>Macro Metaprogramming in Rust</strong>: The changes to the <code>QueryData</code> derive macro demonstrate how to use Rust’s macro system for code generation. Resources on procedural macros and derive macros would help understand this aspect of the implementation.</p></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_21780.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>