<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22005 Make BRP builtins utilities `parse` and `parse_some` public
        
    </title><meta content="#22005 Make BRP builtins utilities `parse` and `parse_some` public" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-15</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22005-zh-cn-20251215>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Make BRP builtins utilities <code>parse</code> and <code>parse_some</code> public<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22005<li><strong>Author</strong>: Nilirad<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: D-Trivial, C-Usability, S-Ready-For-Final-Review, A-Networking<li><strong>Created</strong>: 2025-12-02T10:04:45Z<li><strong>Merged</strong>: 2025-12-15T02:38:26Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Builtin BRP methods make constant use of <code>parse</code> and <code>parse_some</code> in parsing utilities. Making them public allows users to use them in their own code.<h2 id=solution>Solution</h2><p>Make both functions <code>pub</code>.<h2 id=testing>Testing</h2><p>I think testing is not necessary, especially since doc strings do not link anywhere.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This pull request addresses a straightforward but practical usability issue in Bevy’s remote networking module. The change is minimal but demonstrates an important principle in library design: when internal utility functions provide general-purpose functionality that could benefit external users, exposing them can improve developer ergonomics and reduce code duplication.<p>In the <code>bevy_remote</code> crate, specifically within the BRP (Bevy Remote Protocol) builtin methods implementation, two helper functions were being used extensively for parsing JSON data received over the network. These functions, <code>parse</code> and <code>parse_some</code>, handle the common task of deserializing <code>serde_json::Value</code> objects into typed Rust structures while converting parsing errors into the BRP error format consistently.<p>The core issue was that these utility functions, despite being well-designed for general JSON parsing with proper error handling, were marked as private (<code>fn</code>). This meant that developers implementing custom BRP methods or working with BRP data outside the builtin methods couldn’t reuse this logic. They would need to reimplement similar parsing logic, potentially introducing inconsistencies in error handling or code duplication across the codebase.<p>The implementation approach is elegantly simple: change the visibility modifier from the default private to public by adding the <code>pub</code> keyword to both function signatures. This change maintains backward compatibility while expanding the API surface for users. The functions already existed and were well-tested through their use in the builtin methods, so no additional testing was deemed necessary.<p>Looking at the technical details, <code>parse</code> handles direct deserialization of a <code>Value</code> into a generic type <code>T</code> that implements <code>Deserialize</code>, converting <code>serde_json</code> errors into <code>BrpError</code> with appropriate error codes. The <code>parse_some</code> function builds on this by handling optional values, returning an error when <code>None</code> is encountered rather than silently accepting missing parameters.<p>The impact of this change is practical for developers working with Bevy’s networking layer. By exposing these utility functions, the Bevy team acknowledges that good internal abstractions often have value beyond their original scope. Developers can now write cleaner, more consistent parsing code in their custom BRP implementations, using the same error handling patterns as the builtin methods.<p>This PR also highlights an important aspect of Rust crate design: thoughtful consideration of what should be public API. While not every internal helper should be exposed, utility functions that encapsulate common patterns with proper error handling and are already stable through internal use are good candidates for public exposure.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[BRP Builtin Methods] --> B[parse function]
</span><span>    A --> C[parse_some function]
</span><span>    B --> D[External User Code]
</span><span>    C --> D
</span><span>    B --> E[Internal BRP Usage]
</span><span>    C --> E
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><code>crates/bevy_remote/src/builtin_methods.rs</code> (+2/-2)<p>This file contains the BRP builtin methods implementation. The changes are minimal but significant for API usability:<ol><li><strong>parse function</strong>: Changed from private to public utility for deserializing JSON values with BRP error handling<li><strong>parse_some function</strong>: Changed from private to public utility for handling optional JSON values</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// File: crates/bevy_remote/src/builtin_methods.rs
</span><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>parse</span><span>&LTT</span><span style=color:#61676ccc>: </span><span>for<</span><span style=color:#fa6e32>'de</span><span>> Deserialize<</span><span style=color:#fa6e32>'de</span><span>>>(</span><span style=color:#ff8f40>value</span><span style=color:#61676ccc>:</span><span> Value) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span>&LTT, BrpError> {
</span><span>    serde_json</span><span style=color:#ed9366>::</span><span>from_value(value)</span><span style=color:#ed9366>.</span><span style=color:#f07171>map_err</span><span>(|</span><span style=color:#ff8f40>err</span><span>| BrpError {
</span><span>        code</span><span style=color:#61676ccc>: </span><span>error_codes</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>INVALID_PARAMS</span><span style=color:#61676ccc>,
</span><span>        message</span><span style=color:#61676ccc>:</span><span> err</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_string</span><span>()</span><span style=color:#61676ccc>,
</span><span>    })
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>parse</span><span>&LTT</span><span style=color:#61676ccc>: </span><span>for<</span><span style=color:#fa6e32>'de</span><span>> Deserialize<</span><span style=color:#fa6e32>'de</span><span>>>(</span><span style=color:#ff8f40>value</span><span style=color:#61676ccc>:</span><span> Value) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span>&LTT, BrpError> {
</span><span>    serde_json</span><span style=color:#ed9366>::</span><span>from_value(value)</span><span style=color:#ed9366>.</span><span style=color:#f07171>map_err</span><span>(|</span><span style=color:#ff8f40>err</span><span>| BrpError {
</span><span>        code</span><span style=color:#61676ccc>: </span><span>error_codes</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>INVALID_PARAMS</span><span style=color:#61676ccc>,
</span><span>        message</span><span style=color:#61676ccc>:</span><span> err</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_string</span><span>()</span><span style=color:#61676ccc>,
</span><span>    })
</span><span>}
</span></code></pre><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// File: crates/bevy_remote/src/builtin_methods.rs
</span><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>parse_some</span><span>&LTT</span><span style=color:#61676ccc>: </span><span>for<</span><span style=color:#fa6e32>'de</span><span>> Deserialize<</span><span style=color:#fa6e32>'de</span><span>>>(</span><span style=color:#ff8f40>value</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTValue>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span>&LTT, BrpError> {
</span><span>    </span><span style=color:#fa6e32>match</span><span> value {
</span><span>        </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(value) </span><span style=color:#ed9366>=> </span><span style=color:#f07171>parse</span><span>(value)</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#55b4d4;font-style:italic>None </span><span style=color:#ed9366>=> </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(BrpError {
</span><span>            code</span><span style=color:#61676ccc>: </span><span>error_codes</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>INVALID_PARAMS</span><span style=color:#61676ccc>,
</span><span>            message</span><span style=color:#61676ccc>: </span><span style=color:#86b300>"missing params"</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_string</span><span>()</span><span style=color:#61676ccc>,
</span><span>        })</span><span style=color:#61676ccc>,
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>parse_some</span><span>&LTT</span><span style=color:#61676ccc>: </span><span>for<</span><span style=color:#fa6e32>'de</span><span>> Deserialize<</span><span style=color:#fa6e32>'de</span><span>>>(</span><span style=color:#ff8f40>value</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTValue>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span>&LTT, BrpError> {
</span><span>    </span><span style=color:#fa6e32>match</span><span> value {
</span><span>        </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(value) </span><span style=color:#ed9366>=> </span><span style=color:#f07171>parse</span><span>(value)</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#55b4d4;font-style:italic>None </span><span style=color:#ed9366>=> </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(BrpError {
</span><span>            code</span><span style=color:#61676ccc>: </span><span>error_codes</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>INVALID_PARAMS</span><span style=color:#61676ccc>,
</span><span>            message</span><span style=color:#61676ccc>: </span><span style=color:#86b300>"missing params"</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_string</span><span>()</span><span style=color:#61676ccc>,
</span><span>        })</span><span style=color:#61676ccc>,
</span><span>    }
</span><span>}
</span></code></pre><p>These changes make both functions available to external users while maintaining their existing behavior and error handling patterns.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/ecs/networking/ target=_blank>Bevy Networking Documentation</a> - Overview of Bevy’s networking capabilities<li><a rel="noopener nofollow noreferrer" href=https://docs.serde.rs/serde_json/ target=_blank>serde_json Documentation</a> - JSON serialization/deserialization library used in these functions<li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/book/ch07-02-defining-modules-to-control-scope-and-privacy.html target=_blank>Rust Visibility and Privacy</a> - Understanding <code>pub</code> vs private visibility<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/tree/main/crates/bevy_remote target=_blank>Bevy Remote Protocol</a> - Source code for the remote module</ul><h1 id=full-code-diff>Full Code Diff</h1><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_remote/src/builtin_methods.rs b/crates/bevy_remote/src/builtin_methods.rs
</span><span>index abe8881731fc0..7c3164cb82e15 100644
</span><span style=color:#c594c5>--- a/crates/bevy_remote/src/builtin_methods.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_remote/src/builtin_methods.rs
</span><span style=color:#c594c5>@@ -463,7 +463,7 @@ </span><span style=color:#399ee6>pub struct BrpQueryRow {
</span><span> }
</span><span> 
</span><span> /// A helper function used to parse a `serde_json::Value`.
</span><span style=color:#f07171>-fn parse&LTT: for<'de> Deserialize<'de>>(value: Value) -> Result&LTT, BrpError> {
</span><span style=color:#86b300>+pub fn parse&LTT: for<'de> Deserialize<'de>>(value: Value) -> Result&LTT, BrpError> {
</span><span>     serde_json::from_value(value).map_err(|err| BrpError {
</span><span>         code: error_codes::INVALID_PARAMS,
</span><span>         message: err.to_string(),
</span><span style=color:#c594c5>@@ -472,7 +472,7 @@ </span><span style=color:#399ee6>fn parse&LTT: for<'de> Deserialize<'de>>(value: Value) -> Result&LTT, BrpError> {
</span><span> }
</span><span> 
</span><span> /// A helper function used to parse a `serde_json::Value` wrapped in an `Option`.
</span><span style=color:#f07171>-fn parse_some&LTT: for<'de> Deserialize<'de>>(value: Option&LTValue>) -> Result&LTT, BrpError> {
</span><span style=color:#86b300>+pub fn parse_some&LTT: for<'de> Deserialize<'de>>(value: Option&LTValue>) -> Result&LTT, BrpError> {
</span><span>     match value {
</span><span>         Some(value) => parse(value),
</span><span>         None => Err(BrpError {
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22005.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>