<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22051 Remove queue text
        
    </title><meta content="#22051 Remove queue text" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-10</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22051-zh-cn-20251210>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>Remove queue text<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Remove queue text<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22051<li><strong>Author</strong>: ickshonpe<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Code-Quality, S-Ready-For-Final-Review, A-Text, D-Straightforward<li><strong>Created</strong>: 2025-12-06T22:47:26Z<li><strong>Merged</strong>: 2025-12-10T20:11:24Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Remove the <code>queue_text</code> function as redundant.<h2 id=solution>Solution</h2><ul><li>Remove <code>queue_text</code> from <code>TextPipeline</code>.<li>In <code>update_text2d_layout</code>, instead of <code>queue_text</code>, call <code>TextPipeline::update_buffer</code> and then <code>TextPipeline::update_text_layout</code>.</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a code quality issue in Bevy’s text rendering system by removing redundant functionality. The <code>queue_text</code> function in <code>TextPipeline</code> was identified as unnecessary because its responsibilities could be handled more directly by existing methods. This change simplifies the text rendering pipeline while maintaining the same functionality.<p>The problem stemmed from having two different approaches to text processing that essentially did the same thing. The <code>queue_text</code> function was a convenience wrapper that combined two operations: updating the text buffer and updating the layout information. However, these operations were already available as separate functions (<code>update_buffer</code> and <code>update_text_layout_info</code>), and in some cases, callers needed more control over when each operation occurred.<p>The implementation approach was straightforward: remove the redundant function and update its callers to use the two separate functions directly. This required changes in two key systems: the 2D text layout system (<code>update_text2d_layout</code>) and the UI text system (<code>text_system</code>). Both systems were performing similar text processing but with slightly different requirements.<p>In <code>update_text2d_layout</code>, the logic was refactored to separate the buffer update from the layout update. This separation is important because buffer updates are only needed when the text content changes, while layout updates might be needed when other factors change (like bounds or scale). The system now checks for text changes separately and only updates the buffer when necessary:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let</span><span> text_changed </span><span style=color:#ed9366>=</span><span> scale_factor </span><span style=color:#ed9366>!=</span><span> text_layout_info</span><span style=color:#ed9366>.</span><span>scale_factor
</span><span>    </span><span style=color:#ed9366>||</span><span> block</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_changed</span><span>()
</span><span>    </span><span style=color:#ed9366>||</span><span> computed</span><span style=color:#ed9366>.</span><span style=color:#f07171>needs_rerender</span><span>()
</span><span>    </span><span style=color:#ed9366>|| </span><span>(</span><span style=color:#ed9366>!</span><span>reprocess_queue</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_empty</span><span>() </span><span style=color:#ed9366>&&</span><span> reprocess_queue</span><span style=color:#ed9366>.</span><span style=color:#f07171>remove</span><span>(</span><span style=color:#ed9366>&</span><span>entity))</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>(text_changed </span><span style=color:#ed9366>||</span><span> bounds</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_changed</span><span>()) {
</span><span>    </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#fa6e32>if</span><span> text_changed {
</span><span>    </span><span style=color:#fa6e32>match</span><span> text_pipeline</span><span style=color:#ed9366>.</span><span style=color:#f07171>update_buffer</span><span>(</span><span style=color:#ed9366>...</span><span>) {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// Handle errors and queue reprocessing if fonts aren't loaded
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#fa6e32>match</span><span> text_pipeline</span><span style=color:#ed9366>.</span><span style=color:#f07171>update_text_layout_info</span><span>(</span><span style=color:#ed9366>...</span><span>) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Update layout with the current buffer state
</span><span>}
</span></code></pre><p>The technical insight here is that by separating these concerns, we gain several benefits. First, we avoid unnecessary buffer updates when only layout parameters change. Second, we make the error handling more explicit - if a font isn’t loaded during buffer update, the entity gets queued for reprocessing in the next frame. Third, the code becomes more maintainable because each function has a single responsibility.<p>One important implementation detail is the addition of a workaround for text alignment in unbounded text. The <code>update_text_layout_info</code> function now handles the case where text justification needs to work even when no explicit width bounds are provided:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Workaround for alignment not working for unbounded text.
</span><span style=color:#abb0b6;font-style:italic>// See https://github.com/pop-os/cosmic-text/issues/343
</span><span style=color:#fa6e32>let</span><span> width </span><span style=color:#ed9366>= </span><span>(bounds</span><span style=color:#ed9366>.</span><span>width</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_none</span><span>() </span><span style=color:#ed9366>&&</span><span> justify </span><span style=color:#ed9366>!= </span><span>Justify</span><span style=color:#ed9366>::</span><span>Left)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>then</span><span>(|| </span><span style=color:#f07171>buffer_dimensions</span><span>(buffer)</span><span style=color:#ed9366>.</span><span>x)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>or</span><span>(bounds</span><span style=color:#ed9366>.</span><span>width)</span><span style=color:#61676ccc>;
</span><span>buffer</span><span style=color:#ed9366>.</span><span style=color:#f07171>set_size</span><span>(font_system</span><span style=color:#61676ccc>,</span><span> width</span><span style=color:#61676ccc>,</span><span> bounds</span><span style=color:#ed9366>.</span><span>height)</span><span style=color:#61676ccc>;
</span></code></pre><p>This workaround addresses a limitation in the underlying cosmic-text library where text alignment doesn’t work properly for unbounded text.<p>The impact of these changes is primarily code quality improvement. The text rendering system becomes more modular and easier to understand. There’s no functional change for users, but developers working on the text system will benefit from clearer separation of concerns. The removal of 213 lines of code from the <code>queue_text</code> function represents a significant simplification.<p>From an architectural perspective, this change aligns with the single responsibility principle. Each function now has a clear purpose: <code>update_buffer</code> handles text content processing, while <code>update_text_layout_info</code> handles layout and glyph positioning. This separation makes the system more flexible and easier to test and debug.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Text System] --> B{Text Changed?}
</span><span>    B -->|Yes| C[update_buffer]
</span><span>    B -->|No| D{Layout Changed?}
</span><span>    C --> E[update_text_layout_info]
</span><span>    D -->|Yes| E
</span><span>    D -->|No| F[Skip Processing]
</span><span>    
</span><span>    subgraph "Before PR"
</span><span>        G[queue_text] --> H[Combined buffer & layout update]
</span><span>    end
</span><span>    
</span><span>    subgraph "After PR"
</span><span>        C --> I[Buffer processing only]
</span><span>        E --> J[Layout processing only]
</span><span>    end
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-text-src-pipeline-rs-10-213><code>crates/bevy_text/src/pipeline.rs</code> (+10/-213)</h3><p>This file saw the most significant changes with the removal of the entire <code>queue_text</code> function. The function was 213 lines long and combined buffer updates with layout processing. After the change, callers use <code>update_buffer</code> and <code>update_text_layout_info</code> separately.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before (simplified):
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>queue_text</span><span><</span><span style=color:#fa6e32>'a</span><span>>(
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>,
</span><span>    </span><span style=color:#ff8f40>layout_info</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> TextLayoutInfo,
</span><span>    </span><span style=color:#ff8f40>fonts</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>Assets&LTFont>,
</span><span>    </span><span style=color:#ff8f40>text_spans</span><span style=color:#61676ccc>:</span><span> impl </span><span style=color:#55b4d4;font-style:italic>Iterator</span><span>&LTItem = (Entity, </span><span style=color:#fa6e32>usize</span><span>, </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'a str</span><span>, </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'a</span><span> TextFont, Color, LineHeight)>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... many parameters
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><(), TextError> {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Combined buffer update and layout processing
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>update_buffer</span><span>(</span><span style=color:#ed9366>...</span><span>)</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... layout processing logic
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#abb0b6;font-style:italic>// Function removed entirely - callers use update_buffer and update_text_layout_info separately
</span></code></pre><h3 id=crates-bevy-sprite-src-text2d-rs-65-32><code>crates/bevy_sprite/src/text2d.rs</code> (+65/-32)</h3><p>The 2D text layout system was refactored to use the separate functions. The key change was splitting the text processing into two distinct phases and improving the condition checking.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Key change in the main processing loop:
</span><span style=color:#fa6e32>if</span><span> text_changed {
</span><span>    </span><span style=color:#fa6e32>match</span><span> text_pipeline</span><span style=color:#ed9366>.</span><span style=color:#f07171>update_buffer</span><span>(</span><span style=color:#ed9366>...</span><span>) {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// Error handling for missing fonts
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#fa6e32>match</span><span> text_pipeline</span><span style=color:#ed9366>.</span><span style=color:#f07171>update_text_layout_info</span><span>(</span><span style=color:#ed9366>...</span><span>) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Layout processing with its own error handling
</span><span>}
</span></code></pre><h3 id=crates-bevy-text-src-glyph-rs-1-1><code>crates/bevy_text/src/glyph.rs</code> (+1/-1)</h3><p>Updated documentation to reference the new function name.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#abb0b6;font-style:italic>// Used in [`TextPipeline::queue_text`] and [`TextLayoutInfo`] for rendering glyphs.
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#abb0b6;font-style:italic>// Used in [`TextPipeline::update_text_layout_info`] and [`TextLayoutInfo`] for rendering glyphs.
</span></code></pre><h3 id=crates-bevy-text-src-lib-rs-1-1><code>crates/bevy_text/src/lib.rs</code> (+1/-1)</h3><p>Updated the module documentation to reflect the new text processing flow.<h3 id=crates-bevy-ui-src-widget-text-rs-1-0><code>crates/bevy_ui/src/widget/text.rs</code> (+1/-0)</h3><p>Updated the UI text system to pass the <code>justify</code> parameter to <code>update_text_layout_info</code>, which was previously handled internally by the removed <code>queue_text</code> function.<h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_text/latest/bevy_text/ target=_blank>Bevy Text Rendering Documentation</a> - Official documentation for Bevy’s text system<li><a rel="noopener nofollow noreferrer" href=https://github.com/pop-os/cosmic-text target=_blank>cosmic-text Library</a> - The underlying text layout library used by Bevy<li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Single-responsibility_principle target=_blank>Single Responsibility Principle</a> - The design principle that motivated this refactoring<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/introduction/ target=_blank>Bevy Engine Architecture</a> - General information about Bevy’s ECS architecture and systems</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22051.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>