<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21989 Add MeshTag to array_texture example to demonstrate layer selection in shader
        
    </title><meta content="#21989 Add MeshTag to array_texture example to demonstrate layer selection in shader" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-10</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-21989-zh-cn-20251210>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Add MeshTag to array_texture example to demonstrate layer selection in shader<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21989<li><strong>Author</strong>: mgi388<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, C-Examples, S-Ready-For-Final-Review, D-Shaders, M-Deliberate-Rendering-Change<li><strong>Created</strong>: 2025-12-01T04:14:52Z<li><strong>Merged</strong>: 2025-12-10T00:19:59Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>The PR description is already in English, so it is included exactly as-is.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The <code>array_texture</code> example in Bevy needed clarification about how to pass layer selection data to shaders. When examining this example, a developer noticed that the existing implementation used a hack: it derived a fake “layer” value from the mesh’s world position (<code>mesh.world_position.x</code>), which wasn’t representative of how array texture layer selection typically works in real applications.<p>After consulting with the Bevy community on Discord, the developer learned that <code>MeshTag</code> is one recommended approach for passing per-instance data like texture layer indices to shaders. The existing example wasn’t demonstrating this practical technique, which made it less useful for developers trying to understand how to work with array textures in Bevy.<p>The solution involved two main changes. First, the shader code was updated to use <code>MeshTag</code> instead of deriving layer information from position data. The shader imports <code>bevy_pbr::mesh_functions</code> and calls <code>mesh_functions::get_tag(mesh.instance_index)</code> to retrieve the layer index. This aligns with Bevy’s established patterns for passing per-instance data.<p>Second, the example code was enhanced to demonstrate how <code>MeshTag</code> can be used dynamically. The developer added a system that periodically updates the <code>MeshTag</code> on all mesh entities, cycling through the available texture layers. This shows that layer selection isn’t just static data - it can be changed at runtime, which is a common requirement for effects like animated textures or material switching.<p>A key implementation detail is the introduction of a <code>TEXTURE_COUNT</code> constant (set to 4) that’s used consistently throughout the code. This constant controls both the image array layout configuration and the modulo operations for layer cycling, ensuring the example remains maintainable and the logic is clear.<p>The changes demonstrate a practical pattern for working with array textures: using <code>MeshTag</code> to pass layer indices from entity components to shaders. This approach is more realistic than the previous position-based hack and provides a template that developers can adapt for their own use cases, such as texture arrays for terrain, foliage variations, or animated sprite sheets.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[MeshTag Component&LTbr/>on Entity] --> B[update_mesh_tags System&LTbr/>Updates tag value periodically]
</span><span>    B --> C[Render Pipeline&LTbr/>Passes tag to shader]
</span><span>    C --> D[Vertex Shader&LTbr/>Includes tag in vertex data]
</span><span>    D --> E[Fragment Shader&LTbr/>Uses mesh_functions::get_tag&LTbr/>to read layer index]
</span><span>    E --> F[Texture Sampling&LTbr/>Samples from array texture&LTbr/>at specified layer]
</span><span>    G[Array Texture Asset&LTbr/>4-layer texture array] --> F
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=1-examples-shader-array-texture-rs-33-5>1. <code>examples/shader/array_texture.rs</code> (+33/-5)</h3><p><strong>What changed and why</strong>: The example was updated to demonstrate proper usage of <code>MeshTag</code> for array texture layer selection. The example now includes dynamic updates to show how layer selection can change at runtime.<p><strong>Key modifications</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// File: examples/shader/array_texture.rs
</span><span style=color:#abb0b6;font-style:italic>// Before (simplified):
</span><span style=color:#abb0b6;font-style:italic>// No MeshTag usage, no update system
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#abb0b6;font-style:italic>// Added constant for texture count
</span><span style=color:#fa6e32>const </span><span style=color:#ff8f40>TEXTURE_COUNT</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u32 </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>4</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Updated image loading to use the constant
</span><span>settings</span><span style=color:#ed9366>.</span><span>array_layout </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(ImageArrayLayout</span><span style=color:#ed9366>::</span><span>RowCount {
</span><span>    rows</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>TEXTURE_COUNT</span><span style=color:#61676ccc>,
</span><span>})</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Added MeshTag to spawned entities
</span><span>commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((
</span><span>    Mesh3d(mesh_handle</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>())</span><span style=color:#61676ccc>,
</span><span>    MeshMaterial3d(material_handle</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>())</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Pass a different mesh tag to allow selecting different layers of
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// the array texture in the shader.
</span><span>    MeshTag(x </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>u32 </span><span style=color:#ed9366>% </span><span style=color:#ff8f40>TEXTURE_COUNT</span><span>)</span><span style=color:#61676ccc>,
</span><span>    Transform</span><span style=color:#ed9366>::</span><span>from_xyz(x </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32 </span><span style=color:#ed9366>+ </span><span style=color:#ff8f40>0.5</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.0</span><span>)</span><span style=color:#61676ccc>,
</span><span>))</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Added system for dynamic updates
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>update_mesh_tags</span><span>(</span><span style=color:#ff8f40>time</span><span style=color:#61676ccc>: </span><span>Res&LTTime>, </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>query</span><span style=color:#61676ccc>: </span><span>Query<</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> MeshTag>, </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>timer</span><span style=color:#61676ccc>: </span><span>Local&LTTimer>) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Initialize the timer on the first run.
</span><span>    </span><span style=color:#fa6e32>if</span><span> timer</span><span style=color:#ed9366>.</span><span style=color:#f07171>duration</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_zero</span><span>() {
</span><span>        </span><span style=color:#ed9366>*</span><span>timer </span><span style=color:#ed9366>= </span><span>Timer</span><span style=color:#ed9366>::</span><span>from_seconds(</span><span style=color:#ff8f40>1.5</span><span style=color:#61676ccc>, </span><span>TimerMode</span><span style=color:#ed9366>::</span><span>Repeating)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>
</span><span>    timer</span><span style=color:#ed9366>.</span><span style=color:#f07171>tick</span><span>(time</span><span style=color:#ed9366>.</span><span style=color:#f07171>delta</span><span>())</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>if</span><span> timer</span><span style=color:#ed9366>.</span><span style=color:#f07171>just_finished</span><span>() {
</span><span>        </span><span style=color:#fa6e32>for mut</span><span> tag </span><span style=color:#ed9366>in</span><span> query</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter_mut</span><span>() {
</span><span>            </span><span style=color:#abb0b6;font-style:italic>// Cycle through the texture layers to demonstrate that we can
</span><span>            </span><span style=color:#abb0b6;font-style:italic>// select different layers of the array texture at runtime.
</span><span>            tag</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0 </span><span style=color:#ed9366>= </span><span>(tag</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0 </span><span style=color:#ed9366>+ </span><span style=color:#ff8f40>1</span><span>) </span><span style=color:#ed9366>% </span><span style=color:#ff8f40>TEXTURE_COUNT</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre><h3 id=2-assets-shaders-array-texture-wgsl-4-1>2. <code>assets/shaders/array_texture.wgsl</code> (+4/-1)</h3><p><strong>What changed and why</strong>: The shader was updated to use <code>MeshTag</code> for layer selection instead of deriving the layer from world position, which was an unrealistic hack.<p><strong>Key modifications</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// File: assets/shaders/array_texture.wgsl
</span><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> layer </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>i32</span><span>(mesh</span><span style=color:#ed9366>.</span><span>world_position</span><span style=color:#ed9366>.</span><span>x) </span><span style=color:#ed9366>& </span><span style=color:#ff8f40>0x3</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#ed9366>#</span><span>import bevy_pbr</span><span style=color:#ed9366>::</span><span>mesh_functions
</span><span style=color:#abb0b6;font-style:italic>// ...
</span><span style=color:#abb0b6;font-style:italic>// Determine which layer of the array texture to sample from based on the
</span><span style=color:#abb0b6;font-style:italic>// mesh tag which originates from the MeshTag component on the entity.
</span><span style=color:#fa6e32>let</span><span> layer </span><span style=color:#ed9366>= </span><span>mesh_functions</span><span style=color:#ed9366>::</span><span>get_tag(mesh</span><span style=color:#ed9366>.</span><span>instance_index)</span><span style=color:#61676ccc>;
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/mesh/struct.MeshTag.html target=_blank>Bevy MeshTag Documentation</a> - Official documentation for the MeshTag component<li><a rel="noopener nofollow noreferrer" href=https://www.w3.org/TR/WGSL/ target=_blank>WebGPU Shading Language (WGSL) Specification</a> - Reference for the shader language used in Bevy<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/tree/main/examples/shader target=_blank>Bevy Shader Examples</a> - Other shader examples in the Bevy repository<li><a rel="noopener nofollow noreferrer" href=https://learnopengl.com/Advanced-OpenGL/Textures target=_blank>Texture Arrays in Graphics Programming</a> - General concepts about texture arrays (though OpenGL-specific, the concepts apply to WebGPU/WGSL)</ul><h1 id=full-code-diff>Full Code Diff</h1><p>The full code diff is provided in the PR description above.</div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_21989.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>