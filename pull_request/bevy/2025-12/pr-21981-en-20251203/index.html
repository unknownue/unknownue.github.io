<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21981 #21980 Fix Component/Relationship derive using non fully qualified path
        
    </title><meta content="#21981 #21980 Fix Component/Relationship derive using non fully qualified path" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-03</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-21981-zh-cn-20251203>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>#21980 Fix Component/Relationship derive using non fully qualified path<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: #21980 Fix Component/Relationship derive using non fully qualified path<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21981<li><strong>Author</strong>: HeartofPhos<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: D-Trivial, A-ECS, S-Needs-Review, D-Macros<li><strong>Created</strong>: 2025-11-30T10:48:51Z<li><strong>Merged</strong>: 2025-12-03T00:59:24Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Fixes #21980<h2 id=solution>Solution</h2><p>Use fully qualified path for <code>Entity</code><h2 id=testing>Testing</h2><p>The following code now compiles<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>mod </span><span style=color:#399ee6>test </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>derive_component_relationship_hygiene</span><span>() {
</span><span>        </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Debug</span><span style=color:#61676ccc>,</span><span> bevy::prelude::Component)]
</span><span>        </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>relationship</span><span>(relationship_target </span><span style=color:#ed9366>=</span><span> RelTarget)]
</span><span>        </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>Rel</span><span>(pub bevy</span><span style=color:#ed9366>::</span><span>prelude</span><span style=color:#ed9366>::</span><span>Entity)</span><span style=color:#61676ccc>;
</span><span>
</span><span>        </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Debug</span><span style=color:#61676ccc>,</span><span> bevy::prelude::Component)]
</span><span>        </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>relationship_target</span><span>(relationship </span><span style=color:#ed9366>=</span><span> Rel)]
</span><span>        </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>RelTarget</span><span>(bevy</span><span style=color:#ed9366>::</span><span>prelude</span><span style=color:#ed9366>::</span><span>Entity)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The issue began with a straightforward problem: the <code>Component</code> and <code>Relationship</code> derive macros in Bevy’s ECS system had a hygiene issue. When developers used these macros within nested modules or contexts where the <code>Entity</code> type wasn’t directly in scope, the generated code would fail to compile because it referenced <code>Entity</code> without a fully qualified path.<p>This type of issue is common in Rust macro development. Macros generate code, and that generated code needs to work correctly regardless of where the macro is invoked. The problem manifested specifically in the relationship derivation system, where the <code>set_risky</code> method in generated relationship implementations used the type <code>Entity</code> without specifying its full module path.<p>The developer encountered this when trying to use <code>bevy::prelude::Entity</code> explicitly in their component structs. The macro-generated code assumed <code>Entity</code> was in scope, but in this context, only the fully qualified path was available. This is a classic macro hygiene problem where generated code doesn’t respect the caller’s namespace context.<p>The solution was simple but important: change the generated code to use the fully qualified path <code>#bevy_ecs_path::entity::Entity</code> instead of just <code>Entity</code>. The <code>#bevy_ecs_path</code> variable is provided by the macro infrastructure and contains the path to the <code>bevy_ecs</code> crate, ensuring that the generated code always references the correct <code>Entity</code> type regardless of where the macro is called.<p>This change demonstrates an important principle in Rust macro design: when generating code that references types from external crates, always use fully qualified paths or paths provided by the macro’s context. This prevents compilation errors when the macro is used in different namespace contexts.<p>The fix is minimal - just a single line change - but it addresses a real usability issue. Without this fix, developers would need to manually import <code>Entity</code> into every module where they use relationship derives, which is both inconvenient and error-prone. The fix ensures that the derive macros work correctly regardless of the user’s import patterns.<p>From an engineering perspective, this fix highlights the importance of considering macro hygiene in library design. When creating derive macros or procedural macros, developers need to think about how the generated code will interact with different namespace contexts. Using fully qualified paths for external types is a standard practice that prevents these kinds of issues.<p>The testing example provided in the PR description shows exactly the scenario that was broken and is now fixed. By using <code>bevy::prelude::Entity</code> explicitly in the struct definitions, the test demonstrates that the generated relationship implementations now correctly reference the <code>Entity</code> type through the proper path, allowing the code to compile successfully.<p>This change fits into Bevy’s broader architectural goal of providing a clean, ergonomic API. The ECS system’s derive macros should “just work” without requiring developers to understand the internal implementation details or manually manage imports. This fix maintains that principle by ensuring the relationship derive macro works correctly in all reasonable usage contexts.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Component Derive Macro] --> B[Generates Code]
</span><span>    B --> C[Uses Entity Type]
</span><span>    D[Macro Context] --> E[Provides bevy_ecs_path]
</span><span>    E --> F[Fully Qualified Path]
</span><span>    C --> F
</span><span>    F --> G[#bevy_ecs_path::entity::Entity]
</span><span>    G --> H[Compilation Success]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ul><li><code>crates/bevy_ecs/macros/src/component.rs</code> (+1/-1)</ul><p>This file contains the derive macro implementation for the <code>Component</code> trait. The specific change is in the <code>derive_relationship</code> function, which generates the relationship implementation for components.<p>The key modification is in the generated <code>set_risky</code> method signature. Before the fix, it used a bare <code>Entity</code> type, which assumed the type was in scope. After the fix, it uses the fully qualified path provided by the macro context.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// File: crates/bevy_ecs/macros/src/component.rs
</span><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>set_risky</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>entity</span><span style=color:#61676ccc>:</span><span> Entity) {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.#</span><span>relationship_member </span><span style=color:#ed9366>=</span><span> entity</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>set_risky</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>entity</span><span style=color:#61676ccc>:</span><span> #bevy_ecs_path</span><span style=color:#ed9366>::</span><span>entity</span><span style=color:#ed9366>::</span><span>Entity) {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.#</span><span>relationship_member </span><span style=color:#ed9366>=</span><span> entity</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>The <code>#bevy_ecs_path</code> is a token that gets expanded to the correct path to the <code>bevy_ecs</code> crate based on where the macro is invoked. This ensures that the generated code always references the correct <code>Entity</code> type from the <code>bevy_ecs</code> crate’s <code>entity</code> module.<p>This change directly addresses the issue described in the PR: when users reference <code>Entity</code> using a qualified path like <code>bevy::prelude::Entity</code>, the generated code now uses a similarly qualified path instead of assuming <code>Entity</code> is available in the local namespace.<h2 id=further-reading>Further Reading</h2><ol><li><p><strong>Rust Macro Hygiene</strong>: The Rust Reference section on macro hygiene explains how macros handle namespacing and how to write hygienic macros: https://doc.rust-lang.org/reference/macros.html#hygiene</p><li><p><strong>Bevy ECS Relationships</strong>: The Bevy ECS documentation on relationships explains how to use the relationship system and derive macros: https://bevyengine.org/learn/ecs/relationships/</p><li><p><strong>Procedural Macros in Rust</strong>: The “The Little Book of Rust Macros” provides practical guidance on writing procedural macros, including hygiene considerations: https://veykril.github.io/tlborm/</p><li><p><strong>Bevy’s Component Derive Macro</strong>: The Bevy source code for component derivation shows how macros are structured in the codebase: https://github.com/bevyengine/bevy/tree/main/crates/bevy_ecs/macros</p></ol><h1 id=full-code-diff>Full Code Diff</h1><pre style=color:#61676c;background-color:#fafafa><code><span>diff --git a/crates/bevy_ecs/macros/src/component.rs b/crates/bevy_ecs/macros/src/component.rs
</span><span>index 5ec637da1a4f7..f37defab0b111 100644
</span><span>--- a/crates/bevy_ecs/macros/src/component.rs
</span><span>+++ b/crates/bevy_ecs/macros/src/component.rs
</span><span>@@ -826,7 +826,7 @@ fn derive_relationship(
</span><span>             }
</span><span> 
</span><span>             #[inline]
</span><span>-            fn set_risky(&mut self, entity: Entity) {
</span><span>+            fn set_risky(&mut self, entity: #bevy_ecs_path::entity::Entity) {
</span><span>                 self.#relationship_member = entity;
</span><span>             }
</span><span>         }
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_21981.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>