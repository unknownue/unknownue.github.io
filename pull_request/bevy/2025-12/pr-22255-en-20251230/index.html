<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22255 Fix Updated images occasionally never displayed on materials by ensuring correct ordering of system sets
        
    </title><meta content="#22255 Fix Updated images occasionally never displayed on materials by ensuring correct ordering of system sets" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-30</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22255-zh-cn-20251230>中文</a></div></div><div class=pr-content><h1 id=fix-updated-images-occasionally-never-displayed-on-materials-by-ensuring-correct-ordering-of-system-sets>Fix Updated images occasionally never displayed on materials by ensuring correct ordering of system sets</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix Updated images occasionally never displayed on materials by ensuring correct ordering of system sets<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22255<li><strong>Author</strong>: ItsDoot<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-ECS, S-Ready-For-Final-Review, P-Regression<li><strong>Created</strong>: 2025-12-24T05:38:02Z<li><strong>Merged</strong>: 2025-12-30T01:17:47Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h3 id=objective>Objective</h3><ul><li>Fixes #22212</ul><h3 id=solution>Solution</h3><p>Replace <code>HashSet</code> usage with <code>IndexSet</code> in <code>DagGroups</code> to maintain insertion order like the previous <code>Vec</code> implementation.<h3 id=testing>Testing</h3><p>Used the provided example in the bug report. Should we add it as a test or example somewhere?<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a regression in Bevy’s ECS scheduling system that caused updated images to occasionally never display on materials. The issue was subtle but significant - it involved non-deterministic ordering of systems within system sets due to an underlying data structure change.<p>The problem originated from a previous refactoring that replaced <code>Vec</code> with <code>HashSet</code> in the <code>DagGroups</code> data structure. While this change improved certain aspects of the code, it introduced non-deterministic iteration order. In the context of ECS scheduling, where system execution order matters for correctness, this unpredictability led to visual artifacts where updated images would sometimes fail to display correctly.<p>The developer identified the root cause: <code>HashSet</code> doesn’t guarantee insertion order preservation during iteration, whereas the previous <code>Vec</code> implementation did. This mattered because systems within the same set need to execute in a predictable order to ensure that data dependencies are resolved correctly. When systems that update materials and systems that render them ended up in different relative orders on different runs, the rendering system could execute before the material update system, causing stale data to be used.<p>The solution was straightforward: replace <code>HashSet</code> with <code>IndexSet</code> from the <code>indexmap</code> crate. <code>IndexSet</code> provides the same O(1) lookup characteristics as <code>HashSet</code> but maintains insertion order, exactly matching the behavior of the original <code>Vec</code> implementation. This change restores deterministic system ordering while preserving the performance benefits of hash-based lookups.<p>The implementation required changes across four files in the ECS module, primarily updating type signatures and initialization logic. The core change was in <code>DagGroups</code>, where the internal storage type switched from <code>HashMap&LTK, HashSet&LTV, S>, S></code> to <code>HashMap&LTK, IndexSet&LTV, S>, S></code>. This change propagated through several method signatures and trait implementations, particularly in the <code>ScheduleBuildPass</code> trait hierarchy.<p>One important detail is the use of <code>FixedHasher</code> throughout. Bevy uses a deterministic hasher to ensure consistent behavior across runs, which is crucial for the ECS scheduler. The PR maintains this by explicitly specifying <code>FixedHasher</code> as the hasher type for the <code>IndexSet</code>.<p>The fix is minimal and focused - it addresses the regression without introducing new complexity. By preserving insertion order while maintaining hash-based performance characteristics, it solves the ordering issue while keeping the benefits of the previous refactoring.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[System Sets] --> B[DagGroups data structure]
</span><span>    B --> C{Iteration order matters}
</span><span>    C -->|HashSet| D[Non-deterministic order]
</span><span>    C -->|IndexSet| E[Deterministic insertion order]
</span><span>    D --> F[Image update systems run out of order]
</span><span>    E --> G[Systems execute predictably]
</span><span>    F --> H[Images occasionally not displayed]
</span><span>    G --> I[Images always display correctly]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ol><li><p><strong>crates/bevy_ecs/src/schedule/auto_insert_apply_deferred.rs</strong> (+3/-2)</p> <ul><li>Changed the <code>collapse_set</code> method signature to accept <code>IndexSet</code> instead of <code>HashSet</code><li>This ensures that when systems are collapsed into a set, their order is preserved</ul><li><p><strong>crates/bevy_ecs/src/schedule/graph/dag.rs</strong> (+6/-5)</p> <ul><li>The core change: updated <code>DagGroups</code> to use <code>IndexSet</code> instead of <code>HashSet</code><li>Changed the <code>flatten</code> method to work with <code>IndexSet</code><li>Updated type definitions and method signatures throughout</ul> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>DagGroups</span><span>&LTK, V, S = FixedHasher>(HashMap&LTK, HashSet&LTV, S>, S>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>DagGroups</span><span>&LTK, V, S = FixedHasher>(HashMap&LTK, IndexSet&LTV, S>, S>)</span><span style=color:#61676ccc>;
</span></code></pre><li><p><strong>crates/bevy_ecs/src/schedule/pass.rs</strong> (+11/-7)</p> <ul><li>Updated the <code>ScheduleBuildPass</code> trait to use <code>IndexSet</code> in the <code>collapse_set</code> method<li>Modified the trait object implementation to match</ul> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>collapse_set</span><span>(
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>,
</span><span>    </span><span style=color:#ff8f40>set</span><span style=color:#61676ccc>:</span><span> SystemSetKey,
</span><span>    </span><span style=color:#ff8f40>systems</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>HashSet&LTSystemKey>,
</span><span>    </span><span style=color:#ff8f40>dependency_flattening</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>DiGraph&LTNodeId>,
</span><span>) </span><span style=color:#61676ccc>-></span><span> impl </span><span style=color:#55b4d4;font-style:italic>Iterator</span><span>&LTItem = (NodeId, NodeId)></span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>collapse_set</span><span>(
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>,
</span><span>    </span><span style=color:#ff8f40>set</span><span style=color:#61676ccc>:</span><span> SystemSetKey,
</span><span>    </span><span style=color:#ff8f40>systems</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>IndexSet&LTSystemKey, FixedHasher>,
</span><span>    </span><span style=color:#ff8f40>dependency_flattening</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>DiGraph&LTNodeId>,
</span><span>) </span><span style=color:#61676ccc>-></span><span> impl </span><span style=color:#55b4d4;font-style:italic>Iterator</span><span>&LTItem = (NodeId, NodeId)></span><span style=color:#61676ccc>;
</span></code></pre><li><p><strong>crates/bevy_ecs/src/schedule/schedule.rs</strong> (+7/-4)</p> <ul><li>Updated <code>systems_in_set</code> method to return <code>IndexSet</code> instead of <code>HashSet</code><li>Changed <code>remove_systems_by_keys</code> to accept <code>IndexSet</code></ul></ol><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/indexmap/latest/indexmap/set/struct.IndexSet.html target=_blank>IndexSet documentation</a> - The data structure used to replace HashSet<li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/programming/schedules.html target=_blank>Bevy ECS Scheduling</a> - Understanding Bevy’s scheduling system<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/crates/bevy_utils/src/fixed_state.rs target=_blank>Deterministic hashing in Bevy</a> - Bevy’s FixedState hasher for deterministic behavior<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/issues/22212 target=_blank>PR #22212</a> - The original bug report with reproduction case</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22255.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>