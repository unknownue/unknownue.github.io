<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22240 Solari: Fix bug with wrong viewport size under DLSS
        
    </title><meta content="#22240 Solari: Fix bug with wrong viewport size under DLSS" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-29</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2025-12/pr-22240-en-20251229>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=solari-fix-bug-with-wrong-viewport-size-under-dlss>Solari: Fix bug with wrong viewport size under DLSS</h1><h2 id=ji-ben-xin-xi>基本信息</h2><ul><li><strong>标题</strong>: Solari: Fix bug with wrong viewport size under DLSS<li><strong>PR 链接</strong>: https://github.com/bevyengine/bevy/pull/22240<li><strong>作者</strong>: JMS55<li><strong>状态</strong>: 已合并 (MERGED)<li><strong>标签</strong>: C-Bug, A-Rendering, S-Ready-For-Final-Review, D-Straightforward<li><strong>创建时间</strong>: 2025-12-23T00:48:34Z<li><strong>合并时间</strong>: 2025-12-29T04:57:08Z<li><strong>合并者</strong>: alice-i-cecile</ul><h2 id=miao-shu-fan-yi>描述翻译</h2><p>修复 https://github.com/bevyengine/bevy/issues/22200<h2 id=ben-ci-pull-request-de-lai-long-qu-mai>本次 Pull Request 的来龙去脉</h2><p>这个 PR 修复了 Bevy 渲染引擎中 Solari 模块（一个实时光线追踪/全局光照系统）在使用 DLSS (Deep Learning Super Sampling) 时出现的一个关键 bug。问题的核心在于视口 (Viewport) 尺寸的错误使用，导致了渲染伪影。<p><strong>问题与背景</strong> 当启用 DLSS 或其他动态分辨率技术时，渲染管线可能会在主渲染视口 (<code>main_pass_viewport</code>) 之外使用一个不同的、用于上采样或抗锯齿的视口 (<code>viewport</code>)。Solari 的 ReSTIR (Resampled Importance Sampling via Temporal Importance Resampling) 算法在进行时域重投影 (temporal reprojection) 时，需要一个函数 (<code>permute_pixel</code>) 来对历史帧的像素坐标进行随机排列，以防止固定的重投影模式产生带状瑕疵。此函数需要知道当前视口的尺寸以正确计算排列。在修复前，代码错误地使用了 <code>view.viewport.zw</code>，这个值在 DLSS 下可能不是主渲染视口的尺寸，导致排列计算错误。最终表现为屏幕上出现闪烁或位置错误的像素，如同 issue #22200 所报告。<p><strong>解决方案与实现</strong> 解决方案非常直接：将错误的视口引用更正为正确的。开发者识别出在 <code>load_temporal_reservoir</code> 函数中，传递给 <code>permute_pixel</code> 的视口尺寸参数应该是主渲染视口的尺寸。因此，在两处关键代码中将 <code>view.viewport.zw</code> 替换为 <code>view.main_pass_viewport.zw</code>。<p>同时，PR 还包含了一个对 <code>sample_ggx_vndf</code> 函数的优化，将判断是否为镜面反射 (specular) 的粗糙度 (roughness) 阈值从 <code>0.01</code> 降低到 <code>0.001</code>。这个改动与主 bug 无关，但属于同一模块的质量改进。<code>sample_ggx_vndf</code> 函数用于对基于 GGX 分布的可见法线分布函数 (Visible Normal Distribution Function) 进行重要性采样。当粗糙度非常低（表面非常光滑）时，为了性能和数值稳定性，代码会采用一个简化的、精确的镜面反射方向作为采样结果。将阈值从 <code>0.01</code> 降低到 <code>0.001</code>，意味着只有更接近完美镜面的表面才会使用这个简化路径，从而在更多的表面上使用更精确的 VNDF 采样，提升了渲染质量，同时仍然为极端光滑的表面保留了性能优化。<p>从工程角度看，这次修复体现了对渲染管线数据流的清晰理解。<code>view</code> 结构体可能包含多个视口信息，正确区分 <code>viewport</code>（可能与后处理相关）和 <code>main_pass_viewport</code>（主渲染通道的视口）是保证空间-时域重投影算法正确性的基础。这个错误很隐蔽，因为它只在使用特定渲染技术（如 DLSS）时才会显现。<p><strong>影响</strong> 此修复直接解决了在启用 DLSS 时 Solari 渲染出现伪影的问题，确保了高级渲染功能组合（实时光线追踪 + AI 超分辨率）的稳定性和正确性。粗糙度阈值的微调虽然影响范围较小，但体现了对渲染细节的持续优化。整体而言，这是一个典型的、精准定位的图形渲染 bug 修复，通过微小的代码改动解决了特定的技术兼容性问题。<h2 id=shi-jue-biao-shi>视觉表示</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    subgraph "Bug 触发条件"
</span><span>        A[启用 DLSS] --> B[`view.viewport` != `view.main_pass_viewport`]
</span><span>    end
</span><span>    subgraph "错误影响路径"
</span><span>        B --> C[`permute_pixel` 函数接收到错误视口尺寸]
</span><span>        C --> D[像素重投影坐标计算错误]
</span><span>        D --> E[渲染出现时空不一致的伪影]
</span><span>    end
</span><span>    subgraph "修复方案"
</span><span>        F[将 `view.viewport.zw` 替换为 `view.main_pass_viewport.zw`] --> G[`permute_pixel` 计算正确]
</span><span>        G --> H[像素重投影准确，伪影消失]
</span><span>    end
</span><span>    subgraph "附带优化"
</span><span>        I[粗糙度阈值 0.01 -> 0.001] --> J[更多表面使用精确的 GGX VNDF 采样]
</span><span>        J --> K[渲染质量微幅提升]
</span><span>    end
</span></code></pre><h2 id=guan-jian-wen-jian-bian-geng>关键文件变更</h2><ol><li><p><strong><code>crates/bevy_solari/src/realtime/restir_di.wgsl</code> 与 <code>crates/bevy_solari/src/realtime/restir_gi.wgsl</code></strong></p> <ul><li><strong>变更描述</strong>: 修复了直接光照 (DI) 和间接光照 (GI) 的 ReSTIR 时域重投影中，用于像素排列的视口尺寸参数错误的问题。这是本次修复的核心。<li><strong>代码片段</strong>:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// 修复前:
</span><span>let permuted_temporal_pixel_id = permute_pixel(vec2&LTu32>(temporal_pixel_id_float), constants.frame_index, view.viewport.zw);
</span><span>
</span><span>// 修复后:
</span><span>let permuted_temporal_pixel_id = permute_pixel(vec2&LTu32>(temporal_pixel_id_float), constants.frame_index, view.main_pass_viewport.zw);
</span></code></pre></ul><li><p><strong><code>crates/bevy_solari/src/scene/sampling.wgsl</code></strong></p> <ul><li><strong>变更描述</strong>: 优化了 GGX VNDF 采样函数，降低了启用简化镜面反射路径的粗糙度阈值，使得更多表面采用精确采样，提升渲染质量。<li><strong>代码片段</strong>:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// 修复前:
</span><span>if roughness <= 0.01 {
</span><span>    return vec3(-wi_tangent.xy, wi_tangent.z);
</span><span>}
</span><span>
</span><span>// 修复后:
</span><span>if roughness <= 0.001 {
</span><span>    return vec3(-wi_tangent.xy, wi_tangent.z);
</span><span>}
</span></code></pre></ul><li><p><strong><code>crates/bevy_pbr/src/render/utils.wgsl</code></strong></p> <ul><li><strong>变更描述</strong>: 这是一个纯粹的格式化变更，在 <code>sample_cosine_hemisphere</code> 和 <code>sample_uniform_hemisphere</code> 函数之间添加了一个空行，提高了代码可读性，与功能修复无关。<li><strong>代码片段</strong>:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// 变更后（添加了一个空行）:
</span><span>fn sample_cosine_hemisphere(normal: vec3&LTf32>, rng: ptr&LTfunction, u32>) -> vec3&LTf32> {
</span><span>    ...
</span><span>}
</span><span>// 新增的空行在这里
</span><span>// https://www.pbr-book.org/3ed-2018/Monte_Carlo_Integration/2D_Sampling_with_Multidimensional_Transformations#UniformlySamplingaHemisphere
</span><span>fn sample_uniform_hemisphere(normal: vec3&LTf32>, rng: ptr&LTfunction, u32>) -> vec3&LTf32> {
</span><span>    ...
</span><span>}
</span></code></pre></ul></ol><h2 id=kuo-zhan-yue-du>扩展阅读</h2><ul><li><strong>ReSTIR 算法</strong>: 了解用于实时渲染的 Resampled Importance Sampling 技术。 <ul><li>原始论文: <em><a rel="noopener nofollow noreferrer" href=https://research.nvidia.com/publication/2020-07_spatiotemporal-reservoir-resampling-real-time-ray-tracing-dynamic-direct target=_blank>Spatiotemporal reservoir resampling for real-time ray tracing with dynamic direct lighting</a></em></ul><li><strong>DLSS (深度学习超级采样)</strong>: NVIDIA 的 AI 驱动的超分辨率技术。 <ul><li>NVIDIA 官方介绍: <a rel="noopener nofollow noreferrer" href=https://www.nvidia.com/en-us/geforce/technologies/dlss/ target=_blank>NVIDIA DLSS Technology</a></ul><li><strong>GGX 微表面模型与 VNDF 采样</strong>: 现代基于物理的渲染中用于模拟粗糙表面反射的核心模型及其高效采样方法。 <ul><li>Heitz, Eric. <em><a rel="noopener nofollow noreferrer" href=https://jcgt.org/published/0007/04/01/ target=_blank>Sampling the GGX Distribution of Visible Normals</a></em>. Journal of Computer Graphics Techniques, 2018.</ul><li><strong>Bevy 引擎渲染架构</strong>: 了解 Bevy 的渲染图 (Render Graph)、视口管理和着色器模块系统。</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22240.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>