<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22267 fix decal index selection in light textures
        
    </title><meta content="#22267 fix decal index selection in light textures" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-29</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2025-12/pr-22267-en-20251229>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=title>Title</h1><p>fix decal index selection in light textures<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: fix decal index selection in light textures<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22267<li><strong>Author</strong>: ChristopherBiscardi<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-12-25T17:04:39Z<li><strong>Merged</strong>: 2025-12-29T18:12:22Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><h1 id=mu-biao>目标</h1><p>https://github.com/bevyengine/bevy/pull/22039 修改了与一个decal（贴花）关联的贴图数量。光照纹理使用了decal的基础贴图，忽略了其他的贴图。<p>修复问题 #22266<h2 id=jie-jue-fang-an>解决方案</h2><p>使用基础颜色贴图的索引。<h2 id=ce-shi>测试</h2><pre style=color:#61676c;background-color:#fafafa><code><span>cargo run --example light_textures --features="pbr_light_textures"
</span></code></pre><h2 id=xiao-guo-zhan-shi>效果展示</h2><h3 id=xiu-fu-qian>修复前</h3><img alt="screenshot-2025-12-25-at-08 53 17@2x" height=1040 src=https://github.com/user-attachments/assets/77c26920-e7e2-4c96-8a94-275dfbaf759e width=2734><h3 id=xiu-fu-hou>修复后</h3><img alt="screenshot-2025-12-25-at-08 57 26@2x" height=1040 src=https://github.com/user-attachments/assets/cb9d9fce-4f7f-4ccf-8da3-560057d2fd2e width=2734><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>这个PR源于一个由前序PR引入的兼容性问题。PR #22039 修改了Bevy渲染引擎中Decal（贴花）系统的内部数据结构，使其能够支持多个贴图（例如基础颜色、法线、金属粗糙度等）。然而，这次重构并没有完全更新所有相关的代码路径。<p>问题的核心在于<code>pbr_lighting.wgsl</code>着色器文件中的光照计算逻辑。<code>Decal</code>结构体在Rust端的定义被更新了，从一个单一的<code>image_index</code>字段变为了存储多个贴图索引的结构，其中<code>base_color_texture_index</code>字段专门用于存储基础颜色贴图的索引。但是，在WGSL着色器代码中，光照函数（点光源、聚光灯、平行光）仍然在尝试访问旧的、已不存在的<code>image_index</code>字段来获取纹理。这导致着色器读取了错误的内存数据，进而引发了渲染错误，具体表现为贴花纹理无法正确应用到光照纹理上，如图片展示的那样。<p>解决这个问题的方法非常直接。开发者需要确保着色器代码与Rust端的结构体定义保持同步。修复方案就是简单地将三处<code>image_index</code>的引用替换为正确的<code>base_color_texture_index</code>。<p>这个修复虽然只涉及三行代码的修改，但至关重要。它确保了光照系统能够正确地索引到decal的基础颜色纹理，从而让基于贴花的投影纹理光照功能恢复正常。这个案例提醒我们，在修改底层数据结构（尤其是在渲染管线中）时，必须仔细检查所有依赖该结构的代码，包括CPU端的Rust代码和GPU端的着色器代码。即使是一个微小的字段重命名或结构调整，如果漏掉了对某处着色器代码的更新，也可能导致难以调试的渲染错误。<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    PR22039[PR #22039: Decal 重构] -->|引入多纹理支持| DecalStruct[Decal 结构体]
</span><span>    DecalStruct -->|包含| BaseColorIndex[base_color_texture_index 字段]
</span><span>    DecalStruct -.->|不再包含| OldImageIndex[image_index 字段]
</span><span>    LightingShader[光照着色器 pbr_lighting.wgsl] -->|错误引用| OldImageIndex
</span><span>    LightingShader -.->|未同步| DecalStruct
</span><span>    PR22267[PR #22267: 修复] -->|更新引用| LightingShader
</span><span>    LightingShader -->|正确引用| BaseColorIndex
</span><span>    LightingShader -->|功能恢复| CorrectRendering[正确渲染]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ul><li><code>crates/bevy_pbr/src/render/pbr_lighting.wgsl</code> (+3/-3)</ul><p>此文件是Bevy PBR（基于物理的渲染）管线中的核心WebGPU着色语言（WGSL）文件，负责计算点光源、聚光灯和平行光的光照贡献。PR的修改发生在此文件中访问Decal纹理索引的三处地方。<ol><li><strong>修改详情</strong>：在三个不同的光照函数（<code>point_light</code>, <code>spot_light</code>, <code>directional_light</code>）中，将获取Decal纹理索引的字段从<code>image_index</code>更正为<code>base_color_texture_index</code>。这个改动是为了与Rust端的<code>Decal</code>结构体定义保持一致。</ol><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// File: crates/bevy_pbr/src/render/pbr_lighting.wgsl
</span><span>// 修改前（第714行，point_light函数内）：
</span><span>let image_index = view_bindings::clustered_decals.decals[(*light).decal_index].image_index;
</span><span>
</span><span>// 修改后（第714行，point_light函数内）：
</span><span>let image_index = view_bindings::clustered_decals.decals[(*light).decal_index].base_color_texture_index;
</span><span>
</span><span>// 修改前（第762行，spot_light函数内）：
</span><span>let image_index = view_bindings::clustered_decals.decals[(*light).decal_index].image_index;
</span><span>
</span><span>// 修改后（第762行，spot_light函数内）：
</span><span>let image_index = view_bindings::clustered_decals.decals[(*light).decal_index].base_color_texture_index;
</span><span>
</span><span>// 修改前（第843行，directional_light函数内）：
</span><span>let image_index = view_bindings::clustered_decals.decals[(*light).decal_index].image_index;
</span><span>
</span><span>// 修改后（第843行，directional_light函数内）：
</span><span>let image_index = view_bindings::clustered_decals.decals[(*light).decal_index].base_color_texture_index;
</span></code></pre><ol start=2><li><strong>与PR目标的关系</strong>：这个文件是问题发生的直接位置。PR #22039修改了数据源的字段名，但未同步更新此消费端的着色器代码，导致了字段引用错误。此PR的修改直接解决了这个不一致问题，是修复渲染错误的关键。</ol><h2 id=further-reading>Further Reading</h2><ol><li><strong>相关PR</strong>: <a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/pull/22039 target=_blank>PR #22039</a> - 这是引入变更的前序PR，理解它如何修改<code>Decal</code>结构体有助于更全面地理解本修复的背景。<li><strong>Bevy 渲染管线文档</strong>: 官方文档或社区指南中关于PBR渲染、光照和贴花系统的部分，可以帮助理解这些组件如何协同工作。<li><strong>WGSL 规范</strong>: WebGPU Shading Language 的规范，有助于理解着色器代码的语法和结构，特别是<code>view_bindings</code>和纹理采样的部分。<li><strong>Issue #22266</strong>: 本PR修复的原始问题报告，可能包含更多的错误现象和讨论细节。</ol><h1 id=full-code-diff>Full Code Diff</h1><p>diff –git a/crates/bevy_pbr/src/render/pbr_lighting.wgsl b/crates/bevy_pbr/src/render/pbr_lighting.wgsl index 6dff89c041a9f..e4724b89c02e3 100644 — a/crates/bevy_pbr/src/render/pbr_lighting.wgsl +++ b/crates/bevy_pbr/src/render/pbr_lighting.wgsl @@ -711,7 +711,7 @@ fn point_light( let relative_position = (view_bindings::clustered_decals.decals[(*light).decal_index].local_from_world * vec4(P, 1.0)).xyz; let cubemap_type = view_bindings::clustered_decals.decals[(*light).decal_index].tag; let decal_uv = cubemap_uv(relative_position, cubemap_type);<ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>   let image_index = view_bindings::clustered_decals.decals[(*light).decal_index].image_index;
</span></code></pre></ul><ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>   let image_index = view_bindings::clustered_decals.decals[(*light).decal_index].base_color_texture_index;
</span><span>
</span><span>   texture_sample = textureSampleLevel(
</span><span>       view_bindings::clustered_decal_textures[image_index],
</span></code></pre></ul><p>@@ -759,7 +759,7 @@ fn spot_light( vec4((*input).P, 1.0)).xyz; if local_position.z < 0.0 { let decal_uv = (local_position.xy / (local_position.z * (*light).spot_light_tan_angle)) * vec2(-0.5, 0.5) + 0.5;<ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>       let image_index = view_bindings::clustered_decals.decals[(*light).decal_index].image_index;
</span></code></pre></ul><ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>       let image_index = view_bindings::clustered_decals.decals[(*light).decal_index].base_color_texture_index;
</span><span>
</span><span>       texture_sample = textureSampleLevel(
</span><span>           view_bindings::clustered_decal_textures[image_index],
</span></code></pre></ul><p>@@ -840,7 +840,7 @@ fn directional_light( if (view_bindings::clustered_decals.decals[(*light).decal_index].tag != 0u) || all(clamp(decal_uv, vec2(0.0), vec2(1.0)) == decal_uv) {<ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>       let image_index = view_bindings::clustered_decals.decals[(*light).decal_index].image_index;
</span></code></pre></ul><ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>       let image_index = view_bindings::clustered_decals.decals[(*light).decal_index].base_color_texture_index;
</span><span>
</span><span>       texture_sample = textureSampleLevel(
</span><span>           view_bindings::clustered_decal_textures[image_index],</span></code></pre></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22267.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>