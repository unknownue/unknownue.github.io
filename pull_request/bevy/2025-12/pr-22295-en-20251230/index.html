<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22295 Solari: More examples, fix emissive
        
    </title><meta content="#22295 Solari: More examples, fix emissive" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-30</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22295-zh-cn-20251230>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Solari: More examples, fix emissive<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22295<li><strong>Author</strong>: JMS55<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, C-Examples, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-12-29T02:28:48Z<li><strong>Merged</strong>: 2025-12-30T01:56:11Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>This PR makes three main changes to the Solari rendering system:<ul><li>Add a small profiling overlay to the Solari example that times different parts of Solari’s GPU work (DLSS-RR not added because wgpu timestamps aren’t working correctly with wgpu_hal work, I need to fix that as a separate thing)<li>Add a many-lights stress test to the Solari example (100 lights) inspired by https://x.com/Roystoncinemo/status/1841917611833229411. Currently somewhat unusable, but this will hopefully be a bigger focus for Solari 0.19.<li>Changed emissive to have exposure applied, as if <code>emissive_exposure_weight</code> was always set to 1.0 (StandardMaterial defaults to 0.0 which I’m not convinced is a good idea, but that’s a separate topic). If we didn’t do this, the emissive meshes would render as insanely bright white to the point of overflowing the texture and breaking DLSS-RR. I think the new behavior is more what people expect to happen, and matches the pathtracer result now. <img alt=image height=1875 src=https://github.com/user-attachments/assets/af3990d6-ae2d-4520-a7cd-f04041685152 width=3206></ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This pull request addresses several practical issues with Bevy’s Solari real-time rendering system: it adds performance profiling capabilities, introduces a stress test for many-light scenarios, and fixes a critical issue with emissive materials that was causing rendering artifacts and breaking DLSS-RR.<h3 id=the-problem-and-context>The Problem and Context</h3><p>The developer faced three distinct but related issues:<ol><li><strong>Lack of performance visibility</strong>: Developers using Solari couldn’t easily measure the GPU time spent in different stages of the rendering pipeline, making optimization work difficult.<li><strong>Missing stress testing</strong>: The system lacked a test case for handling many light sources, which is a common real-world scenario that can expose performance bottlenecks.<li><strong>Incorrect emissive material handling</strong>: Emissive materials weren’t having exposure applied, causing them to render as extremely bright white. This wasn’t just a visual issue - it was breaking DLSS-RR (Deep Learning Super Sampling Ray Reconstruction) by overflowing texture values.</ol><h3 id=the-solution-approach>The Solution Approach</h3><p>The developer took a straightforward engineering approach to each problem:<ol><li><strong>Performance profiling</strong>: Added fine-grained timing spans to the Solari render graph node, then created a UI overlay to display these timings.<li><strong>Stress test</strong>: Created a new scene setup with 100 emissive spheres (acting as lights) and 200 randomly placed cubes to test many-light performance.<li><strong>Emissive fix</strong>: Changed the order of operations in the shader to apply exposure <em>after</em> adding emissive contributions, effectively treating <code>emissive_exposure_weight</code> as 1.0.</ol><p>The developer made pragmatic decisions based on what would provide immediate value while acknowledging that some issues (like wgpu timestamp support for DLSS-RR profiling) would need to be addressed separately.<h3 id=the-implementation>The Implementation</h3><p>The changes can be broken down into three main areas:<p><strong>Performance Profiling Overlay</strong> The render graph node (<code>node.rs</code>) was modified to add detailed timing spans for each major stage of the Solari pipeline: light tile presampling, world cache updates, direct lighting, diffuse indirect lighting, and specular indirect lighting. Previously, there was only a single timing span for the entire “solari_lighting” pass.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Single timing span
</span><span style=color:#fa6e32>let</span><span> pass_span </span><span style=color:#ed9366>=</span><span> diagnostics</span><span style=color:#ed9366>.</span><span style=color:#f07171>pass_span</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> pass</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"solari_lighting"</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Multiple detailed spans
</span><span style=color:#fa6e32>let</span><span> d </span><span style=color:#ed9366>=</span><span> diagnostics</span><span style=color:#ed9366>.</span><span style=color:#f07171>time_span</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> pass</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"solari_lighting/presample_light_tiles"</span><span>)</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// ... setup and dispatch ...
</span><span>d</span><span style=color:#ed9366>.</span><span style=color:#f07171>end</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> pass)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>let</span><span> d </span><span style=color:#ed9366>=</span><span> diagnostics</span><span style=color:#ed9366>.</span><span style=color:#f07171>time_span</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> pass</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"solari_lighting/world_cache"</span><span>)</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// ... more work ...
</span><span>d</span><span style=color:#ed9366>.</span><span style=color:#f07171>end</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> pass)</span><span style=color:#61676ccc>;
</span></code></pre><p>This detailed breakdown allows developers to identify which specific parts of the pipeline are bottlenecks.<p><strong>Many-Lights Stress Test</strong> A new <code>setup_many_lights</code> function was added that creates a scene with:<ul><li>A large checkerboard plane with UV coordinates scaled by 3x<li>200 randomly scaled and positioned cubes with random colors and roughness<li>100 randomly positioned emissive spheres with high-intensity random colors</ul><p>The scene uses deterministic random generation (ChaCha8Rng with seed 42) for reproducibility. This setup is activated via a new command-line flag <code>--many-lights</code>.<p><strong>Emissive Material Fix</strong> The shader code in both <code>restir_di.wgsl</code> and <code>restir_gi.wgsl</code> was modified to apply exposure multiplication <em>after</em> adding the emissive term:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before in restir_di.wgsl:
</span><span>var pixel_color = merge_result.selected_sample_radiance * combined_reservoir.unbiased_contribution_weight;
</span><span>pixel_color *= view.exposure;
</span><span>pixel_color *= brdf;
</span><span>pixel_color += surface.material.emissive;
</span><span>
</span><span>// After:
</span><span>var pixel_color = merge_result.selected_sample_radiance * combined_reservoir.unbiased_contribution_weight;
</span><span>pixel_color *= brdf;
</span><span>pixel_color += surface.material.emissive;
</span><span>pixel_color *= view.exposure;
</span></code></pre><p>This change ensures that emissive materials are affected by the scene’s exposure settings, preventing them from being unrealistically bright and avoiding texture value overflow issues.<h3 id=technical-insights>Technical Insights</h3><p>The emissive fix reveals an interesting aspect of physically based rendering: exposure control should apply to <em>all</em> light sources in the scene, including emissive materials. By applying exposure after adding emissive contributions, we treat emissive materials as proper light sources that participate in the scene’s overall lighting model.<p>The performance profiling implementation demonstrates Bevy’s diagnostic system capabilities. Each timing span corresponds to a specific stage in the render graph, and these can be queried at runtime to display performance metrics. The developer noted that DLSS-RR timing isn’t included due to issues with wgpu timestamps, which highlights the practical challenges of GPU profiling across different hardware and API layers.<p>The many-lights example uses a clever approach to testing: it doesn’t try to create a perfectly artistic scene, but rather a stress test that pushes the system to its limits. The 100 emissive spheres (each with random colors up to 20,000 intensity) create a challenging lighting scenario that will help identify performance bottlenecks in Solari’s lighting algorithms.<h3 id=the-impact>The Impact</h3><p>These changes provide immediate practical benefits:<ol><li><strong>Better debugging</strong>: Developers can now see exactly where time is being spent in the Solari pipeline, making optimization efforts more targeted.<li><strong>Real-world testing</strong>: The many-lights example exposes performance issues that might not show up in simpler scenes, helping guide future development of Solari 0.19.<li><strong>Visual correctness</strong>: Emissive materials now behave more predictably and won’t break DLSS-RR, improving both visual quality and stability.</ol><p>The changes are backward compatible - existing scenes will see improved emissive material behavior without requiring code changes. The performance overlay is opt-in (only in the example), and the many-lights test is a separate example mode.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Solari Example] --> B{Command Line Flag}
</span><span>    B -->|--many-lights| C[Many Lights Stress Test]
</span><span>    B -->|default| D[Original Pica Pica Scene]
</span><span>    
</span><span>    E[Performance Overlay] --> F[Render Diagnostics]
</span><span>    F --> G[Timing Spans]
</span><span>    G --> H[presample_light_tiles]
</span><span>    G --> I[world_cache]
</span><span>    G --> J[direct_lighting]
</span><span>    G --> K[diffuse_indirect_lighting]
</span><span>    G --> L[specular_indirect_lighting]
</span><span>    
</span><span>    M[Shader Fix] --> N[Emissive Materials]
</span><span>    N --> O[Apply Exposure After Emissive]
</span><span>    O --> P[Prevent Texture Overflow]
</span><span>    P --> Q[Fix DLSS-RR Breakage]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=examples-3d-solari-rs-268-11><code>examples/3d/solari.rs</code> (+268/-11)</h3><p><strong>What changed</strong>: Added performance profiling UI, many-lights stress test scene, and refactored the example to support multiple scenes.<p><strong>Key modifications</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added command-line argument for many-lights test
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>argh</span><span>(switch)]
</span><span>many_lights</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#fa6e32>bool</span><span>></span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Conditional scene setup based on command-line flag
</span><span style=color:#fa6e32>if</span><span> args</span><span style=color:#ed9366>.</span><span>many_lights </span><span style=color:#ed9366>== </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#ff8f40>true</span><span>) {
</span><span>    app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(Startup</span><span style=color:#61676ccc>,</span><span> setup_many_lights)</span><span style=color:#61676ccc>;
</span><span>} </span><span style=color:#fa6e32>else </span><span>{
</span><span>    app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(Startup</span><span style=color:#61676ccc>,</span><span> setup_pica_pica)</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Performance overlay UI with detailed timing display
</span><span>commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((
</span><span>    Node {
</span><span>        position_type</span><span style=color:#61676ccc>: </span><span>PositionType</span><span style=color:#ed9366>::</span><span>Absolute</span><span style=color:#61676ccc>,
</span><span>        right</span><span style=color:#61676ccc>: </span><span style=color:#f07171>px</span><span>(</span><span style=color:#ff8f40>0.0</span><span>)</span><span style=color:#61676ccc>,
</span><span>        padding</span><span style=color:#61676ccc>: </span><span style=color:#f07171>px</span><span>(</span><span style=color:#ff8f40>4.0</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>all</span><span>()</span><span style=color:#61676ccc>,
</span><span>        border_radius</span><span style=color:#61676ccc>: </span><span>BorderRadius</span><span style=color:#ed9366>::</span><span>bottom_left(</span><span style=color:#f07171>px</span><span>(</span><span style=color:#ff8f40>4.0</span><span>))</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#ed9366>..</span><span style=color:#f07171>default</span><span>()
</span><span>    }</span><span style=color:#61676ccc>,
</span><span>    BackgroundColor(Color</span><span style=color:#ed9366>::</span><span>srgba(</span><span style=color:#ff8f40>0.10</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.10</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.10</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.8</span><span>))</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#f07171>children!</span><span>[(
</span><span>        PerformanceText</span><span style=color:#61676ccc>,
</span><span>        Text</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>,
</span><span>        TextFont {
</span><span>            font_size</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>8.0</span><span style=color:#61676ccc>,
</span><span>            </span><span style=color:#ed9366>..</span><span style=color:#f07171>default</span><span>()
</span><span>        }</span><span style=color:#61676ccc>,
</span><span>    )]</span><span style=color:#61676ccc>,
</span><span>))</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Function to update performance text with detailed timing
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>update_performance_text</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>text</span><span style=color:#61676ccc>: </span><span>Single<</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> Text, With&LTPerformanceText>>,
</span><span>    </span><span style=color:#ff8f40>diagnostics</span><span style=color:#61676ccc>: </span><span>Res&LTDiagnosticsStore>,
</span><span>) {
</span><span>    text</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0.</span><span style=color:#f07171>clear</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> total </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0.0</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let mut </span><span style=color:#f29718>add_diagnostic </span><span style=color:#ed9366>= </span><span>|</span><span style=color:#ff8f40>name</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>str</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>path</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'static str</span><span>| {
</span><span>        </span><span style=color:#fa6e32>let</span><span> path </span><span style=color:#ed9366>= </span><span>DiagnosticPath</span><span style=color:#ed9366>::</span><span>new(path)</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(average) </span><span style=color:#ed9366>=</span><span> diagnostics</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#ed9366>&</span><span>path)</span><span style=color:#ed9366>.</span><span style=color:#f07171>and_then</span><span>(Diagnostic</span><span style=color:#ed9366>::</span><span>average) {
</span><span>            text</span><span style=color:#ed9366>.</span><span style=color:#f07171>push_str</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#f07171>format!</span><span>(</span><span style=color:#86b300>"{name:17}  </span><span style=color:#ff8f40>{average:.2}</span><span style=color:#86b300> ms</span><span style=color:#4cbf99>\n</span><span style=color:#86b300>"</span><span>))</span><span style=color:#61676ccc>;
</span><span>            total </span><span style=color:#ed9366>+=</span><span> average</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>    }</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... timing display for each pipeline stage
</span><span>}
</span></code></pre><p><strong>Relation to PR purpose</strong>: This file implements the user-facing changes - the performance overlay and the new stress test scene.<h3 id=crates-bevy-solari-src-realtime-node-rs-16-3><code>crates/bevy_solari/src/realtime/node.rs</code> (+16/-3)</h3><p><strong>What changed</strong>: Added detailed timing spans for each major stage of the Solari lighting pipeline.<p><strong>Key modifications</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Removed single timing span
</span><span style=color:#abb0b6;font-style:italic>// let pass_span = diagnostics.pass_span(&mut pass, "solari_lighting");
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Added individual timing spans for each pipeline stage
</span><span style=color:#fa6e32>let</span><span> d </span><span style=color:#ed9366>=</span><span> diagnostics</span><span style=color:#ed9366>.</span><span style=color:#f07171>time_span</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> pass</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"solari_lighting/presample_light_tiles"</span><span>)</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// ... pipeline setup and dispatch ...
</span><span>d</span><span style=color:#ed9366>.</span><span style=color:#f07171>end</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> pass)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>let</span><span> d </span><span style=color:#ed9366>=</span><span> diagnostics</span><span style=color:#ed9366>.</span><span style=color:#f07171>time_span</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> pass</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"solari_lighting/world_cache"</span><span>)</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// ... more work ...
</span><span>d</span><span style=color:#ed9366>.</span><span style=color:#f07171>end</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> pass)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Similar pattern for direct_lighting, diffuse_indirect_lighting, specular_indirect_lighting
</span></code></pre><p><strong>Relation to PR purpose</strong>: This enables the performance profiling by breaking down the single timing measurement into detailed per-stage measurements.<h3 id=crates-bevy-solari-src-realtime-restir-di-wgsl-1-1><code>crates/bevy_solari/src/realtime/restir_di.wgsl</code> (+1/-1)</h3><p><strong>What changed</strong>: Reordered operations to apply exposure after adding emissive contribution.<p><strong>Key modifications</strong>:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>var pixel_color = merge_result.selected_sample_radiance * combined_reservoir.unbiased_contribution_weight;
</span><span>pixel_color *= view.exposure;
</span><span>pixel_color *= brdf;
</span><span>pixel_color += surface.material.emissive;
</span><span>
</span><span>// After:
</span><span>var pixel_color = merge_result.selected_sample_radiance * combined_reservoir.unbiased_contribution_weight;
</span><span>pixel_color *= brdf;
</span><span>pixel_color += surface.material.emissive;
</span><span>pixel_color *= view.exposure;
</span></code></pre><p><strong>Relation to PR purpose</strong>: This fixes the emissive material issue by ensuring exposure applies to emissive contributions.<h3 id=crates-bevy-solari-src-realtime-restir-gi-wgsl-12-5><code>crates/bevy_solari/src/realtime/restir_gi.wgsl</code> (+12/-5)</h3><p><strong>What changed</strong>: Modified indirect lighting shader to apply visibility tracing in a different place, with conditional compilation for biased vs unbiased resampling.<p><strong>Key modifications</strong>:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Added conditional storage of reservoir based on BIASED_RESAMPLING define
</span><span>#ifndef BIASED_RESAMPLING
</span><span>    gi_reservoirs_a[pixel_index] = combined_reservoir;
</span><span>#endif
</span><span>
</span><span>// Apply visibility tracing
</span><span>combined_reservoir.unbiased_contribution_weight *= trace_point_visibility(surface.world_position, combined_reservoir.sample_point_world_position);
</span><span>
</span><span>#ifdef BIASED_RESAMPLING
</span><span>    gi_reservoirs_a[pixel_index] = combined_reservoir;
</span><span>#endif
</span><span>
</span><span>// Simplified neighbor loading by removing visibility multiplication
</span><span>let spatial_reservoir = gi_reservoirs_b[spatial_pixel_index];
</span><span>// (removed: spatial_reservoir.radiance *= trace_point_visibility(...))
</span></code></pre><p><strong>Relation to PR purpose</strong>: This optimizes the indirect lighting shader and provides configurability for the trade-off between accuracy and stability in visibility calculations.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/advanced-topics/rendering/render-graph/ target=_blank>Bevy Render Graph Documentation</a> - Understanding how timing spans fit into Bevy’s render graph system<li><a rel="noopener nofollow noreferrer" href=https://learnopengl.com/PBR/Theory target=_blank>Physically Based Rendering (PBR) Theory</a> - Background on how exposure affects lighting calculations<li><a rel="noopener nofollow noreferrer" href=https://www.w3.org/TR/WGSL/ target=_blank>WGSL Shader Language Specification</a> - For understanding the shader code changes<li><a rel="noopener nofollow noreferrer" href=https://research.nvidia.com/publication/2021-06_restir-gi-path-resampling-real-time-path-tracing target=_blank>ReSTIR GI Paper</a> - Technical details on the indirect lighting algorithm used in Solari<li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/diagnostic/ target=_blank>Bevy Diagnostics System</a> - How Bevy handles performance measurements and diagnostics</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22295.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>