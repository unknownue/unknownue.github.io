<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22213 Delete `InstrumentedAssetLoader` and `InstrumentedAssetProcessor`, but keep the instrumentation.
        
    </title><meta content="#22213 Delete `InstrumentedAssetLoader` and `InstrumentedAssetProcessor`, but keep the instrumentation." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-23</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22213-zh-cn-20251223>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Delete <code>InstrumentedAssetLoader</code> and <code>InstrumentedAssetProcessor</code>, but keep the instrumentation.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22213<li><strong>Author</strong>: andriyDev<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Assets, S-Ready-For-Final-Review, D-Straightforward<li><strong>Created</strong>: 2025-12-20T22:31:08Z<li><strong>Merged</strong>: 2025-12-22T23:53:40Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>In #12988, we added tracing spans to asset loading and processing, by creating wrapper structs <code>InstrumentedAssetLoader</code> and <code>InstrumentedAssetProcessor</code>.<li>Unfortunately, this causes an issue where <code>ErasedAssetLoader::{default_meta, type_path}</code> and <code>ErasedProcessor::default_meta</code> can return the wrong type path when using the <code>trace</code> feature, and this type path could be written into a meta file, which will be rendered unloadable/unprocessable. <ul><li>Note even though the loader/processor’s type use to have the instrumentation wrapper, when registering the loader/processor, we would actually register the loader/processor under the original type names. So you could still load non-<code>trace</code> written meta files, but <code>trace</code> written meta files would fail to load whether <code>trace</code> was enabled or not!</ul></ul><h2 id=solution>Solution</h2><ul><li>Remove the wrapper loader/processor and instead just create the spans at the callsites. I checked and there’s a single callsite of <code>load</code> and a single callsite of <code>process</code> - very good!<li>I also added testing that was omitted in #17216 (due to missing test utilities which have since been added). This is how I found out about this problem! Score one for testing.</ul><h2 id=testing>Testing</h2><ul><li>We still produce spans in the <code>asset_processing</code> example for both loading and processing.</ul><p>Note: We don’t need a migration guide since users should really not be using these directly, and any meta files using these would just be broken.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a subtle but significant bug in Bevy’s asset system related to how tracing instrumentation was implemented. The issue stemmed from the approach taken in PR #12988, which added tracing spans to asset loading and processing by creating wrapper structs around the actual loader and processor types.<p>The core problem was that when the <code>trace</code> feature was enabled, the wrapper structs (<code>InstrumentedAssetLoader</code> and <code>InstrumentedAssetProcessor</code>) were being used, and their type paths were being returned by the <code>ErasedAssetLoader::type_path()</code> and <code>ErasedAssetLoader::default_meta()</code> methods. This caused incorrect type paths to be written into asset meta files. Specifically, the meta files would contain the type path of the wrapper struct (e.g., <code>InstrumentedAssetLoader&LTMyLoader></code>) instead of the actual loader type (<code>MyLoader</code>). Since asset loaders and processors are registered under their original type names, these meta files would fail to load or process regardless of whether the <code>trace</code> feature was enabled.<p>The developer discovered this bug while adding tests that were missing from PR #17216. The tests involved writing default meta files for loaders and processors, which revealed that the type paths being written were incorrect when <code>trace</code> was enabled.<p>The solution was straightforward: instead of wrapping the loaders and processors at registration time, the tracing spans are now created directly at the callsites where <code>load</code> and <code>process</code> are invoked. This approach has several advantages:<ol><li>It eliminates the wrapper structs entirely, so the type paths remain correct.<li>It centralizes the tracing logic to just two locations (one for loading, one for processing), making the code easier to maintain.<li>It preserves the tracing functionality while fixing the bug.</ol><p>The implementation required changes in several files:<ul><li>The wrapper structs and their implementations were removed from <code>loaders.rs</code> and <code>processor/mod.rs</code>.<li>The <code>ErasedProcessor</code> trait needed a new <code>type_path()</code> method to expose the processor’s type path without relying on the wrapper.<li>Tracing spans were added directly in <code>AssetServer::load_with_meta_loader</code> and <code>AssetProcessor::process_asset</code>.<li>Tests were added to verify that default meta files are written with the correct type paths.</ul><p>One important detail in the implementation is the use of Rust’s <code>#[cfg(feature = "trace")]</code> attribute to conditionally compile the tracing instrumentation. This ensures that the tracing code only affects builds with the <code>trace</code> feature enabled, maintaining performance for release builds.<p>The fix also included a minor adjustment to the meta serialization code to use consistent newline characters (<code>\n</code>) across platforms, which was necessary for the new tests to pass on Windows.<p>This PR demonstrates the importance of comprehensive testing in complex systems like asset pipelines. The bug was only discovered because the developer added tests for writing default meta files, which had been omitted from a previous PR. Without these tests, the issue might have gone unnoticed until users encountered corrupted meta files in production.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Asset Loading/Processing] --> B{Is trace feature enabled?}
</span><span>    B -->|Yes| C[Create tracing span at callsite]
</span><span>    B -->|No| D[Proceed without tracing]
</span><span>    C --> E[Execute loader/processor]
</span><span>    D --> E
</span><span>    E --> F[Return result]
</span><span>    
</span><span>    G[Before: Wrapper Approach] --> H[Loader/Processor wrapped in Instrumented*]
</span><span>    H --> I[Wrapper's type path returned]
</span><span>    I --> J[Incorrect meta files written]
</span><span>    
</span><span>    K[After: Callsite Approach] --> L[Loader/Processor used directly]
</span><span>    L --> M[Correct type path returned]
</span><span>    M --> N[Correct meta files written]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-asset-src-server-loaders-rs-0-45><code>crates/bevy_asset/src/server/loaders.rs</code> (+0/-45)</h3><p><strong>What changed</strong>: Removed the <code>InstrumentedAssetLoader</code> wrapper struct and its implementation. <strong>Why</strong>: The wrapper was causing incorrect type paths to be returned when the <code>trace</code> feature was enabled.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Removed entirely:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"trace"</span><span>)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(TypePath)]
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>InstrumentedAssetLoader</span><span>&LTT>(T)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"trace"</span><span>)]
</span><span style=color:#fa6e32>impl</span><span>&LTT</span><span style=color:#61676ccc>:</span><span> AssetLoader> AssetLoader </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>InstrumentedAssetLoader</span><span>&LTT> {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... implementation that wrapped the loader with tracing spans
</span><span>}
</span></code></pre><h3 id=crates-bevy-asset-src-server-mod-rs-13-3><code>crates/bevy_asset/src/server/mod.rs</code> (+13/-3)</h3><p><strong>What changed</strong>: Added tracing spans directly at the <code>load</code> callsite instead of using a wrapper. <strong>Why</strong>: This ensures the correct loader type path is used while maintaining tracing functionality.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// After: Tracing span created at callsite
</span><span style=color:#fa6e32>let</span><span> load </span><span style=color:#ed9366>=</span><span> AssertUnwindSafe(loader</span><span style=color:#ed9366>.</span><span style=color:#f07171>load</span><span>(reader</span><span style=color:#61676ccc>,</span><span> settings</span><span style=color:#61676ccc>,</span><span> load_context))</span><span style=color:#ed9366>.</span><span style=color:#f07171>catch_unwind</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"trace"</span><span>)]
</span><span style=color:#fa6e32>let</span><span> load </span><span style=color:#ed9366>= </span><span>{
</span><span>    </span><span style=color:#fa6e32>use </span><span>tracing</span><span style=color:#ed9366>::</span><span>Instrument</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#fa6e32>let</span><span> span </span><span style=color:#ed9366>= </span><span>tracing</span><span style=color:#ed9366>::</span><span>info_span</span><span style=color:#ed9366>!</span><span>(
</span><span>        </span><span style=color:#86b300>"asset loading"</span><span style=color:#61676ccc>,
</span><span>        loader </span><span style=color:#ed9366>=</span><span> loader</span><span style=color:#ed9366>.</span><span style=color:#f07171>type_path</span><span>()</span><span style=color:#61676ccc>,
</span><span>        asset </span><span style=color:#ed9366>=</span><span> asset_path</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_string</span><span>()
</span><span>    )</span><span style=color:#61676ccc>;
</span><span>    load</span><span style=color:#ed9366>.</span><span style=color:#f07171>instrument</span><span>(span)
</span><span>}</span><span style=color:#61676ccc>;
</span><span>load</span><span style=color:#ed9366>.</span><span>await
</span></code></pre><h3 id=crates-bevy-asset-src-processor-mod-rs-11-33><code>crates/bevy_asset/src/processor/mod.rs</code> (+11/-33)</h3><p><strong>What changed</strong>: Removed <code>InstrumentedAssetProcessor</code> wrapper and added tracing at the <code>process</code> callsite. <strong>Why</strong>: Similar to the loader fix - ensures correct processor type paths in meta files.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// After: Tracing span created at callsite
</span><span style=color:#fa6e32>let</span><span> process </span><span style=color:#ed9366>=</span><span> processor</span><span style=color:#ed9366>.</span><span style=color:#f07171>process</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> context</span><span style=color:#61676ccc>,</span><span> settings</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ed9366>*</span><span>writer)</span><span style=color:#61676ccc>;
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"trace"</span><span>)]
</span><span style=color:#fa6e32>let</span><span> process </span><span style=color:#ed9366>= </span><span>{
</span><span>    </span><span style=color:#fa6e32>let</span><span> span </span><span style=color:#ed9366>= </span><span style=color:#f07171>info_span!</span><span>(
</span><span>        </span><span style=color:#86b300>"asset processing"</span><span style=color:#61676ccc>,
</span><span>        processor </span><span style=color:#ed9366>=</span><span> processor</span><span style=color:#ed9366>.</span><span style=color:#f07171>type_path</span><span>()</span><span style=color:#61676ccc>,
</span><span>        asset </span><span style=color:#ed9366>=</span><span> asset_path</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_string</span><span>()</span><span style=color:#61676ccc>,
</span><span>    )</span><span style=color:#61676ccc>;
</span><span>    process</span><span style=color:#ed9366>.</span><span style=color:#f07171>instrument</span><span>(span)
</span><span>}</span><span style=color:#61676ccc>;
</span><span>process</span><span style=color:#ed9366>.</span><span>await</span><span style=color:#ed9366>?
</span></code></pre><h3 id=crates-bevy-asset-src-processor-process-rs-2-0><code>crates/bevy_asset/src/processor/process.rs</code> (+2/-0)</h3><p><strong>What changed</strong>: Added <code>type_path()</code> method to the <code>ErasedProcessor</code> trait. <strong>Why</strong>: Needed to get the processor’s type path without relying on wrapper structs.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub trait </span><span style=color:#399ee6>ErasedProcessor</span><span>: Send + Sync {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... existing methods
</span><span>    </span><span style=color:#abb0b6;font-style:italic>/// Returns the type-path of the original [`Process`].
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>type_path</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'static str</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#fa6e32>impl</span><span>&LTP</span><span style=color:#61676ccc>:</span><span> Process> ErasedProcessor </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>P </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>type_path</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'static str </span><span>{
</span><span>        P</span><span style=color:#ed9366>::</span><span>type_path()
</span><span>    }
</span><span>}
</span></code></pre><h3 id=crates-bevy-asset-src-lib-rs-66-2-and-crates-bevy-asset-src-processor-tests-rs-88-6><code>crates/bevy_asset/src/lib.rs</code> (+66/-2) and <code>crates/bevy_asset/src/processor/tests.rs</code> (+88/-6)</h3><p><strong>What changed</strong>: Added test utilities and tests for writing default meta files. <strong>Why</strong>: To verify that the fix works correctly and prevent regressions.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Test utility added to lib.rs
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>read_meta_as_string</span><span>(</span><span style=color:#ff8f40>dir</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>Dir, </span><span style=color:#ff8f40>path</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>Path) </span><span style=color:#61676ccc>-></span><span> String {
</span><span>    </span><span style=color:#fa6e32>let</span><span> bytes </span><span style=color:#ed9366>=</span><span> dir</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_metadata</span><span>(path)</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>str</span><span style=color:#ed9366>::</span><span>from_utf8(bytes</span><span style=color:#ed9366>.</span><span style=color:#f07171>value</span><span>())</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_string</span><span>()
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Test added to verify loader meta writing
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>writes_default_meta_for_loader</span><span>() {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... test setup
</span><span>    </span><span style=color:#f07171>assert_eq!</span><span>(
</span><span>        </span><span style=color:#f07171>read_meta_as_string</span><span>(</span><span style=color:#ed9366>&</span><span>source</span><span style=color:#61676ccc>, </span><span>Path</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ff8f40>ASSET_PATH</span><span>))</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#fa6e32>r</span><span style=color:#86b300>#"(
</span><span style=color:#86b300>    meta_format_version: "1.0",
</span><span style=color:#86b300>    asset: Load(
</span><span style=color:#86b300>        loader: "bevy_asset::tests::CoolTextLoader",  // Correct type path, not wrapped
</span><span style=color:#86b300>        settings: (),
</span><span style=color:#86b300>    ),
</span><span style=color:#86b300>)"#
</span><span>    )</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=crates-bevy-asset-src-meta-rs-6-3><code>crates/bevy_asset/src/meta.rs</code> (+6/-3)</h3><p><strong>What changed</strong>: Modified serialization to use consistent newline characters. <strong>Why</strong>: To ensure tests pass consistently across platforms (Windows uses <code>\r\n</code> by default).<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>fn </span><span style=color:#f29718>serialize</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Vec</span><span><</span><span style=color:#fa6e32>u8</span><span>> {
</span><span>    ron</span><span style=color:#ed9366>::</span><span>ser</span><span style=color:#ed9366>::</span><span>to_string_pretty(
</span><span>        </span><span style=color:#ed9366>&</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// This defaults to \r\n on Windows, so hard-code it to \n so it's consistent for
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// testing.
</span><span>        PrettyConfig</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#ed9366>.</span><span style=color:#f07171>new_line</span><span>(</span><span style=color:#86b300>"</span><span style=color:#4cbf99>\n</span><span style=color:#86b300>"</span><span>)</span><span style=color:#61676ccc>,
</span><span>    )
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>expect</span><span>(</span><span style=color:#86b300>"type is convertible to ron"</span><span>)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>into_bytes</span><span>()
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><strong>Rust Tracing Documentation</strong>: For understanding how tracing spans and instrumentation work in Rust: https://docs.rs/tracing/latest/tracing/<li><strong>Bevy Asset System Documentation</strong>: For understanding Bevy’s asset pipeline: https://bevyengine.org/learn/books/asset-system/<li><strong>Conditional Compilation in Rust</strong>: For understanding <code>#[cfg(feature = "...")]</code> attribute: https://doc.rust-lang.org/reference/conditional-compilation.html<li><strong>Type Erasure Pattern</strong>: For understanding how Bevy’s asset system uses type erasure for dynamic dispatch: https://doc.rust-lang.org/book/ch17-02-trait-objects.html</ol><h1 id=full-code-diff>Full Code Diff</h1><p>[The full code diff is provided in the initial request above]</div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22213.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>