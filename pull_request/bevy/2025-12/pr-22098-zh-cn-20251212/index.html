<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22098 text2d change detection fix
        
    </title><meta content="#22098 text2d change detection fix" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-12</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2025-12/pr-22098-en-20251212>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=title>Title</h1><p>text2d change detection fix<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: text2d change detection fix<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22098<li><strong>Author</strong>: ickshonpe<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Performance, S-Ready-For-Final-Review, P-Regression, A-Text<li><strong>Created</strong>: 2025-12-12T19:47:17Z<li><strong>Merged</strong>: 2025-12-12T20:41:36Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><p><strong>目标</strong><p>修复由于 #22051 破坏了 text2d 的变更检测而导致的性能回归问题。<p>修复 #22099。<p><strong>解决方案</strong><p>在 <code>update_text_buffer</code> 和 <code>update_text_layout_info</code> 函数的开始处，将文本实体的 <code>ComputedTextBlock::needs_rerender</code> 标志设置为 false。<p><strong>测试</strong><pre style=color:#61676c;background-color:#fafafa><code><span>cargo run --example many_text2d --release
</span></code></pre><p>运行时的帧率应该大约是 main 分支的 400 倍。<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>这是一个关于性能回归修复的典型故事。它始于一个为了修复其他问题而进行的修改，但却无意中引入了一个严重得多的问题。PR #22051 原本旨在改进 Bevy 的变更检测机制，但它的改动影响了文本渲染流水线，特别是与 <code>text2d</code> 组件相关的部分，导致了一个严重的性能退化。具体表现是，<code>many_text2d</code> 示例的运行帧率大幅下降。<p>问题的根源在于变更检测逻辑中的一个微妙状态管理错误。在 Bevy 的 ECS 框架中，变更检测是优化性能的关键机制。它确保系统只在组件数据实际发生变化时才执行相应的工作。对于文本渲染，相关的状态被封装在 <code>ComputedTextBlock</code> 结构中，其中一个关键的布尔标志 <code>needs_rerender</code> 用于指示该文本块是否需要重新计算其布局和缓冲区。<p>当 PR #22051 修改了变更检测的行为后，它可能影响了 <code>needs_rerender</code> 标志的清除时机或逻辑。结果就是，系统误以为文本内容在每一帧都发生了变化。这触发了两个计算密集型的函数——<code>update_text_buffer</code>（更新顶点缓冲区和字形数据）和 <code>update_text_layout_info</code>（计算文本布局信息）——在每一帧都被调用，即使文本内容实际上是静态的。这正是 #22099 中报告的性能灾难的原因：帧率暴跌，因为每一帧都在不必要地重新计算和上传所有文本数据。<p>修复方案直接而有效。开发者 <code>ickshonpe</code> 没有尝试去调整复杂的变更检测交互逻辑，而是采取了更可靠的方法：在每次执行这两个核心更新函数时，都显式地将 <code>needs_rerender</code> 标志重置为 <code>false</code>。这个修复的逻辑是合理的：既然这些函数已经被调用（无论是由于变更检测的触发还是其他原因），它们就会完成文本所需的更新工作。在函数开始处重置标志，确保了在本次更新完成后，系统不会错误地认为文本“仍需要渲染”，从而避免了下一帧的无效重计算循环。<p>这个修复的优雅之处在于它的极简性。整个修改只涉及在 <code>crates/bevy_text/src/pipeline.rs</code> 文件的两个函数开头各添加一行代码：<code>computed.needs_rerender = false;</code>。代码的其余部分保持不变。这种“手术刀式”的修复最大限度地减少了引入新错误的可能性，并且完全专注于纠正错误的状态管理。<p>这个事件提供了一个关于软件维护的重要教训：即使是看似良性的、旨在修复其他问题的修改，也可能在系统的其他部分引发连锁反应，尤其是像变更检测这样贯穿整个引擎的核心机制。它也展示了有效的性能问题调试方法——识别出导致不必要工作的核心循环（这里是不当的标志状态），然后直接打断它。<p>最终，这个修复将 <code>many_text2d</code> 示例的性能恢复到了正常水平，正如描述中所说，帧率提升到了 main 分支（指修复前有问题的版本）的约 400 倍。这凸显了正确管理内部状态标志对于渲染性能的极端重要性。<h2 id=visual-representation>Visual Representation</h2><p>下面的 Mermaid 图展示了本 PR 修复的核心流程，重点说明了 <code>needs_rerender</code> 标志的错误循环以及修复如何中断它：<pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Text Component Changed] --> B[变更检测系统&LTbr/>设置 needs_rerender = true]
</span><span>    B --> C{needs_rerender == true ?}
</span><span>    C -->|是| D[调用 update_text_buffer&LTbr/>或 update_text_layout_info]
</span><span>    
</span><span>    subgraph "修复前 (错误循环)"
</span><span>        D --> E[执行昂贵的布局/缓冲计算]
</span><span>        E --> F[??? 标志未被正确清除 ???]
</span><span>        F -.->|下一帧| C
</span><span>    end
</span><span>
</span><span>    subgraph "修复后 (PR #22098)"
</span><span>        D --> G[computed.needs_rerender = false]
</span><span>        G --> H[执行昂贵的布局/缓冲计算]
</span><span>        H --> I{下一帧: 文本未改变}
</span><span>        I -->|是| J[变更检测不触发&LTbr/>跳过昂贵计算]
</span><span>    end
</span><span>
</span><span>    C -->|否| K[跳过昂贵计算&LTbr/>性能良好]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-text-src-pipeline-rs-4-0><code>crates/bevy_text/src/pipeline.rs</code> (+4/-0)</h3><p>这个文件是文本渲染流水线的核心。本次修改只增加了两行完全相同的代码，分别位于两个关键的函数中，用以修复 <code>needs_rerender</code> 标志的状态管理问题。<ol><li><p><strong>修改内容与原因</strong>：在 <code>update_text_buffer</code> 和 <code>update_text_layout_info</code> 函数的开始处，显式地将 <code>computed.needs_rerender</code> 标志设置为 <code>false</code>。这确保了在完成文本更新后，该标志被正确清除，从而防止变更检测系统在下一帧误判文本需要再次更新，避免了昂贵的重复计算。</p><li><p><strong>代码片段</strong>：</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 文件: crates/bevy_text/src/pipeline.rs
</span><span style=color:#abb0b6;font-style:italic>// 在 `update_text_buffer` 函数中添加：
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>update_text_buffer</span><span>(
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>,
</span><span>    </span><span style=color:#ff8f40>computed</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> ComputedTextBlock,
</span><span>    </span><span style=color:#ff8f40>font_system</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> CosmicFontSystem,
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><(), TextError> {
</span><span>    computed</span><span style=color:#ed9366>.</span><span>needs_rerender </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>false</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// &LT-- 新增行
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... 函数的其余部分保持不变
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 在 `update_text_layout_info` 函数中添加：
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>update_text_layout_info</span><span>(
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>,
</span><span>    </span><span style=color:#ff8f40>computed</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> ComputedTextBlock,
</span><span>    </span><span style=color:#ff8f40>layout_info</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> LayoutInfo,
</span><span>    </span><span style=color:#ff8f40>bounds</span><span style=color:#61676ccc>:</span><span> TextBounds,
</span><span>    </span><span style=color:#ff8f40>justify</span><span style=color:#61676ccc>:</span><span> Justify,
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><(), TextError> {
</span><span>    computed</span><span style=color:#ed9366>.</span><span>needs_rerender </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>false</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// &LT-- 新增行
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... 函数的其余部分保持不变
</span><span>}
</span></code></pre><li><p><strong>与PR目标的关联</strong>：这两行简单的代码直接解决了性能回归问题。它们通过强制重置内部状态，打破了导致 <code>text2d</code> 实体在每一帧都进行不必要重绘的循环，从而恢复了正常的渲染性能。</p></ol><h2 id=further-reading>Further Reading</h2><ol><li><strong>Bevy 变更检测官方文档</strong>：了解 Bevy ECS 中变更检测系统的工作原理是理解此类问题的关键。可以查阅 Bevy 官方文档中关于 <code>Component</code> 和 <code>Query</code> 的章节，特别是过滤器如 <code>Changed</code>。<li><strong>GitHub Issue #22099</strong>: 查看原始的问题报告，可以了解性能回归的具体表现和用户反馈。<li><strong>GitHub PR #22051</strong>: 研究引入此回归的原始 PR，有助于理解看似不相关的修改如何影响核心系统，是学习软件工程中“蝴蝶效应”的典型案例。<li><strong>Rendering Pipeline Optimization</strong>: 对于更广泛的图形性能主题，可以学习关于减少状态变更、避免每帧重复提交静态数据等渲染优化技术。</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22098.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>