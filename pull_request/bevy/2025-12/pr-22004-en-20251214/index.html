<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22004 Fix shadow caster/receiver toggle not working
        
    </title><meta content="#22004 Fix shadow caster/receiver toggle not working" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-14</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22004-zh-cn-20251214>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix shadow caster/receiver toggle not working<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22004<li><strong>Author</strong>: momoluna444<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, S-Ready-For-Final-Review, D-Straightforward<li><strong>Created</strong>: 2025-12-02T05:59:04Z<li><strong>Merged</strong>: 2025-12-14T23:22:16Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Fixes #21582<h2 id=solution>Solution</h2><p>In the original implementation of <code>extract_meshes_for_gpu_building</code>, we didn’t account for the case where components are removed. This patch adds fixes for all affected components.<h2 id=testing>Testing</h2><p>The example <code>shadow_caster_receiver</code> works now.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a specific bug in Bevy’s rendering system where toggling shadow caster and shadow receiver components at runtime wasn’t working correctly. The issue (#21582) reported that when you remove components like <code>NotShadowCaster</code> or <code>NotShadowReceiver</code> from entities, the rendering system doesn’t properly update to reflect these changes.<p>The problem occurred in the <code>extract_meshes_for_gpu_building</code> system, which is responsible for extracting mesh data from the ECS world and preparing it for GPU rendering. This system handles various components that affect how meshes are rendered, including shadow-related components, visibility ranges, skinned meshes, and others.<p>The core issue was that the extraction system only tracked entities that needed re-extraction from the <code>meshes_to_reextract_next_frame</code> resource and entities that had their <code>Mesh3d</code> component removed. However, it didn’t account for entities that had other relevant components removed. When components like <code>NotShadowCaster</code> were removed at runtime, the extraction system wouldn’t re-evaluate those entities, leaving them in their previous state in the render world.<p>The solution involved adding queries for <code>RemovedComponents</code> of all the components that affect mesh extraction. The system now tracks removals of:<ul><li><code>PreviousGlobalTransform</code><li><code>Lightmap</code><li><code>Aabb</code><li><code>MeshTag</code><li><code>NoFrustumCulling</code><li><code>NotShadowReceiver</code><li><code>TransmittedShadowReceiver</code><li><code>NotShadowCaster</code><li><code>NoAutomaticBatching</code><li><code>VisibilityRange</code><li><code>SkinnedMesh</code></ul><p>The implementation creates a local <code>EntityHashSet</code> called <code>reextract_entities</code> that collects all entities needing re-extraction. This includes both entities from <code>meshes_to_reextract_next_frame</code> and entities that have had any of the tracked components removed. By using a hash set, we ensure each entity is only processed once even if multiple components were removed from it.<p>Here’s the key change in how entities are collected for re-extraction:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let</span><span> iters </span><span style=color:#ed9366>=</span><span> meshes_to_reextract_next_frame
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>e</span><span>| </span><span style=color:#ed9366>*</span><span>e)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>chain</span><span>(removed_previous_global_transform_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>())
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>chain</span><span>(removed_lightmap_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>())
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>chain</span><span>(removed_aabb_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>())
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>chain</span><span>(removed_mesh_tag_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>())
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>chain</span><span>(removed_no_frustum_culling_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>())
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>chain</span><span>(removed_not_shadow_receiver_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>())
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>chain</span><span>(removed_transmitted_receiver_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>())
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>chain</span><span>(removed_not_shadow_caster_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>())
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>chain</span><span>(removed_no_automatic_batching_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>())
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>chain</span><span>(removed_visibility_range_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>())
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>chain</span><span>(removed_skinned_mesh_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>())</span><span style=color:#61676ccc>;
</span><span>
</span><span>reextract_entities</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend_from_iter</span><span>(iters)</span><span style=color:#61676ccc>;
</span></code></pre><p>The system then iterates through all entities in <code>reextract_entities</code> and calls <code>extract_mesh_for_gpu_building</code> for each one, ensuring the render world is updated with the current component state.<p>This approach is straightforward and aligns with Bevy’s ECS patterns. Each <code>RemovedComponents</code> query efficiently tracks which entities had a specific component removed since the last time the system ran. By chaining all these queries together, we get a complete list of entities that need re-evaluation.<p>One important consideration is that we need to clear the <code>reextract_entities</code> hash set at the beginning of each run to prevent accumulating entities across frames. This is done with <code>reextract_entities.clear()</code> at the start of the system.<p>The fix is minimal and focused - it doesn’t change the overall architecture or add unnecessary complexity. It simply ensures that all relevant component removals are tracked, which was the missing piece in the original implementation. This type of fix is common in ECS-based systems where you need to handle both component additions and removals to keep derived data structures in sync.<p>The impact is that shadow toggling now works correctly at runtime. Developers can dynamically add or remove <code>NotShadowCaster</code> and <code>NotShadowReceiver</code> components, and the rendering system will properly update. This is important for games that need dynamic shadow behavior, like characters entering/excluding shadows or objects that can be toggled between shadow casting states.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[extract_meshes_for_gpu_building System] --> B[EntityHashSet]
</span><span>    B --> C[Process Re-extraction]
</span><span>    
</span><span>    D[meshes_to_reextract_next_frame] --> B
</span><span>    E[RemovedComponents&LTPreviousGlobalTransform>] --> B
</span><span>    F[RemovedComponents&LTLightmap>] --> B
</span><span>    G[RemovedComponents&LTAabb>] --> B
</span><span>    H[RemovedComponents&LTMeshTag>] --> B
</span><span>    I[RemovedComponents&LTNoFrustumCulling>] --> B
</span><span>    J[RemovedComponents&LTNotShadowReceiver>] --> B
</span><span>    K[RemovedComponents&LTTransmittedShadowReceiver>] --> B
</span><span>    L[RemovedComponents&LTNotShadowCaster>] --> B
</span><span>    M[RemovedComponents&LTNoAutomaticBatching>] --> B
</span><span>    N[RemovedComponents&LTVisibilityRange>] --> B
</span><span>    O[RemovedComponents&LTSkinnedMesh>] --> B
</span><span>    
</span><span>    C --> P[extract_mesh_for_gpu_building]
</span><span>    P --> Q[Updated Render World]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-pbr-src-render-mesh-rs-49-2><code>crates/bevy_pbr/src/render/mesh.rs</code> (+49/-2)</h3><p>This file contains the <code>extract_meshes_for_gpu_building</code> system which was modified to handle component removals properly.<p><strong>Key changes:</strong><ol><li><strong>Added 12 new <code>RemovedComponents</code> queries</strong> to track removal of various components that affect mesh extraction.<li><strong>Added a local <code>EntityHashSet</code></strong> to collect all entities needing re-extraction.<li><strong>Modified the entity collection logic</strong> to include entities from all removed component queries.</ol><p><strong>Code snippet showing the main change:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before (simplified):
</span><span style=color:#fa6e32>for </span><span style=color:#ed9366>&</span><span>mesh_entity </span><span style=color:#ed9366>in &**</span><span>meshes_to_reextract_next_frame {
</span><span>    </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(query_row) </span><span style=color:#ed9366>=</span><span> all_meshes_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#ed9366>*</span><span>mesh_entity) {
</span><span>        </span><span style=color:#f07171>extract_mesh_for_gpu_building</span><span>(</span><span style=color:#ed9366>...</span><span>)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> iters </span><span style=color:#ed9366>=</span><span> meshes_to_reextract_next_frame
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>e</span><span>| </span><span style=color:#ed9366>*</span><span>e)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>chain</span><span>(removed_previous_global_transform_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>())
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>chain</span><span>(removed_lightmap_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>())
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>chain</span><span>(removed_aabb_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>())
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>chain</span><span>(removed_mesh_tag_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>())
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>chain</span><span>(removed_no_frustum_culling_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>())
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>chain</span><span>(removed_not_shadow_receiver_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>())
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>chain</span><span>(removed_transmitted_receiver_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>())
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>chain</span><span>(removed_not_shadow_caster_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>())
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>chain</span><span>(removed_no_automatic_batching_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>())
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>chain</span><span>(removed_visibility_range_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>())
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>chain</span><span>(removed_skinned_mesh_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>())</span><span style=color:#61676ccc>;
</span><span>
</span><span>reextract_entities</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend_from_iter</span><span>(iters)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>let mut</span><span> queue </span><span style=color:#ed9366>=</span><span> render_mesh_instance_queues</span><span style=color:#ed9366>.</span><span style=color:#f07171>borrow_local_mut</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>for</span><span> entity </span><span style=color:#ed9366>in &</span><span>reextract_entities {
</span><span>    </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(query_row) </span><span style=color:#ed9366>=</span><span> all_meshes_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#ed9366>*</span><span>entity) {
</span><span>        </span><span style=color:#f07171>extract_mesh_for_gpu_building</span><span>(</span><span style=color:#ed9366>...</span><span>)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><strong>Bevy ECS Documentation</strong>: Understanding <code>RemovedComponents</code> queries and change detection in Bevy’s ECS system.<li><strong>Bevy Rendering Pipeline</strong>: How extraction systems work in Bevy’s render graph architecture.<li><strong>Shadow Mapping Techniques</strong>: Technical details of how shadow casting and receiving works in modern rendering engines.<li><strong>Entity-Component-System Patterns</strong>: Best practices for handling component additions and removals in ECS architectures.</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22004.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>