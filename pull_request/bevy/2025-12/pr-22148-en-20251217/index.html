<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22148 register read on DefaultErrorHandler in CombinatorSystem
        
    </title><meta content="#22148 register read on DefaultErrorHandler in CombinatorSystem" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-17</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22148-zh-cn-20251217>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: register read on DefaultErrorHandler in CombinatorSystem<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22148<li><strong>Author</strong>: janis-bhm<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-ECS, S-Ready-For-Final-Review, P-Unsound<li><strong>Created</strong>: 2025-12-16T06:40:25Z<li><strong>Merged</strong>: 2025-12-17T02:32:30Z<li><strong>Merged By</strong>: cart</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Fixes #22133<h2 id=solution>Solution</h2><p><code>CombinatorSystem</code> now registers a read on the <code>DefaultErrorHandler</code> resource in <code>System::initialize</code> as @hymm suggested. I’ve also decided to deny <code>unsafe_op_in_unsafe_fn</code> in that method, which I think would have helped me find this beforehand.<h2 id=testing>Testing</h2><p>I’ve written a test that checks that <code>CombinatorSystems</code> can still access the resource mutably, checks that a combinatory system does conflict with a system which mutably accesses the resource, and runs such a schedule to possibly allow miri to catch the error that this PR fixes (this last point doesn’t seem to be the true, but afaik that could be due to it not actually being run in parallel even when it’s legal for the executor to do so?).<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses an unsoundness bug in Bevy’s ECS system combinators. The issue stemmed from a subtle oversight in how <code>CombinatorSystem</code> manages its resource accesses during system execution.<h3 id=the-problem-and-context>The Problem and Context</h3><p>When a <code>CombinatorSystem</code> runs its child systems, it needs to handle potential errors from those systems. Specifically, if a child system returns a <code>RunSystemError::Failed</code>, the combinator uses the <code>DefaultErrorHandler</code> resource to process the error. However, the system wasn’t declaring that it reads this resource during its initialization phase.<p>In Bevy’s ECS architecture, systems must declare all their resource accesses during the <code>initialize</code> method. This allows the scheduler to determine which systems can run in parallel without conflicts. When a system fails to declare a resource access but still uses it during execution, this creates a potential data race condition. Other systems that mutate the same resource could be scheduled to run concurrently, leading to undefined behavior.<p>The bug was particularly insidious because it only manifested when:<ol><li>A <code>CombinatorSystem</code> had a child system that failed<li>Another system concurrently mutated the <code>DefaultErrorHandler</code> resource<li>The scheduler incorrectly allowed both to run in parallel</ol><h3 id=the-solution-approach>The Solution Approach</h3><p>The fix, suggested by @hymm, was straightforward in concept but required careful implementation: add a read access registration for the <code>DefaultErrorHandler</code> resource in the <code>CombinatorSystem::initialize</code> method.<p>However, implementing this correctly required attention to several details:<ol><li>The access needs to be added after combining the accesses of both child systems<li>The safety documentation needed updating to reflect the new access<li>The unsafe code blocks needed to be properly annotated to prevent similar issues in the future</ol><p>The developer also made an important defensive change by adding <code>#![deny(unsafe_op_in_unsafe_fn)]</code> to the <code>run_unsafe</code> method. This Rust lint requires explicit <code>unsafe</code> blocks within already-unsafe functions, making it clearer which operations are actually unsafe and need justification.<h3 id=the-implementation>The Implementation</h3><p>The core fix happens in the <code>initialize</code> method of <code>CombinatorSystem</code>. After initializing both child systems and combining their accesses, the method now explicitly registers a read access for the <code>DefaultErrorHandler</code>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// We might need to read the default error handler after the component
</span><span style=color:#abb0b6;font-style:italic>// systems have run to report failures.
</span><span style=color:#fa6e32>let</span><span> error_resource </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span>register_resource</span><span style=color:#ed9366>::</span><span>&LTcrate</span><span style=color:#ed9366>::</span><span>error</span><span style=color:#ed9366>::</span><span>DefaultErrorHandler>()</span><span style=color:#61676ccc>;
</span><span>a_access</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_unfiltered_resource_read</span><span>(error_resource)</span><span style=color:#61676ccc>;
</span></code></pre><p>This ensures that the scheduler knows about this access and won’t schedule conflicting systems to run concurrently.<p>The safety documentation in the <code>combine</code> function was updated to explain why this access doesn’t create conflicts:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// The closure's access to the DefaultErrorHandler does not
</span><span style=color:#abb0b6;font-style:italic>// conflict with any potential access to the DefaultErrorHandler by
</span><span style=color:#abb0b6;font-style:italic>// the systems since the closures are not run in parallel.
</span></code></pre><p>In the <code>run_unsafe</code> method, the developer added the <code>unsafe_op_in_unsafe_fn</code> denial and updated the error handling code to explicitly mark the unsafe operation:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#55b4d4;font-style:italic>Err</span><span>(RunSystemError</span><span style=color:#ed9366>::</span><span>Failed(err)) </span><span style=color:#ed9366>=> </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// SAFETY: We registered access to DefaultErrorHandler in `initialize`.
</span><span>    (</span><span style=color:#fa6e32>unsafe </span><span>{ world</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0.</span><span style=color:#f07171>default_error_handler</span><span>() })(
</span><span>        err</span><span style=color:#61676ccc>,
</span><span>        ErrorContext</span><span style=color:#ed9366>::</span><span>System {
</span><span>            name</span><span style=color:#61676ccc>:</span><span> system</span><span style=color:#ed9366>.</span><span style=color:#f07171>name</span><span>()</span><span style=color:#61676ccc>,
</span><span>        }</span><span style=color:#61676ccc>,
</span><span>    )
</span><span>}
</span></code></pre><p>The test suite was expanded with a new test <code>combinator_with_error_handler_access</code> that verifies:<ol><li>A <code>CombinatorSystem</code> can still access the error handler resource mutably (through one of its child systems)<li>The combinator system doesn’t conflict with itself<li>The combinator system correctly conflicts with another system that mutably accesses the same resource</ol><h3 id=technical-insights>Technical Insights</h3><p>This PR highlights several important aspects of Bevy’s ECS design:<ol><li><p><strong>Access Declarations are Critical</strong>: Bevy’s safety relies on systems declaring all their accesses upfront. This allows the scheduler to prevent data races at compile time rather than runtime.</p><li><p><strong>Combinator Systems Have Complex Lifecycles</strong>: <code>CombinatorSystem</code> needs to handle both the execution of its child systems and any error handling that occurs after they run. This requires careful access management across different phases of execution.</p><li><p><strong>Error Handling as a Resource</strong>: Using the <code>DefaultErrorHandler</code> as a resource allows for flexible error handling strategies, but it also means error handling must follow the same access rules as any other system logic.</p><li><p><strong>Unsafe Code Discipline</strong>: The addition of <code>#![deny(unsafe_op_in_unsafe_fn)]</code> is a best practice that makes unsafe code more maintainable. It forces developers to explicitly mark which operations within an unsafe function are actually unsafe, making safety reasoning easier.</p></ol><h3 id=the-impact>The Impact</h3><p>This fix eliminates a potential data race condition in Bevy’s ECS system. While the bug might have been difficult to trigger in practice (requiring specific timing of system failures and concurrent access), it represented a real unsoundness that could lead to undefined behavior.<p>The changes also improve code quality by:<ol><li>Making the resource access pattern explicit and documented<li>Adding stricter unsafe code guidelines<li>Providing comprehensive tests to prevent regression</ol><p>The test added in this PR is particularly valuable because it verifies both the positive case (systems can access resources they need) and the negative case (conflicting systems are properly detected).<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[CombinatorSystem::initialize] --> B[Initialize System A]
</span><span>    A --> C[Initialize System B]
</span><span>    B --> D[Combine Accesses]
</span><span>    C --> D
</span><span>    D --> E[Register DefaultErrorHandler Read]
</span><span>    E --> F[Return Final Access]
</span><span>    
</span><span>    G[CombinatorSystem::run_unsafe] --> H[Run Child Systems]
</span><span>    H --> I{Child System Failed?}
</span><span>    I -->|Yes| J[Access DefaultErrorHandler]
</span><span>    I -->|No| K[Return Result]
</span><span>    
</span><span>    style E fill:#e1f5e1
</span><span>    style J fill:#e1f5e1
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ul><li><code>crates/bevy_ecs/src/system/combinator.rs</code> (+55/-5)</ul><h3 id=changes-in-combinator-rs>Changes in combinator.rs</h3><p>The main changes focus on ensuring proper resource access registration and improving unsafe code practices:<ol><li><p><strong>Fixed missing resource access registration in <code>initialize</code> method</strong>:</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>initialize</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> World) </span><span style=color:#61676ccc>-></span><span> SystemArchetypeAccess {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> a_access </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>a</span><span style=color:#ed9366>.</span><span style=color:#f07171>initialize</span><span>(world)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> b_access </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>b</span><span style=color:#ed9366>.</span><span style=color:#f07171>initialize</span><span>(world)</span><span style=color:#61676ccc>;
</span><span>    a_access</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend</span><span>(b_access)</span><span style=color:#61676ccc>;
</span><span>    a_access
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>initialize</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> World) </span><span style=color:#61676ccc>-></span><span> SystemArchetypeAccess {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> a_access </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>a</span><span style=color:#ed9366>.</span><span style=color:#f07171>initialize</span><span>(world)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> b_access </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>b</span><span style=color:#ed9366>.</span><span style=color:#f07171>initialize</span><span>(world)</span><span style=color:#61676ccc>;
</span><span>    a_access</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend</span><span>(b_access)</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// We might need to read the default error handler after the component
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// systems have run to report failures.
</span><span>    </span><span style=color:#fa6e32>let</span><span> error_resource </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span>register_resource</span><span style=color:#ed9366>::</span><span>&LTcrate</span><span style=color:#ed9366>::</span><span>error</span><span style=color:#ed9366>::</span><span>DefaultErrorHandler>()</span><span style=color:#61676ccc>;
</span><span>    a_access</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_unfiltered_resource_read</span><span>(error_resource)</span><span style=color:#61676ccc>;
</span><span>    a_access
</span><span>}
</span></code></pre><li><p><strong>Improved unsafe code practices in <code>run_unsafe</code></strong>:</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added at the beginning of the closure:
</span><span style=color:#61676ccc>#!</span><span>[</span><span style=color:#f29718>deny</span><span>(unsafe_op_in_unsafe_fn)]
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Updated error handling with explicit unsafe block:
</span><span style=color:#55b4d4;font-style:italic>Err</span><span>(RunSystemError</span><span style=color:#ed9366>::</span><span>Failed(err)) </span><span style=color:#ed9366>=> </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// SAFETY: We registered access to DefaultErrorHandler in `initialize`.
</span><span>    (</span><span style=color:#fa6e32>unsafe </span><span>{ world</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0.</span><span style=color:#f07171>default_error_handler</span><span>() })(
</span><span>        err</span><span style=color:#61676ccc>,
</span><span>        ErrorContext</span><span style=color:#ed9366>::</span><span>System {
</span><span>            name</span><span style=color:#61676ccc>:</span><span> system</span><span style=color:#ed9366>.</span><span style=color:#f07171>name</span><span>()</span><span style=color:#61676ccc>,
</span><span>        }</span><span style=color:#61676ccc>,
</span><span>    )
</span><span>}
</span></code></pre><li><p><strong>Added comprehensive test coverage</strong>:</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>combinator_with_error_handler_access</span><span>() {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Tests that CombinatorSystem properly handles DefaultErrorHandler access
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// and correctly conflicts with systems that mutate the same resource
</span><span>}
</span></code></pre></ol><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/next/programming/ecs/systems/#system-safety target=_blank>Bevy ECS System Safety Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://rust-lang.github.io/unsafe-code-guidelines/ target=_blank>Rust’s Unsafe Code Guidelines</a><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/rustc/lints/listing/allowed-by-default.html#unsafe-op-in-unsafe-fn target=_blank>The <code>unsafe_op_in_unsafe_fn</code> lint</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/next/programming/errors/ target=_blank>Bevy’s Error Handling Patterns</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/next/programming/ecs/system-combinators/ target=_blank>System Combinators in Bevy ECS</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22148.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>