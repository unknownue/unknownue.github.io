<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21997 `PointerbuttonState::clear`
        
    </title><meta content="#21997 `PointerbuttonState::clear`" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-02</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-21997-zh-cn-20251202>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: <code>PointerbuttonState::clear</code><li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21997<li><strong>Author</strong>: ickshonpe<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: D-Trivial, C-Code-Quality, S-Needs-Review, A-Picking<li><strong>Created</strong>: 2025-12-01T12:23:20Z<li><strong>Merged</strong>: 2025-12-01T23:37:45Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>To clear the <code>PointerButtonState</code>, <code>clear</code> is called on each of its individual fields holding the button state data. Instead add a <code>clear</code> method to <code>PointerButtonState</code>.<h2 id=solution>Solution</h2><p>Add a <code>clear</code> method to <code>PointerButtonState</code> to clear its data.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a code quality issue in Bevy’s picking system, specifically in how pointer button state is cleared. The picking system tracks pointer interactions like clicks and drags, and manages state for different pointer buttons across various UI elements.<p>The problem was that when clearing the <code>PointerButtonState</code> struct, the code was manually calling <code>.clear()</code> on each of its three internal collections: <code>pressing</code>, <code>dragging</code>, and <code>dragging_over</code>. This approach worked but violated the DRY (Don’t Repeat Yourself) principle and made the code less maintainable. Every time the state needed to be cleared, the same three lines of code had to be written.<p>The author identified that this pattern appeared in two places in the codebase: in the <code>PointerState::clear</code> method and in the <code>pointer_events</code> system function. Both locations were clearing the same three fields in the same way. This repetition meant that if the internal structure of <code>PointerButtonState</code> ever changed (for example, adding a fourth collection), developers would need to remember to update both locations.<p>The solution implemented was straightforward and followed good software engineering practices: add a <code>clear</code> method to the <code>PointerButtonState</code> struct that encapsulates the clearing logic. This method clears all three internal collections in one operation. The existing code was then refactored to call this new method instead of manually clearing each field.<p>This change demonstrates several important software engineering concepts:<ol><li><p><strong>Encapsulation</strong>: By adding a method to the struct that handles its own state management, we keep the clearing logic close to the data it operates on. This follows the principle that a type should be responsible for managing its own internal state.</p><li><p><strong>Single Source of Truth</strong>: With the <code>clear</code> method in place, there’s now only one place in the codebase that knows exactly how to clear a <code>PointerButtonState</code>. If the internal structure changes in the future, only this method needs to be updated.</p><li><p><strong>Improved API Design</strong>: The <code>PointerButtonState</code> struct now has a more complete and intuitive API. Users of this struct don’t need to know about its internal field structure to clear it; they can simply call the <code>clear</code> method.</p><li><p><strong>Reduced Cognitive Load</strong>: Developers reading the code no longer need to parse three lines of clearing logic; they can see <code>state.clear()</code> and immediately understand what’s happening.</p></ol><p>The implementation is minimal but effective. The <code>clear</code> method is added to the <code>impl PointerButtonState</code> block, and it simply calls <code>.clear()</code> on each of the three HashMap fields. The existing code in two locations is updated to use this new method.<p>This change also has the benefit of making the code more self-documenting. The method is documented with a clear comment: “Clears all press and drag data tracked for this button on its pointer.” This gives developers a quick understanding of what the method does without needing to examine the implementation details.<p>From a performance perspective, there’s no change - the same operations are executed, just through a different code path. The compiler will likely inline the method calls, resulting in identical machine code to the previous implementation.<p>The PR was labeled as “trivial” (D-Trivial) and “code quality” (C-Code-Quality), which accurately reflects its nature. It’s a small, focused improvement that makes the codebase more maintainable without changing any functionality. The picking system (A-Picking) benefits from cleaner, more maintainable code that will be easier to work with in the future.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[PointerState::clear method] --> B[Calls PointerButtonState::clear]
</span><span>    C[pointer_events system] --> B
</span><span>    B --> D[Clears pressing HashMap]
</span><span>    B --> E[Clears dragging HashMap]
</span><span>    B --> F[Clears dragging_over HashMap]
</span><span>    
</span><span>    style B fill:#e1f5e1
</span><span>    style D fill:#f0f0f0
</span><span>    style E fill:#f0f0f0
</span><span>    style F fill:#f0f0f0
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>File: <code>crates/bevy_picking/src/events.rs</code></strong> (+11/-6)<p>This file contains the event handling and state management for Bevy’s picking system. The changes focus on the <code>PointerButtonState</code> struct, which tracks the state of pointer buttons (like mouse buttons) during picking operations.<p><strong>Key Changes:</strong><ol><li><p><strong>Added <code>clear</code> method to <code>PointerButtonState</code></strong>:</p> <ul><li>A new method was added to the <code>impl PointerButtonState</code> block<li>The method clears all three internal state collections</ul><li><p><strong>Refactored existing code to use the new method</strong>:</p> <ul><li>Updated <code>PointerState::clear</code> method to call <code>state.clear()</code> instead of clearing each field individually<li>Updated <code>pointer_events</code> system function to use the new method</ul></ol><p><strong>Code Snippets:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before (no clear method existed, and clearing was done manually):
</span><span style=color:#abb0b6;font-style:italic>// In PointerState::clear method:
</span><span>state</span><span style=color:#ed9366>.</span><span>pressing</span><span style=color:#ed9366>.</span><span style=color:#f07171>clear</span><span>()</span><span style=color:#61676ccc>;
</span><span>state</span><span style=color:#ed9366>.</span><span>dragging</span><span style=color:#ed9366>.</span><span style=color:#f07171>clear</span><span>()</span><span style=color:#61676ccc>;
</span><span>state</span><span style=color:#ed9366>.</span><span>dragging_over</span><span style=color:#ed9366>.</span><span style=color:#f07171>clear</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// In pointer_events system:
</span><span>state</span><span style=color:#ed9366>.</span><span>pressing</span><span style=color:#ed9366>.</span><span style=color:#f07171>clear</span><span>()</span><span style=color:#61676ccc>;
</span><span>state</span><span style=color:#ed9366>.</span><span>dragging</span><span style=color:#ed9366>.</span><span style=color:#f07171>clear</span><span>()</span><span style=color:#61676ccc>;
</span><span>state</span><span style=color:#ed9366>.</span><span>dragging_over</span><span style=color:#ed9366>.</span><span style=color:#f07171>clear</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After (with the new clear method):
</span><span style=color:#fa6e32>impl </span><span style=color:#399ee6>PointerButtonState </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>/// Clears all press and drag data tracked for this button on its pointer.
</span><span>    </span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>clear</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>) {
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>pressing</span><span style=color:#ed9366>.</span><span style=color:#f07171>clear</span><span>()</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>dragging</span><span style=color:#ed9366>.</span><span style=color:#f07171>clear</span><span>()</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>dragging_over</span><span style=color:#ed9366>.</span><span style=color:#f07171>clear</span><span>()</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// In PointerState::clear method:
</span><span>state</span><span style=color:#ed9366>.</span><span style=color:#f07171>clear</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// In pointer_events system:
</span><span>state</span><span style=color:#ed9366>.</span><span style=color:#f07171>clear</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><h2 id=further-reading>Further Reading</h2><p>For developers interested in learning more about the concepts demonstrated in this PR:<ol><li><p><strong>DRY Principle</strong>: The “Don’t Repeat Yourself” principle is a fundamental software development concept that encourages reducing repetition of code patterns.</p><li><p><strong>Encapsulation in Rust</strong>: The Rust programming language emphasizes encapsulation through its module system and visibility controls (<code>pub</code> keyword). This PR demonstrates good encapsulation practice.</p><li><p><strong>Bevy’s ECS Architecture</strong>: Understanding how Bevy’s Entity Component System works can help contextualize how the picking system fits into the larger framework. The <code>pointer_events</code> system is part of Bevy’s ECS-based architecture.</p><li><p><strong>Code Refactoring Patterns</strong>: This PR is an example of the “Extract Method” refactoring pattern, where repeated code is extracted into a single method.</p><li><p><strong>Rust HashMap API</strong>: The <code>.clear()</code> method used in this PR is part of Rust’s standard library HashMap API, which removes all entries from the map.</p></ol><h1 id=full-code-diff>Full Code Diff</h1><pre style=color:#61676c;background-color:#fafafa><code><span>diff --git a/crates/bevy_picking/src/events.rs b/crates/bevy_picking/src/events.rs
</span><span>index 4528001f0e429..4fb10121efde8 100644
</span><span>--- a/crates/bevy_picking/src/events.rs
</span><span>+++ b/crates/bevy_picking/src/events.rs
</span><span>@@ -351,6 +351,15 @@ pub struct PointerButtonState {
</span><span>     pub dragging_over: HashMap&LTEntity, HitData>,
</span><span> }
</span><span> 
</span><span>+impl PointerButtonState {
</span><span>+    /// Clears all press and drag data tracked for this button on its pointer.
</span><span>+    pub fn clear(&mut self) {
</span><span>+        self.pressing.clear();
</span><span>+        self.dragging.clear();
</span><span>+        self.dragging_over.clear();
</span><span>+    }
</span><span>+}
</span><span>+
</span><span> /// State for all pointers.
</span><span> #[derive(Debug, Clone, Default, Resource)]
</span><span> pub struct PointerState {
</span><span>@@ -379,9 +388,7 @@ impl PointerState {
</span><span>     pub fn clear(&mut self, pointer_id: PointerId) {
</span><span>         for button in PointerButton::iter() {
</span><span>             if let Some(state) = self.pointer_buttons.get_mut(&(pointer_id, button)) {
</span><span>-                state.pressing.clear();
</span><span>-                state.dragging.clear();
</span><span>-                state.dragging_over.clear();
</span><span>+                state.clear();
</span><span>             }
</span><span>         }
</span><span>     }
</span><span>@@ -699,9 +706,7 @@ pub fn pointer_events(
</span><span>                 }
</span><span> 
</span><span>                 // Finally, we can clear the state of everything relating to presses or drags.
</span><span>-                state.pressing.clear();
</span><span>-                state.dragging.clear();
</span><span>-                state.dragging_over.clear();
</span><span>+                state.clear();
</span><span>             }
</span><span>             // Moved
</span><span>             PointerAction::Move { delta } => {
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_21997.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>