<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22317 Fix: Closes shapes for 3d gizmos
        
    </title><meta content="#22317 Fix: Closes shapes for 3d gizmos" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-31</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2025-12/pr-22317-en-20251231>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix: Closes shapes for 3d gizmos<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22317<li><strong>Author</strong>: kfc35<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, C-Code-Quality, S-Ready-For-Final-Review, A-Gizmos<li><strong>Created</strong>: 2025-12-30T20:02:15Z<li><strong>Merged</strong>: 2025-12-31T22:22:11Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p><strong>Objective</strong><ul><li>修复 #22204</ul><p><strong>解决方案</strong><ul><li>重构了 #22085 中的解决方案，使其适用于 3 维；让 2D 的 <code>lineloop</code> 委托给 3D 版本。<li>更新了所有相关使用 <code>linestrip</code> 的地方，改用 <code>lineloop</code>（矩形和 <code>GizmoPrimitive3d&LTTriangle3d></code>）。<code>GizmoPrimitive3d&LTPolyline3d></code>、cube() 和 aabb3d() 仍使用 <code>linestrip</code>。据我所见，在 <code>3d_gizmos</code> 示例中，立方体（场景中心的黑色立方体）的各个角看起来都正常，但也欢迎其他人帮忙检查一下。<li>此 PR <strong>不</strong>处理 #22095 的问题！</ul><p><strong>测试</strong><ul><li><p>运行 <code>cargo run --example 3d_gizmos --features=free_camera</code> 并确认绿色的 3D 方形 gizmo 现在闭合了。 <img alt="Screenshot 2025-12-30 at 4 06 41 PM" height=182 src=https://github.com/user-attachments/assets/5f9f4337-d1fe-4c2e-98c0-2d83fe4b0ea6 width=1063></p><li><p>运行了 #22085 中的演示，确保 2D gizmos 没有出现回归问题。</p><li><p>运行了一个修改过的 <code>Triangle3d</code> 演示，验证 <code>Triangle3d</code> 现在闭合了。</p></ul><details><summary>修改后的 Triangle 3d 演示代码</summary> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>use </span><span>bevy</span><span style=color:#ed9366>::</span><span>prelude</span><span style=color:#ed9366>::*</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>main</span><span>() {
</span><span>    App</span><span style=color:#ed9366>::</span><span>new()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>add_plugins</span><span>(DefaultPlugins)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(Startup</span><span style=color:#61676ccc>,</span><span> setup)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(Update</span><span style=color:#61676ccc>,</span><span> draw_shapes)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>run</span><span>()</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>setup</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>config_store</span><span style=color:#61676ccc>: </span><span>ResMut&LTGizmoConfigStore>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands
</span><span>)
</span><span>{
</span><span>    </span><span style=color:#fa6e32>let </span><span>(config</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>_</span><span>) </span><span style=color:#ed9366>=</span><span> config_store</span><span style=color:#ed9366>.</span><span>config_mut</span><span style=color:#ed9366>::</span><span>&LTDefaultGizmoConfigGroup>()</span><span style=color:#61676ccc>;
</span><span>    config</span><span style=color:#ed9366>.</span><span>line</span><span style=color:#ed9366>.</span><span>width </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>10.0</span><span style=color:#61676ccc>;
</span><span>    config</span><span style=color:#ed9366>.</span><span>line</span><span style=color:#ed9366>.</span><span>joints </span><span style=color:#ed9366>= </span><span>GizmoLineJoint</span><span style=color:#ed9366>::</span><span>Miter</span><span style=color:#61676ccc>;
</span><span>
</span><span>    commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((Camera3d</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>, 
</span><span>        Transform</span><span style=color:#ed9366>::</span><span>from_xyz(</span><span style=color:#ff8f40>0.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.0</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>-</span><span style=color:#ff8f40>5.0</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>looking_at</span><span>(Vec3</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ZERO</span><span style=color:#61676ccc>, </span><span>Vec3</span><span style=color:#ed9366>::</span><span>Z)))</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>draw_shapes</span><span>(</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>gizmos</span><span style=color:#61676ccc>:</span><span> Gizmos) {
</span><span>    gizmos</span><span style=color:#ed9366>.</span><span style=color:#f07171>primitive_3d</span><span>(
</span><span>        </span><span style=color:#ed9366>&</span><span>Triangle3d { vertices</span><span style=color:#61676ccc>: </span><span>[Vec3</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ZERO</span><span style=color:#61676ccc>, </span><span>Vec3</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ff8f40>1.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.</span><span>)</span><span style=color:#61676ccc>, </span><span>Vec3</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ff8f40>0.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>1.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.</span><span>) ] }</span><span style=color:#61676ccc>,
</span><span>        Vec3</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ff8f40>0.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.</span><span>)</span><span style=color:#61676ccc>,
</span><span>        Color</span><span style=color:#ed9366>::</span><span>srgb_u8(</span><span style=color:#ff8f40>0xFF</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span>)
</span><span>    )</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre> <p>修复前（注意左下角的缺口）： <img alt="Screenshot 2025-12-30 at 2 46 36 PM" height=308 src=https://github.com/user-attachments/assets/3b073b9e-7145-4eef-b070-13a56376b17f width=369></p> <p>修复后（左下角的缺口消失了）： <img alt="Screenshot 2025-12-30 at 2 47 28 PM" height=339 src=https://github.com/user-attachments/assets/47494176-b212-42ac-82b0-f042c94941f3 width=361></p></details><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>这个PR始于一个具体的视觉缺陷：在Bevy引擎中，一些3D gizmo形状的线条没有正确闭合。例如，使用 <code>gizmos.rect</code> 或 <code>gizmos.primitive_3d</code> 绘制的 <code>Triangle3d</code>，其路径的起点和终点之间会留下一个微小的缺口。这个问题被记录在issue #22204中。对于开发者调试和可视化来说，一个完整的、封闭的轮廓比一个带有缺口的轮廓更清晰、更准确。<p>问题的根源在于绘制逻辑的不一致。在之前的代码中，2D绘图已经有一个 <code>lineloop</code> 方法来创建闭合图形，其实现会聪明地处理点序列，确保首尾相连。然而，3D绘图API中缺少一个对应的 <code>lineloop</code> 方法。因此，像 <code>rect</code>（在3D空间）和 <code>Triangle3d</code> 这类本应闭合的形状，都退而使用 <code>linestrip</code> 方法来绘制，而 <code>linestrip</code> 只是简单连接提供的点，不会自动闭合图形。<p>开发者kfc35的解决方案思路清晰且高效：将2D <code>lineloop</code> 的核心逻辑“提升”到3D空间，然后在3D中创建一个通用的 <code>lineloop</code> 方法。之后，再让2D的 <code>lineloop</code> 委托给这个新的3D方法（通过将2D点扩展到3D空间）。这样做不仅修复了3D图形的闭合问题，还消除了2D和3D之间的代码重复，符合DRY（Don’t Repeat Yourself）原则。<p>具体的实现在 <code>crates/bevy_gizmos/src/gizmos.rs</code> 中。开发者新增了一个3D的 <code>lineloop</code> 方法。这个方法的核心是一个巧妙的迭代器链（iterator chain）：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>linestrip</span><span>(
</span><span>    first
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>into_iter</span><span>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>chain</span><span>(second)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>chain</span><span>(positions)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>chain</span><span>(first)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>chain</span><span>(second)</span><span style=color:#61676ccc>,
</span><span>    color</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><p>它的逻辑是：取出第一个点（<code>first</code>）和第二个点（<code>second</code>），然后拼接剩余的所有点（<code>positions</code>）。为了闭合图形并正确绘制第一个角点的连接处（joint），它再次拼接回 <code>first</code> 和 <code>second</code>。简单来说，如果原始点序列是 [A, B, C, D]，这个方法会生成 [A, B, C, D, A, B] 给 <code>linestrip</code> 去绘制。最后两个点（A, B）确保了从D回到A的线段被绘制，并且A点处的转角连接样式（如Miter）能够基于线段BA和线段AB的方向被正确计算。<p>完成这个通用方法后，修改调用方就变得很简单了。在同一个文件中，3D <code>rect</code> 方法的绘制调用从 <code>self.linestrip([tl, tr, br, bl, tl], color)</code> 改为 <code>self.lineloop([tl, tr, br, bl], color)</code>。注意，这里的参数列表移除了末尾重复的 <code>tl</code>，因为 <code>lineloop</code> 会负责处理闭合。在 <code>crates/bevy_gizmos/src/primitives/dim3.rs</code> 中，绘制 <code>Triangle3d</code> 的代码也从 <code>self.linestrip([a, b, c, a]...</code> 改为 <code>self.lineloop([a, b, c]...</code>。这种改动使调用方的意图（“画一个闭合环”）更加明确。<p>对于2D部分，原有的 <code>lineloop</code> 方法被重构，现在它只是将2D点（<code>Vec2</code>）通过 <code>.extend(0.)</code> 转换为3D点（<code>Vec3</code>），然后调用新的3D <code>lineloop</code> 方法。这完全移除了之前2D <code>lineloop</code> 方法中独立的、与3D版本逻辑相同的迭代器链代码，实现了代码复用。<p>这个PR带来的直接改进是视觉上的：所有使用更新后的方法绘制的3D闭合形状现在都能正确显示，没有缺口。从代码质量角度看，它通过创建一个统一的3D <code>lineloop</code> 方法并让2D版本复用其逻辑，提升了代码的抽象层次并减少了重复。这个解决方案也展示了在图形编程中，处理闭合路径时需要考虑额外的点来确保连接处渲染正确，这是一个有用的技术细节。<p>不过，正如作者在PR描述中明确指出的，这个修复有它的范围。它没有解决所有3D图形（如 <code>cube()</code> 和 <code>aabb3d()</code>）的闭合问题，因为这些方法仍然使用 <code>linestrip</code>。作者评估后认为立方体的视觉表现可以接受，但将更全面的修复留给了未来的工作（如issue #22095）。这种明确界定修复范围的做法在协作开发中是很专业的。<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    subgraph "新增/重构的方法"
</span><span>        A[Gizmos::lineloop_3d]
</span><span>    end
</span><span>
</span><span>    subgraph "现有方法（调用方）"
</span><span>        B[Gizmos::rect_3d]
</span><span>        C[GizmoPrimitive3d&LTTriangle3d>]
</span><span>        D[Gizmos::lineloop_2d]
</span><span>    end
</span><span>
</span><span>    subgraph "基础绘制方法"
</span><span>        E[Gizmos::linestrip_3d]
</span><span>    end
</span><span>
</span><span>    A --> E
</span><span>    B --> A
</span><span>    C --> A
</span><span>    D --> A
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ol><li><p><strong><code>crates/bevy_gizmos/src/gizmos.rs</code> (+37/-18)</strong></p> <ul><li><strong>修改内容与原因</strong>：这是本次修复的核心文件。主要做了两件事：一是新增了3D版本的 <code>lineloop</code> 方法，提供了绘制闭合3D线段环的通用能力；二是修改了相关的调用方（<code>rect</code> 3D部分）和重构了2D <code>lineloop</code> 方法，使其复用新的3D逻辑。<li><strong>关键代码片段</strong>：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 新增的 3D lineloop 方法
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>inline</span><span>]
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>lineloop</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>positions</span><span style=color:#61676ccc>:</span><span> impl </span><span style=color:#55b4d4;font-style:italic>IntoIterator</span><span>&LTItem = Vec3>, </span><span style=color:#ff8f40>color</span><span style=color:#61676ccc>:</span><span> impl </span><span style=color:#55b4d4;font-style:italic>Into</span><span>&LTColor>) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... 启用检查省略
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> positions </span><span style=color:#ed9366>=</span><span> positions</span><span style=color:#ed9366>.</span><span style=color:#f07171>into_iter</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> first </span><span style=color:#ed9366>=</span><span> positions</span><span style=color:#ed9366>.</span><span style=color:#f07171>next</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> second </span><span style=color:#ed9366>=</span><span> positions</span><span style=color:#ed9366>.</span><span style=color:#f07171>next</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>linestrip</span><span>(
</span><span>        first
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>into_iter</span><span>()
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>chain</span><span>(second)
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>chain</span><span>(positions)
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>chain</span><span>(first)
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>chain</span><span>(second)</span><span style=color:#61676ccc>,
</span><span>        color</span><span style=color:#61676ccc>,
</span><span>    )</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 3D rect 方法内的调用修改
</span><span style=color:#abb0b6;font-style:italic>// 之前:
</span><span style=color:#abb0b6;font-style:italic>// self.linestrip([tl, tr, br, bl, tl], color);
</span><span style=color:#abb0b6;font-style:italic>// 之后:
</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>lineloop</span><span>([tl</span><span style=color:#61676ccc>,</span><span> tr</span><span style=color:#61676ccc>,</span><span> br</span><span style=color:#61676ccc>,</span><span> bl]</span><span style=color:#61676ccc>,</span><span> color)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 2D lineloop 方法重构后（委托给 3D 版本）
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>inline</span><span>]
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>lineloop</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>positions</span><span style=color:#61676ccc>:</span><span> impl </span><span style=color:#55b4d4;font-style:italic>IntoIterator</span><span>&LTItem = Vec2>, </span><span style=color:#ff8f40>color</span><span style=color:#61676ccc>:</span><span> impl </span><span style=color:#55b4d4;font-style:italic>Into</span><span>&LTColor>) {
</span><span>    </span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>enabled {
</span><span>        </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 主要改动：移除旧的复杂逻辑，直接调用 3D 版本
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>lineloop</span><span>(positions</span><span style=color:#ed9366>.</span><span style=color:#f07171>into_iter</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|</span><span style=color:#ff8f40>vec2</span><span>| vec2</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend</span><span>(</span><span style=color:#ff8f40>0.</span><span>))</span><span style=color:#61676ccc>,</span><span> color)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><li><strong>与PR目标的关系</strong>：新增的3D <code>lineloop</code> 方法是修复的基石。修改 <code>rect</code> 和重构2D <code>lineloop</code> 则是应用此基石的具体行动，共同实现了3D形状闭合和代码复用的目标。</ul><li><p><strong><code>crates/bevy_gizmos/src/primitives/dim3.rs</code> (+1/-1)</strong></p> <ul><li><strong>修改内容与原因</strong>：这个文件包含了为各种3D图元（primitive）实现 gizmo 绘制的代码。这里只修改了 <code>Triangle3d</code> 的绘制实现，将其从使用 <code>linestrip</code> 改为使用新的 <code>lineloop</code>，以确保三角形轮廓闭合。<li><strong>关键代码片段</strong>：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 之前:
</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>linestrip</span><span>([a</span><span style=color:#61676ccc>,</span><span> b</span><span style=color:#61676ccc>,</span><span> c</span><span style=color:#61676ccc>,</span><span> a]</span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|</span><span style=color:#ff8f40>vec3</span><span>| isometry </span><span style=color:#ed9366>*</span><span> vec3)</span><span style=color:#61676ccc>,</span><span> color)</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// 之后:
</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>lineloop</span><span>([a</span><span style=color:#61676ccc>,</span><span> b</span><span style=color:#61676ccc>,</span><span> c]</span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|</span><span style=color:#ff8f40>vec3</span><span>| isometry </span><span style=color:#ed9366>*</span><span> vec3)</span><span style=color:#61676ccc>,</span><span> color)</span><span style=color:#61676ccc>;
</span></code></pre><li><strong>与PR目标的关系</strong>：这是修复 <code>GizmoPrimitive3d&LTTriangle3d></code> 绘制不闭合问题的直接改动，是本次PR要解决的具体问题之一。</ul></ol><h2 id=further-reading>Further Reading</h2><ul><li><strong>Bevy Gizmos 官方文档</strong>: 了解 Bevy Gizmo 系统的完整API和功能。<li><strong>Issue #22085</strong>: 本次修复所借鉴的原始2D <code>lineloop</code> 实现所在的PR，提供了问题的初始上下文。<li><strong>Issue #22095</strong>: 本次PR明确未解决的、关于其他3D gizmo（如立方体边框）闭合问题的 issue，指出了未来的改进方向。<li><strong>计算机图形学 - 线段连接处（Line Joins）</strong>: 学习关于 <code>Miter</code>、<code>Bevel</code>、<code>Round</code> 等线段连接处样式的知识，理解为何在闭合环时需要额外点来计算连接。</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22317.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>