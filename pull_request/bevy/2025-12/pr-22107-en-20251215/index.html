<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22107 Global Gizmos
        
    </title><meta content="#22107 Global Gizmos" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-15</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22107-zh-cn-20251215>中文</a></div></div><div class=pr-content><h1 id=global-gizmos>Global Gizmos</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Global Gizmos<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22107<li><strong>Author</strong>: atlv24<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Feature, S-Ready-For-Final-Review, A-Gizmos<li><strong>Created</strong>: 2025-12-13T15:18:25Z<li><strong>Merged</strong>: 2025-12-15T21:12:20Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>use gizmos in non-system contexts, such as deep in a math library or callback without ecs access.<li>kind of upstream https://github.com/atlv24/glizmo<li>builds off of https://github.com/bevyengine/bevy/pull/22105</ul><h2 id=solution>Solution</h2><ul><li>mutex + deref</ul><h2 id=testing>Testing</h2><ul><li></ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a practical limitation in Bevy’s gizmo system: the inability to draw debug shapes from code that doesn’t have access to the ECS. Previously, gizmos could only be used within Bevy systems where you could access the <code>Gizmos</code> resource through ECS queries. This meant that utility libraries, mathematical functions, or callbacks that needed to visualize debug information couldn’t easily integrate with Bevy’s debugging tools.<p>The solution implemented here is straightforward and follows a common pattern in Rust for global mutable state: a mutex-protected static variable. The core idea is to provide a global buffer where gizmo data can be written from anywhere in the codebase, then flush that buffer into the main <code>Gizmos</code> resource during the regular frame processing.<p>Looking at the implementation, the developer created a new module <code>global.rs</code> that defines a static <code>GLOBAL_GIZMO</code> mutex wrapping a <code>GizmoBuffer</code>. This buffer uses the default <code>DefaultGizmoConfigGroup</code> configuration and doesn’t include a render phase (indicated by the <code>()</code> type parameter). The <code>gizmo()</code> function provides access to this global buffer by returning the mutex guard, which implements <code>DerefMut</code> to transparently expose the <code>GizmoBuffer</code> API.<p>The synchronization mechanism is minimal but effective. The mutex ensures thread-safe access to the global buffer, while the <code>flush_global_gizmos</code> system, scheduled to run in the <code>Last</code> schedule just before <code>GizmoMeshSystems</code>, swaps out the accumulated gizmo data into the main <code>Gizmos</code> resource. This swap operation using <code>mem::swap</code> is efficient—it moves the data out of the mutex-protected buffer with minimal allocation overhead, leaving an empty buffer ready for the next frame’s debug drawing.<p>The architectural choice to use a separate buffer that gets swapped each frame aligns well with Bevy’s ECS-centric design. It avoids directly modifying the ECS resource from outside the ECS, maintaining clear ownership boundaries. The plugin approach integrates cleanly into Bevy’s existing gizmo system, requiring only minimal changes to the main <code>lib.rs</code> to add the new plugin.<p>One important consideration is performance: while the mutex introduces some synchronization overhead, it’s acceptable for debug drawing functionality that’s typically used during development and debugging sessions. The swap-and-extend approach in the flush system is efficient, and the mutex is only locked briefly during the swap operation and when external code calls <code>gizmo()</code> to draw something.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[External Code] -->|calls gizmo().draw()| B[Global Gizmo Buffer]
</span><span>    B -->|swap/extend in Last schedule| C[Main Gizmos Resource]
</span><span>    C -->|processed by| D[GizmoMeshSystems]
</span><span>    D -->|generates| E[Render Data]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ol><li><p><strong>crates/bevy_gizmos/src/global.rs</strong> (+48/-0): This new file implements the global gizmo functionality.</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// File: crates/bevy_gizmos/src/global.rs
</span><span style=color:#fa6e32>use </span><span>std</span><span style=color:#ed9366>::</span><span>sync</span><span style=color:#ed9366>::</span><span>Mutex</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>use </span><span>bevy_app</span><span style=color:#ed9366>::</span><span>{App</span><span style=color:#61676ccc>,</span><span> Last</span><span style=color:#61676ccc>,</span><span> Plugin}</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>use </span><span>bevy_ecs</span><span style=color:#ed9366>::</span><span>schedule</span><span style=color:#ed9366>::</span><span>IntoScheduleConfigs</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>use crate</span><span style=color:#61676ccc>::</span><span>{
</span><span>    config</span><span style=color:#ed9366>::</span><span>DefaultGizmoConfigGroup</span><span style=color:#61676ccc>,
</span><span>    gizmos</span><span style=color:#ed9366>::</span><span>{GizmoBuffer</span><span style=color:#61676ccc>,</span><span> Gizmos}</span><span style=color:#61676ccc>,
</span><span>    GizmoMeshSystems</span><span style=color:#61676ccc>,
</span><span>}</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>static </span><span style=color:#ff8f40>GLOBAL_GIZMO</span><span style=color:#61676ccc>: </span><span>Mutex&LTGizmoBuffer&LTDefaultGizmoConfigGroup, ()>> </span><span style=color:#ed9366>=
</span><span>    Mutex</span><span style=color:#ed9366>::</span><span>new(GizmoBuffer</span><span style=color:#ed9366>::</span><span>new())</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>/// Lets you use bevy gizmos outside of systems.
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>GlobalGizmosPlugin</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>impl </span><span>Plugin </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>GlobalGizmosPlugin </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>build</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>app</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> App) {
</span><span>        app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(Last</span><span style=color:#61676ccc>,</span><span> flush_global_gizmos</span><span style=color:#ed9366>.</span><span style=color:#f07171>before</span><span>(GizmoMeshSystems))</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>flush_global_gizmos</span><span>(</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>gizmos</span><span style=color:#61676ccc>:</span><span> Gizmos) {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> buffer </span><span style=color:#ed9366>= </span><span>GizmoBuffer</span><span style=color:#ed9366>::</span><span>new()</span><span style=color:#61676ccc>;
</span><span>    {
</span><span>        core</span><span style=color:#ed9366>::</span><span>mem</span><span style=color:#ed9366>::</span><span>swap(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> buffer</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>GLOBAL_GIZMO</span><span style=color:#ed9366>.</span><span style=color:#f07171>lock</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>())</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>    gizmos</span><span style=color:#ed9366>.</span><span>strip_positions</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend</span><span>(buffer</span><span style=color:#ed9366>.</span><span>strip_positions)</span><span style=color:#61676ccc>;
</span><span>    gizmos</span><span style=color:#ed9366>.</span><span>strip_colors</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend</span><span>(buffer</span><span style=color:#ed9366>.</span><span>strip_colors)</span><span style=color:#61676ccc>;
</span><span>    gizmos</span><span style=color:#ed9366>.</span><span>list_positions</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend</span><span>(buffer</span><span style=color:#ed9366>.</span><span>list_positions)</span><span style=color:#61676ccc>;
</span><span>    gizmos</span><span style=color:#ed9366>.</span><span>list_colors</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend</span><span>(buffer</span><span style=color:#ed9366>.</span><span>list_colors)</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>/// A global gizmo context for use outside of bevy systems.
</span><span style=color:#abb0b6;font-style:italic>///
</span><span style=color:#abb0b6;font-style:italic>/// # Example
</span><span style=color:#abb0b6;font-style:italic>/// ```
</span><span style=color:#abb0b6;font-style:italic>/// # use bevy_gizmos::prelude::*;
</span><span style=color:#abb0b6;font-style:italic>/// # use bevy_math::prelude::*;
</span><span style=color:#abb0b6;font-style:italic>/// # use bevy_color::palettes::basic::WHITE;
</span><span style=color:#abb0b6;font-style:italic>/// fn draw() {
</span><span style=color:#abb0b6;font-style:italic>///     gizmo().sphere(Isometry3d::IDENTITY, 0.5, WHITE);
</span><span style=color:#abb0b6;font-style:italic>/// }
</span><span style=color:#abb0b6;font-style:italic>/// ```
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>gizmo</span><span>() </span><span style=color:#61676ccc>-></span><span> impl core</span><span style=color:#ed9366>::</span><span>ops</span><span style=color:#ed9366>::</span><span>DerefMut&LTTarget = GizmoBuffer&LTDefaultGizmoConfigGroup, ()>> {
</span><span>    </span><span style=color:#ff8f40>GLOBAL_GIZMO</span><span style=color:#ed9366>.</span><span style=color:#f07171>lock</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()
</span><span>}
</span></code></pre><li><p><strong>crates/bevy_gizmos/src/lib.rs</strong> (+3/-1): Modified to include the new module and plugin.</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// File: crates/bevy_gizmos/src/lib.rs
</span><span style=color:#abb0b6;font-style:italic>// Before (relevant excerpt):
</span><span style=color:#abb0b6;font-style:italic>// mod global; // Not present
</span><span style=color:#abb0b6;font-style:italic>// ...
</span><span style=color:#abb0b6;font-style:italic>// impl Plugin for GizmoPlugin {
</span><span style=color:#abb0b6;font-style:italic>//     fn build(&self, app: &mut App) {
</span><span style=color:#abb0b6;font-style:italic>//         // ...
</span><span style=color:#abb0b6;font-style:italic>//         app.add_plugins(aabb::AabbGizmoPlugin);
</span><span style=color:#abb0b6;font-style:italic>//         // ...
</span><span style=color:#abb0b6;font-style:italic>//     }
</span><span style=color:#abb0b6;font-style:italic>// }
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>mod </span><span style=color:#399ee6>global</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// Added
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// In prelude module:
</span><span style=color:#fa6e32>pub use crate</span><span style=color:#ed9366>::</span><span>global</span><span style=color:#ed9366>::</span><span>gizmo</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// Added to exports
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// In Plugin implementation:
</span><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_plugins</span><span>((aabb</span><span style=color:#ed9366>::</span><span>AabbGizmoPlugin</span><span style=color:#61676ccc>, </span><span>global</span><span style=color:#ed9366>::</span><span>GlobalGizmosPlugin))</span><span style=color:#61676ccc>;
</span></code></pre></ol><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/std/sync/struct.Mutex.html target=_blank>Rust <code>std::sync::Mutex</code> documentation</a> - Understanding the synchronization primitive used<li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_gizmos/latest/bevy_gizmos/ target=_blank>Bevy Gizmos documentation</a> - Official documentation for Bevy’s gizmo system<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/pull/22105 target=_blank>PR #22105: GizmoBuffer abstraction</a> - The foundational PR this builds upon<li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/programming/plugins.html target=_blank>Bevy Plugin system</a> - How plugins work in Bevy’s architecture<li><a rel="noopener nofollow noreferrer" href=https://fettblog.eu/global-state-in-rust/ target=_blank>Global state patterns in Rust</a> - Various approaches to managing global state</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22107.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>