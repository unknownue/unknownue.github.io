<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22252 Solari: Disable world cache jitter
        
    </title><meta content="#22252 Solari: Disable world cache jitter" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-29</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22252-zh-cn-20251229>中文</a></div></div><div class=pr-content><h1 id=solari-disable-world-cache-jitter>Solari: Disable world cache jitter</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Solari: Disable world cache jitter<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22252<li><strong>Author</strong>: JMS55<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, S-Ready-For-Final-Review, C-Refinement<li><strong>Created</strong>: 2025-12-24T02:22:18Z<li><strong>Merged</strong>: 2025-12-29T05:21:50Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>I did a bunch of testing, and after recent rounds of improvements to specular GI, I don’t think this is worth it anymore. Turning it off reduces light leaks with thin geometry.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This pull request addresses a specific optimization trade-off in Bevy’s Solari global illumination system. The change focuses on the world cache query mechanism in the real-time rendering pipeline, specifically modifying how position jittering is handled during cache lookups.<p>The core issue revolves around jittering world positions when querying the world cache. Previously, the system used jittering to reduce banding artifacts by adding random offsets to query positions within the tangent plane of the surface normal. This technique was implemented following guidance from external resources, as referenced in the code comment pointing to a blog post about ReGIR (Realtime Global Illumination in Raytracing).<p>However, after extensive testing and recent improvements to the specular GI implementation, the author determined that the jittering approach was no longer providing sufficient benefits to justify its cost. More critically, the jittering was found to cause light leaks with thin geometry. These light leaks occur when the jittered query position incorrectly samples lighting information from behind thin surfaces or from adjacent geometry, resulting in unrealistic illumination bleeding through objects.<p>The solution implemented is straightforward: disable the jittering by default. This is achieved by changing the conditional compilation flag from <code>NO_JITTER_WORLD_CACHE</code> to <code>JITTER_WORLD_CACHE</code>. The change effectively inverts the default behavior - instead of jittering being enabled by default (and requiring an explicit flag to disable it), jittering is now disabled by default and must be explicitly enabled if needed.<p>Technically, this change represents a refinement based on empirical testing results. The jittering technique was originally implemented to address specific visual artifacts, but as the overall GI system improved, the trade-offs shifted. The removal of jittering reduces computational overhead (avoiding the orthonormalization and random offset calculations) while simultaneously improving visual quality by eliminating light leaks.<p>The implementation is minimal but significant. By changing just one line in a WGSL shader, the entire system’s behavior is modified. This type of change demonstrates how small adjustments in graphics programming can have substantial impacts on visual quality and performance. The conditional compilation approach ensures that the jittering code remains available for potential future use or experimentation, while keeping the default path optimized and artifact-free.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[World Cache Query] --> B{Jitter Enabled?}
</span><span>    B -->|Yes| C[Calculate Random Offset]
</span><span>    C --> D[Apply Offset in Tangent Plane]
</span><span>    D --> E[Query Cache at Jittered Position]
</span><span>    B -->|No| F[Query Cache at Original Position]
</span><span>    E --> G[Return Cached GI Data]
</span><span>    F --> G
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=file-crates-bevy-solari-src-realtime-world-cache-query-wgsl>File: <code>crates/bevy_solari/src/realtime/world_cache_query.wgsl</code></h3><p>This WGSL shader file contains the world cache query function that retrieves global illumination data. The change modifies how world positions are handled before querying the cache.<p><strong>Before the change:</strong><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// https://tomclabault.github.io/blog/2025/regir, jitter_world_position_tangent_plane
</span><span>#ifndef NO_JITTER_WORLD_CACHE
</span><span>    let TBN = orthonormalize(world_normal);
</span><span>    let offset = (rand_vec2f(rng) * 2.0 - 1.0) * cell_size * 0.5;
</span><span>    world_position += offset.x * TBN[0] + offset.y * TBN[1];
</span><span>#endif
</span></code></pre><p><strong>After the change:</strong><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// https://tomclabault.github.io/blog/2025/regir, jitter_world_position_tangent_plane
</span><span>#ifdef JITTER_WORLD_CACHE
</span><span>    let TBN = orthonormalize(world_normal);
</span><span>    let offset = (rand_vec2f(rng) * 2.0 - 1.0) * cell_size * 0.5;
</span><span>    world_position += offset.x * TBN[0] + offset.y * TBN[1];
</span><span>#endif
</span></code></pre><p>The key difference is the conditional compilation flag. Previously, jittering was enabled by default unless <code>NO_JITTER_WORLD_CACHE</code> was defined. Now, jittering is disabled by default and only enabled if <code>JITTER_WORLD_CACHE</code> is explicitly defined. This change directly addresses the light leak issue by removing the random position offsets that could cause queries to sample from incorrect locations.<h2 id=further-reading>Further Reading</h2><ol><li><p><a rel="noopener nofollow noreferrer" href=https://tomclabault.github.io/blog/2025/regir target=_blank>ReGIR: Realtime Global Illumination in Raytracing</a> - The original blog post referenced in the code comment, which discusses the jittering technique in detail.</p><li><p>Bevy’s rendering documentation for understanding how the Solari global illumination system integrates with the overall rendering pipeline.</p><li><p>Graphics programming resources on jittering and anti-aliasing techniques for understanding the trade-offs involved in position jittering approaches.</p><li><p>Real-time global illumination literature for context on the challenges of thin geometry and light leaks in GI systems.</p></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22252.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>