<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21863 Fix immediate nested loaded assets not loading their dependencies.
        
    </title><meta content="#21863 Fix immediate nested loaded assets not loading their dependencies." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-10</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2025-12/pr-21863-en-20251210>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=ji-ben-xin-xi>基本信息</h2><ul><li><strong>标题</strong>: Fix immediate nested loaded assets not loading their dependencies.<li><strong>PR链接</strong>: https://github.com/bevyengine/bevy/pull/21863<li><strong>作者</strong>: andriyDev<li><strong>状态</strong>: 已合并<li><strong>标签</strong>: C-Bug, D-Trivial, A-Assets, S-Ready-For-Final-Review<li><strong>创建时间</strong>: 2025-11-16T22:00:32Z<li><strong>合并时间</strong>: 2025-12-09T23:50:10Z<li><strong>合并者</strong>: alice-i-cecile</ul><h2 id=miao-shu-fan-yi>描述翻译</h2><h1 id=mu-biao>目标</h1><ul><li>之前，如果你立即加载一个嵌套资产（immediate nested asset），它不会加载其任何依赖项。这意味着你的资产中可能包含永远不会加载的句柄（handles）。<li>修复 #20988</ul><h2 id=jie-jue-fang-an>解决方案</h2><ul><li>将加载依赖项传播到立即资产加载。<li>我还删除了一些测试应用设置代码的重复。</ul><h2 id=ce-shi>测试</h2><ul><li>添加了一个测试。</ul><p>有一个情况会产生稍微不理想的效果：当你立即加载一个资产，从中获取一些数据（但没有依赖句柄），然后丢弃这个立即加载的资产。现在，这个更改将启动依赖加载，即使我们不会使用它。 然而，A) 拥有一个永远不会加载的句柄更令人惊讶，B) 一旦我们丢弃该句柄，我们应该取消依赖加载，所以我们不应该承担太多的加载成本。<h2 id=zhe-ge-pull-request-de-gu-shi>这个 Pull Request 的故事</h2><h3 id=wen-ti-he-bei-jing>问题和背景</h3><p>在 Bevy 的资产系统中，资产可以引用其他资产，形成依赖关系。开发者可以通过两种方式加载资产：标准异步加载和“立即”加载（immediate load）。立即加载通常用于在资产处理过程中同步地获取另一个资产，例如在加载一个主资产时，其配置文件中指定了需要立即使用的子资产。<p>问题出现在当一个资产通过立即加载方式加载另一个嵌套资产时。在 PR #21863 修复之前，这个立即加载的嵌套资产不会触发其自身依赖项的加载。这意味着，如果嵌套资产本身包含指向其他资产的句柄，这些句柄将永远不会被加载，导致资产处于不完整状态。这是一个严重的 Bug，因为它破坏了资产依赖链的可靠性，开发者可能会发现他们的资产中部分内容缺失，而没有任何错误提示。<p>该问题由 issue #20988 记录，指出了在某些情况下资产句柄永远不会加载的问题。<h3 id=jie-jue-fang-an-fang-fa>解决方案方法</h3><p>问题的根源在于资产加载上下文中一个标志位的传播。在 Bevy 的资产加载器（AssetLoader）中，<code>LoadContext</code> 结构体有一个 <code>should_load_dependencies</code> 字段，用于控制是否应该实际加载依赖项（而不仅仅是记录它们）。在立即加载嵌套资产时，这个标志没有被传递给内部加载过程，导致内部加载过程默认不加载依赖。<p>解决方案很直接：在立即加载嵌套资产时，将当前上下文的 <code>should_load_dependencies</code> 标志传播给内部加载。这样，如果父级加载需要依赖，那么嵌套资产的依赖也会被加载；反之，如果父级加载只是为了获取信息而不需要实际加载依赖（例如在资产预处理阶段），那么嵌套资产的依赖也不会被加载，从而保持原有行为。<p>开发者还借此机会重构了测试代码，提取了通用的应用创建逻辑，消除了多个测试中重复的设置代码。<h3 id=ju-ti-shi-xian>具体实现</h3><p>实现主要集中在 <code>crates/bevy_asset/src/loader.rs</code> 文件中。修改了 <code>LoadContext</code> 的 <code>load_direct_untyped</code> 方法（或相关内部方法），将当前上下文的 <code>should_load_dependencies</code> 标志传递给内部加载调用。<p>具体来说，在 <code>loader.rs</code> 的 <code>load_direct_untyped</code> 函数中（由 <code>LoadContext</code> 的 <code>load</code> 方法调用），当执行立即加载时，现在将 <code>self.should_load_dependencies</code> 作为参数传递给内部加载函数，而不是之前的硬编码 <code>false</code>。<p>修改前，立即加载嵌套资产时，内部加载调用忽略依赖加载；修改后，内部加载会根据外部上下文的标志决定是否加载依赖。<p>此外，在 <code>crates/bevy_asset/src/lib.rs</code> 中，开发者重构了测试工具函数，将原来的 <code>test_app</code> 函数拆分为更通用的 <code>create_app</code> 和 <code>create_app_with_gate</code>，以减少代码重复。最重要的是，添加了一个新的测试 <code>immediate_nested_asset_loads_dependency</code>，专门验证立即加载嵌套资产时其依赖是否被正确加载。<h3 id=ji-shu-jian-jie>技术见解</h3><p>这个修复涉及 Bevy 资产系统的核心概念：<strong>依赖跟踪</strong>和<strong>加载策略</strong>。<p>资产加载分为两个阶段：1) 解析资产并识别依赖；2) 实际加载依赖资产。<code>should_load_dependencies</code> 标志用于控制第二阶段是否执行。在某些场景下，例如资产预处理（preprocessing），我们只需要知道资产依赖哪些其他资产，而不需要立即加载它们，这时可以设置 <code>should_load_dependencies = false</code>。<p>立即加载（immediate load）是一种特殊的同步加载方式，它会在当前加载过程中直接返回加载的资产，而不是异步等待。在修复前，立即加载内部硬编码了 <code>should_load_dependencies = false</code>，这意味着立即加载的资产永远不会触发其依赖的加载。这显然是不合理的，因为立即加载的资产可能也需要其依赖才能正常工作。<p>修复方案确保了加载策略的一致性：如果外部加载需要依赖，那么内部立即加载也应该需要依赖。这符合开发者的直觉。<p>性能方面，PR 描述中提到了一个可能的轻微性能下降：如果开发者立即加载一个资产，只读取一些数据（不涉及依赖句柄），然后丢弃该资产，现在会触发不必要的依赖加载。但作者指出，这比拥有一个永不加载的句柄（会导致资产不完整）更可取，而且系统会在句柄被丢弃后取消加载，因此实际成本有限。<h3 id=ying-xiang>影响</h3><p>这个修复解决了资产依赖链中的一个关键漏洞，确保了立即加载的嵌套资产也能正确加载其依赖。这使得资产系统的行为更加一致和可靠。<p>代码重构部分提高了测试代码的可维护性，减少了重复。<p>新添加的测试为这一特定场景提供了保护，防止未来回归。<p>总体而言，这是一个小而重要的修复，增强了 Bevy 资产系统的健壮性。<h2 id=shi-jue-biao-shi>视觉表示</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Asset Loader] --> B[LoadContext]
</span><span>    B --> C[immediate load]
</span><span>    C --> D[Internal LoadContext]
</span><span>    D --> E[Load dependencies?]
</span><span>    E --> F{should_load_dependencies}
</span><span>    F -->|true| G[Load dependencies]
</span><span>    F -->|false| H[Skip loading]
</span></code></pre><h2 id=guan-jian-wen-jian-geng-gai>关键文件更改</h2><h3 id=crates-bevy-asset-src-loader-rs-5-1><code>crates/bevy_asset/src/loader.rs</code> (+5/-1)</h3><p>这个文件修改了 <code>LoadContext</code> 中立即加载的逻辑，将 <code>should_load_dependencies</code> 标志传播给嵌套的立即加载。<p>关键修改：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 在 load_direct_untyped 或相关函数中，之前可能是：
</span><span style=color:#fa6e32>let</span><span> loaded_asset </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>asset_server</span><span style=color:#ed9366>.</span><span style=color:#f07171>load_direct_untyped</span><span>(
</span><span>    </span><span style=color:#ed9366>&</span><span>asset_path</span><span style=color:#61676ccc>,
</span><span>    meta</span><span style=color:#61676ccc>,
</span><span>    loader</span><span style=color:#61676ccc>,
</span><span>    reader</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#ff8f40>false</span><span style=color:#61676ccc>, </span><span style=color:#abb0b6;font-style:italic>// 硬编码为 false，不加载依赖
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>populate_hashes</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#ed9366>.</span><span>await</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 修改后：
</span><span style=color:#fa6e32>let</span><span> loaded_asset </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>asset_server</span><span style=color:#ed9366>.</span><span style=color:#f07171>load_direct_untyped</span><span>(
</span><span>    </span><span style=color:#ed9366>&</span><span>asset_path</span><span style=color:#61676ccc>,
</span><span>    meta</span><span style=color:#61676ccc>,
</span><span>    loader</span><span style=color:#61676ccc>,
</span><span>    reader</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>should_load_dependencies</span><span style=color:#61676ccc>, </span><span style=color:#abb0b6;font-style:italic>// 传播外部标志
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>populate_hashes</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#ed9366>.</span><span>await</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span></code></pre><p>这个改动确保了立即加载的嵌套资产会遵循外部加载上下文的依赖加载策略。<h3 id=crates-bevy-asset-src-lib-rs-162-96><code>crates/bevy_asset/src/lib.rs</code> (+162/-96)</h3><p>这个文件主要包含测试代码的修改：<ol><li>重构了测试应用创建函数，提取了 <code>create_app</code> 和 <code>create_app_with_gate</code>。<li>添加了新测试 <code>immediate_nested_asset_loads_dependency</code>。</ol><p>新测试的关键代码：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>immediate_nested_asset_loads_dependency</span><span>() {
</span><span>    </span><span style=color:#fa6e32>let </span><span>(</span><span style=color:#fa6e32>mut</span><span> app</span><span style=color:#61676ccc>,</span><span> dir) </span><span style=color:#ed9366>= </span><span style=color:#f07171>create_app</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... 定义了几个测试资产和加载器 ...
</span><span>
</span><span>    dir</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_asset_text</span><span>(Path</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#86b300>"a.immediate"</span><span>)</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"b.defer"</span><span>)</span><span style=color:#61676ccc>;
</span><span>    dir</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_asset_text</span><span>(Path</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#86b300>"b.defer"</span><span>)</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"c.txt"</span><span>)</span><span style=color:#61676ccc>;
</span><span>    dir</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_asset_text</span><span>(Path</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#86b300>"c.txt"</span><span>)</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"hiya"</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#fa6e32>let</span><span> server </span><span style=color:#ed9366>=</span><span> app</span><span style=color:#ed9366>.</span><span style=color:#f07171>world</span><span>()</span><span style=color:#ed9366>.</span><span>resource</span><span style=color:#ed9366>::</span><span>&LTAssetServer>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> immediate_handle</span><span style=color:#61676ccc>: </span><span>Handle&LTImmediateNested> </span><span style=color:#ed9366>=</span><span> server</span><span style=color:#ed9366>.</span><span style=color:#f07171>load</span><span>(</span><span style=color:#86b300>"a.immediate"</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 运行应用直到条件满足
</span><span>    </span><span style=color:#f07171>run_app_until</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> app</span><span style=color:#61676ccc>, </span><span>|</span><span style=color:#ff8f40>world</span><span>| {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// 验证立即加载的资产及其依赖都已加载
</span><span>        </span><span style=color:#fa6e32>let</span><span> immediate_assets </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span>resource</span><span style=color:#ed9366>::</span><span>&LTAssets&LTImmediateNested>>()</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#fa6e32>let</span><span> immediate </span><span style=color:#ed9366>=</span><span> immediate_assets</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#ed9366>&</span><span>immediate_handle)</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span><span>
</span><span>        </span><span style=color:#fa6e32>let</span><span> test_asset_handle </span><span style=color:#ed9366>=</span><span> immediate</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#61676ccc>;
</span><span>        world
</span><span>            </span><span style=color:#ed9366>.</span><span>resource</span><span style=color:#ed9366>::</span><span>&LTAssets&LTTestAsset>>()
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#ed9366>&</span><span>test_asset_handle)</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span><span>
</span><span>        </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(())
</span><span>    })</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>这个测试模拟了一个三层依赖链：一个立即加载的资产 <code>a.immediate</code> 立即加载 <code>b.defer</code>，而 <code>b.defer</code> 又异步加载 <code>c.txt</code>。测试验证了最终 <code>c.txt</code> 被正确加载。<h2 id=jin-yi-bu-yue-du>进一步阅读</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_asset/latest/bevy_asset/ target=_blank>Bevy Asset System Documentation</a> - Bevy 资产系统的官方文档。<li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/features/assets.html target=_blank>Bevy Assets and Loaders</a> - Bevy 资产和加载器的指南。<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/issues/20988 target=_blank>Issue #20988</a> - 该 PR 修复的原始问题。</ul><h1 id=full-code-diff>Full Code Diff</h1><details><summary>展开查看完整代码差异</summary> <pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_asset/src/lib.rs b/crates/bevy_asset/src/lib.rs
</span><span>index add1b42c35553..f381a74e507a9 100644
</span><span style=color:#c594c5>--- a/crates/bevy_asset/src/lib.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_asset/src/lib.rs
</span><span style=color:#c594c5>@@ -718,8 +718,8 @@ </span><span style=color:#399ee6>mod tests {
</span><span>         },
</span><span>         loader::{AssetLoader, LoadContext},
</span><span>         Asset, AssetApp, AssetEvent, AssetId, AssetLoadError, AssetLoadFailedEvent, AssetPath,
</span><span style=color:#f07171>-        AssetPlugin, AssetServer, Assets, InvalidGenerationError, LoadState, UnapprovedPathMode,
</span><span style=color:#f07171>-        UntypedHandle,
</span><span style=color:#86b300>+        AssetPlugin, AssetServer, Assets, InvalidGenerationError, LoadState, LoadedAsset,
</span><span style=color:#86b300>+        UnapprovedPathMode, UntypedHandle,
</span><span>     };
</span><span>     use alloc::{
</span><span>         boxed::Box,
</span><span style=color:#c594c5>@@ -743,6 +743,7 @@ </span><span style=color:#399ee6>mod tests {
</span><span>     };
</span><span>     use bevy_reflect::TypePath;
</span><span>     use core::time::Duration;
</span><span style=color:#86b300>+    use futures_lite::AsyncReadExt;
</span><span>     use serde::{Deserialize, Serialize};
</span><span>     use std::path::{Path, PathBuf};
</span><span>     use thiserror::Error;
</span><span style=color:#c594c5>@@ -762,7 +763,7 @@ </span><span style=color:#399ee6>mod tests {
</span><span>         pub text: String,
</span><span>     }
</span><span> 
</span><span style=color:#f07171>-    #[derive(Serialize, Deserialize)]
</span><span style=color:#86b300>+    #[derive(Serialize, Deserialize, Default)]
</span><span>     pub struct CoolTextRon {
</span><span>         pub text: String,
</span><span>         pub dependencies: Vec&LTString>,
</span><span style=color:#c594c5>@@ -901,7 +902,28 @@ </span><span style=color:#399ee6>mod tests {
</span><span>         }
</span><span>     }
</span><span> 
</span><span style=color:#f07171>-    fn test_app(dir: Dir) -> (App, GateOpener) {
</span><span style=color:#86b300>+    /// Creates a basic asset app and an in-memory file system.
</span><span style=color:#86b300>+    fn create_app() -> (App, Dir) {
</span><span style=color:#86b300>+        let mut app = App::new();
</span><span style=color:#86b300>+        let dir = Dir::default();
</span><span style=color:#86b300>+        let dir_clone = dir.clone();
</span><span style=color:#86b300>+        app.register_asset_source(
</span><span style=color:#86b300>+            AssetSourceId::Default,
</span><span style=color:#86b300>+            AssetSourceBuilder::new(move || {
</span><span style=color:#86b300>+                Box::new(MemoryAssetReader {
</span><span style=color:#86b300>+                    root: dir_clone.clone(),
</span><span style=color:#86b300>+                })
</span><span style=color:#86b300>+            }),
</span><span style=color:#86b300>+        )
</span><span style=color:#86b300>+        .add_plugins((
</span><span style=color:#86b300>+            TaskPoolPlugin::default(),
</span><span style=color:#86b300>+            AssetPlugin::default(),
</span><span style=color:#86b300>+            DiagnosticsPlugin,
</span><span style=color:#86b300>+        ));
</span><span style=color:#86b300>+        (app, dir)
</span><span style=color:#86b300>+    }
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+    fn create_app_with_gate(dir: Dir) -> (App, GateOpener) {
</span><span>         let mut app = App::new();
</span><span>         let (gated_memory_reader, gate_opener) = GatedReader::new(MemoryAssetReader { root: dir });
</span><span>         app.register_asset_source(
</span><span style=color:#c594c5>@@ -1007,7 +1029,7 @@ </span><span style=color:#399ee6>mod tests {
</span><span>             d_id: AssetId&LTCoolText>,
</span><span>         }
</span><span> 
</span><span style=color:#f07171>-        let (mut app, gate_opener) = test_app(dir);
</span><span style=color:#86b300>+        let (mut app, gate_opener) = create_app_with_gate(dir);
</span><span>         app.init_asset::&LTCoolText>()
</span><span>             .init_asset::&LTSubText>()
</span><span>             .init_resource::&LTStoredEvents>()
</span><span style=color:#c594c5>@@ -1312,7 +1334,7 @@ </span><span style=color:#399ee6>mod tests {
</span><span>         dir.insert_asset_text(Path::new(c_path), c_ron);
</span><span>         dir.insert_asset_text(Path::new(d_path), d_ron);
</span><span> 
</span><span style=color:#f07171>-        let (mut app, gate_opener) = test_app(dir);
</span><span style=color:#86b300>+        let (mut app, gate_opener) = create_app_with_gate(dir);
</span><span>         app.init_asset::&LTCoolText>()
</span><span>             .register_asset_loader(CoolTextLoader);
</span><span>         let asset_server = app.world().resource::&LTAssetServer>().clone();
</span><span style=color:#c594c5>@@ -1437,7 +1459,7 @@ </span><span style=color:#399ee6>mod tests {
</span><span>         dir.insert_asset_text(Path::new(b_path), b_ron);
</span><span>         dir.insert_asset_text(Path::new(c_path), c_ron);
</span><span> 
</span><span style=color:#f07171>-        let (mut app, gate_opener) = test_app(dir);
</span><span style=color:#86b300>+        let (mut app, gate_opener) = create_app_with_gate(dir);
</span><span>         app.init_asset::&LTCoolText>()
</span><span>             .register_asset_loader(CoolTextLoader);
</span><span>         let asset_server = app.world().resource::&LTAssetServer>().clone();
</span><span style=color:#c594c5>@@ -1514,7 +1536,7 @@ </span><span style=color:#399ee6>mod tests {
</span><span>         let dir = Dir::default();
</span><span>         dir.insert_asset_text(Path::new("dep.cool.ron"), SIMPLE_TEXT);
</span><span> 
</span><span style=color:#f07171>-        let (mut app, _) = test_app(dir);
</span><span style=color:#86b300>+        let (mut app, _) = create_app_with_gate(dir);
</span><span>         app.init_asset::&LTCoolText>()
</span><span>             .init_asset::&LTSubText>()
</span><span>             .init_resource::&LTStoredEvents>()
</span><span style=color:#c594c5>@@ -1551,7 +1573,7 @@ </span><span style=color:#399ee6>mod tests {
</span><span> 
</span><span>         dir.insert_asset_text(Path::new(dep_path), SIMPLE_TEXT);
</span><span> 
</span><span style=color:#f07171>-        let (mut app, gate_opener) = test_app(dir);
</span><span style=color:#86b300>+        let (mut app, gate_opener) = create_app_with_gate(dir);
</span><span>         app.init_asset::&LTCoolText>()
</span><span>             .init_asset::&LTSubText>()
</span><span>             .init_resource::&LTStoredEvents>()
</span><span style=color:#c594c5>@@ -1692,7 +1714,7 @@ </span><span style=color:#399ee6>mod tests {
</span><span>         dir.insert_asset_text(Path::new(b_path), b_ron);
</span><span>         dir.insert_asset_text(Path::new(c_path), c_ron);
</span><span> 
</span><span style=color:#f07171>-        let (mut app, gate_opener) = test_app(dir);
</span><span style=color:#86b300>+        let (mut app, gate_opener) = create_app_with_gate(dir);
</span><span>         app.init_asset::&LTCoolText>()
</span><span>             .init_asset::&LTSubText>()
</span><span>             .register_asset_loader(CoolTextLoader);
</span><span style=color:#c594c5>@@ -1878,9 +1900,8 @@ </span><span style=color:#399ee6>mod tests {
</span><span> 
</span><span>     #[test]
</span><span>     fn ignore_system_ambiguities_on_assets() {
</span><span style=color:#f07171>-        let mut app = App::new();
</span><span style=color:#f07171>-        app.add_plugins(AssetPlugin::default())
</span><span style=color:#f07171>-            .init_asset::&LTCoolText>();
</span><span style=color:#86b300>+        let mut app = create_app().0;
</span><span style=color:#86b300>+        app.init_asset::&LTCoolText>();
</span><span> 
</span><span>         fn uses_assets(_asset: ResMut&LTAssets&LTCoolText>>) {}
</span><span>         app.add_systems(Update, (uses_assets, uses_assets));
</span><span style=color:#c594c5>@@ -1899,9 +1920,7 @@ </span><span style=color:#399ee6>mod tests {
</span><span>     // not capable of loading subassets when doing nested immediate loads.
</span><span>     #[test]
</span><span>     fn error_on_nested_immediate_load_of_subasset() {
</span><span style=color:#f07171>-        let mut app = App::new();
</span><span style=color:#f07171>-
</span><span style=color:#f07171>-        let dir = Dir::default();
</span><span style=color:#86b300>+        let (mut app, dir) = create_app();
</span><span>         dir.insert_asset_text(
</span><span>             Path::new("a.cool.ron"),
</span><span>             r#"(
</span><span style=color:#c594c5>@@ -1913,12 +1932,6 @@ </span><span style=color:#399ee6>mod tests {
</span><span>         );
</span><span>         dir.insert_asset_text(Path::new("empty.txt"), "");
</span><span> 
</span><span style=color:#f07171>-        app.register_asset_source(
</span><span style=color:#f07171>-            AssetSourceId::Default,
</span><span style=color:#f07171>-            AssetSourceBuilder::new(move || Box::new(MemoryAssetReader { root: dir.clone() })),
</span><span style=color:#f07171>-        )
</span><span style=color:#f07171>-        .add_plugins((TaskPoolPlugin::default(), AssetPlugin::default()));
</span><span style=color:#f07171>-
</span><span>         app.init_asset::&LTCoolText>()
</span><span>             .init_asset::&LTSubText>()
</span><span>             .register_asset_loader(CoolTextLoader);
</span><span style=color:#c594c5>@@ -2110,10 +2123,9 @@ </span><span style=color:#399ee6>mod tests {
</span><span> 
</span><span>     #[test]
</span><span>     fn insert_dropped_handle_returns_error() {
</span><span style=color:#f07171>-        let mut app = App::new();
</span><span style=color:#86b300>+        let mut app = create_app().0;
</span><span> 
</span><span style=color:#f07171>-        app.add_plugins((TaskPoolPlugin::default(), AssetPlugin::default()))
</span><span style=color:#f07171>-            .init_asset::&LTTestAsset>();
</span><span style=color:#86b300>+        app.init_asset::&LTTestAsset>();
</span><span> 
</span><span>         let handle = app.world().resource::&LTAssets&LTTestAsset>>().reserve_handle();
</span><span>         // We still have the asset ID, but we've dropped the handle so the asset is no longer live.
</span><span style=color:#c594c5>@@ -2171,14 +2183,7 @@ </span><span style=color:#399ee6>mod tests {
</span><span> 
</span><span>     #[test]
</span><span>     fn dropping_handle_while_loading_cancels_load() {
</span><span style=color:#f07171>-        let dir = Dir::default();
</span><span style=color:#f07171>-        let mut app = App::new();
</span><span style=color:#f07171>-        let reader = MemoryAssetReader { root: dir.clone() };
</span><span style=color:#f07171>-        app.register_asset_source(
</span><span style=color:#f07171>-            AssetSourceId::Default,
</span><span style=color:#f07171>-            AssetSourceBuilder::new(move || Box::new(reader.clone())),
</span><span style=color:#f07171>-        )
</span><span style=color:#f07171>-        .add_plugins((TaskPoolPlugin::default(), AssetPlugin::default()));
</span><span style=color:#86b300>+        let (mut app, dir) = create_app();
</span><span> 
</span><span>         let (in_loader_sender, in_loader_receiver) = async_channel::bounded(1);
</span><span>         let (gate_sender, gate_receiver) = async_channel::bounded(1);
</span><span style=color:#c594c5>@@ -2227,14 +2232,7 @@ </span><span style=color:#399ee6>mod tests {
</span><span> 
</span><span>     #[test]
</span><span>     fn dropping_subasset_handle_while_loading_cancels_load() {
</span><span style=color:#f07171>-        let dir = Dir::default();
</span><span style=color:#f07171>-        let mut app = App::new();
</span><span style=color:#f07171>-        let reader = MemoryAssetReader { root: dir.clone() };
</span><span style=color:#f07171>-        app.register_asset_source(
</span><span style=color:#f07171>-            AssetSourceId::Default,
</span><span style=color:#f07171>-            AssetSourceBuilder::new(move || Box::new(reader.clone())),
</span><span style=color:#f07171>-        )
</span><span style=color:#f07171>-        .add_plugins((TaskPoolPlugin::default(), AssetPlugin::default()));
</span><span style=color:#86b300>+        let (mut app, dir) = create_app();
</span><span> 
</span><span>         let (in_loader_sender, in_loader_receiver) = async_channel::bounded(1);
</span><span>         let (gate_sender, gate_receiver) = async_channel::bounded(1);
</span><span style=color:#c594c5>@@ -2481,22 +2479,12 @@ </span><span style=color:#399ee6>mod tests {
</span><span>             }
</span><span>         }
</span><span> 
</span><span style=color:#f07171>-        // Create a test asset.
</span><span style=color:#86b300>+        // Create a test asset and setup the app.
</span><span> 
</span><span style=color:#f07171>-        let dir = Dir::default();
</span><span style=color:#86b300>+        let (mut app, dir) = create_app();
</span><span>         dir.insert_asset(Path::new("test.u8"), &[]);
</span><span> 
</span><span style=color:#f07171>-        let asset_source =
</span><span style=color:#f07171>-            AssetSourceBuilder::new(move || Box::new(MemoryAssetReader { root: dir.clone() }));
</span><span style=color:#f07171>-
</span><span style=color:#f07171>-        // Set up the app.
</span><span style=color:#f07171>-
</span><span style=color:#f07171>-        let mut app = App::new();
</span><span style=color:#f07171>-
</span><span style=color:#f07171>-        app.register_asset_source(AssetSourceId::Default, asset_source)
</span><span style=color:#f07171>-            .add_plugins((TaskPoolPlugin::default(), AssetPlugin::default()))
</span><span style=color:#f07171>-            .init_asset::&LTU8Asset>()
</span><span style=color:#f07171>-            .register_asset_loader(U8Loader);
</span><span style=color:#86b300>+        app.init_asset::&LTU8Asset>().register_asset_loader(U8Loader);
</span><span> 
</span><span>         let asset_server = app.world().resource::&LTAssetServer>();
</span><span> 
</span><span style=color:#c594c5>@@ -2545,18 +2533,9 @@ </span><span style=color:#399ee6>mod tests {
</span><span> 
</span><span>     #[test]
</span><span>     fn loading_two_subassets_does_not_start_two_loads() {
</span><span style=color:#f07171>-        let mut app = App::new();
</span><span style=color:#f07171>-
</span><span style=color:#f07171>-        let dir = Dir::default();
</span><span style=color:#86b300>+        let (mut app, dir) = create_app();
</span><span>         dir.insert_asset(Path::new("test.txt"), &[]);
</span><span> 
</span><span style=color:#f07171>-        let asset_source =
</span><span style=color:#f07171>-            AssetSourceBuilder::new(move || Box::new(MemoryAssetReader { root: dir.clone() }));
</span><span style=color:#f07171>-
</span><span style=color:#f07171>-        app.register_asset_source(AssetSourceId::Default, asset_source)
</span><span style=color:#f07171>-            .add_plugins((TaskPoolPlugin::default(), AssetPlugin::default()))
</span><span style=color:#f07171>-            .init_asset::&LTTestAsset>();
</span><span style=color:#f07171>-
</span><span>         struct TwoSubassetLoader;
</span><span> 
</span><span>         impl AssetLoader for TwoSubassetLoader {
</span><span style=color:#c594c5>@@ -2580,7 +2559,8 @@ </span><span style=color:#399ee6>mod tests {
</span><span>             }
</span><span>         }
</span><span> 
</span><span style=color:#f07171>-        app.register_asset_loader(TwoSubassetLoader);
</span><span style=color:#86b300>+        app.init_asset::&LTTestAsset>()
</span><span style=color:#86b300>+            .register_asset_loader(TwoSubassetLoader);
</span><span> 
</span><span>         let asset_server = app.world().resource::&LTAssetServer>().clone();
</span><span>         let _subasset_1: Handle&LTTestAsset> = asset_server.load("test.txt#A");
</span><span style=color:#c594c5>@@ -2595,42 +2575,35 @@ </span><span style=color:#399ee6>mod tests {
</span><span>         assert_eq!(get_started_load_count(app.world()), 2);
</span><span>     }
</span><span> 
</span><span style=color:#f07171>-    #[test]
</span><span style=color:#f07171>-    fn get_strong_handle_prevents_reload_when_asset_still_alive() {
</span><span style=color:#f07171>-        let mut app = App::new();
</span><span style=color:#f07171>-
</span><span style=color:#f07171>-        let dir = Dir::default();
</span><span style=color:#f07171>-        dir.insert_asset(Path::new("test.txt"), &[]);
</span><span style=color:#f07171>-
</span><span style=color:#f07171>-        let asset_source =
</span><span style=color:#f07171>-            AssetSourceBuilder::new(move || Box::new(MemoryAssetReader { root: dir.clone() }));
</span><span style=color:#f07171>-
</span><span style=color:#f07171>-        app.register_asset_source(AssetSourceId::Default, asset_source)
</span><span style=color:#f07171>-            .add_plugins((TaskPoolPlugin::default(), AssetPlugin::default()))
</span><span style=color:#f07171>-            .init_asset::&LTTestAsset>();
</span><span style=color:#86b300>+    /// A loader that immediately returns a [`TestAsset`].
</span><span style=color:#86b300>+    struct TrivialLoader;
</span><span> 
</span><span style=color:#f07171>-        struct TrivialLoader;
</span><span style=color:#f07171>-
</span><span style=color:#f07171>-        impl AssetLoader for TrivialLoader {
</span><span style=color:#f07171>-            type Asset = TestAsset;
</span><span style=color:#f07171>-            type Settings = ();
</span><span style=color:#f07171>-            type Error = std::io::Error;
</span><span style=color:#86b300>+    impl AssetLoader for TrivialLoader {
</span><span style=color:#86b300>+        type Asset = TestAsset;
</span><span style=color:#86b300>+        type Settings = ();
</span><span style=color:#86b300>+        type Error = std::io::Error;
</span><span> 
</span><span style=color:#f07171>-            async fn load(
</span><span style=color:#f07171>-                &self,
</span><span style=color:#f07171>-                _reader: &mut dyn Reader,
</span><span style=color:#f07171>-                _settings: &Self::Settings,
</span><span style=color:#f07171>-                _load_context: &mut LoadContext<'_>,
</span><span style=color:#f07171>-            ) -> Result&LTSelf::Asset, Self::Error> {
</span><span style=color:#f07171>-                Ok(TestAsset)
</span><span style=color:#f07171>-            }
</span><span style=color:#86b300>+        async fn load(
</span><span style=color:#86b300>+            &self,
</span><span style=color:#86b300>+            _reader: &mut dyn Reader,
</span><span style=color:#86b300>+            _settings: &Self::Settings,
</span><span style=color:#86b300>+            _load_context: &mut LoadContext<'_>,
</span><span style=color:#86b300>+        ) -> Result&LTSelf::Asset, Self::Error> {
</span><span style=color:#86b300>+            Ok(TestAsset)
</span><span style=color:#86b300>+        }
</span><span> 
</span><span style=color:#f07171>-            fn extensions(&self) -> &[&str] {
</span><span style=color:#f07171>-                &["txt"]
</span><span style=color:#f07171>-            }
</span><span style=color:#86b300>+        fn extensions(&self) -> &[&str] {
</span><span style=color:#86b300>+            &["txt"]
</span><span>         }
</span><span style=color:#86b300>+    }
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+    #[test]
</span><span style=color:#86b300>+    fn get_strong_handle_prevents_reload_when_asset_still_alive() {
</span><span style=color:#86b300>+        let (mut app, dir) = create_app();
</span><span style=color:#86b300>+        dir.insert_asset(Path::new("test.txt"), &[]);
</span><span> 
</span><span style=color:#f07171>-        app.register_asset_loader(TrivialLoader);
</span><span style=color:#86b300>+        app.init_asset::&LTTestAsset>()
</span><span style=color:#86b300>+            .register_asset_loader(TrivialLoader);
</span><span> 
</span><span>         let asset_server = app.world().resource::&LTAssetServer>().clone();
</span><span>         let original_handle: Handle&LTTestAsset> = asset_server.load("test.txt");
</span><span style=color:#c594c5>@@ -2672,4 +2645,97 @@ </span><span style=color:#399ee6>mod tests {
</span><span>         // assert_eq!(get_started_load_count(app.world()), 1);
</span><span>         assert_eq!(get_started_load_count(app.world()), 2);
</span><span>     }
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+    #[test]
</span><span style=color:#86b300>+    fn immediate_nested_asset_loads_dependency() {
</span><span style=color:#86b300>+        let (mut app, dir) = create_app();
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+        /// This asset holds a handle to its dependency.
</span><span style=color:#86b300>+        #[derive(Asset, TypePath)]
</span><span style=color:#86b300>+        struct DeferredNested(Handle&LTTestAsset>);
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+        struct DeferredNestedLoader;
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+        impl AssetLoader for DeferredNestedLoader {
</span><span style=color:#86b300>+            type Asset = DeferredNested;
</span><span style=color:#86b300>+            type Settings = ();
</span><span style=color:#86b300>+            type Error = std::io::Error;
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+            async fn load(
</span><span style=color:#86b300>+                &self,
</span><span style=color:#86b300>+                reader: &mut dyn Reader,
</span><span style=color:#86b300>+                _: &Self::Settings,
</span><span style=color:#86b300>+                load_context: &mut LoadContext<'_>,
</span><span style=color:#86b300>+            ) -> Result&LTSelf::Asset, Self::Error> {
</span><span style=color:#86b300>+                let mut nested_path = String::new();
</span><span style=color:#86b300>+                reader.read_to_string(&mut nested_path).await?;
</span><span style=color:#86b300>+                Ok(DeferredNested(load_context.load(nested_path)))
</span><span style=color:#86b300>+            }
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+            fn extensions(&self) -> &[&str] {
</span><span style=color:#86b300>+                &["defer"]
</span><span style=color:#86b300>+            }
</span><span style=color:#86b300>+        }
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+        /// This asset holds a handle a dependency of one of its dependencies.
</span><span style=color:#86b300>+        #[derive(Asset, TypePath)]
</span><span style=color:#86b300>+        struct ImmediateNested(Handle&LTTestAsset>);
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+        struct ImmediateNestedLoader;
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+        impl AssetLoader for ImmediateNestedLoader {
</span><span style=color:#86b300>+            type Asset = ImmediateNested;
</span><span style=color:#86b300>+            type Settings = ();
</span><span style=color:#86b300>+            type Error = std::io::Error;
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+            async fn load(
</span><span style=color:#86b300>+                &self,
</span><span style=color:#86b300>+                reader: &mut dyn Reader,
</span><span style=color:#86b300>+                _: &Self::Settings,
</span><span style=color:#86b300>+                load_context: &mut LoadContext<'_>,
</span><span style=color:#86b300>+            ) -> Result&LTSelf::Asset, Self::Error> {
</span><span style=color:#86b300>+                let mut nested_path = String::new();
</span><span style=color:#86b300>+                reader.read_to_string(&mut nested_path).await?;
</span><span style=color:#86b300>+                let deferred_nested: LoadedAsset&LTDeferredNested> = load_context
</span><span style=color:#86b300>+                    .loader()
</span><span style=color:#86b300>+                    .immediate()
</span><span style=color:#86b300>+                    .load(nested_path)
</span><span style=color:#86b300>+                    .await
</span><span style=color:#86b300>+                    .unwrap();
</span><span style=color:#86b300>+                Ok(ImmediateNested(deferred_nested.get().0.clone()))
</span><span style=color:#86b300>+            }
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+            fn extensions(&self) -> &[&str] {
</span><span style=color:#86b300>+                &["immediate"]
</span><span style=color:#86b300>+            }
</span><span style=color:#86b300>+        }
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+        app.init_asset::&LTTestAsset>()
</span><span style=color:#86b300>+            .init_asset::&LTDeferredNested>()
</span><span style=color:#86b300>+            .init_asset::&LTImmediateNested>()
</span><span style=color:#86b300>+            .register_asset_loader(TrivialLoader)
</span><span style=color:#86b300>+            .register_asset_loader(DeferredNestedLoader)
</span><span style=color:#86b300>+            .register_asset_loader(ImmediateNestedLoader);
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+        dir.insert_asset_text(Path::new("a.immediate"), "b.defer");
</span><span style=color:#86b300>+        dir.insert_asset_text(Path::new("b.defer"), "c.txt");
</span><span style=color:#86b300>+        dir.insert_asset_text(Path::new("c.txt"), "hiya");
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+        let server = app.world().resource::&LTAssetServer>().clone();
</span><span style=color:#86b300>+        let immediate_handle: Handle&LTImmediateNested> = server.load("a.immediate");
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+        run_app_until(&mut app, |world| {
</span><span style=color:#86b300>+            let immediate_assets = world.resource::&LTAssets&LTImmediateNested>>();
</span><span style=color:#86b300>+            let immediate = immediate_assets.get(&immediate_handle)?;
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+            let test_asset_handle = immediate.0.clone();
</span><span style=color:#86b300>+            world
</span><span style=color:#86b300>+                .resource::&LTAssets&LTTestAsset>>()
</span><span style=color:#86b300>+                .get(&test_asset_handle)?;
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+            // The immediate asset is loaded, and the asset it got from its immediate load is also
</span><span style=color:#86b300>+            // loaded.
</span><span style=color:#86b300>+            Some(())
</span><span style=color:#86b300>+        });
</span><span style=color:#86b300>+    }
</span><span> }
</span><span>diff --git a/crates/bevy_asset/src/loader.rs b/crates/bevy_asset/src/loader.rs
</span><span>index a56aab4a05740..cf40e8840ad50 100644
</span><span style=color:#c594c5>--- a/crates/bevy_asset/src/loader.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_asset/src/loader.rs
</span><span style=color:#c594c5>@@ -321,6 +321,10 @@ </span><span style=color:#399ee6>pub enum DeserializeMetaError {
</span><span> /// Any asset state accessed by [`LoadContext`] will be tracked and stored for use in dependency events and asset preprocessing.
</span><span> pub struct LoadContext<'a> {
</span><span>     pub(crate) asset_server: &'a AssetServer,
</span><span style=color:#86b300>+    /// Specifies whether dependencies that are loaded deferred should be loaded.
</span><span style=color:#86b300>+    ///
</span><span style=color:#86b300>+    /// This allows us to skip loads for cases where we're never going to use the asset and we just
</span><span style=color:#86b300>+    /// need the dependency information, for example during asset processing.
</span><span>     pub(crate) should_load_dependencies: bool,
</span><span>     populate_hashes: bool,
</span><span>     asset_path: AssetPath<'static>,
</span><span style=color:#c594c5>@@ -536,7 +540,7 @@ </span><span style=color:#399ee6>impl<'a> LoadContext<'a> {
</span><span>                 meta,
</span><span>                 loader,
</span><span>                 reader,
</span><span style=color:#f07171>-                false,
</span><span style=color:#86b300>+                self.should_load_dependencies,
</span><span>                 self.populate_hashes,
</span><span>             )
</span><span>             .await
</span></code></pre></details></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_21863.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>