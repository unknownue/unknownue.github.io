<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18742 Recompute AABBs
        
    </title><meta content="#18742 Recompute AABBs" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-14</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-18742-zh-cn-20251214>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p><strong>Recompute AABBs</strong><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Recompute AABBs<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18742<li><strong>Author</strong>: aevyrie<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, C-Performance, S-Ready-For-Final-Review, A-Animation<li><strong>Created</strong>: 2025-04-07T02:00:42Z<li><strong>Merged</strong>: 2025-12-14T23:20:44Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Recompute AABBs when meshes change.<li>Optimize sprite AABB re-computation to avoid component insertion where mutation is possible.<li>Fixes #4294 and closes #7971</ul><h2 id=solution>Solution</h2><ul><li>Implement the things.</ul><h2 id=testing>Testing</h2><ul><li>CI</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The core problem this PR addresses is that in Bevy, Axis-Aligned Bounding Boxes (AABBs) for entities were not being updated when their underlying meshes changed. This is a critical issue for visibility culling, as an outdated AABB could cause an entity to be incorrectly culled (not rendered) or force unnecessary rendering when it’s outside the view frustum. The bug reports (#4294, #7971) specifically highlighted cases where animated meshes or sprites would disappear because their AABBs weren’t recomputed after their mesh assets were modified.<p>The initial implementation only computed AABBs for entities that didn’t already have one. If a mesh changed after the initial AABB calculation, the system would never update it. This made dynamic meshes (like those used in animations) problematic because their changing vertex positions required updated bounding volumes.<p>The solution involves two main improvements: First, we need to detect when meshes change and trigger AABB recomputation. Second, we should optimize this process by avoiding expensive component insertion operations when we can simply mutate existing AABB components.<p>Looking at the implementation, the developer made several key changes. In the 3D visibility system (<code>crates/bevy_camera/src/visibility/mod.rs</code>), the <code>calculate_bounds</code> system was split into two distinct queries:<ol><li><strong>New entities without AABBs</strong>: For entities that have a <code>Mesh3d</code> component but no <code>Aabb</code> component, we insert a new AABB component.<li><strong>Existing entities with changed meshes</strong>: For entities that already have an AABB component but whose mesh has changed (detected via <code>AssetChanged&LTMesh3d></code> or <code>Changed&LTMesh3d></code>), we mutate the existing AABB component.</ol><p>This separation is crucial for performance. Inserting components is more expensive than mutating existing ones because it can trigger archetype changes and require moving entities between tables. By using <code>par_iter_mut()</code> with parallel iteration for the update path, the system can efficiently update many AABBs concurrently.<p>A new component <code>NoAutoAabb</code> was introduced to give developers control over this automatic recomputation. This is useful for entities that already have correct AABBs or for performance optimization when you have many entities and want to avoid the table scans that the system performs.<p>The system ordering was also adjusted. The <code>CalculateBounds</code> system now runs after <code>AssetEventSystems</code> to ensure mesh asset changes are processed, and it’s marked as ambiguous with itself to prevent multiple instances from running concurrently. This ensures AABBs are recomputed after mesh changes but before visibility checking.<p>For 2D sprites (<code>crates/bevy_sprite/src/lib.rs</code>), a similar approach was taken but with additional complexity. Sprite AABBs depend on both the <code>Sprite</code> component (which contains size information) and the <code>Anchor</code> component (which affects the AABB center). The system was refactored to:<ol><li>Handle new mesh entities without AABBs (insert component)<li>Handle existing mesh entities with changed meshes (mutate component)<li>Handle new sprite entities without AABBs (insert component)<li>Handle existing sprite entities with changed sprites or anchors (mutate component)</ol><p>The sprite AABB calculation logic was extracted into a helper function <code>sprite_size</code> to avoid code duplication. The queries use <code>Without&LTMesh2d></code> and <code>Without&LTSprite></code> constraints to ensure they’re disjoint and can safely run in parallel without conflicting access to components.<p>One important optimization is the use of <code>set_if_neq()</code> when updating AABB components. This method only updates the component if the new value differs from the current one, avoiding unnecessary change detection triggers and potential downstream system work.<p>The impact of these changes is significant: animated meshes and sprites now maintain correct AABBs throughout their lifecycle, fixing visibility culling for dynamic content. The performance improvements from avoiding component insertion and using parallel iteration make the system scalable for scenes with many dynamic objects. The addition of <code>NoAutoAabb</code> provides an escape hatch for advanced use cases where manual AABB control is needed.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Mesh Changes] --> B{Has Aabb?}
</span><span>    B -->|No| C[Insert Aabb Component]
</span><span>    B -->|Yes| D[Mutate Aabb Component]
</span><span>    
</span><span>    E[Sprite/Anchor Changes] --> F{Has Aabb?}
</span><span>    F -->|No| G[Insert Aabb Component]
</span><span>    F -->|Yes| H[Mutate Aabb Component]
</span><span>    
</span><span>    I[NoAutoAabb Component] --> J[Skip Auto-recomputation]
</span><span>    
</span><span>    C --> K[Visibility Culling]
</span><span>    D --> K
</span><span>    G --> K
</span><span>    H --> K
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=1-crates-bevy-camera-src-visibility-mod-rs-45-9>1. <code>crates/bevy_camera/src/visibility/mod.rs</code> (+45/-9)</h3><p><strong>Purpose</strong>: Fix AABB recomputation for 3D meshes when meshes change.<p>Key changes:<ul><li>Added <code>NoAutoAabb</code> component to disable automatic AABB recomputation<li>Split <code>calculate_bounds</code> system into two queries for new entities and updated entities<li>Added parallel iteration for updating existing AABBs<li>Adjusted system ordering to run after asset events</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Only handled entities without AABB
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>calculate_bounds</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands,
</span><span>    </span><span style=color:#ff8f40>meshes</span><span style=color:#61676ccc>: </span><span>Res&LTAssets&LTMesh>>,
</span><span>    </span><span style=color:#ff8f40>without_aabb</span><span style=color:#61676ccc>: </span><span>Query<(Entity, </span><span style=color:#ed9366>&</span><span>Mesh3d), (Without&LTAabb>, Without&LTNoFrustumCulling>)>,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>for </span><span>(entity</span><span style=color:#61676ccc>,</span><span> mesh_handle) </span><span style=color:#ed9366>in &</span><span>without_aabb {
</span><span>        </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(mesh) </span><span style=color:#ed9366>=</span><span> meshes</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(mesh_handle)
</span><span>            </span><span style=color:#ed9366>&& </span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(aabb) </span><span style=color:#ed9366>=</span><span> mesh</span><span style=color:#ed9366>.</span><span style=color:#f07171>compute_aabb</span><span>()
</span><span>        {
</span><span>            commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(entity)</span><span style=color:#ed9366>.</span><span style=color:#f07171>try_insert</span><span>(aabb)</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Handles both new entities and updates to existing ones
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>calculate_bounds</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands,
</span><span>    </span><span style=color:#ff8f40>meshes</span><span style=color:#61676ccc>: </span><span>Res&LTAssets&LTMesh>>,
</span><span>    </span><span style=color:#ff8f40>new_aabb</span><span style=color:#61676ccc>: </span><span>Query<
</span><span>        (Entity, </span><span style=color:#ed9366>&</span><span>Mesh3d),
</span><span>        (
</span><span>            Without&LTAabb>,
</span><span>            Without&LTNoFrustumCulling>,
</span><span>            Without&LTNoAutoAabb>,
</span><span>        ),
</span><span>    >,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>update_aabb</span><span style=color:#61676ccc>: </span><span>Query<
</span><span>        (</span><span style=color:#ed9366>&</span><span>Mesh3d, </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> Aabb),
</span><span>        (
</span><span>            Or<(AssetChanged&LTMesh3d>, Changed&LTMesh3d>)>,
</span><span>            Without&LTNoFrustumCulling>,
</span><span>            Without&LTNoAutoAabb>,
</span><span>        ),
</span><span>    >,
</span><span>) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Insert AABB for new entities
</span><span>    </span><span style=color:#fa6e32>for </span><span>(entity</span><span style=color:#61676ccc>,</span><span> mesh_handle) </span><span style=color:#ed9366>in &</span><span>new_aabb {
</span><span>        </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(mesh) </span><span style=color:#ed9366>=</span><span> meshes</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(mesh_handle)
</span><span>            </span><span style=color:#ed9366>&& </span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(aabb) </span><span style=color:#ed9366>=</span><span> mesh</span><span style=color:#ed9366>.</span><span style=color:#f07171>compute_aabb</span><span>()
</span><span>        {
</span><span>            commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(entity)</span><span style=color:#ed9366>.</span><span style=color:#f07171>try_insert</span><span>(aabb)</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>    }
</span><span>    
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Update AABB for existing entities with changed meshes
</span><span>    update_aabb
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>par_iter_mut</span><span>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>for_each</span><span>(|(</span><span style=color:#ff8f40>mesh_handle</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>mut old_aabb</span><span>)| {
</span><span>            </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(aabb) </span><span style=color:#ed9366>=</span><span> meshes</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(mesh_handle)</span><span style=color:#ed9366>.</span><span style=color:#f07171>and_then</span><span>(MeshAabb</span><span style=color:#ed9366>::</span><span>compute_aabb) {
</span><span>                </span><span style=color:#ed9366>*</span><span>old_aabb </span><span style=color:#ed9366>=</span><span> aabb</span><span style=color:#61676ccc>;
</span><span>            }
</span><span>        })</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=2-crates-bevy-sprite-src-lib-rs-72-14>2. <code>crates/bevy_sprite/src/lib.rs</code> (+72/-14)</h3><p><strong>Purpose</strong>: Fix AABB recomputation for 2D sprites and meshes when they change.<p>Key changes:<ul><li>Split sprite AABB calculation into separate paths for new and updated entities<li>Added helper function to compute sprite size from various sources (custom_size, rect, atlas)<li>Used parallel iteration for updating existing AABB components<li>Added <code>set_if_neq()</code> to avoid unnecessary updates</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Sprite size calculation helper (extracted for reuse)
</span><span style=color:#fa6e32>let </span><span style=color:#f29718>sprite_size </span><span style=color:#ed9366>= </span><span>|</span><span style=color:#ff8f40>sprite</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>Sprite| </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTVec2> {
</span><span>    sprite
</span><span>        </span><span style=color:#ed9366>.</span><span>custom_size
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>or_else</span><span>(|| sprite</span><span style=color:#ed9366>.</span><span>rect</span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|</span><span style=color:#ff8f40>rect</span><span>| rect</span><span style=color:#ed9366>.</span><span style=color:#f07171>size</span><span>()))
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>or_else</span><span>(|| </span><span style=color:#fa6e32>match </span><span style=color:#ed9366>&</span><span>sprite</span><span style=color:#ed9366>.</span><span>texture_atlas {
</span><span>            </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(atlas) </span><span style=color:#ed9366>=> </span><span>{
</span><span>                atlases
</span><span>                    </span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#ed9366>&</span><span>atlas</span><span style=color:#ed9366>.</span><span>layout)
</span><span>                    </span><span style=color:#ed9366>.</span><span style=color:#f07171>and_then</span><span>(|</span><span style=color:#ff8f40>layout</span><span>| layout</span><span style=color:#ed9366>.</span><span>textures</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(atlas</span><span style=color:#ed9366>.</span><span>index </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>usize</span><span>))
</span><span>                    </span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|</span><span style=color:#ff8f40>rect</span><span>| rect</span><span style=color:#ed9366>.</span><span style=color:#f07171>size</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_vec2</span><span>())
</span><span>            }
</span><span>            </span><span style=color:#55b4d4;font-style:italic>None </span><span style=color:#ed9366>=></span><span> images
</span><span>                </span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#ed9366>&</span><span>sprite</span><span style=color:#ed9366>.</span><span>image)
</span><span>                </span><span style=color:#ed9366>.</span><span style=color:#f07171>and_then</span><span>(|</span><span style=color:#ff8f40>image</span><span>| image</span><span style=color:#ed9366>.</span><span>texture_descriptor</span><span style=color:#ed9366>.</span><span>size</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_vec2</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>try_into</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>ok</span><span>())
</span><span>                </span><span style=color:#ed9366>.</span><span style=color:#f07171>and_then</span><span>(|</span><span style=color:#ff8f40>size</span><span style=color:#61676ccc>:</span><span> Vec2| {
</span><span>                    sprite
</span><span>                        </span><span style=color:#ed9366>.</span><span>rect
</span><span>                        </span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|</span><span style=color:#ff8f40>rect</span><span>| rect</span><span style=color:#ed9366>.</span><span style=color:#f07171>size</span><span>())
</span><span>                        </span><span style=color:#ed9366>.</span><span style=color:#f07171>or</span><span>(</span><span style=color:#55b4d4;font-style:italic>Some</span><span>(size))
</span><span>                })</span><span style=color:#61676ccc>,
</span><span>        })
</span><span>}</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// New sprites require inserting a component
</span><span style=color:#fa6e32>for </span><span>(size</span><span style=color:#61676ccc>, </span><span>(entity</span><span style=color:#61676ccc>,</span><span> anchor)) </span><span style=color:#ed9366>in</span><span> new_sprite_aabb
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>filter_map</span><span>(|(</span><span style=color:#ff8f40>entity</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>sprite</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>anchor</span><span>)| </span><span style=color:#f07171>sprite_size</span><span>(sprite)</span><span style=color:#ed9366>.</span><span style=color:#f07171>zip</span><span>(</span><span style=color:#55b4d4;font-style:italic>Some</span><span>((entity</span><span style=color:#61676ccc>,</span><span> anchor))))
</span><span>{
</span><span>    </span><span style=color:#fa6e32>let</span><span> aabb </span><span style=color:#ed9366>=</span><span> Aabb {
</span><span>        center</span><span style=color:#61676ccc>: </span><span>(</span><span style=color:#ed9366>-</span><span>anchor</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_vec</span><span>() </span><span style=color:#ed9366>*</span><span> size)</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend</span><span>(</span><span style=color:#ff8f40>0.0</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()</span><span style=color:#61676ccc>,
</span><span>        half_extents</span><span style=color:#61676ccc>: </span><span>(</span><span style=color:#ff8f40>0.5 </span><span style=color:#ed9366>*</span><span> size)</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend</span><span>(</span><span style=color:#ff8f40>0.0</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()</span><span style=color:#61676ccc>,
</span><span>    }</span><span style=color:#61676ccc>;
</span><span>    commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(entity)</span><span style=color:#ed9366>.</span><span style=color:#f07171>try_insert</span><span>(aabb)</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Updated sprites can take the fast path with parallel component mutation
</span><span>update_sprite_aabb
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>par_iter_mut</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>for_each</span><span>(|(</span><span style=color:#ff8f40>sprite</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>mut aabb</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>anchor</span><span>)| {
</span><span>        </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(size) </span><span style=color:#ed9366>= </span><span style=color:#f07171>sprite_size</span><span>(sprite) {
</span><span>            aabb</span><span style=color:#ed9366>.</span><span style=color:#f07171>set_if_neq</span><span>(Aabb {
</span><span>                center</span><span style=color:#61676ccc>: </span><span>(</span><span style=color:#ed9366>-</span><span>anchor</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_vec</span><span>() </span><span style=color:#ed9366>*</span><span> size)</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend</span><span>(</span><span style=color:#ff8f40>0.0</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()</span><span style=color:#61676ccc>,
</span><span>                half_extents</span><span style=color:#61676ccc>: </span><span>(</span><span style=color:#ff8f40>0.5 </span><span style=color:#ed9366>*</span><span> size)</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend</span><span>(</span><span style=color:#ff8f40>0.0</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()</span><span style=color:#61676ccc>,
</span><span>            })</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>    })</span><span style=color:#61676ccc>;
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><strong>Bevy ECS Change Detection</strong>: Understanding how <code>Changed&LTT></code>, <code>AssetChanged&LTT></code>, and <code>set_if_neq()</code> work is crucial for optimizing systems that respond to component changes.<li><strong>Parallel Iteration in Bevy</strong>: The <code>par_iter_mut()</code> method enables parallel processing of entities, which can significantly improve performance for systems that process many entities.<li><strong>Frustum Culling</strong>: Learn how AABBs are used in visibility determination to understand why correct AABB computation is essential for rendering performance.<li><strong>Bevy System Ordering</strong>: The PR adjusts system sets and ordering constraints, which is important for ensuring systems run in the correct sequence.<li><strong>Component Insertion vs Mutation</strong>: The performance difference between inserting new components and mutating existing ones is a key consideration in ECS design.</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_18742.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>