<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21249 Add optimized is_in_half_space_identity, contains_aabb_identity, and intersects_obb_identity
        
    </title><meta content="#21249 Add optimized is_in_half_space_identity, contains_aabb_identity, and intersects_obb_identity" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-08</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-21249-zh-cn-20251208>中文</a></div></div><div class=pr-content><h1 id=title-add-optimized-is-in-half-space-identity-contains-aabb-identity-and-intersects-obb-identity>Title: Add optimized is_in_half_space_identity, contains_aabb_identity, and intersects_obb_identity</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Add optimized is_in_half_space_identity, contains_aabb_identity, and intersects_obb_identity<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21249<li><strong>Author</strong>: Saratii<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Feature, C-Performance, S-Ready-For-Final-Review, A-Math, D-Straightforward<li><strong>Created</strong>: 2025-09-28T04:11:29Z<li><strong>Merged</strong>: 2025-12-08T23:15:50Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>This adds an optimized version of is_in_half_space, <code>Frustum::contains_aabb_identity</code>, <code>Aabb::is_in_half_space_identity</code>, and <code>Frustum::intersects_obb_identity</code> that takes advantage of how calling with IDENTITY (common) reduces the amount of matrix multiplications.<h2 id=solution>Solution</h2><p>Add a specialized function without touching the original that assumes Identity was passed to simplify math.<h2 id=testing>Testing</h2><p>I use this function extensively in my own project. I asserted the old function called with identity always returns the same as my new function. I bench marked and profiled the usage in my real application and noticed a 16% speed up on Linux and 20% on windows for contains_aabb. I bench marked intersects_obb_identity and noticed a 39% increase on linux and 38% on windows. Both functions have unit tests that assert calling with identity yields the same result in both versions.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a performance optimization opportunity in Bevy’s frustum culling system. The core insight is straightforward: when checking whether bounding volumes are inside or intersect with a camera frustum, the code frequently deals with objects that are already in world space. In these cases, the transform matrix passed to the functions is <code>Affine3A::IDENTITY</code>, but the existing implementations still perform the full matrix multiplication operations.<p>The problem manifests in performance-critical rendering operations, particularly during frustum culling where these functions are called for every object in a scene. Even though identity matrix multiplication is relatively cheap, eliminating it entirely provides measurable performance gains by reducing computational overhead in hot code paths.<p>The developer took a conservative approach to solving this problem by creating specialized versions of the functions rather than modifying the existing ones. This design decision preserves backward compatibility and API stability while providing performance improvements. The new functions are named with <code>_identity</code> suffixes to clearly indicate their purpose and constraints.<p>Looking at the implementation, the optimizations are mathematically sound. For <code>Aabb::is_in_half_space_identity</code>, the function eliminates the matrix transformation of the AABB center from local to world space since the AABB is already in world space. The optimization reduces the operation from:<ol><li>Transforming the AABB center: <code>world_from_local.transform_point3a(aabb.center)</code><li>Performing dot product with the half-space normal</ol><p>To just performing the dot product directly with the AABB center. This saves one 3x4 affine matrix multiplication per call.<p>Similarly, <code>Frustum::contains_aabb_identity</code> leverages the optimized <code>is_in_half_space_identity</code> method for each half-space check, providing a compound optimization when checking against all six frustum planes.<p>The most significant optimization comes in <code>Frustum::intersects_obb_identity</code>, which handles the common case of oriented bounding box intersection testing where both <code>intersect_near</code> and <code>intersect_far</code> parameters are <code>true</code>. The optimization eliminates:<ol><li>The full 4x4 matrix multiplication to transform the AABB center to homogeneous coordinates<li>The conditional logic for handling near and far plane checks<li>The matrix multiplication for non-identity transforms</ol><p>The code implementation shows careful attention to detail. Each optimized function is marked with <code>#[inline]</code> to ensure they can be optimized away by the compiler when appropriate. The documentation clearly states when each function should be used, preventing misuse of the specialized functions.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>/// Optimized version of [`Self::is_in_half_space`] when the AABB is already in world space.
</span><span style=color:#abb0b6;font-style:italic>/// Use this when `world_from_local` would be the identity transform.
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>inline</span><span>]
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>is_in_half_space_identity</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>half_space</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>HalfSpace) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>bool </span><span>{
</span><span>    </span><span style=color:#fa6e32>let</span><span> p_normal </span><span style=color:#ed9366>=</span><span> half_space</span><span style=color:#ed9366>.</span><span style=color:#f07171>normal</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> r </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>half_extents</span><span style=color:#ed9366>.</span><span style=color:#f07171>abs</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>dot</span><span>(p_normal</span><span style=color:#ed9366>.</span><span style=color:#f07171>abs</span><span>())</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> signed_distance </span><span style=color:#ed9366>=</span><span> p_normal</span><span style=color:#ed9366>.</span><span style=color:#f07171>dot</span><span>(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>center) </span><span style=color:#ed9366>+</span><span> half_space</span><span style=color:#ed9366>.</span><span style=color:#f07171>d</span><span>()</span><span style=color:#61676ccc>;
</span><span>    signed_distance </span><span style=color:#ed9366>></span><span> r
</span><span>}
</span></code></pre><p>The testing strategy is robust. The developer implemented comprehensive unit tests that verify the optimized functions produce identical results to their general counterparts when called with identity transforms. This validation approach ensures mathematical correctness while providing performance benefits.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>test_identity_optimized_equivalence</span><span>() {
</span><span>    </span><span style=color:#fa6e32>let</span><span> cases </span><span style=color:#ed9366>= </span><span style=color:#f07171>vec!</span><span>[
</span><span>        (
</span><span>            Aabb {
</span><span>                center</span><span style=color:#61676ccc>: </span><span>Vec3A</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ZERO</span><span style=color:#61676ccc>,
</span><span>                half_extents</span><span style=color:#61676ccc>: </span><span>Vec3A</span><span style=color:#ed9366>::</span><span>splat(</span><span style=color:#ff8f40>1.0</span><span>)</span><span style=color:#61676ccc>,
</span><span>            }</span><span style=color:#61676ccc>,
</span><span>            HalfSpace</span><span style=color:#ed9366>::</span><span>new(Vec4</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ff8f40>1.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.0</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>-</span><span style=color:#ff8f40>0.5</span><span>))</span><span style=color:#61676ccc>,
</span><span>        )</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ... more test cases
</span><span>    ]</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>for </span><span>(aabb</span><span style=color:#61676ccc>,</span><span> half_space) </span><span style=color:#ed9366>in</span><span> cases {
</span><span>        </span><span style=color:#fa6e32>let</span><span> general </span><span style=color:#ed9366>=</span><span> aabb</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_in_half_space</span><span>(</span><span style=color:#ed9366>&</span><span>half_space</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>Affine3A</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>IDENTITY</span><span>)</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#fa6e32>let</span><span> identity </span><span style=color:#ed9366>=</span><span> aabb</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_in_half_space_identity</span><span>(</span><span style=color:#ed9366>&</span><span>half_space)</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#f07171>assert_eq!</span><span>(general</span><span style=color:#61676ccc>,</span><span> identity</span><span style=color:#61676ccc>,</span><span>)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><p>The performance improvements reported—16-20% for <code>contains_aabb</code> and 38-39% for <code>intersects_obb</code>—are substantial for a rendering engine where these operations occur thousands of times per frame. These gains come from eliminating redundant matrix operations that, while individually small, accumulate significantly in tight loops.<p>The impact of this change extends beyond just the immediate performance improvements. By providing specialized identity versions, the PR establishes a pattern for future optimizations in Bevy’s math and geometry code. It demonstrates how common-case optimizations can be implemented without compromising API clarity or correctness.<p>One technical consideration is that callers must now choose between the general and optimized functions based on whether their data is already in world space. This adds a small cognitive burden but provides clear performance benefits. The naming convention (<code>_identity</code>) makes the choice explicit and self-documenting.<p>The implementation follows good software engineering practices: it’s minimal, focused, and doesn’t introduce unnecessary complexity. The changes are isolated to a single file, making the PR easy to review and understand. The addition of thorough tests ensures the optimizations don’t introduce regressions.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Frustum Culling Operations] --> B[General Case Functions]
</span><span>    A --> C[Identity-Optimized Functions]
</span><span>    
</span><span>    B --> D[is_in_half_space]
</span><span>    B --> E[contains_aabb]
</span><span>    B --> F[intersects_obb]
</span><span>    
</span><span>    C --> G[is_in_half_space_identity]
</span><span>    C --> H[contains_aabb_identity]
</span><span>    C --> I[intersects_obb_identity]
</span><span>    
</span><span>    D -->|Uses| J[Matrix Transformations]
</span><span>    E -->|Uses| J
</span><span>    F -->|Uses| J
</span><span>    
</span><span>    G -->|Skips| J
</span><span>    H -->|Skips| J
</span><span>    I -->|Skips| J
</span><span>    
</span><span>    style C fill:#ccf
</span><span>    style G fill:#cfc
</span><span>    style H fill:#cfc
</span><span>    style I fill:#cfc
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-camera-src-primitives-rs-96-1><code>crates/bevy_camera/src/primitives.rs</code> (+96/-1)</h3><p>This file contains geometric primitives used for camera frustum culling. The changes add three new optimized methods for the common case where transforms are identity.<ol><li><strong><code>Aabb::is_in_half_space_identity</code></strong>: Optimized version that skips matrix transformation when AABB is already in world space.</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before (indirect usage through existing functions):
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>is_in_half_space</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>half_space</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>HalfSpace, </span><span style=color:#ff8f40>world_from_local</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>Affine3A) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>bool </span><span>{
</span><span>    </span><span style=color:#fa6e32>let</span><span> p_normal </span><span style=color:#ed9366>=</span><span> half_space</span><span style=color:#ed9366>.</span><span style=color:#f07171>normal</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> aabb_center_world </span><span style=color:#ed9366>=</span><span> world_from_local</span><span style=color:#ed9366>.</span><span style=color:#f07171>transform_point3a</span><span>(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>center)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> r </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>half_extents</span><span style=color:#ed9366>.</span><span style=color:#f07171>abs</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>dot</span><span>(p_normal</span><span style=color:#ed9366>.</span><span style=color:#f07171>abs</span><span>())</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> signed_distance </span><span style=color:#ed9366>=</span><span> p_normal</span><span style=color:#ed9366>.</span><span style=color:#f07171>dot</span><span>(aabb_center_world) </span><span style=color:#ed9366>+</span><span> half_space</span><span style=color:#ed9366>.</span><span style=color:#f07171>d</span><span>()</span><span style=color:#61676ccc>;
</span><span>    signed_distance </span><span style=color:#ed9366>></span><span> r
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After (new optimized function):
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>inline</span><span>]
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>is_in_half_space_identity</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>half_space</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>HalfSpace) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>bool </span><span>{
</span><span>    </span><span style=color:#fa6e32>let</span><span> p_normal </span><span style=color:#ed9366>=</span><span> half_space</span><span style=color:#ed9366>.</span><span style=color:#f07171>normal</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> r </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>half_extents</span><span style=color:#ed9366>.</span><span style=color:#f07171>abs</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>dot</span><span>(p_normal</span><span style=color:#ed9366>.</span><span style=color:#f07171>abs</span><span>())</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> signed_distance </span><span style=color:#ed9366>=</span><span> p_normal</span><span style=color:#ed9366>.</span><span style=color:#f07171>dot</span><span>(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>center) </span><span style=color:#ed9366>+</span><span> half_space</span><span style=color:#ed9366>.</span><span style=color:#f07171>d</span><span>()</span><span style=color:#61676ccc>;
</span><span>    signed_distance </span><span style=color:#ed9366>></span><span> r
</span><span>}
</span></code></pre><ol start=2><li><strong><code>Frustum::intersects_obb_identity</code></strong>: Optimized version for OBB intersection testing with identity transform and both intersect_near/intersect_far set to true.</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// New function:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>inline</span><span>]
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>intersects_obb_identity</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>aabb</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>Aabb) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>bool </span><span>{
</span><span>    </span><span style=color:#fa6e32>let</span><span> aabb_center_world </span><span style=color:#ed9366>=</span><span> aabb</span><span style=color:#ed9366>.</span><span>center</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend</span><span>(</span><span style=color:#ff8f40>1.0</span><span>)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>for</span><span> half_space </span><span style=color:#ed9366>in </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>half_spaces</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>() {
</span><span>        </span><span style=color:#fa6e32>let</span><span> p_normal </span><span style=color:#ed9366>=</span><span> half_space</span><span style=color:#ed9366>.</span><span style=color:#f07171>normal</span><span>()</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#fa6e32>let</span><span> relative_radius </span><span style=color:#ed9366>=</span><span> aabb</span><span style=color:#ed9366>.</span><span>half_extents</span><span style=color:#ed9366>.</span><span style=color:#f07171>abs</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>dot</span><span>(p_normal</span><span style=color:#ed9366>.</span><span style=color:#f07171>abs</span><span>())</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#fa6e32>if</span><span> half_space</span><span style=color:#ed9366>.</span><span style=color:#f07171>normal_d</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>dot</span><span>(aabb_center_world) </span><span style=color:#ed9366>+</span><span> relative_radius </span><span style=color:#ed9366><= </span><span style=color:#ff8f40>0.0 </span><span>{
</span><span>            </span><span style=color:#fa6e32>return </span><span style=color:#ff8f40>false</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>    }
</span><span>    </span><span style=color:#ff8f40>true
</span><span>}
</span></code></pre><ol start=3><li><strong><code>Frustum::contains_aabb_identity</code></strong>: Optimized version that uses the new <code>is_in_half_space_identity</code> method.</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// New function:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>inline</span><span>]
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>contains_aabb_identity</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>aabb</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>Aabb) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>bool </span><span>{
</span><span>    </span><span style=color:#fa6e32>for</span><span> half_space </span><span style=color:#ed9366>in &</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>half_spaces {
</span><span>        </span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>aabb</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_in_half_space_identity</span><span>(half_space) {
</span><span>            </span><span style=color:#fa6e32>return </span><span style=color:#ff8f40>false</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>    }
</span><span>    </span><span style=color:#ff8f40>true
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><p><strong>Frustum Culling Fundamentals</strong>: The PR description references <a rel="noopener nofollow noreferrer" href=https://learnopengl.com/Guest-Articles/2021/Scene/Frustum-Culling target=_blank>Frustum Culling</a> which provides a comprehensive explanation of the mathematics behind frustum culling.</p><li><p><strong>Bevy’s Math Library</strong>: Understanding <code>Affine3A</code>, <code>Vec3A</code>, and <code>HalfSpace</code> types in Bevy’s math library would help contextualize these optimizations.</p><li><p><strong>Common Subexpression Elimination</strong>: This optimization pattern relates to compiler optimization techniques where frequently computed expressions are cached or eliminated.</p><li><p><strong>Branch Prediction and Hot Paths</strong>: The performance improvements demonstrate the importance of optimizing frequently executed code paths, particularly in game engines where rendering operations are performance-critical.</p><li><p><strong>SIMD Optimizations in Game Engines</strong>: While not directly related to this PR, understanding how modern game engines use SIMD (Single Instruction, Multiple Data) operations for geometric calculations provides additional context for performance optimization in rendering systems.</p></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_21249.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>