<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22125 Fix compilation errors and warnings when running bevy_gltf with no features.
        
    </title><meta content="#22125 Fix compilation errors and warnings when running bevy_gltf with no features." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-15</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22125-zh-cn-20251215>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix compilation errors and warnings when running bevy_gltf with no features.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22125<li><strong>Author</strong>: andriyDev<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, D-Trivial, S-Needs-Review, A-glTF<li><strong>Created</strong>: 2025-12-15T07:20:25Z<li><strong>Merged</strong>: 2025-12-15T09:01:42Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>#22106 accidentally added imports for AnimationClip, HashMap, and HashSet - but these are only available/used if the bevy_animation feature is enabled. So running <code>cargo t -p bevy_gltf</code> fails to compile and gives warnings!</ul><h2 id=solution>Solution</h2><ul><li>Guard these <code>use</code> statements on the bevy_animation feature.</ul><h2 id=testing>Testing</h2><ul><li>Ran <code>cargo t -p bevy_gltf</code>.<li>Ran <code>cargo t -p bevy_gltf --all-features</code>.</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This pull request addresses a straightforward but important compilation issue in the Bevy glTF loader. The problem originated from PR #22106, which introduced unconditional imports for types that are only available when the <code>bevy_animation</code> feature is enabled. Specifically, it added imports for <code>AnimationClip</code>, <code>HashMap</code>, and <code>HashSet</code> without proper feature gating.<p>The issue manifested when developers ran tests for the <code>bevy_gltf</code> crate without the animation feature enabled. Running <code>cargo t -p bevy_gltf</code> would fail to compile and produce warnings because the compiler couldn’t find these types in the current feature configuration. This is a classic conditional compilation problem in Rust projects with optional features - importing types that don’t exist in the current feature set breaks compilation.<p>The solution approach was clean and minimal: wrap the problematic imports with <code>#[cfg(feature = "bevy_animation")]</code> attribute. This Rust conditional compilation directive ensures the imports are only included when the specified feature is enabled. The implementation moved the three imports into a single conditional block, which is more maintainable than scattering individual <code>#[cfg]</code> attributes.<p>From a technical perspective, this fix demonstrates proper feature management in Rust crates. Bevy uses a modular feature system where different components (like animation, rendering, UI) can be enabled or disabled. When a module imports types from another module that’s behind a feature flag, those imports must be similarly guarded. The error occurred because PR #22106 added the imports but didn’t consider that <code>bevy_animation</code> might not be available.<p>The impact of this fix is immediate: it restores the ability to compile and test <code>bevy_gltf</code> with minimal feature sets. This is important for several reasons. First, it maintains compatibility with workflows that don’t require animation functionality. Second, it ensures CI/CD pipelines that test different feature combinations continue to work. Third, it prevents downstream users from encountering unexpected compilation errors when they use <code>bevy_gltf</code> without animation features.<p>The fix also shows good Rust practice by grouping related conditional imports together using the <code>use { ... }</code> syntax with the <code>#[cfg]</code> attribute applied to the entire block. This is cleaner than applying the attribute to each import individually and makes the dependency relationships clearer.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[PR #22106] -->|Adds unconditional imports| B[bevy_gltf mod.rs]
</span><span>    B -->|Imports AnimationClip, HashMap, HashSet| C[bevy_animation feature]
</span><span>    C -->|Only available when enabled| D[Compilation Failure]
</span><span>    E[PR #22125] -->|Adds feature guards| F[Conditional Imports]
</span><span>    F -->|Imports only with bevy_animation| G[Successful Compilation]
</span><span>    
</span><span>    style A fill:#f9f,stroke:#333
</span><span>    style E fill:#9f9,stroke:#333
</span><span>    style D fill:#f99,stroke:#333
</span><span>    style G fill:#9f9,stroke:#333
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-gltf-src-loader-extensions-mod-rs-6-2><code>crates/bevy_gltf/src/loader/extensions/mod.rs</code> (+6/-2)</h3><p>This file contains the module declarations and imports for glTF loader extensions. The changes fix conditional compilation by properly guarding imports behind the <code>bevy_animation</code> feature flag.<p><strong>Before the change:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>use </span><span>alloc</span><span style=color:#ed9366>::</span><span>sync</span><span style=color:#ed9366>::</span><span>Arc</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>use </span><span>async_lock</span><span style=color:#ed9366>::</span><span>RwLock</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>use </span><span>bevy_animation</span><span style=color:#ed9366>::</span><span>AnimationClip</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>use </span><span>bevy_asset</span><span style=color:#ed9366>::</span><span>{Handle</span><span style=color:#61676ccc>,</span><span> LoadContext}</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>use </span><span>bevy_ecs</span><span style=color:#ed9366>::</span><span>{
</span><span>    entity</span><span style=color:#ed9366>::</span><span>Entity</span><span style=color:#61676ccc>,
</span><span>    prelude</span><span style=color:#ed9366>::</span><span>Component</span><span style=color:#61676ccc>,
</span><span>    world</span><span style=color:#ed9366>::</span><span>{EntityWorldMut</span><span style=color:#61676ccc>,</span><span> World}</span><span style=color:#61676ccc>,
</span><span>}</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>use </span><span>bevy_pbr</span><span style=color:#ed9366>::</span><span>StandardMaterial</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>use </span><span>bevy_platform</span><span style=color:#ed9366>::</span><span>collections</span><span style=color:#ed9366>::</span><span>{HashMap</span><span style=color:#61676ccc>,</span><span> HashSet}</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>use </span><span>gltf</span><span style=color:#ed9366>::</span><span>Node</span><span style=color:#61676ccc>;
</span></code></pre><p><strong>After the change:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>use </span><span>alloc</span><span style=color:#ed9366>::</span><span>sync</span><span style=color:#ed9366>::</span><span>Arc</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>use </span><span>async_lock</span><span style=color:#ed9366>::</span><span>RwLock</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>use </span><span>bevy_asset</span><span style=color:#ed9366>::</span><span>{Handle</span><span style=color:#61676ccc>,</span><span> LoadContext}</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>use </span><span>bevy_ecs</span><span style=color:#ed9366>::</span><span>{
</span><span>    entity</span><span style=color:#ed9366>::</span><span>Entity</span><span style=color:#61676ccc>,
</span><span>    prelude</span><span style=color:#ed9366>::</span><span>Component</span><span style=color:#61676ccc>,
</span><span>    world</span><span style=color:#ed9366>::</span><span>{EntityWorldMut</span><span style=color:#61676ccc>,</span><span> World}</span><span style=color:#61676ccc>,
</span><span>}</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>use </span><span>bevy_pbr</span><span style=color:#ed9366>::</span><span>StandardMaterial</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>use </span><span>gltf</span><span style=color:#ed9366>::</span><span>Node</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"bevy_animation"</span><span>)]
</span><span style=color:#fa6e32>use </span><span>{
</span><span>    bevy_animation</span><span style=color:#ed9366>::</span><span>AnimationClip</span><span style=color:#61676ccc>,
</span><span>    bevy_platform</span><span style=color:#ed9366>::</span><span>collections</span><span style=color:#ed9366>::</span><span>{HashMap</span><span style=color:#61676ccc>,</span><span> HashSet}</span><span style=color:#61676ccc>,
</span><span>}</span><span style=color:#61676ccc>;
</span></code></pre><p>The changes:<ol><li>Removed the unconditional imports of <code>bevy_animation::AnimationClip</code> and <code>bevy_platform::collections::{HashMap, HashSet}</code><li>Added a conditional import block that only includes these imports when the <code>bevy_animation</code> feature is enabled<li>Used Rust’s grouped import syntax within the conditional block for cleaner code</ol><p>These changes ensure that when <code>bevy_gltf</code> is compiled without the <code>bevy_animation</code> feature, the compiler won’t try to resolve imports for types that don’t exist in that configuration. The rest of the code that uses these types is presumably already guarded by the same feature flag, making this a complete fix.<h2 id=further-reading>Further Reading</h2><ol><li><strong>Rust Conditional Compilation</strong>: The Rust Reference chapter on conditional compilation explains <code>#[cfg]</code> attributes and feature-based compilation: https://doc.rust-lang.org/reference/conditional-compilation.html<li><strong>Cargo Features</strong>: The Cargo Book section on features explains how to define and use features in Rust projects: https://doc.rust-lang.org/cargo/reference/features.html<li><strong>Bevy’s Feature System</strong>: Bevy’s architecture uses features extensively to allow users to include only the components they need. The Bevy Book covers this in the “Features” section.<li><strong>Previous PR #22106</strong>: Understanding the changes that introduced this bug provides context for why feature guards are necessary when adding new dependencies between Bevy modules.</ol><h1 id=full-code-diff>Full Code Diff</h1><pre style=color:#61676c;background-color:#fafafa><code><span>diff --git a/crates/bevy_gltf/src/loader/extensions/mod.rs b/crates/bevy_gltf/src/loader/extensions/mod.rs
</span><span>index 133420881a9cf..d024f39175c94 100644
</span><span>--- a/crates/bevy_gltf/src/loader/extensions/mod.rs
</span><span>+++ b/crates/bevy_gltf/src/loader/extensions/mod.rs
</span><span>@@ -7,7 +7,6 @@ mod khr_materials_specular;
</span><span> use alloc::sync::Arc;
</span><span> use async_lock::RwLock;
</span><span> 
</span><span>-use bevy_animation::AnimationClip;
</span><span> use bevy_asset::{Handle, LoadContext};
</span><span> use bevy_ecs::{
</span><span>     entity::Entity,
</span><span>@@ -15,9 +14,14 @@ use bevy_ecs::{
</span><span>     world::{EntityWorldMut, World},
</span><span> };
</span><span> use bevy_pbr::StandardMaterial;
</span><span>-use bevy_platform::collections::{HashMap, HashSet};
</span><span> use gltf::Node;
</span><span> 
</span><span>+#[cfg(feature = "bevy_animation")]
</span><span>+use {
</span><span>+    bevy_animation::AnimationClip,
</span><span>+    bevy_platform::collections::{HashMap, HashSet},
</span><span>+};
</span><span>+
</span><span> use crate::GltfMesh;
</span><span> 
</span><span> pub(crate) use self::{
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22125.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>