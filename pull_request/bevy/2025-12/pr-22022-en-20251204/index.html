<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22022 Ignore text buffer metrics
        
    </title><meta content="#22022 Ignore text buffer metrics" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-04</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22022-zh-cn-20251204>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=ignore-text-buffer-metrics>Ignore text buffer metrics</h2><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Ignore text buffer metrics<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22022<li><strong>Author</strong>: ickshonpe<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Performance, C-Code-Quality, A-Text, D-Straightforward, S-Needs-Review<li><strong>Created</strong>: 2025-12-03T13:39:37Z<li><strong>Merged</strong>: 2025-12-04T02:57:54Z<li><strong>Merged By</strong>: cart</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Since we set explicit font size and line height attributes for every text section, the <code>Metrics</code> values passed to the text buffer don’t matter. We can just initialize the buffer with some dummy value and then ignore it.<h2 id=solution>Solution</h2><ul><li>Initialize the text buffer to some dummy values.<li>Remove the code that collects and sets the metrics during text updates.</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a performance optimization opportunity in Bevy’s text rendering system. The core issue was that the text pipeline was performing unnecessary calculations for metrics that weren’t actually being used in the final rendering output.<p>The problem stemmed from how the text pipeline interacted with the underlying <code>cosmic-text</code> library. In the original implementation, the code was collecting font metrics (maximum font size and line height) across all text spans, then using these values to configure the text buffer’s metrics. However, this calculation was redundant because each text section already has explicitly defined font size and line height attributes that the text renderer uses directly.<p>Here’s what the original code was doing in <code>pipeline.rs</code>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let mut</span><span> max_font_size</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32 </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0.</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let mut</span><span> max_line_height</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32 </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0.0</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// ... collecting spans and calculating max values
</span><span>
</span><span style=color:#fa6e32>let mut</span><span> metrics </span><span style=color:#ed9366>= </span><span>Metrics</span><span style=color:#ed9366>::</span><span>new(max_font_size</span><span style=color:#61676ccc>,</span><span> max_line_height)</span><span style=color:#ed9366>.</span><span style=color:#f07171>scale</span><span>(scale_factor </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32</span><span>)</span><span style=color:#61676ccc>;
</span><span>metrics</span><span style=color:#ed9366>.</span><span>font_size </span><span style=color:#ed9366>=</span><span> metrics</span><span style=color:#ed9366>.</span><span>font_size</span><span style=color:#ed9366>.</span><span style=color:#f07171>max</span><span>(</span><span style=color:#ff8f40>0.000001</span><span>)</span><span style=color:#61676ccc>;
</span><span>metrics</span><span style=color:#ed9366>.</span><span>line_height </span><span style=color:#ed9366>=</span><span> metrics</span><span style=color:#ed9366>.</span><span>line_height</span><span style=color:#ed9366>.</span><span style=color:#f07171>max</span><span>(</span><span style=color:#ff8f40>0.000001</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Later in the code:
</span><span>buffer</span><span style=color:#ed9366>.</span><span style=color:#f07171>set_metrics_and_size</span><span>(font_system</span><span style=color:#61676ccc>,</span><span> metrics</span><span style=color:#61676ccc>,</span><span> bounds</span><span style=color:#ed9366>.</span><span>width</span><span style=color:#61676ccc>,</span><span> bounds</span><span style=color:#ed9366>.</span><span>height)</span><span style=color:#61676ccc>;
</span></code></pre><p>The unnecessary work included:<ol><li>Iterating through all text spans to find the maximum font size and line height<li>Creating a <code>Metrics</code> object with these values<li>Applying scaling to the metrics<li>Applying a hack to avoid zero values (which would cause a panic)</ol><p>The key insight was recognizing that these metrics were only used for initializing the text buffer, but since each text span specifies its own font properties explicitly, the buffer’s initial metrics don’t affect the final rendered text. The <code>cosmic-text</code> library uses the font properties specified per span when actually rendering, not the initial buffer metrics.<p>The solution was straightforward: remove all the metric collection and calculation code, and simply call <code>buffer.set_size()</code> instead of <code>buffer.set_metrics_and_size()</code>. This eliminated the computational overhead of tracking maximum values across spans and the various calculations that followed.<p>Additionally, the default <code>CosmicBuffer</code> initialization was updated to use arbitrary dummy values (20.0 for both font size and line height) instead of the previous near-zero values that required special handling:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>Self</span><span>(Buffer</span><span style=color:#ed9366>::</span><span>new_empty(Metrics</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ff8f40>0.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.000001</span><span>)))
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>Self</span><span>(Buffer</span><span style=color:#ed9366>::</span><span>new_empty(Metrics</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ff8f40>20.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>20.0</span><span>)))
</span></code></pre><p>This change not only improves performance by eliminating unnecessary calculations but also simplifies the codebase. The removal of the hack to avoid zero values (the <code>max(0.000001)</code> calls) makes the code cleaner and easier to maintain.<p>From an architectural perspective, this optimization highlights an important principle: when working with layered rendering systems, it’s valuable to understand which configuration parameters actually affect the final output versus which are just initialization artifacts. In this case, the buffer metrics were initialization-only parameters that didn’t propagate to the actual text rendering.<p>The impact of this change is primarily performance-related - text updates should be slightly faster due to fewer calculations. There’s no functional change to how text is rendered, as the per-span font properties remain the authoritative source for rendering decisions.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Text Pipeline Update] --> B[Original: Collect Span Metrics]
</span><span>    A --> C[Optimized: Skip Metric Collection]
</span><span>    
</span><span>    B --> D[Calculate Max Font Size]
</span><span>    B --> E[Calculate Max Line Height]
</span><span>    D --> F[Create Metrics Object]
</span><span>    E --> F
</span><span>    F --> G[Apply Scale Factor]
</span><span>    G --> H[Hack: Avoid Zero Values]
</span><span>    H --> I[Set Buffer Metrics and Size]
</span><span>    
</span><span>    C --> J[Set Buffer Size Only]
</span><span>    
</span><span>    subgraph "Removed Operations"
</span><span>        D
</span><span>        E
</span><span>        F
</span><span>        G
</span><span>        H
</span><span>    end
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-text-src-pipeline-rs-1-14><code>crates/bevy_text/src/pipeline.rs</code> (+1/-14)</h3><p>This file contained the main optimization. The changes removed the metric collection and calculation logic:<p><strong>Before:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let mut</span><span> max_font_size</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32 </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0.</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let mut</span><span> max_line_height</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32 </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0.0</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// ... inside span processing loop:
</span><span>max_font_size </span><span style=color:#ed9366>=</span><span> max_font_size</span><span style=color:#ed9366>.</span><span style=color:#f07171>max</span><span>(text_font</span><span style=color:#ed9366>.</span><span>font_size)</span><span style=color:#61676ccc>;
</span><span>max_line_height </span><span style=color:#ed9366>=</span><span> max_line_height</span><span style=color:#ed9366>.</span><span style=color:#f07171>max</span><span>(line_height</span><span style=color:#ed9366>.</span><span style=color:#f07171>eval</span><span>(text_font</span><span style=color:#ed9366>.</span><span>font_size))</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// ... later:
</span><span style=color:#fa6e32>let mut</span><span> metrics </span><span style=color:#ed9366>= </span><span>Metrics</span><span style=color:#ed9366>::</span><span>new(max_font_size</span><span style=color:#61676ccc>,</span><span> max_line_height)</span><span style=color:#ed9366>.</span><span style=color:#f07171>scale</span><span>(scale_factor </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32</span><span>)</span><span style=color:#61676ccc>;
</span><span>metrics</span><span style=color:#ed9366>.</span><span>font_size </span><span style=color:#ed9366>=</span><span> metrics</span><span style=color:#ed9366>.</span><span>font_size</span><span style=color:#ed9366>.</span><span style=color:#f07171>max</span><span>(</span><span style=color:#ff8f40>0.000001</span><span>)</span><span style=color:#61676ccc>;
</span><span>metrics</span><span style=color:#ed9366>.</span><span>line_height </span><span style=color:#ed9366>=</span><span> metrics</span><span style=color:#ed9366>.</span><span>line_height</span><span style=color:#ed9366>.</span><span style=color:#f07171>max</span><span>(</span><span style=color:#ff8f40>0.000001</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// ... when updating buffer:
</span><span>buffer</span><span style=color:#ed9366>.</span><span style=color:#f07171>set_metrics_and_size</span><span>(font_system</span><span style=color:#61676ccc>,</span><span> metrics</span><span style=color:#61676ccc>,</span><span> bounds</span><span style=color:#ed9366>.</span><span>width</span><span style=color:#61676ccc>,</span><span> bounds</span><span style=color:#ed9366>.</span><span>height)</span><span style=color:#61676ccc>;
</span></code></pre><p><strong>After:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Removed all metric collection code
</span><span style=color:#abb0b6;font-style:italic>// ...
</span><span style=color:#abb0b6;font-style:italic>// When updating buffer:
</span><span>buffer</span><span style=color:#ed9366>.</span><span style=color:#f07171>set_size</span><span>(font_system</span><span style=color:#61676ccc>,</span><span> bounds</span><span style=color:#ed9366>.</span><span>width</span><span style=color:#61676ccc>,</span><span> bounds</span><span style=color:#ed9366>.</span><span>height)</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-text-src-text-rs-1-1><code>crates/bevy_text/src/text.rs</code> (+1/-1)</h3><p>This file contained a minor change to use sensible default values instead of near-zero values that required special handling:<p><strong>Before:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>impl </span><span>Default </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>CosmicBuffer </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>default</span><span>() </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>        </span><span style=color:#fa6e32>Self</span><span>(Buffer</span><span style=color:#ed9366>::</span><span>new_empty(Metrics</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ff8f40>0.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.000001</span><span>)))
</span><span>    }
</span><span>}
</span></code></pre><p><strong>After:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>impl </span><span>Default </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>CosmicBuffer </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>default</span><span>() </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>        </span><span style=color:#fa6e32>Self</span><span>(Buffer</span><span style=color:#ed9366>::</span><span>new_empty(Metrics</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ff8f40>20.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>20.0</span><span>)))
</span><span>    }
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><strong>cosmic-text library documentation</strong>: Understanding how cosmic-text handles text layout and rendering would provide context for why these metrics were unnecessary.<li><strong>Bevy Text Rendering System</strong>: The Bevy engine’s text rendering architecture and how it integrates with different backends.<li><strong>Performance Optimization in Game Engines</strong>: General principles for identifying and eliminating redundant calculations in real-time rendering systems.<li><strong>Rust Zero-Cost Abstractions</strong>: How Rust’s type system and compiler optimizations can help eliminate runtime overhead when properly structured.</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22022.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>