<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22123 Fix: Ignores nodes that are hidden via their parents in directional nav
        
    </title><meta content="#22123 Fix: Ignores nodes that are hidden via their parents in directional nav" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-15</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22123-zh-cn-20251215>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix: Ignores nodes that are hidden via their parents in directional nav<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22123<li><strong>Author</strong>: kfc35<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-UI, S-Ready-For-Final-Review, D-Straightforward<li><strong>Created</strong>: 2025-12-15T06:51:35Z<li><strong>Merged</strong>: 2025-12-15T21:12:20Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Fixes #21950</ul><h2 id=solution>Solution</h2><ul><li>Updated the query as suggested in the issue to also check for <code>InheritedVisibility</code>. Entities that have <code>Visibility::INHERITED</code> and <code>InheritedVisibility::HIDDEN</code> should also be ignored for directional navigation</ul><h2 id=testing>Testing</h2><ul><li>Did you test these changes? If so, how? I did not test this change at all! And I wasn’t sure how best to set up an automated test for this since there is not an existing one for that function, else I would have. However, the logic change is simple at least… So if a test is desired, just let me know and please provide me with a little direction :)</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This pull request addresses a specific bug in Bevy’s directional navigation system where UI nodes hidden through parent visibility inheritance were incorrectly being considered as navigable targets. The issue was reported in #21950 and represents a case where the navigation logic wasn’t properly respecting the full visibility hierarchy.<p>The core problem stems from how Bevy’s ECS system handles visibility. There are two main components involved: <code>Visibility</code> and <code>InheritedVisibility</code>. The <code>Visibility</code> component can have three states: <code>Visible</code>, <code>Hidden</code>, or <code>Inherited</code>. When a node has <code>Visibility::Inherited</code>, its actual visibility state is determined by the <code>InheritedVisibility</code> component, which is computed from the parent chain. This dual-component approach allows for efficient visibility propagation through the UI hierarchy.<p>The bug occurred in the <code>auto_rebuild_ui_navigation_graph</code> function within the directional navigation system. This function builds a graph of focusable UI elements for keyboard/gamepad navigation. The original implementation only checked for direct visibility (<code>Visibility::Hidden</code>) but didn’t account for nodes that inherit their visibility from parents. This meant that if a parent UI element was hidden, its children would still appear in the navigation graph even though they weren’t visually present.<p>The fix is straightforward but important for correct navigation behavior. The developer updated the system query to include <code>InheritedVisibility</code> alongside the existing <code>Visibility</code> component. Then, they modified the filtering logic to exclude nodes that are either directly hidden (<code>Visibility::Hidden</code>) or inherited hidden (<code>Visibility::Inherited</code> with <code>InheritedVisibility::HIDDEN</code>).<p>The implementation approach follows the pattern already established in Bevy’s visibility system. The key insight is that when <code>Visibility::Inherited</code> is present, the actual visibility state must be checked in the <code>InheritedVisibility</code> component. This is a common pattern in Bevy’s ECS architecture where computed components store the results of system calculations.<p>From a technical perspective, this fix ensures that directional navigation respects the complete visibility state of UI elements. Without this fix, users could navigate to invisible UI elements, causing confusion and breaking expected accessibility patterns. The change maintains the existing performance characteristics since it only adds one additional component to the query and performs a simple boolean check.<p>One interesting aspect of this PR is the author’s note about testing. They acknowledge they didn’t write automated tests due to the lack of existing test infrastructure for this function. This is a common challenge in large codebases where adding tests for untested areas requires understanding both the functionality and the testing patterns used elsewhere. The author correctly identifies that while the logic change is simple, proper testing would require guidance on the existing test patterns in the codebase.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[auto_rebuild_ui_navigation_graph system] --> B{Query UI nodes}
</span><span>    B --> C[Filter nodes]
</span><span>    C --> D{Check visibility}
</span><span>    D -->|Visibility::Hidden| E[Skip node]
</span><span>    D -->|Visibility::Inherited| F{Check InheritedVisibility}
</span><span>    F -->|InheritedVisibility::HIDDEN| E
</span><span>    D -->|Visible or InheritedVisible| G[Include in navigation graph]
</span><span>    G --> H[Build directional edges]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>File: crates/bevy_input_focus/src/directional_navigation.rs</strong> (+20/-13)<p>This is the only file modified in the PR. The changes involve updating a system query and its filtering logic to properly handle inherited visibility.<p><strong>Key Changes:</strong><ol><li><strong>Import addition</strong> - Added <code>InheritedVisibility</code> to the imports from <code>bevy_camera::visibility</code>.</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>use </span><span>bevy_camera</span><span style=color:#ed9366>::</span><span>visibility</span><span style=color:#ed9366>::</span><span>Visibility</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>use </span><span>bevy_camera</span><span style=color:#ed9366>::</span><span>visibility</span><span style=color:#ed9366>::</span><span>{InheritedVisibility</span><span style=color:#61676ccc>,</span><span> Visibility}</span><span style=color:#61676ccc>;
</span></code></pre><ol start=2><li><strong>Query modification</strong> - Updated the system query to include <code>InheritedVisibility</code> as an optional component.</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>    all_nodes</span><span style=color:#61676ccc>: </span><span>Query<
</span><span>        (
</span><span>            Entity,
</span><span>            </span><span style=color:#ed9366>&</span><span>ComputedNode,
</span><span>            </span><span style=color:#ed9366>&</span><span>UiGlobalTransform,
</span><span>            </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#ed9366>&</span><span>Visibility>,
</span><span>        ),
</span><span>        With&LTAutoDirectionalNavigation>,
</span><span>    ></span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>    all_nodes</span><span style=color:#61676ccc>: </span><span>Query<
</span><span>        (
</span><span>            Entity,
</span><span>            </span><span style=color:#ed9366>&</span><span>ComputedNode,
</span><span>            </span><span style=color:#ed9366>&</span><span>UiGlobalTransform,
</span><span>            </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#ed9366>&</span><span>Visibility>,
</span><span>            </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#ed9366>&</span><span>InheritedVisibility>,
</span><span>        ),
</span><span>        With&LTAutoDirectionalNavigation>,
</span><span>    ></span><span style=color:#61676ccc>,
</span></code></pre><ol start=3><li><strong>Filter logic update</strong> - Enhanced the filtering logic to check inherited visibility states.</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>filter_map</span><span>(|(</span><span style=color:#ff8f40>entity</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>computed</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>transform</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>visibility</span><span>)| {
</span><span>            </span><span style=color:#abb0b6;font-style:italic>// Skip hidden or zero-size nodes
</span><span>            </span><span style=color:#fa6e32>if</span><span> computed</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_empty</span><span>() </span><span style=color:#ed9366>|| </span><span style=color:#f07171>matches!</span><span>(visibility</span><span style=color:#61676ccc>, </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(Visibility</span><span style=color:#ed9366>::</span><span>Hidden)) {
</span><span>                </span><span style=color:#fa6e32>return </span><span style=color:#55b4d4;font-style:italic>None</span><span style=color:#61676ccc>;
</span><span>            }
</span><span>            </span><span style=color:#fa6e32>let </span><span>(_scale</span><span style=color:#61676ccc>,</span><span> _rotation</span><span style=color:#61676ccc>,</span><span> translation) </span><span style=color:#ed9366>=</span><span> transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_scale_angle_translation</span><span>()</span><span style=color:#61676ccc>;
</span><span>            </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(FocusableArea {
</span><span>                entity</span><span style=color:#61676ccc>,
</span><span>                position</span><span style=color:#61676ccc>:</span><span> translation</span><span style=color:#61676ccc>,
</span><span>                size</span><span style=color:#61676ccc>:</span><span> computed</span><span style=color:#ed9366>.</span><span style=color:#f07171>size</span><span>()</span><span style=color:#61676ccc>,
</span><span>            })
</span><span>        })
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>filter_map</span><span>(
</span><span>            |(</span><span style=color:#ff8f40>entity</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>computed</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>transform</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>visibility</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>inherited_visibility</span><span>)| {
</span><span>                </span><span style=color:#abb0b6;font-style:italic>// Skip hidden or zero-size nodes
</span><span>                </span><span style=color:#fa6e32>if</span><span> computed</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_empty</span><span>()
</span><span>                    </span><span style=color:#ed9366>|| </span><span style=color:#f07171>matches!</span><span>(visibility</span><span style=color:#61676ccc>, </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(Visibility</span><span style=color:#ed9366>::</span><span>Hidden))
</span><span>                    </span><span style=color:#ed9366>|| </span><span>(</span><span style=color:#f07171>matches!</span><span>(visibility</span><span style=color:#61676ccc>, </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(Visibility</span><span style=color:#ed9366>::</span><span>Inherited))
</span><span>                        </span><span style=color:#ed9366>&& </span><span style=color:#f07171>matches!</span><span>(inherited_visibility</span><span style=color:#61676ccc>, </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#ed9366>&</span><span>InheritedVisibility</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>HIDDEN</span><span>)))
</span><span>                {
</span><span>                    </span><span style=color:#fa6e32>return </span><span style=color:#55b4d4;font-style:italic>None</span><span style=color:#61676ccc>;
</span><span>                }
</span><span>                </span><span style=color:#fa6e32>let </span><span>(_scale</span><span style=color:#61676ccc>,</span><span> _rotation</span><span style=color:#61676ccc>,</span><span> translation) </span><span style=color:#ed9366>=</span><span> transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_scale_angle_translation</span><span>()</span><span style=color:#61676ccc>;
</span><span>                </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(FocusableArea {
</span><span>                    entity</span><span style=color:#61676ccc>,
</span><span>                    position</span><span style=color:#61676ccc>:</span><span> translation</span><span style=color:#61676ccc>,
</span><span>                    size</span><span style=color:#61676ccc>:</span><span> computed</span><span style=color:#ed9366>.</span><span style=color:#f07171>size</span><span>()</span><span style=color:#61676ccc>,
</span><span>                })
</span><span>            }</span><span style=color:#61676ccc>,
</span><span>        )
</span></code></pre><p>The fix ensures that nodes with <code>Visibility::Inherited</code> and <code>InheritedVisibility::HIDDEN</code> are excluded from the navigation graph, correctly handling the case where nodes are hidden through parent visibility.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_ui/latest/bevy_ui/struct.Visibility.html target=_blank>Bevy UI Visibility System Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/programming/queries.html target=_blank>Bevy ECS Query System</a><li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/features/ui.html#focus-and-navigation target=_blank>UI Navigation in Bevy</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/discussions/3972 target=_blank>Component Inheritance Patterns in ECS</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22123.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>