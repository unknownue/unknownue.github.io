<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21885 Prevent WebGL builds from crashing on startup when using FpsOverlayPlugin
        
    </title><meta content="#21885 Prevent WebGL builds from crashing on startup when using FpsOverlayPlugin" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-08</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-21885-zh-cn-20251208>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Prevent WebGL builds from crashing on startup when using FpsOverlayPlugin<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21885<li><strong>Author</strong>: it-me-joda<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, O-WebGL2, D-Straightforward, S-Waiting-on-Author<li><strong>Created</strong>: 2025-11-19T18:21:43Z<li><strong>Merged</strong>: 2025-12-08T12:19:16Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><p>The PR description is already in English.<h1 id=objective>Objective</h1><ul><li>Fixes #21362<li>The FrameTimeGraph uses a material that crashes in WebGL (but not WebGPU) even if the FrameTimeGraph is disabled. We need to prevent the FrameTimeGraph from being created when we build for WASM.</ul><h2 id=solution>Solution</h2><ul><li>If the build is for WASM with only WebGL, we skip the creation of the FrameTimeGraph. Additionally, if the FrameTimeGraph is enabled, we provide a warning to inform the user that the FrameTimeGraph isn’t supported on WebGL.</ul><h2 id=testing>Testing</h2><ul><li>I used the repro provided in the issue.</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The issue started with a WebGL-specific crash in Bevy when using the FpsOverlayPlugin. The problem was reported in issue #21362, where developers observed that WebGL builds would crash on startup if they included the FpsOverlayPlugin, even when the FrameTimeGraph component of the overlay was disabled. This was a significant problem because it prevented developers from using the FPS overlay for debugging WebGL applications.<p>The root cause was that the FrameTimeGraph uses a custom material called FrametimeGraphMaterial that depends on shader storage buffers (SSBOs). Shader storage buffers are not available in WebGL’s feature set, only in WebGPU. Even when the FrameTimeGraph was disabled via configuration (with <code>frame_time_graph_config.enabled</code> set to false), the code would still create the material and its associated shader storage buffer. This caused a WebGL runtime error because the shader attempted to access an unsupported buffer type.<p>The developer approached this problem with a targeted solution: conditionally skip the creation of the FrameTimeGraph entirely when building for WebGL. The implementation uses Rust’s conditional compilation system with <code>#[cfg]</code> attributes to control what code gets compiled for different target configurations. This is a practical approach because it completely avoids the problematic code path in WebGL builds.<p>The key insight was that the crash wasn’t just about whether the graph was enabled at runtime, but about the compilation of incompatible GPU code. Even with runtime checks to hide the UI element (using <code>Display::None</code>), the material and its shader storage buffer were still created, which caused the WebGL context to reject the shader program. The solution needed to prevent the material from being compiled and instantiated at all in WebGL builds.<p>The implementation wraps the FrameTimeGraph creation code in a conditional block that only runs when NOT building for WASM without WebGPU support. For WebGL builds (WASM without WebGPU), the code instead checks if the graph is enabled and logs a warning using the tracing crate’s <code>warn!</code> macro. This warning informs developers that the feature isn’t available in their current configuration.<p>The developer also needed to update the Cargo.toml files to expose feature flags for WebGL and WebGPU in the bevy_dev_tools crate. This allowed the conditional compilation to work correctly by enabling the appropriate backend features. The bevy_internal crate’s Cargo.toml was updated to propagate these feature flags, ensuring that when someone builds Bevy with WebGL support, the dev tools crate properly compiles for that backend.<p>This solution has minimal performance impact since it simply excludes code at compile time for WebGL builds. For non-WebGL builds (including WebGPU and native), the FrameTimeGraph continues to work as before. The warning message is helpful because it lets developers know why they’re not seeing the frame time graph when they enable it in a WebGL build.<p>The fix is a good example of handling platform-specific limitations in a graphics engine. Rather than trying to make the shader storage buffer work in WebGL (which isn’t possible due to API limitations), the code avoids using the feature entirely on that platform. This is a common pattern in cross-platform graphics programming where different backends support different feature sets.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[FpsOverlayPlugin.setup] --> B{Platform Check}
</span><span>    B -->|WASM & not WebGPU| C[WebGL Build]
</span><span>    B -->|Other| D[Non-WebGL Build]
</span><span>    
</span><span>    C --> E{FrameTimeGraph enabled?}
</span><span>    E -->|Yes| F[Log warning: Not supported]
</span><span>    E -->|No| G[Skip creation silently]
</span><span>    
</span><span>    D --> H[Create FrameTimeGraph with Material]
</span><span>    H --> I[Create ShaderStorageBuffer]
</span><span>    I --> J[Works in WebGPU/Native]
</span><span>    
</span><span>    F --> K[No crash on startup]
</span><span>    G --> K
</span><span>    J --> L[FrameTimeGraph functions normally]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-dev-tools-src-fps-overlay-rs-39-28><code>crates/bevy_dev_tools/src/fps_overlay.rs</code> (+39/-28)</h3><p>This is the main file containing the FPS overlay logic. The changes add conditional compilation to skip creating the FrameTimeGraph in WebGL builds.<p><strong>Key modification:</strong> The code that creates the FrameTimeGraph entity is now wrapped in conditional compilation blocks:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(</span><span style=color:#f29718>all</span><span>(target_arch </span><span style=color:#ed9366>= </span><span style=color:#86b300>"wasm32"</span><span style=color:#61676ccc>, </span><span style=color:#f29718>not</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"webgpu"</span><span>)))]
</span><span>{
</span><span>    </span><span style=color:#fa6e32>if</span><span> overlay_config</span><span style=color:#ed9366>.</span><span>frame_time_graph_config</span><span style=color:#ed9366>.</span><span>enabled {
</span><span>        </span><span style=color:#fa6e32>use </span><span>tracing</span><span style=color:#ed9366>::</span><span>warn</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#f07171>warn!</span><span>(</span><span style=color:#86b300>"Frame time graph is not supported with WebGL. Consider if WebGPU is viable for your usecase."</span><span>)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(</span><span style=color:#f29718>not</span><span>(</span><span style=color:#f29718>all</span><span>(target_arch </span><span style=color:#ed9366>= </span><span style=color:#86b300>"wasm32"</span><span style=color:#61676ccc>, </span><span style=color:#f29718>not</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"webgpu"</span><span>))))]
</span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Original FrameTimeGraph creation code here
</span><span>    </span><span style=color:#fa6e32>let</span><span> font_size </span><span style=color:#ed9366>=</span><span> overlay_config</span><span style=color:#ed9366>.</span><span>text_config</span><span style=color:#ed9366>.</span><span>font_size</span><span style=color:#61676ccc>;
</span><span>    p</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((
</span><span>        Node { </span><span style=color:#abb0b6;font-style:italic>/* ... */ </span><span>}</span><span style=color:#61676ccc>,
</span><span>        Pickable</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>IGNORE</span><span style=color:#61676ccc>,
</span><span>        MaterialNode</span><span style=color:#ed9366>::</span><span>from(frame_time_graph_materials</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(FrametimeGraphMaterial {
</span><span>            values</span><span style=color:#61676ccc>:</span><span> buffers</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(ShaderStorageBuffer {
</span><span>                data</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#f07171>vec!</span><span>[</span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span>])</span><span style=color:#61676ccc>,
</span><span>                </span><span style=color:#ed9366>..</span><span style=color:#55b4d4;font-style:italic>Default</span><span style=color:#ed9366>::</span><span>default()
</span><span>            })</span><span style=color:#61676ccc>,
</span><span>            config</span><span style=color:#61676ccc>: </span><span>FrameTimeGraphConfigUniform</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#abb0b6;font-style:italic>/* ... */</span><span>)</span><span style=color:#61676ccc>,
</span><span>        }))</span><span style=color:#61676ccc>,
</span><span>        FrameTimeGraph</span><span style=color:#61676ccc>,
</span><span>    ))</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=crates-bevy-dev-tools-cargo-toml-2-0><code>crates/bevy_dev_tools/Cargo.toml</code> (+2/-0)</h3><p>Added WebGL and WebGPU feature flags that propagate to the render backend.<p><strong>Key addition:</strong><pre class=language-toml data-lang=toml style=color:#61676c;background-color:#fafafa><code class=language-toml data-lang=toml><span>[</span><span style=color:#399ee6>features</span><span>]
</span><span style=color:#399ee6>bevy_ci_testing </span><span>= [</span><span style=color:#86b300>"serde"</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"ron"</span><span>]
</span><span style=color:#399ee6>webgl </span><span>= [</span><span style=color:#86b300>"bevy_render/webgl"</span><span>]
</span><span style=color:#399ee6>webgpu </span><span>= [</span><span style=color:#86b300>"bevy_render/webgpu"</span><span>]
</span></code></pre><h3 id=crates-bevy-internal-cargo-toml-2-0><code>crates/bevy_internal/Cargo.toml</code> (+2/-0)</h3><p>Updated to include bevy_dev_tools in the WebGL and WebGPU feature chains.<p><strong>Key additions:</strong><pre class=language-toml data-lang=toml style=color:#61676c;background-color:#fafafa><code class=language-toml data-lang=toml><span style=color:#399ee6>webgl </span><span>= [
</span><span>  </span><span style=color:#abb0b6;font-style:italic># ... other dependencies
</span><span>  </span><span style=color:#86b300>"bevy_dev_tools?/webgl"</span><span style=color:#61676ccc>,
</span><span>]
</span><span>
</span><span style=color:#399ee6>webgpu </span><span>= [
</span><span>  </span><span style=color:#abb0b6;font-style:italic># ... other dependencies
</span><span>  </span><span style=color:#86b300>"bevy_dev_tools?/webgpu"</span><span style=color:#61676ccc>,
</span><span>]
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><strong>Bevy WebGL/WebGPU Documentation</strong>: Official Bevy documentation on Web platform support and backend differences.<li><strong>Rust Conditional Compilation</strong>: The Rust Reference section on <code>#[cfg]</code> attributes and feature-based compilation.<li><strong>WebGL vs WebGPU Feature Sets</strong>: Comparison of WebGL 2.0 and WebGPU capabilities, particularly regarding shader storage buffers.<li><strong>Bevy Shader Storage Buffers</strong>: How Bevy uses SSBOs for GPU data transfer and their limitations on different platforms.</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_21885.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>