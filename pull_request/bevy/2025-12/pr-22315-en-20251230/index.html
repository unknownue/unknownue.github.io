<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22315 Small code size improvement
        
    </title><meta content="#22315 Small code size improvement" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-30</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22315-zh-cn-20251230>中文</a></div></div><div class=pr-content><h1 id=small-code-size-improvement>Small code size improvement</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Small code size improvement<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22315<li><strong>Author</strong>: goodartistscopy<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Performance, A-Picking<li><strong>Created</strong>: 2025-12-30T12:38:18Z<li><strong>Merged</strong>: 2025-12-30T19:34:55Z<li><strong>Merged By</strong>: james7132</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Improve code size slightly</ul><h2 id=solution>Solution</h2><ul><li>The index-less version of <code>ray_mesh_intersection&LTT>()</code> does not care about the indices type, so any <code>TryInto&LTusize></code> will do.<li>By avoiding to monomorphize another version of <code>ray_mesh_intersection&LTT></code> (with <code>T=usize</code>) when any of the existing one will do, we get a small improvement in code size (and presumably compilation time as well).</ul><h2 id=testing>Testing</h2><ul><li>Built the <code>mesh_ray_cast</code> example, which works as expected</ul><hr><p>The gain is indeed small (0.8kB in dev, 3kB in release and noise (4B) in size-optimized builds)<h2 id=showcase>Showcase</h2><p><code>cargo bloat</code> is used to visualize the differences. Profile dev confirms that one less instance of the function is generated:<pre class=language-sh data-lang=sh style=color:#61676c;background-color:#fafafa><code class=language-sh data-lang=sh><span style=color:#ed9366>> </span><span style=color:#abb0b6;font-style:italic># BEFORE (dev)
</span><span style=color:#ed9366>></span><span> cargo </span><span style=color:#f29718>bloat</span><span style=color:#ff8f40> --filter </span><span style=color:#86b300>"ray_mesh_intersection$"</span><span style=color:#ff8f40> --example</span><span> mesh_ray_cast
</span><span style=color:#f29718>File</span><span> .text   Size        Crate Name
</span><span style=color:#f29718>0.0%</span><span>  0.0%   856B bevy_picking bevy_picking::mesh_picking::ray_cast::intersections::ray_mesh_intersection
</span><span style=color:#f29718>0.0%</span><span>  0.0%   856B bevy_picking bevy_picking::mesh_picking::ray_cast::intersections::ray_mesh_intersection
</span><span style=color:#f29718>0.0%</span><span>  0.0%   856B bevy_picking bevy_picking::mesh_picking::ray_cast::intersections::ray_mesh_intersection
</span><span style=color:#f29718>0.0%</span><span>  0.0% 2.5KiB              filtered data size, the file size is 263.3MiB
</span><span>
</span><span style=color:#ed9366>> </span><span style=color:#abb0b6;font-style:italic># AFTER (dev)
</span><span style=color:#ed9366>></span><span> cargo </span><span style=color:#f29718>bloat</span><span style=color:#ff8f40> --filter </span><span style=color:#86b300>"ray_mesh_intersection$"</span><span style=color:#ff8f40> --example</span><span> mesh_ray_cast
</span><span style=color:#f29718>File</span><span> .text Size        Crate Name
</span><span style=color:#f29718>0.0%</span><span>  0.0%   856B bevy_picking bevy_picking::mesh_picking::ray_cast::intersections::ray_mesh_intersection
</span><span style=color:#f29718>0.0%</span><span>  0.0%   856B bevy_picking bevy_picking::mesh_picking::ray_cast::intersections::ray_mesh_intersection
</span><span style=color:#f29718>0.0%</span><span>  0.0% 1.7KiB              filtered data size, the file size is 263.3MiB
</span></code></pre><p>In release the function is inlined into <code>ray_intersection_over_mesh()</code> which gains 3kB:<pre class=language-sh data-lang=sh style=color:#61676c;background-color:#fafafa><code class=language-sh data-lang=sh><span style=color:#ed9366>> </span><span style=color:#abb0b6;font-style:italic># BEFORE (release)
</span><span style=color:#ed9366>></span><span> cargo </span><span style=color:#f29718>bloat</span><span style=color:#ff8f40> --release --filter </span><span style=color:#86b300>"ray_intersection_over_mesh$"</span><span style=color:#ff8f40> --example</span><span> mesh_ray_cast
</span><span style=color:#f29718>File</span><span> .text   Size        Crate Name
</span><span style=color:#f29718>0.0%</span><span>  0.0% 5.3KiB bevy_picking bevy_picking::mesh_picking::ray_cast::intersections::ray_intersection_over_mesh
</span><span style=color:#f29718>0.0%</span><span>  0.0% 5.3KiB              filtered data size, the file size is 100.7MiB
</span><span>
</span><span style=color:#ed9366>> </span><span style=color:#abb0b6;font-style:italic># AFTER (release)
</span><span style=color:#ed9366>></span><span> cargo </span><span style=color:#f29718>bloat</span><span style=color:#ff8f40> --release --filter </span><span style=color:#86b300>"ray_intersection_over_mesh$"</span><span style=color:#ff8f40> --example</span><span> mesh_ray_cast
</span><span style=color:#f29718>File</span><span> .text   Size        Crate Name
</span><span style=color:#f29718>0.0%</span><span>  0.0% 2.3KiB bevy_picking bevy_picking::mesh_picking::ray_cast::intersections::ray_intersection_over_mesh
</span><span style=color:#f29718>0.0%</span><span>  0.0% 2.3KiB              filtered data size, the file size is 100.7MiB
</span></code></pre><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a straightforward but common Rust performance optimization issue: reducing binary bloat caused by unnecessary monomorphization of generic functions. The problem was in Bevy’s picking system, specifically in the mesh ray intersection code.<p>The mesh picking system uses a generic function <code>ray_mesh_intersection&LTT></code> that works with different index types (u16, u32) for mesh vertices. When a mesh doesn’t use indices (has <code>None</code> for indices), the code was calling this function with <code>T=usize</code>. This created an unnecessary third instantiation of the generic function, since the function doesn’t actually use the index type parameter when indices are <code>None</code>.<p>The key insight here is that when <code>indices</code> is <code>None</code>, the type parameter <code>T</code> in <code>ray_mesh_intersection&LTT></code> doesn’t matter because no indices are being processed. The function only needs a type that implements <code>TryInto&LTusize></code>, which both <code>u32</code> and <code>usize</code> satisfy. By changing the call from <code>ray_mesh_intersection::&LTusize>(..., None, ...)</code> to <code>ray_mesh_intersection::&LTu32>(..., None, ...)</code>, we eliminate one monomorphization.<p>This optimization follows a standard pattern in Rust performance work: reducing duplicate generated code by minimizing unnecessary generic instantiations. The implementation change is minimal - just one character in the type parameter - but the impact on binary size is measurable.<p>The author used <code>cargo bloat</code> to validate the improvement, showing that in development builds, the number of <code>ray_mesh_intersection</code> instances decreased from three to two, saving 0.8KB. In release builds where the function gets inlined into <code>ray_intersection_over_mesh</code>, the savings were more significant at 3KB. This demonstrates how small, targeted changes can accumulate to meaningful binary size reductions in larger applications.<p>What’s interesting about this optimization is that it doesn’t change the runtime behavior at all - it’s purely a compile-time optimization. The mesh ray intersection logic remains identical, but the compiler generates less code. This type of optimization is particularly valuable in game engines where binary size matters for distribution and loading times.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[ray_intersection_over_mesh] --> B{indices type?}
</span><span>    B -->|U16| C[ray_mesh_intersection::&LTu16>]
</span><span>    B -->|U32| D[ray_mesh_intersection::&LTu32>]
</span><span>    B -->|None| E[ray_mesh_intersection::&LTu32>]
</span><span>    
</span><span>    F[Before: ray_mesh_intersection::&LTusize>] -.->|Eliminated| E
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>crates/bevy_picking/src/mesh_picking/ray_cast/intersections.rs</strong> (+1/-1)<p>This file contains the mesh ray intersection logic for Bevy’s picking system. The change modifies a single line in the <code>ray_intersection_over_mesh</code> function to use <code>u32</code> instead of <code>usize</code> when calling the generic function with no indices.<p><strong>Before:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>super</span><span>) </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>ray_intersection_over_mesh</span><span>(
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... parameters
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTIntersectionData> {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other cases
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(Indices</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>U16</span><span>(indices)) </span><span style=color:#ed9366>=> </span><span>{
</span><span>        ray_mesh_intersection</span><span style=color:#ed9366>::</span><span><</span><span style=color:#fa6e32>u16</span><span>>(ray</span><span style=color:#61676ccc>,</span><span> transform</span><span style=color:#61676ccc>,</span><span> positions</span><span style=color:#61676ccc>,</span><span> normals</span><span style=color:#61676ccc>, </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(indices)</span><span style=color:#61676ccc>,</span><span> uvs</span><span style=color:#61676ccc>,</span><span> cull)
</span><span>    }
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(Indices</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>U32</span><span>(indices)) </span><span style=color:#ed9366>=> </span><span>{
</span><span>        ray_mesh_intersection</span><span style=color:#ed9366>::</span><span><</span><span style=color:#fa6e32>u32</span><span>>(ray</span><span style=color:#61676ccc>,</span><span> transform</span><span style=color:#61676ccc>,</span><span> positions</span><span style=color:#61676ccc>,</span><span> normals</span><span style=color:#61676ccc>, </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(indices)</span><span style=color:#61676ccc>,</span><span> uvs</span><span style=color:#61676ccc>,</span><span> cull)
</span><span>    }
</span><span>    </span><span style=color:#55b4d4;font-style:italic>None </span><span style=color:#ed9366>=> </span><span>ray_mesh_intersection</span><span style=color:#ed9366>::</span><span><</span><span style=color:#fa6e32>usize</span><span>>(ray</span><span style=color:#61676ccc>,</span><span> transform</span><span style=color:#61676ccc>,</span><span> positions</span><span style=color:#61676ccc>,</span><span> normals</span><span style=color:#61676ccc>, </span><span style=color:#55b4d4;font-style:italic>None</span><span style=color:#61676ccc>,</span><span> uvs</span><span style=color:#61676ccc>,</span><span> cull)</span><span style=color:#61676ccc>,
</span><span>}
</span></code></pre><p><strong>After:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>super</span><span>) </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>ray_intersection_over_mesh</span><span>(
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... parameters
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTIntersectionData> {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other cases
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(Indices</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>U16</span><span>(indices)) </span><span style=color:#ed9366>=> </span><span>{
</span><span>        ray_mesh_intersection</span><span style=color:#ed9366>::</span><span><</span><span style=color:#fa6e32>u16</span><span>>(ray</span><span style=color:#61676ccc>,</span><span> transform</span><span style=color:#61676ccc>,</span><span> positions</span><span style=color:#61676ccc>,</span><span> normals</span><span style=color:#61676ccc>, </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(indices)</span><span style=color:#61676ccc>,</span><span> uvs</span><span style=color:#61676ccc>,</span><span> cull)
</span><span>    }
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(Indices</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>U32</span><span>(indices)) </span><span style=color:#ed9366>=> </span><span>{
</span><span>        ray_mesh_intersection</span><span style=color:#ed9366>::</span><span><</span><span style=color:#fa6e32>u32</span><span>>(ray</span><span style=color:#61676ccc>,</span><span> transform</span><span style=color:#61676ccc>,</span><span> positions</span><span style=color:#61676ccc>,</span><span> normals</span><span style=color:#61676ccc>, </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(indices)</span><span style=color:#61676ccc>,</span><span> uvs</span><span style=color:#61676ccc>,</span><span> cull)
</span><span>    }
</span><span>    </span><span style=color:#55b4d4;font-style:italic>None </span><span style=color:#ed9366>=> </span><span>ray_mesh_intersection</span><span style=color:#ed9366>::</span><span><</span><span style=color:#fa6e32>u32</span><span>>(ray</span><span style=color:#61676ccc>,</span><span> transform</span><span style=color:#61676ccc>,</span><span> positions</span><span style=color:#61676ccc>,</span><span> normals</span><span style=color:#61676ccc>, </span><span style=color:#55b4d4;font-style:italic>None</span><span style=color:#61676ccc>,</span><span> uvs</span><span style=color:#61676ccc>,</span><span> cull)</span><span style=color:#61676ccc>,
</span><span>}
</span></code></pre><p>The change is subtle but effective: when there are no indices (<code>None</code> case), we now use <code>u32</code> as the type parameter instead of <code>usize</code>. This allows the compiler to reuse the existing <code>ray_mesh_intersection::&LTu32></code> instantiation rather than creating a separate <code>ray_mesh_intersection::&LTusize></code> version.<h2 id=further-reading>Further Reading</h2><ol><li><strong>Rust Performance Book - Generics and Monomorphization</strong>: Understanding how Rust generates specialized code for each concrete type used with generics<li><strong><code>cargo bloat</code> documentation</strong>: A tool for analyzing binary size in Rust projects<li><strong>Bevy Picking System</strong>: Documentation on Bevy’s entity picking and ray casting systems<li><strong>Rustonomicon - PhantomData</strong>: Advanced patterns for controlling generic type parameters in Rust<li><strong>“Zero Cost Abstractions” in Rust</strong>: How Rust’s generics system provides abstraction without runtime overhead</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22315.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>