<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21864 DespawnOnExit / DespawnOnEnter fix log spam
        
    </title><meta content="#21864 DespawnOnExit / DespawnOnEnter fix log spam" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-09</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-21864-zh-cn-20251209>中文</a></div></div><div class=pr-content><h1 id=title-despawnonexit-despawnonenter-fix-log-spam>Title: DespawnOnExit / DespawnOnEnter fix log spam</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: DespawnOnExit / DespawnOnEnter fix log spam<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21864<li><strong>Author</strong>: Lyndon-Mackay<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, S-Ready-For-Final-Review, D-Straightforward, A-States, C-Refinement<li><strong>Created</strong>: 2025-11-16T23:39:36Z<li><strong>Merged</strong>: 2025-12-09T01:10:26Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>if entity was despawned such as in a hierachy<h1 id=objective>Objective</h1><ul><li>DespawnOnExit / DespawnOnEnter logs errors with despawning. Most if not all use cases don’t care if the item is already despawned. The user is typically saying “Ensure it is despawned” rather then “You should be the one to despawn”<li>Fixes #21832</ul><h2 id=solution>Solution</h2><ul><li>Changes the state_scoped code to use try despawn</ul><h2 id=testing>Testing</h2><ul><li>I updated example state_scoped to include children with DespawnOnExit/DespawnOnEnter and added a brief explanation then I ran the examples</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a logging issue in Bevy’s state-scoped entity despawn system. The problem occurs when entities with <code>DespawnOnExit</code> or <code>DespawnOnEnter</code> components are despawned through hierarchical operations (like despawning a parent entity), and then the state transition systems attempt to despawn them again.<p>The core issue is that when you have a hierarchy of entities and a parent gets despawned, all its children are automatically despawned. If any of those children also have <code>DespawnOnExit</code> or <code>DespawnOnEnter</code> components, the state transition systems will still try to despawn them when the relevant state changes occur. This leads to warning logs like “warning: bevy_ecs::system: Failed to despawn entity X because it doesn’t exist in this World.”<p>From a user’s perspective, this is noisy and unnecessary. When developers use <code>DespawnOnExit</code> or <code>DespawnOnEnter</code>, they’re expressing an intent: “this entity should not exist in this state.” They typically don’t care whether the system that does the despawning is the state transition system or some other system (like a parent despawn). The semantics are about ensuring the entity is gone, not about who does the work.<p>The solution implemented here is straightforward but important: replace <code>.despawn()</code> calls with <code>.try_despawn()</code> in both state transition systems. The <code>try_despawn()</code> method handles the case where an entity might already be despawned by doing nothing in that scenario, avoiding the warning log.<p>Looking at the implementation changes, we can see the pattern clearly. In <code>crates/bevy_state/src/state_scoped.rs</code>, both <code>despawn_entities_on_exit_state</code> and <code>despawn_entities_on_enter_state</code> functions now use <code>try_despawn()</code>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(entity)</span><span style=color:#ed9366>.</span><span style=color:#f07171>despawn</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(entity)</span><span style=color:#ed9366>.</span><span style=color:#f07171>try_despawn</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><p>This change preserves the system’s core functionality while making it more robust to real-world usage patterns. The documentation has also been updated to explicitly state the new behavior: “If the entity has already been despawned no warning will be emitted.”<p>The example updates are particularly instructive. The PR author modified <code>examples/ecs/state_scoped.rs</code> to demonstrate that you can safely add <code>DespawnOnExit</code> and <code>DespawnOnEnter</code> components to children in a hierarchy without worrying about duplicate despawning attempts. The example shows that even when a parent has state-scoped components, you can still apply these components to children. As the comments explain: “It is unnecessary but in complex hierarchies it saves you from having to mentally track which components are found at the top level.”<p>This change reflects a common pattern in game development: making systems more forgiving and less noisy. Game development involves complex entity hierarchies and state transitions, and developers need systems that work well together without requiring perfect coordination. By making <code>DespawnOnExit</code> and <code>DespawnOnEnter</code> idempotent (calling them multiple times has the same effect as calling them once), the API becomes more robust and easier to use correctly.<p>The engineering trade-off here is minimal. The <code>try_despawn()</code> method has a trivial performance cost (checking if the entity exists before attempting to despawn it), but this is negligible compared to the clarity and usability benefits. More importantly, it aligns with the principle of least surprise: users expect “ensure this entity is despawned” semantics, not “you must be the one to despawn it” semantics.<p>This fix also demonstrates good API design practices. When you have a system that operates on entities that might be managed by multiple systems, it’s often better to use idempotent operations. This prevents conflicts and makes the system more composable with other parts of the engine.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[State Transition Event] --> B{Entity has DespawnOnExit/Enter component?}
</span><span>    B -->|Yes| C{State matches trigger condition?}
</span><span>    C -->|Yes| D[Try to despawn entity]
</span><span>    D --> E{Entity already despawned?}
</span><span>    E -->|Yes| F[Silently do nothing - no warning]
</span><span>    E -->|No| G[Despawn entity normally]
</span><span>    B -->|No| H[Do nothing for this entity]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-state-src-state-scoped-rs-6-2><code>crates/bevy_state/src/state_scoped.rs</code> (+6/-2)</h3><p>This file contains the core logic for state-scoped entity despawning. The changes switch from <code>despawn()</code> to <code>try_despawn()</code> in both state transition systems.<p><strong>Before:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>for </span><span>(entity</span><span style=color:#61676ccc>,</span><span> binding) </span><span style=color:#ed9366>in &</span><span>query {
</span><span>    </span><span style=color:#fa6e32>if</span><span> binding</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0 </span><span style=color:#ed9366>== *</span><span>exited {
</span><span>        commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(entity)</span><span style=color:#ed9366>.</span><span style=color:#f07171>despawn</span><span>()</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><p><strong>After:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>for </span><span>(entity</span><span style=color:#61676ccc>,</span><span> binding) </span><span style=color:#ed9366>in &</span><span>query {
</span><span>    </span><span style=color:#fa6e32>if</span><span> binding</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0 </span><span style=color:#ed9366>== *</span><span>exited {
</span><span>        commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(entity)</span><span style=color:#ed9366>.</span><span style=color:#f07171>try_despawn</span><span>()</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><p>The documentation was also updated to clarify the new behavior: “If the entity has already been despawned no warning will be emitted.”<h3 id=examples-ecs-state-scoped-rs-11-0><code>examples/ecs/state_scoped.rs</code> (+11/-0)</h3><p>The example file was updated to demonstrate the fix and provide guidance to users. Key additions include:<ol><li><strong>Documentation</strong>: Added explanation that if an entity was already despawned, no error will be logged.<li><strong>Example Code</strong>: Added <code>DespawnOnExit</code> and <code>DespawnOnEnter</code> components to children in the hierarchy to show that duplicate components are handled gracefully.</ol><p>Example addition:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added to children to show that duplicate despawning is handled gracefully
</span><span>(</span><span style=color:#f07171>children!</span><span>[DespawnOnExit(GameState</span><span style=color:#ed9366>::</span><span>A)])</span><span style=color:#61676ccc>,
</span></code></pre><p>The comments explain: “You can apply this even when the parent has a state scoped component. It is unnecessary but in complex hierarchies it saves you from having to mentally track which components are found at the top level.”<h2 id=further-reading>Further Reading</h2><ol><li><strong>Bevy States Documentation</strong>: For understanding how Bevy’s state system works<li><strong>Entity Commands API</strong>: Documentation for <code>Commands::entity()</code> and related methods like <code>despawn()</code> and <code>try_despawn()</code><li><strong>Idempotent Operations</strong>: General software design principle where operations can be applied multiple times without changing the result beyond the initial application<li><strong>Entity Component System Patterns</strong>: Common patterns in ECS architecture for managing entity lifecycle across different systems</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_21864.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>