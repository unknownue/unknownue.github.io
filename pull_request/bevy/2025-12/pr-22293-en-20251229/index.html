<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22293 bevy_input_focus: don't add nothing when no input is enabled
        
    </title><meta content="#22293 bevy_input_focus: don't add nothing when no input is enabled" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-29</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22293-zh-cn-20251229>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: bevy_input_focus: don’t add nothing when no input is enabled<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22293<li><strong>Author</strong>: mockersf<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Input, S-Ready-For-Final-Review, D-Straightforward<li><strong>Created</strong>: 2025-12-28T21:09:46Z<li><strong>Merged</strong>: 2025-12-29T20:02:52Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><h3 id=objective>Objective</h3><ul><li><code>cargo build --no-default-features --features bevy_input_focus</code> fails:</ul><pre style=color:#61676c;background-color:#fafafa><code><span>   Compiling bevy_input_focus v0.18.0-dev (/home/runner/work/bevy-releasability/bevy-releasability/crates/bevy_input_focus)
</span><span>error[E0599]: no method named `in_set` found for unit type `()` in the current scope
</span><span>   --> crates/bevy_input_focus/src/lib.rs:236:22
</span><span>    |
</span><span>228 | /                 (
</span><span>229 | |                     #[cfg(feature = "keyboard")]
</span><span>230 | |                     dispatch_focused_input::&LTKeyboardInput>,
</span><span>231 | |                     #[cfg(feature = "gamepad")]
</span><span>...   |
</span><span>236 | |                     .in_set(InputFocusSystems::Dispatch),
</span><span>    | |_____________________-^^^^^^
</span><span>    |
</span></code></pre><ul><li>Introduced in #22177</ul><h3 id=solution>Solution</h3><ul><li>Don’t add an empty system tuple when no input feature is enabled</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a build failure that occurs when compiling the <code>bevy_input_focus</code> crate with specific feature configurations. The issue is a regression introduced in PR #22177, and it manifests when users build Bevy with the command <code>cargo build --no-default-features --features bevy_input_focus</code>. The error message indicates that the compiler cannot find the method <code>in_set</code> for the unit type <code>()</code>, which points to a problematic system tuple construction.<p>Looking at the code, the problem stems from how conditional compilation is handled when registering systems in the <code>InputDispatchPlugin</code>. In the Bevy engine, systems are often grouped into tuples and scheduled in specific system sets. When using Rust’s <code>#[cfg(feature = "...")]</code> attributes to conditionally include systems based on enabled features, there’s a subtle edge case: if none of the conditional features are enabled, the entire tuple becomes empty, resulting in the unit type <code>()</code>. The unit type doesn’t have an <code>in_set</code> method, causing the compilation error.<p>The previous implementation used individual <code>#[cfg]</code> attributes on each system within the tuple. While this approach works when at least one feature is enabled, it fails when all features are disabled because it attempts to call <code>.in_set()</code> on an empty tuple. This scenario occurs when building with <code>--no-default-features</code>, which disables all default features, and then explicitly enabling only the <code>bevy_input_focus</code> feature without any of its optional input dependencies (keyboard, gamepad, or mouse).<p>The solution implemented in this PR is straightforward: wrap the entire <code>app.add_systems</code> call for the input dispatch systems in a conditional compilation block that checks if <strong>any</strong> of the input features are enabled. This approach ensures that the problematic empty tuple is never constructed in the first place when no input features are available. The code only attempts to register systems and call <code>.in_set()</code> when there’s at least one system to register.<p>Additionally, the PR optimizes the import statements by conditionally importing <code>bevy_app::PreUpdate</code> only when it’s actually needed. This minor change prevents an unused import warning when no input features are enabled, demonstrating attention to code cleanliness alongside fixing the main issue.<p>The fix demonstrates an important pattern in Rust when working with conditional compilation and system registration in Bevy: always consider the edge case where all conditional elements might be disabled, and structure the code to handle that case gracefully. Instead of trying to register an empty system tuple, it’s better to skip the registration entirely when there are no systems to add.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[InputDispatchPlugin.build()] --> B{Any input features enabled?}
</span><span>    B -->|Yes| C[Create system tuple with enabled systems]
</span><span>    C --> D[Register tuple with .in_set(InputFocusSystems::Dispatch)]
</span><span>    B -->|No| E[Skip system registration entirely]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-input-focus-src-lib-rs-18-14><code>crates/bevy_input_focus/src/lib.rs</code> (+18/-14)</h3><p>This is the only file modified in the PR. The changes fix the build failure by conditionally including the system registration code only when at least one input feature is enabled.<p><strong>Key Changes:</strong><ol><li><strong>Conditional import optimization:</strong></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>use </span><span>bevy_app</span><span style=color:#ed9366>::</span><span>{App</span><span style=color:#61676ccc>,</span><span> Plugin</span><span style=color:#61676ccc>,</span><span> PostStartup</span><span style=color:#61676ccc>,</span><span> PreUpdate}</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(</span><span style=color:#f29718>any</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"keyboard"</span><span style=color:#61676ccc>,</span><span> feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"gamepad"</span><span style=color:#61676ccc>,</span><span> feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"mouse"</span><span>))]
</span><span style=color:#fa6e32>use </span><span>bevy_app</span><span style=color:#ed9366>::</span><span>PreUpdate</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>use </span><span>bevy_app</span><span style=color:#ed9366>::</span><span>{App</span><span style=color:#61676ccc>,</span><span> Plugin</span><span style=color:#61676ccc>,</span><span> PostStartup}</span><span style=color:#61676ccc>;
</span></code></pre><ol start=2><li><strong>Conditional system registration:</strong></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(
</span><span>    PreUpdate</span><span style=color:#61676ccc>,
</span><span>    (
</span><span>        </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"keyboard"</span><span>)]
</span><span>        dispatch_focused_input</span><span style=color:#ed9366>::</span><span>&LTKeyboardInput></span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"gamepad"</span><span>)]
</span><span>        dispatch_focused_input</span><span style=color:#ed9366>::</span><span>&LTGamepadButtonChangedEvent></span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"mouse"</span><span>)]
</span><span>        dispatch_focused_input</span><span style=color:#ed9366>::</span><span>&LTMouseWheel></span><span style=color:#61676ccc>,
</span><span>    )
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>in_set</span><span>(InputFocusSystems</span><span style=color:#ed9366>::</span><span>Dispatch)</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(</span><span style=color:#f29718>any</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"keyboard"</span><span style=color:#61676ccc>,</span><span> feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"gamepad"</span><span style=color:#61676ccc>,</span><span> feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"mouse"</span><span>))]
</span><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(
</span><span>    PreUpdate</span><span style=color:#61676ccc>,
</span><span>    (
</span><span>        </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"keyboard"</span><span>)]
</span><span>        dispatch_focused_input</span><span style=color:#ed9366>::</span><span>&LTKeyboardInput></span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"gamepad"</span><span>)]
</span><span>        dispatch_focused_input</span><span style=color:#ed9366>::</span><span>&LTGamepadButtonChangedEvent></span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"mouse"</span><span>)]
</span><span>        dispatch_focused_input</span><span style=color:#ed9366>::</span><span>&LTMouseWheel></span><span style=color:#61676ccc>,
</span><span>    )
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>in_set</span><span>(InputFocusSystems</span><span style=color:#ed9366>::</span><span>Dispatch)</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><p>The fix works by wrapping the entire <code>app.add_systems</code> call in a conditional compilation block that checks if any of the input features (<code>keyboard</code>, <code>gamepad</code>, or <code>mouse</code>) are enabled. This prevents the creation of an empty system tuple when none of these features are available, which was causing the compilation error.<h2 id=further-reading>Further Reading</h2><ol><li><strong>Rust Conditional Compilation</strong>: The Rust Book section on conditional compilation with <code>#[cfg]</code> attributes: https://doc.rust-lang.org/reference/conditional-compilation.html<li><strong>Bevy Systems and Schedules</strong>: Bevy’s official documentation on systems and scheduling: https://bevyengine.org/learn/quick-start/ecs/system/<li><strong>Bevy Input Handling</strong>: Overview of Bevy’s input handling system: https://bevyengine.org/learn/quick-start/input/<li><strong>Rust Feature Flags</strong>: Cargo documentation on feature flags and conditional compilation: https://doc.rust-lang.org/cargo/reference/features.html<li><strong>Previous PR #22177</strong>: The PR that introduced this regression, which added input focus functionality to Bevy.</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22293.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>