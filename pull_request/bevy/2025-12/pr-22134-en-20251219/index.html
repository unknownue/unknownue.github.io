<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #22134 Move allow unsafe_op_in_unsafe_fn to module level in bevy_ecs
        
    </title><meta content="#22134 Move allow unsafe_op_in_unsafe_fn to module level in bevy_ecs" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-12/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-12-19</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-12/pr-22134-zh-cn-20251219>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>Move allow unsafe_op_in_unsafe_fn to module level in bevy_ecs<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Move allow unsafe_op_in_unsafe_fn to module level in bevy_ecs<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/22134<li><strong>Author</strong>: hymm<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-ECS, C-Code-Quality, S-Ready-For-Final-Review, X-Contentious, D-Straightforward<li><strong>Created</strong>: 2025-12-15T20:17:02Z<li><strong>Merged</strong>: 2025-12-19T01:56:14Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>narrow the scope of the expect unsafe_op_in_unsafe_fn, so we can progressively remove them.</ul><h2 id=testing>Testing</h2><ul><li>cargo check showed no warnings</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a specific code quality issue in the Bevy ECS (Entity Component System) codebase related to unsafe code practices. The core problem was that the <code>#![expect(unsafe_op_in_unsafe_fn)]</code> attribute was applied at the crate root level in <code>bevy_ecs/src/lib.rs</code>, which had the effect of suppressing lint warnings for unsafe operations in unsafe functions across the entire crate. This broad suppression made it difficult to identify and progressively fix individual instances of unsafe code that lacked proper safety documentation.<p>The Rust compiler’s <code>unsafe_op_in_unsafe_fn</code> lint requires that unsafe operations inside unsafe functions must be explicitly wrapped in unsafe blocks with accompanying safety comments. This is a critical safety feature that ensures developers consciously acknowledge and document the unsafe invariants they’re relying on. By suppressing this lint at the crate level, the codebase was missing out on this safety enforcement mechanism.<p>The solution approach was straightforward but methodical: move the <code>expect</code> attribute from the crate root down to specific module files that currently contain unsafe code. This narrows the scope of the suppression to only those modules where unsafe operations are actually present, making it easier to incrementally address each unsafe block. The PR author identified seven key modules that contain unsafe code and added the <code>expect</code> attribute to each one individually.<p>The implementation involved two main changes. First, the crate-level attribute was removed from <code>lib.rs</code>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before in lib.rs:
</span><span style=color:#61676ccc>#!</span><span>[</span><span style=color:#f29718>expect</span><span>(
</span><span>    unsafe_op_in_unsafe_fn</span><span style=color:#61676ccc>,
</span><span>    reason </span><span style=color:#ed9366>= </span><span style=color:#86b300>"See #11590. To be removed once all applicable unsafe code has an unsafe block with a safety comment."
</span><span>)]
</span></code></pre><p>Second, the same attribute was added to each module file that contains unsafe operations:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added to multiple module files:
</span><span style=color:#61676ccc>#!</span><span>[</span><span style=color:#f29718>expect</span><span>(
</span><span>    unsafe_op_in_unsafe_fn</span><span style=color:#61676ccc>,
</span><span>    reason </span><span style=color:#ed9366>= </span><span style=color:#86b300>"See #11590. To be removed once all applicable unsafe code has an unsafe block with a safety comment."
</span><span>)]
</span></code></pre><p>One interesting technical insight from this PR is the approach to incremental safety improvement. By moving from crate-wide suppression to module-specific suppression, the team can now tackle unsafe code cleanup module by module. Each module can have its <code>expect</code> attribute removed once all unsafe operations within that module have been properly annotated with safety comments.<p>An additional change was made in <code>multi_threaded.rs</code> where an unsafe operation was explicitly wrapped in an unsafe block with a detailed safety comment. This demonstrates the pattern that should be followed when eventually removing the <code>expect</code> attributes from modules:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// In multi_threaded.rs:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>expect</span><span>(
</span><span>    clippy::undocumented_unsafe_blocks</span><span style=color:#61676ccc>,
</span><span>    reason </span><span style=color:#ed9366>= </span><span style=color:#86b300>"This actually could result in UB if a system tries to mutate
</span><span style=color:#86b300>    `HotPatchChanges`. We allow this as the resource only exists with the `hotpatching` feature.
</span><span style=color:#86b300>    and `hotpatching` should never be enabled in release."
</span><span>)]
</span><span style=color:#fa6e32>let</span><span> hotpatch_tick </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>unsafe </span><span>{
</span><span>    context
</span><span>        </span><span style=color:#ed9366>.</span><span>environment
</span><span>        </span><span style=color:#ed9366>.</span><span>world_cell
</span><span>        </span><span style=color:#ed9366>.</span><span>get_resource_ref</span><span style=color:#ed9366>::</span><span>&LTHotPatchChanges>()
</span><span>}
</span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|</span><span style=color:#ff8f40>r</span><span>| r</span><span style=color:#ed9366>.</span><span style=color:#f07171>last_changed</span><span>())
</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_or_default</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><p>The impact of these changes is primarily about improving code safety and maintainability. While there are no functional changes or performance improvements, this refactoring sets the stage for more systematic auditing and documentation of unsafe code. It follows the principle of making unsafe operations as explicit and well-documented as possible, which is crucial for a game engine like Bevy where correctness and safety are paramount.<p>The changes also demonstrate good software engineering practices around technical debt management. By referencing issue #11590 in the reason comment, the PR connects this work to a larger initiative to address unsafe code throughout the codebase. This creates traceability and ensures that future contributors understand the context behind these suppressions.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    CRATE_ROOT[bevy_ecs/src/lib.rs] --> REMOVED[Removed crate-wide expect attribute]
</span><span>    
</span><span>    REMOVED --> MODULE1[bundle/mod.rs]
</span><span>    REMOVED --> MODULE2[entity/clone_entities.rs]
</span><span>    REMOVED --> MODULE3[query/mod.rs]
</span><span>    REMOVED --> MODULE4[storage/mod.rs]
</span><span>    REMOVED --> MODULE5[system/system_param.rs]
</span><span>    REMOVED --> MODULE6[world/mod.rs]
</span><span>    
</span><span>    MODULE1 --> ADDED1[Added module-level expect]
</span><span>    MODULE2 --> ADDED2[Added module-level expect]
</span><span>    MODULE3 --> ADDED3[Added module-level expect]
</span><span>    MODULE4 --> ADDED4[Added module-level expect]
</span><span>    MODULE5 --> ADDED5[Added module-level expect]
</span><span>    MODULE6 --> ADDED6[Added module-level expect]
</span><span>    
</span><span>    REMOVED --> MODULE7[schedule/executor/multi_threaded.rs]
</span><span>    MODULE7 --> UNSAFE_BLOCK[Wrapped unsafe operation with explicit block and safety comment]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>crates/bevy_ecs/src/lib.rs</strong> (+0/-5) This file had the crate-wide <code>expect</code> attribute removed. This change enables the <code>unsafe_op_in_unsafe_fn</code> lint for the entire crate, forcing explicit unsafe blocks for unsafe operations.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#61676ccc>#!</span><span>[</span><span style=color:#f29718>expect</span><span>(
</span><span>    unsafe_op_in_unsafe_fn</span><span style=color:#61676ccc>,
</span><span>    reason </span><span style=color:#ed9366>= </span><span style=color:#86b300>"See #11590. To be removed once all applicable unsafe code has an unsafe block with a safety comment."
</span><span>)]
</span><span style=color:#abb0b6;font-style:italic>// After: (attribute removed entirely)
</span></code></pre><p><strong>crates/bevy_ecs/src/bundle/mod.rs</strong> (+5/-0) Added module-level <code>expect</code> attribute to suppress the lint only for this module, which contains unsafe code that needs to be progressively addressed.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added at top of file:
</span><span style=color:#61676ccc>#!</span><span>[</span><span style=color:#f29718>expect</span><span>(
</span><span>    unsafe_op_in_unsafe_fn</span><span style=color:#61676ccc>,
</span><span>    reason </span><span style=color:#ed9366>= </span><span style=color:#86b300>"See #11590. To be removed once all applicable unsafe code has an unsafe block with a safety comment."
</span><span>)]
</span></code></pre><p><strong>crates/bevy_ecs/src/entity/clone_entities.rs</strong> (+5/-0) Similar to bundle module, this file deals with entity cloning operations that involve unsafe memory operations.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added at top of file:
</span><span style=color:#61676ccc>#!</span><span>[</span><span style=color:#f29718>expect</span><span>(
</span><span>    unsafe_op_in_unsafe_fn</span><span style=color:#61676ccc>,
</span><span>    reason </span><span style=color:#ed9366>= </span><span style=color:#86b300>"See #11590. To be removed once all applicable unsafe code has an unsafe block with a safety comment."
</span><span>)]
</span></code></pre><p><strong>crates/bevy_ecs/src/query/mod.rs</strong> (+5/-0) The query system has extensive unsafe code for fast component access and filtering.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added at top of file:
</span><span style=color:#61676ccc>#!</span><span>[</span><span style=color:#f29718>expect</span><span>(
</span><span>    unsafe_op_in_unsafe_fn</span><span style=color:#61676ccc>,
</span><span>    reason </span><span style=color:#ed9366>= </span><span style=color:#86b300>"See #11590. To be removed once all applicable unsafe code has an unsafe block with a safety comment."
</span><span>)]
</span></code></pre><p><strong>crates/bevy_ecs/src/storage/mod.rs</strong> (+5/-0) Storage systems involve low-level memory management and pointer operations that require unsafe code.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added at top of file:
</span><span style=color:#61676ccc>#!</span><span>[</span><span style=color:#f29718>expect</span><span>(
</span><span>    unsafe_op_in_unsafe_fn</span><span style=color:#61676ccc>,
</span><span>    reason </span><span style=color:#ed9366>= </span><span style=color:#86b300>"See #11590. To be removed once all applicable unsafe code has an unsafe block with a safety comment."
</span><span>)]
</span></code></pre><p><strong>crates/bevy_ecs/src/schedule/executor/multi_threaded.rs</strong> (+15/-6) This file shows the pattern for properly handling unsafe operations once the <code>expect</code> attribute is removed. An unsafe block was explicitly added with a safety comment explaining the invariants.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> hotpatch_tick </span><span style=color:#ed9366>=</span><span> context
</span><span>    </span><span style=color:#ed9366>.</span><span>environment
</span><span>    </span><span style=color:#ed9366>.</span><span>world_cell
</span><span>    </span><span style=color:#ed9366>.</span><span>get_resource_ref</span><span style=color:#ed9366>::</span><span>&LTHotPatchChanges>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|</span><span style=color:#ff8f40>r</span><span>| r</span><span style=color:#ed9366>.</span><span style=color:#f07171>last_changed</span><span>())
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_or_default</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> hotpatch_tick </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>unsafe </span><span>{
</span><span>    context
</span><span>        </span><span style=color:#ed9366>.</span><span>environment
</span><span>        </span><span style=color:#ed9366>.</span><span>world_cell
</span><span>        </span><span style=color:#ed9366>.</span><span>get_resource_ref</span><span style=color:#ed9366>::</span><span>&LTHotPatchChanges>()
</span><span>}
</span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|</span><span style=color:#ff8f40>r</span><span>| r</span><span style=color:#ed9366>.</span><span style=color:#f07171>last_changed</span><span>())
</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_or_default</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><p><strong>crates/bevy_ecs/src/system/combinator.rs</strong> (+0/-2) Removed a <code>#![deny(unsafe_op_in_unsafe_fn)]</code> attribute from inside a function since the module-level approach provides better scoping.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before inside function:
</span><span style=color:#61676ccc>#!</span><span>[</span><span style=color:#f29718>deny</span><span>(unsafe_op_in_unsafe_fn)]
</span><span style=color:#abb0b6;font-style:italic>// After: removed entirely
</span></code></pre><p><strong>crates/bevy_ecs/src/system/system_param.rs</strong> (+5/-0) and <strong>crates/bevy_ecs/src/world/mod.rs</strong> (+5/-0) Both modules received the same module-level <code>expect</code> attribute since they contain unsafe system parameter and world manipulation code.<h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/reference/unsafety.html target=_blank>Rust Reference: Unsafe Operations</a> - Official documentation on unsafe Rust<li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/nomicon/ target=_blank>Rustonomicon</a> - The Dark Arts of Unsafe Rust Programming<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/ecs/ target=_blank>Bevy ECS Architecture</a> - Overview of Bevy’s Entity Component System<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/issues/11590 target=_blank>Issue #11590</a> - The tracking issue for unsafe code cleanup in Bevy<li><a rel="noopener nofollow noreferrer" href=https://rust-lang.github.io/rust-clippy/master/#unsafe_op_in_unsafe_fn target=_blank>Rust Clippy Lint: unsafe_op_in_unsafe_fn</a> - Documentation for the lint being addressed</ol><h1 id=full-code-diff>Full Code Diff</h1><details><summary>View full diff</summary> <pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_ecs/src/bundle/mod.rs b/crates/bevy_ecs/src/bundle/mod.rs
</span><span>index b6a81ebd27328..f7cd9996b2853 100644
</span><span style=color:#c594c5>--- a/crates/bevy_ecs/src/bundle/mod.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_ecs/src/bundle/mod.rs
</span><span style=color:#c594c5>@@ -1,3 +1,8 @@
</span><span style=color:#86b300>+#![expect(
</span><span style=color:#86b300>+    unsafe_op_in_unsafe_fn,
</span><span style=color:#86b300>+    reason = "See #11590. To be removed once all applicable unsafe code has an unsafe block with a safety comment."
</span><span style=color:#86b300>+)]
</span><span style=color:#86b300>+
</span><span> //! Types for handling [`Bundle`]s.
</span><span> //!
</span><span> //! This module contains the [`Bundle`] trait and some other helper types.
</span><span>diff --git a/crates/bevy_ecs/src/entity/clone_entities.rs b/crates/bevy_ecs/src/entity/clone_entities.rs
</span><span>index 0f7105e0eb0ce..824775fb7b4b0 100644
</span><span style=color:#c594c5>--- a/crates/bevy_ecs/src/entity/clone_entities.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_ecs/src/entity/clone_entities.rs
</span><span style=color:#c594c5>@@ -1,3 +1,8 @@
</span><span style=color:#86b300>+#![expect(
</span><span style=color:#86b300>+    unsafe_op_in_unsafe_fn,
</span><span style=color:#86b300>+    reason = "See #11590. To be removed once all applicable unsafe code has an unsafe block with a safety comment."
</span><span style=color:#86b300>+)]
</span><span style=color:#86b300>+
</span><span> use crate::{
</span><span>     archetype::Archetype,
</span><span>     bundle::{Bundle, BundleRemover, InsertMode},
</span><span>diff --git a/crates/bevy_ecs/src/lib.rs b/crates/bevy_ecs/src/lib.rs
</span><span>index 4c8763ad66f64..4c336a562bb51 100644
</span><span style=color:#c594c5>--- a/crates/bevy_ecs/src/lib.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_ecs/src/lib.rs
</span><span style=color:#c594c5>@@ -1,7 +1,3 @@
</span><span style=color:#f07171>-#![expect(
</span><span style=color:#f07171>-    unsafe_op_in_unsafe_fn,
</span><span style=color:#f07171>-    reason = "See #11590. To be removed once all applicable unsafe code has an unsafe block with a safety comment."
</span><span style=color:#f07171>-)]
</span><span> #![doc = include_str!("../README.md")]
</span><span> #![cfg_attr(
</span><span>     any(docsrs, docsrs_dep),
</span><span>diff --git a/crates/bevy_ecs/src/query/mod.rs b/crates/bevy_ecs/src/query/mod.rs
</span><span>index b5c1b3d7d18a5..065eadd24db88 100644
</span><span style=color:#c594c5>--- a/crates/bevy_ecs/src/query/mod.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_ecs/src/query/mod.rs
</span><span style=color:#c594c5>@@ -1,3 +1,8 @@
</span><span style=color:#86b300>+#![expect(
</span><span style=color:#86b300>+    unsafe_op_in_unsafe_fn,
</span><span style=color:#86b300>+    reason = "See #11590. To be removed once all applicable unsafe code has an unsafe block with a safety comment."
</span><span style=color:#86b300>+)]
</span><span style=color:#86b300>+
</span><span> //! Contains APIs for retrieving component data from the world.
</span><span> 
</span><span> mod access;
</span><span>diff --git a/crates/bevy_ecs/src/schedule/executor/multi_threaded.rs b/crates/bevy_ecs/src/schedule/executor/multi_threaded.rs
</span><span>index 497b937c31f51..33bc8d0b80079 100644
</span><span style=color:#c594c5>--- a/crates/bevy_ecs/src/schedule/executor/multi_threaded.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_ecs/src/schedule/executor/multi_threaded.rs
</span><span style=color:#c594c5>@@ -448,12 +448,21 @@ </span><span style=color:#399ee6>impl ExecutorState {
</span><span>         }
</span><span> 
</span><span>         #[cfg(feature = "hotpatching")]
</span><span style=color:#f07171>-        let hotpatch_tick = context
</span><span style=color:#f07171>-            .environment
</span><span style=color:#f07171>-            .world_cell
</span><span style=color:#f07171>-            .get_resource_ref::&LTHotPatchChanges>()
</span><span style=color:#f07171>-            .map(|r| r.last_changed())
</span><span style=color:#f07171>-            .unwrap_or_default();
</span><span style=color:#86b300>+        #[expect(
</span><span style=color:#86b300>+            clippy::undocumented_unsafe_blocks,
</span><span style=color:#86b300>+            reason = "This actually could result in UB if a system tries to mutate
</span><span style=color:#86b300>+            `HotPatchChanges`. We allow this as the resource only exists with the `hotpatching` feature.
</span><span style=color:#86b300>+            and `hotpatching` should never be enabled in release."
</span><span style=color:#86b300>+        )]
</span><span style=color:#86b300>+        #[cfg(feature = "hotpatching")]
</span><span style=color:#86b300>+        let hotpatch_tick = unsafe {
</span><span style=color:#86b300>+            context
</span><span style=color:#86b300>+                .environment
</span><span style=color:#86b300>+                .world_cell
</span><span style=color:#86b300>+                .get_resource_ref::&LTHotPatchChanges>()
</span><span style=color:#86b300>+        }
</span><span style=color:#86b300>+        .map(|r| r.last_changed())
</span><span style=color:#86b300>+        .unwrap_or_default();
</span><span> 
</span><span>         // can't borrow since loop mutably borrows `self`
</span><span>         let mut ready_systems = core::mem::take(&mut self.ready_systems_copy);
</span><span>diff --git a/crates/bevy_ecs/src/storage/mod.rs b/crates/bevy_ecs/src/storage/mod.rs
</span><span>index 0584ae15c6738..084cca6bc8396 100644
</span><span style=color:#c594c5>--- a/crates/bevy_ecs/src/storage/mod.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_ecs/src/storage/mod.rs
</span><span style=color:#c594c5>@@ -1,3 +1,8 @@
</span><span style=color:#86b300>+#![expect(
</span><span style=color:#86b300>+    unsafe_op_in_unsafe_fn,
</span><span style=color:#86b300>+    reason = "See #11590. To be removed once all applicable unsafe code has an unsafe block with a safety comment."
</span><span style=color:#86b300>+)]
</span><span style=color:#86b300>+
</span><span> //! Storage layouts for ECS data.
</span><span> //!
</span><span> //! This module implements the low-level collections that store data in a [`World`]. These all offer minimal and often
</span><span>diff --git a/crates/bevy_ecs/src/system/combinator.rs b/crates/bevy_ecs/src/system/combinator.rs
</span><span>index 0ef463fc45e0d..ad10d2ddd8cf6 100644
</span><span style=color:#c594c5>--- a/crates/bevy_ecs/src/system/combinator.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_ecs/src/system/combinator.rs
</span><span style=color:#c594c5>@@ -167,8 +167,6 @@ </span><span style=color:#399ee6>where
</span><span>             input: SystemIn&LTS>,
</span><span>             world: &mut PrivateUnsafeWorldCell,
</span><span>         ) -> Result&LTS::Out, RunSystemError> {
</span><span style=color:#f07171>-            #![deny(unsafe_op_in_unsafe_fn)]
</span><span style=color:#f07171>-
</span><span>             // SAFETY: see comment on `Func::combine` call
</span><span>             match (|| unsafe {
</span><span>                 system.validate_param_unsafe(world.0)?;
</span><span>diff --git a/crates/bevy_ecs/src/system/system_param.rs b/crates/bevy_ecs/src/system/system_param.rs
</span><span>index 16af1523376e4..2a0498ffdcfdc 100644
</span><span style=color:#c594c5>--- a/crates/bevy_ecs/src/system/system_param.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_ecs/src/system/system_param.rs
</span><span style=color:#c594c5>@@ -1,3 +1,8 @@
</span><span style=color:#86b300>+#![expect(
</span><span style=color:#86b300>+    unsafe_op_in_unsafe_fn,
</span><span style=color:#86b300>+    reason = "See #11590. To be removed once all applicable unsafe code has an unsafe block with a safety comment."
</span><span style=color:#86b300>+)]
</span><span style=color:#86b300>+
</span><span> pub use crate::change_detection::{NonSend, NonSendMut, Res, ResMut};
</span><span> use crate::{
</span><span>     archetype::Archetypes,
</span><span>diff --git a/crates/bevy_ecs/src/world/mod.rs b/crates/bevy_ecs/src/world/mod.rs
</span><span>index a4f49c7460a35..3f39865f8f34d 100644
</span><span style=color:#c594c5>--- a/crates/bevy_ecs/src/world/mod.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_ecs/src/world/mod.rs
</span><span style=color:#c594c5>@@ -1,3 +1,8 @@
</span><span style=color:#86b300>+#![expect(
</span><span style=color:#86b300>+    unsafe_op_in_unsafe_fn,
</span><span style=color:#86b300>+    reason = "See #11590. To be removed once all applicable unsafe code has an unsafe block with a safety comment."
</span><span style=color:#86b300>+)]
</span><span style=color:#86b300>+
</span><span> //! Defines the [`World`] and APIs for accessing it directly.
</span><span> 
</span><span> pub(crate) mod command_queue;
</span></code></pre></details></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-12/pr_22134.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>