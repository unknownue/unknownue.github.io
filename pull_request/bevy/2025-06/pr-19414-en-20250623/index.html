<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19414 Let Component::map_entities defer to MapEntities
        
    </title><meta content="#19414 Let Component::map_entities defer to MapEntities" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-06/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-06-23</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-06/pr-19414-zh-cn-20250623>中文</a></div></div><div class=pr-content><h3 id=technical-analysis-of-pr-19414-let-component-map-entities-defer-to-mapentities>Technical Analysis of PR #19414: Let Component::map_entities defer to MapEntities</h3><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Let Component::map_entities defer to MapEntities<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19414<li><strong>Author</strong>: Testare<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-ECS, C-Usability, S-Ready-For-Final-Review, A-Networking, X-Contentious, D-Macros<li><strong>Created</strong>: 2025-05-28T19:13:01Z<li><strong>Merged</strong>: 2025-06-23T21:22:47Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>The objective of this PR is to enable Components to use their <code>MapEntities</code> implementation for <code>Component::map_entities</code>.<p>With the improvements to the entity mapping system, there is definitely a huge reduction in boilerplate. However, especially since <code>(Entity)HashMap<..></code> doesn’t implement <code>MapEntities</code> (I presume because the lack of specialization in rust makes <code>HashMap&LTEntity|X, Entity|X></code> complicated), when somebody has types that contain these hashmaps they can’t use this approach.<p>More so, we can’t even depend on the previous implementation, since <code>Component::map_entities</code> is used instead of <code>MapEntities::map_entities</code>. Outside of implementing <code>Component </code>and <code>Component::map_entities</code> on these types directly, the only path forward is to create a custom type to wrap the hashmaps and implement map entities on that, or split these components into a wrapper type that implement <code>Component</code>, and an inner type that implements <code>MapEntities</code>.<h2 id=current-solution>Current Solution</h2><p>The solution was to allow adding <code>#[component(map_entities)]</code> on the component. By default this will defer to the <code>MapEntities</code> implementation.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>component</span><span>(map_entities)]
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>Inventory </span><span>{
</span><span>    items</span><span style=color:#61676ccc>: </span><span>HashMap&LTEntity, </span><span style=color:#fa6e32>usize</span><span>>
</span><span>}
</span><span>
</span><span style=color:#fa6e32>impl </span><span>MapEntities </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>Inventory </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>map_entities</span><span>&LTM</span><span style=color:#61676ccc>:</span><span> EntityMapper>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>entity_mapper</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> M) {
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>items </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>items
</span><span>           </span><span style=color:#ed9366>.</span><span style=color:#f07171>drain</span><span>()
</span><span>           </span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|(</span><span style=color:#ff8f40>id</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>count</span><span>)|(entity_mapper</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_mapped</span><span>(id)</span><span style=color:#61676ccc>,</span><span> count))
</span><span>           </span><span style=color:#ed9366>.</span><span style=color:#f07171>collect</span><span>()</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span><span>
</span></code></pre><p>You can use <code>#[component(map_entities = &LTfunction path>)]</code> instead to substitute other code in for components. This function can also include generics, but sso far I haven’t been able to find a case where they are needed.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>component</span><span>(map_entities </span><span style=color:#ed9366>=</span><span> map_the_map)]
</span><span style=color:#abb0b6;font-style:italic>// Also works #[component(map_entities = map_the_map::&LTT,_>)]
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>Inventory</span><span>&LTT> {
</span><span>    items</span><span style=color:#61676ccc>: </span><span>HashMap&LTEntity, T>
</span><span>}
</span><span>
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>map_the_map</span><span>&LTT, M</span><span style=color:#61676ccc>:</span><span> EntityMapper>(</span><span style=color:#ff8f40>inv</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span>Inventory&LTT>, </span><span style=color:#ff8f40>entity_mapper</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> M) {
</span><span>    inv</span><span style=color:#ed9366>.</span><span>items </span><span style=color:#ed9366>=</span><span> inv</span><span style=color:#ed9366>.</span><span>items
</span><span>       </span><span style=color:#ed9366>.</span><span style=color:#f07171>drain</span><span>()
</span><span>       </span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|(</span><span style=color:#ff8f40>id</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>count</span><span>)|(entity_mapper</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_mapped</span><span>(id)</span><span style=color:#61676ccc>,</span><span> count))
</span><span>       </span><span style=color:#ed9366>.</span><span style=color:#f07171>collect</span><span>()</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span></code></pre><p>The idea is that with the previous changes to MapEntities, MapEntities is implemented more for entity collections than for Components. If you have a component that makes sense as both, <code>#[component(map_entities)]</code> would work great, while otherwise a component can use <code>#[component(map_entities = &LTfunction>)]</code> to change the behavior of <code>Component::map_entities</code> without opening up the component type to be included in other components.<h2 id=original-solution-if-you-want-to-follow-the-pr>(Original Solution if you want to follow the PR)</h2><p>The solution was to allow adding <code>#[component(entities)]</code> on the component itself to defer to the <code>MapEntities</code> implementation<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>component</span><span>(entities)]
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>Inventory </span><span>{
</span><span>    items</span><span style=color:#61676ccc>: </span><span>HashMap&LTEntity, </span><span style=color:#fa6e32>usize</span><span>>
</span><span>}
</span><span>
</span><span style=color:#fa6e32>impl </span><span>MapEntities </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>Inventory </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>map_entities</span><span>&LTM</span><span style=color:#61676ccc>:</span><span> EntityMapper>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>entity_mapper</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> M) {
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>items </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>items
</span><span>           </span><span style=color:#ed9366>.</span><span style=color:#f07171>drain</span><span>()
</span><span>           </span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|(</span><span style=color:#ff8f40>id</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>count</span><span>)|(entity_mapper</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_mapped</span><span>(id)</span><span style=color:#61676ccc>,</span><span> count))
</span><span>           </span><span style=color:#ed9366>.</span><span style=color:#f07171>collect</span><span>()</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span><span>
</span></code></pre><h2 id=testing>Testing</h2><p>I tested this by patching my local changes into my own bevy project. I had a system that loads a scene file and executes some logic with a Component that contains a <code>HashMap&LTEntity, UVec2></code>, and it panics when Entity is not found from another query. Since the 0.16 update this system has reliably panicked upon attempting to the load the scene.<p>After patching my code in, I added <code>#[component(entities)]</code> to this component, and I was able to successfully load the scene.<p>Additionally, I wrote a doc test.<h2 id=call-outs>Call-outs</h2><h3 id=relationships>Relationships</h3><p>This overrules the default mapping of relationship fields. Anything else seemed more problematic, as you’d have inconsistent behavior between <code>MapEntities</code> and <code>Component</code>.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=the-entity-mapping-challenge>The Entity Mapping Challenge</h3><p>Entity mapping is crucial in Bevy’s ECS for scenarios like scene loading and networking, where entity references need updating when moving between worlds. Before this PR, components containing entity collections like <code>HashMap&LTEntity, T></code> faced a significant hurdle. While Bevy’s <code>MapEntities</code> trait provided entity remapping capabilities, standard collections couldn’t implement it due to Rust’s specialization limitations.<p>This forced workarounds:<ol><li>Manually implement <code>Component::map_entities</code> for each component<li>Create wrapper types for collections<li>Split components into wrapper + inner types</ol><p>All solutions added boilerplate and complexity. The core issue was the disconnect between <code>Component::map_entities</code> (default no-op) and <code>MapEntities::map_entities</code> (customizable mapping logic). There was no straightforward way to connect a component’s <code>MapEntities</code> implementation to its <code>Component</code> behavior.<h3 id=attribute-driven-solution>Attribute-Driven Solution</h3><p>The PR introduces a new <code>#[component(map_entities)]</code> attribute for the <code>Component</code> derive macro. This attribute generates <code>Component::map_entities</code> implementations that delegate to either:<ol><li>The type’s <code>MapEntities</code> implementation (default)<li>A custom function (when using <code>#[component(map_entities = path)]</code>)</ol><p>This approach maintains backward compatibility while solving the entity mapping problem for collection-heavy components. The implementation handles two key cases:<p><strong>Case 1: Default delegation</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>component</span><span>(map_entities)]
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>Inventory </span><span>{
</span><span>    items</span><span style=color:#61676ccc>: </span><span>HashMap&LTEntity, </span><span style=color:#fa6e32>usize</span><span>>
</span><span>}
</span><span>
</span><span style=color:#fa6e32>impl </span><span>MapEntities </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>Inventory </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>map_entities</span><span>&LTM</span><span style=color:#61676ccc>:</span><span> EntityMapper>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>mapper</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> M) {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// Custom mapping logic
</span><span>    }
</span><span>}
</span></code></pre><p>The generated <code>Component::map_entities</code> will call <code>Inventory::map_entities</code> from the <code>MapEntities</code> implementation.<p><strong>Case 2: Custom mapping function</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>component</span><span>(map_entities </span><span style=color:#ed9366>=</span><span> map_the_map)]
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>Inventory</span><span>&LTT> {
</span><span>    items</span><span style=color:#61676ccc>: </span><span>HashMap&LTEntity, T>
</span><span>}
</span><span>
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>map_the_map</span><span>&LTT, M</span><span style=color:#61676ccc>:</span><span> EntityMapper>(</span><span style=color:#ff8f40>inv</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span>Inventory&LTT>, </span><span style=color:#ff8f40>mapper</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> M) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Custom mapping logic
</span><span>}
</span></code></pre><p>This allows using generic functions for components with type parameters.<h3 id=implementation-mechanics>Implementation Mechanics</h3><p>The solution required modifications across Bevy’s ECS macros and component systems:<ol><li><p><strong>Attribute Parsing</strong>: Added <code>MAP_ENTITIES</code> constant and <code>MapEntitiesAttributeKind</code> enum to handle:</p> <ul><li><code>#[component(map_entities)]</code> (default delegation)<li><code>#[component(map_entities = path)]</code> (custom function)</ul><li><p><strong>Code Generation</strong>: Updated macro logic to generate appropriate delegation code:</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(map_entities_override) </span><span style=color:#ed9366>=</span><span> map_entities_attr {
</span><span>    </span><span style=color:#fa6e32>let</span><span> map_entities_tokens </span><span style=color:#ed9366>=</span><span> map_entities_override</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_token_stream</span><span>(bevy_ecs_path)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>return </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#f07171>quote!</span><span>(
</span><span>        </span><span style=color:#ed9366>#</span><span style=color:#f07171>map_entities_tokens</span><span>(</span><span style=color:#ed9366>#</span><span>self_ident</span><span style=color:#61676ccc>,</span><span> mapper)
</span><span>    ))</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre> <p>This generates either a trait method call or function invocation.</p><li><p><strong>Documentation</strong>: Added comprehensive docs showing both usage patterns with practical examples.</p></ol><h3 id=technical-tradeoffs>Technical Tradeoffs</h3><p>The implementation makes a deliberate choice to prioritize consistency over specialization. When both relationship attributes (<code>entities</code>) and <code>map_entities</code> are present, the latter takes precedence. This ensures components behave consistently whether mapped through <code>MapEntities</code> or <code>Component</code> traits. The alternative—maintaining separate code paths—would introduce behavioral inconsistencies.<h3 id=validation-and-impact>Validation and Impact</h3><p>The author validated the solution through:<ol><li>Real-world testing with scene loading systems<li>Documentation tests showing both attribute usages<li>Maintaining existing test coverage</ol><p>The change significantly reduces boilerplate for components containing entity collections. Users can now directly leverage <code>MapEntities</code> implementations through a simple attribute, eliminating wrapper types and manual delegation code. This is particularly valuable for networking and scene systems where entity remapping is frequent.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Component Derive Macro] --> B[Parse map_entities attribute]
</span><span>    B --> C{Attribute Type}
</span><span>    C --> D[Default: MapEntities impl]
</span><span>    C --> E[Custom: Function call]
</span><span>    D --> F[Generate trait delegation]
</span><span>    E --> G[Generate function call]
</span><span>    F --> H[Component::map_entities]
</span><span>    G --> H
</span><span>    H --> I[Entity Mapping Logic]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=1-crates-bevy-ecs-macros-src-component-rs>1. <code>crates/bevy_ecs/macros/src/component.rs</code></h3><p>Added attribute parsing and code generation for <code>map_entities</code>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub const </span><span style=color:#ff8f40>MAP_ENTITIES</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>str </span><span style=color:#ed9366>= </span><span style=color:#86b300>"map_entities"</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Debug)]
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>super</span><span>) </span><span style=color:#fa6e32>enum </span><span style=color:#399ee6>MapEntitiesAttributeKind </span><span>{
</span><span>    Path(ExprPath)</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Default</span><span style=color:#61676ccc>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Added to Attrs struct:
</span><span>map_entities</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTMapEntitiesAttributeKind></span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// In parse_component_attr:
</span><span>} </span><span style=color:#fa6e32>else if</span><span> nested</span><span style=color:#ed9366>.</span><span>path</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_ident</span><span>(</span><span style=color:#ff8f40>MAP_ENTITIES</span><span>) {
</span><span>    attrs</span><span style=color:#ed9366>.</span><span>map_entities </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(nested</span><span style=color:#ed9366>.</span><span>input</span><span style=color:#ed9366>.</span><span>parse</span><span style=color:#ed9366>::</span><span>&LTMapEntitiesAttributeKind>()</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(())
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// In map_entities function:
</span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(map_entities_override) </span><span style=color:#ed9366>=</span><span> map_entities_attr {
</span><span>    </span><span style=color:#fa6e32>let</span><span> map_entities_tokens </span><span style=color:#ed9366>=</span><span> map_entities_override</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_token_stream</span><span>(bevy_ecs_path)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>return </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#f07171>quote!</span><span>(
</span><span>        </span><span style=color:#ed9366>#</span><span style=color:#f07171>map_entities_tokens</span><span>(</span><span style=color:#ed9366>#</span><span>self_ident</span><span style=color:#61676ccc>,</span><span> mapper)
</span><span>    ))</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=2-crates-bevy-ecs-src-component-rs>2. <code>crates/bevy_ecs/src/component.rs</code></h3><p>Updated documentation with usage examples:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>/// You might need more specialized logic... you can annotate your component with
</span><span style=color:#abb0b6;font-style:italic>/// `#[component(map_entities)]`.
</span><span style=color:#abb0b6;font-style:italic>///
</span><span style=color:#abb0b6;font-style:italic>/// ```
</span><span style=color:#abb0b6;font-style:italic>/// #[derive(Component)]
</span><span style=color:#abb0b6;font-style:italic>/// #[component(map_entities)]
</span><span style=color:#abb0b6;font-style:italic>/// struct Inventory {
</span><span style=color:#abb0b6;font-style:italic>///     items: HashMap&LTEntity, usize>
</span><span style=color:#abb0b6;font-style:italic>/// }
</span><span style=color:#abb0b6;font-style:italic>/// 
</span><span style=color:#abb0b6;font-style:italic>/// impl MapEntities for Inventory {
</span><span style=color:#abb0b6;font-style:italic>///   fn map_entities&LTM: EntityMapper>(&mut self, entity_mapper: &mut M) {
</span><span style=color:#abb0b6;font-style:italic>///      // ...
</span><span style=color:#abb0b6;font-style:italic>///   }
</span><span style=color:#abb0b6;font-style:italic>/// }
</span><span style=color:#abb0b6;font-style:italic>/// ```
</span><span style=color:#abb0b6;font-style:italic>///
</span><span style=color:#abb0b6;font-style:italic>/// Alternatively, you can specify the path to a function...
</span><span style=color:#abb0b6;font-style:italic>/// ```
</span><span style=color:#abb0b6;font-style:italic>/// #[derive(Component)]
</span><span style=color:#abb0b6;font-style:italic>/// #[component(map_entities = map_the_map)]
</span><span style=color:#abb0b6;font-style:italic>/// struct Inventory {
</span><span style=color:#abb0b6;font-style:italic>///     items: HashMap&LTEntity, usize>
</span><span style=color:#abb0b6;font-style:italic>/// }
</span><span style=color:#abb0b6;font-style:italic>/// 
</span><span style=color:#abb0b6;font-style:italic>/// fn map_the_map&LTM: EntityMapper>(inv: &mut Inventory, entity_mapper: &mut M) {
</span><span style=color:#abb0b6;font-style:italic>///    // ...
</span><span style=color:#abb0b6;font-style:italic>/// }
</span><span style=color:#abb0b6;font-style:italic>/// ```
</span></code></pre><h3 id=3-crates-bevy-ecs-macros-src-lib-rs>3. <code>crates/bevy_ecs/macros/src/lib.rs</code></h3><p>Updated derive macro for consistency:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let</span><span> map_entities_impl </span><span style=color:#ed9366>= </span><span style=color:#f07171>map_entities</span><span>(
</span><span>    </span><span style=color:#ed9366>&</span><span>ast</span><span style=color:#ed9366>.</span><span>data</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#ed9366>&</span><span>ecs_path</span><span style=color:#61676ccc>,
</span><span>    Ident</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#86b300>"self"</span><span style=color:#61676ccc>, </span><span>Span</span><span style=color:#ed9366>::</span><span>call_site())</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#ff8f40>false</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#ff8f40>false</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#55b4d4;font-style:italic>None</span><span style=color:#61676ccc>,  </span><span style=color:#abb0b6;font-style:italic>// Added parameter
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_ecs/latest/bevy_ecs/component/trait.Component.html target=_blank>Bevy ECS Component Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/features/scenes.html#entity-mapping target=_blank>Entity Mapping in ECS Systems</a><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/reference/attributes.html target=_blank>Rust Attribute Macros</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-06/pr_19414.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>