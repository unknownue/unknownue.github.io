<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19705 Revert "bevy_log: refactor how log layers are wired together (#19248)"
        
    </title><meta content='#19705 Revert "bevy_log: refactor how log layers are wired together (#19248)"' property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-06/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-06-17</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-06/pr-19705-zh-cn-20250617>中文</a></div></div><div class=pr-content><h2 id=revert-bevy-log-refactor-how-log-layers-are-wired-together-19248>Revert “bevy_log: refactor how log layers are wired together (#19248)”</h2><h3 id=basic-information>Basic Information</h3><ul><li><strong>Title</strong>: Revert “bevy_log: refactor how log layers are wired together (#19248)”<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19705<li><strong>Author</strong>: alice-i-cecile<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, D-Trivial, S-Ready-For-Final-Review, P-Critical, A-Diagnostics<li><strong>Created</strong>: 2025-06-17T20:17:23Z<li><strong>Merged</strong>: 2025-06-17T21:01:03Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h3 id=description-translation>Description Translation</h3><p>This reverts commit 8661e914a57d4e5c8bec20f0a840041c0e8aea25, aka #19248.<p>Fixes #19689.<h3 id=the-story-of-this-pull-request>The Story of This Pull Request</h3><p>The problem arose when PR #19248 refactored Bevy’s logging layer wiring. This change introduced a regression where iOS logging stopped functioning entirely (#19689). Since iOS is a supported platform and logging is critical for debugging, this was a high-priority issue requiring immediate resolution.<p>The solution approach was straightforward: revert the problematic commit to restore the previous working implementation. Given the severity of the regression and time constraints, this was deemed the most efficient way to resolve the issue while maintaining stability. The alternative would have been to debug and fix the new implementation, but with the root cause not immediately obvious, reverting provided a faster path to restore functionality.<p>The implementation reverts two main changes:<ol><li>The core logging infrastructure in <code>bevy_log</code><li>The log layers example that depended on the refactored API</ol><p>Before the revert, the logging system used a vector-based approach to combine layers:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let mut</span><span> layers</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Vec</span><span>&LTBoxedLayer> </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>Vec</span><span style=color:#ed9366>::</span><span>new()</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// ... populate layers ...
</span><span style=color:#fa6e32>let</span><span> subscriber </span><span style=color:#ed9366>= </span><span>Registry</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#ed9366>.</span><span style=color:#f07171>with</span><span>(layers)</span><span style=color:#61676ccc>;
</span></code></pre><p>After reverting, we return to the previous method of chaining layers:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let</span><span> subscriber </span><span style=color:#ed9366>= </span><span>Registry</span><span style=color:#ed9366>::</span><span>default()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>with</span><span>(custom_layer)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>with</span><span>(filter_layer)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>with</span><span>(error_layer)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>with</span><span>(fmt_layer)</span><span style=color:#61676ccc>;
</span></code></pre><p>This change restores iOS logging by preserving the platform-specific layer handling that was removed in #19248. The key technical insight is that the vector-based approach didn’t properly handle platform-specific layer composition, particularly the iOS-specific <code>tracing_oslog::OsLogger</code> integration.<p>The impact is immediate restoration of iOS logging functionality without changing other platforms’ behavior. This revert maintains the previous architecture’s trade-offs: while slightly more verbose, it’s proven stable across all targets. Future improvements to layer composition should include comprehensive platform testing before merging.<h3 id=visual-representation>Visual Representation</h3><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Log Initialization] --> B[Platform Detection]
</span><span>    B --> C{Wasm?}
</span><span>    C -->|Yes| D[WASMLayer]
</span><span>    C -->|No| E{Android?}
</span><span>    E -->|Yes| F[AndroidLayer]
</span><span>    E -->|No| G{iOS?}
</span><span>    G -->|Yes| H[OsLogger]
</span><span>    G -->|No| I[FmtLayer]
</span></code></pre><h3 id=key-files-changed>Key Files Changed</h3><ol><li><code>crates/bevy_log/src/lib.rs</code> <ul><li>Reverted layer composition to chained <code>with()</code> calls<li>Restored platform-specific layer handling<li>Fixed iOS logging regression</ul></ol><p>Before:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let mut</span><span> layers</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Vec</span><span>&LTBoxedLayer> </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>Vec</span><span style=color:#ed9366>::</span><span>new()</span><span style=color:#61676ccc>;
</span><span>layers</span><span style=color:#ed9366>.</span><span style=color:#f07171>push</span><span>(</span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>build_filter_layer(</span><span style=color:#ed9366>...</span><span>))</span><span style=color:#61676ccc>;
</span><span>layers</span><span style=color:#ed9366>.</span><span style=color:#f07171>push</span><span>(</span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>build_system_output_layer(</span><span style=color:#ed9366>...</span><span>))</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> subscriber </span><span style=color:#ed9366>= </span><span>Registry</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#ed9366>.</span><span style=color:#f07171>with</span><span>(layers)</span><span style=color:#61676ccc>;
</span></code></pre><p>After:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let</span><span> subscriber </span><span style=color:#ed9366>= </span><span>Registry</span><span style=color:#ed9366>::</span><span>default()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>with</span><span>(custom_layer)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>with</span><span>(filter_layer)</span><span style=color:#61676ccc>;
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"trace"</span><span>)]
</span><span style=color:#fa6e32>let</span><span> subscriber </span><span style=color:#ed9366>=</span><span> subscriber</span><span style=color:#ed9366>.</span><span style=color:#f07171>with</span><span>(tracing_error</span><span style=color:#ed9366>::</span><span>ErrorLayer</span><span style=color:#ed9366>::</span><span>default())</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> subscriber </span><span style=color:#ed9366>=</span><span> subscriber</span><span style=color:#ed9366>.</span><span style=color:#f07171>with</span><span>(fmt_layer)</span><span style=color:#61676ccc>;
</span></code></pre><ol start=2><li><code>examples/app/log_layers.rs</code> <ul><li>Updated type signature to match original API<li>Removed unnecessary boxing</ul></ol><p>Before:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>fn </span><span style=color:#f29718>fmt_layer</span><span>(</span><span style=color:#ff8f40>_app</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> App) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTBoxedLayer> {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(
</span><span>        Layer</span><span style=color:#ed9366>::</span><span>default()
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>without_time</span><span>()
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>boxed</span><span>()
</span><span>    )
</span><span>}
</span></code></pre><p>After:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>fn </span><span style=color:#f29718>fmt_layer</span><span>(</span><span style=color:#ff8f40>_app</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> App) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTBoxedFmtLayer> {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#55b4d4;font-style:italic>Box</span><span style=color:#ed9366>::</span><span>new(
</span><span>        Layer</span><span style=color:#ed9366>::</span><span>default()
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>without_time</span><span>()
</span><span>    ))
</span><span>}
</span></code></pre><h3 id=further-reading>Further Reading</h3><ol><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/tracing-subscriber/latest/tracing_subscriber/layer/index.html#composing-layers target=_blank>tracing_subscriber Layering Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/discussions/19529 target=_blank>Bevy Logging Architecture Discussion</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/issues/19689 target=_blank>iOS Logging Issue #19689</a></ol><h3 id=full-code-diff>Full Code Diff</h3><details><summary>View full diff</summary> <pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_log/src/lib.rs b/crates/bevy_log/src/lib.rs
</span><span>index c0ad83468d8b1..7a80a21cc3ade 100644
</span><span style=color:#c594c5>--- a/crates/bevy_log/src/lib.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_log/src/lib.rs
</span><span style=color:#c594c5>@@ -56,6 +56,7 @@ </span><span style=color:#399ee6>use bevy_app::{App, Plugin};
</span><span> use tracing_log::LogTracer;
</span><span> use tracing_subscriber::{
</span><span>     filter::{FromEnvError, ParseError},
</span><span style=color:#86b300>+    layer::Layered,
</span><span>     prelude::*,
</span><span>     registry::Registry,
</span><span>     EnvFilter, Layer,
</span><span style=color:#c594c5>@@ -83,8 +84,6 @@ </span><span style=color:#399ee6>pub(crate) struct FlushGuard(SyncCell&LTtracing_chrome::FlushGuard>);
</span><span> ///   logging to `stdout`.
</span><span> /// * Using [`android_log-sys`](https://crates.io/crates/android_log-sys) on Android,
</span><span> ///   logging to Android logs.
</span><span style=color:#f07171>-/// * Using [`tracing_oslog`](https://crates.io/crates/tracing_oslog) on iOS,
</span><span style=color:#f07171>-///   logging to iOS logs.
</span><span> /// * Using [`tracing-wasm`](https://crates.io/crates/tracing-wasm) in Wasm, logging
</span><span> ///   to the browser console.
</span><span> ///
</span><span style=color:#c594c5>@@ -255,15 +254,26 @@ </span><span style=color:#399ee6>pub struct LogPlugin {
</span><span>     /// timestamp from the log output.
</span><span>     ///
</span><span>     /// Please see the `examples/log_layers.rs` for a complete example.
</span><span style=color:#f07171>-    ///
</span><span style=color:#f07171>-    /// Note that this field has no effect when `os_target` is `android`, `ios` or `wasm`, as on those
</span><span style=color:#f07171>-    /// platforms we don't use [`tracing_subscriber::fmt::Layer`] but rather the platform default.
</span><span style=color:#f07171>-    pub fmt_layer: fn(app: &mut App) -> Option&LTBoxedLayer>,
</span><span style=color:#86b300>+    pub fmt_layer: fn(app: &mut App) -> Option&LTBoxedFmtLayer>,
</span><span> }
</span><span> 
</span><span> /// A boxed [`Layer`] that can be used with [`LogPlugin::custom_layer`].
</span><span> pub type BoxedLayer = Box&LTdyn Layer&LTRegistry> + Send + Sync + 'static>;
</span><span> 
</span><span style=color:#86b300>+#[cfg(feature = "trace")]
</span><span style=color:#86b300>+type BaseSubscriber =
</span><span style=color:#86b300>+    Layered&LTEnvFilter, Layered&LTOption&LTBox&LTdyn Layer&LTRegistry> + Send + Sync>>, Registry>>;
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+#[cfg(feature = "trace")]
</span><span style=color:#86b300>+type PreFmtSubscriber = Layered&LTtracing_error::ErrorLayer&LTBaseSubscriber>, BaseSubscriber>;
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+#[cfg(not(feature = "trace"))]
</span><span style=color:#86b300>+type PreFmtSubscriber =
</span><span style=color:#86b300>+    Layered&LTEnvFilter, Layered&LTOption&LTBox&LTdyn Layer&LTRegistry> + Send + Sync>>, Registry>>;
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+/// A boxed [`Layer`] that can be used with [`LogPlugin::fmt_layer`].
</span><span style=color:#86b300>+pub type BoxedFmtLayer = Box&LTdyn Layer&LTPreFmtSubscriber> + Send + Sync + 'static>;
</span><span style=color:#86b300>+
</span><span> /// The default [`LogPlugin`] [`EnvFilter`].
</span><span> pub const DEFAULT_FILTER: &str = "wgpu=error,naga=warn";
</span><span> 
</span><span style=color:#c594c5>@@ -290,25 +300,30 @@ </span><span style=color:#399ee6>impl Plugin for LogPlugin {
</span><span>             }));
</span><span>         }
</span><span> 
</span><span style=color:#f07171>-        // We use a Vec of BoxedLayer instead of adding each layer individually using the
</span><span style=color:#f07171>-        // `layer.with(next_layer)`.
</span><span style=color:#f07171>-        // Otherwise, the types of each successive layer becomes unwieldy,
</span><span style=color:#f07171>-        // as the type of each new layer would depend on the types of the previous layers.
</span><span style=color:#f07171>-        let mut layers: Vec&LTBoxedLayer> = Vec::new();
</span><span style=color:#f07171>-
</span><span style=color:#f07171>-        // Add optional layer provided by user
</span><span style=color:#f07171>-        // As they are added first, any of the following layers won't be applied.
</span><span style=color:#f07171>-        // In particular, it won't be affected by the filtering we put in place next.
</span><span style=color:#f07171>-        if let Some(layer) = (self.custom_layer)(app) {
</span><span style=color:#f07171>-            layers.push(layer);
</span><span style=color:#f07171>-        }
</span><span style=color:#86b300>+        let finished_subscriber;
</span><span style=color:#86b300>+        let subscriber = Registry::default();
</span><span> 
</span><span style=color:#f07171>-        layers.push(Self::build_filter_layer(self.level, &self.filter));
</span><span style=color:#86b300>+        // add optional layer provided by user
</span><span style=color:#86b300>+        let subscriber = subscriber.with((self.custom_layer)(app));
</span><span> 
</span><span style=color:#f07171>-        #[cfg(feature = "trace")]
</span><span style=color:#f07171>-        layers.push(tracing_error::ErrorLayer::default().boxed());
</span><span style=color:#86b300>+        let default_filter = { format!("{},{}", self.level, self.filter) };
</span><span style=color:#86b300>+        let filter_layer = EnvFilter::try_from_default_env()
</span><span style=color:#86b300>+            .or_else(|from_env_error| {
</span><span style=color:#86b300>+                _ = from_env_error
</span><span style=color:#86b300>+                    .source()
</span><span style=color:#86b300>+                    .and_then(|source| source.downcast_ref::&LTParseError>())
</span><span style=color:#86b300>+                    .map(|parse_err| {
</span><span style=color:#86b300>+                        // we cannot use the `error!` macro here because the logger is not ready yet.
</span><span style=color:#86b300>+                        eprintln!("LogPlugin failed to parse filter from env: {}", parse_err);
</span><span style=color:#86b300>+                    });
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+                Ok::&LTEnvFilter, FromEnvError>(EnvFilter::builder().parse_lossy(&default_filter))
</span><span style=color:#86b300>+            })
</span><span style=color:#86b300>+            .unwrap();
</span><span style=color:#86b300>+        let subscriber = subscriber.with(filter_layer);
</span><span> 
</span><span style=color:#f07171>-        layers.push(Self::build_system_output_layer((self.fmt_layer)(app)));
</span><span style=color:#86b300>+        #[cfg(feature = "trace")]
</span><span style=color:#86b300>+        let subscriber = subscriber.with(tracing_error::ErrorLayer::default());
</span><span> 
</span><span>         #[cfg(all(
</span><span>             not(target_arch = "wasm32"),
</span><span style=color:#c594c5>@@ -317,136 +332,84 @@ </span><span style=color:#399ee6>impl Plugin for LogPlugin {
</span><span>         ))]
</span><span>         {
</span><span>             #[cfg(feature = "tracing-chrome")]
</span><span style=color:#f07171>-            {
</span><span style=color:#f07171>-                let (chrome_layer, guard) = Self::build_chrome_layer();
</span><span style=color:#86b300>+            let chrome_layer = {
</span><span style=color:#86b300>+                let mut layer = tracing_chrome::ChromeLayerBuilder::new();
</span><span style=color:#86b300>+                if let Ok(path) = std::env::var("TRACE_CHROME") {
</span><span style=color:#86b300>+                    layer = layer.file(path);
</span><span style=color:#86b300>+                }
</span><span style=color:#86b300>+                let (chrome_layer, guard) = layer
</span><span style=color:#86b300>+                    .name_fn(Box::new(|event_or_span| match event_or_span {
</span><span style=color:#86b300>+                        tracing_chrome::EventOrSpan::Event(event) => event.metadata().name().into(),
</span><span style=color:#86b300>+                        tracing_chrome::EventOrSpan::Span(span) => {
</span><span style=color:#86b300>+                            if let Some(fields) =
</span><span style=color:#86b300>+                                span.extensions().get::&LTFormattedFields&LTDefaultFields>>()
</span><span style=color:#86b300>+                            {
</span><span style=color:#86b300>+                                format!("{}: {}", span.metadata().name(), fields.fields.as_str())
</span><span style=color:#86b300>+                            } else {
</span><span style=color:#86b300>+                                span.metadata().name().into()
</span><span style=color:#86b300>+                            }
</span><span style=color:#86b300>+                        }
</span><span style=color:#86b300>+                    }))
</span><span style=color:#86b300>+                    .build();
</span><span>                 app.insert_resource(FlushGuard(SyncCell::new(guard));
</span><span style=color:#f07171>-                layers.push(chrome_layer);
</span><span style=color:#f07171>-            }
</span><span style=color:#f07171>-            #[cfg(feature = "tracing-tracy")]
</span><span style=color:#f07171>-            layers.push(tracing_tracy::TracyLayer::default().boxed());
</span><span style=color:#f07171>-        }
</span><span style=color:#86b300>+                chrome_layer
</span><span style=color:#86b300>+            };
</span><span> 
</span><span style=color:#f07171>-        let subscriber = Registry::default().with(layers);
</span><span style=color:#f07171>-
</span><span style=color:#f07171>-        let logger_already_set = LogTracer::init().is_err();
</span><span style=color:#f07171>-        let subscriber_already_set = tracing::subscriber::set_global_default(subscriber).is_err();
</span><span style=color:#f07171>-
</span><span style=color:#f07171>-        match (logger_already_set, subscriber_already_set) {
</span><span style=color:#f07171>-            (true, true) => error!(
</span><span style=color:#f07171>-                "Could not set global logger and tracing subscriber as they are already set. Consider disabling LogPlugin."
</span><span style=color:#f07171>-            ),
</span><span style=color:#f07171>-            (true, false) => error!("Could not set global logger as it is already set. Consider disabling LogPlugin."),
</span><span style=color:#f07171>-            (false, true) => error!("Could not set global tracing subscriber as it is already set. Consider disabling LogPlugin."),
</span><span style=color:#f07171>-            (false, false) => (),
</span><span style=color:#f07171>-        }
</span><span style=color:#f07171>-    }
</span><span style=color:#f07171>-}
</span><span style=color:#86b300>+            #[cfg(feature = "tracing-tracy")]
</span><span style=color:#86b300>+            let tracy_layer = tracing_tracy::TracyLayer::default();
</span><span> 
</span><span style=color:#f07171>-impl LogPlugin {
</span><span style=color:#f07171>-    /// Build a [`BoxedLayer`] that will filter which logs are outputted.
</span><span style=color:#f07171>-    /// It will read the `RUST_LOG` env variable to override the settings
</span><span style=color:#f07171>-    /// on a given run, the default will fallback to the provided `level` and `filter`
</span><span style=color:#f07171>-    fn build_filter_layer(level: Level, filter: &str) -> BoxedLayer {
</span><span style=color:#f07171>-        let default_filter = { format!("{},{}", level, filter) };
</span><span style=color:#86b300>+            let fmt_layer = (self.fmt_layer)(app).unwrap_or_else(|| {
</span><span style=color:#86b300>+                // note: the implementation of `Default` reads from the env var NO_COLOR
</span><span style=color:#86b300>+                // to decide whether to use ANSI color codes, which is common convention
</span><span style=color:#86b300>+                // https://no-color.org/
</span><span style=color:#86b300>+                Box::new(tracing_subscriber::fmt::Layer::default().with_writer(std::io::stderr))
</span><span style=color:#86b300>+            });
</span><span> 
</span><span style=color:#f07171>-        EnvFilter::try_from_default_env()
</span><span style=color:#f07171>-            .or_else(|from_env_error| {
</span><span style=color:#f07171>-                _ = from_env_error
</span><span style=color:#f07171>-                    .source()
</span><span style=color:#f07171>-                    .and_then(|source| source.downcast_ref::&LTParseError>())
</span><span style=color:#f07171>-                    .map(|parse_err| {
</span><span style=color:#f07171>-                        #[expect(
</span><span style=color:#f07171>-                            clippy::print_stderr,
</span><span style=color:#f07171>-                            reason = "We cannot use the `error!` macro here because the logger is not ready yet."
</span><span style=color:#f07171>-                        )]
</span><span style=color:#f07171>-                        {
</span><span style=color:#f07171>-                        eprintln!("LogPlugin failed to parse filter from env: {}", parse_err);
</span><span style=color:#f07171>-                        }
</span><span style=color:#f07171>-                    });
</span><span style=color:#86b300>+            // bevy_render::renderer logs a `tracy.frame_mark` event every frame
</span><span style=color:#86b300>+            // at Level::INFO. Formatted logs should omit it.
</span><span style=color:#86b300>+            #[cfg(feature = "tracing-tracy")]
</span><span style=color:#86b300>+            let fmt_layer =
</span><span style=color:#86b300>+                fmt_layer.with_filter(tracing_subscriber::filter::FilterFn::new(|meta| {
</span><span style=color:#86b300>+                    meta.fields().field("tracy.frame_mark").is_none()
</span><span style=color:#86b300>+                }));
</span><span> 
</span><span style=color:#f07171>-                Ok::&LTEnvFilter, FromEnvError>(EnvFilter::builder().parse_lossy(&default_filter))
</span><span style=color:#f07171>-            })
</span><span style=color:#f07171>-            .unwrap().boxed()
</span><span style=color:#f07171>-    }
</span><span style=color:#86b300>+            let subscriber = subscriber.with(fmt_layer);
</span><span> 
</span><span style=color:#f07171>-    #[cfg(feature = "tracing-chrome")]
</span><span style=color:#f07171>-    /// [`BoxedLayer`] to build the necessary output when the `tracing-chrome` feature is enabled.
</span><span style=color:#f07171>-    /// The [`tracing_chrome::FlushGuard`] must be kept around till we don't need to output logs
</span><span style=color:#f07171>-    /// any more
</span><span style=color:#f07171>-    fn build_chrome_layer() -> (BoxedLayer, tracing_chrome::FlushGuard) {
</span><span style=color:#f07171>-        let mut layer = tracing_chrome::ChromeLayerBuilder::new();
</span><span style=color:#f07171>-        if let Ok(path) = std::env::var("TRACE_CHROME") {
</span><span style=color:#f07171>-            layer = layer.file(path);
</span><span style=color:#86b300>+            #[cfg(feature = "tracing-chrome")]
</span><span style=color:#86b300>+            let subscriber = subscriber.with(chrome_layer);
</span><span style=color:#86b300>+            #[cfg(feature = "tracing-tracy")]
</span><span style=color:#86b300>+            let subscriber = subscriber.with(tracy_layer);
</span><span style=color:#86b300>+            finished_subscriber = subscriber;
</span><span>         }
</span><span style=color:#f07171>-        let (chrome_layer, guard) = layer
</span><span style=color:#f07171>-            .name_fn(Box::new(|event_or_span| match event_or_span {
</span><span style=color:#f07171>-                tracing_chrome::EventOrSpan::Event(event) => event.metadata().name().into(),
</span><span style=color:#f07171>-                tracing_chrome::EventOrSpan::Span(span) => {
</span><span style=color:#f07171>-                    if let Some(fields) = span.extensions().get::&LTFormattedFields&LTDefaultFields>>()
</span><span style=color:#f07171>-                    {
</span><span style=color:#f07171>-                        format!("{}: {}", span.metadata().name(), fields.fields.as_str())
</span><span style=color:#f07171>-                    } else {
</span><span style=color:#f07171>-                        span.metadata().name().into()
</span><span style=color:#f07171>-                    }
</span><span style=color:#f07171>-                }
</span><span style=color:#f07171>-            }))
</span><span style=color:#f07171>-            .build();
</span><span style=color:#f07171>-        (chrome_layer.boxed(), guard)
</span><span style=color:#f07171>-    }
</span><span> 
</span><span style=color:#f07171>-    #[expect(
</span><span style=color:#f07171>-        clippy::allow_attributes,
</span><span style=color:#f07171>-        reason = "We can't switch to `expect` for allow(unused_variables) as we use it if not on those platforms"
</span><span style=color:#f07171>-    )]
</span><span style=color:#f07171>-    #[allow(unused_variables, reason = "Not used on `wasm32`, `android` or `ios")]
</span><span style=color:#f07171>-    /// Build a [`BoxedLayer`] that outputs logs to the system default.
</span><span style=color:#f07171>-    /// On most platforms, it will be `stderr` with [`tracing_subscriber::fmt::Layer`], expect on `android`, `ios` and` wasm32` where it
</span><span style=color:#f07171>-    /// uses those system default log infrastructure.
</span><span style=color:#f07171>-    /// It is possible to override how you output those logs by providing a `custom_format_layer`.
</span><span style=color:#f07171>-    /// Note that won't have an effect on platform that don't use [`tracing_subscriber::fmt::Layer`]
</span><span style=color:#f07171>-    fn build_system_output_layer(custom_format_layer: Option&LTBoxedLayer>) -> BoxedLayer {
</span><span style=color:#f07171>-        let layer: BoxedLayer;
</span><span>         #[cfg(target_arch = "wasm32")]
</span><span>         {
</span><span style=color:#f07171>-            layer = tracing_wasm::WASMLayer::new(tracing_wasm::WASMLayerConfig::default()).boxed();
</span><span style=color:#86b300>+            finished_subscriber = subscriber.with(tracing_wasm::WASMLayer::new(
</span><span style=color:#86b300>+                tracing_wasm::WASMLayerConfig::default(),
</span><span style=color:#86b300>+            ));
</span><span>         }
</span><span> 
</span><span>         #[cfg(target_os = "android")]
</span><span>         {
</span><span style=color:#f07171>-            layer = android_tracing::AndroidLayer::default().boxed();
</span><span style=color:#86b300>+            finished_subscriber = subscriber.with(android_tracing::AndroidLayer::default());
</span><span>         }
</span><span> 
</span><span>         #[cfg(target_os = "ios")]
</span><span>         {
</span><span style=color:#f07171>-            layer = tracing_oslog::OsLogger::default().boxed();
</span><span style=color:#86b300>+            finished_subscriber = subscriber.with(tracing_oslog::OsLogger::default());
</span><span>         }
</span><span> 
</span><span style=color:#f07171>-        #[cfg(all(
</span><span style=color:#f07171>-            not(target_arch = "wasm32"),
</span><span style=color:#f07171>-            not(target_os = "android"),
</span><span style=color:#f07171>-            not(target_os = "ios")
</span><span style=color:#f07171>-        ))]
</span><span style=color:#f07171>-        {
</span><span style=color:#f07171>-            layer = {
</span><span style=color:#f07171>-                let fmt_layer = custom_format_layer.unwrap_or_else(|| {
</span><span style=color:#f07171>-                    tracing_subscriber::fmt::Layer::default()
</span><span style=color:#f07171>-                        // note: the implementation of `Default` reads from the env var NO_COLOR
</span><span style=color:#f07171>-                        // to decide whether to use ANSI color codes, which is common convention
</span><span style=color:#f07171>-                        // https://no-color.org/
</span><span style=color:#f07171>-                        .with_writer(std::io::stderr)
</span><span style=color:#f07171>-                        .boxed()
</span><span style=color:#f07171>-                });
</span><span style=color:#f07171>-
</span><span style=color:#f07171>-                // bevy_render::renderer logs a `tracy.frame_mark` event every frame
</span><span style=color:#f07171>-                // at Level::INFO. Formatted logs should omit it.
</span><span style=color:#f07171>-                #[cfg(feature = "tracing-tracy")]
</span><span style=color:#f07171>-                let fmt_layer =
</span><span style=color:#f07171>-                    fmt_layer.with_filter(tracing_subscriber::filter::FilterFn::new(|meta| {
</span><span style=color:#f07171>-                        meta.fields().field("tracy.frame_mark").is_none()
</span><span style=color:#f07171>-                    }));
</span><span style=color:#f07171>-                fmt_layer.boxed()
</span><span style=color:#f07171>-            }
</span><span style=color:#86b300>+        let logger_already_set = LogTracer::init().is_err();
</span><span style=color:#86b300>+        let subscriber_already_set =
</span><span style=color:#86b300>+            tracing::subscriber::set_global_default(finished_subscriber).is_err();
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+        match (logger_already_set, subscriber_already_set) {
</span><span style=color:#86b300>+            (true, true) => error!(
</span><span style=color:#86b300>+                "Could not set global logger and tracing subscriber as they are already set. Consider disabling LogPlugin."
</span><span style=color:#86b300>+            ),
</span><span style=color:#86b300>+            (true, false) => error!("Could not set global logger as it is already set. Consider disabling LogPlugin."),
</span><span style=color:#86b300>+            (false, true) => error!("Could not set global tracing subscriber as it is already set. Consider disabling LogPlugin."),
</span><span style=color:#86b300>+            (false, false) => (),
</span><span>         }
</span><span style=color:#f07171>-        layer
</span><span>     }
</span><span> }
</span><span>diff --git a/examples/app/log_layers.rs b/examples/app/log_layers.rs
</span><span>index 83e17ef107b79..8f454e9ee0c9b 100644
</span><span style=color:#c594c5>--- a/examples/app/log_layers.rs
</span><span style=color:#c594c5>+++ b/examples/app/log_layers.rs
</span><span style=color:#c594c5>@@ -4,7 +4,7 @@ </span><span style=color:#399ee6>use bevy::{
</span><span>     log::{
</span><span>         tracing::{self, Subscriber},
</span><span>         tracing_subscriber::Layer,
</span><span style=color:#f07171>-        BoxedLayer,
</span><span style=color:#86b300>+        BoxedFmtLayer, BoxedLayer,
</span><span>     },
</span><span>     prelude::*,
</span><span> };
</span><span style=color:#c594c5>@@ -41,13 +41,12 @@ </span><span style=color:#399ee6>fn custom_layer(_app: &mut App) -> Option&LTBoxedLayer> {
</span><span> // `fmt_layer` option.
</span><span> //
</span><span> // In this example, we're disabling the timestamp in the log output.
</span><span style=color:#f07171>-fn fmt_layer(_app: &mut App) -> Option&LTBoxedLayer> {
</span><span style=color:#f07171>-    Some(
</span><span style=color:#86b300>+fn fmt_layer(_app: &mut App) -> Option&LTBoxedFmtLayer> {
</span><span style=color:#86b300>+    Some(Box::new(
</span><span>         bevy::log::tracing_subscriber::fmt::Layer::default()
</span><span>             .without_time()
</span><span style=color:#f07171>-            .with_writer(std::io::stderr)
</span><span style=color:#f07171>-            .boxed(),
</span><span style=color:#f07171>-    )
</span><span style=color:#86b300>+            .with_writer(std::io::stderr),
</span><span style=color:#86b300>+    ))
</span><span> }
</span><span> 
</span><span> fn main() {
</span></code></pre></details></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-06/pr_19705.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>