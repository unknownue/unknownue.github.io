<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19668 Split CursorOptions off of Window
        
    </title><meta content="#19668 Split CursorOptions off of Window" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-06/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-06-17</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-06/pr-19668-zh-cn-20250617>中文</a></div></div><div class=pr-content><h1 id=analysis-of-pr-19668-split-cursoroptions-off-of-window>Analysis of PR #19668: Split CursorOptions off of Window</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Split CursorOptions off of Window<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19668<li><strong>Author</strong>: janhohenheim<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Input, A-Windowing, S-Ready-For-Final-Review, M-Needs-Migration-Guide, D-Straightforward<li><strong>Created</strong>: 2025-06-16T04:15:24Z<li><strong>Merged</strong>: 2025-06-17T20:38:46Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Fixes #19627<li>Tackles part of #19644<li>Supersedes #19629<li><code>Window</code> has become a very very very big component<li>As such, our change detection does not <em>really</em> work on it, as e.g. moving the mouse will cause a change for the entire window<li>We circumvented this with a cache<li>But, some things <em>shouldn’t</em> be cached as they can be changed from outside the user’s control, notably the cursor grab mode on web<li>So, we need to disable the cache for that<li>But because change detection is broken, that would result in the cursor grab mode being set every frame the mouse is moved<li>That is usually <em>not</em> what a dev wants, as it forces the cursor to be locked even when the end-user is trying to free the cursor on the browser <ul><li>the cache in this situation is invalid due to #8949</ul></ul><h2 id=solution>Solution</h2><ul><li>Split <code>Window</code> into multiple components, each with working change detection<li>Disable caching of the cursor grab mode <ul><li>This will only attempt to force the grab mode when the <code>CursorOptions</code> were touched by the user, which is <em>much</em> rarer than simply moving the mouse.</ul><li>If this PR is merged, I’ll do the exact same for the other constituents of <code>Window</code> as a follow-up</ul><h2 id=testing>Testing</h2><ul><li>Ran all the changed examples</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The <code>Window</code> component in Bevy had grown too large, causing inefficient change detection. Any mouse movement would mark the entire <code>Window</code> component as changed, forcing systems to process all its properties. This was particularly problematic for cursor grab mode on web platforms, where external events could change the cursor state independently.<p>To address this, we split cursor-related properties into a separate <code>CursorOptions</code> component. This allows more granular change detection - mouse movements only affect cursor position in <code>Window</code>, while grab mode changes are isolated to <code>CursorOptions</code>.<p>The implementation required changes across several areas:<ol><li><code>CursorOptions</code> became a standalone component with its own change detection<li>Systems accessing cursor properties were updated to query <code>CursorOptions</code><li>A new <code>changed_cursor_options</code> system handles grab mode updates<li>Migration guides help users adapt to the new structure</ol><p>Key technical decisions included:<ul><li>Maintaining both components on the same entity to preserve existing relationships<li>Adding <code>CachedCursorOptions</code> for tracking state changes<li>Creating a dedicated system for cursor option changes<li>Preserving existing behavior while improving performance</ul><p>These changes fix the specific issue with cursor grab mode resetting every frame on web platforms. The cursor grab mode now only updates when explicitly modified, not on every mouse movement. This reduces unnecessary system executions and improves responsiveness.<p>The refactor also sets the foundation for further decomposition of the <code>Window</code> component. Future PRs can split additional properties into dedicated components using the same pattern established here.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    W[Window Component] --> CO[CursorOptions Component]
</span><span>    CO --> CG[changed_cursor_options System]
</span><span>    W --> CW[changed_windows System]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-window-src-lib-rs-15-2><code>crates/bevy_window/src/lib.rs</code> (+15/-2)</h3><p>Modified to handle the new <code>CursorOptions</code> component when creating windows. The primary window now gets both <code>Window</code> and <code>CursorOptions</code> components.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(primary_window) </span><span style=color:#ed9366>= &</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>primary_window {
</span><span>    app</span><span style=color:#ed9366>.</span><span style=color:#f07171>world_mut</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>(primary_window</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>())</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>((
</span><span>        PrimaryWindow</span><span style=color:#61676ccc>,
</span><span>        RawHandleWrapperHolder(Arc</span><span style=color:#ed9366>::</span><span>new(Mutex</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#55b4d4;font-style:italic>None</span><span>))))</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(primary_window) </span><span style=color:#ed9366>= &</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>primary_window {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> entity_commands </span><span style=color:#ed9366>=</span><span> app</span><span style=color:#ed9366>.</span><span style=color:#f07171>world_mut</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>(primary_window</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>())</span><span style=color:#61676ccc>;
</span><span>    entity_commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>((
</span><span>        PrimaryWindow</span><span style=color:#61676ccc>,
</span><span>        RawHandleWrapperHolder(Arc</span><span style=color:#ed9366>::</span><span>new(Mutex</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#55b4d4;font-style:italic>None</span><span>))))</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(primary_cursor_options) </span><span style=color:#ed9366>= &</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>primary_cursor_options {
</span><span>        entity_commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(primary_cursor_options</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>())</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><h3 id=crates-bevy-window-src-window-rs-structural-changes><code>crates/bevy_window/src/window.rs</code> (Structural changes)</h3><p>Refactored to remove cursor options from <code>Window</code> and make <code>CursorOptions</code> a separate component.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>Window </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>cursor_options</span><span style=color:#61676ccc>:</span><span> CursorOptions,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...other fields...
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>require</span><span>(CursorOptions)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>Window </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...other fields (without cursor_options)...
</span><span>}
</span><span>
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component</span><span style=color:#61676ccc>,</span><span> Debug</span><span style=color:#61676ccc>,</span><span> Clone)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>CursorOptions </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...fields...
</span><span>}
</span></code></pre><h3 id=crates-bevy-winit-src-system-rs-98-64><code>crates/bevy_winit/src/system.rs</code> (+98/-64)</h3><p>Added new systems and components for handling cursor options separately.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// New components:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Debug</span><span style=color:#61676ccc>,</span><span> Clone</span><span style=color:#61676ccc>,</span><span> Component</span><span style=color:#61676ccc>,</span><span> Deref</span><span style=color:#61676ccc>,</span><span> DerefMut)]
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>CachedWindow</span><span>(Window)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Debug</span><span style=color:#61676ccc>,</span><span> Clone</span><span style=color:#61676ccc>,</span><span> Component</span><span style=color:#61676ccc>,</span><span> Deref</span><span style=color:#61676ccc>,</span><span> DerefMut)]
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>CachedCursorOptions</span><span>(CursorOptions)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// New system for cursor option changes:
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>changed_cursor_options</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>changed_windows</span><span style=color:#61676ccc>: </span><span>Query<
</span><span>        (Entity, </span><span style=color:#ed9366>&</span><span>Window, </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> CursorOptions, </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> CachedCursorOptions),
</span><span>        Changed&LTCursorOptions>,
</span><span>    >,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Handles grab mode, visibility, and hit test updates
</span><span>}
</span></code></pre><h3 id=crates-bevy-winit-src-winit-windows-rs-8-7><code>crates/bevy_winit/src/winit_windows.rs</code> (+8/-7)</h3><p>Updated window creation to include cursor options.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#f07171>create_window</span><span>(event_loop</span><span style=color:#61676ccc>,</span><span> entity</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>window</span><span style=color:#61676ccc>, </span><span style=color:#abb0b6;font-style:italic>/* ... */</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#f07171>create_window</span><span>(event_loop</span><span style=color:#61676ccc>,</span><span> entity</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>window</span><span style=color:#61676ccc>,</span><span> cursor_options</span><span style=color:#61676ccc>, </span><span style=color:#abb0b6;font-style:italic>/* ... */</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=examples-helpers-camera-controller-rs-8-8><code>examples/helpers/camera_controller.rs</code> (+8/-8)</h3><p>Updated to query <code>CursorOptions</code> instead of <code>Window</code> for cursor settings.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>for mut</span><span> window </span><span style=color:#ed9366>in &</span><span style=color:#fa6e32>mut</span><span> windows {
</span><span>    window</span><span style=color:#ed9366>.</span><span>cursor_options</span><span style=color:#ed9366>.</span><span>grab_mode </span><span style=color:#ed9366>= </span><span>CursorGrabMode</span><span style=color:#ed9366>::</span><span>Locked</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>for </span><span>(</span><span style=color:#ed9366>_</span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>mut</span><span> cursor_options) </span><span style=color:#ed9366>in &</span><span style=color:#fa6e32>mut</span><span> windows {
</span><span>    cursor_options</span><span style=color:#ed9366>.</span><span>grab_mode </span><span style=color:#ed9366>= </span><span>CursorGrabMode</span><span style=color:#ed9366>::</span><span>Locked</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=release-content-migration-guides-split-window-md-44-0><code>release-content/migration-guides/split-window.md</code> (+44/-0)</h3><p>Added migration guide for the component split.<pre class=language-markdown data-lang=markdown style=color:#61676c;background-color:#fafafa><code class=language-markdown data-lang=markdown><span style=color:#fa6e32;font-weight:700>## </span><span style=color:#399ee6;font-weight:700>Migration
</span><span>
</span><span>// old
</span><span>fn lock_cursor(primary_window: Single<&mut Window, With</span><span style=color:#55b4d490><</span><span style=color:#399ee6>PrimaryWindow</span><span style=color:#55b4d490>></span><span>>) {
</span><span>    primary_window.cursor_options.grab_mode = CursorGrabMode::Locked;
</span><span>}
</span><span>
</span><span>// new
</span><span>fn lock_cursor(primary_cursor_options: Single<&mut CursorOptions, With</span><span style=color:#55b4d490><</span><span style=color:#399ee6>PrimaryWindow</span><span style=color:#55b4d490>></span><span>>) {
</span><span>    primary_cursor_options.grab_mode = CursorGrabMode::Locked;
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/development-practices/change-detection/ target=_blank>Bevy ECS Change Detection</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/development-practices/component/ target=_blank>Component Data in Bevy</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/features/window/ target=_blank>Window Management in Bevy</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-06/pr_19668.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>