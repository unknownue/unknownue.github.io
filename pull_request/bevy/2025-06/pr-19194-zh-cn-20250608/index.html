<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19194 Improve Bevy's double-precision story for third-party crates
        
    </title><meta content="#19194 Improve Bevy's double-precision story for third-party crates" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-06/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-06-08</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2025-06/pr-19194-en-20250608>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=ti-gao-bevy-dui-di-san-fang-crate-de-shuang-jing-du-zhi-chi>提高 Bevy 对第三方 crate 的双精度支持</h1><h2 id=ji-chu-xin-xi>基础信息</h2><ul><li><strong>标题</strong>: Improve Bevy’s double-precision story for third-party crates<li><strong>PR 链接</strong>: https://github.com/bevyengine/bevy/pull/19194<li><strong>作者</strong>: jnhyatt<li><strong>状态</strong>: MERGED<li><strong>标签</strong>: S-Ready-For-Final-Review, A-Math, M-Needs-Migration-Guide, D-Modest<li><strong>创建时间</strong>: 2025-05-12T20:06:18Z<li><strong>合并时间</strong>: 2025-06-08T02:20:25Z<li><strong>合并者</strong>: alice-i-cecile</ul><h2 id=miao-shu-fan-yi>描述翻译</h2><p>某些类型的游戏（通常具有巨大世界）需要一定程度支持双精度(double-precision)。像 <code>big_space</code> 这样的库允许创建大型世界并与 Bevy 主要基于单精度的生态系统无缝集成，但即便如此，在接入 Bevy 接口的流程中，游戏通常仍会直接使用双精度。<p>目前，在 Bevy 中使用双精度类型非常困难。<code>glam</code> 提供 <code>DVec3</code> 等类型，但 Bevy 没有为 <code>Dir3</code> 这样的 <code>glam</code> 包装器提供双精度版本。主要原因包括：<ul><li>代码重复<li>泛型<li>模板（如 <code>glam</code> 所用）<li>宏</ul><p>这些方法在可维护性、可用性或可读性方面都存在显著问题。为了解决这个问题，我开发了 <code>bevy_dmath</code> crate，它复制 <code>bevy_math</code> 的类型和功能，使下游用户能在双精度环境中使用 <code>bevy_math</code> 的便利性和功能。虽然过程基本顺利，但为了完全集成，需要一些只能在 <code>bevy_math</code> 中进行的修改。<h2 id=jie-jue-fang-an>解决方案</h2><p>本 PR 解决了下游双精度数学支持中最直接的问题：<code>VectorSpace</code> 目前只能表示基于 <code>f32</code> 的向量空间。这直接限制了双精度曲线等功能的使用。通过允许向量空间指定底层标量场(scalar field)可以轻松解除此限制。本 PR 新增了 <code>ScalarField</code> trait（满足标量场的静态属性要求），并为 <code>VectorSpace</code> 添加了新的关联类型 <code>type Scalar: ScalarField</code>。这个改动基本是非侵入性的，主要挑战在于：<ul><li>涉及大量曲线代码修改<li><code>bevy_math::ops</code> 不支持 <code>f64</code>，需要临时解决方案</ul><p>对于曲线代码，我尽量保持改动最小化。为了验证可行性，我（未在本 PR 中）将大部分曲线 API 迁移为支持不同的 <code>ScalarField</code>，过程非常顺利。最不优雅的部分是在多处添加 <code>P::Scalar: From&LTusize></code> 约束。虽然可以考虑使用 <code>num-traits</code>，但这与本 PR 无关。关键是目前最小改动方案是在每个曲线实现中将其泛型化为 <code>VectorSpace&LTScalar = f32></code>。曲线功能与之前完全一致，用户 API 没有任何变化。<h2 id=hou-xu-gong-zuo>后续工作</h2><ul><li><p><strong>扩展 <code>bevy_math::ops</code> 支持 <code>f64</code></strong>：<code>bevy_math::ops</code> 被广泛使用，如果曲线要支持不同的 <code>ScalarField</code> 类型，需要能够为 <code>f64</code> 类型调用正确的 <code>std</code> 或 <code>libm</code> 操作。添加 <code>ops64</code> 模块会显得冗余。另一个方案是构建浮点 trait 来调用正确的操作变体，并为 <code>f32</code> 和 <code>f64</code> 实现它。这降低了维护负担，因为修改接口时需要同时更新两者。第三个选项是使用 <code>num-traits</code>（本质是方案 2 但已由他人实现）。它通过 <code>libm</code> 支持 <code>no_std</code>，基本可以即插即用。它缺少 <code>floor</code> 和 <code>ceil</code> 等少量浮点操作，但我们可以自定义浮点 trait（甚至可能上游贡献给 <code>num-traits</code>）。</p><li><p><strong>调整曲线以接受任意 <code>ScalarField</code> 的向量空间</strong>：一旦解决上述问题，曲线即可支持自定义标量类型。代码可读性会有所降低（到处都是 <code>P::Scalar</code> 而非 <code>f32</code>）。另一种设计是使用 <code>f32</code> 插值 <code>DVec3</code> 等类型，但我认为参数化曲线向量空间标量类型是更优方案。虽然需要处理 <code>ScalarType</code>，但它支持足够多的操作，使用体验接近原生浮点类型，并为需要双精度的游戏开启新可能。</p></ul><h2 id=pr-ji-shu-fen-xi>PR 技术分析</h2><h3 id=wen-ti-bei-jing>问题背景</h3><p>Bevy 的数学库主要围绕单精度浮点数(<code>f32</code>)设计，这限制了需要双精度(<code>f64</code>)的应用场景。现有第三方方案（如 <code>big_space</code>）通过坐标转换实现大世界支持，但在与 Bevy 原生数学组件交互时仍面临障碍。核心问题在于 <code>VectorSpace</code> trait 硬编码了 <code>f32</code> 标量类型，导致无法直接使用 <code>DVec3</code> 等双精度类型实现曲线插值等数学抽象。<h3 id=jie-jue-fang-an-she-ji>解决方案设计</h3><p>核心思路是将标量类型从 <code>VectorSpace</code> trait 中解耦：<ol><li>引入 <code>ScalarField</code> trait 定义标量基本操作<li>为 <code>VectorSpace</code> 添加关联类型 <code>type Scalar: ScalarField</code><li>为现有 <code>Vec2/3/4</code> 保持 <code>Scalar = f32</code><li>为 <code>DVec2/3/4</code> 新增实现并指定 <code>Scalar = f64</code></ol><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[VectorSpace] --> B[定义关联类型 Scalar]
</span><span>    B --> C[实现 ScalarField for f32/f64]
</span><span>    C --> D[更新曲线等组件约束]
</span><span>    D --> E[支持第三方双精度crate]
</span></code></pre><p>此设计保持向后兼容性：现有使用 <code>f32</code> 的代码不受影响，同时为双精度类型提供扩展点。<h3 id=guan-jian-ji-shu-shi-xian>关键技术实现</h3><p>主要修改集中在 <code>common_traits.rs</code>，新增 <code>ScalarField</code> trait 并重构 <code>VectorSpace</code>：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 标量场定义
</span><span style=color:#fa6e32>pub trait </span><span style=color:#399ee6>ScalarField</span><span>: 
</span><span>    Mul&LTSelf, Output = Self> + Div&LTSelf, Output = Self> + ... 
</span><span>{
</span><span>    </span><span style=color:#fa6e32>const </span><span style=color:#ff8f40>ZERO</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>Self</span><span style=color:#61676ccc>;  </span><span style=color:#abb0b6;font-style:italic>// 加法单位元
</span><span>    </span><span style=color:#fa6e32>const </span><span style=color:#ff8f40>ONE</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>Self</span><span style=color:#61676ccc>;   </span><span style=color:#abb0b6;font-style:italic>// 乘法单位元
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>recip</span><span>(</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{ </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ONE </span><span style=color:#ed9366>/ </span><span style=color:#55b4d4;font-style:italic>self </span><span>}
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 向量空间重构
</span><span style=color:#fa6e32>pub trait </span><span style=color:#399ee6>VectorSpace</span><span>: 
</span><span>    Mul&LTSelf::Scalar, Output = Self> + Div&LTSelf::Scalar, Output = Self> + ...
</span><span>{
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Scalar</span><span style=color:#61676ccc>:</span><span> ScalarField</span><span style=color:#61676ccc>;  </span><span style=color:#abb0b6;font-style:italic>// 关键关联类型
</span><span>    </span><span style=color:#fa6e32>const </span><span style=color:#ff8f40>ZERO</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>Self</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>lerp</span><span>(</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>rhs</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>Self</span><span>, </span><span style=color:#ff8f40>t</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Scalar) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{ </span><span style=color:#ed9366>... </span><span>}
</span><span>}
</span></code></pre><p>实现示例：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 保持现有f32实现
</span><span style=color:#fa6e32>impl </span><span>VectorSpace </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>Vec3 </span><span>{
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Scalar </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>f32</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>const </span><span style=color:#ff8f40>ZERO</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>Self </span><span style=color:#ed9366>= </span><span>Vec3</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ZERO</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 新增f64实现
</span><span style=color:#fa6e32>impl </span><span>VectorSpace </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>DVec3 </span><span>{
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Scalar </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>f64</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>const </span><span style=color:#ff8f40>ZERO</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>Self </span><span style=color:#ed9366>= </span><span>DVec3</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ZERO</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 标量类型自身也是向量空间
</span><span style=color:#fa6e32>impl</span><span>&LTT</span><span style=color:#61676ccc>:</span><span> ScalarField> VectorSpace </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>T </span><span>{
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Scalar </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>Self</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>const </span><span style=color:#ff8f40>ZERO</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>Self </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ZERO</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=ying-xiang-fan-wei-chu-li>影响范围处理</h3><p>为保证现有功能不受影响，在曲线相关模块中添加显式标量类型约束：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 修改前
</span><span style=color:#fa6e32>impl</span><span>&LTP</span><span style=color:#61676ccc>:</span><span> VectorSpace> Curve&LTP> </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>CubicSegment</span><span>&LTP>
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 修改后
</span><span style=color:#399ee6>impl</span><span>&LTP</span><span style=color:#61676ccc>: </span><span>VectorSpace&LTScalar = </span><span style=color:#fa6e32>f32</span><span>>> </span><span style=color:#399ee6>Curve</span><span>&LTP> </span><span style=color:#399ee6>for CubicSegment</span><span>&LTP>
</span></code></pre><p>这种约束确保：<ol><li>现有单精度曲线功能完全兼容<li>明确标出未来需要扩展支持 <code>f64</code> 的位置<li>避免因泛型扩散导致的编译时间增长</ol><h3 id=xing-neng-kao-liang>性能考量</h3><ul><li>零成本抽象：泛型在编译时单态化，无运行时开销<li>二进制大小：新增 <code>f64</code> 实现会略微增加二进制体积，但仅当实际使用时才引入<li>编译时间：合理使用 trait bound 避免过度泛型化</ul><h2 id=guan-jian-wen-jian-bian-geng>关键文件变更</h2><h3 id=crates-bevy-math-src-common-traits-rs-154-32><code>crates/bevy_math/src/common_traits.rs</code> (+154/-32)</h3><p>核心改动文件，定义 <code>ScalarField</code> trait 并重构 <code>VectorSpace</code>：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 新增ScalarField trait
</span><span style=color:#fa6e32>pub trait </span><span style=color:#399ee6>ScalarField</span><span>: ... {
</span><span>    </span><span style=color:#fa6e32>const </span><span style=color:#ff8f40>ZERO</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>Self</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>const </span><span style=color:#ff8f40>ONE</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>Self</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>recip</span><span>(</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{ </span><span style=color:#ed9366>... </span><span>}
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 修改VectorSpace trait
</span><span style=color:#fa6e32>pub trait </span><span style=color:#399ee6>VectorSpace</span><span>: ... {
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Scalar</span><span style=color:#61676ccc>:</span><span> ScalarField</span><span style=color:#61676ccc>;  </span><span style=color:#abb0b6;font-style:italic>// 新增关联类型
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...其他保持不变...
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 为f32/f64实现ScalarField
</span><span style=color:#fa6e32>impl </span><span>ScalarField </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>f32 </span><span>{
</span><span>    </span><span style=color:#fa6e32>const </span><span style=color:#ff8f40>ZERO</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>Self </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0.0</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>const </span><span style=color:#ff8f40>ONE</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>Self </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>1.0</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=crates-bevy-math-src-curve-derivatives-adaptor-impls-rs-28-18><code>crates/bevy_math/src/curve/derivatives/adaptor_impls.rs</code> (+28/-18)</h3><p>更新曲线适配器的 trait 约束：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 修改前
</span><span style=color:#fa6e32>impl</span><span>&LTS, T, C, D> SampleDerivative<(S, T)> </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>ZipCurve</span><span>&LTS, T, C, D>
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 修改后
</span><span style=color:#399ee6>impl</span><span>&LTU, V, S, T, C, D> </span><span style=color:#399ee6>SampleDerivative</span><span><(S, T)> </span><span style=color:#399ee6>for ZipCurve</span><span>&LTS, T, C, D>
</span><span style=color:#fa6e32>where
</span><span>    U</span><span style=color:#61676ccc>: </span><span>VectorSpace&LTScalar = </span><span style=color:#fa6e32>f32</span><span>>,
</span><span>    V</span><span style=color:#61676ccc>: </span><span>VectorSpace&LTScalar = </span><span style=color:#fa6e32>f32</span><span>>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...更精确的约束...
</span></code></pre><h3 id=crates-bevy-math-src-sampling-shape-sampling-rs-20-15><code>crates/bevy_math/src/sampling/shape_sampling.rs</code> (+20/-15)</h3><p>使三角形采样支持泛型标量：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 修改后支持泛型标量
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>sample_triangle_interior</span><span>&LTP, R>(</span><span style=color:#ff8f40>vertices</span><span style=color:#61676ccc>:</span><span> [P; 3], </span><span style=color:#ff8f40>rng</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> R) </span><span style=color:#61676ccc>-></span><span> P
</span><span style=color:#fa6e32>where
</span><span>    P</span><span style=color:#61676ccc>:</span><span> NormedVectorSpace,
</span><span>    </span><span style=color:#fa6e32>P</span><span style=color:#ed9366>::</span><span>Scalar</span><span style=color:#61676ccc>:</span><span> SampleUniform + PartialOrd,
</span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 使用P::Scalar::ZERO/ONE替代硬编码0.0/1.0
</span><span>}
</span></code></pre><h3 id=crates-bevy-math-src-cubic-splines-mod-rs-13-13><code>crates/bevy_math/src/cubic_splines/mod.rs</code> (+13/-13)</h3><p>更新曲线生成器约束：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 所有曲线生成器增加Scalar类型约束
</span><span style=color:#fa6e32>impl</span><span>&LTP</span><span style=color:#61676ccc>: </span><span>VectorSpace&LTScalar = </span><span style=color:#fa6e32>f32</span><span>>> CubicGenerator&LTP> </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>CubicBezier</span><span>&LTP>
</span></code></pre><h3 id=crates-bevy-math-src-cubic-splines-curve-impls-rs-12-12><code>crates/bevy_math/src/cubic_splines/curve_impls.rs</code> (+12/-12)</h3><p>更新曲线段实现约束：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 曲线段实现明确f32标量
</span><span style=color:#fa6e32>impl</span><span>&LTP</span><span style=color:#61676ccc>: </span><span>VectorSpace&LTScalar = </span><span style=color:#fa6e32>f32</span><span>>> Curve&LTP> </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>CubicSegment</span><span>&LTP>
</span></code></pre><h2 id=ying-xiang-yu-qian-yi-zhi-nan>影响与迁移指南</h2><h3 id=ji-ji-ying-xiang>积极影响</h3><ol><li>为 <code>bevy_dmath</code> 等第三方双精度数学库奠定基础<li>解除向量空间与 <code>f32</code> 的硬耦合<li>保持现有代码完全兼容<li>明确标识出未来可扩展点</ol><h3 id=qian-yi-yao-qiu>迁移要求</h3><p>手动实现 <code>VectorSpace</code> 的用户需添加关联类型：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 迁移前
</span><span style=color:#fa6e32>impl </span><span>VectorSpace </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>MyVecType </span><span>{}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 迁移后
</span><span style=color:#fa6e32>impl </span><span>VectorSpace </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>MyVecType </span><span>{
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Scalar </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>f32</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// 或f64等其他标量类型
</span><span>}
</span></code></pre><p>完整迁移指南见：<a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/release-content/migration-guides/scalar-field-on-vector-space.md target=_blank>scalar-field-on-vector-space.md</a><h2 id=yan-shen-yue-du>延伸阅读</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/glam/latest/glam/f64/index.html target=_blank>glam 双精度类型文档</a><li><a rel="noopener nofollow noreferrer" href=https://crates.io/crates/big_space target=_blank>big_space crate</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/num-traits/latest/num_traits/float/trait.Float.html target=_blank>num-traits 浮点抽象</a><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Vector_space target=_blank>向量空间数学理论</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-06/pr_19194.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>