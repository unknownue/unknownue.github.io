<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19621 Make `IrradianceVolume` require `LightProbe` (and document this).
        
    </title><meta content="#19621 Make `IrradianceVolume` require `LightProbe` (and document this)." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-06/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-06-13</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-06/pr-19621-zh-cn-20250613>中文</a></div></div><div class=pr-content><h1 id=technical-analysis-of-pr-19621-make-irradiancevolume-require-lightprobe>Technical Analysis of PR #19621: Make <code>IrradianceVolume</code> require <code>LightProbe</code></h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Make <code>IrradianceVolume</code> require <code>LightProbe</code> (and document this).<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19621<li><strong>Author</strong>: kpreid<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, C-Usability, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-06-13T16:31:07Z<li><strong>Merged</strong>: 2025-06-13T17:28:38Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h3 id=objective>Objective</h3><p>Make it easier to use <code>IrradianceVolume</code> with fewer ways to silently fail. Fix #19614.<h3 id=solution>Solution</h3><ul><li>Add <code>#[require(LightProbe)]</code> to <code>struct IrradianceVolume</code>.<li>Document this fact.<li>Also document the volume being centered on the origin by default (this was the other thing that was unclear when getting started).</ul><p>I also looked at the other implementor of <code>LightProbeComponent</code>, <code>EnvironmentMapLight</code>, but it has a use which is <em>not</em> as a light probe, so it should not require <code>LightProbe</code>.<h3 id=testing>Testing</h3><ul><li>Confirmed that <code>examples/3d/irradiance_volumes.rs</code> still works after removing <code>LightProbe</code>.<li>Reviewed generated documentation.</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=problem-identification>Problem Identification</h3><p>This PR addresses issue #19614 where users could add <code>IrradianceVolume</code> to entities without the required <code>LightProbe</code> component, resulting in silent failures. The irradiance volume wouldn’t function as expected, but there was no clear error or warning to indicate the missing dependency. Additionally, the documentation didn’t explicitly state that irradiance volumes are centered on the origin by default, leading to potential placement confusion.<h3 id=implementation-strategy>Implementation Strategy</h3><p>The solution uses Bevy’s reflection system to enforce component requirements at the type level. By adding <code>#[require(LightProbe)]</code> to the <code>IrradianceVolume</code> struct, the engine now automatically validates that any entity with an <code>IrradianceVolume</code> must also have a <code>LightProbe</code> component. This prevents the silent failure scenario by making the dependency explicit and enforced.<p>The documentation was updated in two key areas:<ol><li>Added clear statements about the <code>LightProbe</code> requirement<li>Clarified the default center point behavior</ol><p>The approach preserves flexibility for <code>EnvironmentMapLight</code>, which implements <code>LightProbeComponent</code> but isn’t exclusively used as a light probe. This demonstrates good component boundary design by only enforcing requirements where they’re semantically appropriate.<h3 id=code-changes>Code Changes</h3><p>The implementation required minimal but targeted changes:<ol><li><p>Added the requirement attribute to <code>IrradianceVolume</code>:</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Clone</span><span style=color:#61676ccc>,</span><span> Reflect</span><span style=color:#61676ccc>,</span><span> Component</span><span style=color:#61676ccc>,</span><span> Debug)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>reflect</span><span>(Component</span><span style=color:#61676ccc>,</span><span> Default</span><span style=color:#61676ccc>,</span><span> Debug</span><span style=color:#61676ccc>,</span><span> Clone)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>require</span><span>(LightProbe)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>IrradianceVolume </span><span>{
</span></code></pre><li><p>Documented the requirement and default center behavior:</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>/// This component requires the [`LightProbe`] component, and is typically used with
</span><span style=color:#abb0b6;font-style:italic>/// [`bevy_transform::components::Transform`] to place the volume appropriately.
</span></code></pre><li><p>Clarified the default center in module-level docs:</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>//! Like all light probes in Bevy, irradiance volumes are 1×1×1 cubes, centered
</span><span style=color:#abb0b6;font-style:italic>//! on the origin, that can be arbitrarily scaled, rotated, and positioned
</span></code></pre><li><p>Removed the explicit <code>LightProbe</code> from the example since it’s now required:</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((
</span><span>    PbrBundle { </span><span style=color:#ed9366>... </span><span>}</span><span style=color:#61676ccc>,
</span><span>    irradiance_volume</span><span style=color:#61676ccc>,
</span><span>))</span><span style=color:#61676ccc>;
</span></code></pre></ol><h3 id=technical-validation>Technical Validation</h3><p>The author verified correctness through:<ol><li>Functional testing: Confirmed the irradiance volumes example still worked after removing the explicit <code>LightProbe</code> component<li>Documentation review: Checked generated docs to ensure requirement and placement details were properly displayed<li>Component boundary analysis: Validated that <code>EnvironmentMapLight</code> shouldn’t have the same requirement</ol><h3 id=impact-and-benefits>Impact and Benefits</h3><p>This change improves the developer experience by:<ul><li>Preventing a common pitfall through compile-time enforcement<li>Reducing cognitive load with clearer documentation<li>Maintaining backward compatibility<li>Preserving rendering performance (no runtime overhead)</ul><p>The solution demonstrates effective use of Bevy’s reflection system for component validation and shows how small documentation improvements can significantly enhance usability.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[IrradianceVolume] -->|requires| B[LightProbe]
</span><span>    C[Transform] -->|positions| A
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ol><li><strong>crates/bevy_pbr/src/light_probe/irradiance_volume.rs</strong>: <ul><li>Added component requirement attribute<li>Improved documentation about requirements and positioning</ul></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Clone</span><span style=color:#61676ccc>,</span><span> Reflect</span><span style=color:#61676ccc>,</span><span> Component</span><span style=color:#61676ccc>,</span><span> Debug)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>reflect</span><span>(Component</span><span style=color:#61676ccc>,</span><span> Default</span><span style=color:#61676ccc>,</span><span> Debug</span><span style=color:#61676ccc>,</span><span> Clone)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>IrradianceVolume </span><span>{
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Clone</span><span style=color:#61676ccc>,</span><span> Reflect</span><span style=color:#61676ccc>,</span><span> Component</span><span style=color:#61676ccc>,</span><span> Debug)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>reflect</span><span>(Component</span><span style=color:#61676ccc>,</span><span> Default</span><span style=color:#61676ccc>,</span><span> Debug</span><span style=color:#61676ccc>,</span><span> Clone)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>require</span><span>(LightProbe)]
</span><span style=color:#fa6e32>pub</span><span> struct IrradianceVolume {
</span></code></pre><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Documentation additions:
</span><span style=color:#abb0b6;font-style:italic>/// This component requires the [`LightProbe`] component, and is typically used with
</span><span style=color:#abb0b6;font-style:italic>/// [`bevy_transform::components::Transform`] to place the volume appropriately.
</span></code></pre><ol start=2><li><strong>examples/3d/irradiance_volumes.rs</strong>: <ul><li>Removed explicit <code>LightProbe</code> component since it’s now required</ul></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((
</span><span>    PbrBundle { </span><span style=color:#ed9366>... </span><span>}</span><span style=color:#61676ccc>,
</span><span>    irradiance_volume</span><span style=color:#61676ccc>,
</span><span>    LightProbe</span><span style=color:#61676ccc>,
</span><span>))</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((
</span><span>    PbrBundle { </span><span style=color:#ed9366>... </span><span>}</span><span style=color:#61676ccc>,
</span><span>    irradiance_volume</span><span style=color:#61676ccc>,
</span><span>))</span><span style=color:#61676ccc>;
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/features/reflection/ target=_blank>Bevy Reflection System</a><li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/programming/component-deps.html target=_blank>Component Relationships in ECS</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/crates/bevy_pbr/src/light_probe/mod.rs target=_blank>Light Probes Technical Overview</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-06/pr_19621.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>