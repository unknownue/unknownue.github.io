<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19505 Fix regression on the get/get_mut/get_not_found
        
    </title><meta content="#19505 Fix regression on the get/get_mut/get_not_found" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-06/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-06-06</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-06/pr-19505-zh-cn-20250606>中文</a></div></div><div class=pr-content><h2 id=fix-regression-on-the-get-get-mut-get-not-found>Fix regression on the get/get_mut/get_not_found</h2><h3 id=basic-information>Basic Information</h3><ul><li><strong>Title</strong>: Fix regression on the get/get_mut/get_not_found<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19505<li><strong>Author</strong>: re0312<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-ECS, C-Performance, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-06-06T01:46:30Z<li><strong>Merged</strong>: 2025-06-06T21:22:41Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h3 id=description-translation>Description Translation</h3><h1 id=objective>Objective</h1><ul><li>Partial fix #19504<li>As more features were added to Bevy ECS, certain core hot-path function calls exceeded LLVM’s automatic inlining threshold, leading to significant performance regressions in some cases.</ul><h2 id=solution>Solution</h2><ul><li>inline more functions.</ul><h2 id=performance>Performance</h2><p>This brought nearly 3x improvement in Windows bench (using Sander’s testing code)<h3 id=the-story-of-this-pull-request>The Story of This Pull Request</h3><p>Recent feature additions to Bevy’s ECS caused core entity access functions to exceed LLVM’s automatic inlining threshold. This resulted in significant performance regressions in entity lookup operations, particularly impacting Windows platforms. The root cause was function call overhead accumulating in hot-path code like <code>get()</code>, <code>get_mut()</code>, and <code>get_or_entity()</code>.<p>To address this, we systematically applied <code>#[inline]</code> attributes to critical methods in Bevy’s entity access system. The approach focused on entity fetch operations and entity reference handling where benchmarking showed the highest performance degradation. We targeted methods in the <code>WorldEntityFetch</code> trait implementations and core entity accessors, ensuring frequently called functions would be inlined regardless of compiler heuristics.<p>In <code>entity_fetch.rs</code>, we added <code>#[inline]</code> to all methods in the <code>WorldEntityFetch</code> implementations. This trait handles entity lookups for various input types (single entities, arrays of entities, slices, and hash sets). The changes ensure that fetch operations for both single and multiple entities bypass function call overhead:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: No inline attributes
</span><span style=color:#fa6e32>unsafe fn </span><span style=color:#f29718>fetch_ref</span><span>(...) { </span><span style=color:#ed9366>... </span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Inline added
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>inline</span><span>]
</span><span style=color:#fa6e32>unsafe fn </span><span style=color:#f29718>fetch_ref</span><span>(...) { </span><span style=color:#ed9366>... </span><span>}
</span></code></pre><p>Similarly in <code>entity_ref.rs</code>, we optimized entity mutation pathways. The <code>EntityMut</code> constructor and conversion methods now feature <code>#[inline]</code>, and <code>EntityWorldMut</code> gained inline attributes on its unsafe cell accessors and view methods:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: No inline attributes
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>unsafe fn </span><span style=color:#f29718>new</span><span>(...) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{ </span><span style=color:#ed9366>... </span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Inline added
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>inline</span><span>]
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>unsafe fn </span><span style=color:#f29718>new</span><span>(...) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{ </span><span style=color:#ed9366>... </span><span>}
</span></code></pre><p>The <code>#[inline(always)]</code> directives on <code>EntityWorldMut</code>’s internal methods ensure consistent inlining behavior across compiler optimization levels. This is particularly important for methods like <code>as_unsafe_entity_cell()</code> that provide low-level access to entity data.<p>Benchmark results showed nearly 3x performance improvement on Windows after these changes, confirming they effectively reduced function call overhead in critical paths. The changes maintain all existing safety guarantees while making the compiler’s optimization behavior more predictable for these performance-sensitive operations.<h3 id=visual-representation>Visual Representation</h3><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Entity Access Methods] --> B[WorldEntityFetch Trait]
</span><span>    A --> C[EntityRef/EntityMut Types]
</span><span>    B --> D[Single Entity]
</span><span>    B --> E[Entity Arrays]
</span><span>    B --> F[Entity Slices]
</span><span>    B --> G[Entity HashSets]
</span><span>    C --> H[Conversion Methods]
</span><span>    C --> I[Unsafe Cell Accessors]
</span></code></pre><h3 id=key-files-changed>Key Files Changed</h3><p><strong>1. crates/bevy_ecs/src/world/entity_fetch.rs (+15/-0)</strong> Added inline attributes to all <code>WorldEntityFetch</code> methods across implementations for:<ul><li>Single <code>Entity</code><li>Fixed-size entity arrays (<code>[Entity; N]</code>)<li>Entity array references (<code>&[Entity; N]</code>)<li>Entity slices (<code>&[Entity]</code>)<li>Entity hash sets (<code>&EntityHashSet</code>)</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Example change for single entity
</span><span style=color:#fa6e32>unsafe impl </span><span>WorldEntityFetch </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>Entity </span><span>{
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>inline</span><span>]  </span><span style=color:#abb0b6;font-style:italic>// Added attribute
</span><span>    </span><span style=color:#fa6e32>unsafe fn </span><span style=color:#f29718>fetch_ref</span><span>(...) { </span><span style=color:#ed9366>... </span><span>}
</span><span>    
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>inline</span><span>]  </span><span style=color:#abb0b6;font-style:italic>// Added attribute
</span><span>    </span><span style=color:#fa6e32>unsafe fn </span><span style=color:#f29718>fetch_mut</span><span>(...) { </span><span style=color:#ed9366>... </span><span>}
</span><span>    
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>inline</span><span>]  </span><span style=color:#abb0b6;font-style:italic>// Added attribute
</span><span>    </span><span style=color:#fa6e32>unsafe fn </span><span style=color:#f29718>fetch_deferred_mut</span><span>(...) { </span><span style=color:#ed9366>... </span><span>}
</span><span>}
</span></code></pre><p><strong>2. crates/bevy_ecs/src/world/entity_ref.rs (+9/-0)</strong> Added inline attributes to:<ul><li><code>EntityMut</code> constructor<li><code>EntityMut</code> conversion from <code>EntityWorldMut</code><li><code>EntityWorldMut</code> internal cell accessors<li><code>EntityWorldMut</code> view methods</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// EntityMut changes
</span><span style=color:#fa6e32>impl</span><span><</span><span style=color:#fa6e32>'w</span><span>> </span><span style=color:#399ee6>EntityMut</span><span><</span><span style=color:#fa6e32>'w</span><span>> {
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>inline</span><span>]  </span><span style=color:#abb0b6;font-style:italic>// Added attribute
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>unsafe fn </span><span style=color:#f29718>new</span><span>(...) { </span><span style=color:#ed9366>... </span><span>}
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// EntityWorldMut changes
</span><span style=color:#fa6e32>impl</span><span><</span><span style=color:#fa6e32>'w</span><span>> </span><span style=color:#399ee6>EntityWorldMut</span><span><</span><span style=color:#fa6e32>'w</span><span>> {
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>inline</span><span>(always)]  </span><span style=color:#abb0b6;font-style:italic>// Added attribute
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>as_unsafe_entity_cell_readonly</span><span>(...) { </span><span style=color:#ed9366>... </span><span>}
</span><span>    
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>inline</span><span>]  </span><span style=color:#abb0b6;font-style:italic>// Added attribute
</span><span>    </span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>as_readonly</span><span>(...) { </span><span style=color:#ed9366>... </span><span>}
</span><span>}
</span></code></pre><h3 id=further-reading>Further Reading</h3><ol><li><a rel="noopener nofollow noreferrer" href=https://nnethercote.github.io/perf-book/inlining.html target=_blank>Rust Performance Book: Inlining</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_ecs/latest/bevy_ecs/world/struct.World.html target=_blank>Bevy ECS World Docs</a><li><a rel="noopener nofollow noreferrer" href=https://llvm.org/docs/Passes.html#inline-inlining target=_blank>LLVM Inlining Thresholds</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-06/pr_19505.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>