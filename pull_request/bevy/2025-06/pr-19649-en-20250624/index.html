<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19649 Split `EntityClonerBuilder` in `OptOut` and `OptIn` variants
        
    </title><meta content="#19649 Split `EntityClonerBuilder` in `OptOut` and `OptIn` variants" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-06/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-06-24</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-06/pr-19649-zh-cn-20250624>中文</a></div></div><div class=pr-content><h1 id=technical-analysis-of-pr-19649-split-entityclonerbuilder-in-optout-and-optin-variants>Technical Analysis of PR #19649: Split <code>EntityClonerBuilder</code> in <code>OptOut</code> and <code>OptIn</code> variants</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Split <code>EntityClonerBuilder</code> in <code>OptOut</code> and <code>OptIn</code> variants<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19649<li><strong>Author</strong>: urben1680<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, C-Feature, A-ECS, C-Code-Quality, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-06-15T01:08:37Z<li><strong>Merged</strong>: 2025-06-24T00:39:04Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>The original description is in English and is preserved as-is:<h1 id=objective>Objective</h1><p>Further tests after #19326 showed that configuring <code>EntityCloner</code> with required components is bug prone and the current design has several weaknesses in it’s API:<ul><li>Mixing <code>EntityClonerBuilder::allow</code> and <code>EntityClonerBuilder::deny</code> requires extra care how to support that which has an impact on surrounding code that has to keep edge cases in mind. This is especially true for attempts to fix the following issues. There is no use-case known (to me) why someone would mix those.<li>A builder with <code>EntityClonerBuilder::allow_all</code> configuration tries to support required components like <code>EntityClonerBuilder::deny_all</code> does, but the meaning of that is conflicting with how you’d expect things to work: <ul><li>If all components should be cloned except component <code>A</code>, do you also want to exclude required components of <code>A</code> too? Or are these also valid without <code>A</code> at the target entity?<li>If <code>EntityClonerBuilder::allow_all</code> should ignore required components and not add them to be filtered away, which purpose has <code>EntityClonerBuilder::without_required_components</code> for this cloner?</ul><li>Other bugs found with the linked PR are: <ul><li>Denying <code>A</code> also denies required components of <code>A</code> even when <code>A</code> does not exist at the source entity<li>Allowing <code>A</code> also allows required components of <code>A</code> even when <code>A</code> does not exist at the source entity</ul><li>Adding <code>allow_if_new</code> filters to the cloner faces the same issues and require a common solution to dealing with source-archetype sensitive cloning</ul><p>Alternative to #19632 and #19635.<h1 id=solution>Solution</h1><p><code>EntityClonerBuilder</code> is made generic and split into <code>EntityClonerBuilder&LTOptOut></code> and <code>EntityClonerBuilder&LTOptIn></code><p>For an overview of the changes, see the migration guide. It is generally a good idea to start a review of that.<h2 id=algorithm>Algorithm</h2><p>The generic of <code>EntityClonerBuilder</code> contains the filter data that is needed to build and clone the entity components.<p>As the filter needs to be borrowed mutably for the duration of the clone, the borrow checker forced me to separate the filter value and all other fields in <code>EntityCloner</code>. The latter are now in the <code>EntityClonerConfig</code> struct. This caused many changed LOC, sorry.<p>To make reviewing easier:<ol><li>Check the migration guide<li>Many methods of <code>EntityCloner</code> now just call identitcal <code>EntityClonerConfig</code> methods with a mutable borrow of the filter<li>Check <code>EntityClonerConfig::clone_entity_internal</code> which changed a bit regarding the filter usage that is now trait powered (<code>CloneByFilter</code>) to support <code>OptOut</code>, <code>OptIn</code> and <code>EntityClonerFilter</code> (an enum combining the first two)<li>Check <code>OptOut</code> type that no longer tracks required components but has a <code>insert_mode</code> field<li>Check <code>OptIn</code> type that has the most logic changes</ol><h1 id=testing>Testing</h1><p>I added a bunch of tests that cover the new logic parts and the fixed issues.<p>Benchmarks are in a comment a bit below which shows ~4% to 9% regressions, but it varied wildly for me. For example at one run the reflection-based clonings were on-par with main while the other are not, and redoing that swapped the situation for both.<p>It would be really cool if I could get some hints how to get better benchmark results or if you could run them on your machine too.<p>Just be aware this is not a Performance PR but a Bugfix PR, even if I smuggled in some more functionalities. So doing changes to <code>EntityClonerBuilder</code> is kind of required here which might make us bite the bullet.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=the-problem-and-context>The Problem and Context</h3><p>The <code>EntityCloner</code> API had several design weaknesses that made it error-prone to configure:<ol><li>Mixing <code>allow</code> and <code>deny</code> methods created complex edge cases<li>Required component handling was inconsistent: <ul><li><code>allow_all</code> configuration tried to handle required components like <code>deny_all</code> but with conflicting semantics<li>Denying a component would incorrectly deny its required components even when absent<li>Allowing a component would incorrectly allow its required components even when absent</ul><li>The <code>allow_if_new</code> feature inherited these issues</ol><p>These problems made the API difficult to use correctly and led to subtle bugs. The core issue was that a single configuration interface tried to support two fundamentally different filtering approaches: opt-in (allow-list) and opt-out (deny-list).<h3 id=the-solution-approach>The Solution Approach</h3><p>The PR splits <code>EntityClonerBuilder</code> into two distinct types:<ul><li><code>EntityClonerBuilder&LTOptOut></code>: Default opt-out behavior (clone all except explicitly denied)<li><code>EntityClonerBuilder&LTOptIn></code>: Opt-in behavior (clone only explicitly allowed)</ul><p>Key design decisions:<ol><li><strong>Separate state tracking</strong>: <ul><li><code>EntityCloner</code> now holds a filter (<code>EntityClonerFilter</code>) and state (<code>EntityClonerState</code>)<li>This separation was necessary due to borrow checker constraints during cloning</ul><li><strong>Trait-based filtering</strong>: <ul><li>Introduced <code>CloneByFilter</code> trait with implementations for both variants<li><code>OptOut</code> uses simple component ID exclusion<li><code>OptIn</code> requires complex dependency tracking for required components</ul><li><strong>Required component handling</strong>: <ul><li><code>OptOut</code>: Denying a component no longer automatically denies its required components<li><code>OptIn</code>: Added scoped configuration via <code>without_required_components</code></ul><li><strong>New insertion modes</strong>: <ul><li>Added <code>InsertMode::Keep</code> to avoid overwriting existing components<li><code>allow_if_new</code> maps to this insertion mode in the <code>OptIn</code> variant</ul></ol><h3 id=the-implementation>The Implementation</h3><p>The core changes occur in <code>clone_entities.rs</code> where:<ol><li><code>EntityCloner</code> was refactored into:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>EntityCloner </span><span>{
</span><span>    filter</span><span style=color:#61676ccc>:</span><span> EntityClonerFilter,
</span><span>    state</span><span style=color:#61676ccc>:</span><span> EntityClonerState,
</span><span>}
</span></code></pre><li>New builder entry points:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>build_opt_out</span><span>(</span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> World) </span><span style=color:#61676ccc>-> </span><span>EntityClonerBuilder&LTOptOut>
</span><span>pub fn build_opt_in(world: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> World) </span><span style=color:#61676ccc>-> </span><span>EntityClonerBuilder&LTOptIn>
</span></code></pre><li>The <code>OptIn</code> filter tracks component dependencies:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>struct </span><span style=color:#399ee6>OptIn </span><span>{
</span><span>    allow</span><span style=color:#61676ccc>: </span><span>HashMap&LTComponentId, Explicit>,
</span><span>    required_of_allow</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Vec</span><span>&LTComponentId>,
</span><span>    required</span><span style=color:#61676ccc>: </span><span>HashMap&LTComponentId, Required>,
</span><span>    attach_required_components</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>bool</span><span>,
</span><span>}
</span></code></pre><li>Filtering logic was moved to the <code>CloneByFilter</code> trait:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>trait </span><span style=color:#399ee6>CloneByFilter </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>clone_components</span><span><</span><span style=color:#fa6e32>'a</span><span>>(...)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre></ol><h3 id=technical-insights>Technical Insights</h3><ol><li><strong>Performance Considerations</strong>: <ul><li>Benchmarks showed 4-9% regression in some cases<li>The <code>OptIn</code> variant has higher overhead due to dependency tracking<li>Tradeoff accepted since this is primarily a correctness fix</ul><li><strong>Borrow Checker Challenges</strong>: <ul><li>The mutable filter borrow during cloning necessitated splitting state<li><code>LazyCell</code> was used for archetype lookups to defer computation</ul><li><strong>Edge Case Handling</strong>: <ul><li><code>OptIn</code> correctly handles partial cloning of required components<li>Counters track required-by relationships to avoid over-cloning</ul><li><strong>API Clarity</strong>: <ul><li>Separate methods for each variant prevent invalid configurations<li>Explicit method names (<code>allow</code> vs <code>allow_if_new</code>) improve intent signaling</ul></ol><h3 id=the-impact>The Impact</h3><ol><li><strong>Fixed Bugs</strong>: <ul><li>Required components are now handled correctly in both variants<li>Source archetype presence is properly respected<li>Component insertion modes work as expected</ul><li><strong>API Improvements</strong>: <ul><li>Clear separation of concerns between opt-in/opt-out<li>New insertion modes provide finer control<li>Required component configuration is scoped</ul><li><strong>Migration Path</strong>: <ul><li>Added comprehensive migration guide<li>Deprecated methods replaced with variant-specific alternatives</ul><li><strong>Test Coverage</strong>: <ul><li>Added 11 new benchmark scenarios<li>Expanded test coverage for edge cases</ul></ol><h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    EC[EntityCloner] --> EF[EntityClonerFilter]
</span><span>    EC --> ES[EntityClonerState]
</span><span>    EF --> OO[OptOut]
</span><span>    EF --> OI[OptIn]
</span><span>    OO --> DM[Deny Methods]
</span><span>    OO --> WR[without_required_by_components]
</span><span>    OI --> AM[Allow Methods]
</span><span>    OI --> WC[without_required_components]
</span><span>    ES --> CC[Clone Config]
</span><span>    ES --> DQ[Deferred Commands]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ecs-src-entity-clone-entities-rs-962-372><code>crates/bevy_ecs/src/entity/clone_entities.rs</code> (+962/-372)</h3><p>Core refactor of the cloning system:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Monolithic EntityCloner
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>EntityCloner </span><span>{
</span><span>    filter_allows_components</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>bool</span><span>,
</span><span>    filter</span><span style=color:#61676ccc>: </span><span>HashSet&LTComponentId>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other fields ...
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Split design
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>EntityCloner </span><span>{
</span><span>    filter</span><span style=color:#61676ccc>:</span><span> EntityClonerFilter,
</span><span>    state</span><span style=color:#61676ccc>:</span><span> EntityClonerState,
</span><span>}
</span><span>
</span><span style=color:#fa6e32>pub enum </span><span style=color:#399ee6>EntityClonerFilter </span><span>{
</span><span>    OptOut(OptOut)</span><span style=color:#61676ccc>,
</span><span>    OptIn(OptIn)</span><span style=color:#61676ccc>,
</span><span>}
</span><span>
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>EntityClonerState </span><span>{
</span><span>    clone_behavior_overrides</span><span style=color:#61676ccc>: </span><span>HashMap&LTComponentId, ComponentCloneBehavior>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other config fields ...
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// New filtering trait
</span><span style=color:#fa6e32>trait </span><span style=color:#399ee6>CloneByFilter </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>clone_components</span><span><</span><span style=color:#fa6e32>'a</span><span>>(...)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=benches-benches-bevy-ecs-entity-cloning-rs-173-47><code>benches/benches/bevy_ecs/entity_cloning.rs</code> (+173/-47)</h3><p>Added comprehensive filter benchmarking:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>enum </span><span style=color:#399ee6>FilterScenario </span><span>{
</span><span>    OptOutNone</span><span style=color:#61676ccc>,
</span><span>    OptOutNoneKeep(</span><span style=color:#fa6e32>bool</span><span>)</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... 11 scenarios total ...
</span><span>}
</span><span>
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>bench_filter</span><span>&LTB</span><span style=color:#61676ccc>:</span><span> Bundle </span><span style=color:#ed9366>+ </span><span style=color:#55b4d4;font-style:italic>Default</span><span>>(
</span><span>    </span><span style=color:#ff8f40>b</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> Bencher, 
</span><span>    </span><span style=color:#ff8f40>scenario</span><span style=color:#61676ccc>:</span><span> FilterScenario
</span><span>) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Configures cloner based on scenario
</span><span>    </span><span style=color:#fa6e32>match</span><span> scenario {
</span><span>        FilterScenario</span><span style=color:#ed9366>::</span><span>OptOutNone </span><span style=color:#ed9366>=> </span><span>{
</span><span>            target </span><span style=color:#ed9366>= </span><span style=color:#f07171>spawn</span><span>(</span><span style=color:#ff8f40>true</span><span>)</span><span style=color:#61676ccc>;
</span><span>            cloner </span><span style=color:#ed9366>= </span><span>EntityCloner</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ... other scenarios ...
</span><span>    }
</span><span>}
</span></code></pre><h3 id=crates-bevy-ecs-src-world-entity-ref-rs-143-39><code>crates/bevy_ecs/src/world/entity_ref.rs</code> (+143/-39)</h3><p>Updated entity methods to use new variants:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>clone_with</span><span>(
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>,
</span><span>    </span><span style=color:#ff8f40>target</span><span style=color:#61676ccc>:</span><span> Entity,
</span><span>    </span><span style=color:#ff8f40>config</span><span style=color:#61676ccc>:</span><span> impl FnOnce(&</span><span style=color:#ff8f40>mut EntityClonerBuilder</span><span>),
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut Self
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>clone_with_opt_out</span><span>(
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>,
</span><span>    </span><span style=color:#ff8f40>target</span><span style=color:#61676ccc>:</span><span> Entity,
</span><span>    </span><span style=color:#ff8f40>config</span><span style=color:#61676ccc>:</span><span> impl FnOnce(&</span><span style=color:#ff8f40>mut EntityClonerBuilder</span><span><</span><span style=color:#ff8f40>OptOut</span><span>>),
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut Self
</span><span>
</span><span>pub fn clone_with_opt_in(
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> self,
</span><span>    target: Entity,
</span><span>    config: impl FnOnce(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span>EntityClonerBuilder&LTOptIn>),
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut Self
</span></code></pre><h3 id=crates-bevy-ecs-src-system-commands-mod-rs-113-24><code>crates/bevy_ecs/src/system/commands/mod.rs</code> (+113/-24)</h3><p>Updated commands API:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>clone_with</span><span>(
</span><span>    </span><span style=color:#ff8f40>target</span><span style=color:#61676ccc>:</span><span> Entity,
</span><span>    </span><span style=color:#ff8f40>config</span><span style=color:#61676ccc>:</span><span> impl FnOnce(&</span><span style=color:#ff8f40>mut EntityClonerBuilder</span><span>),
</span><span>) </span><span style=color:#61676ccc>-></span><span> impl EntityCommand
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>clone_with_opt_out</span><span>(
</span><span>    </span><span style=color:#ff8f40>target</span><span style=color:#61676ccc>:</span><span> Entity,
</span><span>    </span><span style=color:#ff8f40>config</span><span style=color:#61676ccc>:</span><span> impl FnOnce(&</span><span style=color:#ff8f40>mut EntityClonerBuilder</span><span><</span><span style=color:#ff8f40>OptOut</span><span>>),
</span><span>) </span><span style=color:#61676ccc>-></span><span> impl EntityCommand
</span><span>
</span><span>pub fn clone_with_opt_in(
</span><span>    target: Entity,
</span><span>    config: impl FnOnce(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span>EntityClonerBuilder&LTOptIn>),
</span><span>) </span><span style=color:#61676ccc>-></span><span> impl EntityCommand
</span></code></pre><h3 id=release-content-migration-guides-entity-cloner-builder-split-md-73-0><code>release-content/migration-guides/entity_cloner_builder_split.md</code> (+73/-0)</h3><p>Added migration guide:<pre class=language-markdown data-lang=markdown style=color:#61676c;background-color:#fafafa><code class=language-markdown data-lang=markdown><span style=color:#fa6e32;font-weight:700>## </span><span style=color:#399ee6;font-weight:700>Migration Guide
</span><span>
</span><span style=color:#4cbf99>- </span><span style=color:#ed9366;background-color:#61676c10>`EntityCloner::build`</span><span> replaced with:
</span><span>  </span><span style=color:#4cbf99>- </span><span style=color:#ed9366;background-color:#61676c10>`EntityCloner::build_opt_out`</span><span>
</span><span>  </span><span style=color:#4cbf99>- </span><span style=color:#ed9366;background-color:#61676c10>`EntityCloner::build_opt_in`</span><span>
</span><span style=color:#4cbf99>-</span><span> Method renames:
</span><span>  </span><span style=color:#4cbf99>- </span><span style=color:#ed9366;background-color:#61676c10>`clone_with`</span><span> → </span><span style=color:#ed9366;background-color:#61676c10>`clone_with_opt_out`</span><span>/</span><span style=color:#ed9366;background-color:#61676c10>`clone_with_opt_in`</span><span>
</span><span>  </span><span style=color:#4cbf99>- </span><span style=color:#ed9366;background-color:#61676c10>`clone_and_spawn_with`</span><span> → </span><span style=color:#ed9366;background-color:#61676c10>`clone_and_spawn_with_opt_out`</span><span>/</span><span style=color:#ed9366;background-color:#61676c10>`clone_and_spawn_with_opt_in`</span><span>
</span><span>
</span><span>Example migration:
</span><span>```</span><span style=color:#ff8f40>rust
</span><span style=color:#abb0b6;background-color:#61676c07;font-style:italic>// 0.16
</span><span style=color:#61676c;background-color:#61676c07>EntityCloner</span><span style=color:#ed9366;background-color:#61676c07>::</span><span style=color:#61676c;background-color:#61676c07>build(</span><span style=color:#ed9366;background-color:#61676c07>&</span><span style=color:#fa6e32;background-color:#61676c07>mut</span><span style=color:#61676c;background-color:#61676c07> world)
</span><span style=color:#61676c;background-color:#61676c07>    </span><span style=color:#ed9366;background-color:#61676c07>.</span><span style=color:#f07171;background-color:#61676c07>allow_all</span><span style=color:#61676c;background-color:#61676c07>()
</span><span style=color:#61676c;background-color:#61676c07>    </span><span style=color:#ed9366;background-color:#61676c07>.</span><span style=color:#61676c;background-color:#61676c07>deny</span><span style=color:#ed9366;background-color:#61676c07>::</span><span style=color:#61676c;background-color:#61676c07>&LTComponentA>()</span><span style=color:#61676ccc;background-color:#61676c07>;
</span><span style=color:#61676c;background-color:#61676c07>
</span><span style=color:#abb0b6;background-color:#61676c07;font-style:italic>// 0.17
</span><span style=color:#61676c;background-color:#61676c07>EntityCloner</span><span style=color:#ed9366;background-color:#61676c07>::</span><span style=color:#61676c;background-color:#61676c07>build_opt_out(</span><span style=color:#ed9366;background-color:#61676c07>&</span><span style=color:#fa6e32;background-color:#61676c07>mut</span><span style=color:#61676c;background-color:#61676c07> world)
</span><span style=color:#61676c;background-color:#61676c07>    </span><span style=color:#ed9366;background-color:#61676c07>.</span><span style=color:#61676c;background-color:#61676c07>deny</span><span style=color:#ed9366;background-color:#61676c07>::</span><span style=color:#61676c;background-color:#61676c07>&LTComponentA>()</span><span style=color:#61676ccc;background-color:#61676c07>;
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Entity_component_system target=_blank>Entity Component System Architecture</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/plugins/ecs/ target=_blank>Bevy ECS Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/nomicon/lifetimes.html target=_blank>Rust Borrow Checker Patterns</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-06/pr_19649.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>