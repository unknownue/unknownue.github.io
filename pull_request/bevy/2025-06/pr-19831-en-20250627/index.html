<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19831 cleanup constants
        
    </title><meta content="#19831 cleanup constants" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-06/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-06-27</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-06/pr-19831-zh-cn-20250627>中文</a></div></div><div class=pr-content><h3 id=pr-analysis-cleanup-constants-19831>PR Analysis: Cleanup Constants (#19831)</h3><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: cleanup constants<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19831<li><strong>Author</strong>: atlv24<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: None<li><strong>Created</strong>: 2025-06-27T06:15:11Z<li><strong>Merged</strong>: 2025-06-27T07:21:16Z<li><strong>Merged By</strong>: superdump</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>I think const expressions weren’t supported in Naga when these were written, and we’ve just stuck with that since then. They’re supported now so let’s use them</ul><h2 id=solution>Solution</h2><ul><li>Do that thang</ul><h2 id=testing>Testing</h2><ul><li>transparency_3d, transmission, ssr, 3d_scene, couple others. They all look fine</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p><strong>The Problem and Context</strong><br> The Bevy engine’s PBR rendering pipeline uses bitmask flags extensively in its WGSL shaders to represent material properties and rendering states. Originally, these flags were defined as raw numeric literals (like <code>1073741824u</code>) because Naga (Bevy’s shader translation layer) didn’t support constant expressions when the code was first written. Over time, this approach became problematic:<ol><li>Raw numbers are opaque and require manual bit position calculations<li>Maintenance is error-prone when adding new flags<li>The code is harder to read and verify<li>Naga added support for const expressions, making the old approach obsolete</ol><p><strong>The Solution Approach</strong><br> The developer identified that all affected constants could be rewritten using bit-shift expressions (<code>1u << n</code>) for clearer intent and better maintainability. This approach:<ol><li>Explicitly shows which bit position each flag occupies<li>Eliminates manual calculation of large numeric literals<li>Uses standard bit manipulation patterns familiar to graphics programmers<li>Requires no functional changes to the rendering logic</ol><p>No alternatives were considered since the solution directly addresses the root issue. The changes are localized to constant definitions and don’t affect shader logic.<p><strong>The Implementation</strong><br> The changes update four WGSL files containing flag definitions. Each modification replaces numeric literals with equivalent shift operations:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before
</span><span>const MESH_FLAGS_NO_FRUSTUM_CULLING_BIT: u32 = 268435456u;
</span><span>
</span><span>// After
</span><span>const MESH_FLAGS_NO_FRUSTUM_CULLING_BIT: u32 = 1u << 28u;
</span></code></pre><p>The most significant update occurs in <code>pbr_types.wgsl</code>, where all 24 material flag constants were converted. Complex bitmask definitions like visibility range indices were also improved:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before
</span><span>const MESH_FLAGS_VISIBILITY_RANGE_INDEX_BITS: u32 = 65535u;
</span><span>
</span><span>// After (clearer intent)
</span><span>const MESH_FLAGS_VISIBILITY_RANGE_INDEX_BITS: u32 = (1u << 16u) - 1u;
</span></code></pre><p>Alpha mode flags were updated to use consistent shift patterns:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before
</span><span>const STANDARD_MATERIAL_FLAGS_ALPHA_MODE_MASK: u32 = 536870912u;
</span><span>
</span><span>// After (explicit bit position)
</span><span>const STANDARD_MATERIAL_FLAGS_ALPHA_MODE_MASK: u32 = 1u << 29u;
</span></code></pre><p><strong>Technical Insights</strong><br> The changes demonstrate several good practices:<ol><li><strong>Bitmask Hygiene</strong>: Using <code>1u << n</code> prevents accidental overlap and makes bit positions explicit<li><strong>Compiler Compatibility</strong>: Leveraging newer WGSL features when toolchain support matures<li><strong>Technical Debt Reduction</strong>: Proactively updating patterns when dependencies evolve<li><strong>Validation</strong>: Maintaining existing bitmask values ensures backward compatibility</ol><p><strong>The Impact</strong><br> These changes provide immediate benefits:<ol><li><strong>Readability</strong>: Bit positions are now explicit rather than implied<li><strong>Maintainability</strong>: Adding new flags requires less manual calculation<li><strong>Debugging</strong>: Easier to verify bitmask logic during shader development<li><strong>Consistency</strong>: Standardizes bitflag patterns across the codebase</ol><p>Testing confirmed no visual regressions in key rendering features like transparency, SSR, and 3D scenes.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Deferred Rendering] --> B[pbr_deferred_types.wgsl]
</span><span>    C[Mesh Processing] --> D[mesh_types.wgsl]
</span><span>    E[View Processing] --> F[mesh_view_types.wgsl]
</span><span>    G[PBR Core] --> H[pbr_types.wgsl]
</span><span>    B --> G
</span><span>    D --> G
</span><span>    F --> G
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-pbr-src-render-pbr-types-wgsl-28-30><code>crates/bevy_pbr/src/render/pbr_types.wgsl</code> (+28/-30)</h3><p><strong>Purpose</strong>: Update material flag constants to use bit-shift expressions<br> <strong>Key Changes</strong>:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>const STANDARD_MATERIAL_FLAGS_BASE_COLOR_TEXTURE_BIT: u32 = 1u;
</span><span>const STANDARD_MATERIAL_FLAGS_ALPHA_MODE_MASK: u32 = 536870912u;
</span><span>
</span><span>// After:
</span><span>const STANDARD_MATERIAL_FLAGS_BASE_COLOR_TEXTURE_BIT: u32 = 1u << 0u;
</span><span>const STANDARD_MATERIAL_FLAGS_ALPHA_MODE_MASK: u32 = 1u << 29u;
</span></code></pre><h3 id=crates-bevy-pbr-src-render-mesh-types-wgsl-6-9><code>crates/bevy_pbr/src/render/mesh_types.wgsl</code> (+6/-9)</h3><p><strong>Purpose</strong>: Improve mesh flag constant definitions<br> <strong>Key Changes</strong>:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>const MESH_FLAGS_NO_FRUSTUM_CULLING_BIT: u32 = 268435456u;
</span><span>
</span><span>// After:
</span><span>const MESH_FLAGS_NO_FRUSTUM_CULLING_BIT: u32 = 1u << 28u;
</span></code></pre><h3 id=crates-bevy-pbr-src-render-mesh-view-types-wgsl-7-7><code>crates/bevy_pbr/src/render/mesh_view_types.wgsl</code> (+7/-7)</h3><p><strong>Purpose</strong>: Update light flag constants<br> <strong>Key Changes</strong>:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>const POINT_LIGHT_FLAGS_SHADOWS_ENABLED_BIT: u32 = 1u;
</span><span>
</span><span>// After:
</span><span>const POINT_LIGHT_FLAGS_SHADOWS_ENABLED_BIT: u32 = 1u << 0u;
</span></code></pre><h3 id=crates-bevy-pbr-src-deferred-pbr-deferred-types-wgsl-3-3><code>crates/bevy_pbr/src/deferred/pbr_deferred_types.wgsl</code> (+3/-3)</h3><p><strong>Purpose</strong>: Standardize deferred rendering flags<br> <strong>Key Changes</strong>:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>const DEFERRED_FLAGS_UNLIT_BIT: u32 = 1u;
</span><span>
</span><span>// After:
</span><span>const DEFERRED_FLAGS_UNLIT_BIT: u32 = 1u << 0u;
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://www.w3.org/TR/WGSL/#bit-expr target=_blank>WGSL Bitwise Operations</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/next/pbr/ target=_blank>Bevy PBR Rendering Architecture</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/gfx-rs/naga target=_blank>Naga Shader Translation</a><li><a rel="noopener nofollow noreferrer" href=https://graphicsprogrammingpatterns.com/pattern/bitmask-flags/ target=_blank>Bitmask Patterns in Graphics Programming</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-06/pr_19831.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>