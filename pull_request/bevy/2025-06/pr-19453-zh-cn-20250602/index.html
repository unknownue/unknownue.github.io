<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19453 Exclude `ctrlc` from `bevy_app` for the Nintendo 3DS
        
    </title><meta content="#19453 Exclude `ctrlc` from `bevy_app` for the Nintendo 3DS" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-06/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-06-02</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2025-06/pr-19453-en-20250602>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=pr-19453-fen-xi-zai-nintendo-3ds-ping-tai-pai-chu-ctrlc-yi-lai>PR #19453 分析：在 Nintendo 3DS 平台排除 <code>ctrlc</code> 依赖</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Exclude <code>ctrlc</code> from <code>bevy_app</code> for the Nintendo 3DS<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19453<li><strong>Author</strong>: selvmaya<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-ECS, S-Ready-For-Final-Review, D-Straightforward, C-Machine-Specific<li><strong>Created</strong>: 2025-05-31T20:53:31Z<li><strong>Merged</strong>: 2025-06-02T22:39:58Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h3 id=bei-jing-dong-ji-background-motivation>背景/动机 (Background/motivation)</h3><p>Nintendo 3DS 由 Rust 的 tier 3 目标 <a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/rustc/platform-support/armv6k-nintendo-3ds.html#armv6k-nintendo-3ds target=_blank>armv6k-nintendo-3ds</a> 支持。Bevy 并不官方支持该设备，但随着 Bevy 逐渐兼容 <code>no_std</code>，越来越多的目标得到部分支持（例如 GBA - https://github.com/bevyengine/bevy/discussions/10680, https://github.com/bushrat011899/bevy_mod_gba），无论是官方还是非官方。<p>Nintendo 3DS 运行 Horizon 作为其操作系统，该系统基于 <a rel="noopener nofollow noreferrer" href=https://github.com/rust-lang/rust/blob/4d08223c054cf5a56d9761ca925fd46ffebe7115/compiler/rustc_target/src/spec/targets/armv6k_nintendo_3ds.rs#L34 target=_blank>Unix</a>，并且上述目标（至少部分）支持 Rust 标准库。使用标准库是有意义的，因为 3DS 支持文件系统读取和系统时钟等功能。<h3 id=wen-ti-problem>问题 (Problem)</h3><p>与标准的 Unix 目标不同，<code>armv6k-nintendo-3ds</code> 无法使用/构建 <code>bevy_app</code> 中的 <code>ctrlc</code> 依赖项，该依赖项由 Bevy 的 <code>std</code> Cargo 特性启用。<p>在没有 <code>std</code> 特性标志的情况下，调度系统会崩溃，因为没有提供另一种方式让 Bevy 使用 <code>Instant</code> 类型进行计时（就像你在 <a rel="noopener nofollow noreferrer" href=https://github.com/bushrat011899/bevy_mod_gba/blob/72d8bbf47b33a0ab2f825d80e9ed0b6e5268bf1e/src/time.rs#L36 target=_blank>GBA</a> 上可能做的那样）。<details><summary>示例 (Example)</summary> <pre style=color:#61676c;background-color:#fafafa><code><span>    Finished `dev` profile [optimized + debuginfo] target(s) in 1m 39s
</span><span>Building smdh: /home/maya/repos/hyperspace-dj/target/armv6k-nintendo-3ds/debug/hyperspace-dj.smdh
</span><span>Building 3dsx: /home/maya/repos/hyperspace-dj/target/armv6k-nintendo-3ds/debug/hyperspace-dj.3dsx
</span><span>Adding RomFS from /home/maya/repos/hyperspace-dj/romfs
</span><span>Running 3dslink
</span><span>Sending hyperspace-dj.3dsx, 7172344 bytes
</span><span>2777346 sent (38.72%), 233 blocks
</span><span>starting server
</span><span>server active ...
</span><span>hii we'are about the to start the bevy app
</span><span>
</span><span>thread 'main' panicked at /home/maya/repos/bevy/crates/bevy_platform/src/time/fallback.rs:177:13:
</span><span>An elapsed time getter has not been provided to `Instant`. Please use `Instant::set_elapsed(...)` before calling `Instant::now()`
</span><span>note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
</span></code></pre></details><h3 id=jie-jue-fang-an-solution>解决方案 (Solution)</h3><p>本 PR 仅通过在其现有特性标志中添加一项，将 <code>ctrlc</code> 依赖项及其在 <code>bevy_app</code> 中的使用排除在 3DS 目标（<code>horizon</code>）之外。<p>修复后，我们可以使用 <code>std</code> 特性，并且常规的调度系统不再因缺少 <code>Instant</code>（系统时钟）支持而崩溃。<h3 id=ce-shi-testing>测试 (Testing)</h3><p>我使用修改后的 bevy 版本，在物理 3DS（经典款）上使用自制软件和 <code>cargo-3ds</code>，编译并运行了一个二进制文件，使用了 <code>no_default_features</code> 和特性标志 <code>default_no_std</code> 以及 <code>std</code>。<p>工具链：<a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/rustc/platform-support/armv6k-nintendo-3ds.html#armv6k-nintendo-3ds target=_blank>armv6k-nintendo-3ds</a> (nightly-2025-03-31) 项目参考：https://codeberg.org/pollyglot/hyperspace-dj/commit/440fc1018468885eed4c10c163f6bf3eefc64cb1<h3 id=kao-lu-yin-su-considerations>考虑因素 (Considerations)</h3><p>可能我们不想在 bevy 内部添加特定异常来支持具有特殊行为的特定硬件，但除了在目标配置中使用异常（已有）之外，我不清楚应该使用什么替代方案：这里的每一个更改仅仅是对已经检查目标家族和<code>std</code>标志的配置的补充。<p>目前尚不清楚这个 PR 是否足够全面，足以被视为对更大目标（部分支持 3DS）的充分解决方案，但它似乎是朝着正确方向迈出的一步，因为它至少让带有调度系统的简单 App::run 设置能够工作。<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=wen-ti-he-bei-jing>问题和背景</h3><p>开发者尝试在 Nintendo 3DS 上运行 Bevy 应用时遇到了运行时崩溃。具体错误是调度系统因缺少 <code>Instant</code> 时间支持而 panic。根本原因是 3DS 的 Horizon OS 虽基于 Unix，但不支持 <code>ctrlc</code> 库，而该库由 Bevy 的 <code>std</code> 特性引入。<p>这个问题在技术上是矛盾的：3DS 需要 <code>std</code> 特性来启用系统时钟（支持 <code>Instant</code>），但 <code>std</code> 特性又引入了不兼容的 <code>ctrlc</code> 依赖。错误信息显示：<pre style=color:#61676c;background-color:#fafafa><code><span>An elapsed time getter has not been provided to `Instant`
</span></code></pre><p>表明时间系统初始化失败，导致调度器无法运作。<h3 id=jie-jue-fang-an>解决方案</h3><p>解决方案是修改条件编译，在 3DS 目标（通过 <code>target_os = "horizon"</code> 标识）上排除 <code>ctrlc</code> 依赖。具体实现是在现有条件编译规则中添加特例：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#f07171>all</span><span>(unix</span><span style=color:#61676ccc>, </span><span style=color:#f07171>not</span><span>(target_os </span><span style=color:#ed9366>= </span><span style=color:#86b300>"horizon"</span><span>))
</span></code></pre><p>这样既保留了 Unix 和 Windows 平台的原有行为，又排除了 Horizon 平台。<h3 id=shi-xian-xi-jie>实现细节</h3><p>修改涉及三个文件：<ol><li><strong>Cargo.toml</strong>：调整依赖的目标条件<li><strong>lib.rs</strong>：修改模块导入条件<li><strong>default_plugins.rs</strong>：调整插件启用条件</ol><p>所有修改都使用相同的条件表达式，确保逻辑一致性。这种模式匹配方法避免了平台检测代码重复，同时保持对其他平台行为的零影响。<h3 id=ji-shu-kao-liang>技术考量</h3><p>这个修改展示了条件编译在跨平台支持中的实际应用：<ol><li>使用 <code>cfg</code> 宏精确控制平台特定代码<li>通过布尔逻辑组合条件（<code>all</code>/<code>any</code>/<code>not</code>）<li>保持向后兼容性 - 只排除特定目标<li>最小化变更范围（仅修改 3 个文件，共 4 行）</ol><h3 id=ying-xiang>影响</h3><p>这个 PR 解决了在 3DS 上使用 <code>std</code> 特性时的启动崩溃问题。经过测试验证，修改后应用能正常启动并运行调度系统。虽然不构成官方支持，但为社区在嵌入式设备上使用 Bevy 提供了可行路径。<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[std feature] --> B[ctrlc dependency]
</span><span>    B --> C[Unix/Win signal handling]
</span><span>    D[Horizon OS] -->|Excluded by cfg| B
</span><span>    E[3DS App] -->|Requires| F[Instant clock]
</span><span>    F -->|Depends on| A
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=1-crates-bevy-app-cargo-toml>1. <code>crates/bevy_app/Cargo.toml</code></h3><p><strong>修改原因</strong>：排除 3DS 目标上的 <code>ctrlc</code> 依赖<pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span style=color:#f07171>- [target.'cfg(any(unix, windows))'.dependencies]
</span><span style=color:#86b300>+ [target.'cfg(any(all(unix, not(target_os = "horizon")), windows))'.dependencies]
</span><span>ctrlc = { version = "3.4.4", optional = true }
</span></code></pre><h3 id=2-crates-bevy-app-src-lib-rs>2. <code>crates/bevy_app/src/lib.rs</code></h3><p><strong>修改原因</strong>：条件排除信号处理模块<pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span style=color:#f07171>- #[cfg(all(any(unix, windows), feature = "std"))]
</span><span style=color:#86b300>+ #[cfg(all(any(all(unix, not(target_os = "horizon")), windows), feature = "std"))]
</span><span>mod terminal_ctrl_c_handler;
</span><span>
</span><span style=color:#f07171>- #[cfg(all(any(unix, windows), feature = "std"))]
</span><span style=color:#86b300>+ #[cfg(all(any(all(unix, not(target_os = "horizon")), windows), feature = "std"))]
</span><span>pub use terminal_ctrl_c_handler::*;
</span></code></pre><h3 id=3-crates-bevy-internal-src-default-plugins-rs>3. <code>crates/bevy_internal/src/default_plugins.rs</code></h3><p><strong>修改原因</strong>：防止在 3DS 添加不兼容插件<pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>#[cfg(feature = "std")]
</span><span style=color:#f07171>- #[custom(cfg(any(unix, windows)))]
</span><span style=color:#86b300>+ #[custom(cfg(any(all(unix, not(target_os = "horizon")), windows)))]
</span><span>bevy_app:::TerminalCtrlCHandlerPlugin,
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/reference/conditional-compilation.html target=_blank>Rust 条件编译文档</a> - 理解 <code>cfg</code> 机制<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/discussions/10680 target=_blank>Bevy 平台支持讨论</a> - 社区嵌入式平台实践<li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/rustc/platform-support/armv6k-nintendo-3ds.html target=_blank>Rust 对 Nintendo 3DS 支持</a> - 目标平台技术细节<li><a rel="noopener nofollow noreferrer" href=https://docs.rs/ctrlc/latest/ctrlc/ target=_blank>ctrlc crate 文档</a> - 被排除依赖的功能</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-06/pr_19453.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>