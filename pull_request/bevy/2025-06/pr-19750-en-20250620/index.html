<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19750 Fix QueryData derive codegen
        
    </title><meta content="#19750 Fix QueryData derive codegen" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-06/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-06-20</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-06/pr-19750-zh-cn-20250620>中文</a></div></div><div class=pr-content><h1 id=fix-querydata-derive-codegen>Fix QueryData derive codegen</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix QueryData derive codegen<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19750<li><strong>Author</strong>: ecoskey<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-ECS, S-Ready-For-Final-Review, D-Straightforward<li><strong>Created</strong>: 2025-06-20T07:22:49Z<li><strong>Merged</strong>: 2025-06-20T16:06:25Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>Custom derived <code>QueryData</code> impls currently generate <code>Item</code> structs with the lifetimes swapped, which blows up the borrow checker sometimes.<p>See: https://discord.com/channels/691052431525675048/749335865876021248/1385509416086011914<p>could add a regression test, TBH I don’t know the error well enough to do that minimally. Seems like it’s that both lifetimes on <code>QueryData::Item</code> need to be covariant, but I’m not sure.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=the-problem-and-context>The Problem and Context</h3><p>The Bevy engine’s ECS system uses a <code>QueryData</code> derive macro to generate boilerplate code for query types. A bug was discovered where custom derived implementations were generating structs with swapped lifetimes for <code>QueryData::Item</code>. This caused borrow checker failures due to incorrect lifetime variance. The issue manifested when developers created custom query types using the derive macro, leading to compilation errors that were difficult to diagnose. The problem was reported in the Bevy Discord community, highlighting its impact on real-world usage.<h3 id=the-solution-approach>The Solution Approach</h3><p>The root cause was identified in the macro’s generic parameter ordering. The original implementation inserted lifetimes in an order that inverted their positions in the generated code. The solution required adjusting the insertion order of two lifetime parameters (<code>'__w</code> and <code>'__s</code>) in the generated generic type parameters. This ensures the world lifetime (<code>'__w</code>) appears before the state lifetime (<code>'__s</code>), matching the expected variance requirements of the <code>QueryData</code> trait.<h3 id=the-implementation>The Implementation</h3><p>The fix modifies the order of lifetime parameter insertion in the macro’s code generation logic. Originally, the state lifetime was inserted at index 0 followed by the world lifetime at index 0 (pushing the state lifetime to index 1). The corrected version inserts the world lifetime at index 0 first, then inserts the state lifetime at index 1, maintaining proper ordering.<p>Key technical insight: The <code>QueryData</code> trait requires covariance in both lifetimes of its associated <code>Item</code> type. Swapping the lifetimes violated this requirement, causing the borrow checker to reject valid code. The fix ensures the generated code matches the trait’s lifetime ordering expectations.<h3 id=the-impact>The Impact</h3><p>This change resolves borrow checker errors in custom <code>QueryData</code> implementations without affecting existing functionality. It maintains backward compatibility while fixing a subtle code generation issue. Developers can now use the derive macro without encountering confusing lifetime errors. The fix is minimal (single-line change) and focused, reducing risk of unintended side effects.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[QueryData Derive Macro] --> B[Generates Impl Block]
</span><span>    B --> C[Defines Item Type]
</span><span>    C --> D[Uses Lifetimes in Struct]
</span><span>    D --> E{Correct Lifetime Order?}
</span><span>    E -->|Yes| F[Compilation Succeeds]
</span><span>    E -->|No| G[Borrow Checker Error]
</span><span>    F --> H[Valid ECS Queries]
</span><span>    G --> I[Compilation Failure]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ecs-macros-src-query-data-rs>crates/bevy_ecs/macros/src/query_data.rs</h3><p>This file contains the derive macro implementation for <code>QueryData</code>. The change fixes the order of lifetime parameter insertion in the generated generic type parameters.<p><strong>Before:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let</span><span> user_generics_with_world_and_state </span><span style=color:#ed9366>= </span><span>{
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> generics </span><span style=color:#ed9366>=</span><span> ast</span><span style=color:#ed9366>.</span><span>generics</span><span style=color:#61676ccc>;
</span><span>    generics</span><span style=color:#ed9366>.</span><span>params</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(</span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>, </span><span style=color:#f07171>parse_quote!</span><span>(</span><span style=color:#fa6e32>'__w</span><span>))</span><span style=color:#61676ccc>;
</span><span>    generics</span><span style=color:#ed9366>.</span><span>params</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(</span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>, </span><span style=color:#f07171>parse_quote!</span><span>(</span><span style=color:#fa6e32>'__s</span><span>))</span><span style=color:#61676ccc>;
</span><span>    generics
</span><span>}</span><span style=color:#61676ccc>;
</span></code></pre><p><strong>After:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let</span><span> user_generics_with_world_and_state </span><span style=color:#ed9366>= </span><span>{
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> generics </span><span style=color:#ed9366>=</span><span> ast</span><span style=color:#ed9366>.</span><span>generics</span><span style=color:#61676ccc>;
</span><span>    generics</span><span style=color:#ed9366>.</span><span>params</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(</span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>, </span><span style=color:#f07171>parse_quote!</span><span>(</span><span style=color:#fa6e32>'__w</span><span>))</span><span style=color:#61676ccc>;
</span><span>    generics</span><span style=color:#ed9366>.</span><span>params</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(</span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>, </span><span style=color:#f07171>parse_quote!</span><span>(</span><span style=color:#fa6e32>'__s</span><span>))</span><span style=color:#61676ccc>;
</span><span>    generics
</span><span>}</span><span style=color:#61676ccc>;
</span></code></pre><p>The change swaps the insertion order:<ol><li>World lifetime (<code>'__w</code>) inserted at position 0<li>State lifetime (<code>'__s</code>) inserted at position 1 (after <code>'__w</code>) Previously, both were inserted at position 0, causing inverted ordering.</ol><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/ecs/queries/ target=_blank>Bevy ECS Query System Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/nomicon/subtyping.html target=_blank>Rust Lifetime Variance Explained</a><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/reference/procedural-macros.html target=_blank>Procedural Macros Guide</a><li><a rel="noopener nofollow noreferrer" href=https://discord.com/channels/691052431525675048/749335865876021248/1385509416086011914 target=_blank>Original Discord Discussion</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-06/pr_19750.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>