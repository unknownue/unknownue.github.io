<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19330 Color interpolation in OKLab, OKLCH spaces for UI gradients
        
    </title><meta content="#19330 Color interpolation in OKLab, OKLCH spaces for UI gradients" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-06/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-06-21</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-06/pr-19330-zh-cn-20250621>中文</a></div></div><div class=pr-content><h1 id=technical-analysis-of-pr-19330-color-interpolation-in-oklab-oklch-spaces-for-ui-gradients>Technical Analysis of PR #19330: Color interpolation in OKLab, OKLCH spaces for UI gradients</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Color interpolation in OKLab, OKLCH spaces for UI gradients<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19330<li><strong>Author</strong>: ickshonpe<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Feature, A-Rendering, A-UI, S-Ready-For-Final-Review, X-Uncontroversial, D-Shaders, M-Deliberate-Rendering-Change<li><strong>Created</strong>: 2025-05-21T23:59:40Z<li><strong>Merged</strong>: 2025-06-21T15:24:13Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Add support for interpolation in OKLab and OKLCH color spaces for UI gradients.<h2 id=solution>Solution</h2><ul><li>New <code>InterpolationColorSpace</code> enum with <code>OkLab</code>, <code>OkLch</code>, <code>OkLchLong</code>, <code>Srgb</code> and <code>LinearRgb</code> variants.<li>Added a color space specialization to the gradients pipeline.<li>Added support for interpolation in OkLCH and OkLAB color spaces to the gradients shader. OKLCH interpolation supports both short and long hue paths. This is mostly based on the conversion functions from <code>bevy_color</code> except that interpolation in polar space uses radians.<li>Added <code>color_space</code> fields to each gradient type.</ul><h2 id=testing>Testing</h2><p>The <code>gradients</code> example has been updated to demonstrate the different color interpolation methods. Press space to cycle through the different options.<hr><h2 id=showcase>Showcase</h2><p><img alt=color_spaces src=https://github.com/user-attachments/assets/e10f8342-c3c8-487e-b386-7acdf38d638f><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=the-problem-and-context>The Problem and Context</h3><p>Bevy’s UI gradient system only supported interpolation in sRGB and linear RGB color spaces. These spaces don’t always produce perceptually uniform gradients, particularly when transitioning between hues. The OKLab and OKLCH color spaces provide more perceptually uniform gradients but weren’t supported. This limited visual quality for UI elements using gradients.<p>The key technical constraints were:<ol><li>Maintaining backward compatibility with existing gradient APIs<li>Implementing efficient color space conversions in shaders<li>Supporting both short and long hue paths for polar color spaces<li>Integrating with Bevy’s existing gradient pipeline architecture</ol><h3 id=the-solution-approach>The Solution Approach</h3><p>The solution introduced a new <code>InterpolationColorSpace</code> enum to configure gradient color spaces. The approach:<ol><li>Added color space configuration to all gradient types<li>Implemented WGSL functions for OKLab/OKLCH conversions<li>Modified the gradient shader to select interpolation methods using shader defines<li>Added pipeline specialization based on color space<li>Created helper methods for convenient color space configuration</ol><p>Alternatives considered included implementing color space conversion on CPU, but this was rejected due to performance implications. The shader-based approach maintains rendering performance while providing flexibility.<h3 id=the-implementation>The Implementation</h3><p>The implementation added a <code>color_space</code> field to all gradient structs (<code>LinearGradient</code>, <code>RadialGradient</code>, <code>ConicGradient</code>). This field uses the new <code>InterpolationColorSpace</code> enum:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub enum </span><span style=color:#399ee6>InterpolationColorSpace </span><span>{
</span><span>    OkLab</span><span style=color:#61676ccc>,
</span><span>    OkLch</span><span style=color:#61676ccc>,
</span><span>    OkLchLong</span><span style=color:#61676ccc>,
</span><span>    Srgb</span><span style=color:#61676ccc>,
</span><span>    LinearRgb</span><span style=color:#61676ccc>,
</span><span>}
</span></code></pre><p>The <code>InColorSpace</code> trait provides a builder pattern for configuration:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub trait </span><span style=color:#399ee6>InColorSpace</span><span>: Sized {
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>in_color_space</span><span>(</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>color_space</span><span style=color:#61676ccc>:</span><span> InterpolationColorSpace) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>in_oklab</span><span>(</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>in_color_space</span><span>(InterpolationColorSpace</span><span style=color:#ed9366>::</span><span>OkLab)
</span><span>    }
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other convenience methods ...
</span><span>}
</span></code></pre><p>Shader changes implemented color space conversions in <code>gradient.wgsl</code>:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>fn linear_rgb_to_oklab(c: vec4&LTf32>) -> vec4&LTf32> {
</span><span>    // Conversion math
</span><span>}
</span><span>
</span><span>fn mix_linear_rgb_in_oklab_space(a: vec4&LTf32>, b: vec4&LTf32>, t: f32) -> vec4&LTf32> { 
</span><span>    return oklab_to_linear_rgba(mix(linear_rgb_to_oklab(a), linear_rgb_to_oklab(b), t));
</span><span>}
</span></code></pre><p>The interpolation function was updated to support multiple color spaces:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>#ifdef IN_SRGB
</span><span>    return mix_linear_rgb_in_srgb_space(...);
</span><span>#else ifdef IN_OKLAB
</span><span>    return mix_linear_rgb_in_oklab_space(...);
</span><span>// Other cases...
</span><span>#endif
</span></code></pre><p>Pipeline specialization was modified to include color space:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>UiGradientPipelineKey </span><span>{
</span><span>    anti_alias</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>bool</span><span>,
</span><span>    color_space</span><span style=color:#61676ccc>:</span><span> InterpolationColorSpace, </span><span style=color:#abb0b6;font-style:italic>// New field
</span><span>    </span><span style=color:#fa6e32>pub </span><span>hdr</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>bool</span><span>,
</span><span>}
</span></code></pre><h3 id=technical-insights>Technical Insights</h3><p>Key technical aspects:<ol><li><strong>Hue Interpolation</strong>: OKLCH uses polar coordinates requiring special handling for hue angles. The implementation provides both short and long paths:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>fn lerp_hue(a: f32, b: f32, t: f32) -> f32 {
</span><span>    // Short path calculation
</span><span>}
</span><span>
</span><span>fn lerp_hue_long(a: f32, b: f32, t: f32) -> f32 {
</span><span>    // Long path calculation
</span><span>}
</span></code></pre><li><strong>Shader Efficiency</strong>: Conditional compilation ensures only necessary code paths are included in the final shader<li><strong>API Design</strong>: The builder pattern maintains backward compatibility while providing explicit control<li><strong>Color Space Characteristics</strong>: OKLab provides better perceptual uniformity than RGB spaces, while OKLCH preserves hue consistency</ol><h3 id=the-impact>The Impact</h3><p>These changes:<ol><li>Improve visual quality of gradients through perceptually uniform spaces<li>Maintain performance by implementing conversions in shaders<li>Provide backward-compatible API extensions<li>Enhance flexibility with multiple interpolation options<li>Update documentation and examples to demonstrate new functionality</ol><p>The solution demonstrates how to extend rendering pipelines with new color processing techniques while maintaining performance and API consistency.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Gradient Types] --> B[InterpolationColorSpace]
</span><span>    B --> C[Pipeline Specialization]
</span><span>    C --> D[Shader Defines]
</span><span>    D --> E[Color Space Conversion]
</span><span>    E --> F[Interpolated Output]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ui-src-gradients-rs><code>crates/bevy_ui/src/gradients.rs</code></h3><p>Added color space configuration to gradient types and implementation of interpolation methods.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// New enum definition
</span><span style=color:#fa6e32>pub enum </span><span style=color:#399ee6>InterpolationColorSpace </span><span>{
</span><span>    OkLab</span><span style=color:#61676ccc>,
</span><span>    OkLch</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other variants ...
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Added to gradient structs
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>LinearGradient </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>color_space</span><span style=color:#61676ccc>:</span><span> InterpolationColorSpace, </span><span style=color:#abb0b6;font-style:italic>// New field
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... existing fields ...
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Trait implementation
</span><span style=color:#fa6e32>impl </span><span>InColorSpace </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>LinearGradient </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>in_color_space</span><span>(</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>color_space</span><span style=color:#61676ccc>:</span><span> InterpolationColorSpace) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>color_space </span><span style=color:#ed9366>=</span><span> color_space</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self
</span><span>    }
</span><span>}
</span></code></pre><h3 id=crates-bevy-ui-src-render-gradient-wgsl><code>crates/bevy_ui/src/render/gradient.wgsl</code></h3><p>Implemented color space conversion and interpolation functions.<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>fn interpolate_gradient(...) -> vec4&LTf32> {
</span><span>    return mix_linear_rgb_in_srgb_space(...);
</span><span>}
</span><span>
</span><span>// After:
</span><span>fn interpolate_gradient(...) -> vec4&LTf32> {
</span><span>    #ifdef IN_SRGB
</span><span>        return mix_linear_rgb_in_srgb_space(...);
</span><span>    #else ifdef IN_OKLAB
</span><span>        return mix_linear_rgb_in_oklab_space(...);
</span><span>    // ... other cases ...
</span><span>    #endif
</span><span>}
</span></code></pre><h3 id=examples-ui-gradients-rs><code>examples/ui/gradients.rs</code></h3><p>Added interactive color space cycling to demonstrate functionality.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: No color space control
</span><span>LinearGradient</span><span style=color:#ed9366>::</span><span>new(angle</span><span style=color:#61676ccc>,</span><span> stops)
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Added UI controls
</span><span>commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((
</span><span>    Button</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...,
</span><span>    </span><span style=color:#f07171>observe</span><span>(click</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>move </span><span style=color:#ed9366>|</span><span style=color:#fa6e32>mut</span><span> gradients_query</span><span style=color:#ed9366>| </span><span>{
</span><span>        </span><span style=color:#fa6e32>for mut</span><span> gradient </span><span style=color:#ed9366>in</span><span> gradients_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter_mut</span><span>() {
</span><span>            </span><span style=color:#abb0b6;font-style:italic>// Cycle through color spaces
</span><span>        }
</span><span>    })
</span><span>))
</span></code></pre><h3 id=crates-bevy-ui-src-render-gradient-rs><code>crates/bevy_ui/src/render/gradient.rs</code></h3><p>Updated pipeline specialization to include color space.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>UiGradientPipelineKey {
</span><span>    anti_alias</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>bool</span><span style=color:#61676ccc>,
</span><span>    hdr</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>bool</span><span style=color:#61676ccc>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>UiGradientPipelineKey {
</span><span>    anti_alias</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>bool</span><span style=color:#61676ccc>,
</span><span>    color_space</span><span style=color:#61676ccc>:</span><span> InterpolationColorSpace</span><span style=color:#61676ccc>, </span><span style=color:#abb0b6;font-style:italic>// New
</span><span>    hdr</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>bool</span><span style=color:#61676ccc>,
</span><span>}
</span></code></pre><h3 id=release-content-release-notes-ui-gradients-md><code>release-content/release-notes/ui_gradients.md</code></h3><p>Updated documentation to reflect new functionality.<pre class=language-markdown data-lang=markdown style=color:#61676c;background-color:#fafafa><code class=language-markdown data-lang=markdown><span>// Before:
</span><span>Colors are interpolated between the stops in SRGB space.
</span><span>
</span><span>// After:
</span><span>Colors can be interpolated between the stops in OKLab, OKLCH, SRGB and linear RGB color spaces.
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://bottosson.github.io/posts/oklab/ target=_blank>OKLab color space explanation</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_color/latest/bevy_color/ target=_blank>Bevy Color Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://www.w3.org/TR/WGSL/ target=_blank>WGSL Shading Language Specification</a><li><a rel="noopener nofollow noreferrer" href=https://programmingdesignsystems.com/color/perceptually-uniform-color-spaces/ target=_blank>Perceptually Uniform Color Spaces</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-06/pr_19330.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>