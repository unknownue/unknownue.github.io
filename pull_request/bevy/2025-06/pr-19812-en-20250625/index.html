<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19812 Reuse seeded rng in tilemap_chunk for more determinism
        
    </title><meta content="#19812 Reuse seeded rng in tilemap_chunk for more determinism" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-06/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-06-25</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-06/pr-19812-zh-cn-20250625>中文</a></div></div><div class=pr-content><h2 id=reuse-seeded-rng-in-tilemap-chunk-for-more-determinism>Reuse seeded rng in tilemap_chunk for more determinism</h2><h3 id=basic-information>Basic Information</h3><ul><li><strong>Title</strong>: Reuse seeded rng in tilemap_chunk for more determinism<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19812<li><strong>Author</strong>: rparrett<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, C-Examples, S-Ready-For-Final-Review, C-Testing<li><strong>Created</strong>: 2025-06-25T15:53:00Z<li><strong>Merged</strong>: 2025-06-25T16:30:59Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h3 id=description-translation>Description Translation</h3><h1 id=objective>Objective</h1><p>This example uses a seeded RNG for the initial setup, but new unseeded RNGs during each timed update.<p>This is causing the example to produce different output each time in the <a rel="noopener nofollow noreferrer" href=https://bevyengine.github.io/bevy-example-runner/ target=_blank>example report</a>.</p><img alt=image src=https://github.com/user-attachments/assets/05d78083-97d0-4bcf-aebc-f645b570d144 width=838><h2 id=solution>Solution</h2><p>Store and reuse the RNG, following the pattern used in other examples.<h2 id=testing>Testing</h2><p><code>cargo run --example tilemap_chunk</code><h3 id=the-story-of-this-pull-request>The Story of This Pull Request</h3><h4 id=the-problem-and-context>The Problem and Context</h4><p>The <code>tilemap_chunk</code> example was exhibiting non-deterministic behavior during automated testing. While the initial setup used a seeded RNG (ChaCha8Rng seeded with 42) to generate tilemap chunks, each timed update created a new RNG instance using <code>ChaCha8Rng::from_entropy()</code>. This entropy-based initialization produced different random sequences each run, causing inconsistent output in the Bevy example runner reports. The inconsistency is visible in the attached screenshot showing varying frame times across runs. For testing and deterministic behavior, consistent output across runs is essential.<h4 id=the-solution-approach>The Solution Approach</h4><p>The fix follows established patterns in Bevy examples where RNG state needs to persist across frames. Instead of creating a new RNG on each update, we store the initial seeded RNG as a resource and reuse it throughout the application’s lifecycle. This approach maintains the example’s deterministic behavior while preserving its functionality. The solution required:<ol><li>Defining a new resource wrapper for the RNG<li>Initializing this resource during startup<li>Accessing the shared RNG in the update system</ol><h4 id=the-implementation>The Implementation</h4><p>The changes are minimal but effective. First, we define a new resource type to hold our seeded RNG:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Resource</span><span style=color:#61676ccc>,</span><span> Deref</span><span style=color:#61676ccc>,</span><span> DerefMut)]
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>SeededRng</span><span>(ChaCha8Rng)</span><span style=color:#61676ccc>;
</span></code></pre><p>During the setup phase, we insert this resource into the ECS after initializing the RNG:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_resource</span><span>(SeededRng(rng))</span><span style=color:#61676ccc>;
</span></code></pre><p>The key modification comes in the <code>update_tilemap</code> system, where we replace the locally-scoped RNG with the persistent resource:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>fn </span><span style=color:#f29718>update_tilemap</span><span>(
</span><span>    </span><span style=color:#ff8f40>time</span><span style=color:#61676ccc>: </span><span>Res&LTTime>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>query</span><span style=color:#61676ccc>: </span><span>Query<(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> TilemapChunkIndices, </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> UpdateTimer)>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>rng</span><span style=color:#61676ccc>: </span><span>ResMut&LTSeededRng>,  </span><span style=color:#abb0b6;font-style:italic>// Access the seeded RNG resource
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>for </span><span>(</span><span style=color:#fa6e32>mut</span><span> indices</span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>mut</span><span> timer) </span><span style=color:#ed9366>in</span><span> query</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter_mut</span><span>() {
</span><span>        timer</span><span style=color:#ed9366>.</span><span style=color:#f07171>tick</span><span>(time</span><span style=color:#ed9366>.</span><span style=color:#f07171>delta</span><span>())</span><span style=color:#61676ccc>;
</span><span>        
</span><span>        </span><span style=color:#fa6e32>if</span><span> timer</span><span style=color:#ed9366>.</span><span style=color:#f07171>just_finished</span><span>() {
</span><span>            </span><span style=color:#abb0b6;font-style:italic>// Reuse the same seeded RNG instead of creating new instances
</span><span>            </span><span style=color:#fa6e32>for </span><span style=color:#ed9366>_ in </span><span style=color:#ff8f40>0</span><span style=color:#ed9366>..</span><span style=color:#ff8f40>50 </span><span>{
</span><span>                </span><span style=color:#fa6e32>let</span><span> index </span><span style=color:#ed9366>=</span><span> rng</span><span style=color:#ed9366>.</span><span style=color:#f07171>gen_range</span><span>(</span><span style=color:#ff8f40>0</span><span style=color:#ed9366>..</span><span>indices</span><span style=color:#ed9366>.</span><span style=color:#f07171>len</span><span>())</span><span style=color:#61676ccc>;
</span><span>                indices[index] </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(rng</span><span style=color:#ed9366>.</span><span style=color:#f07171>gen_range</span><span>(</span><span style=color:#ff8f40>0</span><span style=color:#ed9366>..</span><span style=color:#ff8f40>5</span><span>))</span><span style=color:#61676ccc>;
</span><span>            }
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre><p>A minor cleanup was also made to the plugin initialization, removing unnecessary parentheses:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before
</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_plugins</span><span>((DefaultPlugins</span><span style=color:#ed9366>.</span><span style=color:#f07171>set</span><span>(ImagePlugin</span><span style=color:#ed9366>::</span><span>default_nearest())</span><span style=color:#61676ccc>,</span><span>))
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After
</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_plugins</span><span>(DefaultPlugins</span><span style=color:#ed9366>.</span><span style=color:#f07171>set</span><span>(ImagePlugin</span><span style=color:#ed9366>::</span><span>default_nearest()))
</span></code></pre><h4 id=technical-insights>Technical Insights</h4><p>This fix demonstrates proper resource management in ECS architectures. The solution leverages Bevy’s resource system to maintain state across systems and frames. By using <code>ResMut&LTSeededRng></code>, we ensure:<ol><li>The RNG state persists between updates<li>The RNG is safely accessible in systems that need it<li>The initial seed configuration remains consistent</ol><p>The <code>Deref</code> and <code>DerefMut</code> derivations on <code>SeededRng</code> provide ergonomic access to the underlying RNG methods through deref coercion, avoiding boilerplate code.<h4 id=the-impact>The Impact</h4><p>These changes ensure the <code>tilemap_chunk</code> example now produces consistent output across runs, making it reliable for automated testing and documentation. The solution:<ol><li>Eliminates non-determinism from entropy-based RNG initialization<li>Maintains the example’s visual behavior<li>Aligns with established Bevy patterns for RNG handling<li>Adds minimal overhead (single resource allocation)</ol><h3 id=visual-representation>Visual Representation</h3><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[setup system] --> B[Creates SeededRng resource]
</span><span>    B --> C[update_tilemap system]
</span><span>    C --> D[Reuses RNG state]
</span><span>    D --> C[Persists between frames]
</span></code></pre><h3 id=key-files-changed>Key Files Changed</h3><p><strong>File</strong>: <code>examples/2d/tilemap_chunk.rs</code><br> <strong>Changes</strong>: +14 lines, -3 lines<ol><li><strong>Added RNG resource and initialization</strong></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Resource</span><span style=color:#61676ccc>,</span><span> Deref</span><span style=color:#61676ccc>,</span><span> DerefMut)]
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>SeededRng</span><span>(ChaCha8Rng)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// In setup()
</span><span>commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_resource</span><span>(SeededRng(rng))</span><span style=color:#61676ccc>;
</span></code></pre><ol start=2><li><strong>Modified update system to use resource</strong></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>fn </span><span style=color:#f29718>update_tilemap</span><span>(
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>rng</span><span style=color:#61676ccc>: </span><span>ResMut&LTSeededRng>,  </span><span style=color:#abb0b6;font-style:italic>// Added resource access
</span><span>) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Removed: let mut rng = ChaCha8Rng::from_entropy();
</span><span>}
</span></code></pre><ol start=3><li><strong>Minor syntax cleanup</strong></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before
</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_plugins</span><span>((DefaultPlugins</span><span style=color:#ed9366>.</span><span style=color:#f07171>set</span><span>(ImagePlugin</span><span style=color:#ed9366>::</span><span>default_nearest())</span><span style=color:#61676ccc>,</span><span>))
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After
</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_plugins</span><span>(DefaultPlugins</span><span style=color:#ed9366>.</span><span style=color:#f07171>set</span><span>(ImagePlugin</span><span style=color:#ed9366>::</span><span>default_nearest()))
</span></code></pre><h3 id=further-reading>Further Reading</h3><ol><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/ecs/system/trait.Resource.html target=_blank>Bevy Resources Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/rand_chacha/latest/rand_chacha/ target=_blank>rand_chacha crate documentation</a><li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/programming/determinism.html target=_blank>Deterministic Simulation Patterns</a><li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/programming/resources.html target=_blank>ECS Resource Management</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-06/pr_19812.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>