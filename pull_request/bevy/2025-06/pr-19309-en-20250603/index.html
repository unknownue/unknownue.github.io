<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19309 Hot patching systems with subsecond
        
    </title><meta content="#19309 Hot patching systems with subsecond" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-06/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-06-03</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-06/pr-19309-zh-cn-20250603>中文</a></div></div><div class=pr-content><h2 id=hot-patching-systems-with-subsecond>Hot patching systems with subsecond</h2><h3 id=basic-information>Basic Information</h3><ul><li><strong>Title</strong>: Hot patching systems with subsecond<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19309<li><strong>Author</strong>: mockersf<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: X-Controversial, M-Needs-Release-Note, A-Dev-Tools, S-Needs-Review<li><strong>Created</strong>: 2025-05-20T10:50:01Z<li><strong>Merged</strong>: 2025-06-03T21:30:06Z<li><strong>Merged By</strong>: cart</ul><h3 id=the-story-of-this-pull-request>The Story of This Pull Request</h3><h4 id=the-problem-and-context>The Problem and Context</h4><p>Developers working with Bevy faced a significant limitation: modifying systems required restarting the entire application. This disrupted workflows during rapid iteration cycles, especially when testing small logic changes. The core challenge was enabling runtime system updates without compromising performance or introducing overhead when the feature wasn’t used. The solution needed to be opt-in and maintain Bevy’s execution efficiency.<h4 id=the-solution-approach>The Solution Approach</h4><p>The implementation leverages the <code>subsecond</code> library from Dioxus for function pointer redirection. The approach centers on:<ol><li>Adding a feature-gated <code>hotpatching</code> mechanism<li>Storing and comparing function pointers in systems<li>Triggering updates through a <code>HotPatched</code> event<li>Minimizing checks to only when hotpatches occur</ol><p>Key engineering decisions:<ul><li>Feature-gating ensures zero overhead when disabled<li>Function pointer comparison avoids unnecessary refreshes<li>Event-driven updates prevent per-frame checks<li>Integration at the executor level handles all system types uniformly</ul><h4 id=the-implementation>The Implementation</h4><p>The core changes introduce:<ol><li>A new <code>HotPatched</code> event signaling available updates<li>Function pointer storage in systems<li>Refresh logic in system executors<li>Example demonstrating live text/color updates</ol><p>For regular systems, we store and check function pointers:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// crates/bevy_ecs/src/system/function_system.rs
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"hotpatching"</span><span>)]
</span><span>current_ptr</span><span style=color:#61676ccc>: </span><span>subsecond</span><span style=color:#ed9366>::</span><span>HotFnPtr</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>refresh_hotpatch</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>) {
</span><span>    </span><span style=color:#fa6e32>let</span><span> new </span><span style=color:#ed9366>= </span><span>subsecond</span><span style=color:#ed9366>::</span><span>HotFn</span><span style=color:#ed9366>::</span><span>current(F</span><span style=color:#ed9366>::</span><span>run)</span><span style=color:#ed9366>.</span><span style=color:#f07171>ptr_address</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>if</span><span> new </span><span style=color:#ed9366>!= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>current_ptr {
</span><span>        log</span><span style=color:#ed9366>::</span><span>debug</span><span style=color:#ed9366>!</span><span>(</span><span style=color:#86b300>"system {} hotpatched"</span><span style=color:#61676ccc>, </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>name</span><span>())</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>current_ptr </span><span style=color:#ed9366>=</span><span> new</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>Executors conditionally refresh systems when hotpatches occur:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// crates/bevy_ecs/src/schedule/executor/simple.rs
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"hotpatching"</span><span>)]
</span><span style=color:#fa6e32>let</span><span> should_update_hotpatch </span><span style=color:#ed9366>= !</span><span>world
</span><span>    </span><span style=color:#ed9366>.</span><span>get_resource</span><span style=color:#ed9366>::</span><span>&LTEvents&LTHotPatched>>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(Events</span><span style=color:#ed9366>::</span><span>is_empty)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_or</span><span>(</span><span style=color:#ff8f40>true</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Later in system execution loop:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"hotpatching"</span><span>)]
</span><span style=color:#fa6e32>if</span><span> should_update_hotpatch {
</span><span>    system</span><span style=color:#ed9366>.</span><span style=color:#f07171>refresh_hotpatch</span><span>()</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>The plugin establishes the Dioxus connection:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// crates/bevy_app/src/hotpatch.rs
</span><span>subsecond</span><span style=color:#ed9366>::</span><span>register_handler(Arc</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#fa6e32>move </span><span style=color:#ed9366>|| </span><span>{
</span><span>    sender</span><span style=color:#ed9366>.</span><span style=color:#f07171>send</span><span>(HotPatched)</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span><span>}))</span><span style=color:#61676ccc>;
</span></code></pre><h4 id=technical-insights>Technical Insights</h4><p>The solution uses several key techniques:<ol><li><strong>Jump Tables</strong>: <code>subsecond</code> maintains function pointer tables<li><strong>Pointer Comparison</strong>: Systems compare stored vs current pointers<li><strong>Event-Driven</strong>: <code>HotPatched</code> events signal available updates<li><strong>Executor Integration</strong>: All executors handle hotpatching consistently</ol><p>Performance considerations:<ul><li>No overhead when feature disabled (compiles out)<li>Single pointer comparison per system when enabled<li>Events minimize refresh checks to necessary frames</ul><p>Limitations:<ul><li>Requires Dioxus CLI for rebuilds (<code>dx serve --hot-patch</code>)<li>Not supported in WASM targets<li>System signature changes still require restarts</ul><h4 id=the-impact>The Impact</h4><p>These changes enable:<ol><li>Live system updates without app restarts<li>Faster iteration cycles during development<li>Visualized in the new <code>hotpatching_systems</code> example<li>Optional integration via <code>hotpatching</code> feature</ol><p>The implementation demonstrates how to integrate low-level function patching with Bevy’s ECS architecture while maintaining performance characteristics. The pattern could extend to other hot-reloadable components in the future.<h3 id=visual-representation>Visual Representation</h3><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Dioxus CLI] -->|Sends Updates| B(HotPatchPlugin)
</span><span>    B -->|HotPatched Event| C[Executor]
</span><span>    C -->|Refreshes| D[FunctionSystem]
</span><span>    C -->|Refreshes| E[ExclusiveSystem]
</span><span>    F[Example] -->|Demonstrates| D
</span><span>    F -->|Demonstrates| E
</span></code></pre><h3 id=key-files-changed>Key Files Changed</h3><ol><li><code>examples/ecs/hotpatching_systems.rs</code> (+94/-0) <ul><li>New example demonstrating live text/color updates<li>Shows both system hotpatching and manual <code>call()</code> usage</ul></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>fn </span><span style=color:#f29718>update_text</span><span>(</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>text</span><span style=color:#61676ccc>: </span><span>Single<</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> Text>) {
</span><span>    text</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0 </span><span style=color:#ed9366>= </span><span style=color:#86b300>"before"</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_string</span><span>()</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// Editable at runtime
</span><span>}
</span><span>
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>on_click</span><span>(</span><span style=color:#ff8f40>_click</span><span style=color:#61676ccc>: </span><span>Trigger&LTPointer&LTClick>>, ...) {
</span><span>    color</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0 </span><span style=color:#ed9366>= </span><span>palettes</span><span style=color:#ed9366>::</span><span>tailwind</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>RED_600</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// Editable at runtime
</span><span>}
</span></code></pre><ol start=2><li><code>crates/bevy_app/src/hotpatch.rs</code> (+42/-0) <ul><li>New plugin connecting to Dioxus CLI<li>Bridges subsecond updates to ECS events</ul></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>subsecond</span><span style=color:#ed9366>::</span><span>register_handler(Arc</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#fa6e32>move </span><span style=color:#ed9366>|| </span><span>{
</span><span>    sender</span><span style=color:#ed9366>.</span><span style=color:#f07171>send</span><span>(HotPatched)</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span><span>}))</span><span style=color:#61676ccc>;
</span></code></pre><ol start=3><li><code>crates/bevy_ecs/src/system/function_system.rs</code> (+35/-0) <ul><li>Adds function pointer storage to systems<li>Implements hotpatch refresh logic</ul></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"hotpatching"</span><span>)]
</span><span>current_ptr</span><span style=color:#61676ccc>: </span><span>subsecond</span><span style=color:#ed9366>::</span><span>HotFnPtr</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"hotpatching"</span><span>)]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>refresh_hotpatch</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>) { </span><span style=color:#ed9366>... </span><span>}
</span></code></pre><ol start=4><li><code>crates/bevy_ecs/src/system/exclusive_function_system.rs</code> (+32/-0) <ul><li>Similar changes for exclusive systems</ul></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"hotpatching"</span><span>)]
</span><span>current_ptr</span><span style=color:#61676ccc>: </span><span>subsecond</span><span style=color:#ed9366>::</span><span>HotFnPtr</span><span style=color:#61676ccc>,
</span></code></pre><ol start=5><li><code>crates/bevy_ecs/src/schedule/executor/simple.rs</code> (+23/-0) <ul><li>Adds conditional hotpatch refreshing</ul></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"hotpatching"</span><span>)]
</span><span style=color:#fa6e32>let</span><span> should_update_hotpatch </span><span style=color:#ed9366>= ...</span><span style=color:#61676ccc>;
</span><span style=color:#ed9366>...
</span><span style=color:#fa6e32>if</span><span> should_update_hotpatch {
</span><span>    system</span><span style=color:#ed9366>.</span><span style=color:#f07171>refresh_hotpatch</span><span>()</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=further-reading>Further Reading</h3><ol><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/subsecond/latest/subsecond/ target=_blank>Subsecond Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://fasterthanli.me/articles/hot-reloading-in-rust target=_blank>Hot Reloading in Rust</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/ecs/system/ target=_blank>Bevy ECS System Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://dioxuslabs.com/learn/0.5/advanced/hot-reloading target=_blank>Dioxus Hot Reloading Guide</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-06/pr_19309.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>