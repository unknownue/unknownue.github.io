<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19872
        
    </title><meta content=#19872 property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-06/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-06-29</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-06/pr-19872-zh-cn-20250629>中文</a></div></div><div class=pr-content><h2 id=technical-analysis-of-pr-19872-bevy-render-fix-clippy-on-wasm>Technical Analysis of PR #19872: bevy_render: fix clippy on wasm</h2><h3 id=the-problem-and-context>The Problem and Context</h3><p>When compiling Bevy’s renderer for WebAssembly (wasm) targets, Clippy warnings appeared for unfulfilled lint expectations. Specifically, the <code>#[expect(clippy::large_enum_variant)]</code> attributes were triggering warnings because the expected lint violations weren’t occurring in wasm builds. This violated Bevy’s policy of maintaining clean Clippy output and created noise in development workflows targeting web platforms. The core issue stemmed from differences in enum size handling between native and wasm targets, where the lint condition wasn’t consistently met across platforms.<h3 id=the-solution-approach>The Solution Approach</h3><p>The author implemented a targeted solution: conditionally apply the <code>expect</code> attribute only for non-wasm targets. This approach maintains the lint suppression for native builds where the enum size is problematic (as tracked in issue #19220), while avoiding false positives in wasm environments. The solution uses Rust’s conditional compilation with <code>cfg_attr</code> to selectively include the Clippy directive based on the target architecture.<h3 id=the-implementation>The Implementation</h3><p>The changes modify two enums where the original <code>expect</code> attributes caused wasm-specific warnings. The pattern is identical in both cases:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>expect</span><span>(
</span><span>    clippy::large_enum_variant</span><span style=color:#61676ccc>,
</span><span>    reason </span><span style=color:#ed9366>= </span><span style=color:#86b300>"See https://github.com/bevyengine/bevy/issues/19220"
</span><span>)]
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg_attr</span><span>(
</span><span>    </span><span style=color:#f29718>not</span><span>(target_arch </span><span style=color:#ed9366>= </span><span style=color:#86b300>"wasm32"</span><span>)</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#f29718>expect</span><span>(
</span><span>        clippy::large_enum_variant</span><span style=color:#61676ccc>,
</span><span>        reason </span><span style=color:#ed9366>= </span><span style=color:#86b300>"See https://github.com/bevyengine/bevy/issues/19220"
</span><span>    )
</span><span>)]
</span></code></pre><p>This transformation wraps the expectation in a conditional that only activates on non-wasm targets. The reason documentation linking to issue #19220 is preserved for maintainability.<h3 id=technical-insights>Technical Insights</h3><p>Key implementation details:<ol><li><strong>Conditional Compilation</strong>: Uses <code>cfg_attr</code> with <code>not(target_arch = "wasm32")</code> for precise control<li><strong>Lint Preservation</strong>: Maintains the <code>large_enum_variant</code> expectation for native platforms<li><strong>Issue Tracking</strong>: Retains reference to the underlying enum size issue (#19220)<li><strong>Minimal Impact</strong>: Changes only affect linting behavior without modifying runtime logic</ol><p>The solution acknowledges that the enum size issue (which triggers the lint) behaves differently in wasm environments, likely due to:<ul><li>Smaller pointer sizes in wasm (32-bit vs 64-bit native)<li>Different struct padding behaviors<li>Varying enum discriminant sizes</ul><h3 id=the-impact>The Impact</h3><p>These changes:<ol><li>Eliminate Clippy warnings for wasm builds<li>Maintain clean CI output for all targets<li>Preserve existing lint expectations for native platforms<li>Require zero runtime performance overhead<li>Keep the codebase warning-free without resolving the underlying enum size issue</ol><p>The fix demonstrates proper handling of target-specific lint behaviors while maintaining documentation for future optimizations.<h3 id=visual-representation>Visual Representation</h3><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Clippy Check] --> B{Native Target?}
</span><span>    B -->|Yes| C[Apply large_enum_variant Expectation]
</span><span>    B -->|No| D[Skip Expectation]
</span><span>    C --> E[Clean Output]
</span><span>    D --> E
</span></code></pre><h3 id=key-files-changed>Key Files Changed</h3><ol><li><strong>crates/bevy_render/src/batching/gpu_preprocessing.rs</strong> <ul><li>Modified enum: <code>PreprocessWorkItemBuffers</code><li>Change: Conditional Clippy expectation<li>Purpose: Fix wasm Clippy warning for batching system</ul></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>expect</span><span>(
</span><span>    clippy::large_enum_variant</span><span style=color:#61676ccc>,
</span><span>    reason </span><span style=color:#ed9366>= </span><span style=color:#86b300>"See https://github.com/bevyengine/bevy/issues/19220"
</span><span>)]
</span><span style=color:#fa6e32>pub enum </span><span style=color:#399ee6>PreprocessWorkItemBuffers </span><span>{ </span><span style=color:#ed9366>... </span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg_attr</span><span>(
</span><span>    </span><span style=color:#f29718>not</span><span>(target_arch </span><span style=color:#ed9366>= </span><span style=color:#86b300>"wasm32"</span><span>)</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#f29718>expect</span><span>(
</span><span>        clippy::large_enum_variant</span><span style=color:#61676ccc>,
</span><span>        reason </span><span style=color:#ed9366>= </span><span style=color:#86b300>"See https://github.com/bevyengine/bevy/issues/19220"
</span><span>    )
</span><span>)]
</span><span style=color:#fa6e32>pub enum </span><span style=color:#399ee6>PreprocessWorkItemBuffers </span><span>{ </span><span style=color:#ed9366>... </span><span>}
</span></code></pre><ol start=2><li><strong>crates/bevy_render/src/render_resource/pipeline_cache.rs</strong> <ul><li>Modified enums: <code>CachedPipelineState</code> and <code>PipelineCacheError</code><li>Change: Identical conditional pattern applied twice<li>Purpose: Fix wasm Clippy warnings in pipeline management</ul></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Example of one modified enum:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg_attr</span><span>(
</span><span>    </span><span style=color:#f29718>not</span><span>(target_arch </span><span style=color:#ed9366>= </span><span style=color:#86b300>"wasm32"</span><span>)</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#f29718>expect</span><span>(
</span><span>        clippy::large_enum_variant</span><span style=color:#61676ccc>,
</span><span>        reason </span><span style=color:#ed9366>= </span><span style=color:#86b300>"See https://github.com/bevyengine/bevy/issues/19220"
</span><span>    )
</span><span>)]
</span><span style=color:#fa6e32>pub enum </span><span style=color:#399ee6>CachedPipelineState </span><span>{ </span><span style=color:#ed9366>... </span><span>}
</span></code></pre><h3 id=further-reading>Further Reading</h3><ol><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/reference/conditional-compilation.html target=_blank>Rust Conditional Compilation</a><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/rustc/lints/levels.html#expect target=_blank>Clippy Lint Expectations</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/issues/19220 target=_blank>Bevy Issue #19220</a> (enum size optimization)<li><a rel="noopener nofollow noreferrer" href=https://rustwasm.github.io/docs/book/reference/js-ffi.html target=_blank>WebAssembly Rust Targets</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-06/pr_19872.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>