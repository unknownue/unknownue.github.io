<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19563 Ugrade to `wgpu` version `25.0
        
    </title><meta content="#19563 Ugrade to `wgpu` version `25.0" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-06/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-06-26</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2025-06/pr-19563-en-20250626>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=sheng-ji-dao-wgpu-25-0-de-ji-shu-fen-xi-bao-gao>升级到 wgpu 25.0 的技术分析报告</h1><h2 id=ji-ben-xin-xi>基本信息</h2><ul><li><strong>标题</strong>: Ugrade to <code>wgpu</code> version <code>25.0</code><li><strong>PR 链接</strong>: https://github.com/bevyengine/bevy/pull/19563<li><strong>作者</strong>: tychedelia<li><strong>状态</strong>: MERGED<li><strong>标签</strong>: A-Rendering, M-Needs-Migration-Guide, S-Needs-Review<li><strong>创建时间</strong>: 2025-06-09T22:41:08Z<li><strong>合并时间</strong>: 2025-06-26T20:02:14Z<li><strong>合并者</strong>: alice-i-cecile</ul><h2 id=miao-shu-fan-yi>描述翻译</h2><h3 id=mu-biao>目标</h3><p>升级到 <code>wgpu</code> 版本 <code>25.0</code>。<p>依赖 https://github.com/bevyengine/naga_oil/pull/121<h3 id=jie-jue-fang-an>解决方案</h3><h4 id=wen-ti>问题</h4><p>升级面临的最大问题是新的验证规则：<blockquote><p>为了支持此变更，增加了一条额外的验证规则：如果绑定组中存在绑定数组，则该绑定组中不能使用动态偏移缓冲区或 uniform 缓冲区。此要求来自 Vulkan 关于 UpdateAfterBind 描述符的规则。</blockquote><p>这对我们是一个主要困难，因为视图绑定组中使用了多个绑定数组。注意，此要求不仅影响使用动态偏移的 uniform 缓冲区，而是影响<strong>任何</strong>在同时包含绑定数组的绑定组中使用 uniform 的情况。<h4 id=chang-shi-de-xiu-fu-fang-an>尝试的修复方案</h4><p>最简单的修复是在使用绑定数组时将 uniform 改为存储缓冲区：<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>#ifdef BINDING_ARRAYS_ARE_USED
</span><span>@group(0) @binding(0) var&LTuniform> view: View;
</span><span>@group(0) @binding(1) var&LTuniform> lights: types::Lights;
</span><span>#else
</span><span>@group(0) @binding(0) var&LTstorage> view: array&LTView>;
</span><span>@group(0) @binding(1) var&LTstorage> lights: array&LTtypes::Lights>;
</span><span>#endif
</span></code></pre><p>这需要将视图索引传递给着色器：<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>struct PushConstants {
</span><span>    view_index: u32,
</span><span>}
</span><span>
</span><span>var&LTpush_constant> push_constants: PushConstants;
</span></code></pre><p>使用 push constants 没有问题，因为绑定数组只能在原生平台上使用。<p>然而，这大大复杂化了在着色器中访问 <code>view</code> 的方式：<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>#ifdef BINDING_ARRAYS_ARE_USED
</span><span>mesh_view_bindings::view.view_from_world[0].z
</span><span>#else
</span><span>mesh_view_bindings::view[mesh_view_bindings::view_index].view_from_world[0].z
</span><span>#endif
</span></code></pre><p>这种方法可行但会导致着色器中充满条件编译语句。<p>为什么不使用函数？不幸的是，以下在 uniform 路径中返回绑定的 WGSL 无效：<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>fn get_view() -> View {
</span><span>#if BINDING_ARRAYS_ARE_USED
</span><span>    let view_index = push_constants.view_index;
</span><span>    let view = views[view_index];
</span><span>#endif
</span><span>    return view;
</span><span>}
</span></code></pre><p>对于灯光等需要返回指向数据指针的情况也有问题，WGSL 不允许从函数返回指针。<p>下一个尝试是在所有路径中使用索引缓冲区。如果 push constants 可用则可行，但 WebGPU 不支持。这意味着要么在存储缓冲区中传递视图索引（不理想），要么在 WebGPU 上使用混合布局。这种条件布局会污染所有代码。<p>即使接受存储缓冲区方案，还存在动态偏移不是按视图而是按相机设置的问题，需要在每个相机上传递 uniform 数据，这也不理想。<p>因此，虽然不够优雅，最简单的解决方案是将绑定数组移到 <code>@group(1)</code> 并将其他绑定提升一个组。这应该仍能使我们保持在设备限制（4组）内。<h4 id=hou-xu-bu-zou-zhan-wang-wei-lai>后续步骤/展望未来</h4><p>希望避免拆分视图绑定组。如果未来 <code>wgpu</code> 添加 <code>@builtin(draw_index)</code>，可以在 GPU 处理中构建绘制状态列表，完全避免状态更改（见 https://github.com/gfx-rs/wgpu/issues/6823）。<h4 id=ce-shi>测试</h4><p>测试了多个示例，可能仍有部分未修复。<h2 id=zhe-ge-pr-de-gu-shi>这个 PR 的故事</h2><h3 id=wen-ti-he-bei-jing>问题和背景</h3><p>PR #19563 的核心目标是升级 Bevy 的渲染后端到 wgpu 25.0。这个升级引入了关键限制：绑定组中如果包含绑定数组，就不能再使用动态偏移缓冲区或 uniform 缓冲区。这个限制源于 Vulkan 的 UpdateAfterBind 规则，wgpu 25.0 开始强制执行。<p>在 Bevy 的渲染架构中，视图绑定组（view bind group）广泛使用了绑定数组（如环境贴图、辐照体积、聚簇贴花等）。同时，视图绑定组也使用 uniform 缓冲区存储视图矩阵、光照参数等数据。这两个特性在 wgpu 25.0 中无法共存，导致升级受阻。<h3 id=jie-jue-fang-an-fang-fa>解决方案方法</h3><p>开发者探索了多种技术方案：<ol><li><p><strong>条件编译方案</strong>：使用 <code>#ifdef</code> 在绑定数组存在时切换为存储缓冲区</p> <pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>#ifdef BINDING_ARRAYS_ARE_USED
</span><span>@group(0) @binding(0) var&LTstorage> view: array&LTView>;
</span><span>#else
</span><span>@group(0) @binding(0) var&LTuniform> view: View;
</span><span>#endif
</span></code></pre> <p>需要传递视图索引：</p> <pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>struct PushConstants { view_index: u32; }
</span><span>var&LTpush_constant> push_constants: PushConstants;
</span></code></pre> <p><strong>问题</strong>：导致着色器代码充斥条件语句，可读性和维护性差，且 WebGPU 不支持 push constants</p><li><p><strong>统一索引方案</strong>：始终使用索引访问视图数据 <strong>问题</strong>：Web 平台兼容性差，且非视图相关的 uniform 数据（如相机设置）需要额外处理</p><li><p><strong>绑定组重组方案</strong>：将绑定数组移到单独的绑定组</p> <ul><li>绑定数组 → <code>@group(1)</code><li>视图资源 → <code>@group(0)</code><li>网格资源 → <code>@group(2)</code><li>材质资源 → <code>@group(3)</code></ul></ol><p>最终采用方案 3，因为它：<ul><li>满足 wgpu 25.0 的约束条件<li>保持着色器代码相对干净<li>兼容 Web 平台<li>大多数设备支持至少 4 个绑定组</ul><h3 id=shi-xian-xi-jie>实现细节</h3><h4 id=bang-ding-zu-jia-gou-zhong-gou>绑定组架构重构</h4><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[View Bindings] --> B[Binding Arrays]
</span><span>    A --> C[Uniform Buffers]
</span><span>    B --> D[group 1]
</span><span>    C --> E[group 0]
</span><span>    F[Mesh Bindings] --> G[group 2]
</span><span>    H[Material Bindings] --> I[group 3]
</span></code></pre><h4 id=guan-jian-bian-geng>关键变更</h4><ol><li><p><strong>视图绑定组拆分</strong>：</p> <ul><li><code>group(0)</code>：核心视图资源（uniform 缓冲区）<li><code>group(1)</code>：绑定数组资源（环境贴图、辐照体积等）</ul><li><p><strong>着色器绑定调整</strong>：</p> <pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// 之前
</span><span>@group(0) @binding(17) var diffuse_environment_map: texture_cube&LTf32>;
</span><span>
</span><span>// 之后
</span><span>@group(1) @binding(0) var diffuse_environment_map: texture_cube&LTf32>;
</span></code></pre><li><p><strong>空绑定组支持</strong>：</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>MeshViewBindGroup </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>main</span><span style=color:#61676ccc>:</span><span> BindGroup,          </span><span style=color:#abb0b6;font-style:italic>// 主绑定组 (group 0)
</span><span>    </span><span style=color:#fa6e32>pub </span><span>binding_array</span><span style=color:#61676ccc>:</span><span> BindGroup, </span><span style=color:#abb0b6;font-style:italic>// 绑定数组组 (group 1)
</span><span>    </span><span style=color:#fa6e32>pub </span><span>empty</span><span style=color:#61676ccc>:</span><span> BindGroup,         </span><span style=color:#abb0b6;font-style:italic>// 空绑定组占位
</span><span>}
</span></code></pre><li><p><strong>渲染管线更新</strong>：</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>render_pass</span><span style=color:#ed9366>.</span><span style=color:#f07171>set_bind_group</span><span>(</span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>mesh_view_bind_group</span><span style=color:#ed9366>.</span><span>main</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>offsets)</span><span style=color:#61676ccc>;
</span><span>render_pass</span><span style=color:#ed9366>.</span><span style=color:#f07171>set_bind_group</span><span>(</span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>mesh_view_bind_group</span><span style=color:#ed9366>.</span><span>binding_array</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>[])</span><span style=color:#61676ccc>;
</span></code></pre></ol><h3 id=ji-shu-dong-cha>技术洞察</h3><ol><li><p><strong>绑定数组限制</strong>：wgpu 25.0 禁止在绑定数组所在的绑定组中使用动态偏移或 uniform 缓冲区，这是 Vulkan 兼容性要求</p><li><p><strong>架构影响</strong>：</p> <ul><li>绑定组索引全局调整（材质从 group 2 → group 3）<li>视图绑定组拆分为逻辑部分<li>新增空绑定组处理无绑定数组的情况</ul><li><p><strong>性能考量</strong>：绑定组重组避免了复杂的状态切换，保持渲染性能稳定</p><li><p><strong>Web 兼容性</strong>：方案避免了 push constants 等 WebGPU 不支持的特性</p></ol><h3 id=ying-xiang>影响</h3><ol><li><p><strong>着色器迁移</strong>：所有自定义着色器需要更新绑定组索引：</p> <pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// 之前
</span><span>@group(2) @binding(0) var material: CustomMaterial;
</span><span>
</span><span>// 之后
</span><span>@group(3) @binding(0) var material: CustomMaterial;
</span></code></pre><li><p><strong>API 变化</strong>：</p> <ul><li><code>MeshPipelineViewLayout</code> 拆分为多个布局<li>渲染命令需要设置额外的绑定组</ul><li><p><strong>迁移指南</strong>：添加了详细迁移文档指导用户更新着色器</p></ol><h2 id=guan-jian-wen-jian-bian-geng>关键文件变更</h2><h3 id=crates-bevy-pbr-src-render-mesh-view-bindings-rs-161-119><code>crates/bevy_pbr/src/render/mesh_view_bindings.rs</code> (+161/-119)</h3><p><strong>变更原因</strong>：重构视图绑定组以支持绑定数组分离<br> <strong>关键修改</strong>：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 之前
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>MeshPipelineViewLayout </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>bind_group_layout</span><span style=color:#61676ccc>:</span><span> BindGroupLayout,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 之后
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>MeshPipelineViewLayout </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>main_layout</span><span style=color:#61676ccc>:</span><span> BindGroupLayout,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>binding_array_layout</span><span style=color:#61676ccc>:</span><span> BindGroupLayout,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>empty_layout</span><span style=color:#61676ccc>:</span><span> BindGroupLayout,
</span><span>}
</span></code></pre><p><strong>关联 PR</strong>：实现绑定组拆分架构<h3 id=crates-bevy-pbr-src-render-mesh-view-bindings-wgsl-39-39><code>crates/bevy_pbr/src/render/mesh_view_bindings.wgsl</code> (+39/-39)</h3><p><strong>变更原因</strong>：调整资源绑定组索引<br> <strong>关键修改</strong>：<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// 之前
</span><span>@group(0) @binding(17) var diffuse_environment_map: texture_cube&LTf32>;
</span><span>
</span><span>// 之后
</span><span>@group(1) @binding(0) var diffuse_environment_map: texture_cube&LTf32>;
</span></code></pre><p><strong>关联 PR</strong>：绑定数组资源迁移到 group 1<h3 id=crates-bevy-pbr-src-prepass-mod-rs-56-13><code>crates/bevy_pbr/src/prepass/mod.rs</code> (+56/-13)</h3><p><strong>变更原因</strong>：支持前处理管线的绑定组重组<br> <strong>关键修改</strong>：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub type </span><span style=color:#399ee6>DrawPrepass</span><span style=color:#ed9366><</span><span>M</span><span style=color:#ed9366>> = </span><span>(
</span><span>    SetItemPipeline</span><span style=color:#61676ccc>,
</span><span>    SetPrepassViewBindGroup&LT0></span><span style=color:#61676ccc>,
</span><span>    SetPrepassViewEmptyBindGroup&LT1></span><span style=color:#61676ccc>, </span><span style=color:#abb0b6;font-style:italic>// 新增空绑定组
</span><span>    SetMeshBindGroup&LT2></span><span style=color:#61676ccc>,
</span><span>    SetMaterialBindGroup&LTM, 3></span><span style=color:#61676ccc>,
</span><span>    DrawMesh</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><p><strong>关联 PR</strong>：确保前处理与主渲染管线一致性<h3 id=crates-bevy-pbr-src-render-pbr-bindings-wgsl-33-33><code>crates/bevy_pbr/src/render/pbr_bindings.wgsl</code> (+33/-33)</h3><p><strong>变更原因</strong>：材质绑定组索引更新<br> <strong>关键修改</strong>：<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// 之前
</span><span>@group(2) @binding(0) var&LTuniform> material: StandardMaterial;
</span><span>
</span><span>// 之后
</span><span>@group(3) @binding(0) var&LTuniform> material: StandardMaterial;
</span></code></pre><p><strong>关联 PR</strong>：材质系统迁移到 group 3<h3 id=crates-bevy-pbr-src-render-mesh-rs-50-3><code>crates/bevy_pbr/src/render/mesh.rs</code> (+50/-3)</h3><p><strong>变更原因</strong>：支持网格绑定组更新<br> <strong>关键修改</strong>：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub type </span><span style=color:#399ee6>DrawMesh3d </span><span style=color:#ed9366>= </span><span>(
</span><span>    SetItemPipeline</span><span style=color:#61676ccc>,
</span><span>    SetMeshViewBindGroup&LT0></span><span style=color:#61676ccc>,
</span><span>    SetMeshViewBindingArrayBindGroup&LT1></span><span style=color:#61676ccc>, </span><span style=color:#abb0b6;font-style:italic>// 新增绑定数组组
</span><span>    SetMeshBindGroup&LT2></span><span style=color:#61676ccc>,
</span><span>    DrawMesh</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><p><strong>关联 PR</strong>：更新网格渲染命令以支持新绑定组结构<h2 id=jin-yi-bu-yue-du>进一步阅读</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://github.com/gfx-rs/wgpu/blob/trunk/CHANGELOG.md#v2500-2025-04-10 target=_blank>wgpu 25.0 更新日志</a><li><a rel="noopener nofollow noreferrer" href=https://www.khronos.org/registry/vulkan/specs/1.3-extensions/man/html/VK_EXT_descriptor_indexing.html target=_blank>Vulkan UpdateAfterBind 规则</a><li><a href=https://unknownue.github.io/pull_request/bevy/2025-06/pr-19563-zh-cn-20250626/release-content/migration-guides/wgpu_25.md>Bevy 迁移指南：wgpu 25.0</a></ol><h2 id=wan-zheng-dai-ma-chai-yi>完整代码差异</h2><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/assets/shaders/array_texture.wgsl b/assets/shaders/array_texture.wgsl
</span><span>index d49d492a06396..293f3316654e4 100644
</span><span style=color:#c594c5>--- a/assets/shaders/array_texture.wgsl
</span><span style=color:#c594c5>+++ b/assets/shaders/array_texture.wgsl
</span><span style=color:#c594c5>@@ -7,8 +7,8 @@
</span><span> }
</span><span> #import bevy_core_pipeline::tonemapping::tone_mapping
</span><span> 
</span><span style=color:#f07171>-@group(2) @binding(0) var my_array_texture: texture_2d_array&LTf32>;
</span><span style=color:#f07171>-@group(2) @binding(1) var my_array_texture_sampler: sampler;
</span><span style=color:#86b300>+@group(3) @binding(0) var my_array_texture: texture_2d_array&LTf32>;
</span><span style=color:#86b300>+@group(3) @binding(1) var my_array_texture_sampler: sampler;
</span><span> 
</span><span> @fragment
</span><span> fn fragment(
</span><span>diff --git a/crates/bevy_pbr/src/render/mesh_view_bindings.rs b/crates/bevy_pbr/src/render/mesh_view_bindings.rs
</span><span>index 8e231886bae1e..50bbcd20fa9b6 100644
</span><span style=color:#c594c5>--- a/crates/bevy_pbr/src/render/mesh_view_bindings.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_pbr/src/render/mesh_view_bindings.rs
</span><span style=color:#c594c5>@@ -59,7 +59,9 @@ </span><span style=color:#399ee6>use {crate::MESH_PIPELINE_VIEW_LAYOUT_SAFE_MAX_TEXTURES, bevy_utils::once, traci
</span><span> 
</span><span> #[derive(Clone)]
</span><span> pub struct MeshPipelineViewLayout {
</span><span style=color:#f07171>-    pub bind_group_layout: BindGroupLayout,
</span><span style=color:#86b300>+    pub main_layout: BindGroupLayout,
</span><span style=color:#86b300>+    pub binding_array_layout: BindGroupLayout,
</span><span style=color:#86b300>+    pub empty_layout: BindGroupLayout,
</span><span> 
</span><span>     #[cfg(debug_assertions)]
</span><span>     pub texture_count: usize,
</span><span style=color:#c594c5>@@ -498,7 +500,9 @@ </span><span style=color:#399ee6>pub fn prepare_mesh_view_bind_groups(
</span><span> 
</span><span>             commands.entity(entity).insert(MeshViewBindGroup {
</span><span style=color:#f07171>-                value: render_device.create_bind_group("mesh_view_bind_group", layout, &entries),
</span><span style=color:#86b300>+                main: render_device.create_bind_group("mesh_view_bind_group", &layout.main_layout, &entries),
</span><span style=color:#86b300>+                binding_array: render_device.create_bind_group("mesh_view_bind_group_binding_array", &layout.binding_array_layout, &entries_binding_array),
</span><span style=color:#86b300>+                empty: render_device.create_bind_group("mesh_view_bind_group_empty", &layout.empty_layout, &[]),
</span><span>             });
</span><span>         }
</span><span>     }
</span><span>diff --git a/crates/bevy_pbr/src/render/mesh_view_bindings.wgsl b/crates/bevy_pbr/src/render/mesh_view_bindings.wgsl
</span><span>index 2fb34d84669c9..0f650e6e54dbb 100644
</span><span style=color:#c594c5>--- a/crates/bevy_pbr/src/render/mesh_view_bindings.wgsl
</span><span style=color:#c594c5>+++ b/crates/bevy_pbr/src/render/mesh_view_bindings.wgsl
</span><span style=color:#c594c5>@@ -50,70 +50,70 @@ </span><span style=color:#399ee6>const VISIBILITY_RANGE_UNIFORM_BUFFER_SIZE: u32 = 64u;
</span><span> 
</span><span> @group(0) @binding(15) var&LTuniform> ssr_settings: types::ScreenSpaceReflectionsSettings;
</span><span> @group(0) @binding(16) var screen_space_ambient_occlusion_texture: texture_2d&LTf32>;
</span><span style=color:#f07171>-
</span><span style=color:#f07171>-#ifdef MULTIPLE_LIGHT_PROBES_IN_ARRAY
</span><span style=color:#f07171>-@group(0) @binding(17) var diffuse_environment_maps: binding_array&LTtexture_cube&LTf32>, 8u>;
</span><span style=color:#f07171>-@group(0) @binding(18) var specular_environment_maps: binding_array&LTtexture_cube&LTf32>, 8u>;
</span><span style=color:#f07171>-#else
</span><span style=color:#f07171>-@group(0) @binding(17) var diffuse_environment_map: texture_cube&LTf32>;
</span><span style=color:#f07171>-@group(0) @binding(18) var specular_environment_map: texture_cube&LTf32>;
</span><span style=color:#f07171>-#endif
</span><span style=color:#f07171>-@group(0) @binding(19) var environment_map_sampler: sampler;
</span><span style=color:#f07171>-@group(0) @binding(20) var&LTuniform> environment_map_uniform: types::EnvironmentMapUniform;
</span><span style=color:#f07171>-
</span><span style=color:#f07171>-#ifdef IRRADIANCE_VOLUMES_ARE_USABLE
</span><span style=color:#f07171>-#ifdef MULTIPLE_LIGHT_PROBES_IN_ARRAY
</span><span style=color:#f07171>-@group(0) @binding(21) var irradiance_volumes: binding_array&LTtexture_3d&LTf32>, 8u>;
</span><span style=color:#f07171>-#else
</span><span style=color:#f07171>-@group(0) @binding(21) var irradiance_volume: texture_3d&LTf32>;
</span><span style=color:#f07171>-#endif
</span><span style=color:#f07171>-@group(0) @binding(22) var irradiance_volume_sampler: sampler;
</span><span style=color:#f07171>-#endif
</span><span style=color:#f07171>-
</span><span style=color:#f07171>-#ifdef CLUSTERED_DECALS_ARE_USABLE
</span><span style=color:#f07171>-@group(0) @binding(23) var&LTstorage> clustered_decals: types::ClusteredDecals;
</span><span style=color:#f07171>-@group(0) @binding(24) var clustered_decal_textures: binding_array&LTtexture_2d&LTf32>, 8u>;
</span><span style=color:#f07171>-@group(0) @binding(25) var clustered_decal_sampler: sampler;
</span><span style=color:#f07171>-#endif  // CLUSTERED_DECALS_ARE_USABLE
</span><span style=color:#86b300>+@group(0) @binding(17) var&LTuniform> environment_map_uniform: types::EnvironmentMapUniform;
</span><span> 
</span><span> // NB: If you change these, make sure to update `tonemapping_shared.wgsl` too.
</span><span style=color:#f07171>-@group(0) @binding(26) var dt_lut_texture: texture_3d&LTf32>;
</span><span style=color:#f07171>-@group(0) @binding(27) var dt_lut_sampler: sampler;
</span><span style=color:#86b300>+@group(0) @binding(18) var dt_lut_texture: texture_3d&LTf32>;
</span><span style=color:#86b300>+@group(0) @binding(19) var dt_lut_sampler: sampler;
</span><span> 
</span><span> #ifdef MULTISAMPLED
</span><span> #ifdef DEPTH_PREPASS
</span><span style=color:#f07171>-@group(0) @binding(28) var depth_prepass_texture: texture_depth_multisampled_2d;
</span><span style=color:#86b300>+@group(0) @binding(20) var depth_prepass_texture: texture_depth_multisampled_2d;
</span><span> #endif // DEPTH_PREPASS
</span><span> #ifdef NORMAL_PREPASS
</span><span style=color:#f07171>-@group(0) @binding(29) var normal_prepass_texture: texture_multisampled_2d&LTf32>;
</span><span style=color:#86b300>+@group(0) @binding(21) var normal_prepass_texture: texture_multisampled_2d&LTf32>;
</span><span> #endif // NORMAL_PREPASS
</span><span> #ifdef MOTION_VECTOR_PREPASS
</span><span style=color:#f07171>-@group(0) @binding(30) var motion_vector_prepass_texture: texture_multisampled_2d&LTf32>;
</span><span style=color:#86b300>+@group(0) @binding(22) var motion_vector_prepass_texture: texture_multisampled_2d&LTf32>;
</span><span> #endif // MOTION_VECTOR_PREPASS
</span><span> 
</span><span> #else // MULTISAMPLED
</span><span> 
</span><span> #ifdef DEPTH_PREPASS
</span><span style=color:#f07171>-@group(0) @binding(28) var depth_prepass_texture: texture_depth_2d;
</span><span style=color:#86b300>+@group(0) @binding(20) var depth_prepass_texture: texture_depth_2d;
</span><span> #endif // DEPTH_PREPASS
</span><span> #ifdef NORMAL_PREPASS
</span><span style=color:#f07171>-@group(0) @binding(29) var normal_prepass_texture: texture_2d&LTf32>;
</span><span style=color:#86b300>+@group(0) @binding(21) var normal_prepass_texture: texture_2d&LTf32>;
</span><span> #endif // NORMAL_PREPASS
</span><span> #ifdef MOTION_VECTOR_PREPASS
</span><span style=color:#f07171>-@group(0) @binding(30) var motion_vector_prepass_texture: texture_2d&LTf32>;
</span><span style=color:#86b300>+@group(0) @binding(22) var motion_vector_prepass_texture: texture_2d&LTf32>;
</span><span> #endif // MOTION_VECTOR_PREPASS
</span><span> 
</span><span> #endif // MULTISAMPLED
</span><span> 
</span><span> #ifdef DEFERRED_PREPASS
</span><span style=color:#f07171>-@group(0) @binding(31) var deferred_prepass_texture: texture_2d&LTu32>;
</span><span style=color:#86b300>+@group(0) @binding(23) var deferred_prepass_texture: texture_2d&LTu32>;
</span><span> #endif // DEFERRED_PREPASS
</span><span> 
</span><span style=color:#f07171>-@group(0) @binding(32) var view_transmission_texture: texture_2d&LTf32>;
</span><span style=color:#f07171>-@group(0) @binding(33) var view_transmission_sampler: sampler;
</span><span style=color:#86b300>+@group(0) @binding(24) var view_transmission_texture: texture_2d&LTf32>;
</span><span style=color:#86b300>+@group(0) @binding(25) var view_transmission_sampler: sampler;
</span><span> 
</span><span> #ifdef OIT_ENABLED
</span><span style=color:#f07171>-@group(0) @binding(34) var&LTstorage, read_write> oit_layers: array&LTvec2&LTu32>>;
</span><span style=color:#f07171>-@group(0) @binding(35) var&LTstorage, read_write> oit_layer_ids: array&LTatomic&LTi32>>;
</span><span style=color:#f07171>-@group(0) @binding(36) var&LTuniform> oit_settings: types::OrderIndependentTransparencySettings;
</span><span style=color:#86b300>+@group(0) @binding(26) var&LTstorage, read_write> oit_layers: array&LTvec2&LTu32>>;
</span><span style=color:#86b300>+@group(0) @binding(27) var&LTstorage, read_write> oit_layer_ids: array&LTatomic&LTi32>>;
</span><span style=color:#86b300>+@group(0) @binding(28) var&LTuniform> oit_settings: types::OrderIndependentTransparencySettings;
</span><span> #endif // OIT_ENABLED
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+#ifdef MULTIPLE_LIGHT_PROBES_IN_ARRAY
</span><span style=color:#86b300>+@group(1) @binding(0) var diffuse_environment_maps: binding_array&LTtexture_cube&LTf32>, 8u>;
</span><span style=color:#86b300>+@group(1) @binding(1) var specular_environment_maps: binding_array&LTtexture_cube&LTf32>, 8u>;
</span><span style=color:#86b300>+#else
</span><span style=color:#86b300>+@group(1) @binding(0) var diffuse_environment_map: texture_cube&LTf32>;
</span><span style=color:#86b300>+@group(1) @binding(1) var specular_environment_map: texture_cube&LTf32>;
</span><span style=color:#86b300>+#endif
</span><span style=color:#86b300>+@group(1) @binding(2) var environment_map_sampler: sampler;
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+#ifdef IRRADIANCE_VOLUMES_ARE_USABLE
</span><span style=color:#86b300>+#ifdef MULTIPLE_LIGHT_PROBES_IN_ARRAY
</span><span style=color:#86b300>+@group(1) @binding(3) var irradiance_volumes: binding_array&LTtexture_3d&LTf32>, 8u>;
</span><span style=color:#86b300>+#else
</span><span style=color:#86b300>+@group(1) @binding(3) var irradiance_volume: texture_3d&LTf32>;
</span><span style=color:#86b300>+#endif
</span><span style=color:#86b300>+@group(1) @binding(4) var irradiance_volume_sampler: sampler;
</span><span style=color:#86b300>+#endif
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+#ifdef CLUSTERED_DECALS_ARE_USABLE
</span><span style=color:#86b300>+@group(1) @binding(5) var&LTstorage> clustered_decals: types::ClusteredDecals;
</span><span style=color:#86b300>+@group(1) @binding(6) var clustered_decal_textures: binding_array&LTtexture_2d&LTf32>, 8u>;
</span><span style=color:#86b300>+@group(1) @binding(7) var clustered_decal_sampler: sampler;
</span><span style=color:#86b300>+#endif  // CLUSTERED_DECALS_ARE_USABLE
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-06/pr_19563.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>