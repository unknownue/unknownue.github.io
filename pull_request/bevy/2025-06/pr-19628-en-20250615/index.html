<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19628 Add SkipDeferredLighting component
        
    </title><meta content="#19628 Add SkipDeferredLighting component" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-06/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-06-15</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-06/pr-19628-zh-cn-20250615>中文</a></div></div><div class=pr-content><h3 id=title>Title</h3><p><strong>Add SkipDeferredLighting component</strong><hr><h3 id=basic-information>Basic Information</h3><ul><li><strong>Title</strong>: Add SkipDeferredLighting component<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19628<li><strong>Author</strong>: JMS55<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, C-Usability, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-06-13T17:50:42Z<li><strong>Merged</strong>: 2025-06-15T16:51:24Z<li><strong>Merged By</strong>: alice-i-cecile</ul><hr><h3 id=description-translation>Description Translation</h3><p>Adds a new component for when you want to run the deferred gbuffer prepass, but not the lighting pass.<p>This will be used by bevy_solari in the future, as it’ll do it’s own shading pass, but still wants the gbuffer.<hr><h3 id=the-story-of-this-pull-request>The Story of This Pull Request</h3><h4 id=the-problem-and-context>The Problem and Context</h4><p>Bevy’s deferred rendering pipeline executes two critical phases: the <strong>gbuffer prepass</strong> (which writes geometry data like normals and depth to textures) and the <strong>lighting pass</strong> (which computes final lighting using the gbuffer). However, some use cases—such as custom lighting systems like <code>bevy_solari</code>—require the gbuffer data but need to bypass Bevy’s built-in lighting pass to apply custom shading logic. Previously, there was no granular control to decouple these phases per view.<h4 id=the-solution-approach>The Solution Approach</h4><p>The solution introduces a new component, <code>SkipDeferredLighting</code>, which allows views to opt out of the deferred lighting pass while retaining gbuffer generation. This is implemented by modifying the pipeline preparation logic to check for the component’s presence. If detected, the pipeline skips lighting pass setup for that specific view. The approach avoids intrusive changes by leveraging Bevy’s existing query-based pipeline management.<h4 id=the-implementation>The Implementation</h4><p>The core change occurs in <code>prepare_deferred_lighting_pipelines</code> (within <code>deferred/mod.rs</code>). Originally, this function removed the <code>DeferredLightingPipeline</code> only if <code>deferred_prepass</code> was disabled:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>deferred_prepass {
</span><span>    commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(entity)</span><span style=color:#ed9366>.</span><span>remove</span><span style=color:#ed9366>::</span><span>&LTDeferredLightingPipeline>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>The updated logic also checks for the <code>SkipDeferredLighting</code> component:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>deferred_prepass </span><span style=color:#ed9366>||</span><span> skip_deferred_lighting {
</span><span>    commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(entity)</span><span style=color:#ed9366>.</span><span>remove</span><span style=color:#ed9366>::</span><span>&LTDeferredLightingPipeline>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>This condition now skips lighting if either:<ol><li>The view lacks a deferred prepass (<code>!deferred_prepass</code>), or<li>The view explicitly requests lighting skip (<code>skip_deferred_lighting</code>).</ol><p>Additionally, the PR defines the component itself:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component</span><span style=color:#61676ccc>,</span><span> Clone</span><span style=color:#61676ccc>,</span><span> Copy</span><span style=color:#61676ccc>,</span><span> Default)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>SkipDeferredLighting</span><span style=color:#61676ccc>;
</span></code></pre><h4 id=technical-insights>Technical Insights</h4><ul><li><strong>Per-View Control</strong>: Unlike global render configuration, this component operates at the view level, enabling mixed rendering strategies (e.g., some views use built-in lighting, others use custom passes).<li><strong>Pipeline Efficiency</strong>: The check occurs during pipeline preparation, avoiding runtime overhead. Removing <code>DeferredLightingPipeline</code> prevents subsequent nodes from executing the lighting pass.<li><strong>Backward Compatibility</strong>: Existing workflows remain unaffected since the component is opt-in.</ul><h4 id=the-impact>The Impact</h4><ul><li><strong>Custom Shading Workflows</strong>: Projects like <code>bevy_solari</code> can now reuse Bevy’s gbuffer generation while injecting custom lighting.<li><strong>Minimal Overhead</strong>: The change adds a single component check without altering core rendering logic.<li><strong>Pattern for Extensibility</strong>: Demonstrates how to conditionally disable pipeline stages via components, a reusable pattern for similar future features.</ul><hr><h3 id=visual-representation>Visual Representation</h3><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[prepare_deferred_lighting_pipelines] --> B{Check Conditions}
</span><span>    B -->|deferred_prepass = false| C[Remove Pipeline]
</span><span>    B -->|SkipDeferredLighting present| C
</span><span>    B -->|Conditions false| D[Create Lighting Pipeline]
</span><span>    C --> E[Skip Lighting Pass]
</span><span>    D --> F[Execute Lighting Pass]
</span></code></pre><hr><h3 id=key-files-changed>Key Files Changed</h3><h4 id=crates-bevy-pbr-src-deferred-mod-rs><code>crates/bevy_pbr/src/deferred/mod.rs</code></h4><p><strong>Changes</strong>:<ol><li>Modified pipeline preparation to skip lighting when <code>SkipDeferredLighting</code> is present.<li>Added the <code>SkipDeferredLighting</code> component definition.</ol><p><strong>Code Snippets</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before (line 461-464):
</span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>deferred_prepass {
</span><span>    commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(entity)</span><span style=color:#ed9366>.</span><span>remove</span><span style=color:#ed9366>::</span><span>&LTDeferredLightingPipeline>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>deferred_prepass </span><span style=color:#ed9366>||</span><span> skip_deferred_lighting {
</span><span>    commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(entity)</span><span style=color:#ed9366>.</span><span>remove</span><span style=color:#ed9366>::</span><span>&LTDeferredLightingPipeline>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// New component (added at end of file):
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component</span><span style=color:#61676ccc>,</span><span> Clone</span><span style=color:#61676ccc>,</span><span> Copy</span><span style=color:#61676ccc>,</span><span> Default)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>SkipDeferredLighting</span><span style=color:#61676ccc>;
</span></code></pre><p><strong>Relation to PR Purpose</strong>:<br> The component allows selective disabling of the deferred lighting pass while preserving gbuffer generation, fulfilling the PR’s goal of enabling custom shading workflows.<hr><h3 id=further-reading>Further Reading</h3><ol><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/docs/plugins_guidelines.md#deferred-rendering target=_blank>Bevy Deferred Rendering Documentation</a>: Details on Bevy’s deferred pipeline.<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/examples/ecs/component_change_detection.rs target=_blank>Component-Based Rendering Patterns</a>: Examples of using components to control rendering behavior.<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/migration-guides/0.12-to-0.13/#pbr-rework target=_blank>PBR Pipeline Customization</a>: Context on Bevy’s physically based rendering.</ol><hr><h3 id=full-code-diff>Full Code Diff</h3><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_pbr/src/deferred/mod.rs b/crates/bevy_pbr/src/deferred/mod.rs
</span><span>index 65be474e65470..28edd38c52fb0 100644
</span><span style=color:#c594c5>--- a/crates/bevy_pbr/src/deferred/mod.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_pbr/src/deferred/mod.rs
</span><span style=color:#c594c5>@@ -449,6 +449,7 @@ </span><span style=color:#399ee6>pub fn prepare_deferred_lighting_pipelines(
</span><span>         ),
</span><span>         Has&LTRenderViewLightProbes&LTEnvironmentMapLight>>,
</span><span>         Has&LTRenderViewLightProbes&LTIrradianceVolume>>,
</span><span style=color:#86b300>+        Has&LTSkipDeferredLighting>,
</span><span>     )>,
</span><span> ) {
</span><span>     for (
</span><span style=color:#c594c5>@@ -461,12 +462,13 @@ </span><span style=color:#399ee6>pub fn prepare_deferred_lighting_pipelines(
</span><span>         (normal_prepass, depth_prepass, motion_vector_prepass, deferred_prepass),
</span><span>         has_environment_maps,
</span><span>         has_irradiance_volumes,
</span><span style=color:#86b300>+        skip_deferred_lighting,
</span><span>     ) in &views
</span><span>     {
</span><span style=color:#f07171>-        // If there is no deferred prepass, remove the old pipeline if there was
</span><span style=color:#f07171>-        // one. This handles the case in which a view using deferred stops using
</span><span style=color:#f07171>-        // it.
</span><span style=color:#f07171>-        if !deferred_prepass {
</span><span style=color:#86b300>+        // If there is no deferred prepass or we want to skip the deferred lighting pass,
</span><span style=color:#86b300>+        // remove the old pipeline if there was one. This handles the case in which a
</span><span style=color:#86b300>+        // view using deferred stops using it.
</span><span style=color:#86b300>+        if !deferred_prepass || skip_deferred_lighting {
</span><span>             commands.entity(entity).remove::&LTDeferredLightingPipeline>();
</span><span>             continue;
</span><span>         }
</span><span style=color:#c594c5>@@ -552,3 +554,14 @@ </span><span style=color:#399ee6>pub fn prepare_deferred_lighting_pipelines(
</span><span>             .insert(DeferredLightingPipeline { pipeline_id });
</span><span>     }
</span><span> }
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+/// Component to skip running the deferred lighting pass in [`DeferredOpaquePass3dPbrLightingNode`] for a specific view.
</span><span style=color:#86b300>+///
</span><span style=color:#86b300>+/// This works like [`crate::PbrPlugin::add_default_deferred_lighting_plugin`], but is per-view instead of global.
</span><span style=color:#86b300>+///
</span><span style=color:#86b300>+/// Useful for cases where you want to generate a gbuffer, but skip the built-in deferred lighting pass
</span><span style=color:#86b300>+/// to run your own custom lighting pass instead.
</span><span style=color:#86b300>+///
</span><span style=color:#86b300>+/// Insert this component in the render world only.
</span><span style=color:#86b300>+#[derive(Component, Clone, Copy, Default)]
</span><span style=color:#86b300>+pub struct SkipDeferredLighting;
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-06/pr_19628.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>