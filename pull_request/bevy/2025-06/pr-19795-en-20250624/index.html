<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19795 TilemapChunk cleanup
        
    </title><meta content="#19795 TilemapChunk cleanup" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-06/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-06-24</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-06/pr-19795-zh-cn-20250624>中文</a></div></div><div class=pr-content><h1 id=tilemapchunk-cleanup-analysis>TilemapChunk Cleanup Analysis</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: TilemapChunk cleanup<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19795<li><strong>Author</strong>: ConnerPetzold<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, C-Code-Quality, S-Ready-For-Final-Review, D-Straightforward<li><strong>Created</strong>: 2025-06-24T05:07:51Z<li><strong>Merged</strong>: 2025-06-24T22:46:22Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses technical debt from the initial tilemap chunk implementation (#18866), focusing on improving component lifecycle management and reducing unnecessary dependencies. The changes center around three main improvements: switching to an insertion hook, making components immutable, and simplifying component requirements.<p>The original implementation used an <code>Add</code> observer to initialize rendering components when a <code>TilemapChunk</code> was added. While functional, this approach had several limitations. First, it required multiple components (<code>Mesh2d</code>, <code>MeshMaterial2d</code>, etc.) to be present immediately after component creation, creating tight coupling. Second, the observer pattern was being superseded by Bevy’s newer hook system, which provides better integration with the ECS lifecycle.<p>The solution migrates from the observer to an <code>on_insert</code> hook registered directly on the <code>TilemapChunk</code> component. This change simplifies the initialization logic by handling it at the component level rather than through a separate system. The hook function <code>on_insert_tilemap_chunk</code> now handles the setup process when the component is inserted into an entity.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Separate observer system
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>on_add_tilemap_chunk</span><span>(</span><span style=color:#ff8f40>trigger</span><span style=color:#61676ccc>: </span><span>On&LTAdd, TilemapChunk>, ...) { </span><span style=color:#ed9366>... </span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Direct hook registration
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>component</span><span>(immutable</span><span style=color:#61676ccc>,</span><span> on_insert </span><span style=color:#ed9366>=</span><span> on_insert_tilemap_chunk)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>TilemapChunk </span><span>{ ... }
</span></code></pre><p>The implementation uses <code>DeferredWorld</code> to access components and resources within the hook. This approach allows fetching required data directly from the ECS world while maintaining proper access patterns. The hook first validates that required components (<code>TilemapChunk</code>, <code>TilemapChunkIndices</code>, and <code>Anchor</code>) exist on the entity, logging warnings if any are missing.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(tilemap_chunk) </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span>get</span><span style=color:#ed9366>::</span><span>&LTTilemapChunk>(entity) </span><span style=color:#fa6e32>else </span><span>{
</span><span>    </span><span style=color:#f07171>warn!</span><span>(</span><span style=color:#86b300>"TilemapChunk not found for tilemap chunk {}"</span><span style=color:#61676ccc>,</span><span> entity)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span>}</span><span style=color:#61676ccc>;
</span></code></pre><p>The mesh creation logic was refactored to use the cache directly. Instead of modifying the cache through an <code>Entry</code> API, the new implementation checks the cache and creates a new mesh only when necessary. This maintains the original caching behavior while fitting the hook’s access patterns.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let</span><span> mesh </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(mesh) </span><span style=color:#ed9366>=</span><span> tilemap_chunk_mesh_cache</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#ed9366>&</span><span>mesh_key) {
</span><span>    mesh</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()
</span><span>} </span><span style=color:#fa6e32>else </span><span>{
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> meshes </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span>resource_mut</span><span style=color:#ed9366>::</span><span>&LTAssets&LTMesh>>()</span><span style=color:#61676ccc>;
</span><span>    meshes</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(</span><span style=color:#f07171>make_chunk_mesh</span><span>(</span><span style=color:#ed9366>&</span><span>chunk_size</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>display_size</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>anchor))
</span><span>}</span><span style=color:#61676ccc>;
</span></code></pre><p>The component requirements were simplified by removing unnecessary dependencies. The <code>#[require]</code> attribute now only mandates the <code>Anchor</code> component instead of requiring rendering components that are added by the hook. This reduces boilerplate when creating tilemap chunks.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Multiple required components
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>require</span><span>(Mesh2d</span><span style=color:#61676ccc>,</span><span> MeshMaterial2d&LTTilemapChunkMaterial></span><span style=color:#61676ccc>,</span><span> TilemapChunkIndices</span><span style=color:#61676ccc>,</span><span> Anchor)]
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Only Anchor required
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>require</span><span>(Anchor)]
</span></code></pre><p>The <code>TilemapChunk</code> component was made immutable to enforce that its properties don’t change after initialization. This guarantees consistency between the component state and the rendered output, as changing these properties would require recreating the mesh anyway.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>component</span><span>(immutable</span><span style=color:#61676ccc>,</span><span> ...)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>TilemapChunk </span><span>{ ... }
</span></code></pre><p>The update system <code>update_tilemap_chunk_indices</code> was adjusted to only run when indices actually change, using <code>Changed&LTTilemapChunkIndices></code>. The comment clarifies that getting the material mutably triggers change detection, which is necessary for the renderer to pick up updates.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>fn </span><span style=color:#f29718>update_tilemap_chunk_indices</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>materials</span><span style=color:#61676ccc>: </span><span>ResMut&LTAssets&LTTilemapChunkMaterial>>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>images</span><span style=color:#61676ccc>: </span><span>ResMut&LTAssets&LTImage>>,
</span><span>    </span><span style=color:#ff8f40>query</span><span style=color:#61676ccc>: </span><span>Query<(Entity, </span><span style=color:#ed9366>&</span><span>TilemapChunk, </span><span style=color:#ed9366>&</span><span>TilemapChunkIndices), Changed&LTTilemapChunkIndices>>,
</span><span>) { </span><span style=color:#ed9366>... </span><span>}
</span></code></pre><p>A minor cleanup was made to <code>TilemapChunkMaterialPlugin</code> by removing the unnecessary <code>Default</code> derivation since the plugin doesn’t use default initialization.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[TilemapChunk Component] -->|on_insert| B[on_insert_tilemap_chunk]
</span><span>    B --> C[Fetch Components]
</span><span>    C --> D[Validate Indices]
</span><span>    D --> E[Create Mesh]
</span><span>    E --> F[Create Material]
</span><span>    F --> G[Insert Components]
</span><span>    H[Changed TilemapChunkIndices] --> I[Update Material]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-sprite-src-tilemap-chunk-mod-rs><code>crates/bevy_sprite/src/tilemap_chunk/mod.rs</code></h3><p><strong>Changes:</strong><ul><li>Replaced observer with <code>on_insert</code> hook<li>Simplified component requirements<li>Made <code>TilemapChunk</code> immutable<li>Refactored mesh/material creation<li>Optimized update system with <code>Changed</code> filter</ul><p><strong>Key Code Snippets:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Component definition with hook and reduced requirements
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component</span><span style=color:#61676ccc>,</span><span> Clone</span><span style=color:#61676ccc>,</span><span> Debug</span><span style=color:#61676ccc>,</span><span> Default)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>require</span><span>(Anchor)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>component</span><span>(immutable</span><span style=color:#61676ccc>,</span><span> on_insert </span><span style=color:#ed9366>=</span><span> on_insert_tilemap_chunk)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>TilemapChunk </span><span>{ ... }
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Hook implementation
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>on_insert_tilemap_chunk</span><span>(</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>:</span><span> DeferredWorld, HookContext { entity, .. }: HookContext) {
</span><span>    </span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(tilemap_chunk) </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span>get</span><span style=color:#ed9366>::</span><span>&LTTilemapChunk>(entity) </span><span style=color:#fa6e32>else </span><span>{ </span><span style=color:#ed9366>... </span><span>}</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... rest of initialization logic
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Optimized update system
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>update_tilemap_chunk_indices</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>materials</span><span style=color:#61676ccc>: </span><span>ResMut&LTAssets&LTTilemapChunkMaterial>>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>images</span><span style=color:#61676ccc>: </span><span>ResMut&LTAssets&LTImage>>,
</span><span>    </span><span style=color:#ff8f40>query</span><span style=color:#61676ccc>: </span><span>Query<(Entity, </span><span style=color:#ed9366>&</span><span>TilemapChunk, </span><span style=color:#ed9366>&</span><span>TilemapChunkIndices), Changed&LTTilemapChunkIndices>>,
</span><span>) { </span><span style=color:#ed9366>... </span><span>}
</span></code></pre><h3 id=crates-bevy-sprite-src-tilemap-chunk-tilemap-chunk-material-rs><code>crates/bevy_sprite/src/tilemap_chunk/tilemap_chunk_material.rs</code></h3><p><strong>Changes:</strong><ul><li>Removed unnecessary <code>Default</code> derivation</ul><p><strong>Code Snippet:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Default)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>TilemapChunkMaterialPlugin</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>TilemapChunkMaterialPlugin</span><span style=color:#61676ccc>;
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_ecs/latest/bevy_ecs/observer/index.html target=_blank>Bevy ECS Observers Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/rfcs/pull/45 target=_blank>Bevy Component Hooks RFC</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/discussions/4683 target=_blank>Entity Component System Best Practices</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-06/pr_19795.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>