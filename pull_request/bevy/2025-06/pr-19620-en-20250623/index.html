<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19620 bevy_solari: RIS for Direct Lighting
        
    </title><meta content="#19620 bevy_solari: RIS for Direct Lighting" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-06/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-06-23</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-06/pr-19620-zh-cn-20250623>中文</a></div></div><div class=pr-content><h1 id=bevy-solari-ris-for-direct-lighting>bevy_solari: RIS for Direct Lighting</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: bevy_solari: RIS for Direct Lighting<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19620<li><strong>Author</strong>: JMS55<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Feature, A-Rendering, S-Ready-For-Final-Review, M-Needs-Release-Note<li><strong>Created</strong>: 2025-06-13T14:13:02Z<li><strong>Merged</strong>: 2025-06-23T01:04:57Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Start the realtime direct lighting work for bevy solari</ul><h2 id=solution>Solution</h2><ul><li>Setup all the CPU-side code for the realtime lighting path (minus some parts for the temporal reuse I haven’t written yet)<li>Implement RIS with 32 samples to choose a good random light<li>Don’t sample a disk for the directional light, just treat it as a single point. This is faster and not much worse quality.</ul><h2 id=future>Future</h2><ul><li>Spatiotemporal reuse (ReSTIR DI)<li>Denoiser (DLSS-RR)<li>Light tile optimization for faster light selection<li>Indirect lighting (ReSTIR GI)</ul><h2 id=testing>Testing</h2><ul><li>Run the solari example to see realtime<li>Run the solari example with <code>-- --pathtracer</code> to see the existing pathtracer</ul><hr><h2 id=showcase>Showcase</h2><p>1 frame direct lighting: <img alt=image src=https://github.com/user-attachments/assets/b70b968d-9c73-4983-9b6b-b60cace9b47a><p>Accumulated pathtracer output: <img alt=image src=https://github.com/user-attachments/assets/d681bded-ef53-4dbe-bcca-96997c58c3be><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=problem-and-context>Problem and Context</h3><p>Bevy Solari needed a real-time direct lighting solution to complement its existing path tracer. The challenge was implementing an efficient algorithm that could run in real-time while maintaining visual quality. Reservoir-based Importance Sampling (RIS) emerged as a suitable technique due to its ability to efficiently sample light sources while reducing noise. The implementation needed to integrate with Bevy’s existing rendering architecture and provide a clear migration path from the validation path tracer.<h3 id=solution-approach>Solution Approach</h3><p>The implementation focuses on Reservoir-based Importance Sampling for direct lighting (ReSTIR DI). Key decisions included:<ol><li>Using 32 initial samples per pixel for light selection<li>Simplifying directional light sampling by treating them as single points instead of sampling disks<li>Implementing temporal reuse preparation (though actual temporal reuse is future work)<li>Designing a two-pass compute shader pipeline for initial/temporal and spatial/shading operations</ol><p>The directional light optimization was particularly significant - by avoiding disk sampling, we gain performance with minimal quality impact since directional lights are effectively point sources at infinite distance.<h3 id=implementation-details>Implementation Details</h3><p>The core implementation consists of:<ol><li>A new <code>SolariLightingPlugin</code> replacing <code>PathtracingPlugin</code><li>Compute shaders handling RIS and lighting calculations<li>GPU buffer management for reservoir data<li>Camera component integration for lighting control</ol><p>The render graph was extended with a new compute node (<code>SolariLightingNode</code>) that executes in two stages:<ol><li><code>initial_and_temporal</code>: Generates initial reservoirs using RIS<li><code>spatial_and_shade</code>: Performs spatial reuse and final shading</ol><p>Reservoir data is stored in GPU buffers managed by <code>SolariLightingResources</code>, with double-buffering (<code>reservoirs_a</code> and <code>reservoirs_b</code>) to support future temporal reuse.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// File: crates/bevy_solari/src/realtime/mod.rs
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component</span><span style=color:#61676ccc>,</span><span> Reflect</span><span style=color:#61676ccc>,</span><span> Clone)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>require</span><span>(Hdr</span><span style=color:#61676ccc>,</span><span> DeferredPrepass</span><span style=color:#61676ccc>,</span><span> DepthPrepass</span><span style=color:#61676ccc>,</span><span> MotionVectorPrepass)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>SolariLighting </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>reset</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>bool</span><span>,  </span><span style=color:#abb0b6;font-style:italic>// Controls temporal history reset
</span><span>}
</span></code></pre><p>The shader implementation (<code>restir_di.wgsl</code>) handles the core RIS algorithm:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>fn generate_initial_reservoir(...) -> Reservoir {
</span><span>    var reservoir = empty_reservoir();
</span><span>    for (var i = 0u; i < INITIAL_SAMPLES; i++) {
</span><span>        let light_sample = generate_random_light_sample(rng);
</span><span>        // ... resampling logic ...
</span><span>    }
</span><span>    return reservoir;
</span><span>}
</span></code></pre><h3 id=technical-insights>Technical Insights</h3><p>Key technical aspects include:<ol><li><strong>Reservoir Struct</strong>: Carefully sized to match GPU memory requirements<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>const </span><span style=color:#ff8f40>RESERVOIR_STRUCT_SIZE</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u64 </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>32</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// Must match WGSL struct
</span></code></pre><li><strong>Push Constants</strong>: Used to pass frame index and reset flags efficiently<li><strong>Quality/Performance Tradeoffs</strong>: The 32-sample RIS provides good quality while maintaining real-time performance. Directional light simplification reduces sampling cost with minimal visual impact.<li><strong>Architecture Integration</strong>: The solution hooks into Bevy’s render graph after the main pass and uses existing prepass data (GBuffer, depth, motion vectors).</ol><h3 id=impact-and-future-work>Impact and Future Work</h3><p>This PR establishes the foundation for real-time raytraced lighting in Bevy. Immediate benefits include:<ol><li>Real-time direct lighting capability<li>2-3x performance improvement over path tracing in the example scene<li>Clear extension points for future optimizations</ol><p>The implementation leaves several areas for future development:<ol><li>Spatiotemporal reuse (ReSTIR DI)<li>Denoising integration<li>Light tile optimizations<li>Indirect lighting support</ol><h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[SolariLightingPlugin] --> B[ExtractSystem]
</span><span>    A --> C[PrepareSystem]
</span><span>    A --> D[RenderGraphNode]
</span><span>    B --> E[ExtractSchedule]
</span><span>    C --> F[RenderSystems::PrepareResources]
</span><span>    D --> G[Core3d RenderGraph]
</span><span>    G --> H[initial_and_temporal pass]
</span><span>    G --> I[spatial_and_shade pass]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-solari-src-realtime-node-rs-200-0><code>crates/bevy_solari/src/realtime/node.rs</code> (+200/-0)</h3><p>Implements the render graph node and compute pipelines. Creates bind groups and manages shader execution.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Key code: Dispatch logic
</span><span>pass</span><span style=color:#ed9366>.</span><span style=color:#f07171>set_pipeline</span><span>(initial_and_temporal_pipeline)</span><span style=color:#61676ccc>;
</span><span>pass</span><span style=color:#ed9366>.</span><span style=color:#f07171>set_push_constants</span><span>(</span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>, </span><span>bytemuck</span><span style=color:#ed9366>::</span><span>cast_slice(</span><span style=color:#ed9366>&</span><span>[frame_index</span><span style=color:#61676ccc>,</span><span> reset_flag]))</span><span style=color:#61676ccc>;
</span><span>pass</span><span style=color:#ed9366>.</span><span style=color:#f07171>dispatch_workgroups</span><span>(viewport</span><span style=color:#ed9366>.</span><span>x</span><span style=color:#ed9366>.</span><span style=color:#f07171>div_ceil</span><span>(</span><span style=color:#ff8f40>8</span><span>)</span><span style=color:#61676ccc>,</span><span> viewport</span><span style=color:#ed9366>.</span><span>y</span><span style=color:#ed9366>.</span><span style=color:#f07171>div_ceil</span><span>(</span><span style=color:#ff8f40>8</span><span>)</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>1</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-solari-src-realtime-restir-di-wgsl-117-0><code>crates/bevy_solari/src/realtime/restir_di.wgsl</code> (+117/-0)</h3><p>Contains the core RIS implementation and shading logic.<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>@compute @workgroup_size(8, 8, 1)
</span><span>fn initial_and_temporal() {
</span><span>    // RIS reservoir generation
</span><span>    let initial_reservoir = generate_initial_reservoir(...);
</span><span>    reservoirs_b[pixel_index] = initial_reservoir;
</span><span>}
</span></code></pre><h3 id=crates-bevy-solari-src-realtime-mod-rs-91-0><code>crates/bevy_solari/src/realtime/mod.rs</code> (+91/-0)</h3><p>Defines the plugin and main component. Integrates with Bevy’s rendering systems.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>SolariLightingPlugin</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>impl </span><span>Plugin </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>SolariLightingPlugin </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>build</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>app</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> App) {
</span><span>        app</span><span style=color:#ed9366>.</span><span>register_type</span><span style=color:#ed9366>::</span><span>&LTSolariLighting>()
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_resource</span><span>(DefaultOpaqueRendererMethod</span><span style=color:#ed9366>::</span><span>deferred())</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><h3 id=crates-bevy-solari-src-realtime-prepare-rs-65-0><code>crates/bevy_solari/src/realtime/prepare.rs</code> (+65/-0)</h3><p>Manages GPU buffers for reservoir data.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>prepare_solari_lighting_resources</span><span>(...) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Create reservoir buffers
</span><span>    </span><span style=color:#fa6e32>let</span><span> reservoirs_a </span><span style=color:#ed9366>=</span><span> render_device</span><span style=color:#ed9366>.</span><span style=color:#f07171>create_buffer</span><span>(</span><span style=color:#ed9366>...</span><span>)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> reservoirs_b </span><span style=color:#ed9366>=</span><span> render_device</span><span style=color:#ed9366>.</span><span style=color:#f07171>create_buffer</span><span>(</span><span style=color:#ed9366>...</span><span>)</span><span style=color:#61676ccc>;
</span><span>    commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(entity)</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(SolariLightingResources {
</span><span>        reservoirs_a</span><span style=color:#61676ccc>,
</span><span>        reservoirs_b</span><span style=color:#61676ccc>,
</span><span>        view_size</span><span style=color:#61676ccc>,
</span><span>    })</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=examples-3d-solari-rs-50-15><code>examples/3d/solari.rs</code> (+50/-15)</h3><p>Updates the example to support both real-time lighting and path tracing modes.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_plugins</span><span>((DefaultPlugins</span><span style=color:#61676ccc>,</span><span> SolariPlugin</span><span style=color:#61676ccc>,</span><span> CameraControllerPlugin))
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>if</span><span> args</span><span style=color:#ed9366>.</span><span>pathtracer </span><span style=color:#ed9366>== </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#ff8f40>true</span><span>) {
</span><span>    camera</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(Pathtracer</span><span style=color:#ed9366>::</span><span>default())</span><span style=color:#61676ccc>;
</span><span>} </span><span style=color:#fa6e32>else </span><span>{
</span><span>    camera</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(SolariLighting</span><span style=color:#ed9366>::</span><span>default())</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://research.nvidia.com/publication/2020-07_spatiotemporal-reservoir-resampling target=_blank>ReSTIR Paper</a>: Original paper on Spatiotemporal Reservoir Resampling<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/next/rendering/ target=_blank>Bevy Rendering Architecture</a>: Official Bevy rendering documentation<li><a rel="noopener nofollow noreferrer" href=https://www.w3.org/TR/WGSL/ target=_blank>WGSL Specification</a>: WebGPU Shading Language reference<li><a rel="noopener nofollow noreferrer" href=http://www.realtimerendering.com/raytracinggems/ target=_blank>Ray Tracing Gems</a>: Practical techniques for real-time ray tracing</ol><p>This implementation provides a solid foundation for real-time ray traced lighting in Bevy while demonstrating practical tradeoffs between quality and performance. The RIS approach balances computational cost with visual fidelity, and the architecture allows for natural extension to more advanced techniques like spatiotemporal reuse.</div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-06/pr_19620.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>