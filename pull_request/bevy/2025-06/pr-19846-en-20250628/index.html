<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19846 Use SmallVec instead of HashMap in MaterialProperties
        
    </title><meta content="#19846 Use SmallVec instead of HashMap in MaterialProperties" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-06/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-06-28</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-06/pr-19846-zh-cn-20250628>中文</a></div></div><div class=pr-content><h2 id=use-smallvec-instead-of-hashmap-in-materialproperties>Use SmallVec instead of HashMap in MaterialProperties</h2><h3 id=basic-information>Basic Information</h3><ul><li><strong>Title</strong>: Use SmallVec instead of HashMap in MaterialProperties<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19846<li><strong>Author</strong>: IceSentry<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, C-Performance, S-Needs-Benchmarking, S-Needs-Review<li><strong>Created</strong>: 2025-06-28T06:14:02Z<li><strong>Merged</strong>: 2025-06-28T19:03:20Z<li><strong>Merged By</strong>: superdump</ul><h3 id=description-translation>Description Translation</h3><p><strong>Objective</strong><ul><li>MaterialProperties uses HashMap for some data that is generally going to be really small. This is likely using more memory than necessary</ul><p><strong>Solution</strong><ul><li>Use a SmallVec instead<li>I used the size a StandardMaterial would need for all the backing arrays</ul><p><strong>Testing</strong><ul><li>Tested the 3d_scene to confirm it still works</ul><p><strong>Notes</strong> I’m not sure if it made a measurable difference since I’m not sure how to measure this. It’s a bit hard to create an artificial workflow where this would be the main bottleneck. This is very in the realm of microoptimization.<h3 id=the-story-of-this-pull-request>The Story of This Pull Request</h3><p>The <code>MaterialProperties</code> struct in Bevy’s rendering system contained two HashMap fields for storing draw functions and shaders. HashMaps provide O(1) lookups but carry significant memory overhead due to their internal structure (buckets, hashing state, and load factor management). For typical use cases like <code>StandardMaterial</code>, these collections contain only 3-4 entries yet incur HashMap’s fixed overhead per instance.<p>The author identified this as a potential memory optimization opportunity. Since materials are created frequently (each material instance gets its own <code>MaterialProperties</code>), reducing per-instance overhead could yield meaningful memory savings across large scenes. The solution replaces the HashMaps with <code>SmallVec</code> - a stack-allocated vector that avoids heap allocations for small collections. The backing arrays were sized to accommodate <code>StandardMaterial</code>’s typical needs: 4 entries for draw functions and 3 for shaders.<p>Implementation required updating all access patterns:<ol><li>Lookup methods (<code>get_shader</code>, <code>get_draw_function</code>) were converted from HashMap’s <code>get</code> to linear searches through the SmallVec<li>Insertion methods (<code>add_shader</code>, <code>add_draw_function</code>) were simplified to <code>push</code> operations<li>Initialization code was updated to build the collections via <code>push</code> instead of <code>insert</code></ol><p>The prepass module was also updated to use the new <code>get_shader</code> method rather than directly accessing the collection. Testing confirmed functionality remained intact in the 3d_scene example.<p>This optimization targets memory efficiency rather than computational performance. The trade-off involves replacing O(1) HashMap lookups with O(n) linear scans, but given the small collection sizes (n ≤ 4), the practical difference is negligible. The memory savings per material instance come from:<ul><li>Eliminating HashMap’s internal bucket structure<li>Removing hashing overhead<li>Avoiding pointer indirection for small collections</ul><h3 id=visual-representation>Visual Representation</h3><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[MaterialProperties] --> B[draw_functions]
</span><span>    A --> C[shaders]
</span><span>    B --> D[SmallVec]
</span><span>    C --> E[SmallVec]
</span><span>    D --> F[Stack allocation]
</span><span>    E --> G[Stack allocation]
</span><span>    F --> H[Reduced memory overhead]
</span><span>    G --> H
</span></code></pre><h3 id=key-files-changed>Key Files Changed</h3><p><strong>1. crates/bevy_pbr/src/material.rs</strong><ul><li>Replaced HashMap with SmallVec in MaterialProperties<li>Updated access methods to use linear search<li>Modified initialization code to use push operations</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub</span><span> draw_functions</span><span style=color:#61676ccc>: </span><span>HashMap&LTInternedDrawFunctionLabel, DrawFunctionId></span><span style=color:#61676ccc>,
</span><span style=color:#fa6e32>pub</span><span> shaders</span><span style=color:#61676ccc>: </span><span>HashMap&LTInternedShaderLabel, Handle&LTShader>></span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub</span><span> draw_functions</span><span style=color:#61676ccc>: </span><span>SmallVec<[(InternedDrawFunctionLabel, DrawFunctionId)</span><span style=color:#61676ccc>; </span><span style=color:#ff8f40>4</span><span>]></span><span style=color:#61676ccc>,
</span><span style=color:#fa6e32>pub</span><span> shaders</span><span style=color:#61676ccc>: </span><span>SmallVec<[(InternedShaderLabel, Handle&LTShader>)</span><span style=color:#61676ccc>; </span><span style=color:#ff8f40>3</span><span>]></span><span style=color:#61676ccc>,
</span></code></pre><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Lookup method before:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>get_shader</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>label</span><span style=color:#61676ccc>:</span><span> impl ShaderLabel) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTHandle&LTShader>> {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>shaders</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#ed9366>&</span><span>label</span><span style=color:#ed9366>.</span><span style=color:#f07171>intern</span><span>())</span><span style=color:#ed9366>.</span><span style=color:#f07171>cloned</span><span>()
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Lookup method after:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>get_shader</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>label</span><span style=color:#61676ccc>:</span><span> impl ShaderLabel) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTHandle&LTShader>> {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>shaders
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>find</span><span>(|(</span><span style=color:#ff8f40>inner_label</span><span style=color:#61676ccc>,</span><span> _)| inner_label </span><span style=color:#ed9366>== &</span><span>label</span><span style=color:#ed9366>.</span><span style=color:#f07171>intern</span><span>())
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|(_</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>shader</span><span>)| shader)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>cloned</span><span>()
</span><span>}
</span></code></pre><p><strong>2. crates/bevy_pbr/src/prepass/mod.rs</strong><ul><li>Updated shader access to use get_shader() method</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>material_properties
</span><span>    </span><span style=color:#ed9366>.</span><span>shaders
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#ed9366>&</span><span>PrepassFragmentShader</span><span style=color:#ed9366>.</span><span style=color:#f07171>intern</span><span>())
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>material_properties</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_shader</span><span>(PrepassFragmentShader)
</span></code></pre><h3 id=further-reading>Further Reading</h3><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/smallvec/latest/smallvec/ target=_blank>SmallVec Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://nnethercote.github.io/perf-book/collections.html#hash-maps target=_blank>Rust HashMap Internals</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/features/pbr/ target=_blank>Bevy Material System</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-06/pr_19846.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>