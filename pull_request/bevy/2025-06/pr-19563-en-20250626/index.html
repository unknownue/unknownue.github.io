<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19563 Ugrade to `wgpu` version `25.0`
        
    </title><meta content="#19563 Ugrade to `wgpu` version `25.0`" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-06/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-06-26</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-06/pr-19563-zh-cn-20250626>中文</a></div></div><div class=pr-content><h1 id=upgrade-to-wgpu-version-25-0-analysis>Upgrade to <code>wgpu</code> version <code>25.0</code> Analysis</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Ugrade to <code>wgpu</code> version <code>25.0</code><li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19563<li><strong>Author</strong>: tychedelia<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, M-Needs-Migration-Guide, S-Needs-Review<li><strong>Created</strong>: 2025-06-09T22:41:08Z<li><strong>Merged</strong>: 2025-06-26T20:02:14Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Upgrade to <code>wgpu</code> version <code>25.0</code>.<p>Depends on https://github.com/bevyengine/naga_oil/pull/121<h2 id=solution>Solution</h2><h3 id=problem>Problem</h3><p>The biggest issue we face upgrading is the following requirement:<blockquote><p>To facilitate this change, there was an additional validation rule put in place: if there is a binding array in a bind group, you may not use dynamic offset buffers or uniform buffers in that bind group. This requirement comes from vulkan rules on UpdateAfterBind descriptors.</blockquote><p>This is a major difficulty for us, as there are a number of binding arrays that are used in the view bind group. Note, this requirement does not affect merely uniform buffors that use dynamic offset but the use of <em>any</em> uniform in a bind group that also has a binding array.<h3 id=attempted-fixes>Attempted fixes</h3><p>The easiest fix would be to change uniforms to be storage buffers whenever binding arrays are in use:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>#ifdef BINDING_ARRAYS_ARE_USED
</span><span>@group(0) @binding(0) var&LTuniform> view: View;
</span><span>@group(0) @binding(1) var&LTuniform> lights: types::Lights;
</span><span>#else
</span><span>@group(0) @binding(0) var&LTstorage> view: array&LTView>;
</span><span>@group(0) @binding(1) var&LTstorage> lights: array&LTtypes::Lights>;
</span><span>#endif
</span></code></pre><p>This requires passing the view index to the shader so that we know where to index into the buffer:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>struct PushConstants {
</span><span>    view_index: u32,
</span><span>}
</span><span>
</span><span>var&LTpush_constant> push_constants: PushConstants;
</span></code></pre><p>Using push constants is no problem because binding arrays are only usable on native anyway.<p>However, this greatly complicates the ability to access <code>view</code> in shaders. For example:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>#ifdef BINDING_ARRAYS_ARE_USED
</span><span>mesh_view_bindings::view.view_from_world[0].z
</span><span>#else
</span><span>mesh_view_bindings::view[mesh_view_bindings::view_index].view_from_world[0].z
</span><span>#endif
</span></code></pre><p>Using this approach would work but would have the effect of polluting our shaders with ifdef spam basically <em>everywhere</em>.<p>Why not use a function? Unfortunately, the following is not valid wgsl as it returns a binding directly from a function in the uniform path.<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>fn get_view() -> View {
</span><span>#if BINDING_ARRAYS_ARE_USED
</span><span>    let view_index = push_constants.view_index;
</span><span>    let view = views[view_index];
</span><span>#endif
</span><span>    return view;
</span><span>}
</span></code></pre><p>This also poses problems for things like lights where we want to return a ptr to the light data. Returning ptrs from wgsl functions isn’t allowed even if both bindings were buffers.<p>The next attempt was to simply use indexed buffers everywhere, in both the binding array and non binding array path. This would be viable if push constants were available everywhere to pass the view index, but unfortunately they are not available on webgpu. This means either passing the view index in a storage buffer (not ideal for such a small amount of state) or using push constants sometimes and uniform buffers only on webgpu. However, this kind of conditional layout infects absolutely everything.<p>Even if we were to accept just using storage buffer for the view index, there’s also the additional problem that some dynamic offsets aren’t actually per-view but per-use of a setting on a camera, which would require passing that uniform data on <em>every</em> camera regardless of whether that rendering feature is being used, which is also gross.<p>As such, although it’s gross, the simplest solution just to bump binding arrays into <code>@group(1)</code> and all other bindings up one bind group. This should still bring us under the device limit of 4 for most users.<h3 id=next-steps-looking-towards-the-future>Next steps / looking towards the future</h3><p>I’d like to avoid needing split our view bind group into multiple parts. In the future, if <code>wgpu</code> were to add <code>@builtin(draw_index)</code>, we could build a list of draw state in gpu processing and avoid the need for any kind of state change at all (see https://github.com/gfx-rs/wgpu/issues/6823). This would also provide significantly more flexibility to handle things like offsets into other arrays that may not be per-view.<h3 id=testing>Testing</h3><p>Tested a number of examples, there are probably more that are still broken.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=the-problem-and-context>The Problem and Context</h3><p>The upgrade to <code>wgpu</code> 25.0 introduced a new validation rule: binding arrays cannot coexist with uniform buffers or dynamic offset buffers in the same bind group. This rule stems from Vulkan’s UpdateAfterBind descriptor requirements. Since Bevy’s view bind group extensively uses both binding arrays and uniforms, this change presented a significant compatibility challenge.<h3 id=the-solution-approach>The Solution Approach</h3><p>Several approaches were considered:<ol><li><strong>Conditional storage buffers</strong>: Convert uniforms to storage buffers when binding arrays are present <ul><li>Required passing view indices via push constants<li>Introduced pervasive <code>#ifdef</code> logic in shaders<li>Not viable due to shader complexity and platform limitations</ul><li><strong>Indexed buffers everywhere</strong>: Use storage buffers for view data in all cases <ul><li>Limited by WebGPU’s lack of push constant support<li>Would require per-camera uniform data passing</ul></ol><p>The chosen solution reorganizes bind groups:<ul><li>Binding arrays moved to <code>@group(1)</code><li>Mesh bindings shifted to <code>@group(2)</code><li>Material bindings shifted to <code>@group(3)</code></ul><p>This maintains compatibility with device limitations (most devices support at least 4 bind groups) while avoiding the shader complexity of other approaches.<h3 id=the-implementation>The Implementation</h3><p>The implementation required coordinated changes across multiple systems:<ol><li><p><strong>View bind group reorganization</strong>:</p> <ul><li>Split into two bind groups: <code>main</code> (uniforms) and <code>binding_array</code> (binding arrays)<li>Added empty bind group for padding where needed</ul> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>MeshPipelineViewLayout </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>main_layout</span><span style=color:#61676ccc>:</span><span> BindGroupLayout,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>binding_array_layout</span><span style=color:#61676ccc>:</span><span> BindGroupLayout,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>empty_layout</span><span style=color:#61676ccc>:</span><span> BindGroupLayout,
</span><span>}
</span></code></pre><li><p><strong>Render pass adjustments</strong>:</p> <ul><li>Updated bind group indices in all rendering pipelines<li>Added new <code>SetMeshViewBindingArrayBindGroup</code> and <code>SetMeshViewEmptyBindGroup</code> commands</ul> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>render_pass</span><span style=color:#ed9366>.</span><span style=color:#f07171>set_bind_group</span><span>(</span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>mesh_view_bind_group</span><span style=color:#ed9366>.</span><span>main</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>offsets)</span><span style=color:#61676ccc>;
</span><span>render_pass</span><span style=color:#ed9366>.</span><span style=color:#f07171>set_bind_group</span><span>(</span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>mesh_view_bind_group</span><span style=color:#ed9366>.</span><span>binding_array</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>[])</span><span style=color:#61676ccc>;
</span></code></pre><li><p><strong>Shader updates</strong>:</p> <ul><li>Modified group indices for all affected resources</ul> <pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>@group(0) @binding(17) var diffuse_environment_map: texture_cube&LTf32>;
</span><span>
</span><span>// After:
</span><span>@group(1) @binding(0) var diffuse_environment_map: texture_cube&LTf32>;
</span></code></pre><li><p><strong>Material system changes</strong>:</p> <ul><li>Updated material bind groups from group 2 to group 3</ul> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>descriptor</span><span style=color:#ed9366>.</span><span>layout</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(</span><span style=color:#ff8f40>3</span><span style=color:#61676ccc>, </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>material_layout</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>())</span><span style=color:#61676ccc>;
</span></code></pre></ol><h3 id=technical-insights>Technical Insights</h3><p>Key technical considerations:<ul><li>Maintained backward compatibility for most user-facing APIs<li>Minimized shader changes through systematic group renumbering<li>Ensured WebGL compatibility by preserving fallback paths<li>Addressed new <code>wgpu</code> limitations around shader constants:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Now required
</span><span>const FOO: f32 = 1.0;
</span><span>
</span><span>// No longer allowed
</span><span>const FOO = 1.0;
</span></code></pre></ul><h3 id=the-impact>The Impact</h3><p>The changes:<ol><li>Resolve compatibility with <code>wgpu</code> 25.0<li>Maintain rendering performance by avoiding expensive shader branching<li>Require updates to custom materials: <ul><li>Group indices increased by 1 (e.g., <code>@group(2)</code> → <code>@group(3)</code>)</ul><li>Introduce minor complexity in render graph organization</ol><p>The solution provides a foundation for future improvements like draw-indexed rendering while maintaining Bevy’s rendering capabilities across all supported platforms.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[View Bind Group] --> B[Binding Arrays Group 1]
</span><span>    A --> C[Uniforms Group 0]
</span><span>    D[Mesh Bindings Group 2]
</span><span>    E[Material Bindings Group 3]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-pbr-src-render-mesh-view-bindings-rs-161-119><code>crates/bevy_pbr/src/render/mesh_view_bindings.rs</code> (+161/-119)</h3><p>Reorganized view bind groups into separate layouts for main uniforms and binding arrays.<p><strong>Key changes:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>MeshPipelineViewLayout </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>bind_group_layout</span><span style=color:#61676ccc>:</span><span> BindGroupLayout,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>MeshPipelineViewLayout </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>main_layout</span><span style=color:#61676ccc>:</span><span> BindGroupLayout,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>binding_array_layout</span><span style=color:#61676ccc>:</span><span> BindGroupLayout,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>empty_layout</span><span style=color:#61676ccc>:</span><span> BindGroupLayout,
</span><span>}
</span></code></pre><h3 id=crates-bevy-pbr-src-render-mesh-view-bindings-wgsl-39-39><code>crates/bevy_pbr/src/render/mesh_view_bindings.wgsl</code> (+39/-39)</h3><p>Updated binding locations for all resources affected by group reorganization.<p><strong>Example change:</strong><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>@group(0) @binding(17) var diffuse_environment_map: texture_cube&LTf32>;
</span><span>
</span><span>// After:
</span><span>@group(1) @binding(0) var diffuse_environment_map: texture_cube&LTf32>;
</span></code></pre><h3 id=crates-bevy-pbr-src-prepass-mod-rs-56-13><code>crates/bevy_pbr/src/prepass/mod.rs</code> (+56/-13)</h3><p>Adjusted prepass pipelines to use new bind group structure.<p><strong>Key addition:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>SetPrepassViewEmptyBindGroup</span><span><</span><span style=color:#fa6e32>const</span><span> I</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize</span><span>></span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>impl</span><span>&LTP</span><span style=color:#61676ccc>:</span><span> PhaseItem, </span><span style=color:#fa6e32>const</span><span> I</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize</span><span>> RenderCommand&LTP> </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>SetPrepassViewEmptyBindGroup</span><span>&LTI> {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Implementation sets empty bind group at specified index
</span><span>}
</span></code></pre><h3 id=crates-bevy-pbr-src-render-pbr-bindings-wgsl-33-33><code>crates/bevy_pbr/src/render/pbr_bindings.wgsl</code> (+33/-33)</h3><p>Updated material binding locations from group 2 to group 3.<p><strong>Example change:</strong><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>@group(2) @binding(0) var&LTuniform> material: StandardMaterial;
</span><span>
</span><span>// After:
</span><span>@group(3) @binding(0) var&LTuniform> material: StandardMaterial;
</span></code></pre><h3 id=crates-bevy-pbr-src-render-mesh-rs-50-3><code>crates/bevy_pbr/src/render/mesh.rs</code> (+50/-3)</h3><p>Added new render commands for binding array and empty bind groups.<p><strong>New commands:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>SetMeshViewBindingArrayBindGroup</span><span><</span><span style=color:#fa6e32>const</span><span> I</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize</span><span>></span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>SetMeshViewEmptyBindGroup</span><span><</span><span style=color:#fa6e32>const</span><span> I</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize</span><span>></span><span style=color:#61676ccc>;
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://github.com/gfx-rs/wgpu/blob/trunk/CHANGELOG.md#v2500-2025-04-10 target=_blank><code>wgpu</code> 25.0 Changelog</a><li><a rel="noopener nofollow noreferrer" href=https://www.khronos.org/registry/vulkan/specs/1.3-extensions/html/vkspec.html#features-descriptorIndexing target=_blank>Vulkan UpdateAfterBind Specification</a><li><a rel="noopener nofollow noreferrer" href=https://gpuweb.github.io/gpuweb/#abstract-bindings-model target=_blank>WebGPU Binding Model Documentation</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-06/pr_19563.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>