<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19659 Make sequential_dispersed fn constant
        
    </title><meta content="#19659 Make sequential_dispersed fn constant" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-06/>‚Üê Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-06-15</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-06/pr-19659-zh-cn-20250615>‰∏≠Êñá</a></div></div><div class=pr-content><h2 id=title-make-sequential-dispersed-fn-constant>Title: Make sequential_dispersed fn constant</h2><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Make sequential_dispersed fn constant<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19659<li><strong>Author</strong>: alice-i-cecile<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: D-Trivial, C-Usability, S-Ready-For-Final-Review, A-Color<li><strong>Created</strong>: 2025-06-15T16:36:08Z<li><strong>Merged</strong>: 2025-06-15T17:22:22Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Try to make more of <code>bevy_color</code> const now that we have const_float_arithmetic.</ul><h2 id=solution>Solution</h2><p>Fail abjectly, because of our heavy use of traits.<p>I did find these functions though, so you can have a PR üôÉ<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The developer recognized an opportunity to leverage Rust‚Äôs const_float_arithmetic feature to make color functions in bevy_color usable at compile time. This would allow defining constant color palettes directly in code without runtime initialization. However, most color operations rely on traits that aren‚Äôt yet supported in const contexts, limiting what could be converted.<p>The developer identified three functions - <code>sequential_dispersed</code> in the Hsla, Lcha, and Oklcha color spaces - that could be made const. These functions generate perceptually distinct hues using the golden ratio method, which relies only on basic arithmetic operations already supported in const contexts. No trait implementations were involved in their calculations.<p>The implementation approach was straightforward: add the <code>const</code> keyword to each function declaration. The functions‚Äô internals required no modifications since they only use:<ol><li>Constant values (<code>FRAC_U32MAX_GOLDEN_RATIO</code>, <code>RATIO_360</code>)<li>Basic arithmetic operations (multiplication, addition)<li>Type casting All these operations are const-compatible with const_float_arithmetic enabled.</ol><p>This change allows developers to generate color sequences at compile time. For example:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>const </span><span style=color:#ff8f40>PALETTE</span><span style=color:#61676ccc>: </span><span>[Hsla</span><span style=color:#61676ccc>; </span><span style=color:#ff8f40>5</span><span>] </span><span style=color:#ed9366>= </span><span>[
</span><span>    Hsla</span><span style=color:#ed9366>::</span><span>sequential_dispersed(</span><span style=color:#ff8f40>0</span><span>)</span><span style=color:#61676ccc>,
</span><span>    Hsla</span><span style=color:#ed9366>::</span><span>sequential_dispersed(</span><span style=color:#ff8f40>1</span><span>)</span><span style=color:#61676ccc>,
</span><span>    Hsla</span><span style=color:#ed9366>::</span><span>sequential_dispersed(</span><span style=color:#ff8f40>2</span><span>)</span><span style=color:#61676ccc>,
</span><span>    Hsla</span><span style=color:#ed9366>::</span><span>sequential_dispersed(</span><span style=color:#ff8f40>3</span><span>)</span><span style=color:#61676ccc>,
</span><span>    Hsla</span><span style=color:#ed9366>::</span><span>sequential_dispersed(</span><span style=color:#ff8f40>4</span><span>)</span><span style=color:#61676ccc>,
</span><span>]</span><span style=color:#61676ccc>;
</span></code></pre><p>The main limitation encountered was Rust‚Äôs current inability to use traits in const contexts, which prevented converting more complex color operations. This constraint is noted in the PR description as the reason only these specific functions were modified.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    Hsla --> sequential_dispersed
</span><span>    Lcha --> sequential_dispersed
</span><span>    Oklcha --> sequential_dispersed
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-color-src-hsla-rs><code>crates/bevy_color/src/hsla.rs</code></h3><p><strong>Change</strong>: Made <code>sequential_dispersed</code> function const<br> <strong>Why</strong>: Enable compile-time color sequence generation<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>sequential_dispersed</span><span>(</span><span style=color:#ff8f40>index</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u32</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>    </span><span style=color:#fa6e32>const </span><span style=color:#ff8f40>FRAC_U32MAX_GOLDEN_RATIO</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u32 </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>2654435769</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>const </span><span style=color:#ff8f40>RATIO_360</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32 </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>360.0 </span><span style=color:#ed9366>/ </span><span style=color:#fa6e32>u32</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>MAX </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... implementation unchanged ...
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub const fn </span><span style=color:#f29718>sequential_dispersed</span><span>(</span><span style=color:#ff8f40>index</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u32</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>    </span><span style=color:#fa6e32>const </span><span style=color:#ff8f40>FRAC_U32MAX_GOLDEN_RATIO</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u32 </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>2654435769</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>const </span><span style=color:#ff8f40>RATIO_360</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32 </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>360.0 </span><span style=color:#ed9366>/ </span><span style=color:#fa6e32>u32</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>MAX </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... implementation unchanged ...
</span><span>}
</span></code></pre><h3 id=crates-bevy-color-src-lcha-rs><code>crates/bevy_color/src/lcha.rs</code></h3><p><strong>Change</strong>: Made <code>sequential_dispersed</code> function const<br> <strong>Why</strong>: Consistent const support across color spaces<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>sequential_dispersed</span><span>(</span><span style=color:#ff8f40>index</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u32</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>    </span><span style=color:#fa6e32>const </span><span style=color:#ff8f40>FRAC_U32MAX_GOLDEN_RATIO</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u32 </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>2654435769</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>const </span><span style=color:#ff8f40>RATIO_360</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32 </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>360.0 </span><span style=color:#ed9366>/ </span><span style=color:#fa6e32>u32</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>MAX </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... implementation unchanged ...
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub const fn </span><span style=color:#f29718>sequential_dispersed</span><span>(</span><span style=color:#ff8f40>index</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u32</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>    </span><span style=color:#fa6e32>const </span><span style=color:#ff8f40>FRAC_U32MAX_GOLDEN_RATIO</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u32 </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>2654435769</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>const </span><span style=color:#ff8f40>RATIO_360</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32 </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>360.0 </span><span style=color:#ed9366>/ </span><span style=color:#fa6e32>u32</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>MAX </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... implementation unchanged ...
</span><span>}
</span></code></pre><h3 id=crates-bevy-color-src-oklcha-rs><code>crates/bevy_color/src/oklcha.rs</code></h3><p><strong>Change</strong>: Made <code>sequential_dispersed</code> function const<br> <strong>Why</strong>: Complete coverage for perceptual color spaces<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>sequential_dispersed</span><span>(</span><span style=color:#ff8f40>index</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u32</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>    </span><span style=color:#fa6e32>const </span><span style=color:#ff8f40>FRAC_U32MAX_GOLDEN_RATIO</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u32 </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>2654435769</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>const </span><span style=color:#ff8f40>RATIO_360</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32 </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>360.0 </span><span style=color:#ed9366>/ </span><span style=color:#fa6e32>u32</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>MAX </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... implementation unchanged ...
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub const fn </span><span style=color:#f29718>sequential_dispersed</span><span>(</span><span style=color:#ff8f40>index</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u32</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>    </span><span style=color:#fa6e32>const </span><span style=color:#ff8f40>FRAC_U32MAX_GOLDEN_RATIO</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u32 </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>2654435769</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>const </span><span style=color:#ff8f40>RATIO_360</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32 </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>360.0 </span><span style=color:#ed9366>/ </span><span style=color:#fa6e32>u32</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>MAX </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... implementation unchanged ...
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/reference/const_eval.html target=_blank>Rust Reference: Const Functions</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_color/latest/bevy_color/ target=_blank>Bevy Color Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://martin.ankerl.com/2009/12/09/how-to-create-random-colors-programmatically/ target=_blank>Golden Ratio in Color Generation</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/rust-lang/rust/issues/57241 target=_blank>Const Float Arithmetic Tracking Issue</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-06/pr_19659.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>