<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19495 Use component_access_set to determine the set of conflicting accesses between two systems.
        
    </title><meta content="#19495 Use component_access_set to determine the set of conflicting accesses between two systems." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-06/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-06-09</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-06/pr-19495-zh-cn-20250609>中文</a></div></div><div class=pr-content><h1 id=pr-analysis-use-component-access-set-to-determine-the-set-of-conflicting-accesses-between-two-systems>PR Analysis: Use component_access_set to determine the set of conflicting accesses between two systems</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Use component_access_set to determine the set of conflicting accesses between two systems.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19495<li><strong>Author</strong>: andriyDev<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-ECS, S-Ready-For-Final-Review, D-Straightforward<li><strong>Created</strong>: 2025-06-05T00:22:37Z<li><strong>Merged</strong>: 2025-06-09T20:01:22Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Fixes #4381</ul><h2 id=solution>Solution</h2><ul><li>Replace <code>component_access</code> with <code>component_access_set</code> when determining conflicting systems during schedule building.<li>All <code>component_access()</code> impls just forward to <code>&component_access_set().combined_access</code>, so we are essentially trading <code>Access::is_compatible</code> for <code>FilteredAccessSet::is_compatible</code>.<li><code>FilteredAccessSet::get_conflicts</code> internally calls <code>combined_access.is_compatible</code> as the first step, so we can remove that redundant check.</ul><h2 id=testing>Testing</h2><ul><li>Un-ignored a previously failing test now that it passes!<li>Ran the <code>build_schedule</code> benchmark and got basically no change in the results. Perhaps are benchmarks are just not targetted towards this situation.</ul><pre style=color:#61676c;background-color:#fafafa><code><span>$ critcmp main fix-ambiguity -f 'build_schedule'
</span><span>group                                          fix-ambiguity                          main
</span><span>-----                                          -------------                          ----
</span><span>build_schedule/1000_schedule                   1.00       2.9±0.02s        ? ?/sec    1.01       2.9±0.05s        ? ?/sec
</span><span>build_schedule/1000_schedule_no_constraints    1.02     48.3±1.48ms        ? ?/sec    1.00     47.4±1.78ms        ? ?/sec
</span><span>build_schedule/100_schedule                    1.00      9.9±0.17ms        ? ?/sec    1.06     10.5±0.32ms        ? ?/sec
</span><span>build_schedule/100_schedule_no_constraints     1.00   804.7±21.85µs        ? ?/sec    1.03   828.7±19.36µs        ? ?/sec
</span><span>build_schedule/500_schedule                    1.00    451.7±7.25ms        ? ?/sec    1.04   468.9±11.70ms        ? ?/sec
</span><span>build_schedule/500_schedule_no_constraints     1.02     12.7±0.46ms        ? ?/sec    1.00     12.5±0.44ms        ? ?/sec
</span></code></pre><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=the-problem-and-context>The Problem and Context</h3><p>This PR addresses a long-standing issue (#4381) in Bevy’s ECS scheduler where the system conflict detection wasn’t properly handling filtered component accesses. The core problem was that when determining if two systems conflicted, the scheduler was only considering the combined component access patterns without accounting for the full filtered access sets. This could lead to missed conflicts when systems used component filters (like <code>With&LTT></code> or <code>Without&LTT></code>), potentially causing data races during parallel execution.<p>The issue manifested in a specific test case (<code>filtered_components</code>) that had been marked as ignored due to its failure. This test was designed to verify correct conflict detection between systems with filtered component accesses, but the existing implementation couldn’t properly handle these cases.<h3 id=the-solution-approach>The Solution Approach</h3><p>The solution centers on switching from using <code>component_access()</code> to <code>component_access_set()</code> when checking for system conflicts. The key insight was that:<ol><li>All <code>component_access()</code> implementations simply forward to <code>&component_access_set().combined_access</code><li>Using the full filtered access set provides more accurate conflict detection<li>The existing <code>get_conflicts</code> method already contained a redundant compatibility check that could be eliminated</ol><p>By making this change, we effectively replace the less accurate <code>Access::is_compatible</code> check with the more comprehensive <code>FilteredAccessSet::is_compatible</code> logic. This ensures that all aspects of component access patterns, including filters, are considered during conflict detection.<h3 id=the-implementation>The Implementation</h3><p>The core changes occur in the schedule graph construction logic. Previously, the implementation would:<ol><li>Retrieve each system’s component access<li>Check if they were incompatible<li>If incompatible, retrieve the specific conflicts</ol><p>The updated implementation:<ol><li>Retrieves each system’s full component access set<li>Directly checks for conflicts using <code>get_conflicts</code><li>Processes the results without the redundant compatibility check</ol><p>Here’s the key change in the conflict detection logic:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> access_a </span><span style=color:#ed9366>=</span><span> system_a</span><span style=color:#ed9366>.</span><span style=color:#f07171>component_access</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> access_b </span><span style=color:#ed9366>=</span><span> system_b</span><span style=color:#ed9366>.</span><span style=color:#f07171>component_access</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>access_a</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_compatible</span><span>(access_b) {
</span><span>    </span><span style=color:#fa6e32>match</span><span> access_a</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_conflicts</span><span>(access_b) {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ... conflict handling ...
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> access_a </span><span style=color:#ed9366>=</span><span> system_a</span><span style=color:#ed9366>.</span><span style=color:#f07171>component_access_set</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> access_b </span><span style=color:#ed9366>=</span><span> system_b</span><span style=color:#ed9366>.</span><span style=color:#f07171>component_access_set</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>match</span><span> access_a</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_conflicts</span><span>(access_b) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... conflict handling ...
</span><span>}
</span></code></pre><p>This change eliminates the redundant <code>is_compatible</code> check since <code>get_conflicts</code> already performs this check internally. The result is cleaner code that properly accounts for filtered accesses.<h3 id=technical-insights>Technical Insights</h3><p>The key improvement comes from using <code>FilteredAccessSet</code> instead of the simplified <code>Access</code> structure. A <code>FilteredAccessSet</code> contains the complete access pattern information including:<ul><li>Read/write access types<li>Component filters (<code>With</code>, <code>Without</code>, etc.)<li>Combined access patterns</ul><p>This provides a more accurate representation of a system’s actual access requirements compared to the combined access alone. The <code>get_conflicts</code> method properly considers all these factors when determining conflicts between systems.<h3 id=the-impact>The Impact</h3><p>The most immediate impact is fixing the known issue with filtered component conflicts. The previously failing <code>filtered_components</code> test now passes and has been un-ignored. This improves the scheduler’s correctness when dealing with complex system access patterns involving filters.<p>Performance benchmarks showed no significant regression, indicating the change doesn’t add computational overhead despite providing more accurate conflict detection. The solution maintains Bevy’s strict safety guarantees around parallel system execution while fixing a subtle edge case.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[System A] -->|component_access_set| FAS_A[FilteredAccessSet A]
</span><span>    B[System B] -->|component_access_set| FAS_B[FilteredAccessSet B]
</span><span>    FAS_A -->|get_conflicts| FAS_B
</span><span>    FAS_B -->|result| C{Conflicts?}
</span><span>    C -->|Individual| D[Specific conflicts]
</span><span>    C -->|All| E[Complete incompatibility]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ecs-src-schedule-schedule-rs><code>crates/bevy_ecs/src/schedule/schedule.rs</code></h3><p><strong>Changes</strong>:<ul><li>Replaced <code>component_access()</code> with <code>component_access_set()</code> for conflict detection<li>Removed redundant compatibility check before calling <code>get_conflicts</code><li>Simplified control flow by directly matching on <code>get_conflicts</code> result</ul><p><strong>Code Snippet</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> access_a </span><span style=color:#ed9366>=</span><span> system_a</span><span style=color:#ed9366>.</span><span style=color:#f07171>component_access</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> access_b </span><span style=color:#ed9366>=</span><span> system_b</span><span style=color:#ed9366>.</span><span style=color:#f07171>component_access</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>access_a</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_compatible</span><span>(access_b) {
</span><span>    </span><span style=color:#fa6e32>match</span><span> access_a</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_conflicts</span><span>(access_b) {
</span><span>        AccessConflicts</span><span style=color:#ed9366>::</span><span>Individual(conflicts) </span><span style=color:#ed9366>=> </span><span>{
</span><span>            </span><span style=color:#abb0b6;font-style:italic>// ... conflict processing ...
</span><span>        }
</span><span>        AccessConflicts</span><span style=color:#ed9366>::</span><span>All </span><span style=color:#ed9366>=> </span><span>{
</span><span>            </span><span style=color:#abb0b6;font-style:italic>// ... complete incompatibility ...
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> access_a </span><span style=color:#ed9366>=</span><span> system_a</span><span style=color:#ed9366>.</span><span style=color:#f07171>component_access_set</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> access_b </span><span style=color:#ed9366>=</span><span> system_b</span><span style=color:#ed9366>.</span><span style=color:#f07171>component_access_set</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>match</span><span> access_a</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_conflicts</span><span>(access_b) {
</span><span>    AccessConflicts</span><span style=color:#ed9366>::</span><span>Individual(conflicts) </span><span style=color:#ed9366>=> </span><span>{
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ... conflict processing ...
</span><span>    }
</span><span>    AccessConflicts</span><span style=color:#ed9366>::</span><span>All </span><span style=color:#ed9366>=> </span><span>{
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ... complete incompatibility ...
</span><span>    }
</span><span>}
</span></code></pre><h3 id=crates-bevy-ecs-src-schedule-mod-rs><code>crates/bevy_ecs/src/schedule/mod.rs</code></h3><p><strong>Changes</strong>:<ul><li>Un-ignored the <code>filtered_components</code> test that previously failed due to the conflict detection issue</ul><p><strong>Code Snippet</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>ignore </span><span style=color:#ed9366>= </span><span style=color:#86b300>"Known failing but fix is non-trivial: https://github.com/bevyengine/bevy/issues/4381"</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>filtered_components</span><span>() {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... test body ...
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>filtered_components</span><span>() {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... test body ...
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/issues/4381 target=_blank>Original Issue #4381</a> - Details the original problem with filtered component conflicts<li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_ecs/latest/bevy_ecs/system/trait.SystemParam.html target=_blank>Bevy ECS System Params Documentation</a> - Explains system parameter access patterns<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/getting-started/ecs/#systems target=_blank>Bevy Schedule Execution Model</a> - Overview of Bevy’s system scheduling approach<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/crates/bevy_ecs/src/query/filtered_access.rs target=_blank>FilteredAccessSet Implementation</a> - Source code for the filtered access data structure</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-06/pr_19495.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>