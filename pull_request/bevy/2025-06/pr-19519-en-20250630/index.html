<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19519 Fixing Relationship Inconsistencies in Batch Spawning Operations
        
    </title><meta content="#19519 Fixing Relationship Inconsistencies in Batch Spawning Operations" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-06/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-06-30</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-06/pr-19519-zh-cn-20250630>中文</a></div></div><div class=pr-content><h2 id=title-fixing-relationship-inconsistencies-in-batch-spawning-operations>Title: Fixing Relationship Inconsistencies in Batch Spawning Operations</h2><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Spawn batch with relationship<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19519<li><strong>Author</strong>: gwafotapa<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-ECS, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-06-06T22:54:38Z<li><strong>Merged</strong>: 2025-06-30T22:36:09Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Fixes #19356 Issue: Spawning a batch of entities in relationship with the same target adds the relationship between the target and only the last entity of the batch. <code>spawn_batch</code> flushes only after having spawned all entities. This means each spawned entity will have run the <code>on_insert</code> hook of its <code>Relationship</code> component. Here is the relevant part of that hook:<pre class=language-Rust data-lang=Rust style=color:#61676c;background-color:#fafafa><code class=language-Rust data-lang=Rust><span>            </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#fa6e32>mut</span><span> relationship_target) </span><span style=color:#ed9366>=
</span><span>                target_entity_mut</span><span style=color:#ed9366>.</span><span>get_mut</span><span style=color:#ed9366>::</span><span><</span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>RelationshipTarget>()
</span><span>            {
</span><span>                relationship_target</span><span style=color:#ed9366>.</span><span style=color:#f07171>collection_mut_risky</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(entity)</span><span style=color:#61676ccc>;
</span><span>            } </span><span style=color:#fa6e32>else </span><span>{
</span><span>                </span><span style=color:#fa6e32>let mut</span><span> target </span><span style=color:#ed9366>= </span><span><</span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>RelationshipTarget </span><span style=color:#ed9366>as</span><span> RelationshipTarget></span><span style=color:#ed9366>::</span><span>with_capacity(</span><span style=color:#ff8f40>1</span><span>)</span><span style=color:#61676ccc>;
</span><span>                target</span><span style=color:#ed9366>.</span><span style=color:#f07171>collection_mut_risky</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(entity)</span><span style=color:#61676ccc>;
</span><span>                world</span><span style=color:#ed9366>.</span><span style=color:#f07171>commands</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(target_entity)</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(target)</span><span style=color:#61676ccc>;
</span><span>            }
</span></code></pre><p>Given the above snippet and since there’s no flush between spawns, each entity finds the target without a <code>RelationshipTarget</code> component and defers the insertion of that component with the entity’s id as the sole member of its collection. When the commands are finally flushed, each insertion after the first replaces the one before and in the process triggers the <code>on_replace</code> hook of <code>RelationshipTarget</code> which removes the <code>Relationship</code> component from the corresponding entity. That’s how we end up in the invalid state.<h2 id=solution>Solution</h2><p>I see two possible solutions<ol><li>Flush after every spawn<li>Defer the whole code snippet above</ol><p>I don’t know enough about bevy as a whole but 2. seems much more efficient to me. This is what I’m proposing here. I have a doubt though because I’ve started to look at #19348 that 1. would fix as well.<h2 id=testing>Testing</h2><p>I added a test for the issue. I’ve put it in <code>relationship/mod.rs</code> but I could see it in <code>world/spawn_batch.rs</code> or <code>lib.rs</code> because the test is as much about <code>spawn_batch</code> as it is about relationships.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=problem-identification>Problem Identification</h3><p>The issue (#19356) occurred when spawning multiple entities in a batch that all shared a relationship with the same target entity. In batch spawning operations, Bevy’s ECS doesn’t flush commands between individual spawns. This caused a race condition in relationship management where:<ol><li>Each new entity’s <code>Relationship</code> component would trigger its <code>on_insert</code> hook<li>The hook would find the target entity missing its <code>RelationshipTarget</code> component<li>It would schedule a command to insert a new <code>RelationshipTarget</code> containing only itself<li>When commands finally flushed, only the last scheduled insert would persist<li>The intermediate inserts would trigger <code>on_replace</code> hooks that incorrectly removed relationships</ol><p>This resulted in only the final entity in the batch maintaining its relationship to the target.<h3 id=solution-approach>Solution Approach</h3><p>The developer considered two approaches:<ol><li>Flushing after every spawn: Would resolve the issue but introduce performance overhead by breaking batch efficiency<li>Deferred relationship management: Modifies the hook to use Bevy’s command system for atomic updates</ol><p>The developer implemented option #2 as it maintains batch efficiency while fixing the consistency issue. The key insight was that by using Bevy’s command entry API, all relationship updates could be deferred and applied atomically when commands flush.<h3 id=implementation-details>Implementation Details</h3><p>The solution modifies the relationship hook to use Bevy’s <code>entity_commands.entry()</code> API:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(</span><span style=color:#fa6e32>mut</span><span> entity_commands) </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>commands</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_entity</span><span>(target_entity) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Deferring is necessary for batch mode
</span><span>    entity_commands
</span><span>        </span><span style=color:#ed9366>.</span><span>entry</span><span style=color:#ed9366>::</span><span><</span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>RelationshipTarget>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>and_modify</span><span>(</span><span style=color:#fa6e32>move </span><span style=color:#ed9366>|</span><span style=color:#fa6e32>mut</span><span> relationship_target</span><span style=color:#ed9366>| </span><span>{
</span><span>            relationship_target</span><span style=color:#ed9366>.</span><span style=color:#f07171>collection_mut_risky</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(entity)</span><span style=color:#61676ccc>;
</span><span>        })
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>or_insert_with</span><span>(|| {
</span><span>            </span><span style=color:#fa6e32>let mut</span><span> target </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>RelationshipTarget</span><span style=color:#ed9366>::</span><span>with_capacity(</span><span style=color:#ff8f40>1</span><span>)</span><span style=color:#61676ccc>;
</span><span>            target</span><span style=color:#ed9366>.</span><span style=color:#f07171>collection_mut_risky</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(entity)</span><span style=color:#61676ccc>;
</span><span>            target
</span><span>        })</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>This approach:<ol><li>Uses command-based entity access instead of direct world access<li>Defers both component modification and insertion operations<li>Uses <code>and_modify</code> to update existing components<li>Uses <code>or_insert_with</code> to create new components only when needed<li>Maintains all operations in the command buffer until flush</ol><h3 id=testing-strategy>Testing Strategy</h3><p>Two tests were added to verify the fix:<ol><li><code>spawn_batch_with_relationship</code>: Validates batch spawning of child entities<li><code>insert_batch_with_relationship</code>: Validates batch insertion of relationships</ol><p>The tests confirm that:<ul><li>All child entities maintain their <code>ChildOf</code> relationship<li>The parent’s <code>Children</code> component contains all children<li>Relationships persist after command execution</ul><h3 id=technical-insights>Technical Insights</h3><p>The original implementation had a fundamental ordering issue: immediate world access during batch operations caused overlapping state mutations. By shifting to Bevy’s command system:<ul><li>All relationship updates become atomic operations<li>The system naturally handles multiple updates to the same component<li>Batch efficiency is preserved since commands execute together<li>The solution avoids expensive per-entity flushes</ul><p>The <code>entry()</code> API was particularly valuable here as it provides atomic “upsert” semantics, handling both the modification and insertion cases through a unified interface.<h3 id=impact>Impact</h3><p>This fix:<ol><li>Corrects relationship management in batch operations<li>Maintains Bevy’s batch spawning performance<li>Prevents accidental relationship removal<li>Adds test coverage for batch relationship scenarios</ol><p>The changes are localized to the relationship hook, minimizing risk to other systems. The solution demonstrates how Bevy’s command system can resolve ordering issues in batch operations.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Batch Spawn Starts] --> B[Entity 1: Schedule Relationship]
</span><span>    A --> C[Entity 2: Schedule Relationship]
</span><span>    A --> D[...]
</span><span>    A --> E[Entity N: Schedule Relationship]
</span><span>    B --> F[Command Buffer]
</span><span>    C --> F
</span><span>    D --> F
</span><span>    E --> F
</span><span>    F --> G[Flush Commands]
</span><span>    G --> H[Atomic Update of RelationshipTarget]
</span><span>    H --> I[All Relationships Established]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ecs-src-relationship-mod-rs><code>crates/bevy_ecs/src/relationship/mod.rs</code></h3><ol><li><strong>Relationship Hook Modification</strong><br> Changed the relationship hook implementation to use deferred command operations</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(</span><span style=color:#fa6e32>mut</span><span> target_entity_mut) </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_entity_mut</span><span>(target_entity) {
</span><span>    </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#fa6e32>mut</span><span> relationship_target) </span><span style=color:#ed9366>=
</span><span>        target_entity_mut</span><span style=color:#ed9366>.</span><span>get_mut</span><span style=color:#ed9366>::</span><span><</span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>RelationshipTarget>()
</span><span>    {
</span><span>        relationship_target</span><span style=color:#ed9366>.</span><span style=color:#f07171>collection_mut_risky</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(entity)</span><span style=color:#61676ccc>;
</span><span>    } </span><span style=color:#fa6e32>else </span><span>{
</span><span>        </span><span style=color:#fa6e32>let mut</span><span> target </span><span style=color:#ed9366>= </span><span><</span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>RelationshipTarget </span><span style=color:#ed9366>as</span><span> RelationshipTarget></span><span style=color:#ed9366>::</span><span>with_capacity(</span><span style=color:#ff8f40>1</span><span>)</span><span style=color:#61676ccc>;
</span><span>        target</span><span style=color:#ed9366>.</span><span style=color:#f07171>collection_mut_risky</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(entity)</span><span style=color:#61676ccc>;
</span><span>        world</span><span style=color:#ed9366>.</span><span style=color:#f07171>commands</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(target_entity)</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(target)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(</span><span style=color:#fa6e32>mut</span><span> entity_commands) </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>commands</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_entity</span><span>(target_entity) {
</span><span>    entity_commands
</span><span>        </span><span style=color:#ed9366>.</span><span>entry</span><span style=color:#ed9366>::</span><span><</span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>RelationshipTarget>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>and_modify</span><span>(</span><span style=color:#fa6e32>move </span><span style=color:#ed9366>|</span><span style=color:#fa6e32>mut</span><span> relationship_target</span><span style=color:#ed9366>| </span><span>{
</span><span>            relationship_target</span><span style=color:#ed9366>.</span><span style=color:#f07171>collection_mut_risky</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(entity)</span><span style=color:#61676ccc>;
</span><span>        })
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>or_insert_with</span><span>(|| {
</span><span>            </span><span style=color:#fa6e32>let mut</span><span> target </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>RelationshipTarget</span><span style=color:#ed9366>::</span><span>with_capacity(</span><span style=color:#ff8f40>1</span><span>)</span><span style=color:#61676ccc>;
</span><span>            target</span><span style=color:#ed9366>.</span><span style=color:#f07171>collection_mut_risky</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(entity)</span><span style=color:#61676ccc>;
</span><span>            target
</span><span>        })</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><ol start=2><li><strong>Test Cases Added</strong><br> Added validation for batch relationship operations</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>spawn_batch_with_relationship</span><span>() {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> world </span><span style=color:#ed9366>= </span><span>World</span><span style=color:#ed9366>::</span><span>new()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> parent </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn_empty</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>id</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> children </span><span style=color:#ed9366>=</span><span> world
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn_batch</span><span>((</span><span style=color:#ff8f40>0</span><span style=color:#ed9366>..</span><span style=color:#ff8f40>10</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|_| ChildOf(parent)))
</span><span>        </span><span style=color:#ed9366>.</span><span>collect</span><span style=color:#ed9366>::</span><span><</span><span style=color:#55b4d4;font-style:italic>Vec</span><span><</span><span style=color:#ed9366>_</span><span>>>()</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#fa6e32>for </span><span style=color:#ed9366>&</span><span>child </span><span style=color:#ed9366>in &</span><span>children {
</span><span>        </span><span style=color:#f07171>assert!</span><span>(world
</span><span>            </span><span style=color:#ed9366>.</span><span>get</span><span style=color:#ed9366>::</span><span>&LTChildOf>(child)
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>is_some_and</span><span>(|</span><span style=color:#ff8f40>child_of</span><span>| child_of</span><span style=color:#ed9366>.</span><span style=color:#f07171>parent</span><span>() </span><span style=color:#ed9366>==</span><span> parent))</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>    </span><span style=color:#f07171>assert!</span><span>(world
</span><span>        </span><span style=color:#ed9366>.</span><span>get</span><span style=color:#ed9366>::</span><span>&LTChildren>(parent)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>is_some_and</span><span>(|</span><span style=color:#ff8f40>children</span><span>| children</span><span style=color:#ed9366>.</span><span style=color:#f07171>len</span><span>() </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>10</span><span>))</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>insert_batch_with_relationship</span><span>() {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> world </span><span style=color:#ed9366>= </span><span>World</span><span style=color:#ed9366>::</span><span>new()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> parent </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn_empty</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>id</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> child </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn_empty</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>id</span><span>()</span><span style=color:#61676ccc>;
</span><span>    world</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_batch</span><span>([(child</span><span style=color:#61676ccc>,</span><span> ChildOf(parent))])</span><span style=color:#61676ccc>;
</span><span>    world</span><span style=color:#ed9366>.</span><span style=color:#f07171>flush</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#f07171>assert!</span><span>(world</span><span style=color:#ed9366>.</span><span>get</span><span style=color:#ed9366>::</span><span>&LTChildOf>(child)</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_some</span><span>())</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#f07171>assert!</span><span>(world</span><span style=color:#ed9366>.</span><span>get</span><span style=color:#ed9366>::</span><span>&LTChildren>(parent)</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_some</span><span>())</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/ecs/relationships/ target=_blank>Bevy ECS Relationships Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/ecs/commands/ target=_blank>Command System in Bevy</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_ecs/latest/bevy_ecs/system/struct.EntityCommands.html target=_blank>Entity Commands API Reference</a><li><a rel="noopener nofollow noreferrer" href=https://www.gamedeveloper.com/programming/entity-component-system-architectures target=_blank>Batch Processing Patterns in ECS</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-06/pr_19519.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>