<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19779 Improve module structure of observers code
        
    </title><meta content="#19779 Improve module structure of observers code" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-06/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-06-22</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2025-06/pr-19779-en-20250622>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=improve-module-structure-of-observers-code>Improve module structure of observers code</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Improve module structure of observers code<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19779<li><strong>Author</strong>: alice-i-cecile<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-ECS, C-Code-Quality, S-Ready-For-Final-Review, X-Uncontroversial, D-Straightforward<li><strong>Created</strong>: 2025-06-22T20:48:59Z<li><strong>Merged</strong>: 2025-06-22T23:43:54Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h3 id=mu-biao>目标</h3><p>在开发 #17607 时，我发现观察者代码的各个模块之间关系混乱，令人困惑和沮丧。<p>与其在大型重构PR中解决这个问题，我决定先进行一个独立的重构（虽然繁琐但必要），将琐碎但嘈杂的代码整理工作分离出来。<p>观察者代码有大量移动部件，特别是在存储方面，这些代码随意散布在模块中，没有明显顺序。更糟糕的是，几乎所有代码都被堆放在根目录下一个几千行的 mod.rs 文件中。<h3 id=jie-jue-fang-an>解决方案</h3><p>我重新组织了模块结构，目标是：<ul><li>减小 mod.rs 文件的大小<li>按包含关系组织结构体（较大的结构体在前）<li>将相关功能分组<li>添加模块文档说明其存在理由和组织结构</ul><p>本次重构没有功能变更，但为了保持编译通过，我不得不将一些字段的可见性从私有提升为 pub(crate) 或 pub(super)。<p>重构中采用了私有模块+公开重新导出的策略，避免对 bevy 内部和外部造成破坏。我认为我们可以做得更好，但打算留到后续清理阶段完成，避免在开发周期中引入多次破坏性变更。<h3 id=ce-shi>测试</h3><p>没有功能变更，依赖现有测试套件和Rust编译器。<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=wen-ti-he-bei-jing>问题和背景</h3><p>在开发 #17607 功能时，作者发现观察者模块的代码组织存在问题。主要问题集中在 <code>crates/bevy_ecs/src/observer/mod.rs</code> 文件，这个文件包含了几乎所有观察者相关的代码，体积超过数千行。这种结构导致：<ol><li>相关功能分散在文件中，缺乏逻辑分组<li>小结构体定义在大结构体之前，违反直觉的阅读顺序<li>存储相关的代码与其他逻辑混杂，难以定位<li>缺乏模块级别的文档说明</ol><p>这些问题增加了理解和修改代码的难度，尤其在进行 #17607 的功能开发时成为障碍。考虑到观察者系统是ECS的核心部分，良好的代码结构对长期维护至关重要。<h3 id=jie-jue-fang-an-fang-fa>解决方案方法</h3><p>作者决定采用模块化重构策略：<ol><li>按功能拆分巨型 mod.rs 文件<li>创建专门的子模块存放相关功能<li>调整结构体位置，使大结构体出现在小结构体之前<li>添加模块级文档说明职责<li>保持公有API不变，仅调整内部结构</ol><p>重构采用增量方式，通过创建新模块并迁移代码，避免一次性大规模改动。对于必要的可见性调整，使用 pub(crate)/pub(super) 最小化暴露范围，保持封装性。<h3 id=shi-xian-xi-jie>实现细节</h3><p>重构创建了5个新模块，迁移了相关代码：<ol><li><p><strong>centralized_storage.rs</strong><br> 集中存放 <code>Observers</code> 和 <code>CachedObservers</code> 结构体，负责观察者的集中存储和查询逻辑。关键结构：</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 集中存储所有观察者
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>Observers </span><span>{
</span><span>    add</span><span style=color:#61676ccc>:</span><span> CachedObservers,
</span><span>    insert</span><span style=color:#61676ccc>:</span><span> CachedObservers,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...其他生命周期事件缓存
</span><span>    cache</span><span style=color:#61676ccc>: </span><span>HashMap&LTComponentId, CachedObservers>
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 按事件类型分组的观察者集合
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>CachedObservers </span><span>{
</span><span>    global_observers</span><span style=color:#61676ccc>:</span><span> ObserverMap,
</span><span>    component_observers</span><span style=color:#61676ccc>: </span><span>HashMap&LTComponentId, CachedComponentObservers>,
</span><span>    entity_observers</span><span style=color:#61676ccc>: </span><span>EntityHashMap&LTObserverMap>
</span><span>}
</span></code></pre><li><p><strong>distributed_storage.rs</strong><br> 存放 <code>Observer</code> 组件和 <code>ObservedBy</code> 组件，处理观察者的实体关联逻辑：</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 观察者组件定义
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>Observer </span><span>{
</span><span>    system</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Box</span><span>&LTdyn AnyNamedSystem>,
</span><span>    descriptor</span><span style=color:#61676ccc>:</span><span> ObserverDescriptor,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...其他字段
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 实体观察关系组件
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>ObservedBy</span><span>(</span><span style=color:#55b4d4;font-style:italic>Vec</span><span>&LTEntity>)</span><span style=color:#61676ccc>;
</span></code></pre><li><p><strong>system_param.rs</strong><br> 包含观察者系统参数实现，如 <code>On</code> 触发器和 <code>ObserverTrigger</code>：</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 观察者系统参数
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>On</span><span><</span><span style=color:#fa6e32>'w</span><span>, E, B</span><span style=color:#61676ccc>:</span><span> Bundle = ()> {
</span><span>    event</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'w mut</span><span> E,
</span><span>    propagate</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'w mut bool</span><span>,
</span><span>    trigger</span><span style=color:#61676ccc>:</span><span> ObserverTrigger
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 触发器元数据
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>ObserverTrigger </span><span>{
</span><span>    observer</span><span style=color:#61676ccc>:</span><span> Entity,
</span><span>    event_type</span><span style=color:#61676ccc>:</span><span> ComponentId,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...其他字段
</span><span>}
</span></code></pre><li><p><strong>trigger_targets.rs</strong><br> 实现 <code>TriggerTargets</code> trait，定义事件触发目标：</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub trait </span><span style=color:#399ee6>TriggerTargets </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>components</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-></span><span> impl </span><span style=color:#55b4d4;font-style:italic>Iterator</span><span>&LTItem = ComponentId></span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>entities</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-></span><span> impl </span><span style=color:#55b4d4;font-style:italic>Iterator</span><span>&LTItem = Entity></span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><li><p><strong>runner.rs</strong><br> 保留观察者运行逻辑：</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub type </span><span style=color:#399ee6>ObserverRunner </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>fn</span><span>(DeferredWorld</span><span style=color:#61676ccc>,</span><span> ObserverTrigger</span><span style=color:#61676ccc>,</span><span> PtrMut</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut bool</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre></ol><h3 id=ji-shu-jian-jie>技术见解</h3><ol><li><strong>模块边界</strong>：按“集中存储“ vs “分布式存储“划分是合理的架构决策<li><strong>可见性控制</strong>：使用 pub(super) 限制跨模块访问，如：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>super</span><span>) </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>CachedComponentObservers </span><span>{
</span><span>    global_observers</span><span style=color:#61676ccc>:</span><span> ObserverMap,
</span><span>    entity_component_observers</span><span style=color:#61676ccc>: </span><span>EntityHashMap&LTObserverMap>
</span><span>}
</span></code></pre><li><strong>不变性保证</strong>：所有公有API签名保持不变，确保外部兼容性<li><strong>生命周期管理</strong>：<code>Observer</code> 和 <code>ObservedBy</code> 的关联关系保留在 distributed_storage 模块</ol><h3 id=ying-xiang>影响</h3><ol><li><strong>可维护性提升</strong>： <ul><li>mod.rs 从597行缩减到9行<li>平均模块大小降至200行左右</ul><li><strong>导航优化</strong>： <ul><li>相关功能聚集在相同模块<li>消除跨文件跳转的认知负担</ul><li><strong>可读性改进</strong>： <ul><li>添加模块头文档说明职责<li>大结构体在小结构体之前定义</ul><li><strong>后续开发基础</strong>：为 #17607 功能开发扫清结构障碍</ol><h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[observer/mod.rs] --> B[centralized_storage.rs]
</span><span>    A --> C[distributed_storage.rs]
</span><span>    A --> D[system_param.rs]
</span><span>    A --> E[trigger_targets.rs]
</span><span>    A --> F[runner.rs]
</span><span>    C --> G[Observer组件]
</span><span>    C --> H[ObservedBy组件]
</span><span>    B --> I[Observers结构]
</span><span>    B --> J[CachedObservers结构]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ecs-src-observer-mod-rs>crates/bevy_ecs/src/observer/mod.rs</h3><p><strong>变更原因</strong>：<br> 将巨型文件拆分为多个子模块，仅保留模块导出和顶级功能。<p><strong>关键修改</strong>：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: 包含所有观察者实现（597行）
</span><span style=color:#abb0b6;font-style:italic>// ...数千行混合代码...
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: 精简为模块导出（9行）
</span><span style=color:#fa6e32>mod </span><span style=color:#399ee6>centralized_storage</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>mod </span><span style=color:#399ee6>distributed_storage</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>mod </span><span style=color:#399ee6>entity_cloning</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>mod </span><span style=color:#399ee6>runner</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>mod </span><span style=color:#399ee6>system_param</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>mod </span><span style=color:#399ee6>trigger_targets</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>pub use </span><span>centralized_storage</span><span style=color:#ed9366>::*</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>pub use </span><span>distributed_storage</span><span style=color:#ed9366>::*</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// ...其他导出...
</span></code></pre><h3 id=crates-bevy-ecs-src-observer-centralized-storage-rs>crates/bevy_ecs/src/observer/centralized_storage.rs</h3><p><strong>变更原因</strong>：<br> 集中存放观察者存储和查询逻辑。<p><strong>新增代码</strong>：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>Observers </span><span>{
</span><span>    add</span><span style=color:#61676ccc>:</span><span> CachedObservers,
</span><span>    insert</span><span style=color:#61676ccc>:</span><span> CachedObservers,
</span><span>    replace</span><span style=color:#61676ccc>:</span><span> CachedObservers,
</span><span>    remove</span><span style=color:#61676ccc>:</span><span> CachedObservers,
</span><span>    despawn</span><span style=color:#61676ccc>:</span><span> CachedObservers,
</span><span>    cache</span><span style=color:#61676ccc>: </span><span>HashMap&LTComponentId, CachedObservers>
</span><span>}
</span><span>
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>CachedObservers </span><span>{
</span><span>    global_observers</span><span style=color:#61676ccc>:</span><span> ObserverMap,
</span><span>    component_observers</span><span style=color:#61676ccc>: </span><span>HashMap&LTComponentId, CachedComponentObservers>,
</span><span>    entity_observers</span><span style=color:#61676ccc>: </span><span>EntityHashMap&LTObserverMap>
</span><span>}
</span></code></pre><h3 id=crates-bevy-ecs-src-observer-distributed-storage-rs>crates/bevy_ecs/src/observer/distributed_storage.rs</h3><p><strong>变更原因</strong>：<br> 存放与实体关联的观察者组件。<p><strong>新增代码</strong>：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>Observer </span><span>{
</span><span>    system</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Box</span><span>&LTdyn AnyNamedSystem>,
</span><span>    descriptor</span><span style=color:#61676ccc>:</span><span> ObserverDescriptor,
</span><span>    last_trigger_id</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u32</span><span>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...其他字段...
</span><span>}
</span><span>
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>ObservedBy</span><span>(</span><span style=color:#55b4d4;font-style:italic>Vec</span><span>&LTEntity>)</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-ecs-src-observer-system-param-rs>crates/bevy_ecs/src/observer/system_param.rs</h3><p><strong>变更原因</strong>：<br> 分离系统参数实现。<p><strong>新增代码</strong>：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>On</span><span><</span><span style=color:#fa6e32>'w</span><span>, E, B</span><span style=color:#61676ccc>:</span><span> Bundle = ()> {
</span><span>    event</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'w mut</span><span> E,
</span><span>    propagate</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'w mut bool</span><span>,
</span><span>    trigger</span><span style=color:#61676ccc>:</span><span> ObserverTrigger
</span><span>}
</span><span>
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>ObserverTrigger </span><span>{
</span><span>    observer</span><span style=color:#61676ccc>:</span><span> Entity,
</span><span>    event_type</span><span style=color:#61676ccc>:</span><span> ComponentId,
</span><span>    components</span><span style=color:#61676ccc>: </span><span>SmallVec<[ComponentId</span><span style=color:#61676ccc>; </span><span style=color:#ff8f40>2</span><span>]>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...其他字段...
</span><span>}
</span></code></pre><h3 id=crates-bevy-ecs-src-observer-trigger-targets-rs>crates/bevy_ecs/src/observer/trigger_targets.rs</h3><p><strong>变更原因</strong>：<br> 独立存放触发目标trait。<p><strong>新增代码</strong>：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub trait </span><span style=color:#399ee6>TriggerTargets </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>components</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-></span><span> impl </span><span style=color:#55b4d4;font-style:italic>Iterator</span><span>&LTItem = ComponentId> </span><span style=color:#ed9366>+ </span><span style=color:#55b4d4;font-style:italic>Clone </span><span style=color:#ed9366>+ '_</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>entities</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-></span><span> impl </span><span style=color:#55b4d4;font-style:italic>Iterator</span><span>&LTItem = Entity> </span><span style=color:#ed9366>+ </span><span style=color:#55b4d4;font-style:italic>Clone </span><span style=color:#ed9366>+ '_</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/book/ch07-02-defining-modules-to-control-scope-and-privacy.html target=_blank>模块系统官方文档</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/rust-unofficial/patterns/blob/master/patterns/visibility-for-privacy.md target=_blank>Rust可见性最佳实践</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/SanderMertens/ecs-faq target=_blank>ECS架构模式</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-06/pr_19779.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>