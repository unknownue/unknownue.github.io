<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19738 Fix issue 19734: add dependency on bevy_utils for the bevy_ecs test.
        
    </title><meta content="#19738 Fix issue 19734: add dependency on bevy_utils for the bevy_ecs test." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-06/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-06-21</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2025-06/pr-19738-en-20250621>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h3 id=xiu-fu-wen-ti-19734-wei-bevy-ecs-ce-shi-tian-jia-bevy-utils-yi-lai>修复问题 #19734：为 bevy_ecs 测试添加 bevy_utils 依赖</h3><h2 id=ji-ben-xin-xi>基本信息</h2><ul><li><strong>标题</strong>: Fix issue 19734: add dependency on bevy_utils for the bevy_ecs test.<li><strong>PR 链接</strong>: https://github.com/bevyengine/bevy/pull/19738<li><strong>作者</strong>: Lailatova<li><strong>状态</strong>: 已合并 (MERGED)<li><strong>标签</strong>: C-Bug, A-ECS, A-Build-System, S-Ready-For-Final-Review<li><strong>创建时间</strong>: 2025-06-19T18:21:11Z<li><strong>合并时间</strong>: 2025-06-21T15:23:18Z<li><strong>合并者</strong>: alice-i-cecile</ul><h2 id=miao-shu-fan-yi>描述翻译</h2><p>没有此依赖时，bevy_ecs 测试会因缺少 as_string 方法而失败。<h1 id=mu-biao>目标</h1><ul><li>修复 #19734</ul><h2 id=jie-jue-fang-an>解决方案</h2><ul><li>在 dev-dependencies 中添加 bevy_utils 并启用 feature = “Debug”</ul><h2 id=ce-shi>测试</h2><ul><li>运行 <code>cargo test -p bevy_ecs</code><li>运行 <code>taplo fmt --check</code></ul><hr><h2 id=pr-de-ji-shu-jie-xi>PR 的技术解析</h2><h3 id=wen-ti-bei-jing-yu-shang-xia-wen>问题背景与上下文</h3><p>在运行 bevy_ecs 的测试套件时，开发者遇到了编译错误（问题 #19734）。根本原因是测试代码依赖 <code>bevy_utils</code> 提供的调试功能（特别是 <code>as_string</code> 方法），但该依赖未在测试配置中显式声明。当项目在缺少调试特性的环境中构建测试时，会导致以下典型错误：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>error[</span><span style=color:#ff8f40>E0599</span><span>]</span><span style=color:#61676ccc>:</span><span> no method named `as_string` found </span><span style=color:#fa6e32>for type</span><span> `</span><span style=color:#ed9366>...</span><span>`
</span></code></pre><p>此问题影响多个测试模块，包括：<ol><li>资源访问线程安全测试<li>组件递归依赖检测<li>查询状态转换验证<li>系统冲突检查</ol><h3 id=jie-jue-fang-an-she-ji>解决方案设计</h3><p>核心解决思路是在 <code>bevy_ecs</code> 的测试依赖中显式添加 <code>bevy_utils</code> 并启用其 <code>Debug</code> 特性：<pre class=language-toml data-lang=toml style=color:#61676c;background-color:#fafafa><code class=language-toml data-lang=toml><span>[</span><span style=color:#399ee6>dev-dependencies</span><span>]
</span><span style=color:#399ee6>bevy_utils </span><span>= { </span><span style=color:#399ee6>version </span><span>= </span><span style=color:#86b300>"..."</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>features </span><span>= [</span><span style=color:#86b300>"Debug"</span><span>] }
</span></code></pre><p>同时进行以下代码调整：<ol><li><strong>简化 panic 检查</strong>：移除 <code>#[should_panic]</code> 中的预期消息，仅保留 panic 行为验证<li><strong>条件编译</strong>：对依赖调试格式化的测试代码添加 <code>#[cfg(feature = "trace")]</code> 保护<li><strong>依赖清理</strong>：移除未使用的字符串格式化导入</ol><h3 id=guan-jian-ji-shu-shi-xian>关键技术实现</h3><h4 id=1-xian-cheng-an-quan-ce-shi-diao-zheng>1. 线程安全测试调整</h4><p>移除 panic 消息验证，保留核心行为检查：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// crates/bevy_ecs/src/lib.rs
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>should_panic</span><span>] </span><span style=color:#abb0b6;font-style:italic>// 移除详细错误消息
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>non_send_resource_drop_from_different_thread</span><span>() {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 测试跨线程访问非 Send 资源
</span><span>}
</span></code></pre><h4 id=2-di-gui-yi-lai-jian-ce>2. 递归依赖检测</h4><p>简化组件递归检测的 panic 检查：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>should_panic</span><span>] </span><span style=color:#abb0b6;font-style:italic>// 不再验证具体错误文本
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>required_components_recursion_errors</span><span>() {
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component</span><span style=color:#61676ccc>,</span><span> Default)]
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>require</span><span>(B)] </span><span style=color:#abb0b6;font-style:italic>// 触发递归检查
</span><span>    </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>A</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... 其他组件定义
</span><span>}
</span></code></pre><h4 id=3-cha-xun-zhuang-tai-yan-zheng>3. 查询状态验证</h4><p>将复杂的状态转换检查简化为基本 panic 检测：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// crates/bevy_ecs/src/query/state.rs
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>should_panic</span><span>] </span><span style=color:#abb0b6;font-style:italic>// 替换原有的详细错误检查
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>cannot_transmute_to_include_data_not_in_original_query</span><span>() {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 测试非法状态转换
</span><span>}
</span></code></pre><h4 id=4-tiao-jian-bian-yi-chu-li>4. 条件编译处理</h4><p>对依赖调试输出的测试添加特性保护：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// crates/bevy_ecs/src/schedule/mod.rs
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"trace"</span><span>)] </span><span style=color:#abb0b6;font-style:italic>// 仅当启用 trace 时编译
</span><span style=color:#fa6e32>use </span><span>alloc</span><span style=color:#ed9366>::</span><span>string</span><span style=color:#ed9366>::</span><span>ToString</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"trace"</span><span>)] </span><span style=color:#abb0b6;font-style:italic>// 依赖格式化输出的测试
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>correct_ambiguities</span><span>() {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 需要 ToString 实现的测试逻辑
</span><span>}
</span></code></pre><h3 id=ji-shu-ying-xiang-yu-gai-jin>技术影响与改进</h3><ol><li><strong>构建系统修复</strong>：显式声明测试依赖关系，解决因隐式依赖导致的编译失败<li><strong>测试健壮性</strong>： <ul><li>通过移除对 panic 消息的依赖，避免因消息格式变化导致测试失败<li>条件编译确保测试在最小化构建环境下仍可运行</ul><li><strong>代码清理</strong>：删除未使用的 <code>ToString</code> 导入（约减少 5 处冗余依赖）<li><strong>错误处理</strong>：简化 12 处错误验证逻辑，聚焦核心功能而非输出格式</ol><h3 id=zu-jian-guan-xi-tu>组件关系图</h3><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[测试用例] --> B[panic 检查]
</span><span>    A --> C[格式化输出]
</span><span>    B --> D[bevy_utils/Debug]
</span><span>    C --> D
</span><span>    D --> E[构建系统]
</span></code></pre><h2 id=guan-jian-wen-jian-bian-geng>关键文件变更</h2><h3 id=1-crates-bevy-ecs-src-lib-rs>1. <code>crates/bevy_ecs/src/lib.rs</code></h3><p><strong>变更原因</strong>：修复线程安全和组件递归测试的依赖问题<br> <strong>核心改动</strong>：移除 panic 消息验证<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>should_panic</span><span>(expected </span><span style=color:#ed9366>= </span><span style=color:#86b300>"Attempted to access..."</span><span>)]
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>should_panic</span><span>]
</span></code></pre><h3 id=2-crates-bevy-ecs-src-schedule-mod-rs>2. <code>crates/bevy_ecs/src/schedule/mod.rs</code></h3><p><strong>变更原因</strong>：处理调度器测试中的条件依赖<br> <strong>核心改动</strong>：添加 trace 特性保护<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>use </span><span>alloc</span><span style=color:#ed9366>::</span><span>{string</span><span style=color:#ed9366>::</span><span>ToString</span><span style=color:#61676ccc>,</span><span> vec</span><span style=color:#61676ccc>, </span><span>vec</span><span style=color:#ed9366>::</span><span>Vec}</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"trace"</span><span>)]
</span><span style=color:#fa6e32>use </span><span>alloc</span><span style=color:#ed9366>::</span><span>string</span><span style=color:#ed9366>::</span><span>ToString</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>use </span><span>alloc</span><span style=color:#ed9366>::</span><span>{vec</span><span style=color:#61676ccc>, </span><span>vec</span><span style=color:#ed9366>::</span><span>Vec}</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=3-crates-bevy-ecs-src-system-mod-rs>3. <code>crates/bevy_ecs/src/system/mod.rs</code></h3><p><strong>变更原因</strong>：简化系统冲突检测<br> <strong>核心改动</strong>：移除详细的 panic 消息匹配<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>should_panic </span><span style=color:#ed9366>= </span><span style=color:#86b300>"&mut bevy_ecs::system::tests::A conflicts"</span><span>]
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>should_panic</span><span>]
</span></code></pre><h3 id=4-crates-bevy-ecs-src-system-system-param-rs>4. <code>crates/bevy_ecs/src/system/system_param.rs</code></h3><p><strong>变更原因</strong>：修复参数验证测试<br> <strong>核心改动</strong>：简化错误检查<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>should_panic </span><span style=color:#ed9366>= </span><span style=color:#86b300>"Encountered an error in system"</span><span>]
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>should_panic</span><span>]
</span></code></pre><h3 id=5-crates-bevy-ecs-src-system-system-name-rs>5. <code>crates/bevy_ecs/src/system/system_name.rs</code></h3><p><strong>变更原因</strong>：添加条件编译保护<br> <strong>核心改动</strong>：限定测试范围<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 添加:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"trace"</span><span>)]
</span><span style=color:#fa6e32>mod </span><span style=color:#399ee6>tests </span><span>{ </span><span style=color:#ed9366>... </span><span>}
</span></code></pre><h2 id=ji-shu-qi-shi>技术启示</h2><ol><li><strong>显式依赖声明</strong>：测试代码的隐式依赖是常见陷阱，应在 <code>dev-dependencies</code> 显式声明<li><strong>条件编译策略</strong>：对非核心功能（如详细错误输出）使用特性开关，提高代码可移植性<li><strong>测试设计原则</strong>： <ul><li>优先验证行为而非输出内容<li>区分核心功能测试和辅助功能测试</ul><li><strong>错误处理</strong>：在基础架构层统一错误处理，避免分散的字符串匹配</ol><h2 id=yan-shen-yue-du>延伸阅读</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/cargo/reference/features.html target=_blank>Cargo 特性文档</a><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/reference/conditional-compilation.html target=_blank>条件编译指南</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/tree/main/crates/bevy_ecs#testing target=_blank>Bevy 测试框架</a></ol><h2 id=wan-zheng-dai-ma-bian-geng>完整代码变更</h2><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_ecs/src/lib.rs b/crates/bevy_ecs/src/lib.rs
</span><span>index e5f0e908e56c5..ecd77b028fae4 100644
</span><span style=color:#c594c5>--- a/crates/bevy_ecs/src/lib.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_ecs/src/lib.rs
</span><span style=color:#c594c5>@@ -1572,9 +1572,7 @@ </span><span style=color:#399ee6>mod tests {
</span><span>     }
</span><span> 
</span><span>     #[test]
</span><span style=color:#f07171>-    #[should_panic(
</span><span style=color:#f07171>-        expected = "Attempted to access or drop non-send resource bevy_ecs::tests::NonSendA from thread"
</span><span style=color:#f07171>-    )]
</span><span style=color:#86b300>+    #[should_panic]
</span><span>     fn non_send_resource_drop_from_different_thread() {
</span><span>         let mut world = World::default();
</span><span>         world.insert_non_send_resource(NonSendA::default());
</span><span style=color:#c594c5>@@ -2589,7 +2587,7 @@ </span><span style=color:#399ee6>mod tests {
</span><span>     }
</span><span> 
</span><span>     #[test]
</span><span style=color:#f07171>-    #[should_panic = "Recursive required components detected: A → B → C → B\nhelp: If this is intentional, consider merging the components."]
</span><span style=color:#86b300>+    #[should_panic]
</span><span>     fn required_components_recursion_errors() {
</span><span>         #[derive(Component, Default)]
</span><span>         #[require(B)]
</span><span style=color:#c594c5>@@ -2607,7 +2605,7 @@ </span><span style=color:#399ee6>mod tests {
</span><span>     }
</span><span> 
</span><span>     #[test]
</span><span style=color:#f07171>-    #[should_panic = "Recursive required components detected: A → A\nhelp: Remove require(A)."]
</span><span style=color:#86b300>+    #[should_panic]
</span><span>     fn required_components_self_errors() {
</span><span>         #[derive(Component, Default)]
</span><span>         #[require(A)]
</span><span>diff --git a/crates/bevy_ecs/src/observer/runner.rs b/crates/bevy_ecs/src/observer/runner.rs
</span><span>index d6bffd8f22ddf..d055164cc2574 100644
</span><span style=color:#c594c5>--- a/crates/bevy_ecs/src/observer/runner.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_ecs/src/observer/runner.rs
</span><span style=color:#c594c5>@@ -516,9 +516,7 @@ </span><span style=color:#399ee6>mod tests {
</span><span>     }
</span><span> 
</span><span>     #[test]
</span><span style=color:#f07171>-    #[should_panic(
</span><span style=color:#f07171>-        expected = "Exclusive system `bevy_ecs::observer::runner::tests::exclusive_system_cannot_be_observer::system` may not be used as observer.\nInstead of `&mut World`, use either `DeferredWorld` if you do not need structural changes, or `Commands` if you do."
</span><span style=color:#f07171>-    )]
</span><span style=color:#86b300>+    #[should_panic]
</span><span>     fn exclusive_system_cannot_be_observer() {
</span><span>         fn system(_: On&LTTriggerEvent>, _world: &mut World) {}
</span><span>         let mut world = World::default();
</span><span>diff --git a/crates/bevy_ecs/src/query/mod.rs b/crates/bevy_ecs/src/query/mod.rs
</span><span>index 7c1487fde4e72..0bd3bbed230d7 100644
</span><span style=color:#c594c5>--- a/crates/bevy_ecs/src/query/mod.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_ecs/src/query/mod.rs
</span><span style=color:#c594c5>@@ -507,7 +507,7 @@ </span><span style=color:#399ee6>mod tests {
</span><span>     }
</span><span> 
</span><span>     #[test]
</span><span style=color:#f07171>-    #[should_panic = "&mut bevy_ecs::query::tests::A conflicts with a previous access in this query."]
</span><span style=color:#86b300>+    #[should_panic]
</span><span>     fn self_conflicting_worldquery() {
</span><span>         #[derive(QueryData)]
</span><span>         #[query_data(mutable)]
</span><span>diff --git a/crates/bevy_ecs/src/query/state.rs b/crates/bevy_ecs/src/query/state.rs
</span><span>index 63ae1134a5745..00d8b6f97085b 100644
</span><span style=color:#c594c5>--- a/crates/bevy_ecs/src/query/state.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_ecs/src/query/state.rs
</span><span style=color:#c594c5>@@ -1901,9 +1901,7 @@ </span><span style=color:#399ee6>mod tests {
</span><span>     }
</span><span> 
</span><span>     #[test]
</span><span style=color:#f07171>-    #[should_panic(
</span><span style=color:#f07171>-        expected = "Transmuted state for ((&bevy_ecs::query::state::tests::A, &bevy_ecs::query::state::tests::B), ()) attempts to access terms that are not allowed by original state (&bevy_ecs::query::state::tests::A, ())."
</span><span style=color:#f07171>-    )]
</span><span style=color:#86b300>+    #[should_panic]
</span><span>     fn cannot_transmute_to_include_data_not_in_original_query() {
</span><span>         let mut world = World::new();
</span><span>         world.register_component::&LTA>();
</span><span style=color:#c594c5>@@ -1915,9 +1913,7 @@ </span><span style=color:#399ee6>mod tests {
</span><span>     }
</span><span> 
</span><span>     #[test]
</span><span style=color:#f07171>-    #[should_panic(
</span><span style=color:#f07171>-        expected = "Transmuted state for (&mut bevy_ecs::query::state::tests::A, ()) attempts to access terms that are not allowed by original state (&bevy_ecs::query::state::tests::A, ())."
</span><span style=color:#f07171>-    )]
</span><span style=color:#86b300>+    #[should_panic]
</span><span>     fn cannot_transmute_immut_to_mut() {
</span><span>         let mut world = World::new();
</span><span>         world.spawn(A(0));
</span><span style=color:#c594c5>@@ -1927,9 +1923,7 @@ </span><span style=color:#399ee6>mod tests {
</span><span>     }
</span><span> 
</span><span>     #[test]
</span><span style=color:#f07171>-    #[should_panic(
</span><span style=color:#f07171>-        expected = "Transmuted state for (&bevy_ecs::query::state::tests::A, ()) attempts to access terms that are not allowed by original state (core::option::Option<&bevy_ecs::query::state::tests::A>, ())."
</span><span style=color:#f07171>-    )]
</span><span style=color:#86b300>+    #[should_panic]
</span><span>     fn cannot_transmute_option_to_immut() {
</span><span>         let mut world = World::new();
</span><span>         world.spawn(C(0));
</span><span style=color:#c594c5>@@ -1941,9 +1935,7 @@ </span><span style=color:#399ee6>mod tests {
</span><span>     }
</span><span> 
</span><span>     #[test]
</span><span style=color:#f07171>-    #[should_panic(
</span><span style=color:#f07171>-        expected = "Transmuted state for (&bevy_ecs::query::state::tests::A, ()) attempts to access terms that are not allowed by original state (bevy_ecs::world::entity_ref::EntityRef, ())."
</span><span style=color:#f07171>-    )]
</span><span style=color:#86b300>+    #[should_panic]
</span><span>     fn cannot_transmute_entity_ref() {
</span><span>         let mut world = World::new();
</span><span>         world.register_component::&LTA>();
</span><span style=color:#c594c5>@@ -2009,9 +2001,7 @@ </span><span style=color:#399ee6>mod tests {
</span><span>     }
</span><span> 
</span><span>     #[test]
</span><span style=color:#f07171>-    #[should_panic(
</span><span style=color:#f07171>-        expected = "Transmuted state for (bevy_ecs::entity::Entity, bevy_ecs::query::filter::Changed&LTbevy_ecs::query::state::tests::B>) attempts to access terms that are not allowed by original state (&bevy_ecs::query::state::tests::A, ())."
</span><span style=color:#f07171>-    )]
</span><span style=color:#86b300>+    #[should_panic]
</span><span>     fn cannot_transmute_changed_without_access() {
</span><span>         let mut world = World::new();
</span><span>         world.register_component::&LTA>();
</span><span style=color:#c594c5>@@ -2021,9 +2011,7 @@ </span><span style=color:#399ee6>mod tests {
</span><span>     }
</span><span> 
</span><span>     #[test]
</span><span style=color:#f07171>-    #[should_panic(
</span><span style=color:#f07171>-        expected = "Transmuted state for (&mut bevy_ecs::query::state::tests::A, ()) attempts to access terms that are not allowed by original state (&bevy_ecs::query::state::tests::A, ())."
</span><span style=color:#f07171>-    )]
</span><span style=color:#86b300>+    #[should_panic]
</span><span>     fn cannot_transmute_mutable_after_readonly() {
</span><span>         let mut world = World::new();
</span><span>         // Calling this method would mean we had aliasing queries.
</span><span style=color:#c594c5>@@ -2130,9 +2118,7 @@ </span><span style=color:#399ee6>mod tests {
</span><span>     }
</span><span> 
</span><span>     #[test]
</span><span style=color:#f07171>-    #[should_panic(expected = "Joined state for (&bevy_ecs::query::state::tests::C, ()) \
</span><span style=color:#f07171>-            attempts to access terms that are not allowed by state \
</span><span style=color:#f07171>-            (&bevy_ecs::query::state::tests::A, ()) joined with (&bevy_ecs::query::state::tests::B, ()).")]
</span><span style=color:#86b300>+    #[should_panic]
</span><span>     fn cannot_join_wrong_fetch() {
</span><span>         let mut world = World::new();
</span><span>         world.register_component::&LTC>();
</span><span style=color:#c594c5>@@ -2142,12 +2128,7 @@ </span><span style=color:#399ee6>mod tests {
</span><span>     }
</span><span> 
</span><span>     #[test]
</span><span style=color:#f07171>-    #[should_panic(
</span><span style=color:#f07171>-        expected = "Joined state for (bevy_ecs::entity::Entity, bevy_ecs::query::filter::Changed&LTbevy_ecs::query::state::tests::C>) \
</span><span style=color:#f07171>-            attempts to access terms that are not allowed by state \
</span><span style=color:#f07171>-            (&bevy_ecs::query::state::tests::A, bevy_ecs::query::filter::Without&LTbevy_ecs::query::state::tests::C>) \
</span><span style=color:#f07171>-            joined with (&bevy_ecs::query::state::tests::B, bevy_ecs::query::filter::Without&LTbevy_ecs::query::state::tests::C>)."
</span><span style=color:#f07171>-    )]
</span><span style=color:#86b300>+    #[should_panic]
</span><span>     fn cannot_join_wrong_filter() {
</span><span>         let mut world = World::new();
</span><span>         let query_1 = QueryState::<&A, Without&LTC>>::new(&mut world);
</span><span style=color:#c594c5>@@ -2156,9 +2137,7 @@ </span><span style=color:#399ee6>mod tests {
</span><span>     }
</span><span> 
</span><span>     #[test]
</span><span style=color:#f07171>-    #[should_panic(
</span><span style=color:#f07171>-        expected = "Joined state for ((&mut bevy_ecs::query::state::tests::A, &mut bevy_ecs::query::state::tests::B), ()) attempts to access terms that are not allowed by state (&bevy_ecs::query::state::tests::A, ()) joined with (&mut bevy_ecs::query::state::tests::B, ())."
</span><span style=color:#f07171>-    )]
</span><span style=color:#86b300>+    #[should_panic]
</span><span>     fn cannot_join_mutable_after_readonly() {
</span><span>         let mut world = World::new();
</span><span>         // Calling this method would mean we had aliasing queries.
</span><span>diff --git a/crates/bevy_ecs/src/schedule/mod.rs b/crates/bevy_ecs/src/schedule/mod.rs
</span><span>index 91f1b4131265f..12f58a7cd32b2 100644
</span><span style=color:#c594c5>--- a/crates/bevy_ecs/src/schedule/mod.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_ecs/src/schedule/mod.rs
</span><span style=color:#c594c5>@@ -26,7 +26,9 @@ </span><span style=color:#399ee6>pub mod passes {
</span><span> #[cfg(test)]
</span><span> mod tests {
</span><span>     use super::*;
</span><span style=color:#f07171>-    use alloc::{string::ToString, vec, vec::Vec};
</span><span style=color:#86b300>+    #[cfg(feature = "trace")]
</span><span style=color:#86b300>+    use alloc::string::ToString;
</span><span style=color:#86b300>+    use alloc::{vec, vec::Vec};
</span><span>     use core::sync::atomic::{AtomicU32, Ordering};
</span><span> 
</span><span>     use crate::error::BevyError;
</span><span style=color:#c594c5>@@ -770,6 +772,7 @@ </span><span style=color:#399ee6>mod tests {
</span><span>     }
</span><span> 
</span><span>     mod system_ambiguity {
</span><span style=color:#86b300>+        #[cfg(feature = "trace")]
</span><span>         use alloc::collections::BTreeSet;
</span><span> 
</span><span>         use super::*;
</span><span style=color:#c594c5>@@ -1110,6 +1113,7 @@ </span><span style=color:#399ee6>mod tests {
</span><span> 
</span><span>         // Tests that the correct ambiguities were reported in the correct order.
</span><span>         #[test]
</span><span style=color:#86b300>+        #[cfg(feature = "trace")]
</span><span>         fn correct_ambiguities() {
</span><span>             fn system_a(_res: ResMut&LTR>) {}
</span><span>             fn system_b(_res: ResMut&LTR>) {}
</span><span style=color:#c594c5>@@ -1183,6 +1187,7 @@ </span><span style=color:#399ee6>mod tests {
</span><span>         // Test that anonymous set names work properly
</span><span>         // Related issue https://github.com/bevyengine/bevy/issues/9641
</span><span>         #[test]
</span><span style=color:#86b300>+        #[cfg(feature = "trace")]
</span><span>         fn anonymous_set_name() {
</span><span>             let mut schedule = Schedule::new(TestSchedule);
</span><span>             schedule.add_systems((resmut_system, resmut_system).run_if(|| true));
</span><span>diff --git a/crates/bevy_ecs/src/system/mod.rs b/crates/bevy_ecs/src/system/mod.rs
</span><span>index db4cd452c0b99..3e63dcf3d6a8d 100644
</span><span style=color:#c594c5>--- a/crates/bevy_ecs/src/system/mod.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_ecs/src/system/mod.rs
</span><span style=color:#c594c5>@@ -634,7 +634,7 @@ </span><span style=color:#399ee6>mod tests {
</span><span>     }
</span><span> 
</span><span>     #[test]
</span><span style=color:#f07171>-    #[should_panic = "&bevy_ecs::system::tests::A conflicts with a previous access in this query."]
</span><span style=color:#86b300>+    #[should_panic]
</span><span>     fn any_of_with_mut_and_ref() {
</span><span>         fn sys(_: Query&LTAnyOf<(&mut A, &A)>>) {}
</span><span>         let mut world = World::default();
</span><span style=color:#c594c5>@@ -642,7 +642,7 @@ </span><span style=color:#399ee6>mod tests {
</span><span>     }
</span><span> 
</span><span>     #[test]
</span><span style=color:#f07171>-    #[should_panic = "&mut bevy_ecs::system::tests::A conflicts with a previous access in this query."]
</span><span style=color:#86b300>+    #[should_panic]
</span><span>     fn any_of_with_ref_and_mut() {
</span><span>         fn sys(_: Query&LTAnyOf<(&A, &mut A)>>) {}
</span><span>         let mut world = World::default();
</span><span style=color:#c594c5>@@ -650,7 +650,7 @@ </span><span style=color:#399ee6>mod tests {
</span><span>     }
</span><span> 
</span><span>     #[test]
</span><span style=color:#f07171>-    #[should_panic = "&bevy_ecs::system::tests::A conflicts with a previous access in this query."]
</span><span style=color:#86b300>+    #[should_panic]
</span><span>     fn any_of_with_mut_and_option() {
</span><span>         fn sys(_: Query&LTAnyOf<(&mut A, Option<&A>)>>) {}
</span><span>         let mut world = World::default();
</span><span style=color:#c594c5>@@ -680,7 +680,7 @@ </span><span style=color:#399ee6>mod tests {
</span><span>     }
</span><span> 
</span><span>     #[test]
</span><span style=color:#f07171>-    #[should_panic = "&mut bevy_ecs::system::tests::A conflicts with a previous access in this query."]
</span><span style=color:#86b300>+    #[should_panic]
</span><span>     fn any_of_with_conflicting() {
</span><span>         fn sys(_: Query&LTAnyOf<(&mut A, &mut A)>>) {}
</span><span>         let mut world = World::default();
</span><span style=color:#c594c5>@@ -1629,54 +1629,42 @@ </span><span style=color:#399ee6>mod tests {
</span><span>     }
</span><span> 
</span><span>     #[test]
</span><span style=color:#f07171>-    #[should_panic(
</span><span style=color:#f07171>-        expected = "error[B0001]: Query&LTEntityMut, ()> in system bevy_ecs::system::tests::assert_world_and_entity_mut_system_does_conflict_first::system accesses component(s) in a way that conflicts with a previous system parameter. Consider using `Without&LTT>` to create disjoint Queries or merging conflicting Queries into a `ParamSet`. See: https://bevy.org/learn/errors/b0001"
</span><span style=color:#f07171>-    )]
</span><span style=color:#86b300>+    #[should_panic]
</span><span>     fn assert_world_and_entity_mut_system_does_conflict_first() {
</span><span>         fn system(_query: &World, _q2: Query&LTEntityMut>) {}
</span><span>         super::assert_system_does_not_conflict(system);
</span><span>     }
</span><span> 
</span><span>     #[test]
</span><span style=color:#f07171>-    #[should_panic(
</span><span style=color:#f07171>-        expected = "&World conflicts with a previous mutable system parameter. Allowing this would break Rust's mutability rules"
</span><span style=color:#f07171>-    )]
</span><span style=color:#86b300>+    #[should_panic]
</span><span>     fn assert_world_and_entity_mut_system_does_conflict_second() {
</span><span>         fn system(_: Query&LTEntityMut>, _: &World) {}
</span><span>         super::assert_system_does_not_conflict(system);
</span><span>     }
</span><span> 
</span><span>     #[test]
</span><span style=color:#f07171>-    #[should_panic(
</span><span style=color:#f07171>-        expected = "error[B0001]: Query&LTEntityMut, ()> in system bevy_ecs::system::tests::assert_entity_ref_and_entity_mut_system_does_conflict::system accesses component(s) in a way that conflicts with a previous system parameter. Consider using `Without&LTT>` to create disjoint Queries or merging conflicting Queries into a `ParamSet`. See: https://bevy.org/learn/errors/b0001"
</span><span style=color:#f07171>-    )]
</span><span style=color:#86b300>+    #[should_panic]
</span><span>     fn assert_entity_ref_and_entity_mut_system_does_conflict() {
</span><span>         fn system(_query: Query&LTEntityRef>, _q2: Query&LTEntityMut>) {}
</span><span>         super::assert_system_does_not_conflict(system);
</span><span>     }
</span><span> 
</span><span>     #[test]
</span><span style=color:#f07171>-    #[should_panic(
</span><span style=color:#f07171>-        expected = "error[B0001]: Query&LTEntityMut, ()> in system bevy_ecs::system::tests::assert_entity_mut_system_does_conflict::system accesses component(s) in a way that conflicts with a previous system parameter. Consider using `Without&LTT>` to create disjoint Queries or merging conflicting Queries into a `ParamSet`. See: https://bevy.org/learn/errors/b0001"
</span><span style=color:#f07171>-    )]
</span><span style=color:#86b300>+    #[should_panic]
</span><span>     fn assert_entity_mut_system_does_conflict() {
</span><span>         fn system(_query: Query&LTEntityMut>, _q2: Query&LTEntityMut>) {}
</span><span>         super::assert_system_does_not_conflict(system);
</span><span>     }
</span><span> 
</span><span>     #[test]
</span><span style=color:#f07171>-    #[should_panic(
</span><span style=color:#f07171>-        expected = "error[B0001]: Query&LTEntityRef, ()> in system bevy_ecs::system::tests::assert_deferred_world_and_entity_ref_system_does_conflict_first::system accesses component(s) in a way that conflicts with a previous system parameter. Consider using `Without&LTT>` to create disjoint Queries or merging conflicting Queries into a `ParamSet`. See: https://bevy.org/learn/errors/b0001"
</span><span style=color:#f07171>-    )]
</span><span style=color:#86b300>+    #[should_panic]
</span><span>     fn assert_deferred_world_and_entity_ref_system_does_conflict_first() {
</span><span>         fn system(_world: DeferredWorld, _query: Query&LTEntityRef>) {}
</span><span>         super::assert_system_does_not_conflict(system);
</span><span>     }
</span><span> 
</span><span>     #[test]
</span><span style=color:#f07171>-    #[should_panic(
</span><span style=color:#f07171>-        expected = "DeferredWorld in system bevy_ecs::system::tests::assert_deferred_world_and_entity_ref_system_does_conflict_second::system conflicts with a previous access."
</span><span style=color:#f07171>-    )]
</span><span style=color:#86b300>+    #[should_panic]
</span><span>     fn assert_deferred_world_and_entity_ref_system_does_conflict_second() {
</span><span>         fn system(_query: Query&LTEntityRef>, _world: DeferredWorld) {}
</span><span>         super::assert_system_does_not_conflict(system);
</span><span>diff --git a/crates/bevy_ecs/src/system/system.rs b/crates/bevy_ecs/src/system/system.rs
</span><span>index 8527f3d3b84ce..d4521e76f5065 100644
</span><span style=color:#c594c5>--- a/crates/bevy_ecs/src/system/system.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_ecs/src/system/system.rs
</span><span style=color:#c594c5>@@ -410,7 +410,6 @@ </span><span style=color:#399ee6>pub enum RunSystemError {
</span><span> mod tests {
</span><span>     use super::*;
</span><span>     use crate::prelude::*;
</span><span style=color:#f07171>-    use alloc::string::ToString;
</span><span> 
</span><span>     #[test]
</span><span>     fn run_system_once() {
</span><span style=color:#c594c5>@@ -483,7 +482,5 @@ </span><span style=color:#399ee6>mod tests {
</span><span>         let result = world.run_system_once(system);
</span><span> 
</span><span>         assert!(matches!(result, Err(RunSystemError::InvalidParams { .. })));
</span><span style=color:#f07171>-        let expected = "System bevy_ecs::system::system::tests::run_system_once_invalid_params::system did not run due to failed parameter validation: Parameter `Res&LTT>` failed validation: Resource does not exist\nIf this is an expected state, wrap the parameter in `Option&LTT>` and handle</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-06/pr_19738.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>