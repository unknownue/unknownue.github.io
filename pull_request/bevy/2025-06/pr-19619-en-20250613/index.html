<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19619 Fixing running `ci` locally in MacOS
        
    </title><meta content="#19619 Fixing running `ci` locally in MacOS" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-06/>‚Üê Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-06-13</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-06/pr-19619-zh-cn-20250613>‰∏≠Êñá</a></div></div><div class=pr-content><h1 id=fixing-running-ci-locally-in-macos>Fixing running <code>ci</code> locally in MacOS</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fixing running <code>ci</code> locally in MacOS<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19619<li><strong>Author</strong>: eckz<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: None<li><strong>Created</strong>: 2025-06-13T13:45:39Z<li><strong>Merged</strong>: 2025-06-13T15:10:45Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description>Description</h2><h1 id=objective>Objective</h1><ul><li>Running <code>cargo run --package ci</code> in MacOS does not currently work in <code>main</code>.<li>It shows a <code>error: this lint expectation is unfulfilled</code>.<li>Fixes #19583</ul><h2 id=solution>Solution</h2><ul><li>Remove an unnecessary <code>#[expect(clippy::large_enum_variant)]</code> on a function.</ul><h2 id=testing>Testing</h2><ul><li><code>cargo run --package ci</code>: üëç</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The issue started when developers working on macOS encountered a build failure when running the continuous integration (CI) command locally. Specifically, executing <code>cargo run --package ci</code> on macOS would fail with the error message: <code>error: this lint expectation is unfulfilled</code>. This problem was documented in issue #19583 and prevented developers from properly testing their changes locally on macOS systems.<p>The root cause was traced to a Clippy lint expectation that was no longer being fulfilled. In the Bevy codebase, a function called <code>create_pipeline_task</code> had been annotated with <code>#[expect(clippy::large_enum_variant)]</code>. This attribute told the Clippy linter: ‚ÄúI expect this code to trigger a large_enum_variant warning, and that‚Äôs acceptable in this case.‚Äù However, recent code changes meant this lint warning was no longer being triggered, causing the <code>#[expect]</code> attribute to become an error since its expectation went unfulfilled.<p>The solution was straightforward: remove the unnecessary <code>#[expect]</code> attribute. Since the lint warning it was expecting no longer occurred, the attribute had become redundant and was causing the build failure. After removing these four lines of code, developers could once again run the CI command locally on macOS without errors.<p>This change demonstrates an important aspect of Rust‚Äôs linting system: <code>#[expect]</code> attributes require the specified lint to actually trigger. When code evolves and the lint condition disappears, these attributes must be removed to prevent build failures. The fix was minimal but crucial for maintaining developer productivity on macOS.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Developer runs ci command] --> B{MacOS environment}
</span><span>    B -->|Without fix| C[Lint expectation error]
</span><span>    B -->|With fix| D[Successful CI execution]
</span><span>    C --> E[Local testing blocked]
</span><span>    D --> F[Unblocked development workflow]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-render-src-render-resource-pipeline-cache-rs>crates/bevy_render/src/render_resource/pipeline_cache.rs</h3><p><strong>Purpose</strong>: Remove an unfulfilled Clippy lint expectation that was causing build failures on macOS.<p><strong>Code Change</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg_attr</span><span>(
</span><span>    target_os </span><span style=color:#ed9366>= </span><span style=color:#86b300>"macos"</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#f29718>not</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"multi_threaded"</span><span>)
</span><span>)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>expect</span><span>(
</span><span>    clippy::large_enum_variant</span><span style=color:#61676ccc>,
</span><span>    reason </span><span style=color:#ed9366>= </span><span style=color:#86b300>"See https://github.com/bevyengine/bevy/issues/19220"
</span><span>)]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>create_pipeline_task</span><span>(
</span><span>    </span><span style=color:#ff8f40>task</span><span style=color:#61676ccc>:</span><span> impl Future&LTOutput = </span><span style=color:#55b4d4;font-style:italic>Result</span><span>&LTPipeline, PipelineCacheError>> + Send + </span><span style=color:#fa6e32>'static</span><span>,
</span><span>    </span><span style=color:#ff8f40>_sync</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>bool</span><span>,
</span></code></pre><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg_attr</span><span>(
</span><span>    target_os </span><span style=color:#ed9366>= </span><span style=color:#86b300>"macos"</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#f29718>not</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"multi_threaded"</span><span>)
</span><span>)]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>create_pipeline_task</span><span>(
</span><span>    </span><span style=color:#ff8f40>task</span><span style=color:#61676ccc>:</span><span> impl Future&LTOutput = </span><span style=color:#55b4d4;font-style:italic>Result</span><span>&LTPipeline, PipelineCacheError>> + Send + </span><span style=color:#fa6e32>'static</span><span>,
</span><span>    </span><span style=color:#ff8f40>_sync</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>bool</span><span>,
</span></code></pre><p><strong>Impact</strong>: This change directly resolves the build failure by removing the unfulfilled lint expectation. The conditional compilation attributes remain intact, preserving the macOS-specific behavior while eliminating the problematic lint directive.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/nightly/clippy/usage.html#lint-expectations target=_blank>Rust Clippy Lint Expectations Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/reference/conditional-compilation.html target=_blank>Rust Conditional Compilation Attributes</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/docs/ci.md target=_blank>Bevy CI Documentation</a></ul><h2 id=full-code-diff>Full Code Diff</h2><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_render/src/render_resource/pipeline_cache.rs b/crates/bevy_render/src/render_resource/pipeline_cache.rs
</span><span>index e8814895a21a0..9d658cf361abd 100644
</span><span style=color:#c594c5>--- a/crates/bevy_render/src/render_resource/pipeline_cache.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_render/src/render_resource/pipeline_cache.rs
</span><span style=color:#c594c5>@@ -1103,10 +1103,6 @@ </span><span style=color:#399ee6>fn create_pipeline_task(
</span><span>     target_os = "macos",
</span><span>     not(feature = "multi_threaded")
</span><span> )]
</span><span style=color:#f07171>-#[expect(
</span><span style=color:#f07171>-    clippy::large_enum_variant,
</span><span style=color:#f07171>-    reason = "See https://github.com/bevyengine/bevy/issues/19220"
</span><span style=color:#f07171>-)]
</span><span> fn create_pipeline_task(
</span><span>     task: impl Future&LTOutput = Result&LTPipeline, PipelineCacheError>> + Send + 'static,
</span><span>     _sync: bool,
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-06/pr_19619.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>