<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19058 Initial raytraced lighting progress (bevy_solari)
        
    </title><meta content="#19058 Initial raytraced lighting progress (bevy_solari)" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-06/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-06-12</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2025-06/pr-19058-en-20250612>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=chu-shi-guang-xian-zhui-zong-guang-zhao-jin-zhan-bevy-solari>初始光线追踪光照进展（bevy_solari）</h1><h2 id=ji-ben-xin-xi>基本信息</h2><ul><li><strong>标题</strong>: Initial raytraced lighting progress (bevy_solari)<li><strong>PR 链接</strong>: https://github.com/bevyengine/bevy/pull/19058<li><strong>作者</strong>: JMS55<li><strong>状态</strong>: MERGED<li><strong>标签</strong>: C-Feature, A-Rendering, S-Ready-For-Final-Review, D-Complex, M-Needs-Release-Note, X-Contentious<li><strong>创建时间</strong>: 2025-05-04T16:56:14Z<li><strong>合并时间</strong>: 2025-06-12T21:43:13Z<li><strong>合并者</strong>: cart</ul><h2 id=miao-shu-fan-yi>描述翻译</h2><h1 id=bevy-solari>Bevy Solari</h1><img src=https://github.com/user-attachments/assets/94061fc8-01cf-4208-b72a-8eecad610d76 width=100><h2 id=qian-yan>前言</h2><ul><li>参见发布说明。<li>如有关于长期计划的问题，请在 Discord 的 #rendering-dev 频道与我讨论，或开启 GitHub 讨论，请将本 PR 的讨论限制在 PR 内容范围内 :)</ul><h2 id=guan-lian>关联</h2><ul><li>推进 #639, #16408。<li>衍生 https://github.com/bevyengine/bevy/issues/18993。<li>需要先在 naga_oil 修复 RT 相关内容 https://github.com/bevyengine/naga_oil/pull/116。</ul><h2 id=ben-pr>本 PR</h2><p>经过近两年时间，我重启了最初在 https://github.com/bevyengine/bevy/pull/10000 开始的光线追踪工作。<p>与包含实时技术的前一个 PR 不同，本 PR 限定于：<ul><li><code>RaytracingScenePlugin</code> - BLAS 和 TLAS 构建、几何和纹理绑定、采样函数。<li><code>PathtracingPlugin</code> - 非实时路径追踪器，用作测试平台和参考。</ul><h2 id=shi-xian-liao-shen-me>实现了什么？</h2><p><img alt=image src=https://github.com/user-attachments/assets/06522007-c205-46eb-8178-823f19917def><ul><li>在网格加载时构建 BLAS<li>自发光光源<li>带软阴影的定向光<li>漫反射材质（Lambert，非 Bevy 的漫反射 BRDF）和自发光材质<li>参考路径追踪器包含： <ul><li>抗锯齿<li>直接光采样（next event estimation）带 0/1 MIS 权重<li>重要性采样 BRDF 反弹<li>Russian roulette 终止</ul></ul><h2 id=wei-shi-xian-de-nei-rong>未实现的内容？</h2><ul><li>任何实时功能，包括实时降噪器<li>与 Bevy 的光栅化 G-buffer 集成<li>镜面反射材质<li>非透明几何体<li>CPU 或 GPU 优化 <ul><li>BLAS 压缩、合适的无绑定和进一步 RT API 需要 wgpu 支持</ul><li>点光源、聚光灯或天空盒/环境光照<li>除 StandardMaterial 外的其他材质支持（仅支持部分属性）<li>蒙皮/变形或其他动画/变形网格<li>Mipmaps<li>自适应自相交光线偏移<li>开发者检测用户 GPU 是否支持 RT 并回退到烘焙光照的方案<li>文档和最终确定的 API（所有内容都可能更改）</ul><h2 id=zhong-duan-yong-hu-yong-fa>终端用户用法</h2><ul><li>拥有支持内联光线查询 RT 的 GPU<li>在应用中添加 <code>SolariPlugin</code><li>确保用于光线追踪的 <code>Mesh</code> 资源设置 <code>enable_raytracing: true</code>（默认为 true），并使用标准未压缩的位置/法线/uv_0/切线顶点属性集、三角形列表拓扑和 32 位索引。 <ul><li>若不想为网格构建 BLAS 用于 RT，设置 enable_raytracing 为 false。</ul><li>在实体上添加 <code>RaytracingMesh3d</code> 组件（独立于 <code>Mesh3d</code> 或 <code>MeshletMesh3d</code>）。</ul><h2 id=ce-shi>测试</h2><ul><li>是否测试了这些更改？如何测试的？ <ul><li>运行了 solari 示例。</ul><li>是否有部分需要更多测试？ <ul><li>可能需要其他测试场景。法线贴图值得测试。</ul><li>其他人（评审者）如何测试你的更改？他们需要了解什么特定信息？ <ul><li>参考 solari.rs 示例了解如何设置光线追踪。</ul><li>若相关，你在哪些平台上测试了这些更改，有哪些重要平台无法测试？ <ul><li>Windows 11, NVIDIA RTX 3080。</ul></ul><h2 id=pr-ji-shu-fen-xi>PR 技术分析</h2><h3 id=wen-ti-bei-jing>问题背景</h3><p>Bevy 引擎需要现代光线追踪解决方案来解决传统光栅化渲染的局限性。现有光照方案（如阴影贴图和环境光遮蔽）在动态场景和全局光照方面存在质量和性能限制。开发者需要一种利用现代 GPU 硬件能力的方案，支持动态场景的实时全局光照、软阴影和精确反射。<p>技术挑战包括：<ul><li>缺乏加速结构管理（BLAS/TLAS）<li>缺少材质/光照的统一绑定接口<li>无路径追踪参考实现<li>需要与 Bevy 的 ECS 和渲染管线集成</ul><h3 id=jie-jue-fang-an>解决方案</h3><p>本 PR 引入 <code>bevy_solari</code> 模块作为光线追踪基础，分为两个核心插件：<ol><li><code>RaytracingScenePlugin</code>：处理底层加速结构（BLAS/TLAS）、资源绑定和采样函数<li><code>PathtracingPlugin</code>：提供非实时路径追踪器作为参考实现</ol><p>关键工程决策：<ul><li>使用 WGSL 编写核心光线追踪着色器<li>通过 <code>RaytracingMesh3d</code> 组件将光线追踪网格与光栅化网格分离<li>新增 <code>enable_raytracing</code> 网格属性控制 BLAS 构建<li>利用 wgpu 的实验性光线追踪扩展（<code>RAY_QUERY</code>, <code>RAY_TRACING_ACCELERATION_STRUCTURE</code>）</ul><h3 id=shi-xian-xi-jie>实现细节</h3><h4 id=jia-su-jie-gou-guan-li>加速结构管理</h4><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 文件: crates/bevy_solari/src/scene/blas.rs
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>prepare_raytracing_blas</span><span>(...) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 为兼容网格创建 BLAS
</span><span>    </span><span style=color:#fa6e32>let</span><span> blas_size </span><span style=color:#ed9366>=</span><span> BlasTriangleGeometrySizeDescriptor {
</span><span>        vertex_format</span><span style=color:#61676ccc>: </span><span>Mesh</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ATTRIBUTE_POSITION</span><span style=color:#ed9366>.</span><span>format</span><span style=color:#61676ccc>,
</span><span>        vertex_count</span><span style=color:#61676ccc>:</span><span> vertex_slice</span><span style=color:#ed9366>.</span><span>range</span><span style=color:#ed9366>.</span><span style=color:#f07171>len</span><span>() </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>u32</span><span style=color:#61676ccc>,
</span><span>        index_format</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(IndexFormat</span><span style=color:#ed9366>::</span><span>Uint32)</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>    }</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> blas </span><span style=color:#ed9366>=</span><span> render_device</span><span style=color:#ed9366>.</span><span style=color:#f07171>create_blas</span><span>(</span><span style=color:#ed9366>...</span><span>)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><ul><li>网格需满足特定条件：三角形列表拓扑、完整顶点属性、32位索引<li>BLAS 在网格加载时构建，通过 <code>enable_raytracing</code> 控制</ul><h4 id=chang-jing-bang-ding>场景绑定</h4><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 文件: crates/bevy_solari/src/scene/binder.rs
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>prepare_raytracing_scene_bindings</span><span>(...) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 收集所有光线追踪实例
</span><span>    </span><span style=color:#fa6e32>for </span><span>(mesh</span><span style=color:#61676ccc>,</span><span> material</span><span style=color:#61676ccc>,</span><span> transform) </span><span style=color:#ed9366>in &</span><span>instances_query {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// 转换矩阵处理
</span><span>        </span><span style=color:#ed9366>*</span><span>tlas</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_mut_single</span><span>(instance_id)</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>() </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(TlasInstance</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ed9366>...</span><span>))</span><span style=color:#61676ccc>;
</span><span>        
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// 存储几何和材质ID
</span><span>        geometry_ids</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_mut</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>push</span><span>(GpuInstanceGeometryIds { </span><span style=color:#ed9366>... </span><span>})</span><span style=color:#61676ccc>;
</span><span>        material_ids</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_mut</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>push</span><span>(material_id)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>    
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 创建统一绑定组
</span><span>    </span><span style=color:#fa6e32>let</span><span> bind_group </span><span style=color:#ed9366>=</span><span> render_device</span><span style=color:#ed9366>.</span><span style=color:#f07171>create_bind_group</span><span>(
</span><span>        </span><span style=color:#86b300>"raytracing_scene_bind_group"</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#ed9366>&</span><span>bind_group_layout</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#ed9366>&</span><span>BindGroupEntries</span><span style=color:#ed9366>::</span><span>sequential((</span><span style=color:#ed9366>...</span><span>))
</span><span>    )</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><ul><li>使用存储缓冲区管理实例数据（变换矩阵、材质ID等）<li>通过绑定数组处理纹理和采样器<li>为光源（自发光网格、定向光）创建统一数据结构</ul><h4 id=lu-jing-zhui-zong-shi-xian>路径追踪实现</h4><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// 文件: crates/bevy_solari/src/pathtracer/pathtracer.wgsl
</span><span>@compute @workgroup_size(8, 8, 1)
</span><span>fn pathtrace(...) {
</span><span>    // 相机光线生成
</span><span>    let primary_ray_target = view.world_from_clip * vec4(pixel_ndc, 1.0);
</span><span>    var ray_direction = normalize(primary_ray_target.xyz - ray_origin);
</span><span>    
</span><span>    // 路径追踪循环
</span><span>    loop {
</span><span>        let ray_hit = trace_ray(ray_origin, ray_direction, ...);
</span><span>        if ray_hit.kind != RAY_QUERY_INTERSECTION_NONE {
</span><span>            // 材质评估
</span><span>            let diffuse_brdf = ray_hit.material.base_color / PI;
</span><span>            
</span><span>            // 直接光采样
</span><span>            radiance += throughput * diffuse_brdf * sample_random_light(...);
</span><span>            
</span><span>            // 俄罗斯轮盘终止
</span><span>            let p = luminance(throughput);
</span><span>            if rand_f(&rng) > p { break; }
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre><ul><li>实现核心路径追踪算法（光线生成、相交测试、BRDF 采样、NEE）<li>包含 Russian roulette 终止和重要性采样<li>累积式渐进渲染</ul><h3 id=ji-shu-dong-cha>技术洞察</h3><ol><li><strong>硬件要求</strong>：依赖 wgpu 的 <code>RAY_QUERY</code> 和 <code>RAY_TRACING_ACCELERATION_STRUCTURE</code> 扩展<li><strong>资源绑定</strong>：通过动态绑定数组管理纹理/缓冲区<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>struct </span><span style=color:#399ee6>CachedBindingArray</span><span>&LTT, I</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Eq </span><span style=color:#ed9366>+</span><span> Hash> {
</span><span>    map</span><span style=color:#61676ccc>: </span><span>HashMap&LTI, </span><span style=color:#fa6e32>u32</span><span>>,
</span><span>    vec</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Vec</span><span>&LTT>,
</span><span>}
</span></code></pre><li><strong>性能考量</strong>：当前未优化，未来需 BLAS 压缩和无绑定改进<li><strong>材质系统</strong>：仅支持 StandardMaterial 子集，通过纹理 ID 映射处理</ol><h3 id=ying-xiang>影响</h3><ol><li><strong>架构基础</strong>：建立光线追踪核心基础设施<li><strong>功能扩展</strong>：为实时全局光照奠定基础<li><strong>开发者体验</strong>：通过示例展示用法（examples/3d/solari.rs）<li><strong>未来方向</strong>：为实时降噪器和混合渲染铺平道路</ol><h2 id=zu-jian-guan-xi-tu>组件关系图</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[RaytracingScenePlugin] --> B[BLAS管理]
</span><span>    A --> C[TLAS构建]
</span><span>    A --> D[资源绑定]
</span><span>    B --> E[网格处理]
</span><span>    C --> F[实例管理]
</span><span>    D --> G[着色器绑定]
</span><span>    H[PathtracingPlugin] --> I[路径追踪器]
</span><span>    I --> J[渐进渲染]
</span><span>    I --> K[光源采样]
</span></code></pre><h2 id=guan-jian-wen-jian-bian-geng>关键文件变更</h2><h3 id=crates-bevy-solari-src-scene-binder-rs-366-0>crates/bevy_solari/src/scene/binder.rs (+366/-0)</h3><p>负责场景资源的绑定和加速结构管理。关键功能包括：<ul><li>创建 TLAS 和实例数据<li>管理材质/纹理绑定<li>准备光源数据结构</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>fn </span><span style=color:#f29718>prepare_raytracing_scene_bindings</span><span>(...) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 处理材质纹理
</span><span>    </span><span style=color:#fa6e32>let mut </span><span style=color:#f29718>process_texture </span><span style=color:#ed9366>= </span><span>|</span><span style=color:#ff8f40>texture_handle</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTHandle<</span><span style=color:#ed9366>_</span><span>>>| </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#fa6e32>u32</span><span>> {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// 纹理绑定逻辑
</span><span>    }</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 创建TLAS实例
</span><span>    </span><span style=color:#ed9366>*</span><span>tlas</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_mut_single</span><span>(instance_id)</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>() </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(TlasInstance</span><span style=color:#ed9366>::</span><span>new(
</span><span>        blas</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#f07171>tlas_transform</span><span>(</span><span style=color:#ed9366>&</span><span>transform)</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#55b4d4;font-style:italic>Default</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#ff8f40>0xFF</span><span style=color:#61676ccc>,
</span><span>    ))</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=crates-bevy-solari-src-scene-sampling-wgsl-169-0>crates/bevy_solari/src/scene/sampling.wgsl (+169/-0)</h3><p>包含光线追踪的核心采样函数：<ul><li>光源采样（<code>sample_random_light</code>）<li>半球采样（<code>sample_cosine_hemisphere</code>）<li>可见性测试（<code>trace_light_visibility</code>）</ul><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>fn sample_random_light(...) -> vec3&LTf32> {
</span><span>    let light_sample = generate_random_light_sample(rng);
</span><span>    let light_contribution = calculate_light_contribution(...);
</span><span>    let visibility = trace_light_visibility(...);
</span><span>    return light_contribution.radiance * visibility * light_contribution.inverse_pdf;
</span><span>}
</span></code></pre><h3 id=crates-bevy-solari-src-scene-raytracing-scene-bindings-wgsl-164-0>crates/bevy_solari/src/scene/raytracing_scene_bindings.wgsl (+164/-0)</h3><p>定义着色器绑定和数据结构：<ul><li>加速结构访问<li>统一缓冲区布局<li>光线追踪工具函数</ul><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>@group(0) @binding(5) var tlas: acceleration_structure;
</span><span>
</span><span>fn trace_ray(...) -> RayIntersection {
</span><span>    let ray = RayDesc(...);
</span><span>    var rq: ray_query;
</span><span>    rayQueryInitialize(&rq, tlas, ray);
</span><span>    // ...
</span><span>}
</span></code></pre><h3 id=crates-bevy-solari-src-pathtracer-node-rs-134-0>crates/bevy_solari/src/pathtracer/node.rs (+134/-0)</h3><p>实现路径追踪计算节点：<ul><li>管理累积纹理<li>调度计算着色器<li>处理渐进渲染</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>fn </span><span style=color:#f29718>run</span><span>(...) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 设置计算管线
</span><span>    pass</span><span style=color:#ed9366>.</span><span style=color:#f07171>set_pipeline</span><span>(pipeline)</span><span style=color:#61676ccc>;
</span><span>    pass</span><span style=color:#ed9366>.</span><span style=color:#f07171>set_bind_group</span><span>(</span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>,</span><span> scene_bindings</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>[])</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 分派计算任务
</span><span>    pass</span><span style=color:#ed9366>.</span><span style=color:#f07171>dispatch_workgroups</span><span>(viewport</span><span style=color:#ed9366>.</span><span>x</span><span style=color:#ed9366>.</span><span style=color:#f07171>div_ceil</span><span>(</span><span style=color:#ff8f40>8</span><span>)</span><span style=color:#61676ccc>,</span><span> viewport</span><span style=color:#ed9366>.</span><span>y</span><span style=color:#ed9366>.</span><span style=color:#f07171>div_ceil</span><span>(</span><span style=color:#ff8f40>8</span><span>)</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>1</span><span>)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=crates-bevy-mesh-src-mesh-rs>crates/bevy_mesh/src/mesh.rs</h3><p>添加光线追踪控制字段：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>Mesh </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>    </span><span style=color:#fa6e32>pub </span><span>enable_raytracing</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>bool</span><span>,
</span><span>}
</span></code></pre><h2 id=kuo-zhan-yue-du>扩展阅读</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://www.realtimerendering.com/raytracinggems/ target=_blank>Ray Tracing Gems</a>：光线追踪技术权威指南<li><a rel="noopener nofollow noreferrer" href=https://gpuweb.github.io/gpuweb/wgsl/#ray-query target=_blank>WGSL Ray Query Specification</a>：WGSL 光线查询规范<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/docs/plugins/bevy_pbr target=_blank>Bevy 渲染架构</a>：了解 Bevy 的 PBR 实现<li><a rel="noopener nofollow noreferrer" href=https://pbr-book.org/ target=_blank>路径追踪算法</a>：Physically Based Rendering 书籍</ol><p>此 PR 为 Bevy 的光线追踪功能奠定基础，后续工作将聚焦实时降噪和性能优化。开发者可通过示例了解基础用法，但生产环境使用需等待功能完善。</div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-06/pr_19058.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>