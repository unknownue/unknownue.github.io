<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19606 Replace `UntypedHandle` from ReflectAsset with `impl Into<UntypedAssetId>`.
        
    </title><meta content="#19606 Replace `UntypedHandle` from ReflectAsset with `impl Into<UntypedAssetId>`." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-06/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-06-15</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-06/pr-19606-zh-cn-20250615>中文</a></div></div><div class=pr-content><h2 id=replace-untypedhandle-from-reflectasset-with-impl-into-untypedassetid>Replace <code>UntypedHandle</code> from ReflectAsset with <code>impl Into&LTUntypedAssetId></code></h2><h3 id=basic-information>Basic Information</h3><ul><li><strong>Title</strong>: Replace <code>UntypedHandle</code> from ReflectAsset with <code>impl Into&LTUntypedAssetId></code>.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19606<li><strong>Author</strong>: andriyDev<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Assets, C-Usability, S-Ready-For-Final-Review, A-Reflection, M-Needs-Migration-Guide, X-Uncontroversial, D-Straightforward<li><strong>Created</strong>: 2025-06-13T00:20:07Z<li><strong>Merged</strong>: 2025-06-15T17:02:17Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h3 id=description>Description</h3><h1 id=objective>Objective</h1><ul><li>A step towards #19024.<li>Allow <code>ReflectAsset</code> to work with any <code>AssetId</code> not just <code>Handle</code>.<li><code>ReflectAsset::ids()</code> returns an iterator of <code>AssetId</code>s, but then there’s no way to use these ids, since all the other APIs in <code>ReflectAsset</code> require a handle (and we don’t have a reflect way to get the handle).</ul><h2 id=solution>Solution</h2><ul><li>Replace the <code>UntypedHandle</code> argument in <code>ReflectAsset</code> methods with <code>impl Into&LTUntypedAssetId></code>.<li>This matches the regular asset API.<li>This allows <code>ReflectAsset::ids()</code> to be more useful.</ul><h2 id=testing>Testing</h2><ul><li>None.</ul><hr><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=the-problem-and-context>The Problem and Context</h3><p>The <code>ReflectAsset</code> API had a usability gap where its <code>ids()</code> method returned <code>UntypedAssetId</code> values, but all other methods required <code>UntypedHandle</code> parameters. This made the IDs essentially unusable since there was no straightforward way to convert between asset IDs and handles within the reflection system. This limitation prevented developers from working directly with asset IDs obtained through reflection, forcing unnecessary conversions or workarounds.<p>The core issue stemmed from an inconsistency between the reflected asset API and Bevy’s standard asset API. The regular <code>Assets&LTT></code> methods accept any type implementing <code>Into&LTAssetId></code>, providing flexibility in how assets are referenced. However, <code>ReflectAsset</code> only accepted <code>UntypedHandle</code>, creating an artificial barrier for reflection-based workflows.<h3 id=the-solution-approach>The Solution Approach</h3><p>The solution replaces all <code>UntypedHandle</code> parameters in <code>ReflectAsset</code> methods with <code>impl Into&LTUntypedAssetId></code>. This approach:<ol><li>Maintains backward compatibility (since <code>UntypedHandle</code> implements <code>Into&LTUntypedAssetId></code>)<li>Aligns with Bevy’s standard asset API conventions<li>Enables direct use of asset IDs from <code>ids()</code> iterator<li>Requires minimal changes to existing code</ol><p>No alternatives were seriously considered since this directly addresses the inconsistency while maintaining full backward compatibility. The implementation follows Rust’s best practices for API design by using trait bounds to accept multiple input types.<h3 id=the-implementation>The Implementation</h3><p>The changes required updates to both the <code>ReflectAsset</code> struct definition and its method implementations. The function pointers within <code>ReflectAsset</code> were modified to use <code>UntypedAssetId</code> instead of <code>UntypedHandle</code>, while public methods gained <code>impl Into&LTUntypedAssetId></code> parameters.<p>Key implementation details:<ol><li>All method parameters now accept any type convertible to <code>UntypedAssetId</code><li>Internal conversions happen via <code>.into()</code> at method boundaries<li>The <code>FromType</code> implementation was updated to handle <code>UntypedAssetId</code><li>Tests were updated to demonstrate the new usage patterns</ol><p>The implementation maintains safety invariants for <code>get_unchecked_mut</code> by continuing to use <code>UnsafeWorldCell</code> for interior mutability. The <code>typed_debug_checked</code> conversion ensures type safety when accessing specific asset types.<h3 id=technical-insights>Technical Insights</h3><p>The change leverages Rust’s trait system to create a more flexible API without runtime overhead. The <code>impl Into&LTUntypedAssetId></code> parameter:<ul><li>Is monomorphized at compile-time<li>Adds no runtime indirection<li>Allows both handles and raw asset IDs<li>Preserves existing safety guarantees</ul><p>The migration demonstrates good practice for API evolution: maintaining backward compatibility while improving usability. The <code>UntypedAssetId</code> serves as a common denominator for all asset reference types, similar to how <code>AssetId</code> works in non-reflected contexts.<h3 id=the-impact>The Impact</h3><p>This change significantly improves the usability of <code>ReflectAsset</code> by:<ol><li>Enabling direct use of asset IDs from <code>ids()</code> iterator<li>Aligning reflected and non-reflected asset APIs<li>Reducing boilerplate for asset ID/handle conversions<li>Unlocking new reflection-based workflows</ol><p>The solution moves Bevy closer to the goals of Assets V2 (#19024) by creating a more consistent asset handling system. The changes affect all users of <code>ReflectAsset</code>, but the migration path is straightforward thanks to the backward-compatible API design.<hr><h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[ReflectAsset User] -->|Passes| B[impl Into&LTUntypedAssetId>]
</span><span>    B --> C[UntypedAssetId]
</span><span>    C --> D[ReflectAsset Implementation]
</span><span>    D -->|Uses| E[Assets Resource]
</span></code></pre><hr><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-asset-src-reflect-rs><code>crates/bevy_asset/src/reflect.rs</code></h3><p>Updated <code>ReflectAsset</code> to accept asset IDs instead of handles<p><strong>Before:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>get</span><span><</span><span style=color:#fa6e32>'w</span><span>>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'w</span><span> World, </span><span style=color:#ff8f40>handle</span><span style=color:#61676ccc>:</span><span> UntypedHandle) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'w</span><span> dyn Reflect> {
</span><span>    (</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>get)(world</span><span style=color:#61676ccc>,</span><span> handle)
</span><span>}
</span></code></pre><p><strong>After:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>get</span><span><</span><span style=color:#fa6e32>'w</span><span>>(
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>,
</span><span>    </span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'w</span><span> World,
</span><span>    </span><span style=color:#ff8f40>asset_id</span><span style=color:#61676ccc>:</span><span> impl </span><span style=color:#55b4d4;font-style:italic>Into</span><span>&LTUntypedAssetId>,
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'w</span><span> dyn Reflect> {
</span><span>    (</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>get)(world</span><span style=color:#61676ccc>,</span><span> asset_id</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>())
</span><span>}
</span></code></pre><p><strong>Internal implementation change:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>get</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>fn</span><span>(</span><span style=color:#ed9366>&</span><span>World</span><span style=color:#61676ccc>,</span><span> UntypedHandle) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#ed9366>&</span><span>dyn Reflect></span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>get</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>fn</span><span>(</span><span style=color:#ed9366>&</span><span>World</span><span style=color:#61676ccc>,</span><span> UntypedAssetId) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#ed9366>&</span><span>dyn Reflect></span><span style=color:#61676ccc>,
</span></code></pre><h3 id=release-content-migration-guides-reflect-asset-asset-ids-md><code>release-content/migration-guides/reflect_asset_asset_ids.md</code></h3><p>Added migration guide for the API change<pre class=language-markdown data-lang=markdown style=color:#61676c;background-color:#fafafa><code class=language-markdown data-lang=markdown><span style=color:#abb0b6;background-color:#61676c10;font-weight:700>---
</span><span>title: </span><span style=color:#ed9366;background-color:#61676c10>`ReflectAsset`</span><span> now uses </span><span style=color:#ed9366;background-color:#61676c10>`UntypedAssetId`</span><span> instead of </span><span style=color:#ed9366;background-color:#61676c10>`UntypedHandle`</span><span>.
</span><span>pull_requests: [19606]
</span><span style=color:#fa6e32;font-weight:700>---
</span><span>
</span><span>Previously, </span><span style=color:#ed9366;background-color:#61676c10>`ReflectAsset`</span><span> methods all required having </span><span style=color:#ed9366;background-color:#61676c10>`UntypedHandle`</span><span>. The only way to get an
</span><span style=color:#ed9366;background-color:#61676c10>`UntypedHandle`</span><span> through this API was with </span><span style=color:#ed9366;background-color:#61676c10>`ReflectAsset::add`</span><span>. </span><span style=color:#ed9366;background-color:#61676c10>`ReflectAsset::ids`</span><span> was not very
</span><span>useful in this regard.
</span><span>
</span><span>Now, all methods have been changed to accept </span><span style=color:#ed9366;background-color:#61676c10>`impl Into&LTUntypedAssetId>`</span><span>, which matches our regular
</span><span style=color:#ed9366;background-color:#61676c10>`Assets&LTT>`</span><span> API. This means you may need to change how you are calling these methods.
</span><span>
</span><span>For example, if your code previously looked like:
</span><span>
</span><span>```</span><span style=color:#ff8f40>rust
</span><span style=color:#fa6e32;background-color:#61676c07>let</span><span style=color:#61676c;background-color:#61676c07> my_handle</span><span style=color:#61676ccc;background-color:#61676c07>:</span><span style=color:#61676c;background-color:#61676c07> UntypedHandle</span><span style=color:#61676ccc;background-color:#61676c07>;
</span><span style=color:#fa6e32;background-color:#61676c07>let</span><span style=color:#61676c;background-color:#61676c07> my_asset </span><span style=color:#ed9366;background-color:#61676c07>=</span><span style=color:#61676c;background-color:#61676c07> reflect_asset</span><span style=color:#ed9366;background-color:#61676c07>.</span><span style=color:#f07171;background-color:#61676c07>get_mut</span><span style=color:#61676c;background-color:#61676c07>(world</span><span style=color:#61676ccc;background-color:#61676c07>,</span><span style=color:#61676c;background-color:#61676c07> my_handle)</span><span style=color:#ed9366;background-color:#61676c07>.</span><span style=color:#f07171;background-color:#61676c07>unwrap</span><span style=color:#61676c;background-color:#61676c07>()</span><span style=color:#61676ccc;background-color:#61676c07>;
</span></code></pre><p>You can migrate it to:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let</span><span> my_handle</span><span style=color:#61676ccc>:</span><span> UntypedHandle</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> my_asset </span><span style=color:#ed9366>=</span><span> reflect_asset</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_mut</span><span>(world</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>my_handle)</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><pre style=color:#61676c;background-color:#fafafa><code><span>
</span><span>---
</span><span>
</span><span>## Further Reading
</span><span>1. [Bevy Assets Documentation](https://docs.rs/bevy_asset/latest/bevy_asset/)
</span><span>2. [Rust's Into Trait](https://doc.rust-lang.org/std/convert/trait.Into.html)
</span><span>3. [Bevy Reflection System](https://github.com/bevyengine/bevy/blob/main/docs/plugins_guidelines.md#reflection)
</span><span>4. [Assets V2 Tracking Issue (#19024)](https://github.com/bevyengine/bevy/issues/19024)</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-06/pr_19606.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>