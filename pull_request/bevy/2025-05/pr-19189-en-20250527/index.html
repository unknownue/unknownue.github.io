<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19189 Make light cascades and tonemapping luts pub
        
    </title><meta content="#19189 Make light cascades and tonemapping luts pub" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-05/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-05-27</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-05/pr-19189-zh-cn-20250527>中文</a></div></div><div class=pr-content><h1 id=make-light-cascades-and-tonemapping-luts-pub>Make light cascades and tonemapping luts pub</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Make light cascades and tonemapping luts pub<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19189<li><strong>Author</strong>: DGriffin91<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, C-Usability, S-Ready-For-Final-Review, D-Straightforward<li><strong>Created</strong>: 2025-05-12T17:28:27Z<li><strong>Merged</strong>: 2025-05-27T20:05:31Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>Make directional light cascades and tonemapping luts pub so that custom render passes / backends can use them.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The PR addresses a common need in graphics programming: enabling extensibility of rendering pipelines while maintaining access to core rendering data structures. Bevy’s existing implementation contained several critical data structures for shadow mapping and tonemapping that were not accessible to custom render passes due to visibility restrictions.<h3 id=the-visibility-challenge>The Visibility Challenge</h3><p>In the original implementation, both the cascade shadow data (<code>Cascades</code> and <code>Cascade</code> structs) and tonemapping LUTs (<code>TonemappingLuts</code>) were marked with <code>pub(crate)</code> visibility. This prevented external crates and custom rendering backends from accessing these essential components:<ul><li><strong>Cascade data</strong> is crucial for implementing directional shadow mapping with multiple frustum splits<li><strong>Tonemapping LUTs</strong> (Look-Up Tables) are necessary for consistent color grading across different rendering paths</ul><h3 id=strategic-visibility-expansion>Strategic Visibility Expansion</h3><p>The solution involved carefully auditing the visibility modifiers and expanding them where appropriate:<ol><li><strong>Cascade structs</strong> in <code>bevy_pbr</code> had their fields made fully public<li><strong>TonemappingLuts</strong> in <code>bevy_core_pipeline</code> had their texture handles exposed</ol><p>Key code changes in <code>light/mod.rs</code>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) cascades</span><span style=color:#61676ccc>: </span><span>EntityHashMap<</span><span style=color:#55b4d4;font-style:italic>Vec</span><span>&LTCascade>>
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) world_from_cascade</span><span style=color:#61676ccc>:</span><span> Mat4
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: 
</span><span style=color:#fa6e32>pub</span><span> cascades</span><span style=color:#61676ccc>: </span><span>EntityHashMap<</span><span style=color:#55b4d4;font-style:italic>Vec</span><span>&LTCascade>>
</span><span style=color:#fa6e32>pub</span><span> world_from_cascade</span><span style=color:#61676ccc>:</span><span> Mat4
</span></code></pre><p>For tonemapping resources in <code>tonemapping/mod.rs</code>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>blender_filmic</span><span style=color:#61676ccc>: </span><span>Handle&LTImage>
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub</span><span> blender_filmic</span><span style=color:#61676ccc>: </span><span>Handle&LTImage>
</span></code></pre><h3 id=technical-rationale>Technical Rationale</h3><p>These changes follow Rust’s principle of minimum visibility while addressing practical needs:<ol><li><p><strong>Cascade data exposure</strong> enables custom shadow mapping implementations to:</p> <ul><li>Access precomputed view/projection matrices<li>Utilize calculated texel sizes for shadow map sampling<li>Maintain consistency with Bevy’s cascade splitting logic</ul><li><p><strong>LUT accessibility</strong> allows custom render passes to:</p> <ul><li>Reuse existing tonemapping textures<li>Ensure color consistency between built-in and custom pipelines<li>Avoid duplicating LUT resource handling</ul></ol><h3 id=impact-and-considerations>Impact and Considerations</h3><p>The changes introduce no functional alterations but significantly improve extensibility:<ul><li>Existing systems continue operating unchanged<li>Custom render passes can now integrate with Bevy’s lighting and tonemapping systems<li>No performance impact as this only modifies access modifiers<li>Maintains data encapsulation for non-essential internals</ul><p>A critical consideration was ensuring these changes didn’t expose implementation details that might change frequently. The merged solution strikes a balance by exposing only stable, well-defined data structures crucial for rendering integration.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[Custom Render Pass] --> B[Cascades Data]
</span><span>    A --> C[Tonemapping LUTs]
</span><span>    B --> D[Shadow Mapping]
</span><span>    C --> E[Color Grading]
</span><span>    D --> F[Final Render]
</span><span>    E --> F
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-pbr-src-light-mod-rs>crates/bevy_pbr/src/light/mod.rs</h3><ul><li>Changed visibility modifiers for cascade-related struct fields<li>Enables external access to shadow cascade configuration</ul><p>Before:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) cascades</span><span style=color:#61676ccc>: </span><span>EntityHashMap<</span><span style=color:#55b4d4;font-style:italic>Vec</span><span>&LTCascade>>
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) world_from_cascade</span><span style=color:#61676ccc>:</span><span> Mat4
</span></code></pre><p>After:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub</span><span> cascades</span><span style=color:#61676ccc>: </span><span>EntityHashMap<</span><span style=color:#55b4d4;font-style:italic>Vec</span><span>&LTCascade>>
</span><span style=color:#fa6e32>pub</span><span> world_from_cascade</span><span style=color:#61676ccc>:</span><span> Mat4
</span></code></pre><h3 id=crates-bevy-core-pipeline-src-tonemapping-mod-rs>crates/bevy_core_pipeline/src/tonemapping/mod.rs</h3><ul><li>Exposed LUT texture handles for external use<li>Allows sharing of color grading resources</ul><p>Before:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>blender_filmic</span><span style=color:#61676ccc>: </span><span>Handle&LTImage>
</span></code></pre><p>After:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub</span><span> blender_filmic</span><span style=color:#61676ccc>: </span><span>Handle&LTImage>
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li>Bevy’s Rendering Architecture: https://bevyengine.org/learn/book/rendering/<li>Cascaded Shadow Maps: https://developer.nvidia.com/gpugems/gpugems3/part-ii-light-and-shadows/chapter-10-parallel-split-shadow-maps-programmable-gpus<li>Color Look-Up Tables: https://openglinsights.github.io/tonemapping.html</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-05/pr_19189.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>