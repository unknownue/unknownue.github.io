<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19221 Fix #19219 by moving observer triggers out of resource_scope
        
    </title><meta content="#19221 Fix #19219 by moving observer triggers out of resource_scope" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-05/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-05-30</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2025-05/pr-19221-en-20250530>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=xiu-fu-19219-jiang-guan-cha-zhe-hong-fa-qi-yi-chu-resource-scope>修复 #19219：将观察者触发器移出 resource_scope</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix #19219 by moving observer triggers out of resource_scope<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19221<li><strong>Author</strong>: mbrea-c<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-ECS, S-Ready-For-Final-Review, D-Modest<li><strong>Created</strong>: 2025-05-15T21:37:21Z<li><strong>Merged</strong>: 2025-05-30T19:54:07Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h3 id=mu-biao-objective>目标 (Objective)</h3><p>修复 #19219<h3 id=jie-jue-fang-an-solution>解决方案 (Solution)</h3><p>不再在每次场景生成时调用 <code>world.commands().trigger</code> 和 <code>world.commands().trigger_targets</code>，而是保存 <code>instance_id</code> 和可选的父实体，以便在最后统一执行所有此类调用。这样可以防止因在调用 <code>add_child</code> 时可能发生的世界命令队列刷新导致的崩溃。<h3 id=ce-shi-testing>测试 (Testing)</h3><ul><li>你是否测试了这些更改？如果是，如何测试的？ <ul><li>已验证我无法再按照 #19219 中的步骤重现该错误。<li>运行了 <code>bevy_scene</code> 测试。<li>目视验证了以下示例仍按预期运行：<code>many_foxes</code>, <code>scene</code>。（我应该测试更多吗？）</ul><li>是否有任何部分需要更多测试？ <ul><li>待运行根目录下的 <code>cargo test</code> 以测试所有示例是否仍能构建；完成后我将更新 PR。</ul><li>其他人（审阅者）如何测试你的更改？他们需要了解什么特定信息吗？ <ul><li>像往常一样运行 bevy。</ul><li>如果相关，你在哪些平台上测试了这些更改，是否有任何重要的平台你无法测试？ <ul><li>不适用（在 Linux/wayland 上测试，但应该不相关）。</ul></ul><hr><h2 id=ben-pr-de-ji-shu-jie-xi>本 PR 的技术解析</h2><h3 id=wen-ti-gen-yuan>问题根源</h3><p>在 issue #19219 中，用户报告了一个特定场景下的崩溃问题。当使用 <code>resource_scope</code> 访问 <code>SceneSpawner</code> 资源时，立即触发 <code>SceneInstanceReady</code> 事件会导致命令队列刷新。如果此时系统正在执行 <code>add_child</code> 操作（同样会刷新命令队列），就会造成 <code>SceneSpawner</code> 资源被双重访问，引发 panic。<p>核心问题在于：在资源作用域内触发事件会导致命令队列立即刷新，而某些操作（如添加子实体）也会触发队列刷新，从而造成资源访问冲突。<h3 id=jie-jue-fang-an-she-ji>解决方案设计</h3><p>PR 采用延迟事件触发的策略来解决这个问题：<ol><li>不再在场景生成时立即触发 <code>SceneInstanceReady</code> 事件<li>将事件触发所需数据（<code>instance_id</code> 和可选的 <code>parent</code> 实体）暂存到新集合中<li>在所有场景处理完成后统一触发所有事件</ol><p>这种方法避免了在 <code>resource_scope</code> 内刷新命令队列，消除了资源访问冲突的可能性。<h3 id=ju-ti-shi-xian>具体实现</h3><p>在 <code>SceneSpawner</code> 结构中新增 <code>instances_ready</code> 字段作为临时存储：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>SceneSpawner </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...其他字段...
</span><span>    instances_ready</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Vec</span><span><(InstanceId, </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTEntity>)>,
</span><span>}
</span></code></pre><p>在场景生成逻辑中，将事件触发替换为数据暂存：<pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span> if parent.is_none() {
</span><span style=color:#f07171>-    world.commands().trigger(SceneInstanceReady { instance_id });
</span><span style=color:#86b300>+    self.instances_ready.push((instance_id, None));
</span><span> }
</span></code></pre><p>对于有父实体的场景，同样暂存数据：<pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span style=color:#86b300>+ self.instances_ready.push((instance_id, Some(parent)));
</span></code></pre><p>新增统一处理事件的方法：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>fn </span><span style=color:#f29718>trigger_scene_ready_events</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> World) {
</span><span>    </span><span style=color:#fa6e32>for </span><span>(instance_id</span><span style=color:#61676ccc>,</span><span> parent) </span><span style=color:#ed9366>in </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>instances_ready</span><span style=color:#ed9366>.</span><span style=color:#f07171>drain</span><span>(</span><span style=color:#ed9366>..</span><span>) {
</span><span>        </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(parent) </span><span style=color:#ed9366>=</span><span> parent {
</span><span>            world</span><span style=color:#ed9366>.</span><span style=color:#f07171>commands</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>trigger_targets</span><span>(SceneInstanceReady { instance_id }</span><span style=color:#61676ccc>,</span><span> parent)</span><span style=color:#61676ccc>;
</span><span>        } </span><span style=color:#fa6e32>else </span><span>{
</span><span>            world</span><span style=color:#ed9366>.</span><span style=color:#f07171>commands</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>trigger</span><span>(SceneInstanceReady { instance_id })</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre><p>在系统执行流程最后调用新方法：<pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span> scene_spawner.set_scene_instance_parent_sync(world);
</span><span style=color:#86b300>+ scene_spawner.trigger_scene_ready_events(world);
</span></code></pre><h3 id=ji-shu-kao-liang>技术考量</h3><ol><li><strong>命令队列管理</strong>：Bevy 的命令队列在帧间执行，但在某些情况下（如资源作用域内）会立即刷新<li><strong>资源访问安全</strong>：<code>resource_scope</code> 保证资源独占访问，但命令队列刷新可能违反此约束<li><strong>事件触发顺序</strong>：延迟触发不会改变事件语义，因为所有场景操作已完成<li><strong>内存开销</strong>：新增的 <code>Vec</code> 结构内存开销可忽略，且每次帧清空</ol><h3 id=ying-xiang-ping-gu>影响评估</h3><ol><li>修复了特定操作序列下的崩溃问题<li>保持原有事件触发行为不变<li>对性能影响可忽略不计<li>提高了场景生成系统的健壮性</ol><p>测试验证包括：<ul><li>复现 issue 步骤确认崩溃已修复<li><code>bevy_scene</code> 测试套件通过<li>关键示例（<code>many_foxes</code>, <code>scene</code>）功能正常</ul><h2 id=zu-jian-guan-xi-tu>组件关系图</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[SceneSpawner系统] --> B[处理场景生成]
</span><span>    A --> C[设置父实体关系]
</span><span>    A --> D[触发就绪事件]
</span><span>    D --> E[遍历instances_ready]
</span><span>    E --> F{是否有父实体?}
</span><span>    F -->|是| G[trigger_targets]
</span><span>    F -->|否| H[trigger]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-scene-src-scene-spawner-rs><code>crates/bevy_scene/src/scene_spawner.rs</code></h3><p><strong>修改原因</strong>：<br> 核心场景生成逻辑所在文件，需要修复资源作用域内命令队列刷新导致的崩溃问题。<p><strong>关键变更</strong>：<ol><li>新增 <code>instances_ready</code> 字段存储延迟触发的事件数据<li>替换即时事件触发为数据收集<li>添加统一事件触发方法<li>在系统流程最后调用新方法</ol><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span style=color:#c594c5>@@ -79,6 +79,7 @@ </span><span style=color:#399ee6>pub struct SceneSpawner {
</span><span>     scenes_to_despawn: Vec&LTAssetId&LTDynamicScene>>,
</span><span>     instances_to_despawn: Vec&LTInstanceId>,
</span><span>     scenes_with_parent: Vec<(InstanceId, Entity)>,
</span><span style=color:#86b300>+    instances_ready: Vec<(InstanceId, Option&LTEntity>)>,
</span><span> }
</span><span> 
</span><span style=color:#c594c5>@@ -337,8 +338,9 @@ </span><span style=color:#399ee6>impl SceneSpawner {
</span><span>                     // Scenes with parents need more setup before they are ready.
</span><span>                     // See `set_scene_instance_parent_sync()`.
</span><span>                     if parent.is_none() {
</span><span style=color:#f07171>-                        // Defer via commands otherwise SceneSpawner is not available in the observer.
</span><span style=color:#f07171>-                        world.commands().trigger(SceneInstanceReady { instance_id });
</span><span style=color:#86b300>+                        // We trigger `SceneInstanceReady` events after processing all scenes
</span><span style=color:#86b300>+                        // SceneSpawner may not be available in the observer.
</span><span style=color:#86b300>+                        self.instances_ready.push((instance_id, None));
</span><span>                     }
</span><span>                 }
</span><span style=color:#c594c5>@@ -362,8 +364,9 @@ </span><span style=color:#399ee6>impl SceneSpawner {
</span><span>                     // Scenes with parents need more setup before they are ready.
</span><span>                     // See `set_scene_instance_parent_sync()`.
</span><span>                     if parent.is_none() {
</span><span style=color:#f07171>-                        // Defer via commands otherwise SceneSpawner is not available in the observer.
</span><span style=color:#f07171>-                        world.commands().trigger(SceneInstanceReady { instance_id });
</span><span style=color:#86b300>+                        // We trigger `SceneInstanceReady` events after processing all scenes
</span><span style=color:#86b300>+                        // SceneSpawner may not be available in the observer.
</span><span style=color:#86b300>+                        self.instances_ready.push((instance_id, None));
</span><span>                     }
</span><span>                 }
</span><span style=color:#c594c5>@@ -398,12 +401,25 @@ </span><span style=color:#399ee6>impl SceneSpawner {
</span><span>                     }
</span><span>                 }
</span><span> 
</span><span style=color:#86b300>+                // We trigger `SceneInstanceReady` events after processing all scenes
</span><span style=color:#86b300>+                // SceneSpawner may not be available in the observer.
</span><span style=color:#86b300>+                self.instances_ready.push((instance_id, Some(parent)));
</span><span style=color:#86b300>+            } else {
</span><span style=color:#86b300>+                self.scenes_with_parent.push((instance_id, parent));
</span><span style=color:#86b300>+            }
</span><span style=color:#86b300>+        }
</span><span style=color:#86b300>+    }
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+    fn trigger_scene_ready_events(&mut self, world: &mut World) {
</span><span style=color:#86b300>+        for (instance_id, parent) in self.instances_ready.drain(..) {
</span><span style=color:#86b300>+            if let Some(parent) = parent {
</span><span>                 // Defer via commands otherwise SceneSpawner is not available in the observer.
</span><span>                 world
</span><span>                     .commands()
</span><span>                     .trigger_targets(SceneInstanceReady { instance_id }, parent);
</span><span>             } else {
</span><span style=color:#f07171>-                self.scenes_with_parent.push((instance_id, parent));
</span><span style=color:#86b300>+                // Defer via commands otherwise SceneSpawner is not available in the observer.
</span><span style=color:#86b300>+                world.commands().trigger(SceneInstanceReady { instance_id });
</span><span>             }
</span><span>         }
</span><span>     }
</span><span style=color:#c594c5>@@ -477,6 +493,7 @@ </span><span style=color:#399ee6>pub fn scene_spawner_system(world: &mut World) {
</span><span>             .update_spawned_scenes(world, &updated_spawned_scenes)
</span><span>             .unwrap();
</span><span>         scene_spawner.set_scene_instance_parent_sync(world);
</span><span style=color:#86b300>+        scene_spawner.trigger_scene_ready_events(world);
</span><span>     });
</span><span> }
</span></code></pre><h2 id=kuo-zhan-yue-du>扩展阅读</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/next/programming/ecs/system-order/ target=_blank>Bevy ECS 系统执行模型</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/docs/plugins_guidelines.md#commands target=_blank>Bevy 命令队列工作原理</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/ecs/system/fn.resource_scope.html target=_blank>资源作用域安全访问模式</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/discussions/3900 target=_blank>观察者模式在 ECS 中的应用</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-05/pr_19221.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>