<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18704 Make `entity::index` non max
        
    </title><meta content="#18704 Make `entity::index` non max" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-05/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-05-07</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-05/pr-18704-zh-cn-20250507>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Make <code>entity::index</code> non max<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18704<li><strong>Author</strong>: ElliottjPierce<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-ECS, C-Code-Quality, S-Ready-For-Final-Review, D-Complex, X-Contentious<li><strong>Created</strong>: 2025-04-03T17:45:29Z<li><strong>Merged</strong>: 2025-05-07T18:41:00Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>The original description is already in English and remains unchanged:<h1 id=objective>Objective</h1><p>There are two problems this aims to solve.<p>First, <code>Entity::index</code> is currently a <code>u32</code>. That means there are <code>u32::MAX + 1</code> possible entities. Not only is that awkward, but it also make <code>Entity</code> allocation more difficult. I discovered this while working on remote entity reservation, but even on main, <code>Entities</code> doesn’t handle the <code>u32::MAX + 1</code> entity very well. It can not be batch reserved because that iterator uses exclusive ranges, which has a maximum upper bound of <code>u32::MAX - 1</code>. In other words, having <code>u32::MAX</code> as a valid index can be thought of as a bug right now. We either need to make that invalid (this PR), which makes Entity allocation cleaner and makes remote reservation easier (because the length only needs to be u32 instead of u64, which, in atomics is a big deal), or we need to take another pass at <code>Entities</code> to make it handle the <code>u32::MAX</code> index properly.<p>Second, <code>TableRow</code>, <code>ArchetypeRow</code> and <code>EntityIndex</code> (a type alias for u32) all have <code>u32</code> as the underlying type. That means using these as the index type in a <code>SparseSet</code> uses 64 bits for the sparse list because it stores <code>Option&LTIndexType></code>. By using <code>NonMaxU32</code> here, we cut the memory of that list in half. To my knowledge, <code>EntityIndex</code> is the only thing that would really benefit from this niche. <code>TableRow</code> and <code>ArchetypeRow</code> I think are not stored in an <code>Option</code> in bulk. But if they ever are, this would help. Additionally this ensures <code>TableRow::INVALID</code> and <code>ArchetypeRow::INVALID</code> never conflict with an actual row, which in a nice bonus.<p>As a related note, if we do components as entities where <code>ComponentId</code> becomes <code>Entity</code>, the the <code>SparseSet&LTComponentId></code> will see a similar memory improvement too.<h2 id=solution>Solution</h2><p>Create a new type <code>EntityRow</code> that wraps <code>NonMaxU32</code>, similar to <code>TableRow</code> and <code>ArchetypeRow</code>. Change <code>Entity::index</code> to this type.<h2 id=downsides>Downsides</h2><p><code>NonMax</code> is implemented as a <code>NonZero</code> with a binary inversion. That means accessing and storing the value takes one more instruction. I don’t think that’s a big deal, but it’s worth mentioning.<p>As a consequence, <code>to_bits</code> uses <code>transmute</code> to skip the inversion which keeps it a nop. But that also means that ordering has now flipped. In other words, higher indices are considered less than lower indices. I don’t think that’s a problem, but it’s also worth mentioning.<h2 id=alternatives>Alternatives</h2><p>We could keep the index as a u32 type and just document that <code>u32::MAX</code> is invalid, modifying <code>Entities</code> to ensure it never gets handed out. (But that’s not enforced by the type system.) We could still take advantage of the niche here in <code>ComponentSparseSet</code>. We’d just need some unsafe manual conversions, which is probably fine, but opens up the possibility for correctness problems later.<p>We could change <code>Entities</code> to fully support the <code>u32::MAX</code> index. (But that makes <code>Entities</code> more complex and potentially slightly slower.)<h2 id=testing>Testing</h2><ul><li>CI<li>A few tests were changed because they depend on different ordering and <code>to_bits</code> values.</ul><h2 id=future-work>Future Work</h2><ul><li>It might be worth removing the niche on <code>Entity::generation</code> since there is now a different niche.<li>We could move <code>Entity::generation</code> into it’s own type too for clarity.<li>We should change <code>ComponentSparseSet</code> to take advantage of the new niche. (This PR doesn’t change that yet.)<li>Consider removing or updating <code>Identifier</code>. This is only used for <code>Entity</code>, so it might be worth combining since <code>Entity</code> is now more unique.</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=the-problem-and-context>The Problem and Context</h3><p>The Entity Component System (ECS) faced two core issues related to entity indexing. First, using <code>u32</code> for entity indices created an awkward situation where <code>u32::MAX + 1</code> possible entities existed. This caused problems with batch reservation logic that couldn’t handle the full range of <code>u32</code> values. Second, memory usage in sparse sets was suboptimal because <code>Option&LTu32></code> index storage required 64 bits per entry.<h3 id=the-solution-approach>The Solution Approach</h3><p>The PR introduces <code>EntityRow</code>, a new type wrapping <code>NonMaxU32</code>, to replace raw <code>u32</code> indices in entity handling. This approach:<ol><li>Prohibits <code>u32::MAX</code> as a valid index through type constraints<li>Enables niche optimization for <code>Option&LTEntityRow></code>, halving memory usage in sparse sets<li>Simplifies entity allocation logic by eliminating edge cases around maximum index values</ol><h3 id=the-implementation>The Implementation</h3><p>The core changes occur in <code>crates/bevy_ecs/src/entity/mod.rs</code>, where the <code>Entity</code> struct was refactored to use <code>EntityRow</code> instead of raw <code>u32</code>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>Entity </span><span>{
</span><span>    index</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u32</span><span>,
</span><span>    generation</span><span style=color:#61676ccc>: </span><span>NonZero<</span><span style=color:#fa6e32>u32</span><span>>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>Entity </span><span>{
</span><span>    row</span><span style=color:#61676ccc>:</span><span> EntityRow,
</span><span>    generation</span><span style=color:#61676ccc>: </span><span>NonZero<</span><span style=color:#fa6e32>u32</span><span>>,
</span><span>}
</span><span>
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>repr</span><span>(transparent)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>EntityRow</span><span>(NonMaxU32)</span><span style=color:#61676ccc>;
</span></code></pre><p>Key implementation details:<ul><li><code>Entity::from_raw</code> now takes <code>EntityRow</code> instead of <code>u32</code><li>Added <code>Entity::from_raw_u32</code> returning <code>Option&LTEntity></code> for safe conversion<li>Updated comparison operators to account for inverted ordering from <code>NonMaxU32</code> bit patterns</ul><h3 id=technical-insights>Technical Insights</h3><p>The use of <code>NonMaxU32</code> provides two critical benefits:<ol><li><strong>Memory Optimization</strong>: <code>Option&LTEntityRow></code> uses 32 bits instead of 64 due to niche optimization (since <code>NonMaxU32</code> can’t be <code>u32::MAX</code>, that value becomes the <code>None</code> representation)<li><strong>Type Safety</strong>: Invalid indices (<code>u32::MAX</code>) are excluded at the type level</ol><p>The ordering inversion occurs because <code>NonMaxU32</code> stores values as <code>!u32</code> to utilize the niche. This means higher numeric indices compare as smaller values, which required updates to tests relying on specific entity order.<h3 id=the-impact>The Impact</h3><ul><li><strong>Memory Savings</strong>: Sparse set storage for entity indices uses 50% less memory<li><strong>Safer Entity Handling</strong>: Invalid indices are prevented at compile time<li><strong>API Changes</strong>: Entity creation patterns require adjustment (see migration guide)<li><strong>Performance</strong>: Minimal instruction count increase from bitwise operations, offset by memory savings</ul><h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[Entity] --> B[EntityRow]
</span><span>    B --> C[NonMaxU32]
</span><span>    C --> D[Memory Optimization]
</span><span>    A --> E[Generation]
</span><span>    D --> F[SparseSet Efficiency]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ecs-src-entity-mod-rs-295-88><code>crates/bevy_ecs/src/entity/mod.rs</code> (+295/-88)</h3><p>Core entity handling logic updated to use <code>EntityRow</code>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Key change in Entity definition
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(target_endian </span><span style=color:#ed9366>= </span><span style=color:#86b300>"little"</span><span>)]
</span><span>row</span><span style=color:#61676ccc>:</span><span> EntityRow</span><span style=color:#61676ccc>,
</span><span>generation</span><span style=color:#61676ccc>: </span><span>NonZero<</span><span style=color:#fa6e32>u32</span><span>></span><span style=color:#61676ccc>,
</span></code></pre><p>Added <code>EntityRow</code> type and conversion methods:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Clone</span><span style=color:#61676ccc>,</span><span> Copy</span><span style=color:#61676ccc>,</span><span> PartialEq</span><span style=color:#61676ccc>,</span><span> Eq</span><span style=color:#61676ccc>,</span><span> PartialOrd</span><span style=color:#61676ccc>,</span><span> Ord</span><span style=color:#61676ccc>,</span><span> Hash</span><span style=color:#61676ccc>,</span><span> Debug</span><span style=color:#61676ccc>,</span><span> Display)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>EntityRow</span><span>(NonMaxU32)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>impl </span><span style=color:#399ee6>EntityRow </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub const fn </span><span style=color:#f29718>new</span><span>(</span><span style=color:#ff8f40>index</span><span style=color:#61676ccc>:</span><span> NonMaxU32) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>        </span><span style=color:#fa6e32>Self</span><span>(index)
</span><span>    }
</span><span>    
</span><span>    </span><span style=color:#fa6e32>pub const fn </span><span style=color:#f29718>index</span><span>(</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>u32 </span><span>{
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0.</span><span style=color:#f07171>get</span><span>()
</span><span>    }
</span><span>}
</span></code></pre><h3 id=benches-benches-bevy-ecs-world-world-get-rs-24-8><code>benches/benches/bevy_ecs/world/world_get.rs</code> (+24/-8)</h3><p>Updated benchmark entity creation:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> entity </span><span style=color:#ed9366>= </span><span>Entity</span><span style=color:#ed9366>::</span><span>from_raw(i)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> entity </span><span style=color:#ed9366>= </span><span>Entity</span><span style=color:#ed9366>::</span><span>from_raw(EntityRow</span><span style=color:#ed9366>::</span><span>new(
</span><span>    </span><span style=color:#fa6e32>unsafe </span><span>{ NonMaxU32</span><span style=color:#ed9366>::</span><span>new_unchecked(i) }
</span><span>))</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=release-content-migration-guides-make-entity-index-non-max-md-25-0><code>release-content/migration-guides/make_entity_index_non_max.md</code> (+25/-0)</h3><p>New migration guide explaining:<ul><li><code>Entity::from_raw</code> signature change<li>Ordering behavior changes<li>Replacement patterns for manual entity creation</ul><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/nonmax/latest/nonmax/struct.NonMaxU32.html target=_blank>NonMaxU32 documentation</a><li><a rel="noopener nofollow noreferrer" href=https://rust-lang.github.io/unsafe-code-guidelines/layout/enums.html#niche-optimizations target=_blank>Rust niche optimization</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/implementation-notes/ecs-internals/ target=_blank>ECS sparse set internals</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-05/pr_18704.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>