<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19147 fix distinct directional lights per view
        
    </title><meta content="#19147 fix distinct directional lights per view" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-05/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-05-30</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-05/pr-19147-zh-cn-20250530>中文</a></div></div><div class=pr-content><h1 id=analysis-of-pr-19147-fix-distinct-directional-lights-per-view>Analysis of PR #19147: fix distinct directional lights per view</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: fix distinct directional lights per view<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19147<li><strong>Author</strong>: robtfm<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, S-Ready-For-Final-Review, D-Straightforward<li><strong>Created</strong>: 2025-05-09T18:05:15Z<li><strong>Merged</strong>: 2025-05-30T19:56:18Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=the-problem-and-context>The Problem and Context</h3><p>After PR #15156, directional lights assigned to different views via render layers weren’t functioning correctly. The core issue involved how shadow map texture indices were allocated and assigned across views. The system allocated texture layers based on the total number of cascades across all lights, regardless of which views actually used them. This caused two main problems:<ol><li><strong>Incorrect shadow rendering</strong>: When multiple views used different directional lights, they would render shadow maps to the wrong texture indices while sampling from incorrect base indices<li><strong>Inefficient resource usage</strong>: Texture layers were allocated for lights that weren’t visible in a view, including lights with shadows disabled</ol><p>The problem manifested clearly in split-screen scenarios where each view had its own directional light. Without this fix, only one view would display correct shadows while the others showed incorrect or missing shadows.<h3 id=the-solution-approach>The Solution Approach</h3><p>The author implemented a more efficient per-view allocation strategy with these key changes:<ol><li>Pre-calculate the maximum number of cascades any single view will need<li>Allocate texture array layers based on this view maximum rather than the global total<li>Build the <code>GpuDirectionalLight</code> array per-view instead of globally<li>Assign texture indices sequentially within each view’s allocation<li>Remove the <code>skip</code> field since per-view construction eliminates unused lights</ol><p>This approach ensures each view:<ul><li>Only considers lights that intersect its render layers<li>Uses contiguous texture indices starting from 0 for its shadow maps<li>Doesn’t waste resources on lights not visible in the view</ul><p>The solution balances correctness with efficiency while maintaining the same maximum number of directional lights per view (<code>max_texture_array_layers / MAX_CASCADES_PER_LIGHT</code>).<h3 id=the-implementation>The Implementation</h3><p>The core changes occur in <code>light.rs</code> with supporting modifications in WGSL shaders. The implementation follows these steps:<p><strong>1. Precompute maximum cascades per view:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let mut</span><span> num_directional_cascades_enabled </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0</span><span style=color:#fa6e32>usize</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>for </span><span style=color:#ed9366>... in</span><span> sorted_cameras </span><span style=color:#ed9366>... </span><span>{
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> num_directional_cascades_for_this_view </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0</span><span style=color:#fa6e32>usize</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> render_layers </span><span style=color:#ed9366>=</span><span> maybe_layers</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_or_default</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#fa6e32>for </span><span style=color:#ed9366>... in</span><span> directional_lights</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>() {
</span><span>        </span><span style=color:#fa6e32>if</span><span> light</span><span style=color:#ed9366>.</span><span>shadows_enabled </span><span style=color:#ed9366>&&</span><span> light</span><span style=color:#ed9366>.</span><span>render_layers</span><span style=color:#ed9366>.</span><span style=color:#f07171>intersects</span><span>(render_layers) {
</span><span>            num_directional_cascades_for_this_view </span><span style=color:#ed9366>+=</span><span> light
</span><span>                </span><span style=color:#ed9366>.</span><span>cascade_shadow_config
</span><span>                </span><span style=color:#ed9366>.</span><span>bounds
</span><span>                </span><span style=color:#ed9366>.</span><span style=color:#f07171>len</span><span>()
</span><span>                </span><span style=color:#ed9366>.</span><span style=color:#f07171>min</span><span>(</span><span style=color:#ff8f40>MAX_CASCADES_PER_LIGHT</span><span>)</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>    }
</span><span>
</span><span>    num_directional_cascades_enabled </span><span style=color:#ed9366>=</span><span> num_directional_cascades_enabled
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>max</span><span>(num_directional_cascades_for_this_view)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>min</span><span>(max_texture_array_layers)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p><strong>2. Per-view directional light processing:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let mut</span><span> gpu_directional_lights </span><span style=color:#ed9366>= </span><span>[GpuDirectionalLight</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>; </span><span style=color:#ff8f40>MAX_DIRECTIONAL_LIGHTS</span><span>]</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let mut</span><span> num_directional_cascades_enabled_for_this_view </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0</span><span style=color:#fa6e32>usize</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let mut</span><span> num_directional_lights_for_this_view </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0</span><span style=color:#fa6e32>usize</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>for </span><span>(index</span><span style=color:#61676ccc>, </span><span>(_light_entity</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>_</span><span style=color:#61676ccc>,</span><span> light)) </span><span style=color:#ed9366>in</span><span> directional_lights
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>filter</span><span>(|(_</span><span style=color:#61676ccc>,</span><span> _</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>light</span><span>)| light</span><span style=color:#ed9366>.</span><span>render_layers</span><span style=color:#ed9366>.</span><span style=color:#f07171>intersects</span><span>(view_layers))
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>enumerate</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>take</span><span>(</span><span style=color:#ff8f40>MAX_DIRECTIONAL_LIGHTS</span><span>)
</span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... light processing ...
</span><span>    
</span><span>    gpu_directional_lights[index] </span><span style=color:#ed9366>=</span><span> GpuDirectionalLight {
</span><span>        cascades</span><span style=color:#61676ccc>: </span><span>[GpuDirectionalCascade</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>; </span><span style=color:#ff8f40>MAX_CASCADES_PER_LIGHT</span><span>]</span><span style=color:#61676ccc>,
</span><span>        color</span><span style=color:#61676ccc>: </span><span>Vec4</span><span style=color:#ed9366>::</span><span>from_slice(</span><span style=color:#ed9366>&</span><span>light</span><span style=color:#ed9366>.</span><span>color</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_f32_array</span><span>()) </span><span style=color:#ed9366>*</span><span> light</span><span style=color:#ed9366>.</span><span>illuminance</span><span style=color:#61676ccc>,
</span><span>        dir_to_light</span><span style=color:#61676ccc>:</span><span> light</span><span style=color:#ed9366>.</span><span>transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>back</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()</span><span style=color:#61676ccc>,
</span><span>        flags</span><span style=color:#61676ccc>:</span><span> flags</span><span style=color:#ed9366>.</span><span style=color:#f07171>bits</span><span>()</span><span style=color:#61676ccc>,
</span><span>        soft_shadow_size</span><span style=color:#61676ccc>:</span><span> light</span><span style=color:#ed9366>.</span><span>soft_shadow_size</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_or_default</span><span>()</span><span style=color:#61676ccc>,
</span><span>        shadow_depth_bias</span><span style=color:#61676ccc>:</span><span> light</span><span style=color:#ed9366>.</span><span>shadow_depth_bias</span><span style=color:#61676ccc>,
</span><span>        shadow_normal_bias</span><span style=color:#61676ccc>:</span><span> light</span><span style=color:#ed9366>.</span><span>shadow_normal_bias</span><span style=color:#61676ccc>,
</span><span>        num_cascades</span><span style=color:#61676ccc>:</span><span> num_cascades </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>u32</span><span style=color:#61676ccc>,
</span><span>        cascades_overlap_proportion</span><span style=color:#61676ccc>:</span><span> light</span><span style=color:#ed9366>.</span><span>cascade_shadow_config</span><span style=color:#ed9366>.</span><span>overlap_proportion</span><span style=color:#61676ccc>,
</span><span>        depth_texture_base_index</span><span style=color:#61676ccc>:</span><span> num_directional_cascades_enabled_for_this_view </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>u32</span><span style=color:#61676ccc>,
</span><span>    }</span><span style=color:#61676ccc>;
</span><span>    num_directional_cascades_enabled_for_this_view </span><span style=color:#ed9366>+=</span><span> num_cascades</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p><strong>3. Removal of skip field:</strong> The <code>skip</code> field was removed from both Rust and WGSL structs since per-view construction eliminates the need for it:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>GpuDirectionalLight </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>    depth_texture_base_index</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u32</span><span>,
</span><span>    skip</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u32</span><span>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>GpuDirectionalLight </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>    depth_texture_base_index</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u32</span><span>,
</span><span>}
</span></code></pre><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before
</span><span>struct DirectionalLight {
</span><span>    // ...
</span><span>    depth_texture_base_index: u32,
</span><span>    skip: u32,
</span><span>};
</span><span>
</span><span>// After
</span><span>struct DirectionalLight {
</span><span>    // ...
</span><span>    depth_texture_base_index: u32,
</span><span>};
</span></code></pre><h3 id=technical-insights>Technical Insights</h3><p>Key technical aspects of this solution:<ol><li><strong>Per-view resource management</strong>: By building light data per view, we ensure texture indices are view-local and consistent between shadow map rendering and sampling<li><strong>Efficient texture allocation</strong>: Using the maximum per-view cascade count minimizes VRAM usage while guaranteeing sufficient space for all views<li><strong>Render layer filtering</strong>: Early filtering by <code>render_layers.intersects()</code> avoids processing irrelevant lights<li><strong>Simplified shader logic</strong>: Removing the <code>skip</code> field eliminates a conditional check in the lighting shader</ol><p>The solution maintains backward compatibility while fixing both functional and efficiency issues. The per-view approach also naturally extends to future cases with more complex light/view relationships.<h3 id=the-impact>The Impact</h3><p>These changes provide:<ol><li><strong>Correct rendering</strong>: Directional lights now work correctly across multiple views with different render layers<li><strong>Reduced VRAM usage</strong>: Texture memory is allocated based on per-view needs rather than global totals<li><strong>CPU efficiency</strong>: Avoids processing lights that aren’t visible in a view<li><strong>Cleaner code</strong>: Removal of the <code>skip</code> field simplifies both Rust and shader code</ol><p>The solution was validated using a modified split-screen example that placed separate directional lights on different render layers. Without the fix, directional shadows only rendered correctly in one view; with the fix, all views displayed correct shadows for their respective lights.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Global Light Processing] --> B[Problem: Incorrect texture indices]
</span><span>    C[Per-View Light Processing] --> D[Solution: Correct texture indices]
</span><span>    E[Original Approach] --> A
</span><span>    F[New Approach] --> C
</span><span>    G[Shadow Rendering] -->|Before| A
</span><span>    G -->|After| C
</span><span>    H[Shadow Sampling] -->|Before| A
</span><span>    H -->|After| C
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-pbr-src-render-light-rs>crates/bevy_pbr/src/render/light.rs</h3><p>Significant restructuring of directional light processing:<ol><li>Added precomputation of maximum cascades per view<li>Moved directional light processing into view loop<li>Removed skip field from GpuDirectionalLight<li>Added per-view filtering by render layers</ol><p>Key changes:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Global directional light processing
</span><span style=color:#fa6e32>let mut</span><span> gpu_directional_lights </span><span style=color:#ed9366>= </span><span>[GpuDirectionalLight</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>; </span><span style=color:#ff8f40>MAX_DIRECTIONAL_LIGHTS</span><span>]</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let mut</span><span> num_directional_cascades_enabled </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0</span><span style=color:#fa6e32>usize</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>for </span><span>(index</span><span style=color:#61676ccc>, </span><span>(_light_entity</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>_</span><span style=color:#61676ccc>,</span><span> light)) </span><span style=color:#ed9366>in</span><span> directional_lights</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>enumerate</span><span>() {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... process all lights globally ...
</span><span>    gpu_directional_lights[index] </span><span style=color:#ed9366>=</span><span> GpuDirectionalLight {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>        depth_texture_base_index</span><span style=color:#61676ccc>:</span><span> num_directional_cascades_enabled </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>u32</span><span style=color:#61676ccc>,
</span><span>        skip</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>0</span><span style=color:#fa6e32>u32</span><span style=color:#61676ccc>,
</span><span>    }</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Per-view directional light processing
</span><span style=color:#fa6e32>let mut</span><span> num_directional_cascades_enabled </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0</span><span style=color:#fa6e32>usize</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>for </span><span style=color:#ed9366>... in</span><span> views { </span><span style=color:#abb0b6;font-style:italic>// Precompute max cascades
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Calculate per-view cascade count
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Inside view loop:
</span><span style=color:#fa6e32>let mut</span><span> gpu_directional_lights </span><span style=color:#ed9366>= </span><span>[GpuDirectionalLight</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>; </span><span style=color:#ff8f40>MAX_DIRECTIONAL_LIGHTS</span><span>]</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let mut</span><span> num_directional_cascades_enabled_for_this_view </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0</span><span style=color:#fa6e32>usize</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>for </span><span>(index</span><span style=color:#61676ccc>, </span><span>(_light_entity</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>_</span><span style=color:#61676ccc>,</span><span> light)) </span><span style=color:#ed9366>in</span><span> directional_lights
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>filter</span><span>(|(_</span><span style=color:#61676ccc>,</span><span> _</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>light</span><span>)| light</span><span style=color:#ed9366>.</span><span>render_layers</span><span style=color:#ed9366>.</span><span style=color:#f07171>intersects</span><span>(view_layers))
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>enumerate</span><span>()
</span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... process only relevant lights ...
</span><span>    gpu_directional_lights[index] </span><span style=color:#ed9366>=</span><span> GpuDirectionalLight {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>        depth_texture_base_index</span><span style=color:#61676ccc>:</span><span> num_directional_cascades_enabled_for_this_view </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>u32</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// skip field removed
</span><span>    }</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=crates-bevy-pbr-src-render-mesh-view-types-wgsl>crates/bevy_pbr/src/render/mesh_view_types.wgsl</h3><p>Removed skip field from directional light struct:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before
</span><span>struct DirectionalLight {
</span><span>    // ...
</span><span>    depth_texture_base_index: u32,
</span><span>    skip: u32,
</span><span>};
</span><span>
</span><span>// After
</span><span>struct DirectionalLight {
</span><span>    // ...
</span><span>    depth_texture_base_index: u32,
</span><span>};
</span></code></pre><h3 id=crates-bevy-pbr-src-render-pbr-functions-wgsl>crates/bevy_pbr/src/render/pbr_functions.wgsl</h3><p>Removed skip check in directional light processing:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before
</span><span>let light = &view_bindings::lights.directional_lights[i];
</span><span>if (*light).skip != 0u {
</span><span>    continue;
</span><span>}
</span><span>
</span><span>// After
</span><span>let light = &view_bindings::lights.directional_lights[i];
</span><span>// Skip check removed
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/render/view/struct.RenderLayers.html target=_blank>Bevy Render Layers Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/next/features/rendering/lighting/ target=_blank>Bevy Lighting System Overview</a><li><a rel="noopener nofollow noreferrer" href=https://www.w3.org/TR/WGSL/ target=_blank>WGSL Shader Language Specification</a><li><a rel="noopener nofollow noreferrer" href=https://learnopengl.com/Advanced-OpenGL/Texture-Arrays target=_blank>Texture Arrays in Modern Rendering</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-05/pr_19147.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>