<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19387 Add `insert_if_new` test for sparse set.
        
    </title><meta content="#19387 Add `insert_if_new` test for sparse set." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-05/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-05-27</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-05/pr-19387-zh-cn-20250527>中文</a></div></div><div class=pr-content><h1 id=add-insert-if-new-test-for-sparse-set>Add <code>insert_if_new</code> test for sparse set</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Add <code>insert_if_new</code> test for sparse set.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19387<li><strong>Author</strong>: AlephCubed<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: D-Trivial, A-ECS, C-Code-Quality, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-05-26T22:39:38Z<li><strong>Merged</strong>: 2025-05-27T03:37:12Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>Fixes #19081. Simply created a duplicate of the existing <code>insert_if_new</code> test, but using sparse sets.<h2 id=testing>Testing:</h2><p>The test passes on main, but fails if #19059 is reverted.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a gap in test coverage for Bevy’s Entity Component System (ECS) when working with sparse set storage. The core issue (#19081) involved potential regressions in the <code>insert_if_new</code> method’s behavior with sparse components, which was previously fixed in #19059 but lacked proper test validation.<p>The existing test for <code>insert_if_new</code> only verified behavior with default table storage components. However, Bevy’s ECS supports multiple storage types, and sparse sets require separate validation due to their different implementation characteristics. Sparse sets (稀疏集) optimize for components that are frequently added/removed or have many optional instances, using indirect lookup tables rather than dense arrays.<p>The solution replicates the existing test pattern but applies it to sparse components:<ol><li>Created test components annotated with <code>#[component(storage = "SparseSet")]</code><li>Constructed an entity with initial sparse components<li>Verified <code>insert_if_new</code> prevents overwrites while allowing new component additions</ol><p>Key implementation details from the test:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component</span><span style=color:#61676ccc>,</span><span> Debug</span><span style=color:#61676ccc>,</span><span> Eq</span><span style=color:#61676ccc>,</span><span> PartialEq)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>component</span><span>(storage </span><span style=color:#ed9366>= </span><span style=color:#86b300>"SparseSet"</span><span>)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>SparseV</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'static str</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>sparse_set_insert_if_new</span><span>() {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> world </span><span style=color:#ed9366>= </span><span>World</span><span style=color:#ed9366>::</span><span>new()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> id </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>(SparseV(</span><span style=color:#86b300>"one"</span><span>))</span><span style=color:#ed9366>.</span><span style=color:#f07171>id</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> entity </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity_mut</span><span>(id)</span><span style=color:#61676ccc>;
</span><span>    entity</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_if_new</span><span>(SparseV(</span><span style=color:#86b300>"two"</span><span>))</span><span style=color:#61676ccc>;  </span><span style=color:#abb0b6;font-style:italic>// Should be ignored
</span><span>    entity</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_if_new</span><span>((SparseA</span><span style=color:#61676ccc>,</span><span> SparseV(</span><span style=color:#86b300>"three"</span><span>)))</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// Adds SparseA
</span><span>    entity</span><span style=color:#ed9366>.</span><span style=color:#f07171>flush</span><span>()</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#fa6e32>let</span><span> entity </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(id)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#f07171>assert!</span><span>(entity</span><span style=color:#ed9366>.</span><span>contains</span><span style=color:#ed9366>::</span><span>&LTSparseA>())</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#f07171>assert_eq!</span><span>(entity</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>()</span><span style=color:#61676ccc>, </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#ed9366>&</span><span>SparseV(</span><span style=color:#86b300>"one"</span><span>)))</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>This test ensures:<ul><li>Existing sparse components aren’t overwritten<li>New sparse components are properly added<li>Tuple insertion works with mixed component states</ul><p>The test’s value is demonstrated by its failure when reverting #19059, proving it effectively guards against regressions. This approach follows Bevy’s established testing patterns while extending coverage to critical sparse set functionality.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[insert_if_new Test] --> B[Table Storage]
</span><span>    A --> C[Sparse Storage]
</span><span>    C --> D[Prevent Overwrite]
</span><span>    C --> E[Add New Components]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ul><li><code>crates/bevy_ecs/src/bundle.rs</code> (+22/-0)</ul><p>Added test case for sparse set component insertion logic:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// New test components
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component</span><span style=color:#61676ccc>,</span><span> Debug</span><span style=color:#61676ccc>,</span><span> Eq</span><span style=color:#61676ccc>,</span><span> PartialEq)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>component</span><span>(storage </span><span style=color:#ed9366>= </span><span style=color:#86b300>"SparseSet"</span><span>)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>SparseV</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'static str</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component</span><span style=color:#61676ccc>,</span><span> Debug</span><span style=color:#61676ccc>,</span><span> Eq</span><span style=color:#61676ccc>,</span><span> PartialEq)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>component</span><span>(storage </span><span style=color:#ed9366>= </span><span style=color:#86b300>"SparseSet"</span><span>)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>SparseA</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Test implementation
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>sparse_set_insert_if_new</span><span>() {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... test setup and assertions ...
</span><span>}
</span></code></pre><p>This change directly extends test coverage to match sparse set behavior with existing table storage tests.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/ecs-storage/ target=_blank>Bevy ECS Storage Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/book/ch11-03-test-organization.html target=_blank>Rust Test Organization</a><li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/programming/storages.html target=_blank>Component Storage Comparison</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-05/pr_19387.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>