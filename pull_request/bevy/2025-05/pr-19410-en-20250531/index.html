<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19410 Add `resize_in_place` to `Image`
        
    </title><meta content="#19410 Add `resize_in_place` to `Image`" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-05/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-05-31</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-05/pr-19410-zh-cn-20250531>中文</a></div></div><div class=pr-content><h2 id=title-add-resize-in-place-to-image>Title: Add <code>resize_in_place</code> to <code>Image</code></h2><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Add <code>resize_in_place</code> to <code>Image</code><li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19410<li><strong>Author</strong>: rparrett<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Feature, A-Rendering, C-Performance, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-05-28T14:02:02Z<li><strong>Merged</strong>: 2025-05-31T22:15:39Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=the-problem-and-context>The Problem and Context</h3><p>The font atlas system in Bevy creates a new 512x512 texture atlas each time one fills up. With large font sizes and many glyphs, this causes glyphs to spread across multiple textures, reducing rendering efficiency. Batching performance suffers when text draws require switching between multiple textures. The existing <code>AtlasAllocator</code> supports growing atlases, but Bevy lacked a way to resize textures while preserving pixel data. The <code>Image::resize()</code> method only pads or truncates image data with zeros, destroying existing content.<h3 id=the-solution-approach>The Solution Approach</h3><p>We added a <code>resize_in_place()</code> method to the <code>Image</code> type that preserves existing pixel data when resizing. The implementation copies valid pixel regions from the original image to a new buffer, anchoring content at the top-left corner. New areas are filled with zeros (typically transparent pixels). The method supports both 2D textures and texture arrays (3D).<h3 id=the-implementation>The Implementation</h3><p>The core implementation calculates copy regions based on minimum dimensions between old and new sizes. It handles texture stride calculations and copies pixel rows layer-by-layer:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>resize_in_place</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>new_size</span><span style=color:#61676ccc>:</span><span> Extent3d) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><(), ResizeError> {
</span><span>    </span><span style=color:#fa6e32>let</span><span> old_size </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>texture_descriptor</span><span style=color:#ed9366>.</span><span>size</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> pixel_size </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>texture_descriptor</span><span style=color:#ed9366>.</span><span>format</span><span style=color:#ed9366>.</span><span style=color:#f07171>pixel_size</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> byte_len </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>texture_descriptor</span><span style=color:#ed9366>.</span><span>format</span><span style=color:#ed9366>.</span><span style=color:#f07171>pixel_size</span><span>() </span><span style=color:#ed9366>*</span><span> new_size</span><span style=color:#ed9366>.</span><span style=color:#f07171>volume</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#fa6e32>ref mut</span><span> data) </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>data </span><span style=color:#fa6e32>else </span><span>{
</span><span>        </span><span style=color:#fa6e32>return </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(ResizeError</span><span style=color:#ed9366>::</span><span>ImageWithoutData)</span><span style=color:#61676ccc>;
</span><span>    }</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> new</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Vec</span><span><</span><span style=color:#fa6e32>u8</span><span>> </span><span style=color:#ed9366>= </span><span style=color:#f07171>vec!</span><span>[</span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;</span><span> byte_len]</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Calculate copy dimensions
</span><span>    </span><span style=color:#fa6e32>let</span><span> copy_width </span><span style=color:#ed9366>=</span><span> old_size</span><span style=color:#ed9366>.</span><span>width</span><span style=color:#ed9366>.</span><span style=color:#f07171>min</span><span>(new_size</span><span style=color:#ed9366>.</span><span>width) </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>usize</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> copy_height </span><span style=color:#ed9366>=</span><span> old_size</span><span style=color:#ed9366>.</span><span>height</span><span style=color:#ed9366>.</span><span style=color:#f07171>min</span><span>(new_size</span><span style=color:#ed9366>.</span><span>height) </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>usize</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> copy_depth </span><span style=color:#ed9366>=</span><span> old_size
</span><span>        </span><span style=color:#ed9366>.</span><span>depth_or_array_layers
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>min</span><span>(new_size</span><span style=color:#ed9366>.</span><span>depth_or_array_layers) </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>usize</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Stride calculations
</span><span>    </span><span style=color:#fa6e32>let</span><span> old_row_stride </span><span style=color:#ed9366>=</span><span> old_size</span><span style=color:#ed9366>.</span><span>width </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>usize </span><span style=color:#ed9366>*</span><span> pixel_size</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> old_layer_stride </span><span style=color:#ed9366>=</span><span> old_size</span><span style=color:#ed9366>.</span><span>height </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>usize </span><span style=color:#ed9366>*</span><span> old_row_stride</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> new_row_stride </span><span style=color:#ed9366>=</span><span> new_size</span><span style=color:#ed9366>.</span><span>width </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>usize </span><span style=color:#ed9366>*</span><span> pixel_size</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> new_layer_stride </span><span style=color:#ed9366>=</span><span> new_size</span><span style=color:#ed9366>.</span><span>height </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>usize </span><span style=color:#ed9366>*</span><span> new_row_stride</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Copy pixel data
</span><span>    </span><span style=color:#fa6e32>for</span><span> z </span><span style=color:#ed9366>in </span><span style=color:#ff8f40>0</span><span style=color:#ed9366>..</span><span>copy_depth {
</span><span>        </span><span style=color:#fa6e32>for</span><span> y </span><span style=color:#ed9366>in </span><span style=color:#ff8f40>0</span><span style=color:#ed9366>..</span><span>copy_height {
</span><span>            </span><span style=color:#fa6e32>let</span><span> old_offset </span><span style=color:#ed9366>=</span><span> z </span><span style=color:#ed9366>*</span><span> old_layer_stride </span><span style=color:#ed9366>+</span><span> y </span><span style=color:#ed9366>*</span><span> old_row_stride</span><span style=color:#61676ccc>;
</span><span>            </span><span style=color:#fa6e32>let</span><span> new_offset </span><span style=color:#ed9366>=</span><span> z </span><span style=color:#ed9366>*</span><span> new_layer_stride </span><span style=color:#ed9366>+</span><span> y </span><span style=color:#ed9366>*</span><span> new_row_stride</span><span style=color:#61676ccc>;
</span><span>            </span><span style=color:#fa6e32>let</span><span> old_range </span><span style=color:#ed9366>= </span><span>(old_offset)</span><span style=color:#ed9366>..</span><span>(old_offset </span><span style=color:#ed9366>+</span><span> copy_width </span><span style=color:#ed9366>*</span><span> pixel_size)</span><span style=color:#61676ccc>;
</span><span>            </span><span style=color:#fa6e32>let</span><span> new_range </span><span style=color:#ed9366>= </span><span>(new_offset)</span><span style=color:#ed9366>..</span><span>(new_offset </span><span style=color:#ed9366>+</span><span> copy_width </span><span style=color:#ed9366>*</span><span> pixel_size)</span><span style=color:#61676ccc>;
</span><span>            new[new_range]</span><span style=color:#ed9366>.</span><span style=color:#f07171>copy_from_slice</span><span>(</span><span style=color:#ed9366>&</span><span>data[old_range])</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>data </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(new)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>texture_descriptor</span><span style=color:#ed9366>.</span><span>size </span><span style=color:#ed9366>=</span><span> new_size</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(())
</span><span>}
</span></code></pre><h3 id=technical-insights>Technical Insights</h3><p>Key aspects:<ol><li><strong>Memory Safety</strong>: Explicitly handles texture format pixel sizes to prevent buffer overflows<li><strong>Efficiency</strong>: Copies contiguous memory ranges instead of pixel-by-pixel<li><strong>Error Handling</strong>: Introduces <code>ResizeError::ImageWithoutData</code> for images without CPU-side data<li><strong>API Design</strong>: Complements existing <code>resize()</code> method with clear documentation about their different use cases</ol><h3 id=the-impact>The Impact</h3><p>This enables efficient font atlas resizing without recreating textures. For a 512x512 RGBA texture, resizing avoids re-uploading 1MB of texture data to the GPU. The change also benefits other systems needing to preserve pixel data during resizing operations. Two comprehensive tests validate functionality for both 2D and 3D textures across grow/shrink operations.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Image] --> B[resize_in_place]
</span><span>    B --> C[Calculate copy regions]
</span><span>    C --> D[Create new buffer]
</span><span>    D --> E[Copy pixel data]
</span><span>    E --> F[Update image metadata]
</span><span>    F --> G[Success]
</span><span>    C --> H[Error: No CPU data]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-image-src-image-rs-225-0><code>crates/bevy_image/src/image.rs</code> (+225/-0)</h3><p><strong>Purpose</strong>: Implement <code>resize_in_place</code> functionality with tests<p><strong>Key Changes</strong>:<ol><li>New method implementation:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>/// Resizes the image to the new size, keeping the pixel data intact, anchored at the top-left.
</span><span style=color:#abb0b6;font-style:italic>/// When growing, the new space is filled with 0. When shrinking, the image is clipped.
</span><span style=color:#abb0b6;font-style:italic>///
</span><span style=color:#abb0b6;font-style:italic>/// For faster resizing when keeping pixel data intact is not important, use [`Image::resize`].
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>resize_in_place</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>new_size</span><span style=color:#61676ccc>:</span><span> Extent3d) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><(), ResizeError> {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Implementation as shown above
</span><span>}
</span></code></pre><ol start=2><li>New error type:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Error</span><span style=color:#61676ccc>,</span><span> Debug)]
</span><span style=color:#fa6e32>pub enum </span><span style=color:#399ee6>ResizeError </span><span>{
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>error</span><span>(</span><span style=color:#86b300>"resize method requires cpu-side image data but none was present"</span><span>)]
</span><span>    ImageWithoutData</span><span style=color:#61676ccc>,
</span><span>}
</span></code></pre><ol start=3><li>Comprehensive test cases:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>resize_in_place_2d_grow_and_shrink</span><span>() {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Tests 2D texture resizing with pattern validation
</span><span>}
</span><span>
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>resize_in_place_array_grow_and_shrink</span><span>() {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Tests 3D texture array resizing
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/render/texture/struct.TextureAtlas.html target=_blank>Bevy Texture Atlas Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://wgpu.rs/wgpu/texture/index.html target=_blank>WGPU Texture Concepts</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/gfx-rs/wgpu/wiki/Texture-Resizing-Tradeoffs target=_blank>Texture Resizing Techniques</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-05/pr_19410.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>