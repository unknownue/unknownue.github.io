<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #17253 Add a viewport UI widget
        
    </title><meta content="#17253 Add a viewport UI widget" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-05/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-05-05</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-05/pr-17253-zh-cn-20250505>中文</a></div></div><div class=pr-content><h1 id=add-a-viewport-ui-widget>Add a viewport UI widget</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Add a viewport UI widget<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/17253<li><strong>Author</strong>: chompaa<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Feature, A-UI, S-Ready-For-Final-Review, A-Editor, M-Needs-Release-Note, D-Modest, A-Picking<li><strong>Created</strong>: 2025-01-09T04:34:57Z<li><strong>Merged</strong>: 2025-05-05T23:18:37Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>The original PR description is already in English and preserved as-is.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=the-problem-and-context>The Problem and Context</h3><p>Modern game engines often require embedded viewports for features like level editors, picture-in-picture displays, or in-game surveillance systems. Bevy lacked a native solution for rendering camera outputs directly within UI elements while maintaining proper input handling. Developers previously needed custom implementations that didn’t integrate cleanly with Bevy’s existing UI and picking systems.<h3 id=the-solution-approach>The Solution Approach</h3><p>The implementation introduces three core components:<ol><li><strong>ViewportNode Component</strong>: Links UI nodes to camera outputs<li><strong>Input Forwarding System</strong>: Handles pointer events through viewports<li><strong>Dynamic Resolution Handling</strong>: Maintains render target size synchronization</ol><p>The architecture preserves Bevy’s existing ECS patterns while extending the UI system’s capabilities. Key design decisions included:<ul><li>Using dedicated pointer IDs for viewports to prevent input conflicts<li>Feature-gating picking functionality behind <code>bevy_ui_picking_backend</code><li>Implementing automatic render target resizing through a dedicated system</ul><h3 id=the-implementation>The Implementation</h3><p>The core implementation spans several systems:<p><strong>Viewport Node Definition</strong> (crates/bevy_ui/src/widget/viewport.rs):<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component</span><span style=color:#61676ccc>,</span><span> Debug</span><span style=color:#61676ccc>,</span><span> Clone</span><span style=color:#61676ccc>,</span><span> Copy</span><span style=color:#61676ccc>,</span><span> Reflect)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>ViewportNode </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>camera</span><span style=color:#61676ccc>:</span><span> Entity,
</span><span>}
</span></code></pre><p><strong>Input Handling</strong> (partial):<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>fn </span><span style=color:#f29718>viewport_picking</span><span>(...) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Calculate viewport boundaries
</span><span>    </span><span style=color:#fa6e32>let</span><span> node_rect </span><span style=color:#ed9366>= </span><span>Rect</span><span style=color:#ed9366>::</span><span>from_center_size(
</span><span>        global_transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>translation</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>truncate</span><span>()</span><span style=color:#61676ccc>,
</span><span>        computed_node</span><span style=color:#ed9366>.</span><span style=color:#f07171>size</span><span>()</span><span style=color:#61676ccc>,
</span><span>    )</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Transform pointer coordinates
</span><span>    </span><span style=color:#fa6e32>let</span><span> local_position </span><span style=color:#ed9366>= </span><span>(input</span><span style=color:#ed9366>.</span><span>location</span><span style=color:#ed9366>.</span><span>position </span><span style=color:#ed9366>-</span><span> top_left) </span><span style=color:#ed9366>/</span><span> logical_size</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> position </span><span style=color:#ed9366>=</span><span> local_position </span><span style=color:#ed9366>*</span><span> cam_viewport_size</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Forward transformed events
</span><span>    commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>send_event</span><span>(PointerInput {
</span><span>        location</span><span style=color:#61676ccc>,
</span><span>        pointer_id</span><span style=color:#61676ccc>:</span><span> viewport_pointer_id</span><span style=color:#61676ccc>,
</span><span>        action</span><span style=color:#61676ccc>:</span><span> input</span><span style=color:#ed9366>.</span><span>action</span><span style=color:#61676ccc>,
</span><span>    })</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p><strong>Render Target Resizing</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>fn </span><span style=color:#f29718>update_viewport_render_target_size</span><span>(...) {
</span><span>    </span><span style=color:#fa6e32>let</span><span> size </span><span style=color:#ed9366>=</span><span> Extent3d {
</span><span>        width</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u32</span><span style=color:#ed9366>::</span><span>max(</span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>,</span><span> size</span><span style=color:#ed9366>.</span><span>x </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>u32</span><span>)</span><span style=color:#61676ccc>,
</span><span>        height</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u32</span><span style=color:#ed9366>::</span><span>max(</span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>,</span><span> size</span><span style=color:#ed9366>.</span><span>y </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>u32</span><span>)</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#ed9366>..</span><span style=color:#f07171>default</span><span>()
</span><span>    }</span><span style=color:#61676ccc>;
</span><span>    images</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_mut</span><span>(image_handle)</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>resize</span><span>(size)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=technical-insights>Technical Insights</h3><p>Key technical considerations included:<ul><li><strong>Coordinate Transformation</strong>: Maintaining proper mapping between UI space and viewport camera space<li><strong>Input Propagation</strong>: Handling drag operations that start inside and continue outside viewports<li><strong>Performance</strong>: Minimizing overhead through conditional systems and efficient query filters<li><strong>Extensibility</strong>: Designing the ViewportNode to work with any Camera entity using image targets</ul><h3 id=the-impact>The Impact</h3><p>This implementation enables several new use cases:<ol><li>In-game editors with embedded 3D viewports<li>Security camera displays within UI<li>Picture-in-picture gameplay features<li>Multi-view rendering setups</ol><p>The system maintains compatibility with existing Bevy UI components and picking backends while adding approximately 300 lines of focused functionality.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[UI Node] --> B[ViewportNode Component]
</span><span>    B --> C{Camera Entity}
</span><span>    C --> D[Render Target Image]
</span><span>    D --> E[Viewport Rendering System]
</span><span>    E --> F[Pointer Input Handling]
</span><span>    F --> G[Coordinate Transformation]
</span><span>    G --> H[3D Scene Interaction]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ol><li><strong>crates/bevy_ui/src/widget/viewport.rs</strong> (+176/-0)</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component</span><span style=color:#61676ccc>,</span><span> Debug</span><span style=color:#61676ccc>,</span><span> Clone</span><span style=color:#61676ccc>,</span><span> Copy</span><span style=color:#61676ccc>,</span><span> Reflect)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>reflect</span><span>(Component</span><span style=color:#61676ccc>,</span><span> Debug)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>ViewportNode </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>camera</span><span style=color:#61676ccc>:</span><span> Entity,
</span><span>}
</span></code></pre><ul><li>Introduces core component linking UI nodes to cameras</ul><ol start=2><li><strong>examples/ui/viewport_node.rs</strong> (+148/-0)</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((
</span><span>    Node { </span><span style=color:#abb0b6;font-style:italic>/* Position/size */ </span><span>}</span><span style=color:#61676ccc>,
</span><span>    ViewportNode</span><span style=color:#ed9366>::</span><span>new(camera)
</span><span>))</span><span style=color:#ed9366>.</span><span style=color:#f07171>observe</span><span>(on_drag_viewport)</span><span style=color:#61676ccc>;
</span></code></pre><ul><li>Demonstrates viewport creation and interaction handling</ul><ol start=3><li><strong>crates/bevy_ui/src/render/mod.rs</strong> (+66/-1)</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>extract_viewport_nodes</span><span>(...) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Extracts viewport data for rendering
</span><span>    extracted_uinodes</span><span style=color:#ed9366>.</span><span>uinodes</span><span style=color:#ed9366>.</span><span style=color:#f07171>push</span><span>(ExtractedUiNode {
</span><span>        image</span><span style=color:#61676ccc>:</span><span> image</span><span style=color:#ed9366>.</span><span style=color:#f07171>id</span><span>()</span><span style=color:#61676ccc>,
</span><span>        extracted_camera_entity</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>    })</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><ul><li>Integrates viewports into Bevy’s render pipeline</ul><ol start=4><li><strong>release-content/release-notes/viewport-node.md</strong> (+22/-0)</ol><pre class=language-markdown data-lang=markdown style=color:#61676c;background-color:#fafafa><code class=language-markdown data-lang=markdown><span>Bevy UI now has a </span><span style=color:#ed9366;background-color:#61676c10>`ViewportNode`</span><span> component...
</span></code></pre><ul><li>Documents the new feature for end users</ul><ol start=5><li><strong>crates/bevy_ui/src/lib.rs</strong> (+17/-4)</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(First</span><span style=color:#61676ccc>, </span><span>widget</span><span style=color:#ed9366>::</span><span>viewport_picking</span><span style=color:#ed9366>.</span><span style=color:#f07171>in_set</span><span>(PickSet</span><span style=color:#ed9366>::</span><span>PostInput))
</span></code></pre><ul><li>Integrates viewport systems into Bevy’s main UI plugin</ul><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/features/ui/ target=_blank>Bevy UI Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/tree/main/crates/bevy_picking target=_blank>Bevy Picking System Overview</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/features/rendering/render-targets/ target=_blank>Render Targets in Bevy</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-05/pr_17253.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>