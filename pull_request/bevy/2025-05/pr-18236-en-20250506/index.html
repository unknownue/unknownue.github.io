<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18236 Let `FilteredEntity(Ref|Mut)` receive access when nested.
        
    </title><meta content="#18236 Let `FilteredEntity(Ref|Mut)` receive access when nested." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-05/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-05-06</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-05/pr-18236-zh-cn-20250506>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Let <code>FilteredEntity(Ref|Mut)</code> receive access when nested.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18236<li><strong>Author</strong>: chescock<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, C-Feature, A-ECS, S-Ready-For-Final-Review, D-Complex, X-Uncontroversial, D-Unsafe<li><strong>Created</strong>: 2025-03-10T18:16:41Z<li><strong>Merged</strong>: 2025-05-05T23:42:36Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Let <code>FilteredEntityRef</code> and <code>FilteredEntityMut</code> receive access when nested inside tuples or <code>#[derive(QueryData)]</code> types. Make sure to exclude any access that would conflict with other subqueries!<p>Fixes #14349<h2 id=solution>Solution</h2><p>Replace <code>WorldQuery::set_access(state, access)</code> with a new method, <code>QueryData::provide_extra_access(state, access, available_access)</code>, that passes both the total available access and the currently used access. This is called after <code>WorldQuery::update_component_access()</code>, so any access used by ordinary subqueries will be known. <code>FilteredEntityRef</code> and <code>FilteredEntityMut</code> can use the combination to determine how much access they can safely take, while tuples can safely pass those parameters directly to their subqueries.<p>This requires a new <code>Access::remove_conflicting_access()</code> method that can be used to remove any access that would conflict with existing access. Implementing this method was easier by first factoring some common set manipulation code out of <code>Access::extend</code>. I can extract that refactoring to a separate PR if desired.<p>Have <code>FilteredEntity(Ref|Mut)</code> store <code>Access</code> instead of <code>FilteredAccess</code> because they do not need to keep track of the filter. This was necessary in an early draft but no longer is. I left it in because it’s small and I’m touching that code anyway, but I can extract it to a separate PR if desired.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=the-problem-and-context>The Problem and Context</h3><p>The ECS system needed to handle nested <code>FilteredEntityRef</code> and <code>FilteredEntityMut</code> types in queries more effectively. Previous implementations couldn’t properly manage component access when these filtered entity types were nested within tuples or derived query data structures. This led to either overly restrictive access (preventing legitimate component interactions) or potential conflicts when multiple query elements accessed the same components.<p>The core challenge was ensuring dynamic access control:<ol><li>Filtered entities needed to claim available access without conflicting with other subqueries<li>Access calculations had to consider both existing claims and total available permissions<li>The solution needed to integrate with Bevy’s existing query composition patterns</ol><h3 id=the-solution-approach>The Solution Approach</h3><p>The implementation introduced a new <code>provide_extra_access</code> method in the <code>QueryData</code> trait, replacing the previous <code>set_access</code> approach. This method receives three critical pieces of information:<ul><li>Current query state<li>Accumulated access claims<li>Total available access</ul><p>Key technical decisions:<ol><li><strong>Access Conflict Resolution</strong>: Created <code>Access::remove_conflicting_access</code> to safely subtract conflicting permissions<li><strong>Set Operation Refactoring</strong>: Extracted common bitwise operations into <code>invertible_union_with</code> and <code>invertible_difference_with</code> utilities<li><strong>State Simplification</strong>: Changed filtered entities to store <code>Access</code> instead of <code>FilteredAccess</code> since they don’t require filter tracking</ol><h3 id=the-implementation>The Implementation</h3><p>The solution required coordinated changes across multiple ECS modules:<p><strong>1. Access Management Overhaul (access.rs)</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// New conflict resolution method
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>remove_conflicting_access</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>other</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>Access&LTT>) {
</span><span>    </span><span style=color:#f07171>invertible_difference_with</span><span>(
</span><span>        </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>component_read_and_writes</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>component_read_and_writes_inverted</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#ed9366>&</span><span>other</span><span style=color:#ed9366>.</span><span>component_writes</span><span style=color:#61676ccc>,
</span><span>        other</span><span style=color:#ed9366>.</span><span>component_writes_inverted</span><span style=color:#61676ccc>,
</span><span>    )</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... similar handling for other access types
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Refactored set operations
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>invertible_union_with</span><span>(...) { </span><span style=color:#abb0b6;font-style:italic>/* Bitwise union logic */ </span><span>}
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>invertible_difference_with</span><span>(...) { </span><span style=color:#abb0b6;font-style:italic>/* Bitwise difference logic */ </span><span>}
</span></code></pre><p><strong>2. Filtered Entity Implementation (fetch.rs)</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// FilteredEntityMut's provide_extra_access
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>provide_extra_access</span><span>(
</span><span>    </span><span style=color:#ff8f40>state</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut Self</span><span style=color:#ed9366>::</span><span>State,
</span><span>    </span><span style=color:#ff8f40>access</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span>Access&LTComponentId>,
</span><span>    </span><span style=color:#ff8f40>available_access</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>Access&LTComponentId>,
</span><span>) {
</span><span>    state</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone_from</span><span>(available_access)</span><span style=color:#61676ccc>;
</span><span>    state</span><span style=color:#ed9366>.</span><span style=color:#f07171>remove_conflicting_access</span><span>(access)</span><span style=color:#61676ccc>;
</span><span>    access</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend</span><span>(state)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p><strong>3. Query Building Integration (builder.rs)</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Updated query transmutation logic
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>transmute_filtered</span><span>&LTNewD</span><span style=color:#61676ccc>:</span><span> QueryData, NewF</span><span style=color:#61676ccc>:</span><span> QueryFilter>(
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>,
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span>QueryBuilder<</span><span style=color:#fa6e32>'w</span><span>, NewD, NewF> {
</span><span>    </span><span style=color:#fa6e32>let</span><span> fetch_state </span><span style=color:#ed9366>= </span><span>NewD</span><span style=color:#ed9366>::</span><span>init_state(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>world)</span><span style=color:#61676ccc>;
</span><span>    NewD</span><span style=color:#ed9366>::</span><span>provide_extra_access(
</span><span>        </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> fetch_state</span><span style=color:#61676ccc>,
</span><span>        component_access</span><span style=color:#ed9366>.</span><span style=color:#f07171>access_mut</span><span>()</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>access</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>access</span><span>()</span><span style=color:#61676ccc>,
</span><span>    )</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... remaining setup
</span><span>}
</span></code></pre><h3 id=technical-insights>Technical Insights</h3><p>The implementation demonstrates several key patterns:<ol><li><p><strong>Layered Access Control</strong>: Uses a three-phase approach:</p> <ul><li>Collect base access requirements<li>Allow filtered entities to claim remaining access<li>Validate against conflicts</ul><li><p><strong>Bitwise Set Operations</strong>: The <code>invertible_union_with</code> and <code>invertible_difference_with</code> functions handle both normal and inverted bit sets efficiently:</p></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>fn </span><span style=color:#f29718>invertible_union_with</span><span>(...) {
</span><span>    </span><span style=color:#fa6e32>match </span><span>(</span><span style=color:#ed9366>*</span><span>self_inverted</span><span style=color:#61676ccc>,</span><span> other_inverted) {
</span><span>        (</span><span style=color:#ff8f40>true</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>true</span><span>) </span><span style=color:#ed9366>=></span><span> self_set</span><span style=color:#ed9366>.</span><span style=color:#f07171>intersect_with</span><span>(other_set)</span><span style=color:#61676ccc>,
</span><span>        (</span><span style=color:#ff8f40>true</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>false</span><span>) </span><span style=color:#ed9366>=></span><span> self_set</span><span style=color:#ed9366>.</span><span style=color:#f07171>difference_with</span><span>(other_set)</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ... other cases
</span><span>    }
</span><span>}
</span></code></pre><ol start=3><li><strong>Query Composition Safety</strong>: The system ensures nested queries: <ul><li>Start with maximum available access<li>Subtract conflicts from parent queries<li>Propagate remaining access to child elements</ul></ol><h3 id=the-impact>The Impact</h3><p>These changes enable several critical improvements:<ol><li><strong>Safe Nested Access</strong>: Queries can now contain multiple filtered entities with non-conflicting access<li><strong>Dynamic Access Partitioning</strong>: Different parts of a query can claim specific access rights without manual coordination<li><strong>Improved Composition</strong>: Complex query patterns become possible without risking access conflicts</ol><p>Example of valid usage post-PR:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Query with multiple filtered entities
</span><span>QueryBuilder</span><span style=color:#ed9366>::</span><span><(FilteredEntityMut, FilteredEntityMut)></span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> world)
</span><span>    </span><span style=color:#ed9366>.</span><span>data</span><span style=color:#ed9366>::</span><span><</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> A>()
</span><span>    </span><span style=color:#ed9366>.</span><span>data</span><span style=color:#ed9366>::</span><span><</span><span style=color:#ed9366>&</span><span>B>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>build</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// First entity gets write access to A, second gets read-only
</span><span style=color:#fa6e32>let </span><span>(</span><span style=color:#fa6e32>mut</span><span> e1</span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>mut</span><span> e2) </span><span style=color:#ed9366>=</span><span> query</span><span style=color:#ed9366>.</span><span style=color:#f07171>single_mut</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span><span>e1</span><span style=color:#ed9366>.</span><span>get_mut</span><span style=color:#ed9366>::</span><span>&LTA>()</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// Allowed
</span><span>e2</span><span style=color:#ed9366>.</span><span>get</span><span style=color:#ed9366>::</span><span>&LTA>()</span><span style=color:#61676ccc>;     </span><span style=color:#abb0b6;font-style:italic>// Allowed
</span><span>e2</span><span style=color:#ed9366>.</span><span>get_mut</span><span style=color:#ed9366>::</span><span>&LTA>()</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// Blocked
</span></code></pre><h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[QueryBuilder] --> B[provide_extra_access]
</span><span>    B --> C[FilteredEntityRef]
</span><span>    B --> D[FilteredEntityMut]
</span><span>    C --> E[Access Calculation]
</span><span>    D --> E
</span><span>    E --> F[Conflict Resolution]
</span><span>    F --> G[Updated Component Access]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ol><li><p><strong>crates/bevy_ecs/src/query/access.rs</strong> (+186/-61)</p> <ul><li>Added conflict resolution logic<li>Refactored set operations<li>Implemented new test cases</ul><li><p><strong>crates/bevy_ecs/src/query/fetch.rs</strong> (+76/-25)</p> <ul><li>Updated filtered entity implementations<li>Integrated new access methods</ul></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Using FilteredAccess
</span><span style=color:#fa6e32>type </span><span style=color:#399ee6>State </span><span style=color:#ed9366>= </span><span>FilteredAccess&LTComponentId></span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Simplified to Access
</span><span style=color:#fa6e32>type </span><span style=color:#399ee6>State </span><span style=color:#ed9366>= </span><span>Access&LTComponentId></span><span style=color:#61676ccc>;
</span></code></pre><ol start=3><li><p><strong>crates/bevy_ecs/src/query/builder.rs</strong> (+88/-4)</p> <ul><li>Added comprehensive test cases<li>Implemented access propagation logic</ul><li><p><strong>crates/bevy_ecs/macros/src/query_data.rs</strong> (+16/-0)</p> <ul><li>Added macro support for <code>provide_extra_access</code></ul></ol><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/ecs-intro/ target=_blank>Entity Component System Architecture</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_ecs/latest/bevy_ecs/query/index.html target=_blank>Bevy Query System Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/fixedbitset/latest/fixedbitset/struct.FixedBitSet.html target=_blank>Bitwise Set Operations in Rust</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-05/pr_18236.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>