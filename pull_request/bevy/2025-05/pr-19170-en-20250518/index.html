<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19170 Make sure prepass notices changes in alpha mode
        
    </title><meta content="#19170 Make sure prepass notices changes in alpha mode" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-05/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-05-18</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-05/pr-19170-zh-cn-20250518>中文</a></div></div><div class=pr-content><h1 id=make-sure-prepass-notices-changes-in-alpha-mode>Make sure prepass notices changes in alpha mode</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Make sure prepass notices changes in alpha mode<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19170<li><strong>Author</strong>: eero-lehtinen<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, S-Ready-For-Final-Review, D-Straightforward<li><strong>Created</strong>: 2025-05-11T00:38:18Z<li><strong>Merged</strong>: 2025-05-18T06:46:13Z<li><strong>Merged By</strong>: superdump</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Fixes #19150<h2 id=solution>Solution</h2><p>Normally the <code>validate_cached_entity</code> in https://github.com/bevyengine/bevy/blob/86cc02dca229662bdfb371a0e5a1716560ea7baa/crates/bevy_pbr/src/prepass/mod.rs#L1109-L1126 marks unchanged entites as clean, which makes them remain in the phase.<p>If a material is changed to an <code>alpha_mode</code> that isn’t supposed to be added to the prepass pipeline, the specialization system just <code>continue</code>s and doesn’t indicate to the cache that the entity is not clean anymore.<p>I made these invalid entities get removed from the pipeline cache so that they are correctly not marked clean and then removed from the phase.<h2 id=testing>Testing</h2><p>Tested with the example code from the issue.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=the-problem-and-context>The Problem and Context</h3><p>The rendering system faced an inconsistency where materials with certain alpha modes (Blend, Premultiplied, Add, Multiply) weren’t properly excluded from the prepass pipeline when their alpha mode changed. This occurred because the pipeline cache validation system didn’t account for transitions between valid and invalid alpha modes for prepass rendering.<p>When a material changed from a prepass-compatible alpha mode (like Opaque) to an incompatible one, the existing cache entry remained valid. The prepass phase would then incorrectly continue processing these entities, leading to rendering artifacts and potential performance issues from unnecessary processing.<h3 id=the-solution-approach>The Solution Approach</h3><p>The core fix focuses on explicit cache invalidation when encountering incompatible alpha modes. Instead of simply skipping processing for these materials, the solution removes their entries from the pipeline cache. This forces the system to recognize the state change and properly exclude them from subsequent prepass phases.<h3 id=the-implementation>The Implementation</h3><p>The key modification occurs in the material specialization logic for prepass rendering. Two critical changes were made:<ol><li><strong>Alpha Mode Handling</strong>:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>match</span><span> material</span><span style=color:#ed9366>.</span><span>alpha_mode {
</span><span>    AlphaMode</span><span style=color:#ed9366>::</span><span>Opaque </span><span style=color:#ed9366>=> </span><span>{}
</span><span>    AlphaMode</span><span style=color:#ed9366>::</span><span>Blend
</span><span>    </span><span style=color:#ed9366>| </span><span>AlphaMode</span><span style=color:#ed9366>::</span><span>Premultiplied
</span><span>    </span><span style=color:#ed9366>| </span><span>AlphaMode</span><span style=color:#ed9366>::</span><span>Add
</span><span>    </span><span style=color:#ed9366>| </span><span>AlphaMode</span><span style=color:#ed9366>::</span><span>Multiply </span><span style=color:#ed9366>=> </span><span>{
</span><span>        view_specialized_material_pipeline_cache</span><span style=color:#ed9366>.</span><span style=color:#f07171>remove</span><span>(visible_entity)</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><ol start=2><li><strong>Transmission Texture Check</strong>:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>if</span><span> material</span><span style=color:#ed9366>.</span><span>properties</span><span style=color:#ed9366>.</span><span>reads_view_transmission_texture {
</span><span>    view_specialized_material_pipeline_cache</span><span style=color:#ed9366>.</span><span style=color:#f07171>remove</span><span>(visible_entity)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>By adding <code>view_specialized_material_pipeline_cache.remove(visible_entity)</code> before continuing, we ensure:<ul><li>Existing cache entries are purged when materials become incompatible<li>The entity is marked as “not clean” in the phase system<li>Subsequent frames will correctly exclude the entity from prepass processing</ul><h3 id=technical-insights>Technical Insights</h3><p>The fix leverages Bevy’s existing pipeline caching mechanism by understanding:<ol><li>Phase items remain in their phase until marked as removed<li>Cache validation (<code>validate_cached_entity</code>) uses the pipeline cache’s state to determine cleanliness<li>Removing from the pipeline cache forces re-evaluation in the next frame</ol><p>This approach maintains the existing specialization flow while adding explicit invalidation for state transitions that affect pipeline compatibility.<h3 id=the-impact>The Impact</h3><ul><li>Fixes visual artifacts caused by incorrect prepass inclusion<li>Prevents unnecessary processing of incompatible materials<li>Maintains cache efficiency for valid materials<li>Introduces minimal overhead (only affects state transitions between compatible/incompatible modes)</ul><h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Material AlphaMode Change] --> B{Valid for Prepass?}
</span><span>    B -->|Yes| C[Keep in Cache]
</span><span>    B -->|No| D[Remove from Cache]
</span><span>    D --> E[Phase Marks as Removed]
</span><span>    E --> F[Prepass Excluded]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-pbr-src-prepass-mod-rs-7-1><code>crates/bevy_pbr/src/prepass/mod.rs</code> (+7/-1)</h3><p><strong>Purpose</strong>: Fix pipeline cache handling for materials with incompatible alpha modes<p>Key modification in material specialization:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>AlphaMode</span><span style=color:#ed9366>::</span><span>Blend </span><span style=color:#ed9366>| ... => </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>AlphaMode</span><span style=color:#ed9366>::</span><span>Blend </span><span style=color:#ed9366>| ... => </span><span>{
</span><span>    view_specialized_material_pipeline_cache</span><span style=color:#ed9366>.</span><span style=color:#f07171>remove</span><span>(visible_entity)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>This change ensures that when a material transitions to an incompatible alpha mode:<ol><li>Its pipeline cache entry is explicitly removed<li>The phase system detects the change in next frame<li>The entity gets excluded from prepass rendering</ol><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/next/render/pipelines target=_blank>Bevy Render Pipelines Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/next/render/materials target=_blank>Bevy Material System Overview</a><li><a rel="noopener nofollow noreferrer" href=https://www.w3.org/TR/webgpu/#blending target=_blank>WebGPU Blend Modes Specification</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-05/pr_19170.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>