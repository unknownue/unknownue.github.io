<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19129 Provide physical dimensions to wgpu `Device::create_texture_with_data`
        
    </title><meta content="#19129 Provide physical dimensions to wgpu `Device::create_texture_with_data`" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-05/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-05-26</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-05/pr-19129-zh-cn-20250526>中文</a></div></div><div class=pr-content><h1 id=title-provide-physical-dimensions-to-wgpu-device-create-texture-with-data>Title: Provide physical dimensions to wgpu <code>Device::create_texture_with_data</code></h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Provide physical dimensions to wgpu <code>Device::create_texture_with_data</code><li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19129<li><strong>Author</strong>: atlv24<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, C-Usability, S-Ready-For-Final-Review, D-Straightforward<li><strong>Created</strong>: 2025-05-08T08:02:21Z<li><strong>Merged</strong>: 2025-05-26T17:58:30Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Make errors in #19124 #13289 clearer, and opt for option 1. of https://github.com/gfx-rs/wgpu/issues/7677</ul><h2 id=solution>Solution</h2><p>Remove the round to block size <code>.physical_size(texture_format);</code><p>Error message now becomes much clearer:<pre style=color:#61676c;background-color:#fafafa><code><span>thread 'Compute Task Pool (5)' panicked at E:\r\wgpu\wgpu\src\backend\wgpu_core.rs:1423:26:
</span><span>wgpu error: Validation Error
</span><span>
</span><span>Caused by:
</span><span>  In Device::create_texture
</span><span>    Width 2050 is not a multiple of Bc7RgbaUnormSrgb's block width (4)
</span></code></pre><h2 id=testing>Testing</h2><ul><li>Tested using the repro in #19124</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The PR addresses a persistent issue in texture handling where validation errors provided unclear diagnostics when creating textures with incompatible dimensions. The root problem stemmed from how texture dimensions were being adjusted to match format-specific block sizes before being passed to wgpu, which hid validation checks that could provide more direct feedback.<p>Previously, the code used <code>.physical_size(texture_format)</code> to round texture dimensions to the nearest multiple of the texture format’s block size. While this avoided immediate validation errors, it created two problems:<ol><li>Masked the actual validation checks that could catch dimension mismatches earlier<li>Produced confusing error messages downstream when misaligned dimensions caused issues</ol><p>The key insight came from wgpu’s validation layer, which performs block size alignment checks internally. By removing the manual rounding and passing logical dimensions directly, we expose these validation checks earlier in the process. This results in more specific error messages that directly identify the dimension/block size mismatch.<p>The implementation change was straightforward but impactful:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Manual alignment
</span><span>image</span><span style=color:#ed9366>.</span><span>texture_descriptor</span><span style=color:#ed9366>.</span><span>size </span><span style=color:#ed9366>=</span><span> Extent3d { </span><span style=color:#ed9366>... </span><span>}</span><span style=color:#ed9366>.</span><span style=color:#f07171>physical_size</span><span>(texture_format)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Pass logical dimensions directly
</span><span>image</span><span style=color:#ed9366>.</span><span>texture_descriptor</span><span style=color:#ed9366>.</span><span>size </span><span style=color:#ed9366>=</span><span> Extent3d { </span><span style=color:#ed9366>... </span><span>}</span><span style=color:#61676ccc>;
</span></code></pre><p>This change shifts responsibility for dimension validation to wgpu’s internal checks, aligning with the API’s intended use. The accompanying code comment clarifies this decision:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Note: we must give wgpu the logical texture dimensions...
</span><span style=color:#abb0b6;font-style:italic>// However this currently causes wgpu to panic if the dimensions arent a multiple of blocksize
</span></code></pre><p>The trade-off is explicit: developers must now ensure proper dimension alignment upfront, but gain clearer error messages when requirements aren’t met. This improves debugging efficiency, as shown in the updated error message:<pre style=color:#61676c;background-color:#fafafa><code><span>Width 2050 is not a multiple of Bc7RgbaUnormSrgb's block width (4)
</span></code></pre><h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[Texture Loading] --> B[Dimension Calculation]
</span><span>    B --> C[Manual Block Alignment]
</span><span>    B --> D[wgpu Validation]
</span><span>    C -.Obscured Errors.-> E[Downstream Issues]
</span><span>    D --> F[Clear Validation Errors]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>File: crates/bevy_image/src/ktx2.rs</strong> (+4/-2)<ol><li>Removed physical size conversion to surface validation errors earlier<li>Added documentation explaining the validation trade-off</ol><p>Key code change:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>image</span><span style=color:#ed9366>.</span><span>texture_descriptor</span><span style=color:#ed9366>.</span><span>size </span><span style=color:#ed9366>=</span><span> Extent3d {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// dimension fields
</span><span>}</span><span style=color:#ed9366>.</span><span style=color:#f07171>physical_size</span><span>(texture_format)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>image</span><span style=color:#ed9366>.</span><span>texture_descriptor</span><span style=color:#ed9366>.</span><span>size </span><span style=color:#ed9366>=</span><span> Extent3d {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// dimension fields (unchanged)
</span><span>}</span><span style=color:#61676ccc>;
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/wgpu/latest/wgpu/struct.TextureDescriptor.html target=_blank>wgpu texture validation documentation</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/gfx-rs/wgpu/wiki/Texture-Block-Sizes target=_blank>Block compression formats explained</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/gfx-rs/wgpu/issues/7677 target=_blank>Original wgpu issue #7677</a></ol><h1 id=full-code-diff>Full Code Diff</h1><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_image/src/ktx2.rs b/crates/bevy_image/src/ktx2.rs
</span><span>index 0cccbacb072c3..c86e32ef525e1 100644
</span><span style=color:#c594c5>--- a/crates/bevy_image/src/ktx2.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_image/src/ktx2.rs
</span><span style=color:#c594c5>@@ -267,6 +267,9 @@ </span><span style=color:#399ee6>pub fn ktx2_buffer_to_image(
</span><span>     let mut image = Image::default();
</span><span>     image.texture_descriptor.format = texture_format;
</span><span>     image.data = Some(wgpu_data.into_iter().flatten().collect::&LTVec<_>>());
</span><span style=color:#86b300>+    // Note: we must give wgpu the logical texture dimensions, so it can correctly compute mip sizes.
</span><span style=color:#86b300>+    // However this currently causes wgpu to panic if the dimensions arent a multiple of blocksize.
</span><span style=color:#86b300>+    // See https://github.com/gfx-rs/wgpu/issues/7677 for more context.
</span><span>     image.texture_descriptor.size = Extent3d {
</span><span>         width,
</span><span>         height,
</span><span style=color:#c594c5>@@ -276,8 +279,7 @@ </span><span style=color:#399ee6>pub fn ktx2_buffer_to_image(
</span><span>             depth
</span><span>         }
</span><span>         .max(1),
</span><span style=color:#f07171>-    }
</span><span style=color:#f07171>-    .physical_size(texture_format);
</span><span style=color:#86b300>+    };
</span><span>     image.texture_descriptor.mip_level_count = level_count;
</span><span>     image.texture_descriptor.dimension = if depth > 1 {
</span><span>         TextureDimension::D3
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-05/pr_19129.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>