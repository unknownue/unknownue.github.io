<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #23156 Optimizing Hierarchy Propagation Through Event-Driven Observers
        
    </title><meta content="#23156 Optimizing Hierarchy Propagation Through Event-Driven Observers" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2026-03/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2026-03-02</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2026-03/pr-23156-zh-cn-20260302>中文</a></div></div><div class=pr-content><h1 id=title-optimizing-hierarchy-propagation-through-event-driven-observers>Title: Optimizing Hierarchy Propagation Through Event-Driven Observers</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: fix: reparenting perf<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/23156<li><strong>Author</strong>: aevyrie<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Performance, S-Ready-For-Final-Review, A-App, X-Uncontroversial, D-Straightforward<li><strong>Created</strong>: 2026-02-26T07:52:32Z<li><strong>Merged</strong>: 2026-03-02T00:07:00Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p><code>HierarchyPropagatePlugin</code> contains a system <code>update_reparented</code> that scans every entity with the relationship component <code>R</code> every frame to test for <code>Changed&LTR></code>. This means iterating over every child entity every frame, even when nothing has changed. This is a significant per-frame cost that scales linearly with child entity population.<p>Fixes #23155<h1 id=solution>Solution</h1><p>Replace the <code>update_reparented</code> system and its <code>Changed&LTR></code> query with two reactive lifecycle observers:<ul><li><strong><code>on_r_inserted</code></strong>: registered on <code>On&LTInsert, R></code>, fires only when <code>R</code> is actually inserted onto an entity. Copies <code>Inherited&LTC></code> from the new parent if it has one, otherwise removes it from the entity.<li><strong><code>on_r_removed</code></strong>: registered on <code>On&LTRemove, R></code>, fires only when <code>R</code> is actually removed from an entity. Removes <code>Inherited&LTC></code> if the entity had inherited one.</ul><p>This replaces an O(n) per-frame scan with O(1) per-event reactions.<h2 id=what-about-mutations>What about mutations?</h2><p><code>Changed&LTR></code> also detects direct mutations to <code>R</code>, while <code>On&LTInsert, R></code> does not.<p>From what I can tell, this is safe to drop; <strong>please review this logic for correctness!</strong><p>Relationship components like <code>ChildOf</code> must only be changed via <code>insert</code>, never by direct mutation. This is because <code>R</code> carries bookkeeping semantics enforced by component hooks. Inserting a new value triggers hooks that remove the entity from the old parent’s <code>RelationshipTarget</code> and add it to the new one. Direct mutation via <code>Mut&LTR></code> bypasses these hooks entirely, leaving the <code>RelationshipTarget</code> of both the old and new parent in an inconsistent state. Any app doing this already has a bug. <code>On&LTInsert, R></code> fires for <strong>both</strong> first-time additions and replacements (re-inserts with a new value), which covers every valid way a relationship can change:<table><thead><tr><th>Case<th>Old (<code>Changed&LTR></code>)<th>New (<code>On&LTInsert, R></code> / <code>On&LTRemove, R></code>)<tbody><tr><td>New child spawned with <code>R</code><td>✅<td>✅ via <code>On&LTInsert, R></code><tr><td>Entity reparented (<code>insert(R)</code>)<td>✅<td>✅ via <code>On&LTInsert, R></code><tr><td><code>R</code> removed (entity orphaned)<td>✅ via <code>orphaned</code> query<td>✅ via <code>On&LTRemove, R></code><tr><td><code>R</code> mutated directly via <code>Mut&LTR></code><td>✅<td>❌ unsupported: breaks relationship invariants</table><h1 id=testing>Testing</h1><p>All existing propagation tests pass, including:<ul><li><code>test_reparented</code>: entity moved to a non-propagating parent loses <code>Inherited&LTC></code><li><code>test_reparented_with_prior</code>: entity moved between two propagating parents picks up the new value<li><code>test_remove_orphan</code>: entity with <code>R</code> removed loses <code>Inherited&LTC></code></ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a performance issue in Bevy’s hierarchy propagation system. The <code>HierarchyPropagatePlugin</code> was using an inefficient approach that scanned every entity with a relationship component each frame, regardless of whether any changes had occurred. This O(n) per-frame cost became problematic in scenes with many child entities, as it required iterating over all of them every frame just to check for changes.<p>The core problem was in the <code>update_reparented</code> system, which used a <code>Changed&LTR></code> query to detect when relationship components like <code>ChildOf</code> were modified. While <code>Changed&LTR></code> is a useful filter for detecting component changes, it has a hidden cost: the ECS still needs to evaluate every entity with component <code>R</code> to determine if it changed. This meant that in a scene with 10,000 child entities, the system would process 10,000 entities every frame, even if no reparenting occurred.<p>The solution replaces this polling-based approach with an event-driven model using Bevy’s observer system. Instead of scanning all entities each frame, we now register two observers that only execute when specific events occur:<ol><li><code>on_r_inserted</code>: triggered when a relationship component is inserted (or replaced via re-insertion)<li><code>on_r_removed</code>: triggered when a relationship component is removed</ol><p>This transition from O(n) to O(1) per-frame performance is significant. With the old system, processing time scaled linearly with the number of child entities. With the new system, processing only occurs when actual reparenting events happen, which is typically a small fraction of the total entities per frame.<p>A key consideration in this change was handling edge cases around component mutations. The <code>Changed&LTR></code> query detects both insertions and direct mutations (via <code>Mut&LTR></code>), while <code>On&LTInsert, R></code> only detects insertions. After analysis, the PR author determined this was acceptable because relationship components should never be directly mutated. These components have associated hooks that maintain internal bookkeeping in <code>RelationshipTarget</code> components. Direct mutation bypasses these hooks, leaving the relationship system in an inconsistent state. Any code doing direct mutation is already broken, so not supporting this case in the new observers is actually correct behavior.<p>The implementation shows careful attention to the existing API contracts. The <code>on_r_inserted</code> function checks if the new parent has an <code>Inherited&LTC></code> component and either copies it to the child or removes the inherited component if the parent doesn’t propagate. The <code>on_r_removed</code> function simply removes the <code>Inherited&LTC></code> component when the relationship is severed.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>on_r_inserted</span><span><
</span><span>    C</span><span style=color:#61676ccc>:</span><span> Component </span><span style=color:#ed9366>+ </span><span style=color:#55b4d4;font-style:italic>Clone </span><span style=color:#ed9366>+ </span><span style=color:#55b4d4;font-style:italic>PartialEq</span><span>,
</span><span>    F</span><span style=color:#61676ccc>:</span><span> QueryFilter </span><span style=color:#ed9366>+ </span><span style=color:#fa6e32>'static</span><span>,
</span><span>    R</span><span style=color:#61676ccc>:</span><span> Relationship,
</span><span>>(
</span><span>    </span><span style=color:#ff8f40>event</span><span style=color:#61676ccc>: </span><span>On&LTInsert, R>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands,
</span><span>    </span><span style=color:#ff8f40>query</span><span style=color:#61676ccc>: </span><span>Query<(</span><span style=color:#ed9366>&</span><span>R, Has&LTInherited&LTC>>), (Without&LTPropagate&LTC>>, F)>,
</span><span>    </span><span style=color:#ff8f40>relations</span><span style=color:#61676ccc>: </span><span>Query<</span><span style=color:#ed9366>&</span><span>Inherited&LTC>, Without&LTPropagateStop&LTC>>>,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>((relation</span><span style=color:#61676ccc>,</span><span> has_inherited)) </span><span style=color:#ed9366>=</span><span> query</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(event</span><span style=color:#ed9366>.</span><span>entity) </span><span style=color:#fa6e32>else </span><span>{
</span><span>        </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span>    }</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(inherited) </span><span style=color:#ed9366>=</span><span> relations</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(relation</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>()) {
</span><span>        commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(event</span><span style=color:#ed9366>.</span><span>entity)</span><span style=color:#ed9366>.</span><span style=color:#f07171>try_insert</span><span>(inherited</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>())</span><span style=color:#61676ccc>;
</span><span>    } </span><span style=color:#fa6e32>else if</span><span> has_inherited {
</span><span>        commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(event</span><span style=color:#ed9366>.</span><span>entity)</span><span style=color:#ed9366>.</span><span>try_remove</span><span style=color:#ed9366>::</span><span>&LTInherited&LTC>>()</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><p>The PR also includes a minor cleanup in the <code>propagate_output</code> system, renaming variables for clarity and adjusting the query logic to better match the new approach. The change from checking <code>skip.get(removed).is_err()</code> to <code>without_propagation_components.contains(inherited_removed)</code> is more semantically clear about what conditions should prevent component removal.<p>All existing tests continue to pass, validating that the new event-driven approach maintains the same behavior for valid reparenting operations while eliminating the performance overhead of scanning unchanged entities each frame.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[HierarchyPropagatePlugin] --> B[Schedule Systems]
</span><span>    A --> C[Register Observers]
</span><span>    
</span><span>    B --> D[update_source]
</span><span>    B --> E[update_removed_limit]
</span><span>    B --> F[propagate_inherited]
</span><span>    B --> G[propagate_output]
</span><span>    
</span><span>    C --> H[on_r_inserted]
</span><span>    C --> I[on_r_removed]
</span><span>    
</span><span>    H -->|On&LTInsert, R>| J[Copy/Remove Inherited&LTC>]
</span><span>    I -->|On&LTRemove, R>| K[Remove Inherited&LTC>]
</span><span>    
</span><span>    style H fill:#e1f5e1
</span><span>    style I fill:#e1f5e1
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-app-src-propagate-rs-35-20><code>crates/bevy_app/src/propagate.rs</code> (+35/-20)</h3><p>This is the only file modified in the PR. The changes replace the polling-based <code>update_reparented</code> system with two event-driven observers and clean up related code.<ol><li><p><strong>Removal of the <code>update_reparented</code> system from the schedule:</strong></p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>(
</span><span>    update_source</span><span style=color:#ed9366>::</span><span>&LTC, F, R></span><span style=color:#61676ccc>,
</span><span>    update_reparented</span><span style=color:#ed9366>::</span><span>&LTC, F, R></span><span style=color:#61676ccc>,  </span><span style=color:#abb0b6;font-style:italic>// Removed
</span><span>    update_removed_limit</span><span style=color:#ed9366>::</span><span>&LTC, F, R></span><span style=color:#61676ccc>,
</span><span>    propagate_inherited</span><span style=color:#ed9366>::</span><span>&LTC, F, R></span><span style=color:#61676ccc>,
</span><span>    propagate_output</span><span style=color:#ed9366>::</span><span>&LTC, F></span><span style=color:#61676ccc>,
</span><span>)
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>(
</span><span>    update_source</span><span style=color:#ed9366>::</span><span>&LTC, F, R></span><span style=color:#61676ccc>,
</span><span>    update_removed_limit</span><span style=color:#ed9366>::</span><span>&LTC, F, R></span><span style=color:#61676ccc>,
</span><span>    propagate_inherited</span><span style=color:#ed9366>::</span><span>&LTC, F, R></span><span style=color:#61676ccc>,
</span><span>    propagate_output</span><span style=color:#ed9366>::</span><span>&LTC, F></span><span style=color:#61676ccc>,
</span><span>)
</span></code></pre><li><p><strong>Addition of observer registrations:</strong></p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// After:
</span><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_observer</span><span>(on_r_inserted</span><span style=color:#ed9366>::</span><span>&LTC, F, R>)</span><span style=color:#61676ccc>;
</span><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_observer</span><span>(on_r_removed</span><span style=color:#ed9366>::</span><span>&LTC, F, R>)</span><span style=color:#61676ccc>;
</span></code></pre><li><p><strong>Implementation of the new observer functions:</strong></p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// New observer for R insertion
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>on_r_inserted</span><span><</span><span style=color:#f51818>.</span><span style=color:#ed9366>..></span><span>(
</span><span>    event</span><span style=color:#61676ccc>: </span><span>On&LTInsert, R></span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#fa6e32>mut</span><span> commands</span><span style=color:#61676ccc>:</span><span> Commands</span><span style=color:#61676ccc>,
</span><span>    query</span><span style=color:#61676ccc>: </span><span>Query<(</span><span style=color:#ed9366>&</span><span>R, Has&LTInherited&LTC>>), (Without&LTPropagate&LTC>>, F)></span><span style=color:#61676ccc>,
</span><span>    relations</span><span style=color:#61676ccc>: </span><span>Query<</span><span style=color:#ed9366>&</span><span>Inherited&LTC>, Without&LTPropagateStop&LTC>>></span><span style=color:#61676ccc>,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>((relation</span><span style=color:#61676ccc>,</span><span> has_inherited)) </span><span style=color:#ed9366>=</span><span> query</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(event</span><span style=color:#ed9366>.</span><span>entity) </span><span style=color:#fa6e32>else </span><span>{
</span><span>        </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span>    }</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(inherited) </span><span style=color:#ed9366>=</span><span> relations</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(relation</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>()) {
</span><span>        commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(event</span><span style=color:#ed9366>.</span><span>entity)</span><span style=color:#ed9366>.</span><span style=color:#f07171>try_insert</span><span>(inherited</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>())</span><span style=color:#61676ccc>;
</span><span>    } </span><span style=color:#fa6e32>else if</span><span> has_inherited {
</span><span>        commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(event</span><span style=color:#ed9366>.</span><span>entity)</span><span style=color:#ed9366>.</span><span>try_remove</span><span style=color:#ed9366>::</span><span>&LTInherited&LTC>>()</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// New observer for R removal
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>on_r_removed</span><span><</span><span style=color:#f51818>.</span><span style=color:#ed9366>..></span><span>(
</span><span>    event</span><span style=color:#61676ccc>: </span><span>On&LTRemove, R></span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#fa6e32>mut</span><span> commands</span><span style=color:#61676ccc>:</span><span> Commands</span><span style=color:#61676ccc>,
</span><span>    query</span><span style=color:#61676ccc>: </span><span>Query<(), (With&LTInherited&LTC>>, Without&LTPropagate&LTC>>, F)></span><span style=color:#61676ccc>,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>if</span><span> query</span><span style=color:#ed9366>.</span><span style=color:#f07171>contains</span><span>(event</span><span style=color:#ed9366>.</span><span>entity) {
</span><span>        commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(event</span><span style=color:#ed9366>.</span><span>entity)</span><span style=color:#ed9366>.</span><span>try_remove</span><span style=color:#ed9366>::</span><span>&LTInherited&LTC>>()</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><li><p><strong>Cleanup in <code>propagate_output</code>:</strong></p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>mut</span><span> removed</span><span style=color:#61676ccc>: </span><span>RemovedComponents&LTInherited&LTC>></span><span style=color:#61676ccc>,
</span><span>skip</span><span style=color:#61676ccc>: </span><span>Query<(), With&LTPropagateOver&LTC>>></span><span style=color:#61676ccc>,
</span><span style=color:#abb0b6;font-style:italic>// ...
</span><span style=color:#fa6e32>for</span><span> removed </span><span style=color:#ed9366>in</span><span> removed</span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>() {
</span><span>    </span><span style=color:#fa6e32>if</span><span> skip</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(removed)</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_err</span><span>() {
</span><span>        commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(removed)</span><span style=color:#ed9366>.</span><span>try_remove</span><span style=color:#ed9366>::</span><span>&LTC>()</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>mut</span><span> inherited_removed</span><span style=color:#61676ccc>: </span><span>RemovedComponents&LTInherited&LTC>></span><span style=color:#61676ccc>,
</span><span>without_propagation_components</span><span style=color:#61676ccc>: </span><span>Query<(), (Without&LTPropagateOver&LTC>>, Without&LTInherited&LTC>>)></span><span style=color:#61676ccc>,
</span><span style=color:#abb0b6;font-style:italic>// ...
</span><span style=color:#fa6e32>for</span><span> inherited_removed </span><span style=color:#ed9366>in</span><span> inherited_removed</span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>() {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Skip removal if propagation components were re-added this update
</span><span>    </span><span style=color:#fa6e32>if</span><span> without_propagation_components</span><span style=color:#ed9366>.</span><span style=color:#f07171>contains</span><span>(inherited_removed) {
</span><span>        commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(inherited_removed)</span><span style=color:#ed9366>.</span><span>try_remove</span><span style=color:#ed9366>::</span><span>&LTC>()</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre></ol><p>These changes collectively transform the hierarchy propagation system from a polling model to an event-driven one, eliminating unnecessary per-frame work while maintaining correct behavior for all valid use cases.<h2 id=further-reading>Further Reading</h2><ol><li><p><strong>Bevy Observer System</strong>: The PR uses Bevy’s <code>On&LTInsert, T></code> and <code>On&LTRemove, T></code> observers. For more on this pattern, see the <a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/ecs/observer/index.html target=_blank>Bevy Observer Documentation</a>.</p><li><p><strong>ECS Performance Patterns</strong>: This PR demonstrates the common optimization pattern of moving from polling to event-driven systems in entity component systems. The book “Game Programming Patterns” by Robert Nystrom has a useful chapter on Event Queues.</p><li><p><strong>Relationship Components in Bevy</strong>: For background on how relationship components work in Bevy, see the <a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/ecs/relationship/index.html target=_blank>Bevy Relationship Documentation</a>, which explains the hooks and invariants mentioned in the PR.</p><li><p><strong>Component Lifecycle Events</strong>: The PR leverages Bevy’s component lifecycle events. More details can be found in the <a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/ecs/lifecycle/index.html target=_blank>Bevy Component Lifecycle Documentation</a>.</p></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2026-03/pr_23156.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>