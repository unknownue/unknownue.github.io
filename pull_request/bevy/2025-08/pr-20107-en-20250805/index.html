<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20107
        
    </title><meta content=#20107 property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-08/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-08-05</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-08/pr-20107-zh-cn-20250805>中文</a></div></div><div class=pr-content><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This pull request addresses three interconnected issues in Bevy’s <code>specialized_mesh_pipeline</code> example. First, the example didn’t work on WebGL2 due to custom batching implementation that bypassed Bevy’s rendering abstractions. Second, it contained redundant batching logic that duplicated existing engine functionality. Third, it only implemented basic batching without leveraging Bevy’s multi-draw indirect capabilities.<p>The core problem stemmed from the example manually implementing GPU instance buffering and indirect parameter management instead of using Bevy’s built-in batching system. This custom approach broke WebGL2 compatibility since it didn’t account for platform-specific rendering constraints. The original implementation also created unnecessary maintenance overhead by duplicating existing engine functionality.<p>To resolve these issues, we refactored the example to use Bevy’s standard batching abstractions. The key changes include:<ol><li>Removing the custom batching implementation and replacing it with Bevy’s <code>GpuPreprocessingSupport</code> and <code>MeshAllocator</code><li>Simplifying the view query by removing unused parameters<li>Replacing manual work item buffer management with standardized batching methods<li>Using the actual mesh asset ID instead of a placeholder invalid ID<li>Switching to <code>BinnedRenderPhaseType::mesh()</code> which automatically handles both batching and multi-draw indirect</ol><p>These changes make the example both simpler and more powerful. By leveraging <code>GpuPreprocessingSupport</code>, we automatically gain WebGL2 compatibility since the engine handles platform differences internally. The switch to <code>BinnedRenderPhaseType::mesh()</code> also enables multi-draw indirect rendering where supported, potentially improving performance on capable hardware.<p>The implementation demonstrates proper use of Bevy’s rendering abstractions. Instead of manually managing work item buffers and indirect parameters, we now rely on the engine’s built-in systems:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Manual work buffer management
</span><span style=color:#fa6e32>let</span><span> work_item_buffer </span><span style=color:#ed9366>= </span><span>gpu_preprocessing</span><span style=color:#ed9366>::</span><span>get_or_create_work_item_buffer</span><span style=color:#ed9366>::</span><span>&LTOpaque3d>(</span><span style=color:#ed9366>...</span><span>)</span><span style=color:#61676ccc>;
</span><span>gpu_preprocessing</span><span style=color:#ed9366>::</span><span>init_work_item_buffers(</span><span style=color:#ed9366>...</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Automatic handling through standard components
</span><span>BinnedRenderPhaseType</span><span style=color:#ed9366>::</span><span>mesh(
</span><span>    mesh_instance</span><span style=color:#ed9366>.</span><span style=color:#f07171>should_batch</span><span>()</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#ed9366>&</span><span>gpu_preprocessing_support</span><span style=color:#61676ccc>,
</span><span>)
</span></code></pre><p>This approach ensures the example remains compatible with current and future Bevy rendering features while reducing maintenance burden. The changes also fix the WebGL2 compatibility issue since all platform-specific handling is now delegated to Bevy’s internal systems.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[CustomMeshPipeline] --> B[queue_custom_mesh_pipeline]
</span><span>    B --> C[MeshAllocator]
</span><span>    B --> D[GpuPreprocessingSupport]
</span><span>    D --> E[WebGL2 Compatibility]
</span><span>    D --> F[Multi-Draw Indirect]
</span><span>    C --> G[Vertex/Index Slabs]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=examples-shader-advanced-specialized-mesh-pipeline-rs><code>examples/shader_advanced/specialized_mesh_pipeline.rs</code></h3><p><strong>Changes:</strong><ul><li>Removed 127 lines of custom batching implementation<li>Added 28 lines using standard Bevy batching abstractions<li>Simplified view query and batching logic<li>Fixed WebGL2 compatibility</ul><p><strong>Key modifications:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Complex custom batching setup
</span><span style=color:#fa6e32>let mut</span><span> phase_batched_instance_buffers</span><span style=color:#61676ccc>: </span><span>ResMut<
</span><span>    PhaseBatchedInstanceBuffers&LTOpaque3d, &LTMeshPipeline </span><span style=color:#ed9366>as</span><span> GetBatchData></span><span style=color:#ed9366>::</span><span>BufferData>,
</span><span>></span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let mut</span><span> phase_indirect_parameters_buffers</span><span style=color:#61676ccc>: </span><span>ResMut&LTPhaseIndirectParametersBuffers&LTOpaque3d>></span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Standard batching components
</span><span>gpu_preprocessing_support</span><span style=color:#61676ccc>: </span><span>Res&LTGpuPreprocessingSupport></span><span style=color:#61676ccc>,
</span><span>mesh_allocator</span><span style=color:#61676ccc>: </span><span>Res&LTMeshAllocator></span><span style=color:#61676ccc>,
</span></code></pre><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Manual work item buffer management
</span><span style=color:#fa6e32>let</span><span> work_item_buffer </span><span style=color:#ed9366>= </span><span>gpu_preprocessing</span><span style=color:#ed9366>::</span><span>get_or_create_work_item_buffer</span><span style=color:#ed9366>::</span><span>&LTOpaque3d>(</span><span style=color:#ed9366>...</span><span>)</span><span style=color:#61676ccc>;
</span><span>gpu_preprocessing</span><span style=color:#ed9366>::</span><span>init_work_item_buffers(</span><span style=color:#ed9366>...</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Automatic batching type selection
</span><span>BinnedRenderPhaseType</span><span style=color:#ed9366>::</span><span>mesh(
</span><span>    mesh_instance</span><span style=color:#ed9366>.</span><span style=color:#f07171>should_batch</span><span>()</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#ed9366>&</span><span>gpu_preprocessing_support</span><span style=color:#61676ccc>,
</span><span>)
</span></code></pre><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Placeholder asset ID
</span><span>Opaque3dBinKey {
</span><span>    asset_id</span><span style=color:#61676ccc>: </span><span>AssetId</span><span style=color:#ed9366>::</span><span>&LTMesh></span><span style=color:#ed9366>::</span><span>invalid()</span><span style=color:#ed9366>.</span><span style=color:#f07171>untyped</span><span>()</span><span style=color:#61676ccc>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Actual mesh asset ID
</span><span>Opaque3dBinKey {
</span><span>    asset_id</span><span style=color:#61676ccc>:</span><span> mesh_instance</span><span style=color:#ed9366>.</span><span>mesh_asset_id</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()</span><span style=color:#61676ccc>,
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/getting-started/rendering/ target=_blank>Bevy Rendering Architecture</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/render/batching/index.html target=_blank>Bevy Batching System Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/docs/plugins_guidelines.md#webgl2 target=_blank>WebGL2 Limitations in Bevy</a><li><a rel="noopener nofollow noreferrer" href=https://www.khronos.org/opengl/wiki/Vertex_Rendering#Multi-Draw_Indirect target=_blank>Multi-Draw Indirect Explained</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-08/pr_20107.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>