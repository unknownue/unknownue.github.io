<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20711 affine atmosphere
        
    </title><meta content="#20711 affine atmosphere" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-08/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-08-22</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-08/pr-20711-zh-cn-20250822>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>affine atmosphere<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: affine atmosphere<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20711<li><strong>Author</strong>: atlv24<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering<li><strong>Created</strong>: 2025-08-22T08:43:21Z<li><strong>Merged</strong>: 2025-08-22T21:58:52Z<li><strong>Merged By</strong>: james7132</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>dont mat4 inverse</ul><h2 id=solution>Solution</h2><ul><li>use affine</ul><h2 id=testing>Testing</h2><ul><li>atmosphere example</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a performance optimization in Bevy’s atmospheric rendering system. The core issue was the use of expensive matrix inversion operations on 4x4 matrices (Mat4::inverse) when calculating atmosphere transforms. Matrix inversion is computationally expensive, especially for full 4x4 matrices, and can become a bottleneck in rendering systems.<p>The developer identified that the transformation operations being performed were actually affine transformations - a subset of linear transformations that preserve points, straight lines, and planes. Affine transformations include translations, rotations, scaling, and shearing, but not perspective projections. Since the atmosphere rendering doesn’t require full perspective projection matrices, the solution was to use the more efficient Affine3A type instead of Mat4.<p>The implementation replaces Mat4 operations with their Affine3A equivalents. Key changes include:<ol><li>Using view.world_from_view.affine() instead of view.world_from_view.to_matrix()<li>Extracting camera axes from the affine matrix’s matrix3 component<li>Using Vec3A for vector operations instead of Vec3<li>Constructing the transformation using Affine3A::from_cols()<li>Computing the inverse using the more efficient affine inverse operation</ol><p>The Affine3A inverse operation is significantly faster than Mat4 inverse because it leverages the mathematical properties of affine transformations, avoiding the full general matrix inversion process. This optimization reduces computational overhead in the atmosphere rendering pipeline while maintaining identical visual results.<p>The changes were validated using the existing atmosphere example, ensuring that the visual output remained consistent while achieving the performance improvement.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[View Matrix] --> B[Extract Affine Transformation]
</span><span>    B --> C[Calculate Atmosphere Axes]
</span><span>    C --> D[Construct Affine3A Transformation]
</span><span>    D --> E[Compute Inverse]
</span><span>    E --> F[Convert to Mat4 for Storage]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>File</strong>: <code>crates/bevy_pbr/src/atmosphere/resources.rs</code><p><strong>Changes</strong>: Replaced Mat4-based transformation calculations with more efficient Affine3A operations to avoid expensive matrix inversions.<p><strong>Key modifications</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> world_from_view </span><span style=color:#ed9366>=</span><span> view</span><span style=color:#ed9366>.</span><span>world_from_view</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_matrix</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> camera_z </span><span style=color:#ed9366>=</span><span> world_from_view</span><span style=color:#ed9366>.</span><span>z_axis</span><span style=color:#ed9366>.</span><span style=color:#f07171>truncate</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> camera_y </span><span style=color:#ed9366>=</span><span> world_from_view</span><span style=color:#ed9366>.</span><span>y_axis</span><span style=color:#ed9366>.</span><span style=color:#f07171>truncate</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// ... Mat4 operations ...
</span><span style=color:#fa6e32>let</span><span> atmosphere_from_world </span><span style=color:#ed9366>=</span><span> world_from_atmosphere</span><span style=color:#ed9366>.</span><span style=color:#f07171>inverse</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> world_from_view </span><span style=color:#ed9366>=</span><span> view</span><span style=color:#ed9366>.</span><span>world_from_view</span><span style=color:#ed9366>.</span><span style=color:#f07171>affine</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> camera_z </span><span style=color:#ed9366>=</span><span> world_from_view</span><span style=color:#ed9366>.</span><span>matrix3</span><span style=color:#ed9366>.</span><span>z_axis</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> camera_y </span><span style=color:#ed9366>=</span><span> world_from_view</span><span style=color:#ed9366>.</span><span>matrix3</span><span style=color:#ed9366>.</span><span>y_axis</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// ... Affine3A operations ...
</span><span style=color:#fa6e32>let</span><span> atmosphere_from_world </span><span style=color:#ed9366>= </span><span>Mat4</span><span style=color:#ed9366>::</span><span>from(world_from_atmosphere</span><span style=color:#ed9366>.</span><span style=color:#f07171>inverse</span><span>())</span><span style=color:#61676ccc>;
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Affine_transformation target=_blank>Affine Transformations (Wikipedia)</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_math/latest/bevy_math/ target=_blank>Bevy Math Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://www.amazon.com/Computer-Graphics-Principles-Practice-3rd/dp/0321399528 target=_blank>Computer Graphics: Principles and Practice - Affine Transformations</a></ul><h1 id=full-code-diff>Full Code Diff</h1><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_pbr/src/atmosphere/resources.rs b/crates/bevy_pbr/src/atmosphere/resources.rs
</span><span>index 9e3a75d4b6921..ecabc6fe7bc12 100644
</span><span style=color:#c594c5>--- a/crates/bevy_pbr/src/atmosphere/resources.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_pbr/src/atmosphere/resources.rs
</span><span style=color:#c594c5>@@ -11,7 +11,7 @@ </span><span style=color:#399ee6>use bevy_ecs::{
</span><span>     world::{FromWorld, World},
</span><span> };
</span><span> use bevy_image::ToExtents;
</span><span style=color:#f07171>-use bevy_math::{Mat4, Vec3};
</span><span style=color:#86b300>+use bevy_math::{Affine3A, Mat4, Vec3A};
</span><span> use bevy_render::{
</span><span>     extract_component::ComponentUniforms,
</span><span>     render_resource::{binding_types::*, *},
</span><span style=color:#c594c5>@@ -530,23 +530,20 @@ </span><span style=color:#399ee6>pub(super) fn prepare_atmosphere_transforms(
</span><span>     };
</span><span> 
</span><span>     for (entity, view) in &views {
</span><span style=color:#f07171>-        let world_from_view = view.world_from_view.to_matrix();
</span><span style=color:#f07171>-        let camera_z = world_from_view.z_axis.truncate();
</span><span style=color:#f07171>-        let camera_y = world_from_view.y_axis.truncate();
</span><span style=color:#86b300>+        let world_from_view = view.world_from_view.affine();
</span><span style=color:#86b300>+        let camera_z = world_from_view.matrix3.z_axis;
</span><span style=color:#86b300>+        let camera_y = world_from_view.matrix3.y_axis;
</span><span>         let atmo_z = camera_z
</span><span>             .with_y(0.0)
</span><span>             .try_normalize()
</span><span>             .unwrap_or_else(|| camera_y.with_y(0.0).normalize());
</span><span style=color:#f07171>-        let atmo_y = Vec3::Y;
</span><span style=color:#86b300>+        let atmo_y = Vec3A::Y;
</span><span>         let atmo_x = atmo_y.cross(atmo_z).normalize();
</span><span style=color:#f07171>-        let world_from_atmosphere = Mat4::from_cols(
</span><span style=color:#f07171>-            atmo_x.extend(0.0),
</span><span style=color:#f07171>-            atmo_y.extend(0.0),
</span><span style=color:#f07171>-            atmo_z.extend(0.0),
</span><span style=color:#f07171>-            world_from_view.w_axis,
</span><span style=color:#f07171>-        );
</span><span style=color:#86b300>+        let world_from_atmosphere =
</span><span style=color:#86b300>+            Affine3A::from_cols(atmo_x, atmo_y, atmo_z, world_from_view.translation);
</span><span> 
</span><span style=color:#f07171>-        let atmosphere_from_world = world_from_atmosphere.inverse();
</span><span style=color:#86b300>+        let atmosphere_from_world = Mat4::from(world_from_atmosphere.inverse());
</span><span style=color:#86b300>+        let world_from_atmosphere = Mat4::from(world_from_atmosphere);
</span><span> 
</span><span>         commands.entity(entity).insert(AtmosphereTransformsOffset {
</span><span>             index: writer.write(&AtmosphereTransform {
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-08/pr_20711.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>