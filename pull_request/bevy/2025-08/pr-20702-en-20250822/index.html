<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20702 Don't invert an affine matrix as if it was a mat4
        
    </title><meta content="#20702 Don't invert an affine matrix as if it was a mat4" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-08/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-08-22</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-08/pr-20702-zh-cn-20250822>中文</a></div></div><div class=pr-content><h1 id=title-don-t-invert-an-affine-matrix-as-if-it-was-a-mat4>Title: Don’t invert an affine matrix as if it was a mat4</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Don’t invert an affine matrix as if it was a mat4<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20702<li><strong>Author</strong>: atlv24<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, D-Trivial, A-Rendering, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-08-22T06:45:52Z<li><strong>Merged</strong>: 2025-08-22T21:53:48Z<li><strong>Merged By</strong>: james7132</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Don’t invert an affine matrix as if it was a mat4</ul><h2 id=solution>Solution</h2><ul><li>keep it affine</ul><h2 id=testing>Testing</h2><p>shadow biases example<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a performance optimization in Bevy’s camera projection system. The core issue was in the <code>compute_frustum</code> method of the <code>CameraProjection</code> trait, where camera transforms were being inverted using a general-purpose 4x4 matrix inversion when they could have been handled more efficiently as affine transformations.<p>The problem stemmed from how <code>GlobalTransform</code> matrices were being processed. While <code>GlobalTransform</code> represents an affine transformation (composed of rotation, translation, and scale), the original code was treating it as a general 4x4 matrix and using <code>Mat4::inverse()</code>, which performs a full matrix inversion without leveraging the known structure of affine transformations.<p>The solution was straightforward but impactful: instead of converting the transform to a full 4x4 matrix and inverting it, the code now extracts the affine component using <code>GlobalTransform::affine()</code> and calls <code>Affine3A::inverse()</code>. This approach is mathematically equivalent but computationally more efficient because it takes advantage of the known structure of affine transformations, avoiding unnecessary calculations for the bottom row of the matrix which is always <code>[0, 0, 0, 1]</code> in affine transforms.<p>The change is minimal - just a single line modification - but it demonstrates an important optimization principle: using the most specific mathematical operation available rather than general-purpose computations. This is particularly valuable in graphics programming where matrix operations are performed frequently in hot paths like frustum calculation.<p>The fix was tested using the shadow biases example, ensuring that the mathematical correctness was preserved while gaining performance benefits. This type of optimization is especially valuable in rendering systems where every matrix operation counts, particularly when dealing with multiple cameras or complex scenes.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[CameraProjection.compute_frustum] --> B[Get clip from view matrix]
</span><span>    B --> C[Get camera transform]
</span><span>    C --> D[Inverse transform]
</span><span>    D --> E[Multiply matrices]
</span><span>    E --> F[Create frustum]
</span><span>    
</span><span>    subgraph "Optimization Change"
</span><span>        D -.-> G[Use affine().inverse() instead of to_matrix().inverse()]
</span><span>    end
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>File: <code>crates/bevy_camera/src/projection.rs</code></strong><p>This file contains the <code>CameraProjection</code> trait and its implementations. The change was made to the <code>compute_frustum</code> method which calculates the viewing frustum for a camera.<p><strong>Change:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> clip_from_world </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_clip_from_view</span><span>() </span><span style=color:#ed9366>*</span><span> camera_transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_matrix</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>inverse</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> clip_from_world </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_clip_from_view</span><span>() </span><span style=color:#ed9366>*</span><span> camera_transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>affine</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>inverse</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><p>The modification replaces the general matrix inversion (<code>to_matrix().inverse()</code>) with a specialized affine inversion (<code>affine().inverse()</code>). This change improves performance by leveraging the known structure of affine transformations, avoiding unnecessary computations for the bottom row of the 4x4 matrix which is always <code>[0, 0, 0, 1]</code> in affine transforms.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Affine_transformation target=_blank>Affine transformation - Wikipedia</a><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Invertible_matrix target=_blank>Matrix inversion - Wikipedia</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_camera/latest/bevy_camera/projection/trait.CameraProjection.html target=_blank>Bevy Camera Projection Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/glam/latest/glam/struct.Affine3A.html target=_blank>glam crate (Bevy’s math library) Affine3A documentation</a></ul><h2 id=full-code-diff>Full Code Diff</h2><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_camera/src/projection.rs b/crates/bevy_camera/src/projection.rs
</span><span>index f95959c43986c..9a1d61f4ee981 100644
</span><span style=color:#c594c5>--- a/crates/bevy_camera/src/projection.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_camera/src/projection.rs
</span><span style=color:#c594c5>@@ -68,7 +68,7 @@ </span><span style=color:#399ee6>pub trait CameraProjection {
</span><span>     /// This code is called by [`update_frusta`](crate::visibility::update_frusta) system
</span><span>     /// for each camera to update its frustum.
</span><span>     fn compute_frustum(&self, camera_transform: &GlobalTransform) -> Frustum {
</span><span style=color:#f07171>-        let clip_from_world = self.get_clip_from_view() * camera_transform.to_matrix().inverse();
</span><span style=color:#86b300>+        let clip_from_world = self.get_clip_from_view() * camera_transform.affine().inverse();
</span><span>         Frustum::from_clip_from_world_custom_far(
</span><span>             &clip_from_world,
</span><span>             &camera_transform.translation(),
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-08/pr_20702.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>