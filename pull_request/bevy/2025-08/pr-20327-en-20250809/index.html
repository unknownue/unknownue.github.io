<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20327 Make shadows respect render layers
        
    </title><meta content="#20327 Make shadows respect render layers" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-08/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-08-09</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-08/pr-20327-zh-cn-20250809>中文</a></div></div><div class=pr-content><h1 id=analysis-of-pr-20327-make-shadows-respect-render-layers>Analysis of PR #20327: Make shadows respect render layers</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Make shadows respect render layers<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20327<li><strong>Author</strong>: tychedelia<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-07-29T22:28:06Z<li><strong>Merged</strong>: 2025-08-09T01:41:09Z<li><strong>Merged By</strong>: james7132</ul><h2 id=description-translation>Description Translation</h2><p>Adopted from and closes #18747. Original work by @Adriigbs.<p>Shadows and render layers are a bit complicated. Ideally, this filtering would be done at a higher level, but the camera entity just holds a list of references to the light entities for that view. Those light entities then compute what entities are visible from their perspective. We don’t actually get a chance to filter camera and light visible entity until we queue the shadow pass, which is where this PR chooses to filter out entities that aren’t visible in a camera from casting shadows.<p>The alternative would be to store a per camera per light list of entities, which would greatly increase the amount of memory required for visible entities in multi-camera setups.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=the-problem-and-context>The Problem and Context</h3><p>The core issue addressed in this PR is that shadows were not respecting render layers. In Bevy’s rendering system, <code>RenderLayers</code> are used to control which entities are visible to specific cameras. However, before this change, entities would still cast shadows in a camera’s view even if they weren’t on a render layer visible to that camera. This occurred because the shadow queueing system didn’t consider the camera’s render layers when determining which entities should cast shadows.<p>The challenge was implementing this filtering efficiently. The camera entity only holds references to light entities, and lights compute visibility from their perspective. The earliest point where we can filter based on both camera and light visibility is during shadow pass queueing.<h3 id=the-solution-approach>The Solution Approach</h3><p>The solution involves two key changes:<ol><li>Make camera render layers available during shadow queueing<li>Store mesh render layers during mesh extraction for later comparison</ol><p>This approach was chosen over the alternative of storing per-camera per-light entity lists, which would significantly increase memory usage in multi-camera setups. By performing the filtering during shadow queueing, we avoid that memory overhead while still achieving correct behavior.<h3 id=the-implementation>The Implementation</h3><p>The implementation required modifications in two main areas:<ol><li><strong>Shadow Queueing (<code>light.rs</code>):</strong> <ul><li>Modified the view query to include camera render layers<li>Added a render layer intersection check before processing entities for shadows<li>Moved the cache validation after the render layer check to avoid unnecessary work</ul></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// In queue_shadows system
</span><span style=color:#fa6e32>for </span><span>(entity</span><span style=color:#61676ccc>,</span><span> view_lights</span><span style=color:#61676ccc>,</span><span> camera_layers) </span><span style=color:#ed9366>in &</span><span>view_lights {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>    </span><span style=color:#fa6e32>for</span><span> main_entity </span><span style=color:#ed9366>in</span><span> visible_entities</span><span style=color:#ed9366>.</span><span>entities</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>copied</span><span>() {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>        </span><span style=color:#fa6e32>let</span><span> mesh_layers </span><span style=color:#ed9366>=</span><span> mesh_instance
</span><span>            </span><span style=color:#ed9366>.</span><span>shared
</span><span>            </span><span style=color:#ed9366>.</span><span>render_layers
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>as_ref</span><span>()
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_or_default</span><span>()</span><span style=color:#61676ccc>;
</span><span>        
</span><span>        </span><span style=color:#fa6e32>let</span><span> camera_layers </span><span style=color:#ed9366>=</span><span> camera_layers</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_or_default</span><span>()</span><span style=color:#61676ccc>;
</span><span>        
</span><span>        </span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>camera_layers</span><span style=color:#ed9366>.</span><span style=color:#f07171>intersects</span><span>(mesh_layers) {
</span><span>            </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>        
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// Skip the entity if it's cached in a bin and up to date
</span><span>        </span><span style=color:#fa6e32>if</span><span> shadow_phase</span><span style=color:#ed9366>.</span><span style=color:#f07171>validate_cached_entity</span><span>(main_entity</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>*</span><span>current_change_tick) {
</span><span>            </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ... rest of processing
</span><span>    }
</span><span>}
</span></code></pre><ol start=2><li><strong>Mesh Extraction (<code>mesh.rs</code>):</strong> <ul><li>Added <code>render_layers</code> field to <code>RenderMeshInstanceShared</code><li>Modified mesh extraction queries to include <code>RenderLayers</code><li>Propagated render layers through the extraction process</ul></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added to RenderMeshInstanceShared
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>RenderMeshInstanceShared </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... existing fields
</span><span>    </span><span style=color:#fa6e32>pub </span><span>render_layers</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTRenderLayers>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Updated extraction queries
</span><span style=color:#fa6e32>type </span><span style=color:#399ee6>GpuMeshExtractionQuery </span><span style=color:#ed9366>= </span><span>(
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... existing components
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTRead&LTRenderLayers>></span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Updated extraction logic
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>extract_mesh_for_gpu_building</span><span>(
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... existing parameters
</span><span>    </span><span style=color:#ff8f40>render_layers</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#ed9366>&</span><span>RenderLayers>,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>let</span><span> shared </span><span style=color:#ed9366>= </span><span>RenderMeshInstanceShared</span><span style=color:#ed9366>::</span><span>for_cpu_building(
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ... other parameters
</span><span>        render_layers</span><span style=color:#61676ccc>,
</span><span>    )</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=technical-insights>Technical Insights</h3><p>The key technical aspects of this solution include:<ol><li><p><strong>Render Layer Propagation:</strong> The solution propagates render layer information from entities to both mesh instances and cameras, making it available at the critical shadow queueing point.</p><li><p><strong>Efficiency Considerations:</strong> By placing the render layer check before cache validation, we avoid unnecessary cache lookups for entities that will be skipped anyway. This ordering minimizes performance impact.</p><li><p><strong>Compatibility Handling:</strong> The implementation properly handles cases where render layers might not be present (using <code>Option</code> and <code>unwrap_or_default</code>), maintaining backward compatibility.</p></ol><h3 id=the-impact>The Impact</h3><p>This change fixes a significant rendering bug where entities would cast shadows in cameras they shouldn’t be visible in. The solution:<ul><li>Correctly respects render layer configurations<li>Maintains performance by avoiding expensive memory allocations<li>Preserves existing behavior when render layers aren’t used<li>Adds minimal overhead (just an additional intersection check per entity)</ul><p>The changes demonstrate a pattern for propagating component data through Bevy’s rendering pipeline to where it’s needed for specialized processing.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Camera] -->|Provides| B[RenderLayers]
</span><span>    C[Mesh Entity] -->|Provides| D[RenderLayers]
</span><span>    B --> E[Shadow Queueing]
</span><span>    D --> E
</span><span>    E -->|Filters| F[Shadow Casters]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-pbr-src-render-light-rs-19-7><code>crates/bevy_pbr/src/render/light.rs</code> (+19/-7)</h3><p>This file contains the shadow queueing logic. The key change adds render layer filtering to skip entities that shouldn’t cast shadows in the current camera view.<p><strong>Key modifications:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>view_lights</span><span style=color:#61676ccc>: </span><span>Query<(Entity, </span><span style=color:#ed9366>&</span><span>ViewLightEntities), With&LTExtractedView>></span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>view_lights</span><span style=color:#61676ccc>: </span><span>Query<(Entity, </span><span style=color:#ed9366>&</span><span>ViewLightEntities, </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#ed9366>&</span><span>RenderLayers>), With&LTExtractedView>></span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Added render layer check:
</span><span style=color:#fa6e32>let</span><span> mesh_layers </span><span style=color:#ed9366>=</span><span> mesh_instance
</span><span>    </span><span style=color:#ed9366>.</span><span>shared
</span><span>    </span><span style=color:#ed9366>.</span><span>render_layers
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>as_ref</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_or_default</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>let</span><span> camera_layers </span><span style=color:#ed9366>=</span><span> camera_layers</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_or_default</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>camera_layers</span><span style=color:#ed9366>.</span><span style=color:#f07171>intersects</span><span>(mesh_layers) {
</span><span>    </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=crates-bevy-pbr-src-render-mesh-rs-14-0><code>crates/bevy_pbr/src/render/mesh.rs</code> (+14/-0)</h3><p>This file handles mesh extraction. The changes propagate render layer information to mesh instances for use during shadow queueing.<p><strong>Key modifications:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added to RenderMeshInstanceShared:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>RenderMeshInstanceShared </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... existing fields
</span><span>    </span><span style=color:#fa6e32>pub </span><span>render_layers</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTRenderLayers>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Updated extraction queries:
</span><span style=color:#fa6e32>type </span><span style=color:#399ee6>GpuMeshExtractionQuery </span><span style=color:#ed9366>= </span><span>(
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... existing components
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTRead&LTRenderLayers>></span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Updated in extraction logic:
</span><span>shared</span><span style=color:#ed9366>.</span><span>render_layers </span><span style=color:#ed9366>=</span><span> render_layers</span><span style=color:#ed9366>.</span><span style=color:#f07171>cloned</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_render/latest/bevy_render/view/struct.RenderLayers.html target=_blank>Bevy Render Layers Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/pipeline.html target=_blank>Bevy Rendering Pipeline Overview</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/issues/18747 target=_blank>Original Issue #18747</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-08/pr_20327.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>