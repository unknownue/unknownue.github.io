<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20788 Enable load_with_settings TextureFormats
        
    </title><meta content="#20788 Enable load_with_settings TextureFormats" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-08/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-08-31</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-08/pr-20788-zh-cn-20250831>中文</a></div></div><div class=pr-content><h1 id=enable-load-with-settings-textureformats>Enable load_with_settings TextureFormats</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Enable load_with_settings TextureFormats<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20788<li><strong>Author</strong>: ChristopherBiscardi<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, S-Ready-For-Review<li><strong>Created</strong>: 2025-08-29T18:10:59Z<li><strong>Merged</strong>: 2025-08-31T08:23:18Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><p>Previously, loading an image resulted in a hard-coded TextureFormat. When loading images that are meant to be used as the <code>StandardMaterial::depth_map</code>, the data can be stored in ways that result in an <code>R16Uint</code> TextureFormat. This results in an error because the <code>depth_map</code> must be a Float sampler and not a Uint sampler.<p>2025-08-29T17:15:03.081069Z ERROR bevy_render::erased_render_asset: bevy_pbr::mesh_material::MeshMaterial3d&LTbevy_pbr::extended_material::ExtendedMaterial&LTbevy_pbr::pbr_material::StandardMaterial, test_uv_transform::MyExtension>> Bind group construction failed: At binding index 12, the provided image sampler <code>Uint</code> does not match the required sampler type(s) <code>[Float { filterable: true }]</code>.<p>Setting the TextureFormat can adjust the way in which the same image data shows up in the shader. For example, an image that would otherwise be <code>TextureFormat::R16Uint</code> can be set to <code>TextureFormat::R16Unorm</code>, with no other changes, which results in the 16-bit integer data being converted to the 0-1 range for the shader.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>asset_server</span><span style=color:#ed9366>.</span><span style=color:#f07171>load_with_settings</span><span>(
</span><span>    </span><span style=color:#86b300>"grass_height.png"</span><span style=color:#61676ccc>,
</span><span>    |</span><span style=color:#ff8f40>settings</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> ImageLoaderSettings| {
</span><span>        settings</span><span style=color:#ed9366>.</span><span>texture_format </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(TextureFormat</span><span style=color:#ed9366>::</span><span>R16Unorm)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>)</span><span style=color:#61676ccc>,
</span></code></pre><p>This PR adds the ability to set the texture format with using <code>load_with_settings</code>.<p>Software like Substance Designer outputs height data in what becomes <code>R16Uint</code> format, but depth_map requires <code>R16Unorm</code>.<p>–<p>Additional notes:<ul><li>TextureFormat does not have a serde implementation, so is skipped in this PR<li>This PR tries to change as little as possible when it comes to Image creation, so does not add a TextureFormat option to Image constructors like <code>from_buffer</code> and <code>from_dynamic</code>, which is what is used by the ImageLoader. It also ends up relying on a conversion from <a rel="noopener nofollow noreferrer" href=https://docs.rs/image/0.25.6/image/enum.DynamicImage.html target=_blank><code>DynamicImage</code></a>, which doesn’t have enough information to make this judgement afaict.<li>Alternative strategies could include using a LoadTransformAndSave sequence to correct the data, but this is not straightforward as the tools to do this are not obvious (specifically the conversion from the Vec<u8> image crate representation + filename guessing when loading the processed image). <h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2> <p>This PR addresses a specific rendering issue where depth map images with 16-bit integer data couldn’t be properly sampled by shaders. The problem occurred because Bevy’s image loader automatically detected certain image formats as <code>R16Uint</code>, but the depth map functionality required <code>R16Unorm</code> format for proper float sampling.</p> <p>The core issue was in the texture format mismatch: shaders expected float samplers but received uint samplers when using images from tools like Substance Designer that export height data in 16-bit integer formats. This caused bind group construction failures during rendering.</p> <p>The solution implements a minimal change to the existing <code>load_with_settings</code> infrastructure. Instead of modifying core image creation methods or adding complex format detection logic, the PR adds an optional <code>texture_format</code> field to <code>ImageLoaderSettings</code>. This allows users to explicitly override the texture format when loading images, providing the flexibility needed for specialized use cases like depth maps.</p> <p>The implementation follows Bevy’s established patterns for asset loading customization. The new field is marked with <code>#[serde(skip)]</code> because <code>TextureFormat</code> doesn’t have serde implementations, which aligns with the PR’s goal of minimal changes. After the image is loaded using the existing pipeline, the code conditionally applies the user-specified format override.</p> <p>This approach maintains backward compatibility while solving the specific rendering issue. The changes are surgical and focused, affecting only the image loading process without disrupting other parts of the rendering pipeline.</p> <h2 id=visual-representation>Visual Representation</h2> <pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[ImageLoaderSettings] --> B[ImageLoader]
</span><span>    B --> C[Image Creation]
</span><span>    C --> D{TextureFormat&LTbr>Override?}
</span><span>    D -->|Yes| E[Apply Custom Format]
</span><span>    D -->|No| F[Use Default Format]
</span><span>    E --> G[Final Image]
</span><span>    F --> G
</span></code></pre> <h2 id=key-files-changed>Key Files Changed</h2> <h3 id=crates-bevy-image-src-image-loader-rs-15-1><code>crates/bevy_image/src/image_loader.rs</code> (+15/-1)</h3> <p>This file contains the main implementation changes:</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added field to ImageLoaderSettings struct
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>ImageLoaderSettings </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>format</span><span style=color:#61676ccc>:</span><span> ImageFormatSetting,
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>serde</span><span>(skip)]
</span><span>    </span><span style=color:#fa6e32>pub </span><span>texture_format</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTwgpu_types</span><span style=color:#ed9366>::</span><span>TextureFormat>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other fields
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Updated Default implementation
</span><span style=color:#fa6e32>impl </span><span>Default </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>ImageLoaderSettings </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>default</span><span>() </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>        </span><span style=color:#fa6e32>Self </span><span>{
</span><span>            format</span><span style=color:#61676ccc>: </span><span>ImageFormatSetting</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>,
</span><span>            texture_format</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>None</span><span style=color:#61676ccc>,  </span><span style=color:#abb0b6;font-style:italic>// New field
</span><span>            </span><span style=color:#abb0b6;font-style:italic>// ... other fields
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Modified asset loading logic
</span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>image</span><span>| {
</span><span>    </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(format) </span><span style=color:#ed9366>=</span><span> settings</span><span style=color:#ed9366>.</span><span>texture_format {
</span><span>        image</span><span style=color:#ed9366>.</span><span>texture_descriptor</span><span style=color:#ed9366>.</span><span>format </span><span style=color:#ed9366>=</span><span> format</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>    image
</span><span>})
</span></code></pre> <h3 id=crates-bevy-image-src-compressed-image-saver-rs-1-0><code>crates/bevy_image/src/compressed_image_saver.rs</code> (+1/-0)</h3> <p>This file received a minor update to maintain consistency:</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Updated when creating ImageLoaderSettings for saving
</span><span>ImageLoaderSettings {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other settings
</span><span>    texture_format</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>None</span><span style=color:#61676ccc>,  </span><span style=color:#abb0b6;font-style:italic>// Added field
</span><span>}
</span></code></pre> <h2 id=further-reading>Further Reading</h2> <ul><li><a rel="noopener nofollow noreferrer" href=https://gpuweb.github.io/gpuweb/#texture-format-caps target=_blank>WebGPU Texture Formats</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/books/0.13/programming/assets/ target=_blank>Bevy Asset System</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/books/0.13/programming/assets/image/ target=_blank>Image Loading in Bevy</a><li><a rel="noopener nofollow noreferrer" href=https://www.w3.org/TR/WGSL/#sampler-types target=_blank>WGSL Sampler Types</a></ul>    <div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-08/pr_20788.patch id=patch-info style=display:none></div>  <div class=bottom-spacer></div> 