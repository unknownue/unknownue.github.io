<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20657 Regression tests for observers whose Observer component is removed.
        
    </title><meta content="#20657 Regression tests for observers whose Observer component is removed." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-08/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-08-19</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-08/pr-20657-zh-cn-20250819>中文</a></div></div><div class=pr-content><h1 id=regression-tests-for-observers-whose-observer-component-is-removed>Regression tests for observers whose Observer component is removed.</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Regression tests for observers whose Observer component is removed.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20657<li><strong>Author</strong>: gwafotapa<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-ECS, S-Ready-For-Final-Review, C-Testing, X-Uncontroversial, D-Straightforward<li><strong>Created</strong>: 2025-08-19T17:08:49Z<li><strong>Merged</strong>: 2025-08-19T18:39:46Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>Regression test of #19673 .<p>The issue above has been fixed by the observer overhaul. This PR adds the regression tests.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a specific gap in Bevy’s test coverage for the Entity Component System (ECS) observer functionality. The core issue was ensuring that when an Observer component is removed from an entity, the observer is properly unregistered from all relevant observer tracking systems to prevent stale references and potential bugs.<p>The problem stemmed from a previous issue (#19673) where observers weren’t being properly cleaned up when their Observer component was removed. While that specific bug had been fixed by the observer overhaul, there were no regression tests to prevent similar issues from reoccurring in the future. This is a common pattern in software engineering - after fixing a bug, adding tests to ensure it doesn’t regress is crucial for maintaining code quality.<p>The solution approach was straightforward: add comprehensive test coverage for three different types of observers (global, entity-based, and component-based) to verify that removing the Observer component correctly cleans up all observer registrations. Each test follows a consistent pattern:<ol><li>Create an observer of a specific type<li>Remove the Observer component<li>Verify that the observer is no longer registered in the appropriate tracking structure</ol><p>The implementation consists of three test functions that cover the main observer types in Bevy’s ECS:<ol><li><strong>Global observers</strong>: Observers that watch for events across the entire world<li><strong>Entity observers</strong>: Observers that are tied to specific entities<li><strong>Component observers</strong>: Observers that watch for component-specific events</ol><p>Each test uses the same verification pattern - after removing the Observer component, it checks that the observer is no longer present in the appropriate observer collection. The tests use Bevy’s internal observer APIs to directly inspect the observer tracking structures, ensuring the cleanup is working correctly at the implementation level.<p>The technical insight here is that observers in Bevy are managed through multiple layered data structures, and proper cleanup requires removing references from all relevant locations. The tests verify that the observer overhaul correctly handles this cleanup process across different observer types.<p>The impact of these changes is improved test coverage and regression protection for a critical part of Bevy’s ECS system. These tests ensure that observer cleanup works correctly, preventing memory leaks, stale references, and potential panics that could occur if observers weren’t properly unregistered.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Observer Tests] --> B[Global Observer Test]
</span><span>    A --> C[Entity Observer Test]
</span><span>    A --> D[Component Observer Test]
</span><span>    
</span><span>    B --> E[Create global observer]
</span><span>    B --> F[Remove Observer component]
</span><span>    B --> G[Verify unregistered from global_observers]
</span><span>    
</span><span>    C --> H[Create entity observer]
</span><span>    C --> I[Remove Observer component]
</span><span>    C --> J[Verify unregistered from entity_observers]
</span><span>    
</span><span>    D --> K[Create component observer]
</span><span>    D --> L[Remove Observer component]
</span><span>    D --> M[Verify unregistered from component_observers]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ecs-src-observer-mod-rs-44-0><code>crates/bevy_ecs/src/observer/mod.rs</code> (+44/-0)</h3><p>This file received three new test functions that verify proper observer cleanup when the Observer component is removed. The tests cover all major observer types in Bevy’s ECS system.<p><strong>Key changes:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>unregister_global_observer</span><span>() {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> world </span><span style=color:#ed9366>= </span><span>World</span><span style=color:#ed9366>::</span><span>new()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> observer </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_observer</span><span>(|_: On&LTEventA>| {})</span><span style=color:#61676ccc>;
</span><span>    observer</span><span style=color:#ed9366>.</span><span>remove</span><span style=color:#ed9366>::</span><span>&LTObserver>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> id </span><span style=color:#ed9366>=</span><span> observer</span><span style=color:#ed9366>.</span><span style=color:#f07171>id</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> event_key </span><span style=color:#ed9366>= </span><span>EventA</span><span style=color:#ed9366>::</span><span>event_key(</span><span style=color:#ed9366>&</span><span>world)</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#f07171>assert!</span><span>(</span><span style=color:#ed9366>!</span><span>world
</span><span>        </span><span style=color:#ed9366>.</span><span>observers
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>get_observers_mut</span><span>(event_key)
</span><span>        </span><span style=color:#ed9366>.</span><span>global_observers
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>contains_key</span><span>(</span><span style=color:#ed9366>&</span><span>id))</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>unregister_entity_observer</span><span>() {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> world </span><span style=color:#ed9366>= </span><span>World</span><span style=color:#ed9366>::</span><span>new()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> entity </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn_empty</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>id</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> observer </span><span style=color:#ed9366>= </span><span>Observer</span><span style=color:#ed9366>::</span><span>new(|_: On&LTEventA>| {})</span><span style=color:#ed9366>.</span><span style=color:#f07171>with_entity</span><span>(entity)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> observer </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>(observer)</span><span style=color:#61676ccc>;
</span><span>    observer</span><span style=color:#ed9366>.</span><span>remove</span><span style=color:#ed9366>::</span><span>&LTObserver>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> event_key </span><span style=color:#ed9366>= </span><span>EventA</span><span style=color:#ed9366>::</span><span>event_key(</span><span style=color:#ed9366>&</span><span>world)</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#f07171>assert!</span><span>(</span><span style=color:#ed9366>!</span><span>world
</span><span>        </span><span style=color:#ed9366>.</span><span>observers
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>get_observers_mut</span><span>(event_key)
</span><span>        </span><span style=color:#ed9366>.</span><span>entity_observers
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>contains_key</span><span>(</span><span style=color:#ed9366>&</span><span>entity))</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>unregister_component_observer</span><span>() {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> world </span><span style=color:#ed9366>= </span><span>World</span><span style=color:#ed9366>::</span><span>new()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> a </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span>register_component</span><span style=color:#ed9366>::</span><span>&LTA>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> observer </span><span style=color:#ed9366>= </span><span>Observer</span><span style=color:#ed9366>::</span><span>new(|_: On&LTEventA>| {})</span><span style=color:#ed9366>.</span><span style=color:#f07171>with_component</span><span>(a)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> observer </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>(observer)</span><span style=color:#61676ccc>;
</span><span>    observer</span><span style=color:#ed9366>.</span><span>remove</span><span style=color:#ed9366>::</span><span>&LTObserver>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> event_key </span><span style=color:#ed9366>= </span><span>EventA</span><span style=color:#ed9366>::</span><span>event_key(</span><span style=color:#ed9366>&</span><span>world)</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#f07171>assert!</span><span>(</span><span style=color:#ed9366>!</span><span>world
</span><span>        </span><span style=color:#ed9366>.</span><span>observers
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>get_observers_mut</span><span>(event_key)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>get_component_observers</span><span>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>contains_key</span><span>(</span><span style=color:#ed9366>&</span><span>a))</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>These tests follow a consistent pattern:<ol><li>Create a World and set up an observer of a specific type<li>Remove the Observer component from the observer entity<li>Verify that the observer is no longer present in the appropriate observer collection</ol><p>The tests use internal observer APIs (<code>get_observers_mut</code>, <code>global_observers</code>, <code>entity_observers</code>, <code>get_component_observers</code>) to directly inspect the observer tracking structures, ensuring that the cleanup is working correctly at the implementation level.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/advanced-topics/observers/ target=_blank>Bevy ECS Observers Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://martinfowler.com/articles/testing-culture.html#RegressionTests target=_blank>Regression Testing Best Practices</a><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Entity_component_system target=_blank>Entity Component System Pattern</a><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Test-driven_development target=_blank>Test-Driven Development</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-08/pr_20657.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>