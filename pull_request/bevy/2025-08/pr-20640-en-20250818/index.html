<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20640
        
    </title><meta content=#20640 property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-08/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-08-18</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-08/pr-20640-zh-cn-20250818>中文</a></div></div><div class=pr-content><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=the-problem-and-context>The Problem and Context</h3><p>GitHub recently updated their macOS runner images from macOS 14 to macOS 15, which broke Bevy’s iOS build pipeline. The iOS SDK required for building Bevy’s iOS examples was no longer available in the new environment. This caused immediate build failures in CI workflows that depended on iOS tooling, blocking development workflows. Additionally, unrelated tests in Bevy’s ECS module were failing due to overly strict error message validation, causing noise in test results. Both issues required prompt resolution to maintain development velocity.<h3 id=the-solution-approach>The Solution Approach</h3><p>The solution involved two parallel fixes:<ol><li>Temporarily pin all macOS-based CI workflows to macOS 14 runners to maintain iOS build capability<li>Modify ECS tests to use substring matching instead of exact string comparisons for error messages</ol><p>This approach prioritized immediate unblocking of CI pipelines while addressing flaky tests that could cause false negatives in future test runs. The macOS pinning was implemented as a temporary measure until the iOS example could be properly updated for macOS 15.<h3 id=the-implementation>The Implementation</h3><p>The changes were implemented across GitHub workflows and Bevy’s ECS module. For CI pipelines, all instances of <code>macos-latest</code> were replaced with <code>macos-14</code> to pin the runner version. This affected four workflow files responsible for example execution, screenshot generation, cache updates, and iOS validation.<p>For example, in <code>.github/workflows/example-run.yml</code>:<pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span style=color:#f07171>-    runs-on: macos-latest
</span><span style=color:#86b300>+    runs-on: macos-14
</span></code></pre><p>Additionally, a bug was fixed in the screenshot workflow where improper variable expansion caused branch names to be passed incorrectly:<pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span style=color:#f07171>-          metadata='{"os":"${{ inputs.os }}", "commit": "${{ inputs.commit }}", "branch": "$branch"}'
</span><span style=color:#86b300>+          metadata='{"os":"${{ inputs.os }}", "commit": "${{ inputs.commit }}", "branch": "'$branch'"}'
</span></code></pre><p>In the ECS module, tests were modified to verify the presence of core error messages rather than exact string matches. This made the tests more resilient to changes in error message formatting. The before/after comparison shows the improvement:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> expected </span><span style=color:#ed9366>= </span><span style=color:#86b300>"Parameter `Res&LTT>` failed validation: Resource does not exist</span><span style=color:#4cbf99>\n</span><span style=color:#86b300>"</span><span style=color:#61676ccc>;
</span><span style=color:#f07171>assert!</span><span>(result</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_err</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_string</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>contains</span><span>(expected))</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> expected </span><span style=color:#ed9366>= </span><span style=color:#86b300>"Resource does not exist"</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> actual </span><span style=color:#ed9366>=</span><span> result</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_err</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_string</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#f07171>assert!</span><span>(
</span><span>    actual</span><span style=color:#ed9366>.</span><span style=color:#f07171>contains</span><span>(expected)</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#86b300>"Expected error message to contain `{}` but got `{}`"</span><span style=color:#61676ccc>,
</span><span>    expected</span><span style=color:#61676ccc>,
</span><span>    actual
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=technical-insights>Technical Insights</h3><p>The CI changes demonstrate the importance of explicitly specifying environment versions in CI pipelines. Using <code>macos-latest</code> introduces implicit dependencies on third-party maintainers, making builds vulnerable to upstream changes. The test modifications follow the testing principle of verifying behavior rather than implementation details - by checking for substring presence instead of exact matches, the tests become more resilient to incidental changes in error message formatting.<h3 id=the-impact>The Impact</h3><p>These changes immediately restored CI functionality for iOS-related workflows and eliminated flaky test failures. By pinning the macOS version, the team bought time to properly update the iOS example for macOS 15. The test improvements reduced maintenance burden by making validation less brittle to unrelated changes in error messaging.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[GitHub Actions] --> B[macOS Runners]
</span><span>    B --> C[Pin to macOS 14]
</span><span>    C --> D[Restore iOS Builds]
</span><span>    A --> E[ECS Tests]
</span><span>    E --> F[Update Error Validation]
</span><span>    F --> G[Reduce Test Brittleness]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=github-workflows-example-run-yml>.github/workflows/example-run.yml</h3><p><strong>What changed</strong>: Pinned macOS runner to version 14<br> <strong>Why</strong>: To maintain iOS build capability<pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span style=color:#f07171>-    runs-on: macos-latest
</span><span style=color:#86b300>+    runs-on: macos-14
</span></code></pre><h3 id=github-workflows-send-screenshots-to-pixeleagle-yml>.github/workflows/send-screenshots-to-pixeleagle.yml</h3><p><strong>What changed</strong>: Fixed branch variable expansion and pinned macOS version<br> <strong>Why</strong>: Correct metadata handling and environment stability<pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span style=color:#f07171>-          metadata='{"os":"${{ inputs.os }}", "commit": "${{ inputs.commit }}", "branch": "$branch"}'
</span><span style=color:#86b300>+          metadata='{"os":"${{ inputs.os }}", "commit": "${{ inputs.commit }}", "branch": "'$branch'"}'
</span><span>...
</span><span style=color:#f07171>-    runs-on: macos-latest
</span><span style=color:#86b300>+    runs-on: macos-14
</span></code></pre><h3 id=github-workflows-update-caches-yml>.github/workflows/update-caches.yml</h3><p><strong>What changed</strong>: Pinned macOS runner for iOS cache updates<br> <strong>Why</strong>: Ensure consistent environment for cache generation<pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span style=color:#f07171>-          - os: macos-latest
</span><span style=color:#86b300>+          - os: macos-14
</span></code></pre><h3 id=github-workflows-validation-jobs-yml>.github/workflows/validation-jobs.yml</h3><p><strong>What changed</strong>: Pinned macOS runner for iOS validation<br> <strong>Why</strong>: Maintain build environment compatibility<pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span style=color:#f07171>-    runs-on: macos-latest
</span><span style=color:#86b300>+    runs-on: macos-14
</span></code></pre><h3 id=crates-bevy-ecs-src-system-system-rs>crates/bevy_ecs/src/system/system.rs</h3><p><strong>What changed</strong>: Updated error message validation in tests<br> <strong>Why</strong>: Make tests resilient to error message formatting changes<pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>         assert!(matches!(result, Err(RunSystemError::Failed { .. })));
</span><span style=color:#f07171>-        let expected = "Parameter `Res&LTT>` failed validation: Resource does not exist\n";
</span><span style=color:#f07171>-        assert!(result.unwrap_err().to_string().contains(expected));
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+        let expected = "Resource does not exist";
</span><span style=color:#86b300>+        let actual = result.unwrap_err().to_string();
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+        assert!(
</span><span style=color:#86b300>+            actual.contains(expected),
</span><span style=color:#86b300>+            "Expected error message to contain `{}` but got `{}`",
</span><span style=color:#86b300>+            expected,
</span><span style=color:#86b300>+            actual
</span><span style=color:#86b300>+        );
</span></code></pre><h3 id=crates-bevy-ecs-src-system-system-registry-rs>crates/bevy_ecs/src/system/system_registry.rs</h3><p><strong>What changed</strong>: Improved error message validation in registry tests<br> <strong>Why</strong>: Reduce test brittleness and improve failure diagnostics<pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>         assert!(matches!(result, Err(RegisteredSystemError::Failed { .. })));
</span><span style=color:#f07171>-        let expected = "System returned error: Parameter `Res&LTT>` failed validation: Resource does not exist\n";
</span><span style=color:#f07171>-        assert!(result.unwrap_err().to_string().contains(expected));
</span><span style=color:#86b300>+        let expected = "Resource does not exist";
</span><span style=color:#86b300>+        let actual = result.unwrap_err().to_string();
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+        assert!(
</span><span style=color:#86b300>+            actual.contains(expected),
</span><span style=color:#86b300>+            "Expected error message to contain `{}` but got `{}`",
</span><span style=color:#86b300>+            expected,
</span><span style=color:#86b300>+            actual
</span><span style=color:#86b300>+        );
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li>GitHub Actions Workflow Syntax: <a rel="noopener nofollow noreferrer" href=https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idruns-on target=_blank>Specifying runners</a><li>Testing Best Practices: <a rel="noopener nofollow noreferrer" href=https://testing.googleblog.com/2013/08/testing-on-toilet-testing-state-vs.html target=_blank>Behavior Verification vs. Implementation Verification</a><li>Bevy CI Documentation: <a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/.github/CONTRIBUTING.md#continuous-integration target=_blank>Continuous Integration Setup</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-08/pr_20640.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>