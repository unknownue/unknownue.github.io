<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20529 Atmosphere generated environment map lighting
        
    </title><meta content="#20529 Atmosphere generated environment map lighting" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-08/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-08-14</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-08/pr-20529-zh-cn-20250814>中文</a></div></div><div class=pr-content><h1 id=atmosphere-generated-environment-map-lighting-analysis>Atmosphere Generated Environment Map Lighting Analysis</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Atmosphere generated environment map lighting<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20529<li><strong>Author</strong>: mate-h<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Feature, A-Rendering, S-Ready-For-Final-Review, M-Needs-Release-Note<li><strong>Created</strong>: 2025-08-12T10:25:46Z<li><strong>Merged</strong>: 2025-08-14T18:17:02Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=the-problem-and-context>The Problem and Context</h3><p>The Bevy engine’s atmosphere system provided realistic sky rendering but didn’t contribute to environment lighting for reflections and diffuse illumination. Objects in scenes couldn’t reflect the atmospheric conditions, reducing visual fidelity. This limitation was tracked in issue #20374. The challenge was to generate dynamic environment maps from the atmosphere with minimal performance impact while maintaining compatibility with Bevy’s existing PBR pipeline.<h3 id=the-solution-approach>The Solution Approach</h3><p>The implementation introduces a new <code>AtmosphereEnvironmentMapLight</code> component that generates an environment map from the current atmosphere conditions. The approach leverages existing atmospheric lookup textures (LUTs) and computes a cubemap through a new compute shader. Key engineering decisions included:<ol><li>Using compute shaders instead of rasterization for better performance in cubemap generation<li>Reusing existing atmosphere LUTs to avoid redundant calculations<li>Implementing power-of-two size validation to prevent cubemap artifacts<li>Maintaining compatibility with existing <code>EnvironmentMapLight</code> infrastructure</ol><h3 id=the-implementation>The Implementation</h3><p>The solution adds a new <code>AtmosphereEnvironmentMapLight</code> component that users can attach to cameras:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((
</span><span>    Camera3d</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>,
</span><span>    AtmosphereEnvironmentMapLight</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>,
</span><span>))</span><span style=color:#61676ccc>;
</span></code></pre><p>This component triggers the creation of a cubemap texture that gets populated by a new compute pipeline. The implementation consists of:<ol><li><strong>Component handling</strong>: Creation and validation of environment map textures<li><strong>Compute pipeline</strong>: A new WGSL shader (<code>environment.wgsl</code>) that samples the atmosphere<li><strong>Resource management</strong>: Binding groups and textures for GPU operations<li><strong>Integration</strong>: Connection to Bevy’s rendering graph and existing atmosphere systems</ol><p>The environment map generation occurs in a new compute pass:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>pass</span><span style=color:#ed9366>.</span><span style=color:#f07171>dispatch_workgroups</span><span>(
</span><span>    env_map_light</span><span style=color:#ed9366>.</span><span>size</span><span style=color:#ed9366>.</span><span>x </span><span style=color:#ed9366>/ </span><span style=color:#ff8f40>8</span><span style=color:#61676ccc>,
</span><span>    env_map_light</span><span style=color:#ed9366>.</span><span>size</span><span style=color:#ed9366>.</span><span>y </span><span style=color:#ed9366>/ </span><span style=color:#ff8f40>8</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#ff8f40>6</span><span style=color:#61676ccc>, </span><span style=color:#abb0b6;font-style:italic>// 6 cubemap faces
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=technical-insights>Technical Insights</h3><p>The implementation efficiently reuses existing atmosphere data through several key techniques:<ol><li><strong>LUT sampling</strong>: The shader samples precomputed transmittance, multiscattering, and sky-view LUTs<li><strong>Coordinate transformation</strong>: Proper handling of cubemap face directions and coordinate systems<li><strong>Exposure compensation</strong>: Decoupling exposure calculation from inscattering for consistency</ol><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// environment.wgsl
</span><span>let ray_dir_ws = sample_cube_dir(uv, slice_index);
</span><span>ray_dir_ws.z = -ray_dir_ws.z; // Account for cubemap handedness
</span><span>let ray_dir_as = direction_world_to_atmosphere(ray_dir_ws.xyz);
</span><span>let inscattering = sample_sky_view_lut(r, ray_dir_as);
</span></code></pre><p>A notable fix was required in the rendering pipeline to separate exposure compensation from inscattering calculations, ensuring consistent results across different rendering paths.<h3 id=the-impact>The Impact</h3><p>This PR significantly enhances Bevy’s rendering capabilities by:<ol><li>Adding atmospheric contributions to reflections and diffuse lighting<li>Maintaining performance through efficient compute shader implementation<li>Providing artists with a physically-based atmosphere lighting solution<li>Creating foundation for future light probe integration</ol><p>The solution has minimal performance impact due to reuse of existing atmospheric calculations and efficient compute shader design. The implementation also includes safeguards like automatic size correction to ensure robustness:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Correct non-power-of-two sizes
</span><span style=color:#fa6e32>let</span><span> new_size </span><span style=color:#ed9366>= </span><span>UVec2</span><span style=color:#ed9366>::</span><span>new(
</span><span>    size</span><span style=color:#ed9366>.</span><span>x</span><span style=color:#ed9366>.</span><span style=color:#f07171>max</span><span>(</span><span style=color:#ff8f40>1</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>next_power_of_two</span><span>()</span><span style=color:#61676ccc>,
</span><span>    size</span><span style=color:#ed9366>.</span><span>y</span><span style=color:#ed9366>.</span><span style=color:#f07171>max</span><span>(</span><span style=color:#ff8f40>1</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>next_power_of_two</span><span>()</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[AtmosphereEnvironmentMapLight] --> B[Create Environment Texture]
</span><span>    B --> C[Prepare Probe Textures]
</span><span>    C --> D[Environment Compute Pass]
</span><span>    D --> E[GeneratedEnvironmentMapLight]
</span><span>    E --> F[PBR Shading]
</span><span>    
</span><span>    G[Atmosphere System] --> H[LUTs]
</span><span>    H --> D
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ol><li><code>crates/bevy_pbr/src/atmosphere/environment.rs</code> (+332/-0) <ul><li>Adds core logic for environment map generation<li>Implements compute pass setup and texture preparation<li>Creates new ECS components and resources</ul></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Component for atmosphere environment lighting
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>AtmosphereEnvironmentMap </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>environment_map</span><span style=color:#61676ccc>: </span><span>Handle&LTImage>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>size</span><span style=color:#61676ccc>:</span><span> UVec2,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Creates environment map texture
</span><span style=color:#fa6e32>let mut</span><span> environment_image </span><span style=color:#ed9366>= </span><span>Image</span><span style=color:#ed9366>::</span><span>new_fill(
</span><span>    Extent3d {
</span><span>        width</span><span style=color:#61676ccc>:</span><span> new_size</span><span style=color:#ed9366>.</span><span>x</span><span style=color:#61676ccc>,
</span><span>        height</span><span style=color:#61676ccc>:</span><span> new_size</span><span style=color:#ed9366>.</span><span>y</span><span style=color:#61676ccc>,
</span><span>        depth_or_array_layers</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>6</span><span style=color:#61676ccc>,
</span><span>    }</span><span style=color:#61676ccc>,
</span><span>    TextureDimension</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>D2</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#ed9366>&</span><span>[</span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>; </span><span style=color:#ff8f40>8</span><span>]</span><span style=color:#61676ccc>,
</span><span>    TextureFormat</span><span style=color:#ed9366>::</span><span>Rgba16Float</span><span style=color:#61676ccc>,
</span><span>    RenderAssetUsages</span><span style=color:#ed9366>::</span><span>all()</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><ol start=2><li><code>crates/bevy_pbr/src/atmosphere/environment.wgsl</code> (+37/-0) <ul><li>New compute shader for environment map generation<li>Samples atmosphere LUTs and writes to cubemap</ul></ol><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>@compute @workgroup_size(8, 8, 1)
</span><span>fn main(@builtin(global_invocation_id) global_id: vec3&LTu32>) {
</span><span>    // ... sampling logic ...
</span><span>    textureStore(output, vec2&LTi32>(global_id.xy), i32(slice_index), color);
</span><span>}
</span></code></pre><ol start=3><li><code>crates/bevy_light/src/probe.rs</code> (+34/-1) <ul><li>Adds new <code>AtmosphereEnvironmentMapLight</code> component<li>Documents usage and parameters</ul></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>AtmosphereEnvironmentMapLight </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>intensity</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>affects_lightmapped_mesh_diffuse</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>bool</span><span>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>size</span><span style=color:#61676ccc>:</span><span> UVec2,
</span><span>}
</span></code></pre><ol start=4><li><code>crates/bevy_pbr/src/atmosphere/mod.rs</code> (+21/-2) <ul><li>Integrates new environment system into atmosphere plugin<li>Adds startup systems and rendering nodes</ul></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(Update</span><span style=color:#61676ccc>,</span><span> prepare_atmosphere_probe_components)
</span><span>   </span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(RenderStartup</span><span style=color:#61676ccc>,</span><span> init_atmosphere_probe_layout)
</span><span>   </span><span style=color:#ed9366>.</span><span>add_render_graph_node</span><span style=color:#ed9366>::</span><span>&LTEnvironmentNode>(Core3d</span><span style=color:#61676ccc>, </span><span>AtmosphereNode</span><span style=color:#ed9366>::</span><span>Environment)</span><span style=color:#61676ccc>;
</span></code></pre><ol start=5><li><code>crates/bevy_pbr/src/atmosphere/render_sky.wgsl</code> (+5/-1) <ul><li>Fixes exposure handling for consistency</ul></ol><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>// inscattering += sun_radiance * transmittance * view.exposure;
</span><span>
</span><span>// After:
</span><span>inscattering += sun_radiance * transmittance;
</span><span>inscattering *= view.exposure; // Exposure compensation
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://www.pbr-book.org/ target=_blank>Physically Based Rendering: From Theory to Implementation</a><li><a rel="noopener nofollow noreferrer" href=https://developer.nvidia.com/gpugems/gpugems2/part-ii-shading-lighting-and-shadows/chapter-16-accurate-atmospheric-scattering target=_blank>Real-Time Rendering of Atmospheric Scattering Effects</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/features/pbr/ target=_blank>Bevy PBR Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://gpuweb.github.io/gpuweb/wgsl/ target=_blank>WGSL Shader Language Specification</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-08/pr_20529.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>