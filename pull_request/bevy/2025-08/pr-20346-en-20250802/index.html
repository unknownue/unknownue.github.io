<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20346 Side: Fix `ci` tool when running with `--test-threads`
        
    </title><meta content="#20346 Side: Fix `ci` tool when running with `--test-threads`" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-08/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-08-02</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-08/pr-20346-zh-cn-20250802>中文</a></div></div><div class=pr-content><h1 id=analysis-of-pr-20346-side-fix-ci-tool-when-running-with-test-threads>Analysis of PR #20346: Side: Fix <code>ci</code> tool when running with <code>--test-threads</code></h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Side: Fix <code>ci</code> tool when running with <code>--test-threads</code><li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20346<li><strong>Author</strong>: hukasu<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Build-System, S-Ready-For-Final-Review, C-Testing, D-Straightforward<li><strong>Created</strong>: 2025-07-31T00:53:23Z<li><strong>Merged</strong>: 2025-08-02T18:13:17Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><p>The original description is in English and is preserved exactly as-is:<h1 id=objective>Objective</h1><p><code>ci</code> tool fails if you run with <code>--test-threads</code> because <code>cargo test --benches</code> does not take <code>--test-threads</code><h2 id=solution>Solution</h2><p>Split the command that call <code>cargo test</code> into one for <code>--benches</code> and other for <code>--lib --bins --tests</code>.<h2 id=testing>Testing</h2><p>Ran <code>cargo run -p ci -- --build-jobs 4 --test-threads 4</code><h2 id=note>Note</h2><p>This is a cherry-pick of a commit that was added to #19011 but was unrelated to the PR<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The CI tool in Bevy’s development workflow had a specific limitation when users tried to run tests with custom thread configurations. The <code>ci</code> tool accepts a <code>--test-threads</code> parameter to control parallelism during test execution, but this caused failures when benchmark tests were included in the test run. The root issue was that <code>cargo test --benches</code> doesn’t accept the <code>--test-threads</code> argument, causing the entire test command to fail when this parameter was passed.<p>The original implementation used a single command to run all tests including benchmarks:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#86b300>"cargo test --workspace --lib --bins --tests --benches ... -- {test_threads...}"
</span></code></pre><p>This approach worked for standard tests but failed when <code>--test-threads</code> was passed because the benchmark runner doesn’t accept this parameter.<p>The solution involved splitting the test execution into two separate commands:<ol><li>A command for standard tests (<code>--lib</code>, <code>--bins</code>, <code>--tests</code>) that accepts <code>--test-threads</code><li>A separate command for benchmarks (<code>--benches</code>) that doesn’t include the thread parameter</ol><p>This separation required careful handling of the job arguments (<code>--jobs</code> for build parallelism). The implementation needed to ensure both commands could access the job configuration without causing ownership issues. The solution used references for the first command and moved the value for the second command, leveraging Rust’s ownership system to safely share the configuration between both commands.<p>The fix maintains the original functionality while adding compatibility with the <code>--test-threads</code> parameter. Benchmarks continue to run with their default configuration, while standard tests benefit from the requested thread configuration. This change is particularly valuable for developers running CI locally with custom configurations, as it allows them to control test parallelism without encountering errors from the benchmark runner.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[CI Test Command] --> B{Has --test-threads?}
</span><span>    B -->|Yes| C[Split into two commands]
</span><span>    B -->|No| D[Single command]
</span><span>    C --> E[Standard Tests\nwith --test-threads]
</span><span>    C --> F[Benchmark Tests\nwithout --test-threads]
</span><span>    D --> G[All tests in single command]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=tools-ci-src-commands-test-rs><code>tools/ci/src/commands/test.rs</code></h3><p>This file contains the test command implementation for Bevy’s CI tool. The changes modify how test commands are constructed when <code>--test-threads</code> is present.<p><strong>Before:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#f07171>vec!</span><span>[PreparedCommand</span><span style=color:#ed9366>::</span><span>new</span><span style=color:#ed9366>::</span><span><</span><span style=color:#fa6e32>Self</span><span>>(
</span><span>    </span><span style=color:#f07171>cmd!</span><span>(
</span><span>        sh</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#86b300>"cargo test --workspace --lib --bins --tests --benches {no_fail_fast...} {jobs...} -- {test_threads...}"
</span><span>    )</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#86b300>"Please fix failing tests in output above."</span><span style=color:#61676ccc>,
</span><span>)]
</span></code></pre><p><strong>After:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#f07171>vec!</span><span>[
</span><span>    PreparedCommand</span><span style=color:#ed9366>::</span><span>new</span><span style=color:#ed9366>::</span><span><</span><span style=color:#fa6e32>Self</span><span>>(
</span><span>        </span><span style=color:#f07171>cmd!</span><span>(
</span><span>            sh</span><span style=color:#61676ccc>,
</span><span>            </span><span style=color:#86b300>"cargo test --workspace --lib --bins --tests {no_fail_fast...} {jobs_ref...} -- {test_threads_ref...}"
</span><span>        )</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#86b300>"Please fix failing tests in output above."</span><span style=color:#61676ccc>,
</span><span>    )</span><span style=color:#61676ccc>,
</span><span>    PreparedCommand</span><span style=color:#ed9366>::</span><span>new</span><span style=color:#ed9366>::</span><span><</span><span style=color:#fa6e32>Self</span><span>>(
</span><span>        </span><span style=color:#f07171>cmd!</span><span>(
</span><span>            sh</span><span style=color:#61676ccc>,
</span><span>            </span><span style=color:#86b300>"cargo test --workspace --benches {no_fail_fast...} {jobs...}"
</span><span>        )</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#86b300>"Please fix failing tests in output above."</span><span style=color:#61676ccc>,
</span><span>    )
</span><span>]
</span></code></pre><p><strong>Key changes:</strong><ol><li>Split single command into two separate commands<li>First command handles standard tests and includes <code>--test-threads</code><li>Second command handles benchmarks without thread parameter<li>Used references (<code>jobs_ref</code>, <code>test_threads_ref</code>) for first command<li>Used value (<code>jobs</code>) for second command to avoid ownership issues<li>Maintained error message consistency</ol><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/cargo/commands/cargo-test.html target=_blank>Cargo test documentation</a> - Official documentation for cargo test parameters<li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/unstable-book/library-features/test.html target=_blank>Rust Benchmark Tests</a> - How benchmark tests work in Rust<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/docs/ci.md target=_blank>Bevy CI Documentation</a> - Bevy’s CI workflow and usage</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-08/pr_20346.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>