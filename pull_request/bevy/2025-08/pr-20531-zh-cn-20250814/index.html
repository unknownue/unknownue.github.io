<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20531 Update `morph_targets` and `many_foxes` examples to use observers
        
    </title><meta content="#20531 Update `morph_targets` and `many_foxes` examples to use observers" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-08/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-08-14</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2025-08/pr-20531-en-20250814>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h2 id=ji-shu-fen-xi-bao-gao-pr-20531>技术分析报告：PR #20531</h2><h3 id=ji-chu-xin-xi>基础信息</h3><ul><li><strong>标题</strong>: Update <code>morph_targets</code> and <code>many_foxes</code> examples to use observers<li><strong>PR链接</strong>: https://github.com/bevyengine/bevy/pull/20531<li><strong>作者</strong>: greeble-dev<li><strong>状态</strong>: 已合并<li><strong>标签</strong>: C-Examples, C-Code-Quality, S-Ready-For-Final-Review, A-Animation<li><strong>创建时间</strong>: 2025-08-12T12:35:55Z<li><strong>合并时间</strong>: 2025-08-14T21:02:26Z<li><strong>合并人</strong>: alice-i-cecile</ul><h3 id=miao-shu-fan-yi>描述翻译</h3><h4 id=objective>Objective</h4><p>更新示例以遵循动画播放的最佳实践，同时解决场景多次生成的问题。<h4 id=background>Background</h4><p>播放骨骼动画的示例通常包含两个步骤：<ol><li>启动场景生成<li>场景生成后播放动画</ol><p>不同示例使用不同方法触发第2步，包括场景生成观察者(scene spawning observer)和<code>Added&LTAnimationPlayer></code>查询。<p>观察者方法更精确且易于扩展，而其他方法在复杂场景（如多场景或多动画）中会失效（详见 #17421）。此外，观察者方法可规避当前场景多次生成的问题（#20393, #20430）。<h4 id=solution>Solution</h4><p>更新<code>morph_targets</code>和<code>many_foxes</code>示例使用观察者模式。对<code>morph_targets</code>的额外改进：<ul><li>修复文档中引用不存在的<code>update_weights</code>功能<li>使用与<code>animated_mesh</code>示例相同的<code>AnimationToPlay</code>组件<li>将<code>name_morphs</code>系统改为事件驱动并打印资源名称</ul><p>未更新仍使用<code>Added&LTAnimationPlayer></code>的示例：<code>animated_mesh_control</code>, <code>animated_mesh_events</code>, <code>animation_masks</code>。<h4 id=testing>Testing</h4><pre class=language-sh data-lang=sh style=color:#61676c;background-color:#fafafa><code class=language-sh data-lang=sh><span style=color:#f29718>cargo</span><span> run</span><span style=color:#ff8f40> --example</span><span> morph_targets
</span><span style=color:#f29718>cargo</span><span> run</span><span style=color:#ff8f40> --example</span><span> many_foxes
</span></code></pre><hr><h3 id=prji-shu-fen-xi>PR技术分析</h3><h4 id=wen-ti-bei-jing>问题背景</h4><p>在Bevy中，播放骨骼动画的示例需要解决两个关键问题：<ol><li><strong>动画触发时机</strong>：需确保动画在场景完全加载后播放<li><strong>多场景处理</strong>：当存在多个相同场景实例时，需独立控制每个实例的动画</ol><p>原实现使用<code>Added&LTAnimationPlayer></code>查询存在以下问题：<ul><li>全局状态管理复杂（依赖<code>Local&LTbool></code>标志位）<li>难以扩展到多场景（所有播放器同时触发）<li>无法处理场景重复生成问题（#20393, #20430）</ul><h4 id=jie-jue-fang-an>解决方案</h4><p>PR采用观察者模式(observer pattern)重构动画触发逻辑：<ol><li>使用<code>On&LTSceneInstanceReady></code>事件替代状态标志<li>通过实体观察者(entity observer)绑定场景就绪事件<li>在事件系统中精确控制每个场景实例的动画</ol><h4 id=ji-shu-shi-xian>技术实现</h4><h5 id=1-morph-targetsshi-li-zhong-gou>1. <code>morph_targets</code>示例重构</h5><p><strong>核心变更</strong>：<ul><li>移除资源型状态管理（<code>MorphData</code> + <code>Local&LTbool></code>）<li>引入事件驱动的动画触发<li>改进变形目标名称输出</ul><p><strong>关键代码对比</strong>：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 文件: examples/animation/morph_targets.rs
</span><span style=color:#abb0b6;font-style:italic>// 之前: 基于标志位的动画设置
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>setup_animations</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>has_setup</span><span style=color:#61676ccc>: </span><span>Local<</span><span style=color:#fa6e32>bool</span><span>>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>players</span><span style=color:#61676ccc>: </span><span>Query<(Entity, </span><span style=color:#ed9366>&</span><span>Name, </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> AnimationPlayer)>,
</span><span>    </span><span style=color:#ff8f40>morph_data</span><span style=color:#61676ccc>: </span><span>Res&LTMorphData>,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>if </span><span style=color:#ed9366>*</span><span>has_setup { </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>; </span><span>}
</span><span>    </span><span style=color:#fa6e32>for </span><span>(entity</span><span style=color:#61676ccc>,</span><span> name</span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>mut</span><span> player) </span><span style=color:#ed9366>in &</span><span style=color:#fa6e32>mut</span><span> players {
</span><span>        </span><span style=color:#fa6e32>if</span><span> name</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_str</span><span>() </span><span style=color:#ed9366>== </span><span style=color:#86b300>"Main" </span><span>{
</span><span>            player</span><span style=color:#ed9366>.</span><span style=color:#f07171>play</span><span>(</span><span style=color:#ed9366>...</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>repeat</span><span>()</span><span style=color:#61676ccc>;
</span><span>            </span><span style=color:#ed9366>*</span><span>has_setup </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>true</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 之后: 观察者模式
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>play_animation_when_ready</span><span>(
</span><span>    </span><span style=color:#ff8f40>trigger</span><span style=color:#61676ccc>: </span><span>On&LTSceneInstanceReady>, </span><span style=color:#abb0b6;font-style:italic>// 场景就绪事件
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>players</span><span style=color:#61676ccc>: </span><span>Query<</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> AnimationPlayer>,
</span><span>    </span><span style=color:#ff8f40>children</span><span style=color:#61676ccc>: </span><span>Query<</span><span style=color:#ed9366>&</span><span>Children>,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>for</span><span> child </span><span style=color:#ed9366>in</span><span> children</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter_descendants</span><span>(trigger</span><span style=color:#ed9366>.</span><span style=color:#f07171>target</span><span>()) {
</span><span>        </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(</span><span style=color:#fa6e32>mut</span><span> player) </span><span style=color:#ed9366>=</span><span> players</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_mut</span><span>(child) {
</span><span>            player</span><span style=color:#ed9366>.</span><span style=color:#f07171>play</span><span>(</span><span style=color:#ed9366>...</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>repeat</span><span>()</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// 精确触发单个实例
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 场景绑定观察者
</span><span>commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((
</span><span>    SceneRoot(asset_server</span><span style=color:#ed9366>.</span><span style=color:#f07171>load</span><span>(</span><span style=color:#ed9366>...</span><span>))</span><span style=color:#61676ccc>,
</span><span>    AnimationToPlay { </span><span style=color:#ed9366>... </span><span>}
</span><span>))</span><span style=color:#ed9366>.</span><span style=color:#f07171>observe</span><span>(play_animation_when_ready)</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// 关键绑定
</span></code></pre><p><strong>变形目标名称输出改进</strong>：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 之前: 单次打印
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>name_morphs</span><span>(</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>has_printed</span><span style=color:#61676ccc>: </span><span>Local<</span><span style=color:#fa6e32>bool</span><span>>, ...) {
</span><span>    </span><span style=color:#fa6e32>if </span><span style=color:#ed9366>*</span><span>has_printed { </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>; </span><span>}
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...打印逻辑
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 之后: 事件驱动
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>name_morphs</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>events</span><span style=color:#61676ccc>: </span><span>EventReader&LTAssetEvent&LTMesh>>,
</span><span>    </span><span style=color:#ff8f40>asset_server</span><span style=color:#61676ccc>: </span><span>Res&LTAssetServer>,
</span><span>    </span><span style=color:#ff8f40>meshes</span><span style=color:#61676ccc>: </span><span>Res&LTAssets&LTMesh>>,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>for</span><span> event </span><span style=color:#ed9366>in</span><span> events</span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>() {
</span><span>        </span><span style=color:#fa6e32>if let </span><span>AssetEvent</span><span style=color:#ed9366>::</span><span>Added { id } </span><span style=color:#ed9366>=</span><span> event {
</span><span>            </span><span style=color:#fa6e32>if let </span><span>(</span><span style=color:#55b4d4;font-style:italic>Some</span><span>(path)</span><span style=color:#61676ccc>, </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(mesh)) </span><span style=color:#ed9366>= </span><span>(asset_server</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_path</span><span>(</span><span style=color:#ed9366>*</span><span>id)</span><span style=color:#61676ccc>,</span><span> meshes</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#ed9366>*</span><span>id)) {
</span><span>                </span><span style=color:#f07171>info!</span><span>(</span><span style=color:#86b300>"Morph target names for {path:?}:"</span><span>)</span><span style=color:#61676ccc>;
</span><span>                </span><span style=color:#abb0b6;font-style:italic>// ...打印所有变形目标名称
</span><span>            }
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre><h5 id=2-many-foxesshi-li-zhong-gou>2. <code>many_foxes</code>示例重构</h5><p><strong>核心变更</strong>：<ul><li>移除全局状态同步机制<li>为每个狐狸实例单独注册观察者<li>基于实体ID的动画偏移计算</ul><p><strong>关键代码对比</strong>：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 文件: examples/stress_tests/many_foxes.rs
</span><span style=color:#abb0b6;font-style:italic>// 之前: 全局状态控制
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>setup_scene_once_loaded</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>done</span><span style=color:#61676ccc>: </span><span>Local<</span><span style=color:#fa6e32>bool</span><span>>,
</span><span>    </span><span style=color:#ff8f40>player</span><span style=color:#61676ccc>: </span><span>Query<(Entity, </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> AnimationPlayer)>,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!*</span><span>done </span><span style=color:#ed9366>&&</span><span> player</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>len</span><span>() </span><span style=color:#ed9366>==</span><span> foxes</span><span style=color:#ed9366>.</span><span>count {
</span><span>        </span><span style=color:#fa6e32>for </span><span>(entity</span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>mut</span><span> player) </span><span style=color:#ed9366>in &</span><span style=color:#fa6e32>mut</span><span> player {
</span><span>            </span><span style=color:#fa6e32>let</span><span> anim </span><span style=color:#ed9366>=</span><span> player</span><span style=color:#ed9366>.</span><span style=color:#f07171>play</span><span>(</span><span style=color:#ed9366>...</span><span>)</span><span style=color:#61676ccc>;
</span><span>            anim</span><span style=color:#ed9366>.</span><span style=color:#f07171>seek_to</span><span>(entity</span><span style=color:#ed9366>.</span><span style=color:#f07171>index</span><span>() </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32 </span><span style=color:#ed9366>/ </span><span style=color:#ff8f40>10.0</span><span>)</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// 基于实体ID偏移
</span><span>        }
</span><span>        </span><span style=color:#ed9366>*</span><span>done </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>true</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 之后: 基于场景的观察者
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>setup_scene_once_loaded</span><span>(
</span><span>    </span><span style=color:#ff8f40>trigger</span><span style=color:#61676ccc>: </span><span>On&LTSceneInstanceReady>, </span><span style=color:#abb0b6;font-style:italic>// 单个场景事件
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>players</span><span style=color:#61676ccc>: </span><span>Query<</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> AnimationPlayer>,
</span><span>    </span><span style=color:#ff8f40>children</span><span style=color:#61676ccc>: </span><span>Query<</span><span style=color:#ed9366>&</span><span>Children>,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>for</span><span> child </span><span style=color:#ed9366>in</span><span> children</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter_descendants</span><span>(trigger</span><span style=color:#ed9366>.</span><span style=color:#f07171>target</span><span>()) {
</span><span>        </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(</span><span style=color:#fa6e32>mut</span><span> player) </span><span style=color:#ed9366>=</span><span> players</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_mut</span><span>(child) {
</span><span>            </span><span style=color:#fa6e32>let</span><span> anim </span><span style=color:#ed9366>=</span><span> player</span><span style=color:#ed9366>.</span><span style=color:#f07171>play</span><span>(</span><span style=color:#ed9366>...</span><span>)</span><span style=color:#61676ccc>;
</span><span>            anim</span><span style=color:#ed9366>.</span><span style=color:#f07171>seek_to</span><span>(trigger</span><span style=color:#ed9366>.</span><span style=color:#f07171>target</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>index</span><span>() </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32 </span><span style=color:#ed9366>/ </span><span style=color:#ff8f40>10.0</span><span>)</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// 基于触发实体ID
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 每个狐狸实例注册观察者
</span><span>builder</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((
</span><span>    SceneRoot(fox_handle</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>())</span><span style=color:#61676ccc>,
</span><span>    Transform</span><span style=color:#ed9366>::</span><span>from_xyz(</span><span style=color:#ed9366>...</span><span>)
</span><span>))</span><span style=color:#ed9366>.</span><span style=color:#f07171>observe</span><span>(setup_scene_once_loaded)</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// 关键绑定
</span></code></pre><h4 id=ji-shu-dong-cha>技术洞察</h4><ol><li><p><strong>观察者模式优势</strong>：</p> <ul><li>消除帧循环检查（frame polling）<li>精确绑定事件与实体关系<li>自动处理多实例场景<li>代码结构更符合ECS范式</ul><li><p><strong>实体ID的应用</strong>：</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>anim</span><span style=color:#ed9366>.</span><span style=color:#f07171>seek_to</span><span>(trigger</span><span style=color:#ed9366>.</span><span style=color:#f07171>target</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>index</span><span>() </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32 </span><span style=color:#ed9366>/ </span><span style=color:#ff8f40>10.0</span><span>)
</span></code></pre> <p>利用实体ID生成唯一动画偏移量，解决同步问题同时保持随机性</p><li><p><strong>资源事件处理</strong>： <code>AssetEvent::Added</code>事件机制确保：</p> <ul><li>动态加载资源正确处理<li>避免初始化顺序问题<li>支持热重载场景</ul></ol><h4 id=ying-xiang-fen-xi>影响分析</h4><ol><li><p><strong>正向影响</strong>：</p> <ul><li>示例代码更符合最佳实践<li>解决场景重复生成导致的动画问题<li>提供可复用的动画触发模式<li>改进的变形目标调试输出</ul><li><p><strong>注意事项</strong>：</p> <ul><li>观察者系统需严格匹配组件层级<li>实体遍历存在固定开销（但可忽略）</ul></ol><hr><h3 id=guan-jian-wen-jian-bian-geng>关键文件变更</h3><h4 id=1-examples-animation-morph-targets-rs-60-74>1. <code>examples/animation/morph_targets.rs</code> (+60/-74)</h4><p><strong>变更概要</strong>：重构为观察者模式，改进变形目标输出<br> <strong>关键代码</strong>：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 新事件驱动动画触发
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>play_animation_when_ready</span><span>(
</span><span>    </span><span style=color:#ff8f40>trigger</span><span style=color:#61676ccc>: </span><span>On&LTSceneInstanceReady>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands,
</span><span>    </span><span style=color:#ff8f40>children</span><span style=color:#61676ccc>: </span><span>Query<</span><span style=color:#ed9366>&</span><span>Children>,
</span><span>    </span><span style=color:#ff8f40>animations_to_play</span><span style=color:#61676ccc>: </span><span>Query<</span><span style=color:#ed9366>&</span><span>AnimationToPlay>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>players</span><span style=color:#61676ccc>: </span><span>Query<</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> AnimationPlayer>,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(animation_to_play) </span><span style=color:#ed9366>=</span><span> animations_to_play</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(trigger</span><span style=color:#ed9366>.</span><span style=color:#f07171>target</span><span>()) {
</span><span>        </span><span style=color:#fa6e32>for</span><span> child </span><span style=color:#ed9366>in</span><span> children</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter_descendants</span><span>(trigger</span><span style=color:#ed9366>.</span><span style=color:#f07171>target</span><span>()) {
</span><span>            </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(</span><span style=color:#fa6e32>mut</span><span> player) </span><span style=color:#ed9366>=</span><span> players</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_mut</span><span>(child) {
</span><span>                player</span><span style=color:#ed9366>.</span><span style=color:#f07171>play</span><span>(animation_to_play</span><span style=color:#ed9366>.</span><span>index)</span><span style=color:#ed9366>.</span><span style=color:#f07171>repeat</span><span>()</span><span style=color:#61676ccc>;
</span><span>                commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(child)
</span><span>                    </span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(AnimationGraphHandle(animation_to_play</span><span style=color:#ed9366>.</span><span>graph_handle</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()))</span><span style=color:#61676ccc>;
</span><span>            }
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 事件驱动的变形目标输出
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>name_morphs</span><span>(
</span><span>    </span><span style=color:#ff8f40>asset_server</span><span style=color:#61676ccc>: </span><span>Res&LTAssetServer>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>events</span><span style=color:#61676ccc>: </span><span>EventReader&LTAssetEvent&LTMesh>>,
</span><span>    </span><span style=color:#ff8f40>meshes</span><span style=color:#61676ccc>: </span><span>Res&LTAssets&LTMesh>>,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>for</span><span> event </span><span style=color:#ed9366>in</span><span> events</span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>() {
</span><span>        </span><span style=color:#fa6e32>if let </span><span>AssetEvent</span><span style=color:#ed9366>::</span><span>&LTMesh></span><span style=color:#ed9366>::</span><span>Added { id } </span><span style=color:#ed9366>=</span><span> event
</span><span>            </span><span style=color:#ed9366>&& </span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(path) </span><span style=color:#ed9366>=</span><span> asset_server</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_path</span><span>(</span><span style=color:#ed9366>*</span><span>id)
</span><span>            </span><span style=color:#ed9366>&& </span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(mesh) </span><span style=color:#ed9366>=</span><span> meshes</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#ed9366>*</span><span>id)
</span><span>            </span><span style=color:#ed9366>&& </span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(names) </span><span style=color:#ed9366>=</span><span> mesh</span><span style=color:#ed9366>.</span><span style=color:#f07171>morph_target_names</span><span>()
</span><span>        {
</span><span>            </span><span style=color:#f07171>info!</span><span>(</span><span style=color:#86b300>"Morph target names for {path:?}:"</span><span>)</span><span style=color:#61676ccc>;
</span><span>            </span><span style=color:#fa6e32>for</span><span> name </span><span style=color:#ed9366>in</span><span> names {
</span><span>                </span><span style=color:#f07171>info!</span><span>(</span><span style=color:#86b300>"  {name}"</span><span>)</span><span style=color:#61676ccc>;
</span><span>            }
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre><h4 id=2-examples-stress-tests-many-foxes-rs-18-18>2. <code>examples/stress_tests/many_foxes.rs</code> (+18/-18)</h4><p><strong>变更概要</strong>：狐狸实例动画触发重构<br> <strong>关键代码</strong>：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 观察者绑定
</span><span>builder</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((
</span><span>    SceneRoot(fox_handle</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>())</span><span style=color:#61676ccc>,
</span><span>    Transform</span><span style=color:#ed9366>::</span><span>from_xyz(x</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.0</span><span style=color:#61676ccc>,</span><span> z)
</span><span>))</span><span style=color:#ed9366>.</span><span style=color:#f07171>observe</span><span>(setup_scene_once_loaded)</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// 关键观察者注册
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 单场景动画触发
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>setup_scene_once_loaded</span><span>(
</span><span>    </span><span style=color:#ff8f40>trigger</span><span style=color:#61676ccc>: </span><span>On&LTSceneInstanceReady>,
</span><span>    </span><span style=color:#ff8f40>animations</span><span style=color:#61676ccc>: </span><span>Res&LTAnimations>,
</span><span>    </span><span style=color:#ff8f40>foxes</span><span style=color:#61676ccc>: </span><span>Res&LTFoxes>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands,
</span><span>    </span><span style=color:#ff8f40>children</span><span style=color:#61676ccc>: </span><span>Query<</span><span style=color:#ed9366>&</span><span>Children>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>players</span><span style=color:#61676ccc>: </span><span>Query<</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> AnimationPlayer>,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>for</span><span> child </span><span style=color:#ed9366>in</span><span> children</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter_descendants</span><span>(trigger</span><span style=color:#ed9366>.</span><span style=color:#f07171>target</span><span>()) {
</span><span>        </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(</span><span style=color:#fa6e32>mut</span><span> player) </span><span style=color:#ed9366>=</span><span> players</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_mut</span><span>(child) {
</span><span>            </span><span style=color:#fa6e32>let</span><span> playing_animation </span><span style=color:#ed9366>=</span><span> player</span><span style=color:#ed9366>.</span><span style=color:#f07171>play</span><span>(animations</span><span style=color:#ed9366>.</span><span>node_indices[</span><span style=color:#ff8f40>0</span><span>])</span><span style=color:#ed9366>.</span><span style=color:#f07171>repeat</span><span>()</span><span style=color:#61676ccc>;
</span><span>            </span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>foxes</span><span style=color:#ed9366>.</span><span>sync {
</span><span>                playing_animation</span><span style=color:#ed9366>.</span><span style=color:#f07171>seek_to</span><span>(trigger</span><span style=color:#ed9366>.</span><span style=color:#f07171>target</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>index</span><span>() </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32 </span><span style=color:#ed9366>/ </span><span style=color:#ff8f40>10.0</span><span>)</span><span style=color:#61676ccc>;
</span><span>            }
</span><span>            commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(child)
</span><span>                </span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(AnimationGraphHandle(animations</span><span style=color:#ed9366>.</span><span>graph</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()))</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre><hr><h3 id=jia-gou-guan-xi-tu>架构关系图</h3><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[SceneRoot实体] -->|绑定观察者| B(SceneInstanceReady事件)
</span><span>    B --> C{观察者系统}
</span><span>    C -->|遍历后代| D[AnimationPlayer组件]
</span><span>    D --> E[播放动画]
</span><span>    E -->|插入| F[AnimationGraphHandle]
</span></code></pre><hr><h3 id=yan-shen-yue-du>延伸阅读</h3><ol><li><p>Bevy观察者机制文档： https://bevyengine.org/learn/book/events/observers/</p><li><p>场景系统工作原理： https://bevyengine.org/learn/book/scenes/</p><li><p>动画系统最佳实践： https://github.com/bevyengine/bevy/discussions/17421</p><li><p>相关未解决问题：</p> <ul><li>#20393: 场景重复生成问题<li>#20430: 动画同步问题</ul></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-08/pr_20531.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>