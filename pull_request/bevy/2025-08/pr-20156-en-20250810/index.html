<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20156 Optimize solari initial and temporal DI
        
    </title><meta content="#20156 Optimize solari initial and temporal DI" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-08/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-08-10</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-08/pr-20156-zh-cn-20250810>中文</a></div></div><div class=pr-content><h1 id=technical-analysis-optimize-solari-initial-and-temporal-di>Technical Analysis: Optimize solari initial and temporal DI</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Optimize solari initial and temporal DI<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20156<li><strong>Author</strong>: SparkyPotato<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, C-Performance, S-Ready-For-Final-Review, M-Needs-Release-Note<li><strong>Created</strong>: 2025-07-16T00:25:15Z<li><strong>Merged</strong>: 2025-08-10T19:42:23Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Optimizes the initial + temporal ReSTIR DI pass. In the example cornell box scene, it goes from 2.37 ms to 1.97 ms. On a more complex scene, the Lumberyard bistro, with many emissive lights, it goes from 130+ ms to about 80.8 ms at 1440p on a 4070.<p>I also noticed that triangle area calculation didn’t take object scale into account and fixed that.<h2 id=solution>Solution</h2><ul><li>Switch to textures instead of buffers for reservoir storage.<li>There’s also a bunch of other micro-optimizations to increase SM occupancy and reduce memory pressure.</ul><h2 id=testing>Testing</h2><ul><li>This was tested on the cornell box example scene and bistro.<li>Everything was tested on Windows 11 with a 4070 running at 1440p. Testing on other platforms and GPUs by running the example.</ul><hr><h2 id=showcase>Showcase</h2><img alt=image height=1392 src=https://github.com/user-attachments/assets/b53f66e8-c97d-4f94-b30f-bbe6ade1a507 width=2560><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=the-performance-bottleneck>The Performance Bottleneck</h3><p>The PR addresses performance issues in Bevy’s ReSTIR DI (ReSTIR Direct Illumination) implementation. In complex scenes like the Lumberyard bistro with multiple emissive lights, the initial implementation was taking over 130 ms per frame at 1440p on an RTX 4070, making real-time performance challenging. The cornell box scene also showed room for improvement at 2.37 ms. Performance analysis revealed two main issues: inefficient reservoir storage using buffers rather than textures, and incorrect triangle area calculations that didn’t account for object scale.<h3 id=solution-architecture>Solution Architecture</h3><p>The solution involves two primary optimizations:<ol><li><strong>Reservoir storage migration</strong>: Switching from buffer-based to texture-based storage for DI reservoirs<li><strong>Triangle area correction</strong>: Fixing world-space area calculations by transforming vertices before computation</ol><p>Additional micro-optimizations were implemented to reduce memory pressure and increase SM occupancy. The texture approach leverages GPU memory architectures better suited for 2D data access patterns, while the triangle area fix ensures physically accurate lighting calculations.<h3 id=implementation-details>Implementation Details</h3><p>The implementation required coordinated changes across multiple subsystems:<p><strong>1. Reservoir storage overhaul</strong><br> The core optimization replaces buffer storage with RGBA32UINT storage textures for DI reservoirs. In <code>prepare.rs</code>, reservoir creation was refactored:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Buffer-based reservoirs
</span><span style=color:#fa6e32>let</span><span> di_reservoirs_a </span><span style=color:#ed9366>=</span><span> render_device</span><span style=color:#ed9366>.</span><span style=color:#f07171>create_buffer</span><span>(</span><span style=color:#ed9366>&</span><span>BufferDescriptor {
</span><span>    label</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#86b300>"solari_lighting_di_reservoirs_a"</span><span>)</span><span style=color:#61676ccc>,
</span><span>    size</span><span style=color:#61676ccc>: </span><span>(view_size</span><span style=color:#ed9366>.</span><span>x </span><span style=color:#ed9366>*</span><span> view_size</span><span style=color:#ed9366>.</span><span>y) </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>u64 </span><span style=color:#ed9366>* </span><span style=color:#ff8f40>DI_RESERVOIR_STRUCT_SIZE</span><span style=color:#61676ccc>,
</span><span>    usage</span><span style=color:#61676ccc>: </span><span>BufferUsages</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>STORAGE</span><span style=color:#61676ccc>,
</span><span>    mapped_at_creation</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>false</span><span style=color:#61676ccc>,
</span><span>})</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Texture-based reservoirs
</span><span style=color:#fa6e32>let </span><span style=color:#f29718>di_reservoirs </span><span style=color:#ed9366>= </span><span>|</span><span style=color:#ff8f40>name</span><span>| {
</span><span>    </span><span style=color:#fa6e32>let</span><span> tex </span><span style=color:#ed9366>=</span><span> render_device</span><span style=color:#ed9366>.</span><span style=color:#f07171>create_texture</span><span>(</span><span style=color:#ed9366>&</span><span>TextureDescriptor {
</span><span>        label</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(name)</span><span style=color:#61676ccc>,
</span><span>        size</span><span style=color:#61676ccc>:</span><span> view_size</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_extents</span><span>()</span><span style=color:#61676ccc>,
</span><span>        format</span><span style=color:#61676ccc>: </span><span>TextureFormat</span><span style=color:#ed9366>::</span><span>Rgba32Uint</span><span style=color:#61676ccc>,
</span><span>        usage</span><span style=color:#61676ccc>: </span><span>TextureUsages</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>STORAGE_BINDING</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ... other parameters ...
</span><span>    })</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> view </span><span style=color:#ed9366>=</span><span> tex</span><span style=color:#ed9366>.</span><span style=color:#f07171>create_view</span><span>(</span><span style=color:#ed9366>&</span><span>TextureViewDescriptor</span><span style=color:#ed9366>::</span><span>default())</span><span style=color:#61676ccc>;
</span><span>    (tex</span><span style=color:#61676ccc>,</span><span> view)
</span><span>}</span><span style=color:#61676ccc>;
</span></code></pre><p><strong>2. Shader adaptation</strong><br> The WGSL shaders were updated to use texture storage and new packing functions:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before: Buffer access
</span><span>@group(1) @binding(3) var&LTstorage, read_write> di_reservoirs_a: array&LTReservoir>;
</span><span>
</span><span>// After: Texture storage
</span><span>@group(1) @binding(3) var di_reservoirs_a: texture_storage_2d&LTrgba32uint, read_write>;
</span><span>
</span><span>// New packing/unpacking functions
</span><span>fn pack_reservoir(reservoir: Reservoir) -> vec4&LTu32> {
</span><span>    let weights = bitcast&LTvec2&LTu32>>(vec2&LTf32>(reservoir.confidence_weight, reservoir.unbiased_contribution_weight));
</span><span>    return vec4&LTu32>(reservoir.sample.light_id, reservoir.sample.seed, weights);
</span><span>}
</span><span>
</span><span>fn unpack_reservoir(packed: vec4&LTu32>) -> Reservoir {
</span><span>    let weights = bitcast&LTvec2&LTf32>>(packed.zw);
</span><span>    return Reservoir(LightSample(packed.x, packed.y), weights.x, weights.y);
</span><span>}
</span></code></pre><p><strong>3. Triangle area correction</strong><br> The triangle area calculation was fixed by transforming vertices to world space before computation:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before: Local-space calculation (ignored scale)
</span><span>let triangle_edge0 = vertices[0].position - vertices[1].position;
</span><span>let triangle_edge1 = vertices[0].position - vertices[2].position;
</span><span>let triangle_area = length(cross(triangle_edge0, triangle_edge1)) / 2.0;
</span><span>
</span><span>// After: World-space calculation
</span><span>let world_vertices = transform_positions(transform, vertices);
</span><span>let triangle_edge0 = world_vertices[0] - world_vertices[1];
</span><span>let triangle_edge1 = world_vertices[0] - world_vertices[2];
</span><span>let triangle_area = length(cross(triangle_edge0, triangle_edge1)) / 2.0;
</span></code></pre><h3 id=performance-impact>Performance Impact</h3><p>The optimizations yielded significant gains:<ul><li>Cornell box: 2.37 ms → 1.97 ms (17% improvement)<li>Lumberyard bistro: 130+ ms → 80.8 ms (≥38% improvement)</ul><p>The texture-based reservoir storage reduces memory bandwidth pressure and improves cache coherence due to better spatial locality. The packing optimization minimizes storage requirements while maintaining necessary precision. The triangle area fix ensures correct light contribution calculations, particularly important for scaled objects.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[ReSTIR DI Pass] --> B[Reservoir Storage]
</span><span>    A --> C[Triangle Area Calc]
</span><span>    B --> D[Buffer Storage] --> H[High Memory Pressure]
</span><span>    B --> E[Texture Storage] --> I[Improved Cache Coherence]
</span><span>    C --> F[Local Space] --> J[Incorrect Scale]
</span><span>    C --> G[World Space] --> K[Physically Accurate]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ol><li><p><strong><code>crates/bevy_solari/src/realtime/prepare.rs</code> (+29/-32)</strong><br> Refactored resource creation to use textures for DI reservoirs:</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// DI reservoirs now use texture storage
</span><span style=color:#fa6e32>let </span><span style=color:#f29718>di_reservoirs </span><span style=color:#ed9366>= </span><span>|</span><span style=color:#ff8f40>name</span><span>| {
</span><span>    render_device</span><span style=color:#ed9366>.</span><span style=color:#f07171>create_texture</span><span>(</span><span style=color:#abb0b6;font-style:italic>/* ... */</span><span>)
</span><span>}</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> di_reservoirs_a </span><span style=color:#ed9366>= </span><span style=color:#f07171>di_reservoirs</span><span>(</span><span style=color:#86b300>"solari_lighting_di_reservoirs_a"</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><li><p><strong><code>crates/bevy_solari/src/realtime/restir_di.wgsl</code> (+35/-12)</strong><br> Implemented texture-based reservoir storage with packing:</p> <pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Packing/unpacking functions
</span><span>fn pack_reservoir(reservoir: Reservoir) -> vec4&LTu32> { /* ... */ }
</span><span>fn unpack_reservoir(packed: vec4&LTu32>) -> Reservoir { /* ... */ }
</span><span>
</span><span>// Updated reservoir access
</span><span>store_reservoir_a(global_id.xy, combined_reservoir);
</span></code></pre><li><p><strong><code>crates/bevy_solari/src/scene/raytracing_scene_bindings.wgsl</code> (+27/-10)</strong><br> Fixed triangle area calculation:</p> <pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// World-space area calculation
</span><span>let world_vertices = transform_positions(transform, vertices);
</span><span>let triangle_edge0 = world_vertices[0] - world_vertices[1];
</span></code></pre><li><p><strong><code>crates/bevy_solari/src/realtime/node.rs</code> (+5/-5)</strong><br> Updated bindings to use texture resources:</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Bind group layout change
</span><span style=color:#f07171>texture_storage_2d</span><span>(TextureFormat</span><span style=color:#ed9366>::</span><span>Rgba32Uint</span><span style=color:#61676ccc>, </span><span>StorageTextureAccess</span><span style=color:#ed9366>::</span><span>ReadWrite)
</span></code></pre><li><p><strong><code>release-content/release-notes/bevy_solari.md</code> (+1/-1)</strong><br> Added PR reference to release notes.</p></ol><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://research.nvidia.com/publication/2020-07_spatiotemporal-reservoir-resampling-real-time-ray-tracing-dynamic-direct target=_blank>ReSTIR Paper</a> - Original research on reservoir-based spatiotemporal resampling<li><a rel="noopener nofollow noreferrer" href=https://www.w3.org/TR/WGSL/#storage-texture target=_blank>WGSL Storage Textures</a> - WebGPU Shading Language specification<li><a rel="noopener nofollow noreferrer" href=https://developer.nvidia.com/blog/how-access-global-memory-efficiently-cuda-c-kernels/ target=_blank>GPU Memory Architecture</a> - NVIDIA’s guide to global memory access patterns</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-08/pr_20156.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>