<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20728 Fixed `Xyza` to `Laba` color conversion.
        
    </title><meta content="#20728 Fixed `Xyza` to `Laba` color conversion." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-08/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-08-23</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-08/pr-20728-zh-cn-20250823>中文</a></div></div><div class=pr-content><h1 id=fixed-xyza-to-laba-color-conversion>Fixed <code>Xyza</code> to <code>Laba</code> color conversion</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fixed <code>Xyza</code> to <code>Laba</code> color conversion.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20728<li><strong>Author</strong>: 443eb9<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, D-Trivial, S-Needs-Review, A-Color<li><strong>Created</strong>: 2025-08-23T11:03:34Z<li><strong>Merged</strong>: 2025-08-23T13:04:57Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Fixes <code>Xyza</code> to <code>Laba</code> color conversion.<p>As the website referenced in comment:</p><img alt=image height=77 src=https://github.com/user-attachments/assets/aad9676a-33f5-428e-be8d-b25f2eb3b7f0 width=236><p>The variable that used to compares to <code>epsilon</code> is <code>zr</code>, but in actual code, it’s mistyped into <code>yr</code>.<h2 id=solution>Solution</h2><p>Changed <code>yr</code> to <code>zr</code>.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a straightforward but important bug in Bevy’s color conversion system. The issue was in the conversion logic from Xyza (CIE 1931 color space with alpha) to Laba (CIELAB color space with alpha). The bug manifested as incorrect color transformations due to a simple variable naming error.<p>The problem occurred in the calculation of the <code>fz</code> component of the Laba color. According to the CIE standard and the referenced implementation, the condition for applying the cubic root transformation should check the <code>zr</code> (z reference) value against the CIE epsilon constant. However, the original code incorrectly used <code>yr</code> (y reference) in this condition, which would cause incorrect transformations for colors where the z component was below the epsilon threshold but the y component was above it.<p>The fix was minimal but critical: changing a single variable name from <code>yr</code> to <code>zr</code> in the condition check. This ensures the correct mathematical transformation is applied according to the CIE standard, maintaining color accuracy throughout the conversion process.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before (incorrect):
</span><span style=color:#fa6e32>let</span><span> fz </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>if</span><span> yr </span><span style=color:#ed9366>> </span><span>Laba</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>CIE_EPSILON </span><span>{
</span><span>    ops</span><span style=color:#ed9366>::</span><span>cbrt(zr)
</span><span>} </span><span style=color:#fa6e32>else </span><span>{
</span><span>    (Laba</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>CIE_KAPPA </span><span style=color:#ed9366>*</span><span> zr </span><span style=color:#ed9366>+ </span><span style=color:#ff8f40>16.0</span><span>) </span><span style=color:#ed9366>/ </span><span style=color:#ff8f40>116.0
</span><span>}</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After (correct):
</span><span style=color:#fa6e32>let</span><span> fz </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>if</span><span> zr </span><span style=color:#ed9366>> </span><span>Laba</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>CIE_EPSILON </span><span>{
</span><span>    ops</span><span style=color:#ed9366>::</span><span>cbrt(zr)
</span><span>} </span><span style=color:#fa6e32>else </span><span>{
</span><span>    (Laba</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>CIE_KAPPA </span><span style=color:#ed9366>*</span><span> zr </span><span style=color:#ed9366>+ </span><span style=color:#ff8f40>16.0</span><span>) </span><span style=color:#ed9366>/ </span><span style=color:#ff8f40>116.0
</span><span>}</span><span style=color:#61676ccc>;
</span></code></pre><p>This type of bug highlights the importance of careful variable naming and cross-referencing implementations against established standards. While the change was trivial, it ensures color accuracy for applications using Bevy’s color conversion utilities, particularly important for graphics applications where precise color representation matters.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    X[Xyza Color Space] --> C[Conversion Logic]
</span><span>    C --> L[Laba Color Space]
</span><span>    
</span><span>    subgraph Bug Fix
</span><span>        C_Old[yr comparison] --> C_New[zr comparison]
</span><span>    end
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ul><li><code>crates/bevy_color/src/laba.rs</code> (+1/-1)</ul><p>This file contains the implementation of Laba color space operations, including conversions from other color spaces. The change was made to the <code>From&LTXyza> for Laba</code> implementation.<p><strong>Key modification:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> fz </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>if</span><span> yr </span><span style=color:#ed9366>> </span><span>Laba</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>CIE_EPSILON </span><span>{
</span><span>    ops</span><span style=color:#ed9366>::</span><span>cbrt(zr)
</span><span>} </span><span style=color:#fa6e32>else </span><span>{
</span><span>    (Laba</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>CIE_KAPPA </span><span style=color:#ed9366>*</span><span> zr </span><span style=color:#ed9366>+ </span><span style=color:#ff8f40>16.0</span><span>) </span><span style=color:#ed9366>/ </span><span style=color:#ff8f40>116.0
</span><span>}</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> fz </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>if</span><span> zr </span><span style=color:#ed9366>> </span><span>Laba</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>CIE_EPSILON </span><span>{
</span><span>    ops</span><span style=color:#ed9366>::</span><span>cbrt(zr)
</span><span>} </span><span style=color:#fa6e32>else </span><span>{
</span><span>    (Laba</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>CIE_KAPPA </span><span style=color:#ed9366>*</span><span> zr </span><span style=color:#ed9366>+ </span><span style=color:#ff8f40>16.0</span><span>) </span><span style=color:#ed9366>/ </span><span style=color:#ff8f40>116.0
</span><span>}</span><span style=color:#61676ccc>;
</span></code></pre><p>The change ensures the correct variable (<code>zr</code>) is compared against the epsilon value, fixing the color conversion logic.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/CIELAB_color_space target=_blank>CIELAB color space documentation</a><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/CIE_1931_color_space target=_blank>CIE 1931 color space</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_color/latest/bevy_color/ target=_blank>Bevy Color documentation</a></ul><h1 id=full-code-diff>Full Code Diff</h1><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_color/src/laba.rs b/crates/bevy_color/src/laba.rs
</span><span>index 010b3df249678..3797c7500d82e 100644
</span><span style=color:#c594c5>--- a/crates/bevy_color/src/laba.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_color/src/laba.rs
</span><span style=color:#c594c5>@@ -275,7 +275,7 @@ </span><span style=color:#399ee6>impl From&LTXyza> for Laba {
</span><span>         } else {
</span><span>             (Laba::CIE_KAPPA * yr + 16.0) / 116.0
</span><span>         };
</span><span style=color:#f07171>-        let fz = if yr > Laba::CIE_EPSILON {
</span><span style=color:#86b300>+        let fz = if zr > Laba::CIE_EPSILON {
</span><span>             ops::cbrt(zr)
</span><span>         } else {
</span><span>             (Laba::CIE_KAPPA * zr + 16.0) / 116.0
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-08/pr_20728.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>