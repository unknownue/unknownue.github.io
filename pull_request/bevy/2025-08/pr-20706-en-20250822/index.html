<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20706 invert affine not mat4 in spotlight
        
    </title><meta content="#20706 invert affine not mat4 in spotlight" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-08/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-08-22</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-08/pr-20706-zh-cn-20250822>中文</a></div></div><div class=pr-content><h1 id=invert-affine-not-mat4-in-spotlight>invert affine not mat4 in spotlight</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: invert affine not mat4 in spotlight<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20706<li><strong>Author</strong>: atlv24<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering<li><strong>Created</strong>: 2025-08-22T07:52:46Z<li><strong>Merged</strong>: 2025-08-22T21:30:21Z<li><strong>Merged By</strong>: james7132</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>yet again, invert affine matrix not mat4</ul><h2 id=solution>Solution</h2><ul><li></ul><h2 id=testing>Testing</h2><ul><li>lighting example</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a performance optimization in Bevy’s spotlight rendering system. The core issue was that the <code>spot_light_world_from_view</code> function was returning a full 4x4 matrix (<code>Mat4</code>) when it was actually constructing an affine transformation. Since affine transformations have specific mathematical properties, using the specialized <code>Affine3A</code> type allows for more efficient matrix inversion operations.<p>The problem stemmed from the fact that in computer graphics, affine transformations (which include translation, rotation, and scaling) can be represented more efficiently than general 4x4 matrices. When these matrices need to be inverted (a common operation in rendering), inverting a full 4x4 matrix is computationally more expensive than inverting an affine transformation.<p>The solution approach was straightforward: replace the <code>Mat4</code> return type with <code>Affine3A</code> and use the appropriate constructor method. The <code>Affine3A::from_mat3_translation</code> method perfectly matches what the original code was doing - creating an affine transformation from a 3x3 rotation matrix and a translation vector.<p>The implementation change is minimal but impactful. By using <code>Affine3A</code> instead of <code>Mat4</code>, the rendering system can now perform more efficient matrix inversions when working with spotlights. This optimization is particularly valuable in scenes with multiple spotlights where these matrix operations occur frequently.<p>The technical insight here is recognizing when to use specialized mathematical types instead of general-purpose ones. While <code>Mat4</code> can represent any 4x4 matrix, <code>Affine3A</code> is specifically designed for affine transformations and provides optimized operations for this common use case in computer graphics.<p>This change follows the same pattern established in previous optimizations throughout the Bevy codebase (“yet again, invert affine matrix not mat4”), indicating this is a established performance optimization pattern in the engine.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[SpotLight System] --> B[spot_light_world_from_view]
</span><span>    B --> C[Mat4 return type]
</span><span>    B --> D[Affine3A return type]
</span><span>    D --> E[Efficient inversion]
</span><span>    E --> F[Improved rendering performance]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>File: <code>crates/bevy_light/src/spot_light.rs</code></strong><p>Changes: Modified the <code>spot_light_world_from_view</code> function to return <code>Affine3A</code> instead of <code>Mat4</code> and use the appropriate constructor.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>spot_light_world_from_view</span><span>(</span><span style=color:#ff8f40>transform</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>GlobalTransform) </span><span style=color:#61676ccc>-></span><span> Mat4 {
</span><span>    </span><span style=color:#fa6e32>let</span><span> fwd_dir </span><span style=color:#ed9366>=</span><span> transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>back</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> basis </span><span style=color:#ed9366>= </span><span style=color:#f07171>orthonormalize</span><span>(fwd_dir)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> mat </span><span style=color:#ed9366>= </span><span>Mat4</span><span style=color:#ed9366>::</span><span>from_mat3(basis)</span><span style=color:#61676ccc>;
</span><span>    mat</span><span style=color:#ed9366>.</span><span>w_axis </span><span style=color:#ed9366>=</span><span> transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>translation</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend</span><span>(</span><span style=color:#ff8f40>1.0</span><span>)</span><span style=color:#61676ccc>;
</span><span>    mat
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>spot_light_world_from_view</span><span>(</span><span style=color:#ff8f40>transform</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>GlobalTransform) </span><span style=color:#61676ccc>-></span><span> Affine3A {
</span><span>    </span><span style=color:#fa6e32>let</span><span> fwd_dir </span><span style=color:#ed9366>=</span><span> transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>back</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> basis </span><span style=color:#ed9366>= </span><span style=color:#f07171>orthonormalize</span><span>(fwd_dir)</span><span style=color:#61676ccc>;
</span><span>    Affine3A</span><span style=color:#ed9366>::</span><span>from_mat3_translation(basis</span><span style=color:#61676ccc>,</span><span> transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>translation</span><span>())
</span><span>}
</span></code></pre><p>The key changes are:<ol><li>Changed return type from <code>Mat4</code> to <code>Affine3A</code><li>Replaced manual matrix construction with <code>Affine3A::from_mat3_translation</code><li>Added <code>Affine3A</code> to the import statement</ol><p>These changes allow for more efficient matrix inversion operations in the spotlight rendering pipeline while maintaining the same mathematical transformation.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Affine_transformation target=_blank>Affine transformations in computer graphics</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_math/latest/bevy_math/ target=_blank>Bevy Math crate documentation</a><li><a rel="noopener nofollow noreferrer" href=https://www.scratchapixel.com/lessons/mathematics-physics-for-computer-graphics/geometry target=_blank>Matrix inversion algorithms and performance considerations</a></ul><h1 id=full-code-diff>Full Code Diff</h1><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_light/src/spot_light.rs b/crates/bevy_light/src/spot_light.rs
</span><span>index 4b7481629a162..e4bc5696ac809 100644
</span><span style=color:#c594c5>--- a/crates/bevy_light/src/spot_light.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_light/src/spot_light.rs
</span><span style=color:#c594c5>@@ -6,7 +6,7 @@ </span><span style=color:#399ee6>use bevy_camera::{
</span><span> use bevy_color::Color;
</span><span> use bevy_ecs::prelude::*;
</span><span> use bevy_image::Image;
</span><span style=color:#f07171>-use bevy_math::{Dir3, Mat3, Mat4, Vec3};
</span><span style=color:#86b300>+use bevy_math::{Affine3A, Dir3, Mat3, Mat4, Vec3};
</span><span> use bevy_reflect::prelude::*;
</span><span> use bevy_transform::components::{GlobalTransform, Transform};
</span><span> 
</span><span style=color:#c594c5>@@ -176,14 +176,12 @@ </span><span style=color:#399ee6>pub fn orthonormalize(z_basis: Dir3) -> Mat3 {
</span><span> /// Constructs a right-handed orthonormal basis with translation, using only the forward direction and translation of a given [`GlobalTransform`].
</span><span> ///
</span><span> /// This is a version of [`orthonormalize`] which also includes translation.
</span><span style=color:#f07171>-pub fn spot_light_world_from_view(transform: &GlobalTransform) -> Mat4 {
</span><span style=color:#86b300>+pub fn spot_light_world_from_view(transform: &GlobalTransform) -> Affine3A {
</span><span>     // the matrix z_local (opposite of transform.forward())
</span><span>     let fwd_dir = transform.back();
</span><span> 
</span><span>     let basis = orthonormalize(fwd_dir);
</span><span style=color:#f07171>-    let mut mat = Mat4::from_mat3(basis);
</span><span style=color:#f07171>-    mat.w_axis = transform.translation().extend(1.0);
</span><span style=color:#f07171>-    mat
</span><span style=color:#86b300>+    Affine3A::from_mat3_translation(basis, transform.translation())
</span><span> }
</span><span> 
</span><span> pub fn spot_light_clip_from_view(angle: f32, near_z: f32) -> Mat4 {
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-08/pr_20706.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>