<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20535 Split up `ComputedUiTargetCamera`
        
    </title><meta content="#20535 Split up `ComputedUiTargetCamera`" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-08/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-08-15</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-08/pr-20535-zh-cn-20250815>中文</a></div></div><div class=pr-content><h2 id=split-up-computeduitargetcamera>Split up <code>ComputedUiTargetCamera</code></h2><h3 id=basic-information>Basic Information</h3><ul><li><strong>Title</strong>: Split up <code>ComputedUiTargetCamera</code><li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20535<li><strong>Author</strong>: ickshonpe<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, A-UI, C-Code-Quality, S-Ready-For-Final-Review, M-Needs-Migration-Guide, D-Straightforward, A-Camera<li><strong>Created</strong>: 2025-08-12T13:59:30Z<li><strong>Merged</strong>: 2025-08-15T16:28:36Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h3 id=description-translation>Description Translation</h3><h1 id=objective>Objective</h1><p>Remove the render target info from <code>ComputedUiTargetCamera</code> so it just holds the camera id that is only needed for rendering and picking.<p>Fixes #20534<h2 id=solution>Solution</h2><ul><li>Remove the render target info from <code>ComputedUiTargetCamera</code>.<li>Create a new component <code>ComputedUiRenderTargetInfo</code> and move the render target info (physical size and scale factor) into it.<li>Update the systems to use the <code>ComputedUiRenderTargetInfo</code> as needed.</ul><h2 id=testing>Testing</h2><p>The behaviour of the UI examples should be unchanged.<h3 id=the-story-of-this-pull-request>The Story of This Pull Request</h3><p>The <code>ComputedUiTargetCamera</code> component previously combined two distinct responsibilities: identifying the target camera for UI rendering and storing render target information (physical size and scale factor). This coupling caused unnecessary data propagation through systems that only required the camera entity reference, such as picking and focus handling. Additionally, it forced systems that needed physical size/scale factor to carry the entire camera entity reference, even when it wasn’t required.<p>To resolve this, we split the component:<ol><li><code>ComputedUiTargetCamera</code> now exclusively holds the camera entity ID<li><code>ComputedUiRenderTargetInfo</code> contains the physical size and scale factor</ol><p>This separation reduces memory usage and processing overhead in systems that only need one piece of information. For example:<ul><li>Picking systems only require camera entity IDs to map input coordinates<li>Layout systems primarily need physical size/scale factor for pixel-perfect measurements<li>Rendering systems require both but can access them independently</ul><p>The implementation required coordinated changes across multiple systems:<ol><li>Modified the propagation system to generate both components</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// In propagate_ui_target_cameras:
</span><span>commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(root_entity)</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(Propagate(ComputedUiTargetCamera { camera }))</span><span style=color:#61676ccc>;
</span><span>commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(root_entity)</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(Propagate(ComputedUiRenderTargetInfo {
</span><span>    scale_factor</span><span style=color:#61676ccc>,
</span><span>    physical_size</span><span style=color:#61676ccc>,
</span><span>}))</span><span style=color:#61676ccc>;
</span></code></pre><ol start=2><li>Updated all downstream systems to use the appropriate component:</ol><ul><li>Layout calculations switched to <code>ComputedUiRenderTargetInfo</code><li>Text measurement now uses <code>ComputedUiRenderTargetInfo</code> for scale factor<li>Box shadow rendering accesses physical size via <code>ComputedUiRenderTargetInfo</code><li>Focus handling continues using <code>ComputedUiTargetCamera</code> for camera references</ul><p>The changes maintain identical UI behavior while optimizing data access patterns. Systems now query only the necessary components, reducing unnecessary data processing. For instance, text measurement no longer needs to process camera entity data when recalculating layouts after scale factor changes.<p>Testing confirmed no behavioral changes in UI examples. The migration guide alerts users to update their systems where they previously accessed physical size or scale factor through <code>ComputedUiTargetCamera</code>.<h3 id=visual-representation>Visual Representation</h3><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[UI Node] --> B[ComputedUiTargetCamera]
</span><span>    A --> C[ComputedUiRenderTargetInfo]
</span><span>    B --> D[Camera Entity]
</span><span>    C --> E[Physical Size]
</span><span>    C --> F[Scale Factor]
</span></code></pre><h3 id=key-files-changed>Key Files Changed</h3><ol><li><strong><code>crates/bevy_ui/src/ui_node.rs</code></strong><br> Split component definitions and updated accessors:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// BEFORE:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>ComputedUiTargetCamera </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) camera</span><span style=color:#61676ccc>:</span><span> Entity,
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) scale_factor</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>,
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) physical_size</span><span style=color:#61676ccc>:</span><span> UVec2,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// AFTER:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>ComputedUiTargetCamera </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) camera</span><span style=color:#61676ccc>:</span><span> Entity,
</span><span>}
</span><span>
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>ComputedUiRenderTargetInfo </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) scale_factor</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>,
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) physical_size</span><span style=color:#61676ccc>:</span><span> UVec2,
</span><span>}
</span></code></pre><ol start=2><li><strong><code>crates/bevy_ui/src/update.rs</code></strong><br> Refactored propagation logic:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// BEFORE:
</span><span>commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(Propagate(ComputedUiTargetCamera {
</span><span>    camera</span><span style=color:#61676ccc>,
</span><span>    scale_factor</span><span style=color:#61676ccc>,
</span><span>    physical_size</span><span style=color:#61676ccc>,
</span><span>}))</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// AFTER:
</span><span>commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(Propagate(ComputedUiTargetCamera { camera }))</span><span style=color:#61676ccc>;
</span><span>commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(Propagate(ComputedUiRenderTargetInfo {
</span><span>    scale_factor</span><span style=color:#61676ccc>,
</span><span>    physical_size</span><span style=color:#61676ccc>,
</span><span>}))</span><span style=color:#61676ccc>;
</span></code></pre><ol start=3><li><strong><code>crates/bevy_ui/src/layout/mod.rs</code></strong><br> Updated layout system dependencies:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// BEFORE:
</span><span>query&LTRef&LTComputedUiTargetCamera>>
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// AFTER:
</span><span>query&LTRef&LTComputedUiRenderTargetInfo>>
</span></code></pre><ol start=4><li><strong><code>crates/bevy_ui_render/src/box_shadow.rs</code></strong><br> Fixed rendering parameter access:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// BEFORE:
</span><span style=color:#fa6e32>let</span><span> scale_factor </span><span style=color:#ed9366>=</span><span> uinode</span><span style=color:#ed9366>.</span><span>inverse_scale_factor</span><span style=color:#ed9366>.</span><span style=color:#f07171>recip</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// AFTER:
</span><span style=color:#fa6e32>let</span><span> scale_factor </span><span style=color:#ed9366>=</span><span> target</span><span style=color:#ed9366>.</span><span style=color:#f07171>scale_factor</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><ol start=5><li><strong><code>crates/bevy_ui/src/widget/text.rs</code></strong><br> Corrected text measurement inputs:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// BEFORE:
</span><span>query<</span><span style=color:#ed9366>&</span><span>ComputedUiTargetCamera>
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// AFTER:
</span><span>query&LTRef&LTComputedUiRenderTargetInfo>>
</span></code></pre><h3 id=further-reading>Further Reading</h3><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/getting-started/ui/ target=_blank>Bevy UI System Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://gameprogrammingpatterns.com/component.html target=_blank>Component Data Optimization Patterns</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/crates/bevy_hierarchy/src/lib.rs target=_blank>Bevy Hierarchy Propagation</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-08/pr_20535.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>