<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20656 `Text2d` multi target scale factors support
        
    </title><meta content="#20656 `Text2d` multi target scale factors support" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-08/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-08-26</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-08/pr-20656-zh-cn-20250826>中文</a></div></div><div class=pr-content><h1 id=text2d-multi-target-scale-factors-support><code>Text2d</code> multi target scale factors support</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: <code>Text2d</code> multi target scale factors support<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20656<li><strong>Author</strong>: ickshonpe<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, S-Ready-For-Final-Review, A-Text, M-Needs-Release-Note, X-Uncontroversial, D-Straightforward<li><strong>Created</strong>: 2025-08-19T16:20:02Z<li><strong>Merged</strong>: 2025-08-26T03:25:46Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description>Description</h2><p>Use the scale factor of the render target for <code>Text2d</code> entities, instead of always using the scale factor of the primary window.<p>Fixes #17342 Fixes #1890<h2 id=solution>Solution</h2><p>Iterate the cameras, find the first camera with <code>RenderLayers</code> intersecting the <code>Text2d</code> entity’s <code>RenderLayers</code> and use that camera’s target’s scale factor.<p>This also allows us to remove the <code>bevy_window</code> dependency from <code>bevy_sprite_render</code> and make it optional for <code>bevy_sprite</code> on the “bevy_sprite_picking_backend” feature.<p><code>Text2d</code> is still limited to generating only one text layout per <code>Text2d</code> entity. If a <code>Text2d</code> entity is simultaneously rendered to multiple targets with different scale factors then the maximum of the target scale factors is used.<h2 id=testing>Testing</h2><p>I think I’m using <code>RenderLayers</code> and <code>VisibleEntities</code> correctly, and my tests and the examples seem to work, but it would be best if a rendering SME gave this a glance just to to make sure that I’m not doing something naive.<p>Comes with a new example <code>multi_window_text</code> that can be used for testing:<pre style=color:#61676c;background-color:#fafafa><code><span>cargo run --example multi_window_text
</span></code></pre><p>If the changes are working correctly, the secondary window’s text should be twice as big as the primary window’s text without blurriness.<h2 id=showcase>Showcase</h2><img alt=primary src=https://github.com/user-attachments/assets/547edf21-5c6e-4a95-ac8b-1b08b1c1364e width=642><img alt=secondary src=https://github.com/user-attachments/assets/b38d278d-64bc-4a90-9b11-0ac27d3a02bb width=642><p>All the text uses a font-size of <code>30</code>. The secondary window has a scale factor of <code>2.</code>, so the secondary window’s text uses glyphs drawn at double the resolution. On main, <code>Text2d</code> use glyphs drawn at the same size for both windows, and so the text drawn with <code>Text2d</code> to the secondary window is blurry:</p><img alt=secondary_main src=https://github.com/user-attachments/assets/1aa3a523-e1d4-4196-a13c-d6ac8aa34cf3 width=642><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a long-standing issue with <code>Text2d</code> rendering in multi-window setups. The core problem was that <code>Text2d</code> entities always used the scale factor of the primary window, regardless of which render target they were being drawn to. This caused blurry text when rendering to secondary windows with different scale factors.<p>The solution involved rearchitecting how <code>Text2d</code> determines the appropriate scale factor for text rendering. Instead of querying the primary window, the system now iterates through all cameras and finds the first camera whose <code>RenderLayers</code> intersect with the <code>Text2d</code> entity’s <code>RenderLayers</code>. It then uses that camera’s target scale factor for text layout generation.<p>The implementation required changes across multiple systems:<ol><li><p><strong>Camera Query Integration</strong>: The <code>update_text2d_layout</code> system now queries camera entities instead of windows, collecting target scale factors along with their render layer masks.</p><li><p><strong>Render Layer Matching</strong>: For each <code>Text2d</code> entity, the system finds cameras whose render layers intersect with the entity’s layers and selects the maximum scale factor from matching cameras.</p><li><p><strong>Scale Factor Tracking</strong>: Added a <code>scale_factor</code> field to <code>TextLayoutInfo</code> to track which scale factor was used for layout generation, enabling proper scaling during extraction.</p><li><p><strong>Dependency Cleanup</strong>: Removed the <code>bevy_window</code> dependency from <code>bevy_sprite_render</code> since window scale factors are no longer queried directly.</p></ol><p>The system handles edge cases gracefully: if a <code>Text2d</code> entity is visible to multiple cameras with different scale factors, it uses the maximum scale factor to ensure text remains crisp across all targets. This approach maintains backward compatibility while fixing the blurry text issue.<p>A new example <code>multi_window_text</code> demonstrates the fix, showing crisp text in both primary and secondary windows with different scale factors. The example also illustrates how <code>RenderLayers</code> can be used to control which cameras render which text entities.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Text2d Entity] --> B{RenderLayers}
</span><span>    B --> C[Camera 1]
</span><span>    B --> D[Camera 2]
</span><span>    C --> E[Scale Factor 1.0]
</span><span>    D --> F[Scale Factor 2.0]
</span><span>    E --> G[Text Layout Generation]
</span><span>    F --> G
</span><span>    G --> H[Crisp Text Rendering]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-sprite-src-text2d-rs-76-28><code>crates/bevy_sprite/src/text2d.rs</code> (+76/-28)</h3><p>This file contains the core logic changes for multi-window scale factor support. The <code>update_text2d_layout</code> system was completely rewritten to query cameras instead of windows and handle render layer matching.<p><strong>Key changes:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Query primary window only
</span><span style=color:#fa6e32>let</span><span> scale_factor </span><span style=color:#ed9366>=</span><span> windows
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>single</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>ok</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|</span><span style=color:#ff8f40>window</span><span>| window</span><span style=color:#ed9366>.</span><span>resolution</span><span style=color:#ed9366>.</span><span style=color:#f07171>scale_factor</span><span>())
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>or</span><span>(</span><span style=color:#ed9366>*</span><span>last_scale_factor)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_or</span><span>(</span><span style=color:#ff8f40>1.</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Query all cameras and match render layers
</span><span>target_scale_factors</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend</span><span>(
</span><span>    camera_query
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>filter</span><span>(|(_</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>visible_entities</span><span style=color:#61676ccc>,</span><span> _)| {
</span><span>            </span><span style=color:#ed9366>!</span><span>visible_entities</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(TypeId</span><span style=color:#ed9366>::</span><span>of</span><span style=color:#ed9366>::</span><span>&LTSprite>())</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_empty</span><span>()
</span><span>        })
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>filter_map</span><span>(|(</span><span style=color:#ff8f40>camera</span><span style=color:#61676ccc>,</span><span> _</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>maybe_camera_mask</span><span>)| {
</span><span>            camera</span><span style=color:#ed9366>.</span><span style=color:#f07171>target_scaling_factor</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|</span><span style=color:#ff8f40>scale_factor</span><span>| {
</span><span>                (scale_factor</span><span style=color:#61676ccc>,</span><span> maybe_camera_mask</span><span style=color:#ed9366>.</span><span style=color:#f07171>cloned</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_or_default</span><span>())
</span><span>            })
</span><span>        })</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-sprite-render-src-text2d-mod-rs-3-10><code>crates/bevy_sprite_render/src/text2d/mod.rs</code> (+3/-10)</h3><p>Removed window query dependency and now uses the scale factor stored in <code>TextLayoutInfo</code> for proper scaling during extraction.<p><strong>Key changes:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Use primary window scale factor
</span><span style=color:#fa6e32>let</span><span> scale_factor </span><span style=color:#ed9366>=</span><span> windows
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>single</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|</span><span style=color:#ff8f40>window</span><span>| window</span><span style=color:#ed9366>.</span><span>resolution</span><span style=color:#ed9366>.</span><span style=color:#f07171>scale_factor</span><span>())
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_or</span><span>(</span><span style=color:#ff8f40>1.0</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Use scale factor from text layout info
</span><span style=color:#fa6e32>let</span><span> scaling </span><span style=color:#ed9366>= </span><span>GlobalTransform</span><span style=color:#ed9366>::</span><span>from_scale(
</span><span>    Vec2</span><span style=color:#ed9366>::</span><span>splat(text_layout_info</span><span style=color:#ed9366>.</span><span>scale_factor</span><span style=color:#ed9366>.</span><span style=color:#f07171>recip</span><span>())</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend</span><span>(</span><span style=color:#ff8f40>1.</span><span>)</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=examples-window-multi-window-text-rs-116-0><code>examples/window/multi_window_text.rs</code> (+116/-0)</h3><p>New example demonstrating multi-window text rendering with different scale factors, showing both <code>Text</code> and <code>Text2d</code> components working correctly across windows.<h3 id=crates-bevy-text-src-pipeline-rs-1-0><code>crates/bevy_text/src/pipeline.rs</code> (+1/-0)</h3><p>Added <code>scale_factor</code> field to <code>TextLayoutInfo</code> to track which scale factor was used for text layout generation.<h3 id=cargo-toml-11-0><code>Cargo.toml</code> (+11/-0)</h3><p>Added new example and removed <code>bevy_window</code> dependency from <code>bevy_sprite_render</code>.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/render/view/struct.RenderLayers.html target=_blank>Bevy Render Layers Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/window/struct.Window.html#method.scale_factor target=_blank>Window Scale Factors in Bevy</a><li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/features/text.html target=_blank>Text Rendering in Bevy</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-08/pr_20656.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>