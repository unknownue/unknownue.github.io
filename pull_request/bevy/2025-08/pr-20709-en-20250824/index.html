<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20709 use affine in volumetric fog
        
    </title><meta content="#20709 use affine in volumetric fog" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-08/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-08-24</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-08/pr-20709-zh-cn-20250824>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>use affine in volumetric fog<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: use affine in volumetric fog<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20709<li><strong>Author</strong>: atlv24<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-08-22T08:28:20Z<li><strong>Merged</strong>: 2025-08-24T21:12:22Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>avoid mat4 inverse on affine matrices<li>simplify transform math<li>improve perf</ul><h2 id=solution>Solution</h2><ul><li></ul><h2 id=testing>Testing</h2><ul><li>volumetric fog example</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses performance optimization in Bevy’s volumetric fog rendering system by leveraging affine transformations instead of general 4x4 matrices. The core issue was that the system was performing expensive matrix inversions on affine matrices using general-purpose <code>Mat4</code> operations, which are computationally heavier than necessary for affine transformations.<p>The developer recognized that fog volume transformations are inherently affine (containing only translation, rotation, and uniform scaling), making them suitable for the more efficient <code>Affine3A</code> type. This change eliminates unnecessary computational overhead while maintaining identical visual results.<p>The implementation involved systematically replacing <code>Mat4</code> usage with <code>Affine3A</code> throughout the volumetric fog pipeline. Key changes include:<ul><li>Switching local storage from <code>Vec&LTMat4></code> to <code>Vec&LTAffine3A></code> for fog volume transformations<li>Using <code>affine().inverse()</code> instead of <code>to_matrix().inverse()</code> for faster inversion<li>Replacing matrix-vector multiplication with specialized affine transformation methods<li>Updating plane calculation and camera detection logic to work with affine transforms</ul><p>These changes provide measurable performance improvements by reducing mathematical operations and leveraging optimized affine transformation methods. The code also becomes more semantically correct by using the appropriate transformation type for the domain.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[FogVolume Transform] --> B[Affine3A Inverse]
</span><span>    B --> C[View Transform]
</span><span>    C --> D[Vector Transformation]
</span><span>    D --> E[Plane Calculation]
</span><span>    E --> F[Fog Rendering]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>crates/bevy_pbr/src/volumetric_fog/render.rs</strong> (+18/-14)<p>This file contains the core implementation changes for volumetric fog rendering. The modifications replace general 4x4 matrix operations with optimized affine transformations.<p>Key changes include:<ol><li><strong>Matrix storage type change</strong>:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>mut</span><span> local_from_world_matrices</span><span style=color:#61676ccc>: </span><span>Local<</span><span style=color:#55b4d4;font-style:italic>Vec</span><span>&LTMat4>>
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>mut</span><span> local_from_world_matrices</span><span style=color:#61676ccc>: </span><span>Local<</span><span style=color:#55b4d4;font-style:italic>Vec</span><span>&LTAffine3A>>
</span></code></pre><ol start=2><li><strong>Efficient affine inversion</strong>:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>local_from_world_matrices</span><span style=color:#ed9366>.</span><span style=color:#f07171>push</span><span>(fog_transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_matrix</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>inverse</span><span>())</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>local_from_world_matrices</span><span style=color:#ed9366>.</span><span style=color:#f07171>push</span><span>(fog_transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>affine</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>inverse</span><span>())</span><span style=color:#61676ccc>;
</span></code></pre><ol start=3><li><strong>Affine transformation usage</strong>:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> bounding_radius </span><span style=color:#ed9366>= </span><span>(Mat3A</span><span style=color:#ed9366>::</span><span>from_mat4(view_from_local) </span><span style=color:#ed9366>* </span><span>Vec3A</span><span style=color:#ed9366>::</span><span>splat(</span><span style=color:#ff8f40>0.5</span><span>))</span><span style=color:#ed9366>.</span><span style=color:#f07171>length</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> bounding_radius </span><span style=color:#ed9366>=</span><span> view_from_local
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>transform_vector3a</span><span>(Vec3A</span><span style=color:#ed9366>::</span><span>splat(</span><span style=color:#ff8f40>0.5</span><span>))
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>length</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><ol start=4><li><strong>Specialized affine methods</strong>:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> view_normal </span><span style=color:#ed9366>= </span><span>(view_from_normal_local </span><span style=color:#ed9366>*</span><span> local_normal)</span><span style=color:#ed9366>.</span><span style=color:#f07171>normalize_or_zero</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> view_normal </span><span style=color:#ed9366>=</span><span> view_from_local
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>transform_vector3a</span><span>(local_normal)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>normalize_or_zero</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><p>These changes optimize the transformation pipeline by using mathematically appropriate operations for affine transformations, reducing computational overhead while maintaining identical visual results.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Affine_transformation target=_blank>Affine Transformation - Wikipedia</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_math/latest/bevy_math/ target=_blank>Bevy Math Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://www.amazon.com/Computer-Graphics-Principles-Practice-3rd/dp/0321399528 target=_blank>Computer Graphics: Principles and Practice - Foley, van Dam, Feiner, Hughes</a></ul><h2 id=full-code-diff>Full Code Diff</h2><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_pbr/src/volumetric_fog/render.rs b/crates/bevy_pbr/src/volumetric_fog/render.rs
</span><span>index 7d1a55700e429..0c558fe2e804d 100644
</span><span style=color:#c594c5>--- a/crates/bevy_pbr/src/volumetric_fog/render.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_pbr/src/volumetric_fog/render.rs
</span><span style=color:#c594c5>@@ -19,7 +19,7 @@ </span><span style=color:#399ee6>use bevy_ecs::{
</span><span> };
</span><span> use bevy_image::{BevyDefault, Image};
</span><span> use bevy_light::{FogVolume, VolumetricFog, VolumetricLight};
</span><span style=color:#f07171>-use bevy_math::{vec4, Mat3A, Mat4, Vec3, Vec3A, Vec4, Vec4Swizzles as _};
</span><span style=color:#86b300>+use bevy_math::{vec4, Affine3A, Mat4, Vec3, Vec3A, Vec4};
</span><span> use bevy_mesh::{Mesh, MeshVertexBufferLayoutRef};
</span><span> use bevy_render::{
</span><span>     diagnostic::RecordDiagnostics,
</span><span style=color:#c594c5>@@ -698,12 +698,12 @@ </span><span style=color:#399ee6>pub fn prepare_volumetric_fog_uniforms(
</span><span>     fog_volumes: Query<(Entity, &FogVolume, &GlobalTransform)>,
</span><span>     render_device: Res&LTRenderDevice>,
</span><span>     render_queue: Res&LTRenderQueue>,
</span><span style=color:#f07171>-    mut local_from_world_matrices: Local&LTVec&LTMat4>>,
</span><span style=color:#86b300>+    mut local_from_world_matrices: Local&LTVec&LTAffine3A>>,
</span><span> ) {
</span><span>     // Do this up front to avoid O(n^2) matrix inversion.
</span><span>     local_from_world_matrices.clear();
</span><span>     for (_, _, fog_transform) in fog_volumes.iter() {
</span><span style=color:#f07171>-        local_from_world_matrices.push(fog_transform.to_matrix().inverse());
</span><span style=color:#86b300>+        local_from_world_matrices.push(fog_transform.affine().inverse());
</span><span>     }
</span><span> 
</span><span>     let uniform_count = view_targets.iter().len() * local_from_world_matrices.len();
</span><span style=color:#c594c5>@@ -715,7 +715,7 @@ </span><span style=color:#399ee6>pub fn prepare_volumetric_fog_uniforms(
</span><span>     };
</span><span> 
</span><span>     for (view_entity, extracted_view, volumetric_fog) in view_targets.iter() {
</span><span style=color:#f07171>-        let world_from_view = extracted_view.world_from_view.to_matrix();
</span><span style=color:#86b300>+        let world_from_view = extracted_view.world_from_view.affine();
</span><span> 
</span><span>         let mut view_fog_volumes = vec![];
</span><span> 
</span><span style=color:#c594c5>@@ -736,7 +736,9 @@ </span><span style=color:#399ee6>pub fn prepare_volumetric_fog_uniforms(
</span><span>             );
</span><span> 
</span><span>             // Calculate the radius of the sphere that bounds the fog volume.
</span><span style=color:#f07171>-            let bounding_radius = (Mat3A::from_mat4(view_from_local) * Vec3A::splat(0.5)).length();
</span><span style=color:#86b300>+            let bounding_radius = view_from_local
</span><span style=color:#86b300>+                .transform_vector3a(Vec3A::splat(0.5))
</span><span style=color:#86b300>+                .length();
</span><span> 
</span><span>             // Write out our uniform.
</span><span>             let uniform_buffer_offset = writer.write(&VolumetricFogUniform {
</span><span style=color:#c594c5>@@ -788,9 +790,8 @@ </span><span style=color:#399ee6>pub fn prepare_view_depth_textures_for_volumetric_fog(
</span><span>     }
</span><span> }
</span><span> 
</span><span style=color:#f07171>-fn get_far_planes(view_from_local: &Mat4) -> [Vec4; 3] {
</span><span style=color:#86b300>+fn get_far_planes(view_from_local: &Affine3A) -> [Vec4; 3] {
</span><span>     let (mut far_planes, mut next_index) = ([Vec4::ZERO; 3], 0);
</span><span style=color:#f07171>-    let view_from_normal_local = Mat3A::from_mat4(*view_from_local);
</span><span> 
</span><span>     for &local_normal in &[
</span><span>         Vec3A::X,
</span><span style=color:#c594c5>@@ -800,13 +801,15 @@ </span><span style=color:#399ee6>fn get_far_planes(view_from_local: &Mat4) -> [Vec4; 3] {
</span><span>         Vec3A::Z,
</span><span>         Vec3A::NEG_Z,
</span><span>     ] {
</span><span style=color:#f07171>-        let view_normal = (view_from_normal_local * local_normal).normalize_or_zero();
</span><span style=color:#86b300>+        let view_normal = view_from_local
</span><span style=color:#86b300>+            .transform_vector3a(local_normal)
</span><span style=color:#86b300>+            .normalize_or_zero();
</span><span>         if view_normal.z <= 0.0 {
</span><span>             continue;
</span><span>         }
</span><span> 
</span><span style=color:#f07171>-        let view_position = *view_from_local * (-local_normal * 0.5).extend(1.0);
</span><span style=color:#f07171>-        let plane_coords = view_normal.extend(-view_normal.dot(view_position.xyz().into()));
</span><span style=color:#86b300>+        let view_position = view_from_local.transform_point3a(-local_normal * 0.5);
</span><span style=color:#86b300>+        let plane_coords = view_normal.extend(-view_normal.dot(view_position));
</span><span> 
</span><span>         far_planes[next_index] = plane_coords;
</span><span>         next_index += 1;
</span><span style=color:#c594c5>@@ -846,8 +849,9 @@ </span><span style=color:#399ee6>impl VolumetricFogBindGroupLayoutKey {
</span><span> 
</span><span> /// Given the transform from the view to the 1×1×1 cube in local fog volume
</span><span> /// space, returns true if the camera is inside the volume.
</span><span style=color:#f07171>-fn camera_is_inside_fog_volume(local_from_view: &Mat4) -> bool {
</span><span style=color:#f07171>-    Vec3A::from(local_from_view.col(3).xyz())
</span><span style=color:#86b300>+fn camera_is_inside_fog_volume(local_from_view: &Affine3A) -> bool {
</span><span style=color:#86b300>+    local_from_view
</span><span style=color:#86b300>+        .translation
</span><span>         .abs()
</span><span>         .cmple(Vec3A::splat(0.5))
</span><span>         .all()
</span><span style=color:#c594c5>@@ -858,10 +862,10 @@ </span><span style=color:#399ee6>fn camera_is_inside_fog_volume(local_from_view: &Mat4) -> bool {
</span><span> fn calculate_fog_volume_clip_from_local_transforms(
</span><span>     interior: bool,
</span><span>     clip_from_view: &Mat4,
</span><span style=color:#f07171>-    view_from_local: &Mat4,
</span><span style=color:#86b300>+    view_from_local: &Affine3A,
</span><span> ) -> Mat4 {
</span><span>     if !interior {
</span><span style=color:#f07171>-        return *clip_from_view * *view_from_local;
</span><span style=color:#86b300>+        return *clip_from_view * Mat4::from(*view_from_local);
</span><span>     }
</span><span> 
</span><span>     // If the camera is inside the fog volume, then we'll be rendering a full
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-08/pr_20709.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>