<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20359 use transpose not inverse in shadow map transform
        
    </title><meta content="#20359 use transpose not inverse in shadow map transform" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-08/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-08-01</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-08/pr-20359-zh-cn-20250801>中文</a></div></div><div class=pr-content><h1 id=analysis-of-pr-20359-use-transpose-not-inverse-in-shadow-map-transform>Analysis of PR #20359: use transpose not inverse in shadow map transform</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: use transpose not inverse in shadow map transform<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20359<li><strong>Author</strong>: atlv24<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, S-Needs-Review<li><strong>Created</strong>: 2025-07-31T23:38:06Z<li><strong>Merged</strong>: 2025-08-01T22:12:39Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>minor simplification + precision/performance improvement</ul><h2 id=solution>Solution</h2><ul><li>inverse is transpose for rotation matrices</ul><h2 id=testing>Testing</h2><ul><li>shadow_bias example</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a small but meaningful optimization in Bevy’s shadow rendering system. The change occurs in the cascade processing logic where we compute the transformation from world space to light space. Previously, the code was constructing a rotation matrix from a light’s transform and then computing its inverse to get the light-to-world transformation. The key insight here is that for pure rotation matrices (which are orthogonal), the inverse is mathematically equivalent to the transpose. Matrix transposition is computationally cheaper and numerically more stable than full matrix inversion.<p>The original implementation used <code>transform.compute_transform().rotation</code> to extract the rotation component. This was replaced with the more direct <code>transform.rotation()</code> method, which avoids unnecessary computation since we only need the rotation quaternion. The subsequent matrix operation was then changed from <code>inverse()</code> to <code>transpose()</code>, leveraging the mathematical property that for rotation matrices, inverse equals transpose.<p>These changes provide three concrete benefits:<ol><li><strong>Performance improvement</strong>: Matrix transpose is O(n²) while inverse is O(n³) for n×n matrices<li><strong>Numerical stability</strong>: Transpose avoids potential floating-point precision issues in inverse calculations<li><strong>Code simplification</strong>: The more efficient operation better expresses the mathematical intent</ol><p>The author validated these changes using Bevy’s <code>shadow_bias</code> example, confirming that shadow rendering behavior remains correct while gaining these optimizations. This is a good example of a precise, localized optimization that leverages mathematical properties to improve both performance and code quality without changing functionality.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Light Transform] --> B[Extract Rotation]
</span><span>    B --> C[Create Rotation Matrix]
</span><span>    C --> D[Original: Compute Inverse]
</span><span>    C --> E[PR: Compute Transpose]
</span><span>    D --> F[Light-to-World Transform]
</span><span>    E --> F
</span><span>    F --> G[Shadow Mapping]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-light-src-cascade-rs><code>crates/bevy_light/src/cascade.rs</code></h3><p><strong>Changes:</strong><ol><li>Optimized rotation extraction from light transform<li>Replaced matrix inverse with transpose operation</ol><p><strong>Before:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let</span><span> world_from_light </span><span style=color:#ed9366>= </span><span>Mat4</span><span style=color:#ed9366>::</span><span>from_quat(transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>compute_transform</span><span>()</span><span style=color:#ed9366>.</span><span>rotation)</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> light_to_world_inverse </span><span style=color:#ed9366>=</span><span> world_from_light</span><span style=color:#ed9366>.</span><span style=color:#f07171>inverse</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><p><strong>After:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let</span><span> world_from_light </span><span style=color:#ed9366>= </span><span>Mat4</span><span style=color:#ed9366>::</span><span>from_quat(transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>rotation</span><span>())</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> light_to_world_inverse </span><span style=color:#ed9366>=</span><span> world_from_light</span><span style=color:#ed9366>.</span><span style=color:#f07171>transpose</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><p><strong>Why:</strong><ul><li><code>transform.rotation()</code> directly accesses the rotation component without computing the full transform<li><code>transpose()</code> replaces <code>inverse()</code> for better performance and numerical stability<li>Both changes maintain identical mathematical results for rotation matrices</ul><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Rotation_matrix target=_blank>Rotation Matrix Properties (Wikipedia)</a><li><a rel="noopener nofollow noreferrer" href=https://math.stackexchange.com/questions/1936020/why-is-the-inverse-of-an-orthogonal-matrix-equal-to-its-transpose target=_blank>Matrix Transpose vs Inverse (Math StackExchange)</a><li><a rel="noopener nofollow noreferrer" href=https://www.scratchapixel.com/lessons/mathematics-physics-for-computer-graphics/geometry target=_blank>Floating-Point Precision in Computer Graphics (Scratchapixel)</a></ul><h2 id=full-code-diff>Full Code Diff</h2><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_light/src/cascade.rs b/crates/bevy_light/src/cascade.rs
</span><span>index 0cb713a9e684c..ba4c615b06007 100644
</span><span style=color:#c594c5>--- a/crates/bevy_light/src/cascade.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_light/src/cascade.rs
</span><span style=color:#c594c5>@@ -225,8 +225,8 @@ </span><span style=color:#399ee6>pub fn build_directional_light_cascades(
</span><span>         // users to not change any other aspects of the transform - there's no guarantee
</span><span>         // `transform.to_matrix()` will give us a matrix with our desired properties.
</span><span>         // Instead, we directly create a good matrix from just the rotation.
</span><span style=color:#f07171>-        let world_from_light = Mat4::from_quat(transform.compute_transform().rotation);
</span><span style=color:#f07171>-        let light_to_world_inverse = world_from_light.inverse();
</span><span style=color:#86b300>+        let world_from_light = Mat4::from_quat(transform.rotation());
</span><span style=color:#86b300>+        let light_to_world_inverse = world_from_light.transpose();
</span><span> 
</span><span>         for (view_entity, projection, view_to_world) in views.iter().copied() {
</span><span>             let camera_to_light_view = light_to_world_inverse * view_to_world;
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-08/pr_20359.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>