<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20430 debounce asset events for scene reloading
        
    </title><meta content="#20430 debounce asset events for scene reloading" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-08/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-08-14</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-08/pr-20430-zh-cn-20250814>中文</a></div></div><div class=pr-content><h2 id=debounce-asset-events-for-scene-reloading>debounce asset events for scene reloading</h2><h3 id=basic-information>Basic Information</h3><ul><li><strong>Title</strong>: debounce asset events for scene reloading<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20430<li><strong>Author</strong>: mockersf<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Assets, S-Ready-For-Final-Review, A-Scenes, X-Contentious<li><strong>Created</strong>: 2025-08-05T18:51:25Z<li><strong>Merged</strong>: 2025-08-14T20:34:40Z<li><strong>Merged By</strong>: mockersf</ul><h3 id=description-translation>Description Translation</h3><h1 id=objective>Objective</h1><ul><li>examples <code>many_foxes</code> and <code>morph_targets</code> have stopped working since #18358<li>any case that load several parts of a complex asset and a scene, and do setup on asset load will fail<li>Fixes #20383</ul><h2 id=solution>Solution</h2><ul><li>Debounce scene asset events so that we ignore modified event happening too quickly after each others</ul><h2 id=testing>Testing</h2><ul><li>run examples <code>many_foxes</code> or <code>morph_targets</code></ul><h2 id=alternative>Alternative</h2><p>I <em>don’t</em> think this is a good long term fix, but this should be fixed in the 0.17 and I think alternatives are worse / too complex.<p>Alternatives are:<ul><li>Revert #18358. Normal scene loading is more important than hot reloading<li>Implement partial asset loading in the asset server and the gltf loader so that when we load <code>file.gltf#Animation0</code>, only the animation data is loaded. This would be a very good change, but too big to do for the 0.17<li>Have the asset server load parent assets only once, even when loading subassets. This would be a good change and less complex, but I think worse than the previous idea and kinda not compatible with it</ul><h3 id=the-story-of-this-pull-request>The Story of This Pull Request</h3><p>This PR addresses a regression in Bevy’s asset handling system that broke several examples and real-world use cases after the introduction of hot-reloading in PR #18358. The core issue (#20383) manifested when loading complex assets like GLTF files containing multiple subassets (meshes, animations, textures). Each subasset load would trigger a separate <code>Modified</code> event for the parent scene asset, causing the scene to be unloaded and reloaded multiple times in quick succession. This behavior was particularly problematic for scenes with initial setup logic, as repeated reloads would reset entity transforms and other state.<p>The solution implements an event debouncing mechanism for scene assets. Rather than immediately processing every <code>Modified</code> event, the system now tracks event timestamps and ignores events occurring within a short time window (2 frames) of each other. This approach prevents multiple rapid-fire events from triggering repeated scene reloads while still allowing legitimate asset modifications to propagate.<p>Two new fields were added to the <code>SceneSpawner</code> struct to implement this debouncing logic:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>SceneSpawner </span><span>{
</span><span>    scene_asset_event_reader</span><span style=color:#61676ccc>: </span><span>EventCursor&LTAssetEvent&LTScene>>,
</span><span>    dynamic_scene_asset_event_reader</span><span style=color:#61676ccc>: </span><span>EventCursor&LTAssetEvent&LTDynamicScene>>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other fields
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>SceneSpawner </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... existing fields
</span><span>    debounced_scene_asset_events</span><span style=color:#61676ccc>: </span><span>HashMap&LTAssetId&LTScene>, </span><span style=color:#fa6e32>u32</span><span>>,
</span><span>    debounced_dynamic_scene_asset_events</span><span style=color:#61676ccc>: </span><span>HashMap&LTAssetId&LTDynamicScene>, </span><span style=color:#fa6e32>u32</span><span>>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other fields
</span><span>}
</span></code></pre><p>The asset event processing logic was modified to incorporate the debouncing check. For <code>Modified</code> events, the system now verifies whether the asset ID is new to the debounce map before processing:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>match</span><span> event {
</span><span>    AssetEvent</span><span style=color:#ed9366>::</span><span>Added { id } </span><span style=color:#ed9366>=> </span><span>{
</span><span>        scene_spawner</span><span style=color:#ed9366>.</span><span>debounced_scene_asset_events</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(</span><span style=color:#ed9366>*</span><span>id</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span>)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>    AssetEvent</span><span style=color:#ed9366>::</span><span>Modified { id } </span><span style=color:#ed9366>=> </span><span>{
</span><span>        </span><span style=color:#fa6e32>if</span><span> scene_spawner
</span><span>            </span><span style=color:#ed9366>.</span><span>debounced_scene_asset_events
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(</span><span style=color:#ed9366>*</span><span>id</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span>)
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>is_none</span><span>()
</span><span>            </span><span style=color:#ed9366>&&</span><span> scene_spawner</span><span style=color:#ed9366>.</span><span>spawned_scenes</span><span style=color:#ed9366>.</span><span style=color:#f07171>contains_key</span><span>(id)
</span><span>        {
</span><span>            updated_spawned_scenes</span><span style=color:#ed9366>.</span><span style=color:#f07171>push</span><span>(</span><span style=color:#ed9366>*</span><span>id)</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>    }
</span><span>    </span><span style=color:#ed9366>_ => </span><span>{}
</span><span>}
</span></code></pre><p>A periodic cleanup mechanism increments counters each frame and removes stale entries after they exceed the threshold:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>const </span><span style=color:#ff8f40>SCENE_ASSET_AGE_THRESHOLD</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u32 </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>2</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>for</span><span> asset_id </span><span style=color:#ed9366>in</span><span> scene_spawner</span><span style=color:#ed9366>.</span><span>debounced_scene_asset_events</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>keys</span><span>() {
</span><span>    </span><span style=color:#fa6e32>let</span><span> age </span><span style=color:#ed9366>=</span><span> scene_spawner
</span><span>        </span><span style=color:#ed9366>.</span><span>debounced_scene_asset_events
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(asset_id)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>if </span><span style=color:#ed9366>*</span><span>age </span><span style=color:#ed9366>> </span><span style=color:#ff8f40>SCENE_ASSET_AGE_THRESHOLD </span><span>{
</span><span>        scene_spawner</span><span style=color:#ed9366>.</span><span>debounced_scene_asset_events</span><span style=color:#ed9366>.</span><span style=color:#f07171>remove</span><span>(asset_id)</span><span style=color:#61676ccc>;
</span><span>    } </span><span style=color:#fa6e32>else </span><span>{
</span><span>        scene_spawner
</span><span>            </span><span style=color:#ed9366>.</span><span>debounced_scene_asset_events
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(</span><span style=color:#ed9366>*</span><span>asset_id</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>*</span><span>age </span><span style=color:#ed9366>+ </span><span style=color:#ff8f40>1</span><span>)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><p>The implementation required adjustments to test cases, as multiple frame updates are now needed to clear the debounce buffer. Tests were updated with explicit frame advancement calls:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added to tests in lib.rs
</span><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>update</span><span>()</span><span style=color:#61676ccc>;
</span><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>update</span><span>()</span><span style=color:#61676ccc>;
</span><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>update</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><p>This solution is explicitly marked as a temporary fix in code comments. The long-term solution involves implementing partial asset loading where subassets like <code>file.gltf#Animation0</code> would load only required data without affecting the parent asset. However, this approach was deemed too complex for immediate implementation in the 0.17 release cycle.<h3 id=visual-representation>Visual Representation</h3><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Asset Event Occurred] --> B{Event Type}
</span><span>    B -->|Added| C[Insert into debounce map age=0]
</span><span>    B -->|Modified| D{Asset in debounce map?}
</span><span>    D -->|No| E[Process event and insert into map]
</span><span>    D -->|Yes| F[Skip event and reset age counter]
</span><span>    G[Frame Update] --> H[Increment all counters]
</span><span>    H --> I{Counter > 2?}
</span><span>    I -->|Yes| J[Remove from map]
</span><span>    I -->|No| K[Keep in map]
</span></code></pre><h3 id=key-files-changed>Key Files Changed</h3><ol><li><p><strong>crates/bevy_scene/src/scene_spawner.rs</strong><br> Added debounce logic for scene asset events:</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// New struct fields
</span><span>debounced_scene_asset_events</span><span style=color:#61676ccc>: </span><span>HashMap&LTAssetId&LTScene>, </span><span style=color:#fa6e32>u32</span><span>></span><span style=color:#61676ccc>,
</span><span>debounced_dynamic_scene_asset_events</span><span style=color:#61676ccc>: </span><span>HashMap&LTAssetId&LTDynamicScene>, </span><span style=color:#fa6e32>u32</span><span>></span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Modified event handling
</span><span style=color:#fa6e32>match</span><span> event {
</span><span>    AssetEvent</span><span style=color:#ed9366>::</span><span>Added { id } </span><span style=color:#ed9366>=> </span><span>{
</span><span>        scene_spawner</span><span style=color:#ed9366>.</span><span>debounced_scene_asset_events</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(</span><span style=color:#ed9366>*</span><span>id</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span>)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>    AssetEvent</span><span style=color:#ed9366>::</span><span>Modified { id } </span><span style=color:#ed9366>=> </span><span>{
</span><span>        </span><span style=color:#fa6e32>if</span><span> scene_spawner
</span><span>            </span><span style=color:#ed9366>.</span><span>debounced_scene_asset_events
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(</span><span style=color:#ed9366>*</span><span>id</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span>)
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>is_none</span><span>()
</span><span>            </span><span style=color:#ed9366>&&</span><span> scene_spawner</span><span style=color:#ed9366>.</span><span>spawned_scenes</span><span style=color:#ed9366>.</span><span style=color:#f07171>contains_key</span><span>(id)
</span><span>        {
</span><span>            updated_spawned_scenes</span><span style=color:#ed9366>.</span><span style=color:#f07171>push</span><span>(</span><span style=color:#ed9366>*</span><span>id)</span><span style=color:#61676ccc>;
</span><span>        }
</span><span>    }
</span><span>    </span><span style=color:#ed9366>_ => </span><span>{}
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Periodic cleanup
</span><span style=color:#fa6e32>const </span><span style=color:#ff8f40>SCENE_ASSET_AGE_THRESHOLD</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u32 </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>2</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>for</span><span> asset_id </span><span style=color:#ed9366>in</span><span> scene_spawner</span><span style=color:#ed9366>.</span><span>debounced_scene_asset_events</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>keys</span><span>() {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Age checking and removal logic
</span><span>}
</span></code></pre><li><p><strong>crates/bevy_scene/src/lib.rs</strong><br> Updated tests to account for debounce timing:</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>update</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>update</span><span>()</span><span style=color:#61676ccc>;
</span><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>update</span><span>()</span><span style=color:#61676ccc>;
</span><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>update</span><span>()</span><span style=color:#61676ccc>;
</span><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>update</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre></ol><h3 id=further-reading>Further Reading</h3><ol><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/issues/20383 target=_blank>Original Issue #20383</a> - Detailed bug report<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/pull/18358 target=_blank>PR #18358</a> - Hot-reloading changes that introduced the regression<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/features/assets/ target=_blank>Asset System Documentation</a> - Bevy’s asset handling fundamentals<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/discussions/2543 target=_blank>Event Handling Patterns</a> - Discussion of event processing in ECS architectures</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-08/pr_20430.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>