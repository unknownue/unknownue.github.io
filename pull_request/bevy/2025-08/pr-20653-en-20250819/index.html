<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20653 Enabling bevy_tasks/async-io Feature When async-io is in Use
        
    </title><meta content="#20653 Enabling bevy_tasks/async-io Feature When async-io is in Use" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-08/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-08-19</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-08/pr-20653-zh-cn-20250819>中文</a></div></div><div class=pr-content><h1 id=title-enabling-bevy-tasks-async-io-feature-when-async-io-is-in-use>Title: Enabling bevy_tasks/async-io Feature When async-io is in Use</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Enable bevy_tasks/async-io when async-io is in use<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20653<li><strong>Author</strong>: james7132<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: D-Trivial, A-Accessibility, S-Ready-For-Final-Review, A-Editor, A-Tasks<li><strong>Created</strong>: 2025-08-19T06:51:30Z<li><strong>Merged</strong>: 2025-08-19T17:02:00Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>bevy_tasks has a feature that otherwise goes unused in first-party crates to enable use of async-io’s block_on instead of futures_lite::block_on. This enables the idle time between tasks to be used to process async-io’s work.<br> We do actually conditionally use <code>async-io</code> in a few locations.<h2 id=solution>Solution</h2><p>Enable the feature when those features are in use.<h2 id=future-work>Future Work</h2><ul><li><input disabled type=checkbox> smol-hyper unfortunately pulls in both async-io and async-executor. If we do end up merging #20331, we may want https://github.com/notgull/smol-hyper/pull/3 to keep async-executor out of the dependency tree.</ul><h2 id=testing>Testing</h2><p>CI<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a straightforward but important optimization in Bevy’s async task execution system. The core issue was that <code>bevy_tasks</code> includes an <code>async-io</code> feature flag that enables the use of <code>async-io</code>’s <code>block_on</code> implementation instead of <code>futures_lite::block_on</code>, but this feature wasn’t being activated even when <code>async-io</code> was actually being used elsewhere in the codebase.<p>The problem occurs in two specific modules: <code>bevy_remote</code> and <code>bevy_winit</code>. Both of these crates conditionally depend on <code>async-io</code> through their feature flags (<code>http</code> for <code>bevy_remote</code> and <code>accesskit_unix</code> for <code>bevy_winit</code>), but they weren’t enabling the corresponding <code>async-io</code> feature in <code>bevy_tasks</code>. This meant that even though <code>async-io</code> was present in the dependency tree, <code>bevy_tasks</code> wasn’t taking advantage of its potentially more efficient task scheduling capabilities.<p>The <code>async-io</code> crate’s <code>block_on</code> implementation has a key advantage: it can utilize idle time between tasks to process <code>async-io</code>’s own work, potentially leading to better performance in async-heavy applications. Without this feature enabled, Bevy was leaving performance on the table in scenarios where <code>async-io</code> was already being used.<p>The solution is simple but effective: enable the <code>bevy_tasks/async-io</code> feature in both crates when their respective features that pull in <code>async-io</code> are enabled. This ensures that when <code>async-io</code> is available, <code>bevy_tasks</code> will automatically use its optimized <code>block_on</code> implementation instead of the default <code>futures_lite</code> version.<p>The implementation required minimal changes - just adding the feature flag to the appropriate feature definitions in the Cargo.toml files. This is a clean solution that maintains the existing conditional dependency structure while ensuring all components properly coordinate their feature usage.<p>From an architectural perspective, this change improves the consistency of the feature flag system. Features that introduce dependencies should generally enable the corresponding features in dependent crates to ensure optimal performance and functionality. This PR follows that principle by properly propagating the <code>async-io</code> feature through the dependency graph.<p>The impact is primarily performance-related: applications using the <code>http</code> feature of <code>bevy_remote</code> or the <code>accesskit_unix</code> feature of <code>bevy_winit</code> will now benefit from <code>async-io</code>’s more efficient task scheduling without any code changes required. This is a clear win for users of these features.<p>The PR also notes future work regarding <code>smol-hyper</code>, which currently pulls in both <code>async-io</code> and <code>async-executor</code>. If PR #20331 is merged, there may be an opportunity to further optimize the dependency tree by keeping <code>async-executor</code> out, but that’s outside the scope of this current change.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[bevy_remote/http feature] --> B[async-io dependency]
</span><span>    A --> C[bevy_tasks/async-io feature]
</span><span>    D[bevy_winit/accesskit_unix feature] --> E[async-io dependency]
</span><span>    D --> F[bevy_tasks/async-io feature]
</span><span>    B --> G[Optimized block_on]
</span><span>    E --> G
</span><span>    C --> G
</span><span>    F --> G
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-remote-cargo-toml><code>crates/bevy_remote/Cargo.toml</code></h3><p>This file was modified to enable the <code>bevy_tasks/async-io</code> feature when the <code>http</code> feature is used, since <code>http</code> already pulls in <code>async-io</code>.<pre class=language-toml data-lang=toml style=color:#61676c;background-color:#fafafa><code class=language-toml data-lang=toml><span style=color:#abb0b6;font-style:italic># Before:
</span><span style=color:#399ee6>http </span><span>= [</span><span style=color:#86b300>"dep:async-io"</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"dep:smol-hyper"</span><span>]
</span><span>
</span><span style=color:#abb0b6;font-style:italic># After:
</span><span style=color:#399ee6>http </span><span>= [</span><span style=color:#86b300>"dep:async-io"</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"dep:smol-hyper"</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"bevy_tasks/async-io"</span><span>]
</span></code></pre><h3 id=crates-bevy-winit-cargo-toml><code>crates/bevy_winit/Cargo.toml</code></h3><p>This file was modified to enable the <code>bevy_tasks/async-io</code> feature when the <code>accesskit_unix</code> feature is used, since <code>accesskit_unix</code> already pulls in <code>async-io</code> through <code>accesskit_winit</code>.<pre class=language-toml data-lang=toml style=color:#61676c;background-color:#fafafa><code class=language-toml data-lang=toml><span style=color:#abb0b6;font-style:italic># Before:
</span><span style=color:#399ee6>accesskit_unix </span><span>= [</span><span style=color:#86b300>"accesskit_winit/accesskit_unix"</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"accesskit_winit/async-io"</span><span>]
</span><span>
</span><span style=color:#abb0b6;font-style:italic># After:
</span><span style=color:#399ee6>accesskit_unix </span><span>= [
</span><span>  </span><span style=color:#86b300>"accesskit_winit/accesskit_unix"</span><span style=color:#61676ccc>,
</span><span>  </span><span style=color:#86b300>"accesskit_winit/async-io"</span><span style=color:#61676ccc>,
</span><span>  </span><span style=color:#86b300>"bevy_tasks/async-io"</span><span style=color:#61676ccc>,
</span><span>]
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/async-io target=_blank>async-io crate documentation</a> - Learn about async-io’s block_on implementation and its advantages<li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_tasks target=_blank>Bevy Tasks documentation</a> - Understanding Bevy’s task execution system<li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/cargo/reference/features.html target=_blank>Cargo features documentation</a> - How to properly use and propagate feature flags in Rust<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/pull/20331 target=_blank>PR #20331</a> - Related work that might affect future dependency optimization</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-08/pr_20653.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>