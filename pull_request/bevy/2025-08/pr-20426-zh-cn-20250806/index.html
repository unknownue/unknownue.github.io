<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20426 Trim dependencies.
        
    </title><meta content="#20426 Trim dependencies." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-08/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-08-06</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2025-08/pr-20426-en-20250806>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=trim-dependencies>Trim dependencies</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Trim dependencies.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20426<li><strong>Author</strong>: nnethercote<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Dependencies, C-Code-Quality, S-Ready-For-Final-Review, X-Uncontroversial, D-Straightforward<li><strong>Created</strong>: 2025-08-05T06:06:38Z<li><strong>Merged</strong>: 2025-08-06T09:04:39Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=mu-biao>目标</h1><p>移除不需要的依赖项。<h2 id=jie-jue-fang-an>解决方案</h2><p>使用 <code>cargo-shear</code>、<code>cargo-machete</code> 和 <code>cargo-udeps</code> 进行识别。它们都执行相同的任务（识别未使用的依赖项），效果都一般（存在大量假阴性和假阳性），但三者结合使用可以获得有用的结果。<h2 id=ce-shi>测试</h2><ul><li>我通过在每个受影响的 crate 中 grep 已移除依赖项的名称来双重检查所有移除项，确保没有剩余的使用。我认为它们都是安全的。<li>运行 <code>cargo run -p ci</code></ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=wen-ti-shi-bie>问题识别</h3><p>在大型 Rust 项目如 Bevy 中，随着时间推移，依赖项会累积不必要的包。这些未使用的依赖会增加编译时间、二进制大小和潜在的安全风险。PR #20426 的目标是系统性地识别并移除这些冗余依赖，保持项目的轻量和高效。<h3 id=gong-ju-xuan-ze-yu-fang-fa>工具选择与方法</h3><p>作者采用三重工具策略：<ol><li><code>cargo-shear</code>：检测未使用的依赖<li><code>cargo-machete</code>：扫描未使用的依赖声明<li><code>cargo-udeps</code>：查找未使用的开发依赖</ol><p>由于每个工具都有局限性（假阳性和假阴性），作者组合使用它们相互验证。这种方法提高了结果的可靠性，但最终仍需手动验证每个移除项。<h3 id=shou-dong-yan-zheng-guo-cheng>手动验证过程</h3><p>为确保安全性，作者对每个被移除的依赖执行了以下操作：<ol><li>在整个 crate 中搜索依赖名称<li>检查所有导入、宏和特性标志<li>确认没有残留引用<li>运行 CI 测试 (<code>cargo run -p ci</code>) 验证构建完整性</ol><h3 id=ju-ti-yi-lai-yi-chu-fen-xi>具体依赖移除分析</h3><p>移除操作集中在六个 Cargo.toml 文件中，影响多种类型的依赖：<p><strong>根目录依赖清理</strong>:<pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span style=color:#f07171>- hyper = { version = "1", features = ["server", "http1"] }
</span><span style=color:#f07171>- http-body-util = "0.1"
</span><span style=color:#f07171>- macro_rules_attribute = "0.2"
</span></code></pre><p>这些网络相关的依赖可能来自旧功能或原型代码，当前代码库已不再需要。<p><strong>基准测试优化</strong>:<pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span style=color:#f07171>- bevy_utils = { path = "../crates/bevy_utils" }
</span></code></pre><p>基准测试不再需要 utils 模块提供的辅助功能，简化了测试环境。<p><strong>平台特定调整</strong>:<pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span style=color:#f07171>-[target.'cfg(target_os = "linux")'.dev-dependencies]
</span><span style=color:#f07171>-bevy_winit = { path = "../crates/bevy_winit", features = ["x11"] }
</span></code></pre><p>由于基准测试不实际创建窗口，Linux 专用的 winit 依赖被移除。<p><strong>渲染模块精简</strong>:<pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span style=color:#f07171>- codespan-reporting = "0.12.0"
</span></code></pre><p>该错误报告库在渲染流程中已不再使用。<p><strong>文本模块调整</strong>:<pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span style=color:#f07171>- unicode-bidi = "0.3.13"
</span></code></pre><p>双向文本支持库被移除，表明当前文本处理流程已简化或改用其他方案。<p><strong>WASM 目标优化</strong>:<pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span style=color:#f07171>- crossbeam-channel = "0.5"
</span></code></pre><p>WebAssembly 环境移除了不必要的线程通道库，适应 wasm 的单线程模型。<h3 id=ji-shu-jue-ce-yu-kao-liang>技术决策与考量</h3><ol><li><strong>安全第一</strong>：每个移除项都经过 grep 验证，避免破坏性更改<li><strong>工具互补</strong>：结合多个检测工具弥补各自缺陷<li><strong>范围控制</strong>：仅移除明确未使用的依赖，保守处理边界情况<li><strong>CI 验证</strong>：通过标准测试管道确认无回归问题</ol><h3 id=ying-xiang-yu-shou-yi>影响与收益</h3><ol><li><strong>构建性能</strong>：减少不必要的依赖缩短了干净构建时间<li><strong>二进制大小</strong>：减小最终二进制文件的体积<li><strong>安全面</strong>：减少潜在漏洞的攻击面<li><strong>维护性</strong>：简化依赖树使未来升级更易管理<li><strong>编译检查</strong>：消除未使用依赖的编译警告</ol><h2 id=key-files-changed>Key Files Changed</h2><h3 id=cargo-toml>Cargo.toml</h3><p>移除三个主依赖和三个开发依赖：<pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span style=color:#f07171>- hyper = { version = "1", features = ["server", "http1"] }
</span><span style=color:#f07171>- http-body-util = "0.1"
</span><span style=color:#f07171>- macro_rules_attribute = "0.2"
</span><span>[target.'cfg(not(target_family = "wasm"))'.dev-dependencies]
</span><span style=color:#f07171>- smol = "2"
</span><span style=color:#f07171>- smol-macros = "0.1"
</span><span style=color:#f07171>- smol-hyper = "0.1"
</span></code></pre><h3 id=benches-cargo-toml>benches/Cargo.toml</h3><p>简化基准测试依赖：<pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span style=color:#f07171>- bevy_utils = { path = "../crates/bevy_utils" }
</span><span style=color:#f07171>-[target.'cfg(target_os = "linux")'.dev-dependencies]
</span><span style=color:#f07171>- bevy_winit = { path = "../crates/bevy_winit", features = ["x11"] }
</span></code></pre><h3 id=crates-bevy-render-cargo-toml>crates/bevy_render/Cargo.toml</h3><p>移除渲染专用依赖：<pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span style=color:#f07171>- codespan-reporting = "0.12.0"
</span></code></pre><h3 id=crates-bevy-text-cargo-toml>crates/bevy_text/Cargo.toml</h3><p>精简文本处理依赖：<pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span style=color:#f07171>- unicode-bidi = "0.3.13"
</span></code></pre><h3 id=crates-bevy-winit-cargo-toml>crates/bevy_winit/Cargo.toml</h3><p>优化 WASM 依赖：<pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span style=color:#f07171>- crossbeam-channel = "0.5"
</span></code></pre><h3 id=tools-example-showcase-cargo-toml>tools/example-showcase/Cargo.toml</h3><p>清理工具依赖：<pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span style=color:#f07171>- ron = "0.10"
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><code>cargo-udeps</code> 官方文档: https://github.com/est31/cargo-udeps<li>Rust 依赖管理最佳实践: https://doc.rust-lang.org/cargo/guide/dependencies.html<li>使用 <code>cargo tree</code> 分析依赖: https://doc.rust-lang.org/cargo/commands/cargo-tree.html<li>依赖安全检查工具 <code>cargo-audit</code>: https://github.com/RustSec/cargo-audit</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-08/pr_20426.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>