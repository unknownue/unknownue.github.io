<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18473 Make `GatedReader` a test-only symbol, and allow all `bevy_asset` tests to all run single threaded.
        
    </title><meta content="#18473 Make `GatedReader` a test-only symbol, and allow all `bevy_asset` tests to all run single threaded." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-08/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-08-15</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-08/pr-18473-zh-cn-20250815>中文</a></div></div><div class=pr-content><h1 id=analysis-of-pr-18473-make-gatedreader-a-test-only-symbol>Analysis of PR #18473: Make <code>GatedReader</code> a test-only symbol</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Make <code>GatedReader</code> a test-only symbol, and allow all <code>bevy_asset</code> tests to all run single threaded.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18473<li><strong>Author</strong>: andriyDev<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Assets, S-Ready-For-Final-Review, C-Testing, M-Needs-Migration-Guide, X-Uncontroversial, D-Straightforward, D-Async<li><strong>Created</strong>: 2025-03-22T01:54:38Z<li><strong>Merged</strong>: 2025-08-15T04:24:03Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Some tests have been disabled in single-threaded mode.<li>This was because the channel blocks the executing thread when in the asset reader. But that means we never get to the test line to open the gate! So we need multithreading just to let the reader block and the test can make progress in the background.</ul><h2 id=solution>Solution</h2><ul><li>The solution to allowing all tests to run single threaded is to make <code>GatedReader</code> await for gates to open rather than blocking on it.<li>This however requires adding <code>async-channel</code> (already in tree). To avoid this additional dependency in most cases, I made this a dev-dependency.<li>However, this now means that <code>GatedReader</code> can only be used in tests (in bevy_asset). We could make this a feature flag, but it seems highly unlikely that real users need a <code>GatedReader</code> - and if they need it for their test, they can just fork the <code>GatedReader</code>.</ul><h2 id=testing>Testing</h2><ul><li>The <code>bevy_asset</code> tests pass without setting the <code>--features multi_threaded</code> flag!</ul><hr><h2 id=migration-guide>Migration Guide</h2><p><code>bevy_asset::io::gated::GatedReader</code> and <code>bevy_asset::io::gated::GatedOpener</code> are no longer accessible to users.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=the-problem-and-context>The Problem and Context</h3><p>Several <code>bevy_asset</code> tests were disabled in single-threaded mode due to synchronization issues with <code>GatedReader</code>. This test utility blocked threads using synchronous channels, preventing test progress in single-threaded environments. The core issue was that the blocking <code>recv()</code> call in <code>GatedReader</code> would stall the only available thread, preventing test code from reaching the point where it could open gates. This forced tests to require multi-threading just to work around the blocking behavior.<h3 id=the-solution-approach>The Solution Approach</h3><p>The solution centered on converting <code>GatedReader</code> to use asynchronous I/O:<ol><li>Replace <code>crossbeam_channel</code> with <code>async-channel</code> to enable non-blocking awaits<li>Modify <code>recv()</code> to <code>await</code> instead of blocking<li>Make <code>GatedReader</code> test-only to avoid shipping unused code<li>Remove multi-threading requirements from affected tests</ol><h3 id=the-implementation>The Implementation</h3><p>The key change was converting the blocking channel operations to async-compatible equivalents. In <code>gated.rs</code>, the <code>crossbeam_channel</code> was replaced with <code>async_channel</code>, and <code>receiver.recv().unwrap()</code> was changed to <code>receiver.recv().await.unwrap()</code>. This allows the single thread to yield execution while waiting for gates to open.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before (blocking):
</span><span>receiver</span><span style=color:#ed9366>.</span><span style=color:#f07171>recv</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After (async):
</span><span>receiver</span><span style=color:#ed9366>.</span><span style=color:#f07171>recv</span><span>()</span><span style=color:#ed9366>.</span><span>await</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><p>The <code>GateOpener</code> was modified to use <code>send_blocking()</code> to maintain compatibility with test code that isn’t fully async:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>gates</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0.</span><span style=color:#f07171>send_blocking</span><span>(())</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><p>To prevent <code>GatedReader</code> from being compiled in release builds, it was moved behind a <code>#[cfg(test)]</code> guard in <code>io/mod.rs</code>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(test)]
</span><span style=color:#fa6e32>pub mod </span><span style=color:#399ee6>gated</span><span style=color:#61676ccc>;
</span></code></pre><p>This change allowed removal of multi-threading requirement checks from 5 test cases in <code>lib.rs</code>, eliminating error messages like:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Removed from tests:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(</span><span style=color:#f29718>not</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"multi_threaded"</span><span>))]
</span><span style=color:#f07171>panic!</span><span>(</span><span style=color:#86b300>"This test requires the </span><span style=color:#4cbf99>\"</span><span style=color:#86b300>multi_threaded</span><span style=color:#4cbf99>\"</span><span style=color:#86b300> feature..."</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=technical-insights>Technical Insights</h3><p>The implementation demonstrates effective async conversion of blocking operations:<ol><li>Using <code>async-channel</code> maintains similar channel semantics while enabling async/await<li><code>send_blocking()</code> bridges sync and async contexts when opening gates<li>The test-only restriction avoids imposing async-channel on all users<li>Tests now properly exercise async asset loading in single-threaded environments</ol><h3 id=the-impact>The Impact</h3><p>These changes enable all <code>bevy_asset</code> tests to run in single-threaded mode, reducing test complexity and improving CI flexibility. The <code>GatedReader</code> is now properly scoped to test builds, reducing binary size for end-users. The changes also demonstrate how to convert blocking test utilities to async patterns without disrupting test semantics.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Test Execution] --> B[GatedReader.read]
</span><span>    B --> C{Channel Receive}
</span><span>    C -->|Blocking| D[Thread Stalled]
</span><span>    C -->|Async| E[Thread Yields]
</span><span>    E --> F[Test Continues]
</span><span>    F --> G[GateOpener.open]
</span><span>    G --> H[Channel Send]
</span><span>    H --> I[Receive Completes]
</span><span>    I --> J[Read Continues]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ol><li><p><code>crates/bevy_asset/Cargo.toml</code></p> <ul><li>Added <code>async-channel</code> as dev-dependency</ul> <pre class=language-toml data-lang=toml style=color:#61676c;background-color:#fafafa><code class=language-toml data-lang=toml><span>[</span><span style=color:#399ee6>dev-dependencies</span><span>]
</span><span style=color:#399ee6>async-channel </span><span>= </span><span style=color:#86b300>"2"
</span></code></pre><li><p><code>crates/bevy_asset/src/io/gated.rs</code></p> <ul><li>Replaced crossbeam_channel with async_channel<li>Converted blocking recv to async await</ul> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>use </span><span>crossbeam_channel</span><span style=color:#ed9366>::</span><span>{Receiver</span><span style=color:#61676ccc>,</span><span> Sender}</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>receiver</span><span style=color:#ed9366>.</span><span style=color:#f07171>recv</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>use </span><span>async_channel</span><span style=color:#ed9366>::</span><span>{Receiver</span><span style=color:#61676ccc>,</span><span> Sender}</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>receiver</span><span style=color:#ed9366>.</span><span style=color:#f07171>recv</span><span>()</span><span style=color:#ed9366>.</span><span>await</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><li><p><code>crates/bevy_asset/src/io/mod.rs</code></p> <ul><li>Made gated module test-only</ul> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub mod </span><span style=color:#399ee6>gated</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(test)]
</span><span style=color:#fa6e32>pub mod </span><span style=color:#399ee6>gated</span><span style=color:#61676ccc>;
</span></code></pre><li><p><code>crates/bevy_asset/src/lib.rs</code></p> <ul><li>Removed multi-threading requirement checks</ul> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Removed from 5 test cases:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(</span><span style=color:#f29718>not</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"multi_threaded"</span><span>))]
</span><span style=color:#f07171>panic!</span><span>(</span><span style=color:#86b300>"This test requires..."</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><li><p><code>release-content/migration-guides/gated_reader.md</code></p> <ul><li>Added migration note about private API</ul> <pre class=language-markdown data-lang=markdown style=color:#61676c;background-color:#fafafa><code class=language-markdown data-lang=markdown><span>The </span><span style=color:#ed9366;background-color:#61676c10>`GatedReader`</span><span> and </span><span style=color:#ed9366;background-color:#61676c10>`GatedOpener`</span><span>... have been made private.
</span></code></pre></ol><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/async-channel/latest/async_channel/ target=_blank>async-channel documentation</a> - Understanding the async channel implementation<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/getting-started/async/ target=_blank>Bevy Async Tasks</a> - Context for async patterns in Bevy<li><a rel="noopener nofollow noreferrer" href=https://rust-lang.github.io/async-book/ target=_blank>Rust Async Book</a> - Fundamental async programming concepts</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-08/pr_18473.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>