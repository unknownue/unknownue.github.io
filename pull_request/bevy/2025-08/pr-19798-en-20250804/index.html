<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19798 Move bevy_mikktspace out of tree
        
    </title><meta content="#19798 Move bevy_mikktspace out of tree" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-08/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-08-04</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-08/pr-19798-zh-cn-20250804>中文</a></div></div><div class=pr-content><h1 id=analysis-of-pr-19798-move-bevy-mikktspace-out-of-tree>Analysis of PR #19798: Move bevy_mikktspace out of tree</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Move bevy_mikktspace out of tree<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19798<li><strong>Author</strong>: atlv24<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, C-Dependencies, C-Code-Quality, S-Ready-For-Final-Review, A-Math, P-Unsound, X-Blessed, D-Unsafe<li><strong>Created</strong>: 2025-06-24T08:01:41Z<li><strong>Merged</strong>: 2025-08-04T17:35:58Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><pre style=color:#61676c;background-color:#fafafa><code><span># Objective
</span><span>
</span><span>- Have safe bevy_mikktspace by landing #9050
</span><span>- Don't have C in-tree
</span><span>
</span><span>Related issues and PRs:
</span><span>
</span><span>- Closes #9050
</span><span>- Closes #8429 
</span><span>- Fixes #7372
</span><span>
</span><span>## Solution
</span><span>
</span><span>- Rebase to main
</span><span>- Remove glam dependency so lock-step update is not necessary anymore
</span><span>- Make it standalone: https://github.com/atlv24/bevy_mikktspace
</span><span>- Transfer to bevy org
</span><span>
</span><span>## Testing
</span><span>
</span><span>- Test suite made by Layl
</span></code></pre><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses two main issues: improving code safety by landing a safe Rust implementation of the Mikkelsen tangent space algorithm (#9050), and removing C code from Bevy’s main repository. The tangent space generation is essential for normal mapping in rendering, but the original implementation contained unsafe C code that was challenging to maintain and update.<p>The solution involved extracting the <code>bevy_mikktspace</code> crate from Bevy’s main repository and making it a standalone library. This extraction allowed the removal of the <code>glam</code> dependency, eliminating the need for lock-step version updates between the math library and Bevy. The crate was moved to a new repository under the Bevy organization (https://github.com/atlv24/bevy_mikktspace) where it can be maintained independently.<p>During the implementation, several key changes were made to integrate the standalone crate:<ol><li>The <code>bevy_mesh</code> crate was updated to depend on the external <code>bevy_mikktspace</code> crate instead of the in-tree version<li>The tangent generation API in <code>bevy_mesh</code> was modified to match the updated interface from the standalone crate<li>The entire <code>bevy_mikktspace</code> directory and its contents were removed from Bevy’s repository</ol><p>The API change in <code>bevy_mesh</code> is particularly important. The <code>set_tangent_encoded</code> method was replaced with a more flexible <code>set_tangent</code> method that better handles tangent space calculations:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>set_tangent_encoded</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>tangent</span><span style=color:#61676ccc>:</span><span> [</span><span style=color:#fa6e32>f32</span><span>; 4], </span><span style=color:#ff8f40>face</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize</span><span>, </span><span style=color:#ff8f40>vert</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize</span><span>)
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>set_tangent</span><span>(
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>,
</span><span>    </span><span style=color:#ff8f40>tangent_space</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTbevy_mikktspace</span><span style=color:#ed9366>::</span><span>TangentSpace>,
</span><span>    </span><span style=color:#ff8f40>face</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize</span><span>,
</span><span>    </span><span style=color:#ff8f40>vert</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize</span><span>,
</span><span>)
</span></code></pre><p>This change provides more explicit control over tangent space generation and improves error handling by converting the previous boolean return value to a proper <code>Result</code> type. The error handling was also enhanced in the tangent generation process:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> success </span><span style=color:#ed9366>= </span><span>bevy_mikktspace</span><span style=color:#ed9366>::</span><span>generate_tangents(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> mikktspace_mesh)</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>success {
</span><span>    </span><span style=color:#fa6e32>return </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(GenerateTangentsError</span><span style=color:#ed9366>::</span><span>MikktspaceError)</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>bevy_mikktspace</span><span style=color:#ed9366>::</span><span>generate_tangents(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> mikktspace_mesh)</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span></code></pre><p>The extraction of <code>bevy_mikktspace</code> significantly cleans up Bevy’s dependency tree and codebase. By removing over 3,000 lines of code (mostly generated C-to-Rust bindings), the PR reduces maintenance overhead and potential security risks from unsafe code. The standalone crate can now evolve independently with its own release cycle, versioning, and documentation.<p>Testing was ensured through the existing test suite created by Layl, which verifies the correctness of the tangent generation algorithm. The changes maintain backward compatibility in the generated tangents while improving the safety and maintainability of the code.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[bevy_mesh] --> B[bevy_mikktspace]
</span><span>    B --> C[External Dependency]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ol><li><p><code>crates/bevy_mesh/Cargo.toml</code></p> <ul><li>Updated dependency to external crate</ul> <pre class=language-toml data-lang=toml style=color:#61676c;background-color:#fafafa><code class=language-toml data-lang=toml><span style=color:#abb0b6;font-style:italic># Before:
</span><span style=color:#399ee6>bevy_mikktspace </span><span>= { </span><span style=color:#399ee6>path </span><span>= </span><span style=color:#86b300>"../bevy_mikktspace"</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>version </span><span>= </span><span style=color:#86b300>"0.17.0-dev" </span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic># After:
</span><span style=color:#399ee6>bevy_mikktspace </span><span>= { </span><span style=color:#399ee6>version </span><span>= </span><span style=color:#86b300>"0.17.0-dev" </span><span>}
</span></code></pre><li><p><code>crates/bevy_mesh/src/mikktspace.rs</code></p> <ul><li>Updated API usage to match new crate interface</ul> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>set_tangent_encoded</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>tangent</span><span style=color:#61676ccc>:</span><span> [</span><span style=color:#fa6e32>f32</span><span>; 4], </span><span style=color:#ff8f40>face</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize</span><span>, </span><span style=color:#ff8f40>vert</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize</span><span>) {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>tangents[idx] </span><span style=color:#ed9366>=</span><span> tangent</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>set_tangent</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>tangent_space</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTbevy_mikktspace</span><span style=color:#ed9366>::</span><span>TangentSpace>, </span><span style=color:#ff8f40>face</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize</span><span>, </span><span style=color:#ff8f40>vert</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize</span><span>) {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>tangents[idx] </span><span style=color:#ed9366>=</span><span> tangent_space</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_or_default</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>tangent_encoded</span><span>()</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Error handling simplified
</span><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>success {
</span><span>    </span><span style=color:#fa6e32>return </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(GenerateTangentsError</span><span style=color:#ed9366>::</span><span>MikktspaceError)</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>bevy_mikktspace</span><span style=color:#ed9366>::</span><span>generate_tangents(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> mikktspace_mesh)</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span></code></pre><li><p><code>crates/bevy_mikktspace/**</code> (removed)</p> <ul><li>Entire crate removed from repository including: <ul><li>Generated Rust bindings (<code>src/generated.rs</code>)<li>Regression tests (<code>tests/regression_test.rs</code>)<li>Example code (<code>examples/generate.rs</code>)<li>License files<li>Asset files (<code>examples/cube.obj</code>)</ul></ul></ol><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=http://www.mikktspace.com/ target=_blank>Mikkelsen Tangent Space Algorithm</a> - Original algorithm specification<li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_mesh/latest/bevy_mesh/ target=_blank>Bevy’s Mesh Documentation</a> - Details on Bevy’s mesh system<li><a rel="noopener nofollow noreferrer" href=https://learnopengl.com/Advanced-Lighting/Normal-Mapping target=_blank>Tangent Space Normal Maps</a> - Practical explanation of normal mapping techniques<li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/nomicon/ target=_blank>Rust Safety Guidelines</a> - Understanding unsafe code practices in Rust</ol><p>The extraction of <code>bevy_mikktspace</code> demonstrates a healthy approach to dependency management in large projects. By isolating specialized functionality into separate crates, Bevy maintains a cleaner codebase while allowing domain-specific components to evolve at their own pace. This pattern could be applied to other specialized subsystems in the engine.</div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-08/pr_19798.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>