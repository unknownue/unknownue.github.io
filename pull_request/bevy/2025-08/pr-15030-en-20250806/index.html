<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #15030
        
    </title><meta content=#15030 property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-08/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-08-06</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-08/pr-15030-zh-cn-20250806>中文</a></div></div><div class=pr-content><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=the-problem-and-context>The Problem and Context</h3><p>Before this PR, Bevy’s reflection system required developers to manually register every top-level type that derived the <code>Reflect</code> trait. While nested types were automatically registered via #5781, forgetting to call <code>app.register_type::&LTT>()</code> for root types remained a common source of runtime errors. This was particularly problematic during rapid prototyping and when using tools like the inspector, where missing registration would silently break reflection capabilities. The manual process added cognitive overhead and was error-prone in larger codebases.<h3 id=the-solution-approach>The Solution Approach</h3><p>This PR introduces automatic compile-time registration for non-generic types deriving <code>Reflect</code>. The implementation provides two pathways:<ol><li><strong>Default inventory-based approach</strong>: Uses the <code>inventory</code> crate for platforms it supports (Linux/macOS/Windows/WebAssembly/etc.) to collect type registrations at compile time.<li><strong>Static fallback</strong>: For unsupported platforms, writes registration function names to disk during compilation, then loads them via a macro (<code>load_type_registrations!</code>) at runtime.</ol><p>Key engineering decisions:<ul><li>Opt-out mechanism via <code>#[reflect(no_auto_register)]</code> attribute<li>Minimal runtime overhead by leveraging compile-time registration<li>Preserve existing manual registration APIs<li>Platform-agnostic fallback to ensure broad compatibility</ul><h3 id=the-implementation>The Implementation</h3><p>The core changes extend Bevy’s reflection infrastructure:<ol><li><strong>TypeRegistry extensions</strong>:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added to TypeRegistry
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"auto_register"</span><span>)]
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>register_derived_types</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>) {
</span><span>    </span><span style=color:#fa6e32>crate</span><span style=color:#ed9366>::</span><span>__macro_exports</span><span style=color:#ed9366>::</span><span>auto_register</span><span style=color:#ed9366>::</span><span>register_types(</span><span style=color:#55b4d4;font-style:italic>self</span><span>)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>This method triggers registration of all types collected during compilation.<ol start=2><li><strong>Derive macro enhancements</strong>:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// In container_attributes parsing
</span><span>} </span><span style=color:#fa6e32>else if</span><span> lookahead</span><span style=color:#ed9366>.</span><span style=color:#f07171>peek</span><span>(kw</span><span style=color:#ed9366>::</span><span>no_auto_register) {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>parse_no_auto_register</span><span>(input)
</span></code></pre><p>The macro now generates registration code unless opted out. For static registration:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Static registration writes function names to disk
</span><span style=color:#fa6e32>let</span><span> export_name </span><span style=color:#ed9366>= </span><span style=color:#f07171>format!</span><span>(</span><span style=color:#86b300>"_bevy_reflect_register_</span><span style=color:#ff8f40>{}</span><span style=color:#86b300>"</span><span style=color:#61676ccc>, </span><span>uuid</span><span style=color:#ed9366>::</span><span>Uuid</span><span style=color:#ed9366>::</span><span>new_v4()</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_u128</span><span>())</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// ... writes to target/bevy_reflect_type_registrations
</span></code></pre><ol start=3><li><strong>App initialization integration</strong>:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// In app initialization
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"reflect_auto_register"</span><span>)]
</span><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_resource</span><span>(AppTypeRegistry</span><span style=color:#ed9366>::</span><span>new_with_derived_types())</span><span style=color:#61676ccc>;
</span></code></pre><p>Automatically registers types when the feature is enabled.<h3 id=technical-insights>Technical Insights</h3><ul><li><strong>Platform Compatibility</strong>: The dual-approach ensures coverage across all platforms. The static method uses UUIDs to avoid symbol collisions.<li><strong>Performance</strong>: Benchmarks show negligible startup impact (&LT40ms) but note WASM size increases (4.77-11.46%) due to including more type data. The actual overhead of auto-registration vs manual is minimal (0.2-0.64%).<li><strong>Generics Limitation</strong>: Automatic registration only works for concrete types. Generic types still require manual registration since their monomorphized forms can’t be known at compile time.<li><strong>Project Structure</strong>: The static approach requires separating type definitions from the macro invocation (typically via lib/bin separation) to ensure registration functions are generated before being collected.</ul><h3 id=the-impact>The Impact</h3><ul><li><strong>Ergonomics</strong>: Eliminates the most common reflection-related boilerplate and pitfalls.<li><strong>Safety</strong>: Reduces runtime errors from missing registrations.<li><strong>Flexibility</strong>: Opt-out attribute and fallback implementation accommodate diverse use cases.<li><strong>Documentation</strong>: Includes comprehensive examples (auto_register_static) and release notes.</ul><p>The solution maintains Bevy’s focus on ergonomics without compromising flexibility, though the WASM size tradeoffs warrant consideration for constrained environments.<pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Derive(Reflect)] --> B{Platform Support}
</span><span>    B -->|Supported| C[Inventory Registration]
</span><span>    B -->|Unsupported| D[Static Registration]
</span><span>    C --> E[Runtime TypeRegistry]
</span><span>    D --> F[File-based Collection]
</span><span>    F --> G[load_type_registrations! Macro]
</span><span>    G --> E
</span><span>    E --> H[Reflection System]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-reflect-src-type-registry-rs><code>crates/bevy_reflect/src/type_registry.rs</code></h3><ul><li><strong>Purpose</strong>: Add auto-registration entry point<li><strong>Key Change</strong>:</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"auto_register"</span><span>)]
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>register_derived_types</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>) {
</span><span>    </span><span style=color:#fa6e32>crate</span><span style=color:#ed9366>::</span><span>__macro_exports</span><span style=color:#ed9366>::</span><span>auto_register</span><span style=color:#ed9366>::</span><span>register_types(</span><span style=color:#55b4d4;font-style:italic>self</span><span>)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=crates-bevy-reflect-derive-src-impls-common-rs><code>crates/bevy_reflect/derive/src/impls/common.rs</code></h3><ul><li><strong>Purpose</strong>: Generate registration code in derive macro<li><strong>Key Addition</strong>:</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"auto_register"</span><span>)]
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>reflect_auto_registration</span><span>(</span><span style=color:#ff8f40>meta</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>ReflectMeta) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTproc_macro2</span><span style=color:#ed9366>::</span><span>TokenStream> {
</span><span>    </span><span style=color:#fa6e32>if</span><span> meta</span><span style=color:#ed9366>.</span><span style=color:#f07171>attrs</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>no_auto_register</span><span>() {
</span><span>        </span><span style=color:#fa6e32>return </span><span style=color:#55b4d4;font-style:italic>None</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... generates platform-specific registration code
</span></code></pre><h3 id=crates-bevy-reflect-derive-src-lib-rs><code>crates/bevy_reflect/derive/src/lib.rs</code></h3><ul><li><strong>Purpose</strong>: Implement static registration collector<li><strong>Key Addition</strong>:</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>proc_macro</span><span>]
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>load_type_registrations</span><span>(</span><span style=color:#ff8f40>_input</span><span style=color:#61676ccc>:</span><span> TokenStream) </span><span style=color:#61676ccc>-></span><span> TokenStream {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... reads generated registration functions from disk
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... generates code to register them at runtime
</span></code></pre><h3 id=examples-reflection-auto-register-static-src-lib-rs><code>examples/reflection/auto_register_static/src/lib.rs</code></h3><ul><li><strong>Purpose</strong>: Demonstrate static registration setup<li><strong>Key Structure</strong>:</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Reflect)]
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>Struct </span><span>{ a</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>i32 </span><span>} </span><span style=color:#abb0b6;font-style:italic>// In lib crate
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Bin crate calls macro before app creation:
</span><span style=color:#f07171>load_type_registrations!</span><span>()</span><span style=color:#61676ccc>;
</span><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_plugins</span><span>(DefaultPlugins)</span><span style=color:#ed9366>.</span><span style=color:#f07171>run</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=release-content-release-notes-reflect-auto-registration-md><code>release-content/release-notes/reflect_auto_registration.md</code></h3><ul><li><strong>Purpose</strong>: Document feature for release<li><strong>Key Content</strong>:</ul><pre class=language-markdown data-lang=markdown style=color:#61676c;background-color:#fafafa><code class=language-markdown data-lang=markdown><span style=color:#fa6e32;font-weight:700>## </span><span style=color:#399ee6;font-weight:700>Automatic </span><span style=color:#ed9366;background-color:#61676c10;font-weight:700>`Reflect`</span><span style=color:#399ee6;font-weight:700> registration
</span><span>Deriving </span><span style=color:#ed9366;background-color:#61676c10>`Reflect`</span><span> now auto-registers non-generic types. Opt-out with:
</span><span style=color:#ed9366;background-color:#61676c10>`#[reflect(no_auto_register)]`</span><span>
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/reflect/index.html target=_blank>Bevy Reflection Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/dtolnay/inventory target=_blank><code>inventory</code> Crate Details</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/tree/main/examples/reflection/auto_register_static target=_blank>Static Registration Example</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-08/pr_15030.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>