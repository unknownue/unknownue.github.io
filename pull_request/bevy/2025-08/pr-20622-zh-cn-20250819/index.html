<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20622 Tweak Solari world cache
        
    </title><meta content="#20622 Tweak Solari world cache" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-08/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-08-19</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2025-08/pr-20622-en-20250819>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=tweak-solari-world-cache>Tweak Solari world cache</h1><h2 id=ji-ben-xin-xi>基本信息</h2><ul><li><strong>标题</strong>: Tweak Solari world cache<li><strong>PR链接</strong>: https://github.com/bevyengine/bevy/pull/20622<li><strong>作者</strong>: JMS55<li><strong>状态</strong>: 已合并<li><strong>标签</strong>: A-Rendering, S-Ready-For-Final-Review, C-Refinement<li><strong>创建时间</strong>: 2025-08-17T17:23:26Z<li><strong>合并时间</strong>: 2025-08-19T17:49:41Z<li><strong>合并者</strong>: alice-i-cecile</ul><h2 id=miao-shu-fan-yi>描述翻译</h2><h1 id=objective-mu-biao>Objective (目标)</h1><ul><li>使世界缓存对光照变化更敏感<li>使世界缓存的LOD切换更慢，让过渡不那么明显<li>减小基础单元大小以改善近处光照效果</ul><h2 id=zhe-ge-prde-gu-shi>这个PR的故事</h2><p>这个PR主要优化了Bevy Solari模块中的世界缓存系统。Solari是Bevy的实时光线追踪全局光照系统，世界缓存是其核心组件之一，用于存储和复用光照计算的结果。<p><strong>问题背景</strong> 原来的世界缓存在几个方面存在不足：对光照变化的响应不够及时，LOD（细节级别）切换过于明显，以及近处光照的分辨率不够高。这些都会影响最终渲染的质量和视觉连贯性。<p><strong>解决方案</strong> 开发者通过调整三个关键参数来解决这些问题：<ol><li>降低 <code>WORLD_CACHE_MAX_TEMPORAL_SAMPLES</code> 从30.0到10.0，使缓存对光照变化更敏感<li>减小 <code>WORLD_CACHE_POSITION_BASE_CELL_SIZE</code> 从0.4到0.25，提高近处光照的分辨率<li>引入新的 <code>WORLD_CACHE_POSITION_LOD_SCALE</code> 参数控制LOD过渡速度</ol><p><strong>技术实现</strong> 核心的变化在于位置量化函数的重构。原来的代码将位置量化和LOD计算耦合在一起：<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// 之前的方法
</span><span>fn quantize_position(world_position: vec3&LTf32>, view_position: vec3&LTf32>) -> vec3&LTf32> {
</span><span>    let base_size = WORLD_CACHE_POSITION_BASE_CELL_SIZE;
</span><span>    let d = distance(view_position, world_position);
</span><span>    let step = max((d * base_size) / 7.0, base_size);
</span><span>    let quantization_factor = exp2(floor(log2(step)));
</span><span>    
</span><span>    return floor(world_position / quantization_factor + 0.0001);
</span><span>}
</span></code></pre><p>重构后分离了单元大小计算和位置量化：<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// 新的方法
</span><span>fn get_cell_size(world_position: vec3&LTf32>, view_position: vec3&LTf32>) -> f32 {
</span><span>    let camera_distance = distance(view_position, world_position) / WORLD_CACHE_POSITION_LOD_SCALE;
</span><span>    let lod = exp2(floor(log2(1.0 + camera_distance)));
</span><span>    return WORLD_CACHE_POSITION_BASE_CELL_SIZE * lod;
</span><span>}
</span><span>
</span><span>fn quantize_position(world_position: vec3&LTf32>, quantization_factor: f32) -> vec3&LTf32> {
</span><span>    return floor(world_position / quantization_factor + 0.0001);
</span><span>}
</span></code></pre><p>这种重构使得LOD计算更加清晰和可控，新的LOD_SCALE参数允许精确调整LOD过渡的速度。<p><strong>影响与收益</strong> 这些调整带来了明显的视觉改进：<ul><li>光照变化更快地反映在缓存中，减少了延迟感<li>LOD过渡更加平滑，减少了突兀的细节级别变化<li>近处光照质量提高，因为使用了更小的缓存单元</ul><p>调试功能也得到了增强，添加了 <code>VISUALIZE_WORLD_CACHE</code> 宏来直接可视化缓存内容，便于开发和调试。<h2 id=ke-shi-hua-biao-shi>可视化表示</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[World Cache Query] --> B[get_cell_size]
</span><span>    B --> C[calculate LOD based on distance]
</span><span>    A --> D[quantize_position]
</span><span>    D --> E[use cell_size for quantization]
</span><span>    A --> F[compute cache key]
</span><span>    F --> G[query cache data]
</span></code></pre><h2 id=guan-jian-wen-jian-bian-geng>关键文件变更</h2><h3 id=crates-bevy-solari-src-realtime-world-cache-query-wgsl-14-11><code>crates/bevy_solari/src/realtime/world_cache_query.wgsl</code> (+14/-11)</h3><p>核心的世界缓存查询逻辑修改，重构了位置量化函数并调整了关键参数。<p><strong>主要变更：</strong><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// 之前：
</span><span>const WORLD_CACHE_MAX_TEMPORAL_SAMPLES: f32 = 30.0;
</span><span>const WORLD_CACHE_POSITION_BASE_CELL_SIZE: f32 = 0.4;
</span><span>
</span><span>// 之后：
</span><span>const WORLD_CACHE_MAX_TEMPORAL_SAMPLES: f32 = 10.0;
</span><span>const WORLD_CACHE_POSITION_BASE_CELL_SIZE: f32 = 0.25;
</span><span>const WORLD_CACHE_POSITION_LOD_SCALE: f32 = 30.0;
</span></code></pre><p><strong>函数重构：</strong><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// 之前单一的量化函数
</span><span>fn quantize_position(world_position: vec3&LTf32>, view_position: vec3&LTf32>) -> vec3&LTf32> {
</span><span>    let base_size = WORLD_CACHE_POSITION_BASE_CELL_SIZE;
</span><span>    let d = distance(view_position, world_position);
</span><span>    let step = max((d * base_size) / 7.0, base_size);
</span><span>    let quantization_factor = exp2(floor(log2(step)));
</span><span>    
</span><span>    return floor(world_position / quantization_factor + 0.0001);
</span><span>}
</span><span>
</span><span>// 之后分离的函数
</span><span>fn get_cell_size(world_position: vec3&LTf32>, view_position: vec3&LTf32>) -> f32 {
</span><span>    let camera_distance = distance(view_position, world_position) / WORLD_CACHE_POSITION_LOD_SCALE;
</span><span>    let lod = exp2(floor(log2(1.0 + camera_distance)));
</span><span>    return WORLD_CACHE_POSITION_BASE_CELL_SIZE * lod;
</span><span>}
</span><span>
</span><span>fn quantize_position(world_position: vec3&LTf32>, quantization_factor: f32) -> vec3&LTf32> {
</span><span>    return floor(world_position / quantization_factor + 0.0001);
</span><span>}
</span></code></pre><h3 id=crates-bevy-solari-src-realtime-restir-gi-wgsl-4-1><code>crates/bevy_solari/src/realtime/restir_gi.wgsl</code> (+4/-1)</h3><p>添加了世界缓存可视化调试功能。<p><strong>主要变更：</strong><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// 添加了调试可视化功能
</span><span>#ifdef VISUALIZE_WORLD_CACHE
</span><span>    textureStore(view_output, global_id.xy, vec4(query_world_cache(world_position, world_normal, view.world_position) * view.exposure, 1.0));
</span><span>#endif
</span></code></pre><h3 id=release-content-release-notes-bevy-solari-md-1-1><code>release-content/release-notes/bevy_solari.md</code> (+1/-1)</h3><p>更新发布说明，包含这个PR的引用。<h2 id=yan-shen-yue-du>延伸阅读</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/tree/main/crates/bevy_solari target=_blank>Bevy Solari 项目</a> - Solari模块的源代码<li><a rel="noopener nofollow noreferrer" href=https://research.nvidia.com/publication/2020-07_restir-gi-path-resampling-real-time-path-tracing target=_blank>ReSTIR GI 论文</a> - 相关的实时路径追踪技术<li><a rel="noopener nofollow noreferrer" href=https://gpuweb.github.io/gpuweb/wgsl/ target=_blank>WGSL 语言规范</a> - WebGPU着色语言的官方文档</ul><h2 id=wan-zheng-dai-ma-chai-yi>完整代码差异</h2><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_solari/src/realtime/restir_gi.wgsl b/crates/bevy_solari/src/realtime/restir_gi.wgsl
</span><span>index f98546e96b40e..66ececed93a16 100644
</span><span style=color:#c594c5>--- a/crates/bevy_solari/src/realtime/restir_gi.wgsl
</span><span style=color:#c594c5>+++ b/crates/bevy_solari/src/realtime/restir_gi.wgsl
</span><span style=color:#c594c5>@@ -3,7 +3,6 @@
</span><span> #import bevy_core_pipeline::tonemapping::tonemapping_luminance as luminance
</span><span> #import bevy_pbr::pbr_deferred_types::unpack_24bit_normal
</span><span> #import bevy_pbr::prepass_bindings::PreviousViewUniforms
</span><span style=color:#f07171>-#import bevy_pbr::rgb9e5::rgb9e5_to_vec3_
</span><span> #import bevy_pbr::utils::{rand_f, sample_uniform_hemisphere, uniform_hemisphere_inverse_pdf, sample_disk, octahedral_decode}
</span><span> #import bevy_render::maths::PI
</span><span> #import bevy_render::view::View
</span><span style=color:#c594c5>@@ -82,6 +81,10 @@ </span><span style=color:#399ee6>fn spatial_and_shade(@builtin(global_invocation_id) global_id: vec3&LTu32>) {
</span><span>     var pixel_color = textureLoad(view_output, global_id.xy);
</span><span>     pixel_color += vec4(merge_result.selected_sample_radiance * combined_reservoir.unbiased_contribution_weight * view.exposure, 0.0);
</span><span>     textureStore(view_output, global_id.xy, pixel_color);
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+#ifdef VISUALIZE_WORLD_CACHE
</span><span style=color:#86b300>+    textureStore(view_output, global_id.xy, vec4(query_world_cache(world_position, world_normal, view.world_position) * view.exposure, 1.0));
</span><span style=color:#86b300>+#endif
</span><span> }
</span><span> 
</span><span> fn generate_initial_reservoir(world_position: vec3&LTf32>, world_normal: vec3&LTf32>, rng: ptr&LTfunction, u32>) -> Reservoir {
</span><span>diff --git a/crates/bevy_solari/src/realtime/world_cache_query.wgsl b/crates/bevy_solari/src/realtime/world_cache_query.wgsl
</span><span>index b30900160c7d1..ecf9a0892906b 100644
</span><span style=color:#c594c5>--- a/crates/bevy_solari/src/realtime/world_cache_query.wgsl
</span><span style=color:#c594c5>+++ b/crates/bevy_solari/src/realtime/world_cache_query.wgsl
</span><span style=color:#c594c5>@@ -1,14 +1,16 @@
</span><span> #define_import_path bevy_solari::world_cache
</span><span> 
</span><span style=color:#f07171>-/// Controls how response the world cache is to changes in lighting
</span><span style=color:#f07171>-const WORLD_CACHE_MAX_TEMPORAL_SAMPLES: f32 = 30.0;
</span><span style=color:#86b300>+/// How responsive the world cache is to changes in lighting (higher is less responsive, lower is more responsive)
</span><span style=color:#86b300>+const WORLD_CACHE_MAX_TEMPORAL_SAMPLES: f32 = 10.0;
</span><span> /// Maximum amount of frames a cell can live for without being queried
</span><span> const WORLD_CACHE_CELL_LIFETIME: u32 = 30u;
</span><span> /// Maximum amount of attempts to find a cache entry after a hash collision
</span><span> const WORLD_CACHE_MAX_SEARCH_STEPS: u32 = 3u;
</span><span> 
</span><span style=color:#f07171>-/// Controls the base size of each cache cell
</span><span style=color:#f07171>-const WORLD_CACHE_POSITION_BASE_CELL_SIZE: f32 = 0.4;
</span><span style=color:#86b300>+/// The size of a cache cell at the lowest LOD in meters
</span><span style=color:#86b300>+const WORLD_CACHE_POSITION_BASE_CELL_SIZE: f32 = 0.25;
</span><span style=color:#86b300>+/// How fast the world cache transitions between LODs as a function of distance to the camera
</span><span style=color:#86b300>+const WORLD_CACHE_POSITION_LOD_SCALE: f32 = 30.0;
</span><span> 
</span><span> /// Marker value for an empty cell
</span><span> const WORLD_CACHE_EMPTY_CELL: u32 = 0u;
</span><span style=color:#c594c5>@@ -36,9 +38,9 @@ </span><span style=color:#399ee6>struct WorldCacheGeometryData {
</span><span> 
</span><span> #ifndef WORLD_CACHE_NON_ATOMIC_LIFE_BUFFER
</span><span> fn query_world_cache(world_position: vec3&LTf32>, world_normal: vec3&LTf32>, view_position: vec3&LTf32>) -> vec3&LTf32> {
</span><span style=color:#f07171>-    let world_position_quantized = bitcast&LTvec3&LTu32>>(quantize_position(world_position, view_position));
</span><span style=color:#86b300>+    let cell_size = get_cell_size(world_position, view_position);
</span><span style=color:#86b300>+    let world_position_quantized = bitcast&LTvec3&LTu32>>(quantize_position(world_position, cell_size));
</span><span>     let world_normal_quantized = bitcast&LTvec3&LTu32>>(quantize_normal(world_normal));
</span><span style=color:#f07171>-
</span><span>     var key = compute_key(world_position_quantized, world_normal_quantized);
</span><span>     let checksum = compute_checksum(world_position_quantized, world_normal_quantized);
</span><span> 
</span><span style=color:#c594c5>@@ -64,12 +66,13 @@ </span><span style=color:#399ee6>fn query_world_cache(world_position: vec3&LTf32>, world_normal: vec3&LTf32>, view_po
</span><span> }
</span><span> #endif
</span><span> 
</span><span style=color:#f07171>-fn quantize_position(world_position: vec3&LTf32>, view_position: vec3&LTf32>) -> vec3&LTf32> {
</span><span style=color:#f07171>-    let base_size = WORLD_CACHE_POSITION_BASE_CELL_SIZE;
</span><span style=color:#f07171>-    let d = distance(view_position, world_position);
</span><span style=color:#f07171>-    let step = max((d * base_size) / 7.0, base_size);
</span><span style=color:#f07171>-    let quantization_factor = exp2(floor(log2(step)));
</span><span style=color:#86b300>+fn get_cell_size(world_position: vec3&LTf32>, view_position: vec3&LTf32>) -> f32 {
</span><span style=color:#86b300>+    let camera_distance = distance(view_position, world_position) / WORLD_CACHE_POSITION_LOD_SCALE;
</span><span style=color:#86b300>+    let lod = exp2(floor(log2(1.0 + camera_distance)));
</span><span style=color:#86b300>+    return WORLD_CACHE_POSITION_BASE_CELL_SIZE * lod;
</span><span style=color:#86b300>+}
</span><span> 
</span><span style=color:#86b300>+fn quantize_position(world_position: vec3&LTf32>, quantization_factor: f32) -> vec3&LTf32> {
</span><span>     return floor(world_position / quantization_factor + 0.0001);
</span><span> }
</span><span> 
</span><span>diff --git a/release-content/release-notes/bevy_solari.md b/release-content/release-notes/bevy_solari.md
</span><span>index cfe89f6576927..1ab28542a473c 100644
</span><span style=color:#c594c5>--- a/release-content/release-notes/bevy_solari.md
</span><span style=color:#c594c5>+++ b/release-content/release-notes/bevy_solari.md
</span><span style=color:#c594c5>@@ -1,7 +1,7 @@
</span><span> ---
</span><span> title: Initial raytraced lighting progress (bevy_solari)
</span><span> authors: ["@JMS55", "@SparkyPotato"]
</span><span style=color:#f07171>-pull_requests: [19058, 19620, 19790, 20020, 20113, 20156, 20213, 20242, 20259, 20406, 20457, 20580, 20596]
</span><span style=color:#86b300>+pull_requests: [19058, 19620, 19790, 20020, 20113, 20156, 20213, 20242, 20259, 20406, 20457, 20580, 20596, 20622]
</span><span> ---
</span><span> 
</span><span> ## Overview
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-08/pr_20622.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>