<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20712 use affine inverse in cluster
        
    </title><meta content="#20712 use affine inverse in cluster" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-08/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-08-22</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-08/pr-20712-zh-cn-20250822>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>Performance Optimization: Using Affine Inverse in Cluster Assignment<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: use affine inverse in cluster<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20712<li><strong>Author</strong>: atlv24<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering<li><strong>Created</strong>: 2025-08-22T08:50:37Z<li><strong>Merged</strong>: 2025-08-22T21:35:47Z<li><strong>Merged By</strong>: james7132</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Avoid using expensive matrix4 inverse operations</ul><h2 id=solution>Solution</h2><ul><li>Use more efficient affine inverse operations instead</ul><h2 id=testing>Testing</h2><ul><li>Tested with clustered decals example</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a performance optimization in Bevy’s rendering system, specifically in the cluster assignment logic for lights and decals. The core issue was in the matrix inversion operation used to compute the view-from-world transformation matrix.<p>In the original implementation, the code was using a full 4x4 matrix inversion (<code>Mat4::inverse()</code>) which is computationally expensive. Since camera transformations in Bevy are always affine transformations (composed of translation, rotation, and uniform scaling), the developer recognized that a more efficient affine inverse operation could be used instead.<p>The solution replaces two key operations:<ol><li><code>camera_transform.to_matrix()</code> with <code>camera_transform.affine()</code> to get an affine representation<li><code>world_from_view.inverse()</code> with <code>Mat4::from(world_from_view.inverse())</code> to use the affine inverse</ol><p>This change is particularly impactful because cluster assignment runs for every frame and affects how lights and decals are distributed across screen space clusters. The affine inverse operation is significantly faster than a general matrix inverse because it leverages the mathematical properties of affine transformations, avoiding unnecessary computations for the perspective components that don’t exist in camera transforms.<p>The optimization maintains identical mathematical results while reducing computational overhead. This is a classic example of using mathematical domain knowledge (knowing that camera transforms are always affine) to achieve performance gains without changing functionality.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Camera Transform] --> B[Extract Affine Representation]
</span><span>    B --> C[Compute Affine Inverse]
</span><span>    C --> D[Convert to Mat4]
</span><span>    D --> E[View-from-World Matrix]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-light-src-cluster-assign-rs><code>crates/bevy_light/src/cluster/assign.rs</code></h3><p>This file contains the cluster assignment logic for lights and decals. The changes optimize the matrix inversion operation used in view transformation calculations.<p><strong>Key modifications:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> world_from_view </span><span style=color:#ed9366>=</span><span> camera_transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_matrix</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// ...
</span><span style=color:#fa6e32>let</span><span> view_from_world </span><span style=color:#ed9366>=</span><span> world_from_view</span><span style=color:#ed9366>.</span><span style=color:#f07171>inverse</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> world_from_view </span><span style=color:#ed9366>=</span><span> camera_transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>affine</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// ...
</span><span style=color:#fa6e32>let</span><span> view_from_world </span><span style=color:#ed9366>= </span><span>Mat4</span><span style=color:#ed9366>::</span><span>from(world_from_view</span><span style=color:#ed9366>.</span><span style=color:#f07171>inverse</span><span>())</span><span style=color:#61676ccc>;
</span></code></pre><p>The changes replace the full 4x4 matrix operations with more efficient affine operations, maintaining the same mathematical result but with better performance.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Affine_transformation target=_blank>Affine transformation</a> - Wikipedia article on affine transformations<li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Invertible_matrix target=_blank>Matrix inversion</a> - Mathematical background on matrix inversion<li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/transform/components/struct.Transform.html target=_blank>Bevy Transform documentation</a> - Official Bevy documentation on Transform components</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-08/pr_20712.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>