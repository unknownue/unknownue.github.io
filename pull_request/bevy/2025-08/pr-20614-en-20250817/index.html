<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20614 Use boxed storage for material erasure.
        
    </title><meta content="#20614 Use boxed storage for material erasure." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-08/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-08-17</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-08/pr-20614-zh-cn-20250817>中文</a></div></div><div class=pr-content><h1 id=analysis-of-pr-20614-use-boxed-storage-for-material-erasure>Analysis of PR #20614: Use boxed storage for material erasure</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Use boxed storage for material erasure.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20614<li><strong>Author</strong>: tychedelia<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, C-Usability, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-08-17T01:12:24Z<li><strong>Merged</strong>: 2025-08-17T16:57:23Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>#19667 added a <code>bytemuck::Pod</code> type constraint on <code>AsBindGroup::Data</code> which, while technically a reasonable constraint to expect from material keys, imposed a breaking change on our users which may be confusing / difficult for them to work around. It’s not technically invalid to store arbitrary types in a material key, just probably bad practice.<p>Additionally, the performance concerns here were probably overstated: 1. cold specialization makes re-specialization less likely. 2. we can mitigate going through the vtable unnecessarily by pre-computing our hash which should still make the boxed storage fast in almost all cases where we don’t get a collision.<h2 id=solution>Solution</h2><p>Use <code>Box&LTdyn Any></code> for erasure.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a breaking change introduced by #19667, which added a <code>bytemuck::Pod</code> constraint to material key types. While technically sound, this constraint proved problematic for users who needed more flexible material key implementations. The core issue was that <code>bytemuck::Pod</code> requires types to be plain old data with no padding or complex representations, limiting what developers could use as material keys.<p>The solution replaces the byte-based storage with type-erased boxed storage. Instead of requiring material keys to be POD types that can be serialized to bytes, we now store them as <code>Box&LTdyn Any></code> and handle comparison/hashing through a vtable. This maintains the necessary functionality while removing the restrictive constraint.<p>Key implementation details include:<ol><li>Creating <code>ErasedMaterialKey</code> to wrap type-erased material keys<li>Precomputing hashes at key creation time to optimize lookups<li>Using a vtable for dynamic dispatch of clone and comparison operations<li>Removing <code>bytemuck</code> constraints from all material-related traits and structs</ol><p>The new <code>ErasedMaterialKey</code> struct handles the type erasure:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Debug)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>ErasedMaterialKey </span><span>{
</span><span>    type_id</span><span style=color:#61676ccc>:</span><span> TypeId,
</span><span>    hash</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u64</span><span>,
</span><span>    value</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Box</span><span>&LTdyn Any </span><span style=color:#ed9366>+ </span><span style=color:#55b4d4;font-style:italic>Send </span><span style=color:#ed9366>+ </span><span style=color:#55b4d4;font-style:italic>Sync</span><span>>,
</span><span>    vtable</span><span style=color:#61676ccc>: </span><span>Arc&LTErasedMaterialKeyVTable>,
</span><span>}
</span></code></pre><p>The vtable contains function pointers for type-specific operations:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Debug)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>ErasedMaterialKeyVTable </span><span>{
</span><span>    clone_fn</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>fn</span><span>(</span><span style=color:#ed9366>&</span><span>dyn Any) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Box</span><span>&LTdyn Any </span><span style=color:#ed9366>+ </span><span style=color:#55b4d4;font-style:italic>Send </span><span style=color:#ed9366>+ </span><span style=color:#55b4d4;font-style:italic>Sync</span><span>>,
</span><span>    partial_eq_fn</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>fn</span><span>(</span><span style=color:#ed9366>&</span><span>dyn Any, </span><span style=color:#ed9366>&</span><span>dyn Any) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>bool</span><span>,
</span><span>}
</span></code></pre><p>Performance considerations were addressed by:<ul><li>Precomputing the hash during key creation<li>Storing the type ID for fast type checking<li>Using Arc for vtable sharing to reduce duplication</ul><p>This approach maintains the efficiency of material lookups while providing greater flexibility. The precomputed hash ensures that the vtable is only accessed for equality checks when hashes collide, which should be rare.<p>The PR also updates multiple examples to demonstrate the simpler material key definitions now possible. For instance, boolean flags in material keys no longer need to be represented as u32 values:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>repr</span><span>(C)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Eq</span><span style=color:#61676ccc>,</span><span> PartialEq</span><span style=color:#61676ccc>,</span><span> Hash</span><span style=color:#61676ccc>,</span><span> Copy</span><span style=color:#61676ccc>,</span><span> Clone</span><span style=color:#61676ccc>,</span><span> bytemuck::Pod</span><span style=color:#61676ccc>,</span><span> bytemuck::Zeroable)]
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>CustomMaterialKey </span><span>{
</span><span>    is_red</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u32</span><span>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>repr</span><span>(C)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Eq</span><span style=color:#61676ccc>,</span><span> PartialEq</span><span style=color:#61676ccc>,</span><span> Hash</span><span style=color:#61676ccc>,</span><span> Copy</span><span style=color:#61676ccc>,</span><span> Clone)]
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>CustomMaterialKey </span><span>{
</span><span>    is_red</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>bool</span><span>,
</span><span>}
</span></code></pre><p>This change simplifies material implementations and reduces potential errors from manual conversions.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Material Key] --> B[ErasedMaterialKey]
</span><span>    B --> C[TypeID]
</span><span>    B --> D[Precomputed Hash]
</span><span>    B --> E[Box&LTdyn Any>]
</span><span>    B --> F[VTable]
</span><span>    F --> G[Clone Function]
</span><span>    F --> H[Comparison Function]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-pbr-src-material-rs-91-8><code>crates/bevy_pbr/src/material.rs</code> (+91/-8)</h3><p>Core implementation of the material erasure system. Introduced <code>ErasedMaterialKey</code> and integrated it throughout the material system.<p>Key changes:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>ErasedMaterialPipelineKey </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>mesh_key</span><span style=color:#61676ccc>:</span><span> MeshPipelineKey,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>material_key</span><span style=color:#61676ccc>: </span><span>SmallVec<[</span><span style=color:#fa6e32>u8</span><span style=color:#61676ccc>; </span><span style=color:#ff8f40>8</span><span>]>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>type_id</span><span style=color:#61676ccc>:</span><span> TypeId,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>ErasedMaterialPipelineKey </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>mesh_key</span><span style=color:#61676ccc>:</span><span> MeshPipelineKey,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>material_key</span><span style=color:#61676ccc>:</span><span> ErasedMaterialKey,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>type_id</span><span style=color:#61676ccc>:</span><span> TypeId,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// New type definition:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Debug)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>ErasedMaterialKey </span><span>{
</span><span>    type_id</span><span style=color:#61676ccc>:</span><span> TypeId,
</span><span>    hash</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u64</span><span>,
</span><span>    value</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Box</span><span>&LTdyn Any </span><span style=color:#ed9366>+ </span><span style=color:#55b4d4;font-style:italic>Send </span><span style=color:#ed9366>+ </span><span style=color:#55b4d4;font-style:italic>Sync</span><span>>,
</span><span>    vtable</span><span style=color:#61676ccc>: </span><span>Arc&LTErasedMaterialKeyVTable>,
</span><span>}
</span></code></pre><h3 id=crates-bevy-render-src-render-resource-bind-group-rs-5-7><code>crates/bevy_render/src/render_resource/bind_group.rs</code> (+5/-7)</h3><p>Relaxed constraints on material data types in the <code>AsBindGroup</code> trait.<p>Key change:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub trait </span><span style=color:#399ee6>AsBindGroup </span><span>{
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Data</span><span style=color:#61676ccc>: </span><span>bytemuck</span><span style=color:#ed9366>::</span><span>Pod </span><span style=color:#ed9366>+ </span><span>bytemuck</span><span style=color:#ed9366>::</span><span>Zeroable </span><span style=color:#ed9366>+ </span><span style=color:#55b4d4;font-style:italic>Send </span><span style=color:#ed9366>+ </span><span style=color:#55b4d4;font-style:italic>Sync</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub trait </span><span style=color:#399ee6>AsBindGroup </span><span>{
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Data</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Send </span><span style=color:#ed9366>+ </span><span style=color:#55b4d4;font-style:italic>Sync</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>}
</span></code></pre><h3 id=examples-shader-shader-defs-rs-4-6><code>examples/shader/shader_defs.rs</code> (+4/-6)</h3><p>Updated example to use more natural boolean type in material key.<p>Key change:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>repr</span><span>(C)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Eq</span><span style=color:#61676ccc>,</span><span> PartialEq</span><span style=color:#61676ccc>,</span><span> Hash</span><span style=color:#61676ccc>,</span><span> Copy</span><span style=color:#61676ccc>,</span><span> Clone</span><span style=color:#61676ccc>,</span><span> bytemuck::Pod</span><span style=color:#61676ccc>,</span><span> bytemuck::Zeroable)]
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>CustomMaterialKey </span><span>{
</span><span>    is_red</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u32</span><span>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>repr</span><span>(C)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Eq</span><span style=color:#61676ccc>,</span><span> PartialEq</span><span style=color:#61676ccc>,</span><span> Hash</span><span style=color:#61676ccc>,</span><span> Copy</span><span style=color:#61676ccc>,</span><span> Clone)]
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>CustomMaterialKey </span><span>{
</span><span>    is_red</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>bool</span><span>,
</span><span>}
</span></code></pre><h3 id=examples-shader-shader-material-wesl-rs-4-4><code>examples/shader/shader_material_wesl.rs</code> (+4/-4)</h3><p>Similar update to another example material.<p>Key change:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>repr</span><span>(C)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Eq</span><span style=color:#61676ccc>,</span><span> PartialEq</span><span style=color:#61676ccc>,</span><span> Hash</span><span style=color:#61676ccc>,</span><span> Copy</span><span style=color:#61676ccc>,</span><span> Clone</span><span style=color:#61676ccc>,</span><span> bytemuck::Pod</span><span style=color:#61676ccc>,</span><span> bytemuck::Zeroable)]
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>CustomMaterialKey </span><span>{
</span><span>    party_mode</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u32</span><span>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>repr</span><span>(C)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Eq</span><span style=color:#61676ccc>,</span><span> PartialEq</span><span style=color:#61676ccc>,</span><span> Hash</span><span style=color:#61676ccc>,</span><span> Copy</span><span style=color:#61676ccc>,</span><span> Clone)]
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>CustomMaterialKey </span><span>{
</span><span>    party_mode</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>bool</span><span>,
</span><span>}
</span></code></pre><h3 id=crates-bevy-sprite-render-src-mesh2d-material-rs-2-2><code>crates/bevy_sprite_render/src/mesh2d/material.rs</code> (+2/-2)</h3><p>Minor updates to support the new material key type.<h2 id=further-reading>Further Reading</h2><ul><li>Rust <code>Any</code> trait documentation: https://doc.rust-lang.org/std/any/trait.Any.html<li>Bevy Material System: https://bevyengine.org/learn/book/getting-started/materials/<li>Type Erasure Patterns: https://www.cs.sjsu.edu/~pearce/oom/patterns/erasure.htm</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-08/pr_20614.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>