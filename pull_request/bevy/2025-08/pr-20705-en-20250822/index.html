<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20705 invert affine not mat4 in point_light
        
    </title><meta content="#20705 invert affine not mat4 in point_light" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-08/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-08-22</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-08/pr-20705-zh-cn-20250822>中文</a></div></div><div class=pr-content><h1 id=invert-affine-not-mat4-in-point-light>invert affine not mat4 in point_light</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: invert affine not mat4 in point_light<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20705<li><strong>Author</strong>: atlv24<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, A-Math<li><strong>Created</strong>: 2025-08-22T07:47:11Z<li><strong>Merged</strong>: 2025-08-22T21:29:23Z<li><strong>Merged By</strong>: james7132</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Don’t do a full mat4 inverse when you have an affine matrix</ul><h2 id=solution>Solution</h2><ul><li>Do an affine inverse when you have an affine matrix</ul><h2 id=testing>Testing</h2><ul><li>Lighting example</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a performance optimization in Bevy’s point light rendering system. The core issue was in the <code>update_point_light_frusta</code> function, where the code was performing a full 4x4 matrix inversion on what was known to be an affine transformation matrix. This was computationally expensive and unnecessary.<p>The transformation matrix <code>world_from_view</code> is constructed from a translation and rotation, which guarantees it’s an affine transformation. Affine transformations have specific mathematical properties that allow for more efficient inversion compared to general 4x4 matrices. The original implementation used a general matrix inverse operation, which involves more complex calculations than needed for affine transformations.<p>The solution replaces the general matrix inversion with a specialized affine inversion. Instead of converting to a full 4x4 matrix and then inverting (<code>world_from_view.to_matrix().inverse()</code>), the code now uses the affine representation and its optimized inverse operation (<code>world_from_view.compute_affine().inverse()</code>).<p>This change maintains identical mathematical results while improving performance. The optimization is particularly valuable in rendering systems where this calculation occurs for each point light and each face of the cubemap, making even small performance gains multiply across the system.<p>The change was tested using the lighting example to ensure no visual regressions or functional changes occurred. The maintainers recognized this as a straightforward mathematical optimization that improves performance without altering behavior.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Point Light Frusta Update] --> B[Compute world_from_view]
</span><span>    B --> C{Inverse Operation}
</span><span>    C -->|Before| D[Full mat4 inverse]
</span><span>    C -->|After| E[Affine inverse]
</span><span>    D --> F[Clip from World Matrix]
</span><span>    E --> F
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>File:</strong> <code>crates/bevy_light/src/point_light.rs</code><p><strong>Change Description:</strong> Replaced general matrix inversion with optimized affine inversion in point light frustum calculation.<p><strong>Code Change:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> clip_from_world </span><span style=color:#ed9366>=</span><span> clip_from_view </span><span style=color:#ed9366>*</span><span> world_from_view</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_matrix</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>inverse</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> clip_from_world </span><span style=color:#ed9366>=</span><span> clip_from_view </span><span style=color:#ed9366>*</span><span> world_from_view</span><span style=color:#ed9366>.</span><span style=color:#f07171>compute_affine</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>inverse</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><p>This change replaces the computationally expensive general matrix inverse with a more efficient affine-specific inverse operation. The transformation <code>world_from_view</code> is known to be affine (composed of translation and rotation), so using the affine inverse is mathematically equivalent but more performant.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Affine_transformation target=_blank>Affine Transformation - Wikipedia</a><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Invertible_matrix target=_blank>Matrix Inversion - Wikipedia</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_math/latest/bevy_math/ target=_blank>Bevy Math Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Computer_Graphics:_Principles_and_Practice target=_blank>Computer Graphics: Principles and Practice - Foley, van Dam, Feiner, Hughes</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-08/pr_20705.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>