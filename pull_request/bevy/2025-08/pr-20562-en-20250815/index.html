<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20562 Revert asset lifetime changes and preserve staticness of asset paths in AssetServer::load()
        
    </title><meta content="#20562 Revert asset lifetime changes and preserve staticness of asset paths in AssetServer::load()" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-08/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-08-15</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-08/pr-20562-zh-cn-20250815>中文</a></div></div><div class=pr-content><h1 id=revert-asset-lifetime-changes-and-preserve-staticness-of-asset-paths-in-assetserver-load>Revert asset lifetime changes and preserve staticness of asset paths in AssetServer::load()</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Revert asset lifetime changes and preserve staticness of asset paths in AssetServer::load()<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20562<li><strong>Author</strong>: alice-i-cecile<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Assets, C-Performance, S-Ready-For-Final-Review, P-Regression, D-Modest<li><strong>Created</strong>: 2025-08-13T19:49:39Z<li><strong>Merged</strong>: 2025-08-15T18:14:25Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Fixes #19844</ul><h2 id=solution>Solution</h2><ul><li>Revert #10823<li>Also reverts #19094, as the ignored test added there does not compile with the new lifetime rules.</ul><h2 id=todo>TODO</h2><p>This PR was made > 10k issues ago, and git can do funky things. Opening as a draft to investigate the diff before proceeding.<ul><li><input checked disabled type=checkbox> merge main into the old branch<li><input checked disabled type=checkbox> revert the PR<li><input checked disabled type=checkbox> make sure the diff looks okay<li><input checked disabled type=checkbox> add comments explaining why we did this weird thing</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a regression in asset path handling that caused unexpected performance degradation. The issue (#19844) stemmed from changes in how asset paths were stored and cloned. Previously, asset paths used static string references wherever possible to avoid allocations. However, after PR #10823, this behavior changed, causing unnecessary allocations when cloning asset paths.<p>The core problem was that the asset path implementation started allowing non-static lifetimes, which forced runtime allocations when paths needed to be cloned. This was particularly problematic for the AssetServer::load() method where path cloning occurs frequently. The performance impact became noticeable in applications with heavy asset loading operations.<p>To resolve this, we reverted the problematic changes from PR #10823. This required carefully rolling back modifications to three key areas: AssetSourceId, AssetPath, and AssetSourceBuilders. The solution enforces static lifetimes for asset paths and source IDs to guarantee zero allocations during cloning operations.<p>The implementation involved:<ol><li>Removing the <code>as_static()</code> and <code>from_static()</code> conversion methods that allowed non-static paths<li>Restricting From implementations to only accept <code>&'static str</code> and <code>&'static Path</code><li>Ensuring all stored paths use CowArc::Static to avoid allocations<li>Adding clear code comments to prevent future regressions</ol><p>A key insight was recognizing that the generic lifetime parameters introduced in #10823 were causing the allocation overhead. By reverting to static-only lifetimes, we ensure that:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let</span><span> path</span><span style=color:#61676ccc>:</span><span> AssetPath </span><span style=color:#ed9366>= </span><span style=color:#86b300>"static/path.asset"</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> cloned </span><span style=color:#ed9366>=</span><span> path</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#61676ccc>;  </span><span style=color:#abb0b6;font-style:italic>// Now a cheap ref-count operation
</span></code></pre><p>We also had to revert PR #19094 since its test case <code>same_asset_different_settings</code> relied on the reverted lifetime changes. This test was already ignored due to blocking issues, so its removal doesn’t affect current functionality. It can be reintroduced later when the underlying issues are resolved.<p>The changes significantly improve performance in asset-heavy scenarios by eliminating redundant allocations. More importantly, they restore the expected behavior where asset paths can be cloned without performance penalties.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[AssetServer::load] --> B[AssetPath]
</span><span>    B --> C[Clone Operation]
</span><span>    C --> D{Static Path?}
</span><span>    D -->|Yes| E[Zero Allocation]
</span><span>    D -->|No| F[Costly Allocation]
</span><span>    E --> G[Optimal Performance]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-asset-src-path-rs-10-36>crates/bevy_asset/src/path.rs (+10/-36)</h3><p>Modified AssetPath implementation to enforce static lifetimes and avoid allocations during cloning.<p>Key changes:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>impl</span><span><</span><span style=color:#fa6e32>'a</span><span>> </span><span style=color:#55b4d4;font-style:italic>From</span><span><</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'a str</span><span>> </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>AssetPath</span><span><</span><span style=color:#fa6e32>'a</span><span>> {
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>from</span><span>(</span><span style=color:#ff8f40>asset_path</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'a str</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// Could create non-static paths
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>impl </span><span style=color:#55b4d4;font-style:italic>From</span><span><</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'static str</span><span>> </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>AssetPath</span><span><</span><span style=color:#fa6e32>'static</span><span>> {
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>from</span><span>(</span><span style=color:#ff8f40>asset_path</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'static str</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>        AssetPath {
</span><span>            path</span><span style=color:#61676ccc>: </span><span>CowArc</span><span style=color:#ed9366>::</span><span>Static(path)</span><span style=color:#61676ccc>,  </span><span style=color:#abb0b6;font-style:italic>// Ensures no allocation on clone
</span><span>            </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre><h3 id=crates-bevy-asset-src-io-source-rs-10-24>crates/bevy_asset/src/io/source.rs (+10/-24)</h3><p>Updated AssetSourceId to only allow static lifetimes and removed conversion methods that enabled non-static usage.<p>Key changes:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Removed potentially problematic methods:
</span><span style=color:#fa6e32>impl </span><span style=color:#399ee6>AssetSourceId</span><span><</span><span style=color:#fa6e32>'static</span><span>> {
</span><span>    </span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>as_static</span><span>(</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{ </span><span style=color:#ed9366>... </span><span>}
</span><span>    </span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>from_static</span><span>(</span><span style=color:#ff8f40>value</span><span style=color:#61676ccc>:</span><span> impl </span><span style=color:#55b4d4;font-style:italic>Into</span><span><</span><span style=color:#fa6e32>Self</span><span>>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{ </span><span style=color:#ed9366>... </span><span>}
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Simplified conversion:
</span><span style=color:#fa6e32>impl </span><span style=color:#55b4d4;font-style:italic>From</span><span><</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'static str</span><span>> </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>AssetSourceId</span><span><</span><span style=color:#fa6e32>'static</span><span>> {
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>from</span><span>(</span><span style=color:#ff8f40>value</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'static str</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>        AssetSourceId</span><span style=color:#ed9366>::</span><span>Name(value</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>())  </span><span style=color:#abb0b6;font-style:italic>// Static by construction
</span><span>    }
</span><span>}
</span></code></pre><h3 id=crates-bevy-asset-src-lib-rs-1-89>crates/bevy_asset/src/lib.rs (+1/-89)</h3><p>Removed the invalidated test case and updated source registration to use the new static-only types.<p>Key change:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>register_asset_source</span><span>(AssetSourceId</span><span style=color:#ed9366>::</span><span>from_static(id)</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>...</span><span>)
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>register_asset_source</span><span>(id</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>...</span><span>)  </span><span style=color:#abb0b6;font-style:italic>// Relies on static conversion
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/utils/struct.CowArc.html target=_blank>CowArc documentation</a> - Bevy’s copy-on-write atomic reference counted type<li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/book/ch04-00-understanding-ownership.html target=_blank>Rust Ownership and Lifetimes</a> - Fundamental Rust concepts relevant to this change<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/issues/19844 target=_blank>Issue #19844</a> - Original regression report with performance analysis</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-08/pr_20562.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>