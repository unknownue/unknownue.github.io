<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20722 add plugin tracing spans
        
    </title><meta content="#20722 add plugin tracing spans" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-08/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-08-26</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-08/pr-20722-zh-cn-20250826>中文</a></div></div><div class=pr-content><h1 id=add-plugin-tracing-spans>add plugin tracing spans</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: add plugin tracing spans<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20722<li><strong>Author</strong>: atlv24<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Performance, S-Ready-For-Final-Review, A-App<li><strong>Created</strong>: 2025-08-23T06:50:27Z<li><strong>Merged</strong>: 2025-08-26T00:35:06Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>easily diagnose startup performance issues</ul><h2 id=solution>Solution</h2><ul><li>add plugin tracing spans</ul><h2 id=testing>Testing</h2><ul><li>i have not been able to get any tracing to work in any of bevy. idk if this code works, but it looks like it should. is tracing broken or do i have a setup issue?</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a common challenge in Bevy application development: diagnosing startup performance issues. When applications experience slow initialization, developers need visibility into which plugins are contributing most to the startup time. Without proper instrumentation, it’s difficult to identify performance bottlenecks during the plugin build, finish, and cleanup phases.<p>The solution implements tracing spans around plugin lifecycle operations. The implementation adds conditional tracing instrumentation that only activates when the <code>trace</code> feature is enabled, ensuring zero overhead for production builds without tracing. The changes cover three key areas of plugin execution:<ol><li><strong>Plugin build phase</strong>: Added tracing spans when plugins are built during app initialization<li><strong>Plugin finish phase</strong>: Added spans when plugins finalize their setup<li><strong>Plugin cleanup phase</strong>: Added spans during plugin cleanup operations</ol><p>A notable technical consideration was ensuring proper span hierarchy. The PR modifies system spans to set their parent to <code>None</code>, preventing them from appearing as children of plugin build spans. This separation provides clearer trace visualization by keeping plugin-level and system-level instrumentation distinct.<p>The implementation uses Bevy’s existing plugin registry iteration pattern, inserting tracing spans within the “hokeypokey” plugin swapping mechanism that avoids allocation while iterating through plugins. Each span includes the plugin name as metadata, making it easy to identify which plugin corresponds to each span in tracing output.<p>While the author noted uncertainty about whether tracing was working in their environment, the code follows established patterns for Bevy’s tracing instrumentation and provides the necessary hooks for performance analysis when tracing is properly configured.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[App Plugin Operations] --> B[Plugin Build]
</span><span>    A --> C[Plugin Finish]
</span><span>    A --> D[Plugin Cleanup]
</span><span>    B --> E[Individual Plugin Build Spans]
</span><span>    C --> F[Individual Plugin Finish Spans]
</span><span>    D --> G[Individual Plugin Cleanup Spans]
</span><span>    H[System Spans] --> I[Detached from Plugin Hierarchy]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-app-src-app-rs-13-0><code>crates/bevy_app/src/app.rs</code> (+13/-0)</h3><p>Added tracing spans for plugin build, finish, and cleanup operations in the main App implementation.<p>Key changes:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added in finish() method
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"trace"</span><span>)]
</span><span style=color:#fa6e32>let</span><span> _finish_span </span><span style=color:#ed9366>= </span><span style=color:#f07171>info_span!</span><span>(</span><span style=color:#86b300>"plugin finish"</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>entered</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Added per-plugin in finish loop
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"trace"</span><span>)]
</span><span style=color:#fa6e32>let</span><span> _plugin_finish_span </span><span style=color:#ed9366>= </span><span style=color:#f07171>info_span!</span><span>(</span><span style=color:#86b300>"plugin finish"</span><span style=color:#61676ccc>,</span><span> plugin </span><span style=color:#ed9366>=</span><span> hokeypokey</span><span style=color:#ed9366>.</span><span style=color:#f07171>name</span><span>())</span><span style=color:#ed9366>.</span><span style=color:#f07171>entered</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Similar additions for cleanup() method
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"trace"</span><span>)]
</span><span style=color:#fa6e32>let</span><span> _cleanup_span </span><span style=color:#ed9366>= </span><span style=color:#f07171>info_span!</span><span>(</span><span style=color:#86b300>"plugin cleanup"</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>entered</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Added in add_plugin() build operation
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"trace"</span><span>)]
</span><span style=color:#fa6e32>let</span><span> _plugin_build_span </span><span style=color:#ed9366>= </span><span style=color:#f07171>info_span!</span><span>(</span><span style=color:#86b300>"plugin build"</span><span style=color:#61676ccc>,</span><span> plugin </span><span style=color:#ed9366>=</span><span> plugin</span><span style=color:#ed9366>.</span><span style=color:#f07171>name</span><span>())</span><span style=color:#ed9366>.</span><span style=color:#f07171>entered</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-app-src-sub-app-rs-6-0><code>crates/bevy_app/src/sub_app.rs</code> (+6/-0)</h3><p>Added tracing spans for plugin finish and cleanup operations in SubApp implementation.<p>Key changes:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added per-plugin in finish() method
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"trace"</span><span>)]
</span><span style=color:#fa6e32>let</span><span> _plugin_finish_span </span><span style=color:#ed9366>= </span><span style=color:#f07171>info_span!</span><span>(</span><span style=color:#86b300>"plugin finish"</span><span style=color:#61676ccc>,</span><span> plugin </span><span style=color:#ed9366>=</span><span> hokeypokey</span><span style=color:#ed9366>.</span><span style=color:#f07171>name</span><span>())</span><span style=color:#ed9366>.</span><span style=color:#f07171>entered</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Added per-plugin in cleanup() method  
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"trace"</span><span>)]
</span><span style=color:#fa6e32>let</span><span> _plugin_cleanup_span </span><span style=color:#ed9366>= </span><span style=color:#f07171>info_span!</span><span>(</span><span style=color:#86b300>"plugin cleanup"</span><span style=color:#61676ccc>,</span><span> plugin </span><span style=color:#ed9366>=</span><span> hokeypokey</span><span style=color:#ed9366>.</span><span style=color:#f07171>name</span><span>())</span><span style=color:#ed9366>.</span><span style=color:#f07171>entered</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-ecs-src-system-function-system-rs-6-4><code>crates/bevy_ecs/src/system/function_system.rs</code> (+6/-4)</h3><p>Modified system spans to detach them from plugin build spans for clearer tracing hierarchy.<p>Key changes:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"trace"</span><span>)]
</span><span>system_span</span><span style=color:#61676ccc>: </span><span style=color:#f07171>info_span!</span><span>(</span><span style=color:#86b300>"system"</span><span style=color:#61676ccc>,</span><span> name </span><span style=color:#ed9366>=</span><span> name</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_string</span><span>())</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:  
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"trace"</span><span>)]
</span><span>system_span</span><span style=color:#61676ccc>: </span><span style=color:#f07171>info_span!</span><span>(parent</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>None</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"system"</span><span style=color:#61676ccc>,</span><span> name </span><span style=color:#ed9366>=</span><span> name</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_string</span><span>())</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Similar change for commands_span
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/prelude/tracing/index.html target=_blank>Bevy Tracing Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/tracing/latest/tracing/ target=_blank>Rust Tracing Library</a><li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/programming/plugins.html target=_blank>Bevy Plugin System</a><li><a rel="noopener nofollow noreferrer" href=https://tokio.rs/blog/2019-08-tracing target=_blank>Performance Profiling with Tracing</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-08/pr_20722.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>