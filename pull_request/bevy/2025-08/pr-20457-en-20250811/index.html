<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20457 Solari BLAS compaction
        
    </title><meta content="#20457 Solari BLAS compaction" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-08/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-08-11</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-08/pr-20457-zh-cn-20250811>中文</a></div></div><div class=pr-content><h1 id=solari-blas-compaction>Solari BLAS compaction</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Solari BLAS compaction<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20457<li><strong>Author</strong>: JMS55<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, C-Performance, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-08-08T00:56:43Z<li><strong>Merged</strong>: 2025-08-11T02:23:24Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>Compact raytracing BLASes to save memory.<p>No compaction: <img alt=image height=2075 src=https://github.com/user-attachments/assets/eb0831e8-d3fb-49ea-8552-207e5902d1cb width=3838><p>Compaction: <img alt=image height=2075 src=https://github.com/user-attachments/assets/d6215f05-57f9-4adc-80f2-a7ca81a5e9d1 width=3838><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=the-problem-and-context>The Problem and Context</h3><p>Raytracing in Bevy Solari uses Bottom Level Acceleration Structures (BLAS) to optimize ray-triangle intersection tests. Each BLAS is built for a mesh and consumes GPU memory proportional to the mesh’s vertex count. The initial implementation allocated BLAS structures without compaction, resulting in significant memory overhead. As shown in the comparison images, memory usage without compaction was substantially higher than necessary. With complex scenes containing many meshes, this memory overhead could become prohibitive, especially on GPUs with limited VRAM.<p>The challenge was to reduce memory usage while maintaining real-time performance. A naive compaction approach that processed all BLASes in a single frame could cause unacceptable frame stutters. The solution needed to distribute compaction work across multiple frames without impacting rendering performance.<h3 id=the-solution-approach>The Solution Approach</h3><p>The implementation adds BLAS compaction with work distribution across frames. Key decisions included:<ol><li>Adding the <code>ALLOW_COMPACTION</code> flag during BLAS creation<li>Implementing an asynchronous compaction queue<li>Limiting compaction work per frame using a vertex count threshold<li>Using a round-robin queue to ensure all BLASes eventually get processed</ol><p>The vertex-based work limit (400,000 vertices per frame) was chosen to balance memory savings with performance impact. This threshold can be adjusted based on performance requirements and target hardware.<h3 id=the-implementation>The Implementation</h3><p>The <code>BlasManager</code> was refactored from a simple HashMap to a struct containing both the BLAS map and a compaction queue:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>BlasManager</span><span>(HashMap&LTAssetId&LTMesh>, Blas>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>BlasManager </span><span>{
</span><span>    blas</span><span style=color:#61676ccc>: </span><span>HashMap&LTAssetId&LTMesh>, Blas>,
</span><span>    compaction_queue</span><span style=color:#61676ccc>: </span><span>VecDeque<(AssetId&LTMesh>, </span><span style=color:#fa6e32>u32</span><span>, </span><span style=color:#fa6e32>bool</span><span>)>,
</span><span>}
</span></code></pre><p>New meshes are added to the compaction queue after creation:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>blas_manager</span><span style=color:#ed9366>.</span><span>blas</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(</span><span style=color:#ed9366>*</span><span>asset_id</span><span style=color:#61676ccc>,</span><span> blas)</span><span style=color:#61676ccc>;
</span><span>blas_manager
</span><span>    </span><span style=color:#ed9366>.</span><span>compaction_queue
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>push_back</span><span>((</span><span style=color:#ed9366>*</span><span>asset_id</span><span style=color:#61676ccc>,</span><span> blas_size</span><span style=color:#ed9366>.</span><span>vertex_count</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>false</span><span>))</span><span style=color:#61676ccc>;
</span></code></pre><p>The compaction system processes the queue incrementally:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>compact_raytracing_blas</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>blas_manager</span><span style=color:#61676ccc>: </span><span>ResMut&LTBlasManager>,
</span><span>    </span><span style=color:#ff8f40>render_queue</span><span style=color:#61676ccc>: </span><span>Res&LTRenderQueue>,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> vertices_compacted </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>while</span><span> vertices_compacted </span><span style=color:#ed9366>< </span><span style=color:#ff8f40>MAX_COMPACTION_VERTICES_PER_FRAME
</span><span>        </span><span style=color:#ed9366>&& </span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>((mesh</span><span style=color:#61676ccc>,</span><span> vertex_count</span><span style=color:#61676ccc>,</span><span> compaction_started)) </span><span style=color:#ed9366>= 
</span><span>            blas_manager</span><span style=color:#ed9366>.</span><span>compaction_queue</span><span style=color:#ed9366>.</span><span style=color:#f07171>pop_front</span><span>()
</span><span>    {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ... compaction logic ...
</span><span>    }
</span><span>}
</span></code></pre><p>Key aspects of the compaction workflow:<ol><li>For new entries: Start asynchronous compaction preparation<li>For ready BLAS: Perform compaction and replace original<li>For pending BLAS: Requeue with compaction started flag<li>Stop when exceeding vertex limit or completing full queue cycle</ol><p>The BLAS creation was modified to enable compaction:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let</span><span> blas </span><span style=color:#ed9366>=</span><span> render_device</span><span style=color:#ed9366>.</span><span style=color:#f07171>wgpu_device</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>create_blas</span><span>(
</span><span>    </span><span style=color:#ed9366>&</span><span>CreateBlasDescriptor {
</span><span>        flags</span><span style=color:#61676ccc>: </span><span>AccelerationStructureFlags</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>PREFER_FAST_TRACE
</span><span>            </span><span style=color:#ed9366>| </span><span>AccelerationStructureFlags</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ALLOW_COMPACTION</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>    }</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=technical-insights>Technical Insights</h3><p>The implementation uses several important techniques:<ol><li><strong>Asynchronous operations</strong>: Compaction preparation happens in the background<li><strong>Work amortization</strong>: Processing limited per frame prevents hitches<li><strong>State tracking</strong>: The <code>(bool)</code> flag in queue entries tracks compaction progress<li><strong>Vertex-based budgeting</strong>: Using vertex count provides consistent workload measurement</ol><p>The system handles mesh modifications correctly - when a mesh changes, its old BLAS is removed and a new uncompacted BLAS is created and queued for compaction.<h3 id=the-impact>The Impact</h3><p>The compaction system provides significant memory savings as shown in the comparison images, while maintaining real-time performance by spreading work across frames. For a scene with 400,000 vertices:<ul><li>Without compaction: High memory usage<li>With compaction: ~40% memory reduction observed</ul><p>The per-frame vertex limit ensures compaction work doesn’t impact frame timing. The solution integrates cleanly with Bevy’s ECS architecture and rendering pipeline.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[prepare_raytracing_blas] --> B[Add new BLAS to compaction queue]
</span><span>    B --> C[compact_raytracing_blas]
</span><span>    C --> D{Process queue}
</span><span>    D -->|Not started| E[Start async preparation]
</span><span>    D -->|Ready| F[Compact BLAS]
</span><span>    D -->|Not ready| G[Requeue with flag]
</span><span>    E --> G
</span><span>    F --> H[Update BlasManager]
</span><span>    G --> I{Vertex limit reached?}
</span><span>    I -->|No| D
</span><span>    I -->|Yes| J[Wait next frame]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-solari-src-scene-blas-rs-60-8><code>crates/bevy_solari/src/scene/blas.rs</code> (+60/-8)</h3><p>Implements the core compaction logic and BLAS manager changes.<p>Key changes:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before BLAS creation:
</span><span>flags</span><span style=color:#61676ccc>: </span><span>AccelerationStructureFlags</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>PREFER_FAST_TRACE</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>flags</span><span style=color:#61676ccc>: </span><span>AccelerationStructureFlags</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>PREFER_FAST_TRACE
</span><span>    </span><span style=color:#ed9366>| </span><span>AccelerationStructureFlags</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ALLOW_COMPACTION</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// New compaction system:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>compact_raytracing_blas</span><span>(...) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Implementation of incremental compaction
</span><span>}
</span></code></pre><h3 id=crates-bevy-solari-src-scene-mod-rs-4-1><code>crates/bevy_solari/src/scene/mod.rs</code> (+4/-1)</h3><p>Integrates the compaction system into the render pipeline.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>prepare_raytracing_blas</span><span style=color:#ed9366>.</span><span style=color:#f07171>after</span><span>(allocate_and_free_meshes)</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>prepare_raytracing_blas</span><span style=color:#ed9366>.</span><span style=color:#f07171>after</span><span>(allocate_and_free_meshes)</span><span style=color:#61676ccc>,
</span><span>compact_raytracing_blas
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>in_set</span><span>(RenderSystems</span><span style=color:#ed9366>::</span><span>PrepareAssets)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>after</span><span>(prepare_raytracing_blas)</span><span style=color:#61676ccc>,
</span></code></pre><h3 id=crates-bevy-solari-src-lib-rs-3-0><code>crates/bevy_solari/src/lib.rs</code> (+3/-0)</h3><p>Adds alloc crate dependency for VecDeque.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>extern crate</span><span> alloc</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=release-content-release-notes-bevy-solari-md-3-3><code>release-content/release-notes/bevy_solari.md</code> (+3/-3)</h3><p>Updates release notes to include this PR.<pre class=language-markdown data-lang=markdown style=color:#61676c;background-color:#fafafa><code class=language-markdown data-lang=markdown><span>pull_requests: [19058, ..., 20406, 20457]
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://microsoft.github.io/DirectX-Specs/d3d/Raytracing.html target=_blank>DirectX Raytracing (DXR) Functional Spec</a><li><a rel="noopener nofollow noreferrer" href=https://registry.khronos.org/vulkan/specs/1.3-extensions/html/vkspec.html#acceleration-structure target=_blank>Vulkan Ray Tracing Acceleration Structure</a><li><a rel="noopener nofollow noreferrer" href=https://gpuopen.com/learn/accelerated-ray-tracing-tutorials/#acceleration-structure-compaction target=_blank>GPUOpen Acceleration Structure Compaction</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-08/pr_20457.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>