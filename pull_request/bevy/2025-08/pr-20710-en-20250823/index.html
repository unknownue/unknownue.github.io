<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20710 use affine inverse in prepass
        
    </title><meta content="#20710 use affine inverse in prepass" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-08/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-08-23</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-08/pr-20710-zh-cn-20250823>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>use affine inverse in prepass<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: use affine inverse in prepass<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20710<li><strong>Author</strong>: atlv24<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, S-Needs-Review<li><strong>Created</strong>: 2025-08-22T08:33:42Z<li><strong>Merged</strong>: 2025-08-23T21:29:10Z<li><strong>Merged By</strong>: james7132</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>yet again, use affine inverse where possible</ul><h2 id=solution>Solution</h2><ul><li>yours truly</ul><h2 id=testing>Testing</h2><ul><li>deferred rendering example</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a performance optimization opportunity in Bevy’s prepass rendering system. The core issue was that camera transformation matrices were being computed using less efficient mathematical operations than necessary.<p>In computer graphics, camera transformations are typically represented as affine transformations - these preserve parallel lines and include operations like translation, rotation, scaling, and shearing. Bevy’s <code>Affine3A</code> type is specifically designed to handle these transformations more efficiently than general 4x4 matrices (<code>Mat4</code>).<p>The problem was in two functions in the prepass module: <code>update_previous_view_data</code> and <code>prepare_previous_view_uniforms</code>. Both were using <code>to_matrix()</code> to convert <code>Affine3A</code> transformations to <code>Mat4</code> before computing inverses, which is computationally expensive. Matrix inversion for 4x4 matrices has higher computational complexity than for affine transformations.<p>The solution replaces this pattern with more efficient operations:<ol><li>Use <code>affine()</code> instead of <code>to_matrix()</code> to preserve the affine representation<li>Compute inverses using <code>Affine3A::inverse()</code> which is optimized for affine transformations<li>Convert to <code>Mat4</code> only when necessary for subsequent matrix operations</ol><p>This change follows established patterns in the Bevy codebase for optimizing transformation calculations. The author recognized that this same optimization had been applied elsewhere and consistently applied it to the prepass system as well.<p>The implementation maintains mathematical correctness while improving performance. All transformation calculations produce identical results, but with better computational efficiency. This is particularly important for the prepass system which runs every frame and needs to handle camera transformations efficiently.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[GlobalTransform] --> B[affine()]
</span><span>    B --> C[Affine3A]
</span><span>    C --> D[inverse()]
</span><span>    D --> E[Affine3A]
</span><span>    E --> F[Mat4::from()]
</span><span>    F --> G[Mat4 for rendering]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-pbr-src-prepass-mod-rs-7-7><code>crates/bevy_pbr/src/prepass/mod.rs</code> (+7/-7)</h3><p>This file contains the prepass rendering logic. The changes optimize camera transformation calculations by using affine inverses instead of matrix inverses.<p><strong>Key changes in <code>update_previous_view_data</code>:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> world_from_view </span><span style=color:#ed9366>=</span><span> camera_transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_matrix</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> view_from_world </span><span style=color:#ed9366>=</span><span> world_from_view</span><span style=color:#ed9366>.</span><span style=color:#f07171>inverse</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> world_from_view </span><span style=color:#ed9366>=</span><span> camera_transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>affine</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> view_from_world </span><span style=color:#ed9366>= </span><span>Mat4</span><span style=color:#ed9366>::</span><span>from(world_from_view</span><span style=color:#ed9366>.</span><span style=color:#f07171>inverse</span><span>())</span><span style=color:#61676ccc>;
</span></code></pre><p><strong>Key changes in <code>prepare_previous_view_uniforms</code>:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> world_from_view </span><span style=color:#ed9366>=</span><span> camera</span><span style=color:#ed9366>.</span><span>world_from_view</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_matrix</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> view_from_world </span><span style=color:#ed9366>=</span><span> world_from_view</span><span style=color:#ed9366>.</span><span style=color:#f07171>inverse</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> world_from_view </span><span style=color:#ed9366>=</span><span> camera</span><span style=color:#ed9366>.</span><span>world_from_view</span><span style=color:#ed9366>.</span><span style=color:#f07171>affine</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> view_from_world </span><span style=color:#ed9366>= </span><span>Mat4</span><span style=color:#ed9366>::</span><span>from(world_from_view</span><span style=color:#ed9366>.</span><span style=color:#f07171>inverse</span><span>())</span><span style=color:#61676ccc>;
</span></code></pre><p>These changes replace expensive 4x4 matrix inversions with more efficient affine inversions, converting to Mat4 only when necessary for compatibility with other rendering components.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Affine_transformation target=_blank>Affine transformations in computer graphics</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/math/struct.Affine3A.html target=_blank>Bevy’s Affine3A documentation</a><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Invertible_matrix#Methods_of_matrix_inversion target=_blank>Matrix inversion computational complexity</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-08/pr_20710.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>