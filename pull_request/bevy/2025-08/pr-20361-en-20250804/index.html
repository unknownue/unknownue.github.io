<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20361 add ref doc and extract a couple vars and skip a sqrt in shadow cascades
        
    </title><meta content="#20361 add ref doc and extract a couple vars and skip a sqrt in shadow cascades" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-08/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-08-04</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-08/pr-20361-zh-cn-20250804>中文</a></div></div><div class=pr-content><h2 id=pull-request-analysis-add-ref-doc-and-extract-a-couple-vars-and-skip-a-sqrt-in-shadow-cascades>Pull Request Analysis: add ref doc and extract a couple vars and skip a sqrt in shadow cascades</h2><h3 id=basic-information>Basic Information</h3><ul><li><strong>Title</strong>: add ref doc and extract a couple vars and skip a sqrt in shadow cascades<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20361<li><strong>Author</strong>: atlv24<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: D-Trivial, A-Rendering, C-Code-Quality, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-07-31T23:51:36Z<li><strong>Merged</strong>: 2025-08-04T21:32:52Z<li><strong>Merged By</strong>: james7132</ul><h3 id=description-translation>Description Translation</h3><h1 id=objective>Objective</h1><ul><li>ref doc is hard to find<li>expression is big<li>sqrt is extra</ul><h2 id=solution>Solution</h2><ul><li>add ref doc<li>extract a couple vars<li>skip a sqrt</ul><h2 id=testing>Testing</h2><ul><li>shadow biases example</ul><h3 id=the-story-of-this-pull-request>The Story of This Pull Request</h3><p>This PR addresses three related issues in Bevy’s cascade shadow mapping implementation. First, the <code>calculate_cascade</code> function lacked reference documentation, making it harder for developers to understand the theoretical basis for the shadow cascade calculations. Second, the existing code contained a complex expression for calculating cascade diameter that was difficult to parse at a glance. Third, the implementation performed two unnecessary square root operations when computing frustum diagonals.<p>The solution approach focused on clarity and performance. For documentation, we added a direct link to NVIDIA’s official paper on cascaded shadow maps. This provides developers with essential context about the algorithm’s theoretical foundation. The complex expression was refactored by extracting intermediate values (<code>body_diagonal</code> and <code>far_plane_diagonal</code>) to improve readability. Most significantly, the square root operations were optimized by comparing squared lengths first before performing a single square root operation on the maximum value.<p>The implementation changes demonstrate good optimization practices. By moving from length comparisons to squared length comparisons, we reduce the number of expensive square root operations from two to one. This is particularly valuable in graphics code that runs every frame. The variable extraction also improves maintainability - the intermediate values clearly represent the two diagonal measurements being compared.<p>These changes fit well within Bevy’s existing rendering architecture. The optimization doesn’t alter the shadow mapping behavior, but makes the calculations more efficient. The added documentation helps future contributors understand why certain calculations exist, particularly the note about precision considerations affecting cascade diameter calculations.<p>The impact is twofold: better developer documentation and a small but measurable performance improvement in shadow cascade calculations. The changes demonstrate a good pattern for optimizing vector comparisons where relative distances matter more than absolute values - a common scenario in graphics programming.<h3 id=visual-representation>Visual Representation</h3><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[calculate_cascade] --> B[Frustum Corners]
</span><span>    B --> C[Compute Diagonals]
</span><span>    C --> D[Optimized Length Comparison]
</span><span>    D --> E[Cascade Diameter Calculation]
</span></code></pre><h3 id=key-files-changed>Key Files Changed</h3><p><strong>crates/bevy_light/src/cascade.rs</strong> (+5/-4)<br> This file contains the core implementation changes for cascade shadow mapping. The modifications improve documentation clarity and optimize the cascade diameter calculation.<p>Key changes:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> cascade_diameter </span><span style=color:#ed9366>= </span><span>(frustum_corners[</span><span style=color:#ff8f40>0</span><span>] </span><span style=color:#ed9366>-</span><span> frustum_corners[</span><span style=color:#ff8f40>6</span><span>])
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>length</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>max</span><span>((frustum_corners[</span><span style=color:#ff8f40>4</span><span>] </span><span style=color:#ed9366>-</span><span> frustum_corners[</span><span style=color:#ff8f40>6</span><span>])</span><span style=color:#ed9366>.</span><span style=color:#f07171>length</span><span>())
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>ceil</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> body_diagonal </span><span style=color:#ed9366>= </span><span>(frustum_corners[</span><span style=color:#ff8f40>0</span><span>] </span><span style=color:#ed9366>-</span><span> frustum_corners[</span><span style=color:#ff8f40>6</span><span>])</span><span style=color:#ed9366>.</span><span style=color:#f07171>length_squared</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> far_plane_diagonal </span><span style=color:#ed9366>= </span><span>(frustum_corners[</span><span style=color:#ff8f40>4</span><span>] </span><span style=color:#ed9366>-</span><span> frustum_corners[</span><span style=color:#ff8f40>6</span><span>])</span><span style=color:#ed9366>.</span><span style=color:#f07171>length_squared</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> cascade_diameter </span><span style=color:#ed9366>=</span><span> body_diagonal</span><span style=color:#ed9366>.</span><span style=color:#f07171>max</span><span>(far_plane_diagonal)</span><span style=color:#ed9366>.</span><span style=color:#f07171>sqrt</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>ceil</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><p>The changes:<ol><li>Added reference documentation linking to NVIDIA’s cascaded shadow maps paper<li>Extracted two diagonal calculations into separate variables<li>Replaced two <code>.length()</code> calls with <code>.length_squared()</code> + single <code>.sqrt()</code></ol><h3 id=further-reading>Further Reading</h3><ul><li><a rel="noopener nofollow noreferrer" href=https://developer.download.nvidia.com/SDK/10.5/opengl/src/cascaded_shadow_maps/doc/cascaded_shadow_maps.pdf target=_blank>Cascaded Shadow Maps (NVIDIA)</a> - Official reference paper added in documentation<li>Bevy’s <a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/examples/3d/shadow_biases.rs target=_blank>Shadow Biases Example</a> - Relevant test case mentioned in PR description<li>Mathematics of <a rel="noopener nofollow noreferrer" href=https://developer.nvidia.com/gpugems/gpugems/part-i-natural-effects/chapter-1-effective-water-simulation-physical-models target=_blank>Squared Length Optimization</a> - General technique for optimizing distance comparisons</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-08/pr_20361.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>