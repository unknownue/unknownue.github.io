<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20544 Improve error message for failed entity commands
        
    </title><meta content="#20544 Improve error message for failed entity commands" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-08/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-08-14</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-08/pr-20544-zh-cn-20250814>中文</a></div></div><div class=pr-content><h2 id=improve-error-message-for-failed-entity-commands>Improve error message for failed entity commands</h2><h3 id=basic-information>Basic Information</h3><ul><li><strong>Title</strong>: Improve error message for failed entity commands<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20544<li><strong>Author</strong>: alice-i-cecile<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, C-Docs, A-ECS, C-Usability, S-Ready-For-Final-Review, X-Contentious, D-Straightforward<li><strong>Created</strong>: 2025-08-13T00:08:59Z<li><strong>Merged</strong>: 2025-08-13T20:07:40Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h3 id=description>Description</h3><h1 id=objective>Objective</h1><ul><li>If an entity command is sent targeting a despawned entity, that command will error, and then panic by default.<li>This occurs even if the entity exists at the time the command was sent.<li>This can cause surprising panics when working with observers that depend on each other, especially when using entity events that cause entities to be despawned.<li>Closes #19623.</ul><h2 id=solution>Solution</h2><p>As outlined in #19623, this behavior isn’t exactly a bug, although it is surprising.<p>When you attempt to trigger an observer for an entity that doesn’t exist, Bevy should give you some indication that something has gone wrong!<p>The standard mechanism we have for doing so is to return an error in the command, which is passed to the default error handler. By default, this panics, reproducing the problem reported in #19623.<p>Unfortunately, the error reporting was so bad that neither the OP nor the contributors could quickly isolate the problem and tell them what they should be doing differently.<p>The actual solution is both standard to the rest of Bevy and quite simple: just queue the command in a way that makes the error not panic. We should explain that!<p>I’ve added commentary to that effect on both <code>EntityCommands::trigger/trigger_targets</code> and the error message returned.<h2 id=testing>Testing</h2><p>I’ve added a new test demonstrating the fix for this failure mode. Swapping that test to plain <code>.trigger</code> fixes the problem.<h3 id=the-story-of-this-pull-request>The Story of This Pull Request</h3><h4 id=the-problem-and-context>The Problem and Context</h4><p>When working with Bevy’s ECS, developers use entity commands to perform operations like triggering events. However, if a command targets an entity that has been despawned by the time the command is applied, the command fails. By default, this failure triggers a panic. This behavior is particularly problematic when using observers that depend on each other, as one observer might despawn an entity while another observer attempts to trigger an event on that same entity in the same frame. The panic occurs even if the entity existed when the command was originally queued, leading to confusing debugging scenarios as reported in issue #19623.<h4 id=the-solution-approach>The Solution Approach</h4><p>The core issue wasn’t the panic itself—Bevy’s default error handling for failed commands is intentionally panic-based. The real problem was the lack of clear guidance in both the error messages and API documentation. Developers encountering these panics didn’t understand why they occurred or how to handle them properly. The solution focused on two key improvements: enhancing the error message to explicitly suggest proper error handling techniques, and adding documentation to relevant command methods to warn about this failure mode upfront.<h4 id=the-implementation>The Implementation</h4><p>The changes were implemented in two files:<ol><li><strong>Error message enhancement</strong> in <code>error.rs</code>: The existing <code>EntityMutableFetchError::EntityDoesNotExist</code> error was modified to include actionable guidance. Previously, it only indicated the entity didn’t exist. Now it explicitly suggests using <code>EntityCommands::queue_handled</code> or <code>queue_silenced</code> when applying commands to potentially despawned entities:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(thiserror::Error</span><span style=color:#61676ccc>,</span><span> Debug</span><span style=color:#61676ccc>,</span><span> Clone</span><span style=color:#61676ccc>,</span><span> Copy</span><span style=color:#61676ccc>,</span><span> PartialEq</span><span style=color:#61676ccc>,</span><span> Eq)]
</span><span style=color:#fa6e32>pub enum </span><span style=color:#399ee6>EntityMutableFetchError </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>/// The entity with the given ID does not exist.
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>error</span><span>(
</span><span>        </span><span style=color:#86b300>"{0}</span><span style=color:#4cbf99>\n
</span><span style=color:#86b300>    If you were attempting to apply a command to this entity,
</span><span style=color:#86b300>    and want to handle this error gracefully, consider using `EntityCommands::queue_handled` or `queue_silenced`."
</span><span>    )]
</span><span>    EntityDoesNotExist(</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>from</span><span>] EntityDoesNotExistError)</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>}
</span></code></pre><ol start=2><li><strong>API documentation</strong> in <code>commands/mod.rs</code>: The <code>trigger</code>, <code>trigger_targets</code>, and entity-specific <code>trigger</code> methods now include warnings about the failure mode and guidance on handling it:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>/// Sends a global [`Event`] without any targets.
</span><span style=color:#abb0b6;font-style:italic>///
</span><span style=color:#abb0b6;font-style:italic>/// This will run any [`Observer`] of the given [`Event`] that isn't scoped to specific targets.
</span><span style=color:#abb0b6;font-style:italic>///
</span><span style=color:#abb0b6;font-style:italic>/// If the entity that this command targets does not exist when the command is applied,
</span><span style=color:#abb0b6;font-style:italic>/// the command will fail, possibly causing it to panic based on the default [error handler](crate::error) set.
</span><span style=color:#abb0b6;font-style:italic>///
</span><span style=color:#abb0b6;font-style:italic>/// To queue this command with a specific handler, use [`EntityCommands::queue_handled`]
</span><span style=color:#abb0b6;font-style:italic>/// with [`entity_command::trigger(event)`](entity_command::trigger).
</span><span style=color:#abb0b6;font-style:italic>/// [`EntityCommands::queue_silenced`] may also be used to ignore the error completely.
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>track_caller</span><span>]
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>trigger</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>event</span><span style=color:#61676ccc>:</span><span> impl Event) {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>queue</span><span>(command</span><span style=color:#ed9366>::</span><span>trigger(event))</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><ol start=3><li><strong>Validation test</strong>: A new test case was added to demonstrate proper handling of commands targeting despawned entities. The test simulates a scenario where one observer despawns an entity while another observer attempts to trigger an event on it. Using <code>queue_silenced</code> prevents the panic:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>fixing_panicking_entity_commands</span><span>() {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... setup ...
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>followup</span><span>(</span><span style=color:#ff8f40>on</span><span style=color:#61676ccc>: </span><span>On&LTKill>, </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands) {
</span><span>        commands
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(on</span><span style=color:#ed9366>.</span><span style=color:#f07171>target</span><span>())
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>queue_silenced</span><span>(</span><span style=color:#f07171>trigger</span><span>(FollowupEvent))</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... test execution ...
</span><span>}
</span></code></pre><h4 id=technical-insights>Technical Insights</h4><p>The implementation leverages Bevy’s existing command queuing mechanisms. The key insight is that commands targeting potentially despawned entities should use error-handling strategies already available in the API:<ul><li><code>queue_handled</code>: Allows custom error handling logic<li><code>queue_silenced</code>: Silently ignores errors</ul><p>These methods were already present but underutilized due to insufficient documentation. The changes don’t modify core command execution logic—they simply improve developer guidance at the failure points.<h4 id=the-impact>The Impact</h4><p>These changes significantly improve the developer experience when working with entity commands and observers:<ol><li>Clear error messages guide developers to solutions instead of leaving them to debug panics<li>API documentation proactively warns about the failure mode<li>The included test demonstrates the correct pattern for dependent observers<li>Fixes #19623 by providing actionable solutions to a common pitfall</ol><h3 id=visual-representation>Visual Representation</h3><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Entity Command Triggered] --> B{Entity Exists?}
</span><span>    B -->|Yes| C[Command Succeeds]
</span><span>    B -->|No| D[Command Fails]
</span><span>    D --> E[Default: Panic]
</span><span>    D --> F[Use queue_handled: Custom Logic]
</span><span>    D --> G[Use queue_silenced: Ignore Error]
</span></code></pre><h3 id=key-files-changed>Key Files Changed</h3><h4 id=crates-bevy-ecs-src-world-error-rs-52-1><code>crates/bevy_ecs/src/world/error.rs</code> (+52/-1)</h4><p><strong>Purpose</strong>: Improve error message for entity command failures<br> <strong>Key Changes</strong>:<ol><li>Enhanced error message with handling guidance<li>Added test case demonstrating proper error handling</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>error</span><span>(transparent)]
</span><span>EntityDoesNotExist(</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>from</span><span>] EntityDoesNotExistError)</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>error</span><span>(
</span><span>    </span><span style=color:#86b300>"{0}</span><span style=color:#4cbf99>\n
</span><span style=color:#86b300>If you were attempting to apply a command to this entity,
</span><span style=color:#86b300>and want to handle this error gracefully, consider using `EntityCommands::queue_handled` or `queue_silenced`."
</span><span>)]
</span><span>EntityDoesNotExist(</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>from</span><span>] EntityDoesNotExistError)</span><span style=color:#61676ccc>,
</span></code></pre><h4 id=crates-bevy-ecs-src-system-commands-mod-rs-20-0><code>crates/bevy_ecs/src/system/commands/mod.rs</code> (+20/-0)</h4><p><strong>Purpose</strong>: Add warnings and guidance to command methods<br> <strong>Key Changes</strong>: Added documentation to three methods:<ol><li><code>Commands::trigger</code><li><code>Commands::trigger_targets</code><li><code>EntityCommands::trigger</code></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added documentation block:
</span><span style=color:#abb0b6;font-style:italic>/// If the entity that this command targets does not exist when the command is applied,
</span><span style=color:#abb0b6;font-style:italic>/// the command will fail, possibly causing it to panic based on the default [error handler](crate::error) set.
</span><span style=color:#abb0b6;font-style:italic>///
</span><span style=color:#abb0b6;font-style:italic>/// To queue this command with a specific handler, use [`EntityCommands::queue_handled`]
</span><span style=color:#abb0b6;font-style:italic>/// with [`entity_command::trigger(event)`](entity_command::trigger).
</span><span style=color:#abb0b6;font-style:italic>/// [`EntityCommands::queue_silenced`] may also be used to ignore the error completely.
</span></code></pre><h3 id=further-reading>Further Reading</h3><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_ecs/latest/bevy_ecs/system/struct.Commands.html target=_blank>Bevy Commands Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/events/#observers target=_blank>Bevy Observer System Guide</a><li>Original Issue: <a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/issues/19623 target=_blank>#19623</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-08/pr_20544.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>