<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20069 Material bind group shader def
        
    </title><meta content="#20069 Material bind group shader def" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-08/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-08-06</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-08/pr-20069-zh-cn-20250806>中文</a></div></div><div class=pr-content><h2 id=material-bind-group-shader-def>Material Bind Group Shader Def</h2><h3 id=basic-information>Basic Information</h3><ul><li><strong>Title</strong>: Material bind group shader def<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20069<li><strong>Author</strong>: tychedelia<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Feature, A-Rendering, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-07-09T21:08:01Z<li><strong>Merged</strong>: 2025-08-06T05:27:37Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h3 id=description-translation>Description Translation</h3><p>Use a shader def for the material bind group index to make it easier for when we want to switch back to group 2 in the future without breaking everyone again.<h3 id=the-story-of-this-pull-request>The Story of This Pull Request</h3><h4 id=the-problem-and-context>The Problem and Context</h4><p>Bevy’s rendering system relies on WGSL shaders that reference bind groups by index. When the engine upgraded to wgpu 0.25, the material bind group index changed from 2 to 3. This hard-coded value in shaders caused breaking changes requiring manual updates across the codebase and user projects. The rigid coupling between shader code and bind group layout made future index changes difficult and error-prone.<h4 id=the-solution-approach>The Solution Approach</h4><p>The solution introduces a shader definition (<code>MATERIAL_BIND_GROUP</code>) to abstract the bind group index. This allows changing the index through a single constant in Rust code rather than requiring manual updates to every shader file. The approach maintains backward compatibility while enabling future flexibility. Key decisions included:<ol><li>Using a shader def instead of a constant buffer for minimal overhead<li>Implementing consistent naming (<code>MATERIAL_BIND_GROUP</code>) across 2D/3D pipelines<li>Preserving existing bind group indices (3 for 3D, 2 for 2D) during migration</ol><h4 id=the-implementation>The Implementation</h4><p>The implementation involved two primary changes:<ol><li><p><strong>Rust Code Updates</strong><br> Added compile-time constants for bind group indices and injected them into shaders via <code>ShaderDefVal</code> during pipeline specialization:</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// In bevy_pbr/src/material.rs
</span><span style=color:#fa6e32>pub const </span><span style=color:#ff8f40>MATERIAL_BIND_GROUP_INDEX</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>3</span><span style=color:#61676ccc>;
</span><span>
</span><span>descriptor</span><span style=color:#ed9366>.</span><span>vertex</span><span style=color:#ed9366>.</span><span>shader_defs</span><span style=color:#ed9366>.</span><span style=color:#f07171>push</span><span>(ShaderDefVal</span><span style=color:#ed9366>::</span><span>UInt(
</span><span>    </span><span style=color:#86b300>"MATERIAL_BIND_GROUP"</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#ff8f40>MATERIAL_BIND_GROUP_INDEX </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>u32</span><span style=color:#61676ccc>,
</span><span>))</span><span style=color:#61676ccc>;
</span></code></pre><li><p><strong>WGSL Shader Migration</strong><br> Replaced all hard-coded <code>@group(N)</code> references with the shader def:</p> <pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before
</span><span>@group(3) @binding(0) var texture: texture_2d&LTf32>;
</span><span>
</span><span>// After
</span><span>@group(#{MATERIAL_BIND_GROUP}) @binding(0) var texture: texture_2d&LTf32>;
</span></code></pre></ol><p>The changes affected 27 files across core rendering crates and example shaders. The migration guide was updated to reflect best practices for future compatibility.<h4 id=technical-insights>Technical Insights</h4><p>The shader def system allows value substitution at pipeline compilation time. Using <code>#{MATERIAL_BIND_GROUP}</code> syntax provides:<ul><li><strong>Compile-time evaluation</strong>: No runtime performance cost<li><strong>Strong typing</strong>: UInt ensures valid group indices<li><strong>Cross-pipeline consistency</strong>: Works in both forward/prepass pipelines<li><strong>Backward compatibility</strong>: Existing shaders continue working</ul><h4 id=the-impact>The Impact</h4><p>This change decouples shader code from bind group layout specifics. Future index changes will only require updating the Rust constants rather than modifying individual shaders. The solution:<ol><li>Reduces breakage risk during rendering backend upgrades<li>Simplifies maintenance of material systems<li>Provides clear migration path via the updated wgpu 0.25 guide</ol><h3 id=visual-representation>Visual Representation</h3><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Rust Material Pipeline] -->|Injects| B[MATERIAL_BIND_GROUP Shader Def]
</span><span>    B -->|Used in| C[WGSL Shaders]
</span><span>    C -->|Compiles with| D[Bind Group Index]
</span><span>    D -->|Runtime| E[GPU Execution]
</span></code></pre><h3 id=key-files-changed>Key Files Changed</h3><ol><li><p><code>crates/bevy_pbr/src/render/pbr_bindings.wgsl</code><br> Updated all material resource bindings to use shader def:</p> <pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>@group(3) @binding(0) var&LTstorage> material_indices: array&LTStandardMaterialBindings>;
</span><span>
</span><span>// After:
</span><span>@group(#{MATERIAL_BIND_GROUP}) @binding(0) var&LTstorage> material_indices: array&LTStandardMaterialBindings>;
</span></code></pre><li><p><code>assets/shaders/fallback_image_test.wgsl</code><br> Migrated texture bindings to shader def:</p> <pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>@group(3) @binding(0) var test_texture_1d: texture_1d&LTf32>;
</span><span>
</span><span>// After:
</span><span>@group(#{MATERIAL_BIND_GROUP}) @binding(0) var test_texture_1d: texture_1d&LTf32>;
</span></code></pre><li><p><code>crates/bevy_render/src/bindless.wgsl</code><br> Updated bindless resource declarations:</p> <pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>@group(3) @binding(1) var bindless_samplers_filtering: binding_array&LTsampler>;
</span><span>
</span><span>// After:
</span><span>@group(#{MATERIAL_BIND_GROUP}) @binding(1) var bindless_samplers_filtering: binding_array&LTsampler>;
</span></code></pre><li><p><code>crates/bevy_sprite/src/mesh2d/material.rs</code><br> Added 2D material bind group constant and shader def:</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub const </span><span style=color:#ff8f40>MATERIAL_2D_BIND_GROUP_INDEX</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>2</span><span style=color:#61676ccc>;
</span><span>
</span><span>descriptor</span><span style=color:#ed9366>.</span><span>vertex</span><span style=color:#ed9366>.</span><span>shader_defs</span><span style=color:#ed9366>.</span><span style=color:#f07171>push</span><span>(ShaderDefVal</span><span style=color:#ed9366>::</span><span>UInt(
</span><span>    </span><span style=color:#86b300>"MATERIAL_BIND_GROUP"</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#ff8f40>MATERIAL_2D_BIND_GROUP_INDEX </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>u32</span><span style=color:#61676ccc>,
</span><span>))</span><span style=color:#61676ccc>;
</span></code></pre><li><p><code>crates/bevy_pbr/src/material.rs</code><br> Implemented core 3D material bind group logic:</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub const </span><span style=color:#ff8f40>MATERIAL_BIND_GROUP_INDEX</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>3</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#fa6e32>ref mut</span><span> fragment) </span><span style=color:#ed9366>=</span><span> descriptor</span><span style=color:#ed9366>.</span><span>fragment {
</span><span>    fragment</span><span style=color:#ed9366>.</span><span>shader_defs</span><span style=color:#ed9366>.</span><span style=color:#f07171>push</span><span>(ShaderDefVal</span><span style=color:#ed9366>::</span><span>UInt(
</span><span>        </span><span style=color:#86b300>"MATERIAL_BIND_GROUP"</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#ff8f40>MATERIAL_BIND_GROUP_INDEX </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>u32</span><span style=color:#61676ccc>,
</span><span>    ))</span><span style=color:#61676ccc>;
</span><span>}</span><span style=color:#61676ccc>;
</span></code></pre></ol><h3 id=further-reading>Further Reading</h3><ol><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/crates/bevy_render/src/render_resource/pipeline_specializer.rs target=_blank>WGSL Shader Def Specification</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/getting-started/pipeline/ target=_blank>Bevy Render Pipeline Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://www.w3.org/TR/WGSL/#binding-points target=_blank>WGSL Bind Group Layouts</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-08/pr_20069.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>