<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20675 Fix aabb area calculation
        
    </title><meta content="#20675 Fix aabb area calculation" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-08/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-08-20</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-08/pr-20675-zh-cn-20250820>中文</a></div></div><div class=pr-content><h1 id=fix-aabb-area-calculation>Fix aabb area calculation</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix aabb area calculation<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20675<li><strong>Author</strong>: atlv24<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, S-Ready-For-Final-Review, A-Math<li><strong>Created</strong>: 2025-08-20T17:22:27Z<li><strong>Merged</strong>: 2025-08-20T18:22:31Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>positive area can be reported for inverted Aabb2d, and negative area too in some cases. Invalid Aabbs (any(min > max)) should have zero area.</ul><h2 id=solution>Solution</h2><ul><li>max 0</ul><h2 id=testing>Testing</h2><ul><li>found at work, fixed at work, tested at work, works at work</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a mathematical correctness issue in Bevy’s axis-aligned bounding box (AABB) implementation. The problem occurred when dealing with invalid AABBs - specifically those where any component of the <code>min</code> vector was greater than the corresponding component of the <code>max</code> vector.<p>The core issue was in the <code>visible_area()</code> method implementation for both 2D and 3D AABBs. When calculating the area, the code simply computed <code>self.max - self.min</code> without validating whether the resulting dimensions were positive. For invalid AABBs where <code>min > max</code> in any dimension, this subtraction would produce negative values, leading to mathematically incorrect area calculations.<p>In 2D, the area calculation is <code>width * height</code>, and with negative dimensions, this could produce positive area values (when both dimensions are negative) or negative area values (when one dimension is negative). Similarly, in 3D, the surface area calculation <code>b.x * (b.y + b.z) + b.y * b.z</code> would produce nonsensical results with negative dimensions.<p>The fix is straightforward and mathematically sound: clamp each dimension to zero using <code>.max(Vec2::ZERO)</code> for 2D and <code>.max(Vec3A::ZERO)</code> for 3D. This ensures that invalid AABBs (where any dimension would be negative) report zero area, which is the correct behavior for degenerate bounding volumes.<p>The implementation maintains performance with <code>#[inline(always)]</code> directives and uses the existing vector math operations without introducing branching or complex logic. This approach ensures that valid AABBs continue to compute areas efficiently while handling edge cases correctly.<p>This fix is important because many algorithms that use AABBs for spatial partitioning, collision detection, or rendering optimizations rely on the assumption that area calculations are mathematically correct. Invalid area values could lead to incorrect behavior in systems that prioritize or cull objects based on their visible area.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Aabb2d.visible_area] --> B[Compute dimensions: max - min]
</span><span>    B --> C[Clamp to zero: .max(ZERO)]
</span><span>    C --> D[Calculate area]
</span><span>    
</span><span>    E[Aabb3d.visible_area] --> F[Compute dimensions: max - min]
</span><span>    F --> G[Clamp to zero: .max(ZERO)]
</span><span>    G --> H[Calculate surface area]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-math-src-bounding-bounded2d-mod-rs-1-1><code>crates/bevy_math/src/bounding/bounded2d/mod.rs</code> (+1/-1)</h3><p><strong>Change</strong>: Fixed area calculation for invalid 2D AABBs by clamping dimensions to zero.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>visible_area</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>f32 </span><span>{
</span><span>    </span><span style=color:#fa6e32>let</span><span> b </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>max </span><span style=color:#ed9366>- </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>min</span><span style=color:#61676ccc>;
</span><span>    b</span><span style=color:#ed9366>.</span><span>x </span><span style=color:#ed9366>*</span><span> b</span><span style=color:#ed9366>.</span><span>y
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>visible_area</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>f32 </span><span>{
</span><span>    </span><span style=color:#fa6e32>let</span><span> b </span><span style=color:#ed9366>= </span><span>(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>max </span><span style=color:#ed9366>- </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>min)</span><span style=color:#ed9366>.</span><span style=color:#f07171>max</span><span>(Vec2</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ZERO</span><span>)</span><span style=color:#61676ccc>;
</span><span>    b</span><span style=color:#ed9366>.</span><span>x </span><span style=color:#ed9366>*</span><span> b</span><span style=color:#ed9366>.</span><span>y
</span><span>}
</span></code></pre><h3 id=crates-bevy-math-src-bounding-bounded3d-mod-rs-1-1><code>crates/bevy_math/src/bounding/bounded3d/mod.rs</code> (+1/-1)</h3><p><strong>Change</strong>: Fixed surface area calculation for invalid 3D AABBs by clamping dimensions to zero.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>visible_area</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>f32 </span><span>{
</span><span>    </span><span style=color:#fa6e32>let</span><span> b </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>max </span><span style=color:#ed9366>- </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>min</span><span style=color:#61676ccc>;
</span><span>    b</span><span style=color:#ed9366>.</span><span>x </span><span style=color:#ed9366>* </span><span>(b</span><span style=color:#ed9366>.</span><span>y </span><span style=color:#ed9366>+</span><span> b</span><span style=color:#ed9366>.</span><span>z) </span><span style=color:#ed9366>+</span><span> b</span><span style=color:#ed9366>.</span><span>y </span><span style=color:#ed9366>*</span><span> b</span><span style=color:#ed9366>.</span><span>z
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>visible_area</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>f32 </span><span>{
</span><span>    </span><span style=color:#fa6e32>let</span><span> b </span><span style=color:#ed9366>= </span><span>(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>max </span><span style=color:#ed9366>- </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>min)</span><span style=color:#ed9366>.</span><span style=color:#f07171>max</span><span>(Vec3A</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ZERO</span><span>)</span><span style=color:#61676ccc>;
</span><span>    b</span><span style=color:#ed9366>.</span><span>x </span><span style=color:#ed9366>* </span><span>(b</span><span style=color:#ed9366>.</span><span>y </span><span style=color:#ed9366>+</span><span> b</span><span style=color:#ed9366>.</span><span>z) </span><span style=color:#ed9366>+</span><span> b</span><span style=color:#ed9366>.</span><span>y </span><span style=color:#ed9366>*</span><span> b</span><span style=color:#ed9366>.</span><span>z
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Minimum_bounding_box#Axis-aligned_minimum_bounding_box target=_blank>Axis-aligned bounding boxes (AABBs) in computer graphics</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_math/latest/bevy_math/bounding/trait.BoundingVolume.html target=_blank>Bevy’s Bounding Volume documentation</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/glam/latest/glam/ target=_blank>Vector math operations in Rust</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-08/pr_20675.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>