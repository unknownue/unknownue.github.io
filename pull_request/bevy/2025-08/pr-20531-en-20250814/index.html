<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20531 Update `morph_targets` and `many_foxes` examples to use observers
        
    </title><meta content="#20531 Update `morph_targets` and `many_foxes` examples to use observers" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-08/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-08-14</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-08/pr-20531-zh-cn-20250814>中文</a></div></div><div class=pr-content><h2 id=update-morph-targets-and-many-foxes-examples-to-use-observers>Update <code>morph_targets</code> and <code>many_foxes</code> examples to use observers</h2><h3 id=basic-information>Basic Information</h3><ul><li><strong>Title</strong>: Update <code>morph_targets</code> and <code>many_foxes</code> examples to use observers<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20531<li><strong>Author</strong>: greeble-dev<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Examples, C-Code-Quality, S-Ready-For-Final-Review, A-Animation<li><strong>Created</strong>: 2025-08-12T12:35:55Z<li><strong>Merged</strong>: 2025-08-14T21:02:26Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h3 id=description>Description</h3><p>Change some examples to follow best practices for playing animations, and as a bonus work around an issue with scenes spawning multiple times.<h4 id=background>Background</h4><p>Examples that play skeletal animations usually have two steps:<ol><li>Start scene spawning.<li>Play animations after the scene has spawned.</ol><p>Different examples use different approaches for triggering part 2, including a scene spawning observer and <code>Added&LTAnimationPlayer></code> queries.<p>The observer approach is arguably best as it’s more tightly scoped and easier for users to extend. The other approaches work in simple examples but fall down when users want multiple scenes or animations. See #17421 for more detail.<p>As a bonus, the scene spawning observer works around a current issue with scenes spawning multiple times - see #20393, #20430. Although there’s an argument that this PR shouldn’t land until the issue is properly fixed, as these examples are a useful test case.<h4 id=solution>Solution</h4><p>Update the <code>morph_targets</code> and <code>many_foxes</code> examples to use observers.<p>I also made a few tweaks and fixes to <code>morph_targets</code>:<ul><li>Fix documentation referring to an <code>update_weights</code> feature that isn’t in the example.<li>Use the same <code>AnimationToPlay</code> component as the <code>animated_mesh</code> example.<li>Change the <code>name_morphs</code> system to be event driven and print the asset name. <ul><li>This is maybe too complex, but could also be nice for users to c&p into their app for debugging.</ul></ul><p>I haven’t updated the <code>animated_mesh_control</code>, <code>animated_mesh_events</code>, and <code>animation_masks</code> examples, which still use <code>Added&LTAnimationPlayer></code>.<h4 id=testing>Testing</h4><pre class=language-sh data-lang=sh style=color:#61676c;background-color:#fafafa><code class=language-sh data-lang=sh><span style=color:#f29718>cargo</span><span> run</span><span style=color:#ff8f40> --example</span><span> morph_targets
</span><span style=color:#f29718>cargo</span><span> run</span><span style=color:#ff8f40> --example</span><span> many_foxes
</span></code></pre><h3 id=the-story-of-this-pull-request>The Story of This Pull Request</h3><p>This PR addresses inconsistent animation setup patterns in Bevy examples. The core problem was that examples used different approaches to trigger animations after scene loading - some used frame-based checks with local flags, while others used component-added queries. These approaches were fragile when handling multiple scenes or animations, as discussed in issue #17421.<p>The solution migrates both <code>morph_targets</code> and <code>many_foxes</code> examples to use Bevy’s observer system. Observers provide event-driven scene readiness detection through the <code>SceneInstanceReady</code> component. This approach:<ol><li>Eliminates frame-based polling with <code>Local&LTbool></code> flags<li>Avoids broad <code>Added&LTAnimationPlayer></code> queries<li>Works around scene spawning issues (#20393, #20430)<li>Provides a reusable pattern for animation setup</ol><p>For <code>morph_targets</code>, we implemented several improvements alongside the observer migration:<ol><li>Replaced the resource-based <code>MorphData</code> with an <code>AnimationToPlay</code> component<li>Converted the <code>name_morphs</code> system to use <code>AssetEvent&LTMesh></code> for event-driven logging<li>Added asset path information to morph target logs<li>Simplified the scene setup flow</ol><p>The observer systems work by:<ol><li>Attaching observers to scene entities during spawning<li>Triggering when <code>SceneInstanceReady</code> appears<li>Traversing entity descendants to find <code>AnimationPlayer</code> components<li>Starting animations with proper configuration</ol><p>This pattern ensures animations start exactly once per scene instance without frame-based polling. The <code>morph_targets</code> example now also demonstrates practical use of <code>AssetEvent</code> for reactive asset handling.<h3 id=visual-representation>Visual Representation</h3><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Scene Spawn] --> B[Attach Observer]
</span><span>    B --> C{SceneInstanceReady}
</span><span>    C --> D[Find AnimationPlayer]
</span><span>    D --> E[Start Animation]
</span></code></pre><h3 id=key-files-changed>Key Files Changed</h3><ol><li><p><strong>examples/animation/morph_targets.rs</strong> (+60/-74)<br> Migrated to observer pattern, added event-driven morph target logging<br> Key changes:</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Frame-based animation setup
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>setup_animations</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>has_setup</span><span style=color:#61676ccc>: </span><span>Local<</span><span style=color:#fa6e32>bool</span><span>>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>players</span><span style=color:#61676ccc>: </span><span>Query<(Entity, </span><span style=color:#ed9366>&</span><span>Name, </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> AnimationPlayer)>,
</span><span>    </span><span style=color:#ff8f40>morph_data</span><span style=color:#61676ccc>: </span><span>Res&LTMorphData>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>graphs</span><span style=color:#61676ccc>: </span><span>ResMut&LTAssets&LTAnimationGraph>>,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>if </span><span style=color:#ed9366>*</span><span>has_setup { </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>; </span><span>}
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... frame-based player search
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Observer-based animation setup
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>play_animation_when_ready</span><span>(
</span><span>    </span><span style=color:#ff8f40>trigger</span><span style=color:#61676ccc>: </span><span>On&LTSceneInstanceReady>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands,
</span><span>    </span><span style=color:#ff8f40>children</span><span style=color:#61676ccc>: </span><span>Query<</span><span style=color:#ed9366>&</span><span>Children>,
</span><span>    </span><span style=color:#ff8f40>animations_to_play</span><span style=color:#61676ccc>: </span><span>Query<</span><span style=color:#ed9366>&</span><span>AnimationToPlay>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>players</span><span style=color:#61676ccc>: </span><span>Query<</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> AnimationPlayer>,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(animation_to_play) </span><span style=color:#ed9366>=</span><span> animations_to_play</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(trigger</span><span style=color:#ed9366>.</span><span style=color:#f07171>target</span><span>()) {
</span><span>        </span><span style=color:#fa6e32>for</span><span> child </span><span style=color:#ed9366>in</span><span> children</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter_descendants</span><span>(trigger</span><span style=color:#ed9366>.</span><span style=color:#f07171>target</span><span>()) {
</span><span>            </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(</span><span style=color:#fa6e32>mut</span><span> player) </span><span style=color:#ed9366>=</span><span> players</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_mut</span><span>(child) {
</span><span>                player</span><span style=color:#ed9366>.</span><span style=color:#f07171>play</span><span>(animation_to_play</span><span style=color:#ed9366>.</span><span>index)</span><span style=color:#ed9366>.</span><span style=color:#f07171>repeat</span><span>()</span><span style=color:#61676ccc>;
</span><span>                </span><span style=color:#abb0b6;font-style:italic>// ... component setup
</span><span>            }
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre><li><p><strong>examples/stress_tests/many_foxes.rs</strong> (+18/-18)<br> Converted to per-instance observer pattern<br> Key changes:</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Global frame-based animation starter
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>setup_scene_once_loaded</span><span>(
</span><span>    </span><span style=color:#ff8f40>animations</span><span style=color:#61676ccc>: </span><span>Res&LTAnimations>,
</span><span>    </span><span style=color:#ff8f40>foxes</span><span style=color:#61676ccc>: </span><span>Res&LTFoxes>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>player</span><span style=color:#61676ccc>: </span><span>Query<(Entity, </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> AnimationPlayer)>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>done</span><span style=color:#61676ccc>: </span><span>Local<</span><span style=color:#fa6e32>bool</span><span>>,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!*</span><span>done </span><span style=color:#ed9366>&&</span><span> player</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>len</span><span>() </span><span style=color:#ed9366>==</span><span> foxes</span><span style=color:#ed9366>.</span><span>count {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ... process all players
</span><span>        </span><span style=color:#ed9366>*</span><span>done </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>true</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Per-instance observer system
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>setup_scene_once_loaded</span><span>(
</span><span>    </span><span style=color:#ff8f40>trigger</span><span style=color:#61676ccc>: </span><span>On&LTSceneInstanceReady>,
</span><span>    </span><span style=color:#ff8f40>animations</span><span style=color:#61676ccc>: </span><span>Res&LTAnimations>,
</span><span>    </span><span style=color:#ff8f40>foxes</span><span style=color:#61676ccc>: </span><span>Res&LTFoxes>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands,
</span><span>    </span><span style=color:#ff8f40>children</span><span style=color:#61676ccc>: </span><span>Query<</span><span style=color:#ed9366>&</span><span>Children>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>players</span><span style=color:#61676ccc>: </span><span>Query<</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> AnimationPlayer>,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>for</span><span> child </span><span style=color:#ed9366>in</span><span> children</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter_descendants</span><span>(trigger</span><span style=color:#ed9366>.</span><span style=color:#f07171>target</span><span>()) {
</span><span>        </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(</span><span style=color:#fa6e32>mut</span><span> player) </span><span style=color:#ed9366>=</span><span> players</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_mut</span><span>(child) {
</span><span>            </span><span style=color:#abb0b6;font-style:italic>// ... start animation per instance
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre></ol><h3 id=further-reading>Further Reading</h3><ol><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/rfcs/pull/39 target=_blank>Bevy Observers RFC</a> - Observer pattern design<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/next/scenes/ target=_blank>Scene System Documentation</a> - Scene loading workflow<li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/animation/struct.AnimationGraph.html target=_blank>Animation Graph API</a> - Animation control reference<li>Issue <a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/issues/17421 target=_blank>#17421</a> - Animation setup discussion<li>PR <a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/pull/11531 target=_blank>#11531</a> - Original observer implementation</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-08/pr_20531.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>