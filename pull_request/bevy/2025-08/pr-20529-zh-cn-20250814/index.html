<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20529 Atmosphere generated environment map lighting
        
    </title><meta content="#20529 Atmosphere generated environment map lighting" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-08/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-08-14</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2025-08/pr-20529-en-20250814>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=atmosphere-generated-environment-map-lighting>Atmosphere generated environment map lighting</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Atmosphere generated environment map lighting<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20529<li><strong>Author</strong>: mate-h<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Feature, A-Rendering, S-Ready-For-Final-Review, M-Needs-Release-Note<li><strong>Created</strong>: 2025-08-12T10:25:46Z<li><strong>Merged</strong>: 2025-08-14T18:17:02Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>目标<ul><li>为大气效果添加生成的环境光照（用于反射和漫反射）<li>跟踪问题：#20374</ul><p>解决方案<ul><li>创建了新的大气节点类型 environment（环境）<li>对现有的天空视角查找纹理（sky-view lookup texture）进行上采样，仅绑定到当前视图。这个大气立方体贴图通道对性能影响很小，但过滤管线会对示例产生轻微性能影响<li>使用新的过滤管线，为不同粗糙度级别和漫反射创建 mip 链</ul><p>测试<ul><li>运行了大气示例</ul><hr><p>效果展示</p><img alt="Screenshot 2025-08-12 at 12 19 08 PM" height=752 src=https://github.com/user-attachments/assets/8f00ff25-5f48-4c51-b67e-abcbf421abc4 width=1281><pre class=language-rs data-lang=rs style=color:#61676c;background-color:#fafafa><code class=language-rs data-lang=rs><span>commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((
</span><span>    Camera3d</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 从相机视角将大气渲染到环境贴图
</span><span>    AtmosphereEnvironmentMapLight</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>,
</span><span>))</span><span style=color:#61676ccc>;
</span></code></pre><p>局限性与超出范围<ul><li>该生成功能暂不支持光照探针（light probe）。这允许从场景内任意“位置“和整个大气层中将大气渲染为光照探针<li>因此我们假设场景与大气层的相对比例存在数量级差异，在当前实现中这是安全假设（尚未正式支持太空视图）<li>PBR 定向光仍不受大气影响（不被其着色），这超出本 PR 范围<li>与本 PR 无关的问题：全反射球体周围出现小黑点。已定位问题，这是基于渲染天空着色器中深度值的散射计算问题。但添加环境贴图光照使该问题更“明显“，将单独处理<li>后续工作：https://github.com/mate-h/bevy/pull/10</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=wen-ti-yu-bei-jing>问题与背景</h3><p>在 Bevy 的渲染系统中，大气效果（Atmosphere）已经能渲染天空视觉表现，但缺少对基于图像照明（IBL）的支持。具体来说：<ol><li>现有实现无法为反射和全局漫射照明提供环境贴图<li>场景中的物体无法反射动态变化的大气效果（如不同时间段的天空颜色变化）<li>缺少将大气作为光源集成到 PBR 渲染管线的机制</ol><p>技术约束包括：<ul><li>环境贴图需要立方体贴图（cubemap）格式<li>生成过程需高效，避免影响实时渲染性能<li>需要与现有大气计算管线集成</ul><h3 id=jie-jue-fang-an>解决方案</h3><p>开发者引入新组件 <code>AtmosphereEnvironmentMapLight</code>，通过计算着色器动态生成环境贴图：<ol><li><p><strong>新组件设计</strong><br> 创建 <code>AtmosphereEnvironmentMapLight</code> 组件，可附加到相机或光照探针：</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>AtmosphereEnvironmentMapLight </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>intensity</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>affects_lightmapped_mesh_diffuse</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>bool</span><span>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>size</span><span style=color:#61676ccc>:</span><span> UVec2,
</span><span>}
</span></code></pre> <p>关键参数：</p> <ul><li><code>intensity</code>：控制环境光照亮度<li><code>size</code>：指定立方体贴图分辨率（必须为2的幂）</ul><li><p><strong>纹理准备</strong><br> 在 <code>prepare_atmosphere_probe_components</code> 系统中创建空的 Rgba16Float 格式立方体贴图：</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let mut</span><span> environment_image </span><span style=color:#ed9366>= </span><span>Image</span><span style=color:#ed9366>::</span><span>new_fill(
</span><span>    Extent3d { width</span><span style=color:#61676ccc>:</span><span> new_size</span><span style=color:#ed9366>.</span><span>x</span><span style=color:#61676ccc>,</span><span> height</span><span style=color:#61676ccc>:</span><span> new_size</span><span style=color:#ed9366>.</span><span>y</span><span style=color:#61676ccc>,</span><span> depth_or_array_layers</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>6 </span><span>}</span><span style=color:#61676ccc>,
</span><span>    TextureDimension</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>D2</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#ed9366>&</span><span>[</span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>; </span><span style=color:#ff8f40>8</span><span>]</span><span style=color:#61676ccc>,
</span><span>    TextureFormat</span><span style=color:#ed9366>::</span><span>Rgba16Float</span><span style=color:#61676ccc>,
</span><span>    RenderAssetUsages</span><span style=color:#ed9366>::</span><span>all()</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><li><p><strong>计算管线</strong><br> 新增 <code>environment.wgsl</code> 计算着色器，核心逻辑：</p> <pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>@compute @workgroup_size(8, 8, 1)
</span><span>fn main(@builtin(global_invocation_id) global_id: vec3&LTu32>) {
</span><span>    let ray_dir_ws = sample_cube_dir(uv, slice_index);
</span><span>    let ray_dir_as = direction_world_to_atmosphere(ray_dir_ws.xyz);
</span><span>    let inscattering = sample_sky_view_lut(r, ray_dir_as);
</span><span>    textureStore(output, vec2&LTi32>(global_id.xy), i32(slice_index), vec4(inscattering, 1.0));
</span><span>}
</span></code></pre> <ul><li>每个工作线程处理立方体一个面的像素<li>重用现有大气函数计算散射光</ul><li><p><strong>渲染图集成</strong><br> 在 AtmospherePlugin 中注册新节点：</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#ed9366>.</span><span>add_render_graph_node</span><span style=color:#ed9366>::</span><span>&LTEnvironmentNode>(Core3d</span><span style=color:#61676ccc>, </span><span>AtmosphereNode</span><span style=color:#ed9366>::</span><span>Environment)
</span></code></pre> <p><code>EnvironmentNode</code> 负责调度计算着色器：</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>pass</span><span style=color:#ed9366>.</span><span style=color:#f07171>dispatch_workgroups</span><span>(
</span><span>    env_map_light</span><span style=color:#ed9366>.</span><span>size</span><span style=color:#ed9366>.</span><span>x </span><span style=color:#ed9366>/ </span><span style=color:#ff8f40>8</span><span style=color:#61676ccc>,
</span><span>    env_map_light</span><span style=color:#ed9366>.</span><span>size</span><span style=color:#ed9366>.</span><span>y </span><span style=color:#ed9366>/ </span><span style=color:#ff8f40>8</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#ff8f40>6 </span><span style=color:#abb0b6;font-style:italic>// 6个立方体贴图面
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><li><p><strong>光照集成</strong><br> 生成的环境贴图转换为 <code>GeneratedEnvironmentMapLight</code>：</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>GeneratedEnvironmentMapLight {
</span><span>    environment_map</span><span style=color:#61676ccc>:</span><span> environment_handle</span><span style=color:#61676ccc>,
</span><span>    intensity</span><span style=color:#61676ccc>:</span><span> env_map_light</span><span style=color:#ed9366>.</span><span>intensity</span><span style=color:#61676ccc>,
</span><span>    rotation</span><span style=color:#61676ccc>: </span><span>Quat</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>IDENTITY</span><span style=color:#61676ccc>,
</span><span>    affects_lightmapped_mesh_diffuse</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>...</span><span style=color:#61676ccc>,
</span><span>}
</span></code></pre> <p>供 PBR 系统使用</p></ol><h3 id=guan-jian-ji-shu-dian>关键技术点</h3><ol><li><strong>高效重用</strong>：复用已有大气纹理（transmittance_lut, sky_view_lut 等）避免重复计算<li><strong>并行计算</strong>：每个立方体贴图面独立处理，工作组大小 8x8 优化 GPU 占用<li><strong>自动分辨率处理</strong>：<code>validate_environment_map_size</code> 确保尺寸为2的幂<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>UVec2</span><span style=color:#ed9366>::</span><span>new(size</span><span style=color:#ed9366>.</span><span>x</span><span style=color:#ed9366>.</span><span style=color:#f07171>max</span><span>(</span><span style=color:#ff8f40>1</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>next_power_of_two</span><span>()</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>...</span><span>)
</span></code></pre><li><strong>曝光解耦</strong>：修改 <code>render_sky.wgsl</code> 将曝光计算移出散射计算：<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// 之前
</span><span>inscattering += sun_radiance * transmittance * view.exposure;
</span><span>
</span><span>// 之后
</span><span>inscattering += sun_radiance * transmittance;
</span><span>inscattering *= view.exposure; // 统一应用曝光
</span></code></pre></ol><h3 id=xing-neng-ying-xiang>性能影响</h3><ul><li>立方体贴图生成：因使用计算着色器且重用现有数据，开销较小<li>过滤管线：生成 mip 链有轻微性能影响<li>内存占用：每张 512x512 立方体贴图约 12MB (RGBA16Float * 6 faces)</ul><h3 id=shi-ji-ying-xiang>实际影响</h3><ol><li>用户可通过简单组件添加大气环境光照：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((Camera3d</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>, </span><span>AtmosphereEnvironmentMapLight</span><span style=color:#ed9366>::</span><span>default()))</span><span style=color:#61676ccc>;
</span></code></pre><li>示例场景展示大气对反射和全局光照的影响<li>为后续光照探针支持奠定基础</ol><h3 id=yi-zhi-xian-zhi>已知限制</h3><ol><li>光照探针支持待实现（当前仅相机视图有效）<li>定向光未受大气着色影响（未来扩展点）<li>全反射物体边缘存在视觉瑕疵（独立问题）</ol><h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[AtmosphereEnvironmentMapLight] --> B(创建空立方体贴图)
</span><span>    B --> C[EnvironmentNode]
</span><span>    C --> D[environment.wgsl]
</span><span>    D --> E[GeneratedEnvironmentMapLight]
</span><span>    E --> F[PBR渲染管线]
</span><span>    G[大气纹理] --> D
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=1-crates-bevy-light-src-probe-rs-34-1>1. <code>crates/bevy_light/src/probe.rs</code> (+34/-1)</h3><p>添加新组件 <code>AtmosphereEnvironmentMapLight</code>：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component</span><span style=color:#61676ccc>,</span><span> Clone)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>AtmosphereEnvironmentMapLight </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>intensity</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>affects_lightmapped_mesh_diffuse</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>bool</span><span>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>size</span><span style=color:#61676ccc>:</span><span> UVec2,
</span><span>}
</span></code></pre><h3 id=2-crates-bevy-pbr-src-atmosphere-environment-rs-332-0>2. <code>crates/bevy_pbr/src/atmosphere/environment.rs</code> (+332/-0)</h3><p>环境贴图核心实现：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 创建环境贴图纹理
</span><span style=color:#fa6e32>let mut</span><span> environment_image </span><span style=color:#ed9366>= </span><span>Image</span><span style=color:#ed9366>::</span><span>new_fill(
</span><span>    Extent3d { width</span><span style=color:#61676ccc>:</span><span> new_size</span><span style=color:#ed9366>.</span><span>x</span><span style=color:#61676ccc>,</span><span> height</span><span style=color:#61676ccc>:</span><span> new_size</span><span style=color:#ed9366>.</span><span>y</span><span style=color:#61676ccc>,</span><span> depth_or_array_layers</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>6 </span><span>}</span><span style=color:#61676ccc>,
</span><span>    TextureDimension</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>D2</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#ed9366>&</span><span>[</span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>; </span><span style=color:#ff8f40>8</span><span>]</span><span style=color:#61676ccc>,
</span><span>    TextureFormat</span><span style=color:#ed9366>::</span><span>Rgba16Float</span><span style=color:#61676ccc>,
</span><span>    RenderAssetUsages</span><span style=color:#ed9366>::</span><span>all()</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 计算着色器调度
</span><span>pass</span><span style=color:#ed9366>.</span><span style=color:#f07171>dispatch_workgroups</span><span>(
</span><span>    env_map_light</span><span style=color:#ed9366>.</span><span>size</span><span style=color:#ed9366>.</span><span>x </span><span style=color:#ed9366>/ </span><span style=color:#ff8f40>8</span><span style=color:#61676ccc>,
</span><span>    env_map_light</span><span style=color:#ed9366>.</span><span>size</span><span style=color:#ed9366>.</span><span>y </span><span style=color:#ed9366>/ </span><span style=color:#ff8f40>8</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#ff8f40>6 </span><span style=color:#abb0b6;font-style:italic>// 6 cubemap faces
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=3-crates-bevy-pbr-src-atmosphere-environment-wgsl-37-0>3. <code>crates/bevy_pbr/src/atmosphere/environment.wgsl</code> (+37/-0)</h3><p>环境贴图计算着色器：<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>@compute @workgroup_size(8, 8, 1)
</span><span>fn main(@builtin(global_invocation_id) global_id: vec3&LTu32>) {
</span><span>    let ray_dir_ws = sample_cube_dir(uv, slice_index);
</span><span>    let inscattering = sample_sky_view_lut(r, ray_dir_as);
</span><span>    textureStore(output, vec2&LTi32>(global_id.xy), i32(slice_index), vec4(inscattering, 1.0));
</span><span>}
</span></code></pre><h3 id=4-crates-bevy-pbr-src-atmosphere-mod-rs-21-2>4. <code>crates/bevy_pbr/src/atmosphere/mod.rs</code> (+21/-2)</h3><p>集成到大气系统：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(Update</span><span style=color:#61676ccc>,</span><span> prepare_atmosphere_probe_components)
</span><span>   </span><span style=color:#ed9366>.</span><span>add_render_graph_node</span><span style=color:#ed9366>::</span><span>&LTEnvironmentNode>(Core3d</span><span style=color:#61676ccc>, </span><span>AtmosphereNode</span><span style=color:#ed9366>::</span><span>Environment)
</span></code></pre><h3 id=5-crates-bevy-pbr-src-atmosphere-render-sky-wgsl-5-1>5. <code>crates/bevy_pbr/src/atmosphere/render_sky.wgsl</code> (+5/-1)</h3><p>修复曝光处理：<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// 之前
</span><span>inscattering += sun_radiance * transmittance * view.exposure;
</span><span>
</span><span>// 之后
</span><span>inscattering += sun_radiance * transmittance;
</span><span>inscattering *= view.exposure;
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://learnopengl.com/PBR/IBL target=_blank>基于图像照明(IBL)原理</a><li><a rel="noopener nofollow noreferrer" href=https://www.w3.org/TR/WGSL/#compute-shaders target=_blank>WGSL 计算着色器规范</a><li><a rel="noopener nofollow noreferrer" href=https://jaxry.github.io/panorama-to-cubemap/ target=_blank>立方体贴图技术</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-08/pr_20529.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>