<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20765 Fix viewport_to_world for orthographic cameras and add regression tests
        
    </title><meta content="#20765 Fix viewport_to_world for orthographic cameras and add regression tests" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-08/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-08-26</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-08/pr-20765-zh-cn-20250826>中文</a></div></div><div class=pr-content><h1 id=fix-viewport-to-world-for-orthographic-cameras-and-add-regression-tests>Fix viewport_to_world for orthographic cameras and add regression tests</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix viewport_to_world for orthographic cameras and add regression tests<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20765<li><strong>Author</strong>: atlv24<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, S-Ready-For-Final-Review, P-Regression, D-Straightforward<li><strong>Created</strong>: 2025-08-26T16:34:20Z<li><strong>Merged</strong>: 2025-08-26T20:52:58Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Fixes #20762</ul><h2 id=solution>Solution</h2><ul><li>Orthographic directions behave differently, and need the point-difference. We can still avoid the matrix compose and world translation precision losses though.</ul><h2 id=testing>Testing</h2><ul><li>Added regression tests</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a bug in the <code>viewport_to_world</code> method for orthographic cameras that was causing incorrect ray calculations. The issue stemmed from how the method handled near and far plane calculations differently between perspective and orthographic projections.<p>The core problem was in the mathematical approach used to compute the world-space ray direction. For perspective cameras, the direction calculation works correctly by transforming a single point from view space to world space. However, orthographic projections require calculating the difference between two points (near and far planes) to determine the proper direction vector.<p>The original implementation attempted to optimize precision by avoiding matrix composition and maintaining separate transformations, but it didn’t account for the fundamental difference in how orthographic projections work compared to perspective projections. This led to incorrect ray directions being returned for orthographic cameras.<p>The solution maintains the precision optimizations while correctly handling both projection types. Instead of trying to derive the direction from a single point, the fix calculates both near and far points in view space, computes their difference to get the proper direction vector, and then transforms both components to world space separately.<p>Key technical aspects of the fix:<ol><li>Calculates both near (Z=1.0) and far (Z=EPSILON) points in NDC space<li>Transforms both points to view space using the inverse clip-from-view matrix<li>Computes the direction vector in view space before transforming to world space<li>Maintains precision by avoiding unnecessary matrix compositions</ol><p>The PR also adds comprehensive regression tests that verify correct behavior for both orthographic 2D, orthographic 3D, and perspective projections. These tests ensure that:<ul><li>Ray directions match the camera’s forward vector<li>Ray origins are correctly positioned based on viewport coordinates<li>Both corner cases (viewport coordinates at 0,0 and maximum values) work correctly</ul><h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Viewport Coordinates] --> B[Convert to NDC]
</span><span>    B --> C[Calculate Near/Far Points]
</span><span>    C --> D[Transform to View Space]
</span><span>    D --> E[Compute Direction Vector]
</span><span>    E --> F[Transform to World Space]
</span><span>    F --> G[Return Ray3d]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-camera-src-camera-rs-103-19><code>crates/bevy_camera/src/camera.rs</code> (+103/-19)</h3><p>This file contains the main fix for the orthographic camera bug and adds comprehensive regression tests.<p><strong>Key changes to the viewport_to_world method:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let mut</span><span> rect_relative </span><span style=color:#ed9366>= </span><span>(viewport_position </span><span style=color:#ed9366>-</span><span> target_rect</span><span style=color:#ed9366>.</span><span>min) </span><span style=color:#ed9366>/</span><span> target_rect</span><span style=color:#ed9366>.</span><span style=color:#f07171>size</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// Flip the Y co-ordinate origin from the top to the bottom.
</span><span>rect_relative</span><span style=color:#ed9366>.</span><span>y </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>1.0 </span><span style=color:#ed9366>-</span><span> rect_relative</span><span style=color:#ed9366>.</span><span>y</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>let</span><span> ndc_point_near </span><span style=color:#ed9366>= </span><span>(rect_relative </span><span style=color:#ed9366>* </span><span style=color:#ff8f40>2. </span><span style=color:#ed9366>- </span><span>Vec2</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ONE</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend</span><span>(</span><span style=color:#ff8f40>1.0</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// ... single point transformation logic
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> rect_relative </span><span style=color:#ed9366>= </span><span>(viewport_position </span><span style=color:#ed9366>-</span><span> target_rect</span><span style=color:#ed9366>.</span><span>min) </span><span style=color:#ed9366>/</span><span> target_rect</span><span style=color:#ed9366>.</span><span style=color:#f07171>size</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let mut</span><span> ndc_xy </span><span style=color:#ed9366>=</span><span> rect_relative </span><span style=color:#ed9366>* </span><span style=color:#ff8f40>2. </span><span style=color:#ed9366>- </span><span>Vec2</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ONE</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// Flip the Y co-ordinate from the top to the bottom to enter NDC.
</span><span>ndc_xy</span><span style=color:#ed9366>.</span><span>y </span><span style=color:#ed9366>= -</span><span>ndc_xy</span><span style=color:#ed9366>.</span><span>y</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>let</span><span> ndc_point_near </span><span style=color:#ed9366>=</span><span> ndc_xy</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend</span><span>(</span><span style=color:#ff8f40>1.0</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// Using EPSILON because an ndc with Z = 0 returns NaNs.
</span><span style=color:#fa6e32>let</span><span> ndc_point_far </span><span style=color:#ed9366>=</span><span> ndc_xy</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend</span><span>(</span><span style=color:#fa6e32>f32</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>EPSILON</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> view_from_clip </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>computed</span><span style=color:#ed9366>.</span><span>clip_from_view</span><span style=color:#ed9366>.</span><span style=color:#f07171>inverse</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> world_from_view </span><span style=color:#ed9366>=</span><span> camera_transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>affine</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// ... dual point transformation logic
</span></code></pre><p><strong>Regression tests added:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>viewport_to_world_orthographic_3d_returns_forward</span><span>() {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Tests both viewport corners for orthographic 3D
</span><span>}
</span><span>
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>viewport_to_world_orthographic_2d_returns_forward</span><span>() {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Tests both viewport corners for orthographic 2D
</span><span>}
</span><span>
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>viewport_to_world_perspective_center_returns_forward</span><span>() {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Tests center viewport point for perspective
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_camera/latest/bevy_camera/ target=_blank>Bevy Camera Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/3D_projection#Orthographic_projection target=_blank>Orthographic vs Perspective Projection</a><li><a rel="noopener nofollow noreferrer" href=https://learnopengl.com/Getting-started/Coordinate-Systems target=_blank>Coordinate Systems in Computer Graphics</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-08/pr_20765.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>