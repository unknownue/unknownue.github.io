<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20783 set uv_transform in pbr_input_from_standard_material
        
    </title><meta content="#20783 set uv_transform in pbr_input_from_standard_material" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-08/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-08-28</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-08/pr-20783-zh-cn-20250828>中文</a></div></div><div class=pr-content><h1 id=title-set-uv-transform-in-pbr-input-from-standard-material>Title: set uv_transform in pbr_input_from_standard_material</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: set uv_transform in pbr_input_from_standard_material<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20783<li><strong>Author</strong>: ChristopherBiscardi<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-08-28T13:44:50Z<li><strong>Merged</strong>: 2025-08-28T16:54:05Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>Previously, even though the <code>uv_transform</code> was being accessed correctly from the material bindings; that information was not being passed on in the constructed <code>pbr_input</code> from <code>pbr_input_from_standard_material</code>. This led to a situation where the <code>StandardMaterial</code> textures would properly have the <code>StandardMaterial::uv_transform</code> applied, but the <code>pbr_input.material.uv_transform</code> value was the default instead of the material’s. In turn this leads to any textures in a material extension using the wrong uvs, unless the value was accessed from the bindings directly instead of the pbr_input struct.<h2 id=testing>Testing</h2><p>Given an Affine2 supplied to a StandardMaterial in an extension, such as this one from the bevy examples<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>MeshMaterial3d(materials</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(ExtendedMaterial {
</span><span>    base</span><span style=color:#61676ccc>:</span><span> StandardMaterial {
</span><span>        uv_transform</span><span style=color:#61676ccc>: </span><span>Affine2</span><span style=color:#ed9366>::</span><span>from_scale(
</span><span>            Vec2</span><span style=color:#ed9366>::</span><span>splat(</span><span style=color:#ff8f40>4.</span><span>)</span><span style=color:#61676ccc>,
</span><span>        )</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#ed9366>..</span><span style=color:#55b4d4;font-style:italic>Default</span><span style=color:#ed9366>::</span><span>default()
</span><span>    }</span><span style=color:#61676ccc>,
</span><span>    extension</span><span style=color:#61676ccc>: </span><span>MyExtension</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ff8f40>1</span><span>)</span><span style=color:#61676ccc>,
</span><span>}))</span><span style=color:#61676ccc>,
</span></code></pre><p>Previously, accessing the uv_transform from the pbr_input would result in the default being used, which fills one full cube face. Accessing from the bindings correctly uses the uv_transform and shows 4 boxes.<pre style=color:#61676c;background-color:#fafafa><code><span>    // correct
</span><span>    // let uv = (bevy_pbr::pbr_bindings::material.uv_transform * vec3(in.uv, 1.0)).xy;
</span><span>    // incorrect
</span><span>    let uv = (pbr_input.material.uv_transform * vec3(in.uv, 1.0)).xy;
</span><span>
</span><span>    pbr_input.material.base_color = vec4(uv % 1., 0., 1.);
</span></code></pre><img alt="screenshot-2025-08-28-at-06 29 33@2x" height=1496 src=https://github.com/user-attachments/assets/e6d843a6-f83b-43a4-aea1-53574f3855a0 width=2560><img alt="screenshot-2025-08-28-at-06 29 41@2x" height=1496 src=https://github.com/user-attachments/assets/e331747c-316a-48ad-be90-e649ca1ca7bf width=2560><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a consistency issue in Bevy’s PBR rendering pipeline where material extensions were receiving incorrect UV transformation data. The problem occurred in the <code>pbr_input_from_standard_material</code> function within the fragment shader, which constructs the PBR input data structure used throughout the rendering process.<p>The core issue was that while the material bindings correctly provided the UV transform value from the StandardMaterial, this value wasn’t being propagated to the <code>pbr_input.material.uv_transform</code> field. This created an inconsistency where StandardMaterial textures would render correctly with the proper UV transformations, but any material extensions relying on <code>pbr_input.material.uv_transform</code> would receive default values instead of the actual material transformations.<p>The solution was straightforward but critical: add a single line of code to copy the UV transform value from the material bindings to the PBR input structure. This ensures that both standard materials and material extensions operate with consistent UV transformation data throughout the rendering pipeline.<p>The implementation demonstrates an important principle in graphics programming: data consistency across different stages of the rendering pipeline is essential for correct visual output. Even when data is available in one part of the system, it must be properly propagated to all dependent components to maintain coherence.<p>This fix has significant impact for developers using material extensions in Bevy, as it ensures that UV transformations work consistently across both standard materials and extended materials. The change eliminates the need for workarounds where developers had to directly access material bindings instead of using the provided PBR input structure.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[StandardMaterial.uv_transform] --> B[Material Bindings]
</span><span>    B --> C[pbr_input_from_standard_material]
</span><span>    C --> D[pbr_input.material.uv_transform]
</span><span>    D --> E[Material Extensions]
</span><span>    C --> F[Standard Material Rendering]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-pbr-src-render-pbr-fragment-wgsl-2-0><code>crates/bevy_pbr/src/render/pbr_fragment.wgsl</code> (+2/-0)</h3><p>This WGSL shader file contains the function <code>pbr_input_from_standard_material</code> that constructs the PBR input data structure. The change ensures the UV transform value from material bindings is properly assigned to the PBR input structure.<p><strong>Key modification:</strong><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>fn pbr_input_from_standard_material(
</span><span>    // ... existing code ...
</span><span>) -> PbrInput {
</span><span>    // ... existing code ...
</span><span>#ifdef BINDLESS
</span><span>    let uv_transform = pbr_bindings::material.uv_transform;
</span><span>#endif  // BINDLESS
</span><span>
</span><span>    // UV transform was not being assigned to pbr_input
</span><span>#ifdef VERTEX_UVS_A
</span><span>    var uv = (uv_transform * vec3(in.uv, 1.0)).xy;
</span><span>#endif
</span><span>    // ... rest of function ...
</span><span>}
</span><span>
</span><span>// After:
</span><span>fn pbr_input_from_standard_material(
</span><span>    // ... existing code ...
</span><span>) -> PbrInput {
</span><span>    // ... existing code ...
</span><span>#ifdef BINDLESS
</span><span>    let uv_transform = pbr_bindings::material.uv_transform;
</span><span>#endif  // BINDLESS
</span><span>
</span><span>    pbr_input.material.uv_transform = uv_transform;
</span><span>
</span><span>#ifdef VERTEX_UVS_A
</span><span>    var uv = (uv_transform * vec3(in.uv, 1.0)).xy;
</span><span>#endif
</span><span>    // ... rest of function ...
</span><span>}
</span></code></pre><p>The added line <code>pbr_input.material.uv_transform = uv_transform;</code> ensures that the UV transform value from the material bindings is properly propagated to the PBR input structure, making it available to material extensions.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/books/introduction/3d-rendering/materials/ target=_blank>Bevy PBR Materials Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://gpuweb.github.io/gpuweb/wgsl/ target=_blank>WGSL Shader Language Specification</a><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/UV_mapping target=_blank>UV Mapping and Transformations in Computer Graphics</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/books/introduction/3d-rendering/material-extensions/ target=_blank>Bevy Material Extensions Guide</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-08/pr_20783.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>