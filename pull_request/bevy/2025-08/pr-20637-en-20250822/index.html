<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20637 Text2d feature-gate
        
    </title><meta content="#20637 Text2d feature-gate" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-08/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-08-22</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-08/pr-20637-zh-cn-20250822>中文</a></div></div><div class=pr-content><h1 id=text2d-feature-gate>Text2d feature-gate</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Text2d feature-gate<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20637<li><strong>Author</strong>: ickshonpe<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, C-Code-Quality, S-Ready-For-Final-Review, A-Text<li><strong>Created</strong>: 2025-08-18T12:45:29Z<li><strong>Merged</strong>: 2025-08-22T22:31:05Z<li><strong>Merged By</strong>: james7132</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Add a “text2d” feature-gate to enable text rendering using <code>bevy_sprite</code> and <code>bevy_sprite_render</code>.<h2 id=solution>Solution</h2><p>Add a “text2d” default feature, and all the necessary feature gates. Made <code>bevy_window</code> an optional depedency for <code>bevy_sprite</code> again.<h2 id=testing>Testing</h2><p>The UI <code>text</code> example runs with the “text2d” feature disabled. I haven’t implemented any features like this that span multiple crates before, so needs a good second look from someone.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a dependency management issue in Bevy’s text rendering system. The core problem was that text rendering functionality was tightly coupled with sprite rendering, making it impossible to use sprites without also including text rendering capabilities. This created unnecessary bloat for users who only needed sprite functionality without text support.<p>The solution implements a feature gate system that makes text2d rendering optional across multiple crates. The approach involves modifying dependency declarations in Cargo.toml files and adding conditional compilation attributes in the Rust code.<p>The implementation starts with the root Cargo.toml, where the <code>bevy_text</code> feature is modified to remove the hard dependency on <code>bevy_sprite</code>:<pre class=language-toml data-lang=toml style=color:#61676c;background-color:#fafafa><code class=language-toml data-lang=toml><span style=color:#abb0b6;font-style:italic># Before:
</span><span style=color:#399ee6>bevy_text </span><span>= [</span><span style=color:#86b300>"bevy_internal/bevy_text"</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"bevy_asset"</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"bevy_sprite"</span><span>]
</span><span>
</span><span style=color:#abb0b6;font-style:italic># After:
</span><span style=color:#399ee6>bevy_text </span><span>= [</span><span style=color:#86b300>"bevy_internal/bevy_text"</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"bevy_asset"</span><span>]
</span></code></pre><p>In <code>bevy_internal/Cargo.toml</code>, the feature definitions are restructured to establish proper conditional dependencies:<pre class=language-toml data-lang=toml style=color:#61676c;background-color:#fafafa><code class=language-toml data-lang=toml><span style=color:#399ee6>bevy_text </span><span>= [
</span><span>  </span><span style=color:#86b300>"dep:bevy_text"</span><span style=color:#61676ccc>,
</span><span>  </span><span style=color:#86b300>"bevy_image"</span><span style=color:#61676ccc>,
</span><span>  </span><span style=color:#86b300>"bevy_sprite?/bevy_text"</span><span style=color:#61676ccc>,
</span><span>  </span><span style=color:#86b300>"bevy_sprite_render?/bevy_text"</span><span style=color:#61676ccc>,
</span><span>]
</span></code></pre><p>The key change here is the use of <code>?/</code> syntax, which means “enable this feature only if the dependency is available.” This allows for optional feature propagation.<p>In <code>bevy_sprite/Cargo.toml</code>, several dependencies are made optional and a new <code>bevy_text</code> feature is added:<pre class=language-toml data-lang=toml style=color:#61676c;background-color:#fafafa><code class=language-toml data-lang=toml><span>[</span><span style=color:#399ee6>features</span><span>]
</span><span style=color:#399ee6>bevy_sprite_picking_backend </span><span>= [</span><span style=color:#86b300>"bevy_picking"</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"bevy_window"</span><span>]
</span><span style=color:#399ee6>bevy_text </span><span>= [</span><span style=color:#86b300>"dep:bevy_text"</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"bevy_window"</span><span>]
</span><span>
</span><span>[</span><span style=color:#399ee6>dependencies</span><span>]
</span><span style=color:#399ee6>bevy_window </span><span>= { </span><span style=color:#399ee6>path </span><span>= </span><span style=color:#86b300>"../bevy_window"</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>version </span><span>= </span><span style=color:#86b300>"0.17.0-dev"</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>optional </span><span>= </span><span style=color:#ff8f40>true </span><span>}
</span><span style=color:#399ee6>bevy_text </span><span>= { </span><span style=color:#399ee6>path </span><span>= </span><span style=color:#86b300>"../bevy_text"</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>version </span><span>= </span><span style=color:#86b300>"0.17.0-dev"</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>optional </span><span>= </span><span style=color:#ff8f40>true </span><span>}
</span></code></pre><p>The Rust code in <code>bevy_sprite/src/lib.rs</code> is modified with conditional compilation attributes:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Module is conditionally compiled
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"bevy_text"</span><span>)]
</span><span style=color:#fa6e32>mod </span><span style=color:#399ee6>text2d</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Conditionally export text2d components
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"bevy_text"</span><span>)]
</span><span style=color:#fa6e32>pub use </span><span>text2d</span><span style=color:#ed9366>::*</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Systems are conditionally added
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"bevy_text"</span><span>)]
</span><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(
</span><span>    PostUpdate</span><span style=color:#61676ccc>,
</span><span>    (
</span><span>        bevy_text</span><span style=color:#ed9366>::</span><span>detect_text_needs_rerender</span><span style=color:#ed9366>::</span><span>&LTText2d></span><span style=color:#61676ccc>,
</span><span>        update_text2d_layout
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>ambiguous_with</span><span>(bevy_camera</span><span style=color:#ed9366>::</span><span>CameraUpdateSystems)
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>after</span><span>(bevy_text</span><span style=color:#ed9366>::</span><span>remove_dropped_font_atlas_sets)</span><span style=color:#61676ccc>,
</span><span>        calculate_bounds_text2d</span><span style=color:#ed9366>.</span><span style=color:#f07171>in_set</span><span>(VisibilitySystems</span><span style=color:#ed9366>::</span><span>CalculateBounds)</span><span style=color:#61676ccc>,
</span><span>    )
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>chain</span><span>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>in_set</span><span>(bevy_text</span><span style=color:#ed9366>::</span><span>Text2dUpdateSystems)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>after</span><span>(bevy_app</span><span style=color:#ed9366>::</span><span>AnimationSystems)</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><p>Similar changes are made in <code>bevy_sprite_render</code> to conditionally include text2d rendering functionality, and both <code>bevy_ui</code> and <code>bevy_ui_render</code> are updated to explicitly enable the text2d feature since UI always needs text rendering.<p>The impact of these changes is significant for users who want to optimize their build size. Projects that use sprites but don’t need text rendering can now exclude the text rendering code, reducing binary size and compile times. The changes maintain backward compatibility by keeping the feature enabled by default.<p>This implementation demonstrates effective use of Rust’s feature system for managing optional functionality in a large, modular codebase. The cross-crate coordination shows careful attention to dependency management and feature propagation.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[bevy_internal] --> B[bevy_sprite]
</span><span>    A --> C[bevy_sprite_render]
</span><span>    A --> D[bevy_text]
</span><span>    
</span><span>    B -->|optional| D
</span><span>    C -->|optional| D
</span><span>    
</span><span>    E[bevy_ui] -->|requires| B
</span><span>    F[bevy_ui_render] -->|requires| C
</span><span>    
</span><span>    style D stroke-dasharray: 5 5
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>crates/bevy_sprite/src/lib.rs</strong> (+11/-9)<ul><li>Added conditional compilation for text2d module and functionality<li>Modified system registration to be feature-gated<li>Updated import statements to use fully qualified paths</ul><p><strong>crates/bevy_internal/Cargo.toml</strong> (+9/-4)<ul><li>Restructured feature definitions for better dependency management<li>Added optional feature propagation using <code>?/</code> syntax<li>Updated dependency relationships between text, sprite, and sprite_render</ul><p><strong>crates/bevy_sprite/Cargo.toml</strong> (+4/-3)<ul><li>Made bevy_window and bevy_text dependencies optional<li>Added bevy_text feature that enables text functionality<li>Updated feature dependencies for picking backend</ul><p><strong>crates/bevy_ui_render/Cargo.toml</strong> (+4/-2)<ul><li>Explicitly enabled bevy_text feature on bevy_sprite_render dependency<li>Removed default-features = false from bevy_text dependency</ul><pre class=language-toml data-lang=toml style=color:#61676c;background-color:#fafafa><code class=language-toml data-lang=toml><span style=color:#abb0b6;font-style:italic># Before:
</span><span style=color:#399ee6>bevy_sprite_render </span><span>= { </span><span style=color:#399ee6>path </span><span>= </span><span style=color:#86b300>"../bevy_sprite_render"</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>version </span><span>= </span><span style=color:#86b300>"0.17.0-dev" </span><span>}
</span><span style=color:#399ee6>bevy_text </span><span>= { </span><span style=color:#399ee6>path </span><span>= </span><span style=color:#86b300>"../bevy_text"</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>version </span><span>= </span><span style=color:#86b300>"0.17.0-dev"</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>default-features </span><span>= </span><span style=color:#ff8f40>false </span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic># After:
</span><span style=color:#399ee6>bevy_sprite_render </span><span>= { </span><span style=color:#399ee6>path </span><span>= </span><span style=color:#86b300>"../bevy_sprite_render"</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>version </span><span>= </span><span style=color:#86b300>"0.17.0-dev"</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>features </span><span>= [
</span><span>  </span><span style=color:#86b300>"bevy_text"</span><span style=color:#61676ccc>,
</span><span>] }
</span><span style=color:#399ee6>bevy_text </span><span>= { </span><span style=color:#399ee6>path </span><span>= </span><span style=color:#86b300>"../bevy_text"</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>version </span><span>= </span><span style=color:#86b300>"0.17.0-dev" </span><span>}
</span></code></pre><p><strong>crates/bevy_ui/Cargo.toml</strong> (+3/-1)<ul><li>Explicitly enabled bevy_text feature on bevy_sprite dependency</ul><pre class=language-toml data-lang=toml style=color:#61676c;background-color:#fafafa><code class=language-toml data-lang=toml><span style=color:#abb0b6;font-style:italic># Before:
</span><span style=color:#399ee6>bevy_sprite </span><span>= { </span><span style=color:#399ee6>path </span><span>= </span><span style=color:#86b300>"../bevy_sprite"</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>version </span><span>= </span><span style=color:#86b300>"0.17.0-dev" </span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic># After:
</span><span style=color:#399ee6>bevy_sprite </span><span>= { </span><span style=color:#399ee6>path </span><span>= </span><span style=color:#86b300>"../bevy_sprite"</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>version </span><span>= </span><span style=color:#86b300>"0.17.0-dev"</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>features </span><span>= [
</span><span>  </span><span style=color:#86b300>"bevy_text"</span><span style=color:#61676ccc>,
</span><span>] }
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/cargo/reference/features.html target=_blank>The Cargo Book: Features</a> - Official documentation on Rust’s feature system<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/features/ target=_blank>Bevy Engine: Features</a> - How to use features in Bevy<li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/reference/conditional-compilation.html target=_blank>Conditional Compilation in Rust</a> - Reference for #[cfg] attributes<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/plugins/ target=_blank>Bevy’s Modular Architecture</a> - Understanding how Bevy’s plugin system works</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-08/pr_20637.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>