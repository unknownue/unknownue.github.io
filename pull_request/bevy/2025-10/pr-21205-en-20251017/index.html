<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21205 Add BindGroupLayout caching via descriptors
        
    </title><meta content="#21205 Add BindGroupLayout caching via descriptors" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-10/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-10-17</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-10/pr-21205-zh-cn-20251017>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Add BindGroupLayout caching via descriptors<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21205<li><strong>Author</strong>: Zeophlite<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, C-Code-Quality, S-Ready-For-Review<li><strong>Created</strong>: 2025-09-25T06:32:20Z<li><strong>Merged</strong>: 2025-10-17T01:21:32Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Defer creating <code>BindGroupLayout</code> by using a <code>BindGroupLayoutDescriptor</code> and cache the results<li>Unblocks <code>bevy_material</code> (render-less material definitions)<li>Blocked by https://github.com/bevyengine/bevy/pull/21533</ul><h2 id=solution>Solution</h2><ul><li>Reviewers, look at first commit for mechanism, and following for usage</ul><h2 id=testing>Testing</h2><ul><li>CI</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a fundamental optimization in Bevy’s rendering system by introducing a caching mechanism for BindGroupLayout creation. The core problem was that BindGroupLayouts were being created immediately and repeatedly throughout the codebase, leading to redundant GPU resource allocation and initialization overhead.<p>The solution centers around introducing a <code>BindGroupLayoutDescriptor</code> struct that encapsulates the information needed to create a BindGroupLayout, then deferring the actual creation until needed and caching the results. This approach transforms what was previously an immediate creation pattern into a lazy, cached pattern that significantly reduces redundant resource allocation.<p>The implementation required changes across nearly the entire rendering codebase, affecting 63 files in the crates directory. The key technical insight was that <code>BindGroupLayoutDescriptor</code> could serve as a lightweight, hashable representation of BindGroupLayout requirements, while the actual WGPU resource creation could be deferred and managed centrally through the existing <code>PipelineCache</code> system.<p>From an architectural perspective, this change introduces a clear separation between the description of resource requirements and their actual allocation. The <code>BindGroupLayoutDescriptor</code> contains only the label and entries, making it cheap to create and store compared to the actual GPU resource. The <code>PipelineCache</code> now maintains a dedicated cache for BindGroupLayouts, keyed by their descriptors, ensuring that identical layouts are only created once.<p>The impact of these changes is substantial. By eliminating redundant BindGroupLayout creation, the system reduces GPU memory usage and initialization overhead. More importantly, this change enables future work on render-less material definitions in <code>bevy_material</code> by providing a more flexible and cache-friendly way to manage binding layouts.<p>One of the key engineering decisions was to integrate the caching directly into the existing <code>PipelineCache</code> rather than creating a separate cache system. This leverages existing infrastructure and ensures that BindGroupLayout lifetimes are properly managed alongside pipelines. The implementation also maintains backward compatibility by preserving the same API surface for most use cases, with the main change being that bind group creation now requires access to the pipeline cache.<p>The changes demonstrate a clear pattern for optimizing GPU resource management in graphics engines: describe resources declaratively, defer creation until needed, and cache aggressively. This approach aligns with modern graphics API best practices and sets the foundation for more advanced material and rendering features in Bevy.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TB
</span><span>    A[BindGroupLayoutDescriptor] --> B[PipelineCache]
</span><span>    B --> C[BindGroupLayout Cache]
</span><span>    C --> D[Actual BindGroupLayout]
</span><span>    E[Render Pipeline] --> B
</span><span>    F[Compute Pipeline] --> B
</span><span>    G[Material System] --> A
</span><span>    H[Post-processing] --> A
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-render-src-render-resource-pipeline-cache-rs-53-2><code>crates/bevy_render/src/render_resource/pipeline_cache.rs</code> (+53/-2)</h3><p>This file contains the core caching mechanism implementation. The key change is the addition of a <code>BindGroupLayoutCache</code> that stores BindGroupLayouts keyed by their descriptors.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// New cache structure
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Default)]
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>BindGroupLayoutCache </span><span>{
</span><span>    bgls</span><span style=color:#61676ccc>: </span><span>HashMap&LTBindGroupLayoutDescriptor, BindGroupLayout>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// New method in PipelineCache
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>get_bind_group_layout</span><span>(
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>,
</span><span>    </span><span style=color:#ff8f40>bind_group_layout_descriptor</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>BindGroupLayoutDescriptor,
</span><span>) </span><span style=color:#61676ccc>-></span><span> BindGroupLayout {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>bindgroup_layout_cache
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>lock</span><span>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>device</span><span style=color:#61676ccc>,</span><span> bind_group_layout_descriptor</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>())
</span><span>}
</span></code></pre><h3 id=crates-bevy-render-src-render-resource-pipeline-rs><code>crates/bevy_render/src/render_resource/pipeline.rs</code></h3><p>Introduced the <code>BindGroupLayoutDescriptor</code> struct that replaces direct <code>BindGroupLayout</code> usage in pipeline descriptors:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// New descriptor type
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Clone</span><span style=color:#61676ccc>,</span><span> Debug</span><span style=color:#61676ccc>,</span><span> PartialEq</span><span style=color:#61676ccc>,</span><span> Eq</span><span style=color:#61676ccc>,</span><span> Hash</span><span style=color:#61676ccc>,</span><span> Default)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>BindGroupLayoutDescriptor </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>label</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTCow<</span><span style=color:#fa6e32>'static</span><span>, </span><span style=color:#fa6e32>str</span><span>>>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>entries</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Vec</span><span>&LTBindGroupLayoutEntry>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Updated pipeline descriptors
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>RenderPipelineDescriptor </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>layout</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Vec</span><span>&LTBindGroupLayoutDescriptor>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>}
</span><span>
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>ComputePipelineDescriptor </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>layout</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Vec</span><span>&LTBindGroupLayoutDescriptor>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>}
</span></code></pre><h3 id=crates-bevy-pbr-src-material-rs-85-61><code>crates/bevy_pbr/src/material.rs</code> (+85/-61)</h3><p>Updated the material system to use descriptors and pipeline cache:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Immediate BindGroupLayout creation
</span><span style=color:#fa6e32>let</span><span> material_layout </span><span style=color:#ed9366>= </span><span>M</span><span style=color:#ed9366>::</span><span>bind_group_layout(render_device)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Descriptor-based with caching
</span><span style=color:#fa6e32>let</span><span> material_layout </span><span style=color:#ed9366>= </span><span>M</span><span style=color:#ed9366>::</span><span>bind_group_layout_descriptor(render_device)</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> actual_material_layout </span><span style=color:#ed9366>=</span><span> pipeline_cache</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_bind_group_layout</span><span>(</span><span style=color:#ed9366>&</span><span>material_layout)</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-pbr-src-render-mesh-bindings-rs-47-35><code>crates/bevy_pbr/src/render/mesh_bindings.rs</code> (+47/-35)</h3><p>Updated mesh binding layouts to use descriptors:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Direct layout creation
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>model_only</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>render_device</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>RenderDevice, </span><span style=color:#ff8f40>model</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>BindingResource) </span><span style=color:#61676ccc>-></span><span> BindGroup {
</span><span>    render_device</span><span style=color:#ed9366>.</span><span style=color:#f07171>create_bind_group</span><span>(
</span><span>        </span><span style=color:#86b300>"model_only_mesh_bind_group"</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#ed9366>&</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>model_only</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#ed9366>&</span><span>[entry</span><span style=color:#ed9366>::</span><span>model(</span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>,</span><span> model</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>())]</span><span style=color:#61676ccc>,
</span><span>    )
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Using pipeline cache
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>model_only</span><span>(
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>,
</span><span>    </span><span style=color:#ff8f40>render_device</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>RenderDevice,
</span><span>    </span><span style=color:#ff8f40>pipeline_cache</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>PipelineCache,
</span><span>    </span><span style=color:#ff8f40>model</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>BindingResource,
</span><span>) </span><span style=color:#61676ccc>-></span><span> BindGroup {
</span><span>    render_device</span><span style=color:#ed9366>.</span><span style=color:#f07171>create_bind_group</span><span>(
</span><span>        </span><span style=color:#86b300>"model_only_mesh_bind_group"</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#ed9366>&</span><span>pipeline_cache</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_bind_group_layout</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>model_only)</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#ed9366>&</span><span>[entry</span><span style=color:#ed9366>::</span><span>model(</span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>,</span><span> model</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>())]</span><span style=color:#61676ccc>,
</span><span>    )
</span><span>}
</span></code></pre><h3 id=crates-bevy-anti-alias-src-smaa-mod-rs-54-40><code>crates/bevy_anti_alias/src/smaa/mod.rs</code> (+54/-40)</h3><p>Updated anti-aliasing system to use the new descriptor pattern:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Immediate layout creation
</span><span style=color:#fa6e32>let</span><span> postprocess_bind_group_layout </span><span style=color:#ed9366>=</span><span> render_device</span><span style=color:#ed9366>.</span><span style=color:#f07171>create_bind_group_layout</span><span>(
</span><span>    </span><span style=color:#86b300>"SMAA postprocess bind group layout"</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#ed9366>&</span><span>BindGroupLayoutEntries</span><span style=color:#ed9366>::</span><span>sequential(</span><span style=color:#abb0b6;font-style:italic>/* ... */</span><span>)</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Descriptor creation  
</span><span style=color:#fa6e32>let</span><span> postprocess_bind_group_layout </span><span style=color:#ed9366>= </span><span>BindGroupLayoutDescriptor</span><span style=color:#ed9366>::</span><span>new(
</span><span>    </span><span style=color:#86b300>"SMAA postprocess bind group layout"</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#ed9366>&</span><span>BindGroupLayoutEntries</span><span style=color:#ed9366>::</span><span>sequential(</span><span style=color:#abb0b6;font-style:italic>/* ... */</span><span>)</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://gpuweb.github.io/gpuweb/#gpubindgrouplayout target=_blank>WebGPU Bind Group Layout Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_render/latest/bevy_render/render_resource/struct.RenderPipeline.html target=_blank>Bevy Render Pipeline Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/gfx-rs/wgpu/wiki/Resource-Management target=_blank>GPU Resource Management Patterns</a><li><a rel="noopener nofollow noreferrer" href=https://alain.xyz/blog/descriptor-management target=_blank>Descriptor-Based Resource Management in Modern Graphics APIs</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-10/pr_21205.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>