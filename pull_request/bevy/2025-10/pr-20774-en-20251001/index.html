<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20774 Split `AnimationTarget` into two components
        
    </title><meta content="#20774 Split `AnimationTarget` into two components" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-10/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-10-01</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-10/pr-20774-zh-cn-20251001>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Split <code>AnimationTarget</code> into two components<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20774<li><strong>Author</strong>: greeble-dev<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Feature, S-Ready-For-Final-Review, A-Animation, M-Needs-Migration-Guide, D-Complex, X-Contentious<li><strong>Created</strong>: 2025-08-27T08:33:19Z<li><strong>Merged</strong>: 2025-10-01T19:54:59Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>The original description is in English, so it is included exactly as-is:<h2 id=objective>Objective</h2><p>Add flexibility by refactoring <code>AnimationTarget</code> into two separate components. This will smooth the path for future animation features.<h2 id=background>Background</h2><p><code>bevy_animation</code> animates entities by assigning them <code>AnimationTarget</code> components:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>struct </span><span style=color:#399ee6>AnimationTarget </span><span>{
</span><span>    player</span><span style=color:#61676ccc>:</span><span> Entity,
</span><span>    id</span><span style=color:#61676ccc>:</span><span> AnimationTargetId,
</span><span>}
</span></code></pre><ul><li><code>player: Entity</code> links to an entity that contains an <code>AnimationPlayer</code> component. An <code>AnimationPlayer</code> plays <code>AnimationClip</code> assets.<li><code>id: AnimationTargetId</code> identifies which tracks in an <code>AnimationClip</code> apply to the target entity.</ul><p>When loading a glTF these components are automatically created. They can also be created manually.<h2 id=problem>Problem</h2><p>The two parts of <code>AnimationTarget</code> often go together but sometimes would be better separated:<ol><li>I might want to calculate the <code>AnimationTargetId</code> first, but not link it up to an <code>AnimationPlayer</code> until later (see #18262 for an example).<li>I might want to use <code>AnimationTargetId</code> but not use <code>AnimationPlayer</code> - maybe I’ve got a different component that plays <code>AnimationClip</code>s.</ol><p>In theory <code>player</code> could be left as <code>Entity::PLACEHOLDER</code>, but that’s messy and will trigger a warning in <code>animate_targets</code>.<h2 id=solution>Solution</h2><p>This PR splits <code>AnimationTarget</code> into two components:<ol><li><code>AnimationTargetId</code> is just the original struct with a component derive.<li><code>AnimationPlayerTarget</code> is a new unit struct <code>(Entity)</code>.</ol><p>I’m not convinced <code>AnimationPlayerTarget</code> is a good name, but it does fit the usual source/target naming for entity relationships. <code>AnimationPlayerRef</code> was another candidate.<p><code>AnimationPlayerTarget</code> could be a relationship target, but there would be a performance cost from making <code>AnimationPlayer</code> a relationship source. Maybe it’s still a good idea, but that’s probably best left to another PR.<h3 id=performance>Performance</h3><p>Profiled on <code>many_foxes</code> - difference was negligible.<h3 id=testing>Testing</h3><p>Examples <code>animated_mesh</code>, <code>animated_transform</code>, <code>animated_ui</code>, <code>animation_masks</code>, <code>eased_motion</code>, <code>scene_viewer</code>.<h2 id=future>Future</h2><p>If this PR lands then I’ll probably file a follow up that adds more flexibility to the the glTF loader creation of <code>AnimationTargetId</code> and <code>AnimationPlayer</code>. This will help #18262 and enable some other features.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a fundamental architectural limitation in Bevy’s animation system. The original <code>AnimationTarget</code> component bundled two distinct concerns: target identification and player linkage. While this worked for basic cases, it created friction for more advanced animation workflows.<p>The core problem was that <code>AnimationTarget</code> combined two separate responsibilities:<ol><li><strong>Target Identification</strong>: The <code>AnimationTargetId</code> field identified which animation curves from an <code>AnimationClip</code> should apply to this entity<li><strong>Player Linkage</strong>: The <code>player</code> field specified which <code>AnimationPlayer</code> entity should drive the animation</ol><p>In practice, these two concerns often need to be managed independently. Developers might want to assign target IDs during asset loading but defer player assignment until runtime. Alternatively, they might want to use custom animation systems that don’t rely on <code>AnimationPlayer</code> at all.<p>The solution involved a clean separation of concerns. The team split <code>AnimationTarget</code> into two dedicated components:<ul><li><code>AnimationTargetId</code>: Now a standalone component that identifies which animation curves apply<li><code>AnimatedBy</code>: A new component that links to the controlling <code>AnimationPlayer</code></ul><p>This change required updating the core animation system to query for both components. The <code>animate_targets</code> system now looks for entities that have both an <code>AnimationTargetId</code> (identifying which curves to apply) and an <code>AnimatedBy</code> component (specifying which player drives the animation).<p>The implementation maintained backward compatibility through careful migration of all examples and internal systems. The glTF loader, which automatically creates animation targets during asset import, was updated to insert both components instead of the single <code>AnimationTarget</code>.<p>Performance testing showed negligible impact, which was expected since the change primarily affected component composition rather than algorithmic complexity. The team tested multiple animation examples to ensure the refactor didn’t break existing functionality.<p>This refactor opens up several future possibilities:<ul><li>Deferred player assignment for dynamic animation systems<li>Custom animation players that don’t use the standard <code>AnimationPlayer</code> component<li>More flexible animation retargeting workflows<li>Better support for runtime bone addition/removal</ul><p>The migration guide provides clear instructions for updating existing code, replacing single <code>AnimationTarget</code> components with tuples containing both new components.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[AnimationPlayer] --> B[AnimatedBy]
</span><span>    B --> C[AnimationTargetId]
</span><span>    C --> D[AnimationClip]
</span><span>    
</span><span>    E[Entity] --> C
</span><span>    E --> B
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-animation-src-lib-rs-46-55><code>crates/bevy_animation/src/lib.rs</code> (+46/-55)</h3><p>This is the core animation system where the component split was implemented. The changes include:<ol><li><strong>Component Definition</strong>: <code>AnimationTarget</code> was removed and replaced with two separate components<li><strong>System Updates</strong>: The <code>animate_targets</code> system was updated to query for both components<li><strong>Type Aliases</strong>: Updated <code>AnimationEntityMut</code> to exclude the new components</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Clone</span><span style=color:#61676ccc>,</span><span> Copy</span><span style=color:#61676ccc>,</span><span> Component</span><span style=color:#61676ccc>,</span><span> Reflect)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>AnimationTarget </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>id</span><span style=color:#61676ccc>:</span><span> AnimationTargetId,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>player</span><span style=color:#61676ccc>:</span><span> Entity,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Clone</span><span style=color:#61676ccc>,</span><span> Copy</span><span style=color:#61676ccc>,</span><span> Component</span><span style=color:#61676ccc>,</span><span> Reflect</span><span style=color:#61676ccc>,</span><span> Debug)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>AnimatedBy</span><span>(#[entities] pub Entity)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// AnimationTargetId is now a component:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Clone</span><span style=color:#61676ccc>,</span><span> Copy</span><span style=color:#61676ccc>,</span><span> PartialEq</span><span style=color:#61676ccc>,</span><span> Eq</span><span style=color:#61676ccc>,</span><span> PartialOrd</span><span style=color:#61676ccc>,</span><span> Ord</span><span style=color:#61676ccc>,</span><span> Reflect</span><span style=color:#61676ccc>,</span><span> Debug</span><span style=color:#61676ccc>,</span><span> Serialize</span><span style=color:#61676ccc>,</span><span> Deserialize</span><span style=color:#61676ccc>,</span><span> Component)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>AnimationTargetId</span><span>(pub Uuid)</span><span style=color:#61676ccc>;
</span></code></pre><p>The system query was updated from:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>mut</span><span> targets</span><span style=color:#61676ccc>: </span><span>Query<(Entity, </span><span style=color:#ed9366>&</span><span>AnimationTarget, AnimationEntityMut)>
</span></code></pre><p>to:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>mut</span><span> targets</span><span style=color:#61676ccc>: </span><span>Query<(Entity, </span><span style=color:#ed9366>&</span><span>AnimationTargetId, </span><span style=color:#ed9366>&</span><span>AnimatedBy, AnimationEntityMut)>
</span></code></pre><h3 id=release-content-migration-guides-animation-target-refactor-md-23-0><code>release-content/migration-guides/animation-target-refactor.md</code> (+23/-0)</h3><p>This new file provides migration instructions for users upgrading their code:<pre class=language-markdown data-lang=markdown style=color:#61676c;background-color:#fafafa><code class=language-markdown data-lang=markdown><span>The </span><span style=color:#ed9366;background-color:#61676c10>`AnimationTarget`</span><span> component has been split into two separate components.
</span><span style=color:#ed9366;background-color:#61676c10>`AnimationTarget::id`</span><span> is now an </span><span style=color:#ed9366;background-color:#61676c10>`AnimationTargetId`</span><span> component, and
</span><span style=color:#ed9366;background-color:#61676c10>`AnimationTarget::player`</span><span> is now an </span><span style=color:#ed9366;background-color:#61676c10>`AnimatedBy`</span><span> component.
</span><span>
</span><span>Before:
</span><span>```</span><span style=color:#ff8f40>rust
</span><span style=color:#61676c;background-color:#61676c07>entity</span><span style=color:#ed9366;background-color:#61676c07>.</span><span style=color:#f07171;background-color:#61676c07>insert</span><span style=color:#61676c;background-color:#61676c07>(AnimationTarget { id</span><span style=color:#61676ccc;background-color:#61676c07>:</span><span style=color:#61676c;background-color:#61676c07> AnimationTargetId(id)</span><span style=color:#61676ccc;background-color:#61676c07>,</span><span style=color:#61676c;background-color:#61676c07> player</span><span style=color:#61676ccc;background-color:#61676c07>:</span><span style=color:#61676c;background-color:#61676c07> player_entity })</span><span style=color:#61676ccc;background-color:#61676c07>;
</span></code></pre><p>After:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>entity</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>((AnimationTargetId(id)</span><span style=color:#61676ccc>,</span><span> AnimatedBy(player_entity)))</span><span style=color:#61676ccc>;
</span></code></pre><pre style=color:#61676c;background-color:#fafafa><code><span>
</span><span>### `crates/bevy_gltf/src/loader/mod.rs` (+5/-5)
</span><span>
</span><span>The glTF loader was updated to create both components instead of the single `AnimationTarget`:
</span><span>
</span><span>```rust
</span><span>// Before:
</span><span>node.insert(AnimationTarget {
</span><span>    id: AnimationTargetId::from_names(animation_context.path.iter()),
</span><span>    player: animation_context.root,
</span><span>});
</span><span>
</span><span>// After:
</span><span>node.insert((
</span><span>    AnimationTargetId::from_names(animation_context.path.iter()),
</span><span>    AnimatedBy(animation_context.root),
</span><span>));
</span></code></pre><h3 id=example-files>Example Files</h3><p>Multiple example files were updated to use the new component structure:<p><strong><code>examples/animation/animated_transform.rs</code></strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>AnimationTarget {
</span><span>    id</span><span style=color:#61676ccc>:</span><span> planet_animation_target_id</span><span style=color:#61676ccc>,
</span><span>    player</span><span style=color:#61676ccc>:</span><span> planet_entity</span><span style=color:#61676ccc>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>(
</span><span>    planet_animation_target_id</span><span style=color:#61676ccc>,
</span><span>    AnimatedBy(planet_entity)</span><span style=color:#61676ccc>,
</span><span>)
</span></code></pre><p><strong><code>examples/animation/animation_masks.rs</code></strong>: Updated the system that removes animation components to handle both new components separately.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_animation/latest/bevy_animation/ target=_blank>Bevy Animation System Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Entity_component_system target=_blank>Entity-Component System Patterns</a><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Composition_over_inheritance target=_blank>Composition over Inheritance</a><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Universally_unique_identifier target=_blank>UUID Standard</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-10/pr_20774.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>