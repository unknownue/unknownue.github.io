<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21350 Solari: Support clear color
        
    </title><meta content="#21350 Solari: Support clear color" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-10/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-10-02</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-10/pr-21350-zh-cn-20251002>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>Solari: Support clear color<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Solari: Support clear color<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21350<li><strong>Author</strong>: JMS55<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Feature, A-Rendering, S-Ready-For-Final-View, D-Straightforward<li><strong>Created</strong>: 2025-10-02T16:14:00Z<li><strong>Merged</strong>: 2025-10-02T16:55:39Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><img alt=image height=1500 src=https://github.com/user-attachments/assets/8bd37bda-88b0-436a-9c01-a22fb63e9e87 width=2564><ul><li>ClearColor is not supported for the pathtracer still<li>Tonemapping makes the clear color appear incorrect (the above image is supposed to be pure white), which is a little wonky. That’s a separate issue though.</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a gap in Bevy’s Solari rendering system where clear color functionality was not properly supported in the real-time lighting pipeline. The core issue was that the SolariLightingNode was not respecting the clear color configuration defined by the camera, which meant background pixels weren’t being initialized with the expected clear color.<p>The problem stemmed from two related issues. First, in the compute shader (<code>restir_di.wgsl</code>), there was explicit logic that wrote black (<code>vec4(vec3(0.0), 1.0)</code>) to the output texture for pixels with zero depth (background pixels). This hardcoded behavior overrode any clear color settings. Second, the node implementation wasn’t checking if it should perform a clear operation before beginning its compute work.<p>The solution involved coordinated changes across both the Rust node implementation and the WGSL shader. In the Rust code, the node now checks if the view target has a clear load operation configured. If so, it begins a render pass specifically to perform the clear before starting the compute work. This is a more efficient approach than trying to handle clear operations within the compute shader itself.<p>The key insight here was recognizing that clear operations are fundamentally a render pass operation in graphics APIs like WebGPU, not something that should be handled manually in compute shaders. By leveraging the existing render pass infrastructure, the solution maintains consistency with Bevy’s rendering patterns while adding minimal overhead.<p>In the shader code, the fix was straightforward - simply removing the line that explicitly wrote black for background pixels. This allows the clear color (if applied) to remain visible, or if no clear was performed, the existing contents of the texture to persist.<p>One important engineering consideration was the conditional nature of the clear operation. The node only performs the clear if the view target’s load operation is configured as <code>LoadOp::Clear</code>. This ensures compatibility with other rendering pipelines that might have already cleared the target, preventing unnecessary double-clears that could impact performance.<p>The implementation demonstrates good separation of concerns - the clear operation is handled at the appropriate abstraction level (render pass operations) while the compute shader focuses solely on lighting calculations. This approach also makes the system more maintainable, as clear color behavior is now consistent with other Bevy rendering nodes.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[Camera ClearColor] --> B[SolariLightingNode]
</span><span>    B --> C[RenderPass Clear]
</span><span>    B --> D[ComputePass Lighting]
</span><span>    C --> E[ViewTarget]
</span><span>    D --> E
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-solari-src-realtime-node-rs-16-3><code>crates/bevy_solari/src/realtime/node.rs</code> (+16/-3)</h3><p>This file contains the main logic change for clear color support. The key modifications include:<ol><li>Added imports for <code>LoadOp</code> and <code>RenderPassDescriptor</code> to support render pass operations<li>Added logic to check for clear operations and execute them before compute work</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Key additions in imports
</span><span style=color:#fa6e32>use </span><span>bevy_render</span><span style=color:#ed9366>::</span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... existing imports ...
</span><span>    LoadOp</span><span style=color:#61676ccc>,</span><span> RenderPassDescriptor</span><span style=color:#61676ccc>,  </span><span style=color:#abb0b6;font-style:italic>// New imports for clear support
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other imports ...
</span><span>}</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// In the run method, after getting view_target:
</span><span style=color:#fa6e32>let</span><span> view_target </span><span style=color:#ed9366>=</span><span> view_target</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_unsampled_color_attachment</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// New clear logic before compute pass:
</span><span style=color:#fa6e32>if </span><span style=color:#f07171>matches!</span><span>(view_target</span><span style=color:#ed9366>.</span><span>ops</span><span style=color:#ed9366>.</span><span>load</span><span style=color:#61676ccc>, </span><span>LoadOp</span><span style=color:#ed9366>::</span><span>Clear(</span><span style=color:#ed9366>_</span><span>)) {
</span><span>    command_encoder</span><span style=color:#ed9366>.</span><span style=color:#f07171>begin_render_pass</span><span>(</span><span style=color:#ed9366>&</span><span>RenderPassDescriptor {
</span><span>        label</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#86b300>"solari_lighting_clear"</span><span>)</span><span style=color:#61676ccc>,
</span><span>        color_attachments</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>[</span><span style=color:#55b4d4;font-style:italic>Some</span><span>(view_target)]</span><span style=color:#61676ccc>,
</span><span>        depth_stencil_attachment</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>None</span><span style=color:#61676ccc>,
</span><span>        timestamp_writes</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>None</span><span style=color:#61676ccc>,
</span><span>        occlusion_query_set</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>None</span><span style=color:#61676ccc>,
</span><span>    })</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=crates-bevy-solari-src-realtime-restir-di-wgsl-0-1><code>crates/bevy_solari/src/realtime/restir_di.wgsl</code> (+0/-1)</h3><p>This shader file had a single line removed that was explicitly writing black to background pixels:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>if depth == 0.0 {
</span><span>    store_reservoir_a(global_id.xy, empty_reservoir());
</span><span>    textureStore(view_output, global_id.xy, vec4(vec3(0.0), 1.0));  // This line was removed
</span><span>    return;
</span><span>}
</span><span>
</span><span>// After:
</span><span>if depth == 0.0 {
</span><span>    store_reservoir_a(global_id.xy, empty_reservoir());
</span><span>    return;
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://gpuweb.github.io/gpuweb/#render-passes target=_blank>WebGPU Render Passes Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_render/latest/bevy_render/render_graph/index.html target=_blank>Bevy Render Graph Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/wgpu/latest/wgpu/enum.LoadOp.html target=_blank>LoadOp and StoreOp in Graphics APIs</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-10/pr_21350.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>