<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21387 Fixed fog contribution for point and spotlights
        
    </title><meta content="#21387 Fixed fog contribution for point and spotlights" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-10/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-10-04</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-10/pr-21387-zh-cn-20251004>中文</a></div></div><div class=pr-content><h1 id=fixed-fog-contribution-for-point-and-spotlights>Fixed fog contribution for point and spotlights</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fixed fog contribution for point and spotlights<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21387<li><strong>Author</strong>: JeroenHoogers<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-10-04T20:44:47Z<li><strong>Merged</strong>: 2025-10-04T22:55:21Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p><strong>Objective</strong><p>Fixes #21327 Volumetric fog contribution was not proportional to the light intensity for point and spotlights.<p><strong>Solution</strong><p>Take into account <code>exposure</code> value for Point and Spotlights to match the Directional light implementation.<p><strong>Testing</strong><ul><li>Run the updated <code>volumetric_fog</code> example. You can see the volumetric effect of point and spotlights now match the intensity of this light on the surfaces of the room.</ul><hr><p><strong>Showcase</strong><p>Point and spotlight intensities in the original <code>volumetric_fog</code> example were too low to light up the room despite having a very strong volumetric contribution. This update boosts the light intensity and lowers the volumetric contribution of point and spotlights<p>Before this change <code>volumetric_fog</code> example with 10x light intensity for point and spotlights: <img alt=brightness_10x_on height=1126 src=https://github.com/user-attachments/assets/7562585c-bc1b-4cbf-9d52-4ffb083d65f4 width=1922><p>After change: <img alt=brightness_10x_on_fix height=1126 src=https://github.com/user-attachments/assets/2a17fec8-0272-4c4e-9d88-d0916027a7c5 width=1922><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a specific rendering inconsistency in Bevy’s volumetric fog system. The core issue was that point lights and spotlights were producing disproportionately strong volumetric fog effects compared to their actual illumination of scene surfaces.<p>The problem stemmed from an inconsistency in how different light types handled exposure calculations in the volumetric fog shader. While directional lights properly accounted for camera exposure settings, point and spotlights were using a hardcoded scaling factor of 0.1 instead of the actual exposure value. This created a visual disconnect where lights could appear to have strong volumetric scattering in fog while barely illuminating the actual scene geometry.<p>The solution approach was straightforward: align the point and spotlight volumetric fog calculations with the existing directional light implementation. This involved replacing the magic number 0.1 with the proper <code>exposure</code> uniform variable in the shader code. The fix ensures consistent light behavior across all light types and maintains proper HDR tone mapping integration.<p>Looking at the implementation details, the key change occurs in the volumetric fog shader where the light contribution calculation is modified:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>let light_factors_per_step = fog_color * light_tint * light_attenuation *
</span><span>    scattering * density * step_size_world * light_intensity * 0.1;
</span><span>
</span><span>// After:
</span><span>let light_factors_per_step = fog_color * light_tint * light_attenuation *
</span><span>    scattering * density * step_size_world * light_intensity * exposure;
</span></code></pre><p>This change has important technical implications. By using the actual exposure value instead of a fixed constant, the volumetric fog now properly responds to camera exposure settings and maintains consistent behavior with the rest of the rendering pipeline. This is particularly important for HDR rendering workflows where exposure values can vary significantly.<p>The example updates are equally important - they demonstrate that with the corrected calculations, the light intensities needed to be increased to maintain the desired visual effect. The point light intensity was increased from 1000.0 to 10,000.0, and the spotlight from 5000.0 to 50,000.0. These adjustments show that the original example values were likely chosen to compensate for the broken volumetric calculations, and now reflect more appropriate values for the corrected implementation.<p>The impact of this fix is significant for anyone using volumetric fog with point or spotlights. It ensures that light behavior is predictable and consistent, and that artists can trust that the light intensity values they set will produce proportional results in both surface lighting and volumetric effects.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[Point Lights] --> B[Volumetric Fog Shader]
</span><span>    C[Spot Lights] --> B
</span><span>    D[Directional Lights] --> B
</span><span>    B --> E[Exposure Uniform]
</span><span>    E --> F[Consistent Light Behavior]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-pbr-src-volumetric-fog-volumetric-fog-wgsl><code>crates/bevy_pbr/src/volumetric_fog/volumetric_fog.wgsl</code></h3><p>This shader file contains the core volumetric fog calculations. The key change replaces a hardcoded scaling factor with the proper exposure uniform.<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Key change in volumetric fog calculation:
</span><span>// Before:
</span><span>let light_factors_per_step = fog_color * light_tint * light_attenuation *
</span><span>    scattering * density * step_size_world * light_intensity * 0.1;
</span><span>
</span><span>// After:
</span><span>let light_factors_per_step = fog_color * light_tint * light_attenuation *
</span><span>    scattering * density * step_size_world * light_intensity * exposure;
</span></code></pre><h3 id=examples-3d-volumetric-fog-rs><code>examples/3d/volumetric_fog.rs</code></h3><p>The example file was updated to use more appropriate light intensities that work correctly with the fixed shader calculations.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Point light intensity adjustment:
</span><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>intensity</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>1000.0</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>intensity</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>10_000.0</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Spotlight intensity adjustment:
</span><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>intensity</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>5000.0</span><span style=color:#61676ccc>, </span><span style=color:#abb0b6;font-style:italic>// lumens
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>intensity</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>50_000.0</span><span style=color:#61676ccc>, </span><span style=color:#abb0b6;font-style:italic>// lumens
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/pbr/struct.VolumetricFogSettings.html target=_blank>Bevy Volumetric Fog Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://www.w3.org/TR/WGSL/ target=_blank>WGSL Shader Language Specification</a><li><a rel="noopener nofollow noreferrer" href=https://learnopengl.com/Advanced-Lighting/HDR target=_blank>Physically Based Rendering and HDR</a><li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/features/rendering.html target=_blank>Bevy Rendering Architecture</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-10/pr_21387.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>