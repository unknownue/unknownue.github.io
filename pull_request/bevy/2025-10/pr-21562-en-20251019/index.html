<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21562 Minor refactors in change detection
        
    </title><meta content="#21562 Minor refactors in change detection" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-10/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-10-19</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-10/pr-21562-zh-cn-20251019>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>Minor refactors in change detection<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Minor refactors in change detection<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21562<li><strong>Author</strong>: JaySpruce<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-ECS, C-Code-Quality, S-Ready-For-Final-Review, M-Needs-Migration-Guide<li><strong>Created</strong>: 2025-10-16T17:38:43Z<li><strong>Merged</strong>: 2025-10-19T17:56:16Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p><strong>Objective</strong><p>While tinkering with change detection, I’ve collected some nitpicks:<ul><li>The word “ticks” is kind of overloaded; ticks are used by components, systems, and the world, but “ticks” is often used to refer to the “added + changed” pair of ticks that only components have (and resources, but they’re close enough to components).<li><code>Ticks</code> is a nice name for a struct, but it’s taken by a <code>pub(crate)</code> struct that’s pretty niche. (I don’t have any plans for the <code>Ticks</code> name, but it could be useful for something.)<li>Every use of <code>Ticks</code>, <code>TicksMut</code>, and <code>TickCells</code> is accompanied by a <code>MaybeLocation</code> that represents the calling location that last modified the component, so it should just be part of the structs.<li><code>NonSend</code> seems to be in the wrong file, and doesn’t implement methods with the macros that every other change-detecting query parameter uses.</ul><p><strong>Solution</strong><p>Renamed the following structs:<ul><li><code>Ticks</code> -> <code>RefComponentTicks</code><li><code>TicksMut</code> -> <code>MutComponentTicks</code><li><code>TickCells</code> -> <code>ComponentTickCells</code></ul><p>Added a <code>changed_by: MaybeLocation</code> field to <code>RefComponentTicks</code>, <code>MutComponentTicks</code>, and <code>ComponentTickCells</code> and folded in the loose <code>MaybeLocation</code>s.<p>Moved <code>NonSend</code> from <code>system/system_param.rs</code> to <code>change_detection.rs</code> and updated its implementation to match similar query parameters.<p>Removed <code>ComponentTickCells::read</code> because it is now unused (and not public).<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses several technical debt issues in Bevy’s change detection system through a series of focused refactors. The changes stem from practical observations made while working with the codebase, targeting naming clarity, structural consistency, and architectural organization.<p>The core problem was that the term “ticks” had become overloaded in the codebase. It referred to both individual tick values used by systems and the world, and the paired “added + changed” ticks specific to components and resources. This ambiguity made the code harder to understand and maintain. Additionally, the <code>Ticks</code>, <code>TicksMut</code>, and <code>TickCells</code> structs were always used alongside separate <code>MaybeLocation</code> parameters, creating unnecessary complexity and potential for errors.<p>The solution involved renaming the core tick-related structs to be more descriptive and self-contained. <code>Ticks</code> became <code>ComponentTicksRef</code>, <code>TicksMut</code> became <code>ComponentTicksMut</code>, and <code>TickCells</code> became <code>ComponentTickCells</code>. These new names clearly indicate their purpose and scope, resolving the naming ambiguity.<p>More importantly, each of these structs now includes a <code>changed_by: MaybeLocation</code> field directly, eliminating the need to pass this information separately throughout the codebase. This structural change simplifies the API and reduces boilerplate code. For example:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>Mut</span><span><</span><span style=color:#fa6e32>'w</span><span>, T</span><span style=color:#61676ccc>: </span><span style=color:#f51818>?</span><span>Sized> {
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) value</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'w mut</span><span> T,
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) ticks</span><span style=color:#61676ccc>: </span><span>TicksMut<</span><span style=color:#fa6e32>'w</span><span>>,
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) changed_by</span><span style=color:#61676ccc>: </span><span>MaybeLocation<</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'w mut </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'static </span><span>Location<</span><span style=color:#fa6e32>'static</span><span>>>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>Mut</span><span><</span><span style=color:#fa6e32>'w</span><span>, T</span><span style=color:#61676ccc>: </span><span style=color:#f51818>?</span><span>Sized> {
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) value</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'w mut</span><span> T,
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) ticks</span><span style=color:#61676ccc>: </span><span>ComponentTicksMut<</span><span style=color:#fa6e32>'w</span><span>>,
</span><span>}
</span></code></pre><p>The implementation required updating all the change detection macros and methods to work with the new struct layout. The <code>change_detection_impl</code> and <code>change_detection_mut_impl</code> macros were modified to access the <code>changed_by</code> field through the ticks struct rather than as a separate field. This change affected all change-detecting types including <code>Res</code>, <code>ResMut</code>, <code>Ref</code>, <code>Mut</code>, and <code>NonSendMut</code>.<p>Another significant improvement was moving the <code>NonSend</code> type from <code>system/system_param.rs</code> to <code>change_detection.rs</code> and updating its implementation to use the same macros as other change-detecting query parameters. This consolidation brings consistency to the change detection system and eliminates duplicate functionality. The <code>NonSend</code> type now properly implements the change detection traits through the standard macros, making it behave consistently with other similar types.<p>The refactor also removed the unused <code>ComponentTickCells::read</code> method, which was no longer necessary after the structural changes. This cleanup helps maintain a lean and focused API.<p>From a technical perspective, these changes improve code organization by grouping related functionality together and reducing coupling between components. The inclusion of <code>MaybeLocation</code> directly in the tick structs ensures that change tracking information remains cohesive and is always available when needed. This approach also reduces the cognitive load on developers working with change detection, as they no longer need to manage separate location tracking.<p>The impact of these changes is primarily internal - they don’t change the public API behavior but significantly improve code quality and maintainability. The refactored code is more consistent, easier to understand, and less error-prone. The migration guide included with the PR ensures that any internal usage of the renamed types is properly updated.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Change Detection Types] --> B[ComponentTickCells]
</span><span>    A --> C[ComponentTicksRef]
</span><span>    A --> D[ComponentTicksMut]
</span><span>    
</span><span>    B --> E[contains changed_by]
</span><span>    C --> E
</span><span>    D --> E
</span><span>    
</span><span>    F[Query Parameters] --> G[Ref]
</span><span>    F --> H[Mut]
</span><span>    F --> I[Res]
</span><span>    F --> J[ResMut]
</span><span>    F --> K[NonSend]
</span><span>    F --> L[NonSendMut]
</span><span>    
</span><span>    G --> C
</span><span>    H --> D
</span><span>    I --> C
</span><span>    J --> D
</span><span>    K --> C
</span><span>    L --> D
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ecs-src-change-detection-rs-91-72><code>crates/bevy_ecs/src/change_detection.rs</code> (+91/-72)</h3><p>This was the primary file modified, containing the core change detection types and implementations. The key changes include:<ul><li>Renamed <code>Ticks</code> to <code>ComponentTicksRef</code> and added <code>changed_by</code> field<li>Renamed <code>TicksMut</code> to <code>ComponentTicksMut</code> and added <code>changed_by</code> field<li>Updated all change detection types to use the new structs<li>Moved <code>NonSend</code> and <code>NonSendMut</code> types into this file</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>Ticks</span><span><</span><span style=color:#fa6e32>'w</span><span>> {
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) added</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'w</span><span> Tick,
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) changed</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'w</span><span> Tick,
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) last_run</span><span style=color:#61676ccc>:</span><span> Tick,
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) this_run</span><span style=color:#61676ccc>:</span><span> Tick,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>ComponentTicksRef</span><span><</span><span style=color:#fa6e32>'w</span><span>> {
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) added</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'w</span><span> Tick,
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) changed</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'w</span><span> Tick,
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) changed_by</span><span style=color:#61676ccc>: </span><span>MaybeLocation<</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'w </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'static </span><span>Location<</span><span style=color:#fa6e32>'static</span><span>>>,
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) last_run</span><span style=color:#61676ccc>:</span><span> Tick,
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) this_run</span><span style=color:#61676ccc>:</span><span> Tick,
</span><span>}
</span></code></pre><h3 id=crates-bevy-ecs-src-system-system-param-rs-37-118><code>crates/bevy_ecs/src/system/system_param.rs</code> (+37/-118)</h3><p>This file was significantly simplified by moving <code>NonSend</code> to the change detection module and removing duplicate implementations. The system parameter implementations now use the consolidated change detection types.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: NonSend was defined here with custom implementation
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>NonSend</span><span><</span><span style=color:#fa6e32>'w</span><span>, T</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>'static</span><span>> {
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) value</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'w</span><span> T,
</span><span>    ticks</span><span style=color:#61676ccc>:</span><span> ComponentTicks,
</span><span>    last_run</span><span style=color:#61676ccc>:</span><span> Tick,
</span><span>    this_run</span><span style=color:#61676ccc>:</span><span> Tick,
</span><span>    changed_by</span><span style=color:#61676ccc>: </span><span>MaybeLocation<</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'w </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'static </span><span>Location<</span><span style=color:#fa6e32>'static</span><span>>>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: NonSend moved to change_detection.rs and uses standard macros
</span></code></pre><h3 id=crates-bevy-ecs-src-component-tick-rs-6-19><code>crates/bevy_ecs/src/component/tick.rs</code> (+6/-19)</h3><p>Updated the <code>ComponentTickCells</code> struct to include the <code>changed_by</code> field and removed the unused <code>read</code> method.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>TickCells</span><span><</span><span style=color:#fa6e32>'a</span><span>> {
</span><span>    </span><span style=color:#fa6e32>pub </span><span>added</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'a </span><span>UnsafeCell&LTTick>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>changed</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'a </span><span>UnsafeCell&LTTick>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>ComponentTickCells</span><span><</span><span style=color:#fa6e32>'a</span><span>> {
</span><span>    </span><span style=color:#fa6e32>pub </span><span>added</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'a </span><span>UnsafeCell&LTTick>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>changed</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'a </span><span>UnsafeCell&LTTick>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>changed_by</span><span style=color:#61676ccc>: </span><span>MaybeLocation<</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'a </span><span>UnsafeCell<</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'static </span><span>Location<</span><span style=color:#fa6e32>'static</span><span>>>>,
</span><span>}
</span></code></pre><h3 id=crates-bevy-ecs-src-query-fetch-rs-17-11><code>crates/bevy_ecs/src/query/fetch.rs</code> (+17/-11)</h3><p>Updated query fetching implementations to work with the new tick structs and integrated <code>changed_by</code> field.<h3 id=crates-bevy-ecs-src-world-unsafe-world-cell-rs-30-56><code>crates/bevy_ecs/src/world/unsafe_world_cell.rs</code> (+30/-56)</h3><p>Simplified world cell access methods by leveraging the consolidated tick structs with built-in location tracking.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/advanced-topics/change-detection/ target=_blank>Bevy Change Detection Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://rust-lang.github.io/unsafe-code-guidelines/ target=_blank>Rust Unsafe Code Guidelines</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_ecs/latest/bevy_ecs/system/trait.SystemParam.html target=_blank>System Param Documentation</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-10/pr_21562.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>