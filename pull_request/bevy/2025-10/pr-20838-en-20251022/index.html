<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20838 Generalized atmospheric scattering media
        
    </title><meta content="#20838 Generalized atmospheric scattering media" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-10/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-10-22</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-10/pr-20838-zh-cn-20251022>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>Generalized atmospheric scattering media<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Generalized atmospheric scattering media<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20838<li><strong>Author</strong>: ecoskey<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Feature, A-Rendering, S-Ready-For-Final-Review, M-Release-Note, D-Modest<li><strong>Created</strong>: 2025-09-02T20:48:28Z<li><strong>Merged</strong>: 2025-10-22T23:25:08Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Right now, only a very small set of atmospheres are possible with Bevy’s atmospheric scattering system because of the fixed set of scattering terms available. For example, a scene set in a dry, desert environment might want a dense low-lying layer of dust particulate separate from the ambient dust in the atmosphere. This PR introduces a mechanism for generalized scattering media, replacing the fixed scattering terms with a customizable asset.<h2 id=solution>Solution</h2><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(TypePath</span><span style=color:#61676ccc>,</span><span> Asset</span><span style=color:#61676ccc>,</span><span> Clone)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>ScatteringMedium </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>label</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTCow<</span><span style=color:#fa6e32>'static</span><span>, </span><span style=color:#fa6e32>str</span><span>>>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>falloff_resolution</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u32</span><span>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>phase_resolution</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u32</span><span>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>terms</span><span style=color:#61676ccc>: </span><span>SmallVec<[ScatteringTerm</span><span style=color:#61676ccc>; </span><span style=color:#ff8f40>1</span><span>]>,
</span><span>}
</span></code></pre><details><summary>see other new types</summary> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Default</span><span style=color:#61676ccc>,</span><span> Clone)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>ScatteringTerm </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>absorption</span><span style=color:#61676ccc>:</span><span> Vec3,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>scattering</span><span style=color:#61676ccc>:</span><span> Vec3,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>falloff</span><span style=color:#61676ccc>:</span><span> Falloff,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>phase</span><span style=color:#61676ccc>:</span><span> PhaseFunction,
</span><span>}
</span><span>
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Default</span><span style=color:#61676ccc>,</span><span> Clone)]
</span><span style=color:#fa6e32>pub enum </span><span style=color:#399ee6>Falloff </span><span>{
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>default</span><span>]
</span><span>    Linear</span><span style=color:#61676ccc>,
</span><span>    Exponential {
</span><span>        scale</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span style=color:#61676ccc>,
</span><span>    }</span><span style=color:#61676ccc>,
</span><span>    Tent {
</span><span>        center</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span style=color:#61676ccc>,
</span><span>        width</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span style=color:#61676ccc>,
</span><span>    }</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>/// A falloff function defined by a custom curve.
</span><span>    </span><span style=color:#abb0b6;font-style:italic>///
</span><span>    </span><span style=color:#abb0b6;font-style:italic>/// domain: [0, 1),
</span><span>    </span><span style=color:#abb0b6;font-style:italic>/// range: [0, 1],
</span><span>    Curve(Arc&LTdyn Curve<</span><span style=color:#fa6e32>f32</span><span>> </span><span style=color:#ed9366>+ </span><span style=color:#55b4d4;font-style:italic>Send </span><span style=color:#ed9366>+ </span><span style=color:#55b4d4;font-style:italic>Sync</span><span>>)</span><span style=color:#61676ccc>,
</span><span>}
</span><span>
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Clone)]
</span><span style=color:#fa6e32>pub enum </span><span style=color:#399ee6>PhaseFunction </span><span>{
</span><span>    Isotropic</span><span style=color:#61676ccc>,
</span><span>    Rayleigh</span><span style=color:#61676ccc>,
</span><span>    Mie {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>/// domain: [-1, 1]
</span><span>        bias</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span style=color:#61676ccc>,
</span><span>    }</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>/// A phase function defined by a custom curve.
</span><span>    </span><span style=color:#abb0b6;font-style:italic>///
</span><span>    </span><span style=color:#abb0b6;font-style:italic>/// domain: [-1, 1]
</span><span>    </span><span style=color:#abb0b6;font-style:italic>/// range: [0, 1]
</span><span>    Curve(Arc&LTdyn Curve<</span><span style=color:#fa6e32>f32</span><span>> </span><span style=color:#ed9366>+ </span><span style=color:#55b4d4;font-style:italic>Send </span><span style=color:#ed9366>+ </span><span style=color:#55b4d4;font-style:italic>Sync</span><span>>)</span><span style=color:#61676ccc>,
</span><span>}
</span></code></pre></details><p><code>ScatteringMedium</code> contains a list of <code>ScatteringTerms</code>, which are processed into a set of two LUTs:<ul><li>The “density LUT”, a 2D <code>falloff_resolution x 2</code> LUT which contains the medium’s optical density with respect to the atmosphere’s “falloff parameter”, a linear value which is 1.0 at the planet’s surface and 0.0 at the edge of space. Absorption density and scattering density correspond to the first and second rows respectively.<li>The “scattering LUT”, a 2D <code>falloff_resolution x phase_resolution</code> LUT which contains the medium’s scattering density multiplied by the phase function, with the U axis corresponding to the falloff parameter and the V axis corresponding to <code>neg_LdotV * 0.5 + 0.5</code>, where <code>neg_LdotV</code> is the dot product of the light direction and the outgoing view vector.</ul><h2 id=testing>Testing</h2><ul><li>Need to verify output, should be almost exactly the same<li>exponential falloff is slightly different now, but verified new parameters against the old in Desmos.</ul><h2 id=todos>TODOS:</h2><ul><li>Docs Docs Docs<li>Cleanup<li>profile perf<li>reduce memory usage/traffic. This approach requires a few extra texture samples in the inner loop of each pass. Each atmosphere LUT is still quite small, but texture samples are expensive and the new LUTs use f32 texels currently.</ul><h2 id=showcase>Showcase</h2><details><summary>Click to view showcase</summary> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>fn </span><span style=color:#f29718>init_atmosphere</span><span>(</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands, </span><span style=color:#ff8f40>scattering_media</span><span style=color:#61676ccc>: </span><span>ResMut&LTAssets&LTScatteringMedium>>) {
</span><span>  </span><span style=color:#fa6e32>let</span><span> earth_atmosphere </span><span style=color:#ed9366>=</span><span> scattering_media</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(
</span><span>    ScatteringMedium</span><span style=color:#ed9366>::</span><span>new(
</span><span>      </span><span style=color:#ff8f40>256</span><span style=color:#61676ccc>,
</span><span>      </span><span style=color:#ff8f40>256</span><span style=color:#61676ccc>,
</span><span>      [
</span><span>          </span><span style=color:#abb0b6;font-style:italic>// rayleigh scattering
</span><span>          ScatteringTerm {
</span><span>              absorption</span><span style=color:#61676ccc>: </span><span>Vec3</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ZERO</span><span style=color:#61676ccc>,
</span><span>              scattering</span><span style=color:#61676ccc>: </span><span>Vec3</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ff8f40>5.802e-6</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>13.558e-6</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>33.100e-6</span><span>)</span><span style=color:#61676ccc>,
</span><span>              falloff</span><span style=color:#61676ccc>: </span><span>Falloff</span><span style=color:#ed9366>::</span><span>Exponential { scale</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>12.5 </span><span>}</span><span style=color:#61676ccc>,
</span><span>              phase</span><span style=color:#61676ccc>: </span><span>PhaseFunction</span><span style=color:#ed9366>::</span><span>Rayleigh</span><span style=color:#61676ccc>,
</span><span>          }</span><span style=color:#61676ccc>,
</span><span>          </span><span style=color:#abb0b6;font-style:italic>// mie scattering
</span><span>          ScatteringTerm {
</span><span>              absorption</span><span style=color:#61676ccc>: </span><span>Vec3</span><span style=color:#ed9366>::</span><span>splat(</span><span style=color:#ff8f40>3.996e-6</span><span>)</span><span style=color:#61676ccc>,
</span><span>              scattering</span><span style=color:#61676ccc>: </span><span>Vec3</span><span style=color:#ed9366>::</span><span>splat(</span><span style=color:#ff8f40>0.444e-6</span><span>)</span><span style=color:#61676ccc>,
</span><span>              falloff</span><span style=color:#61676ccc>: </span><span>Falloff</span><span style=color:#ed9366>::</span><span>Exponential { scale</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>83.5 </span><span>}</span><span style=color:#61676ccc>,
</span><span>              phase</span><span style=color:#61676ccc>: </span><span>PhaseFunction</span><span style=color:#ed9366>::</span><span>Mie { bias</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>0.8 </span><span>}</span><span style=color:#61676ccc>,
</span><span>          }</span><span style=color:#61676ccc>,
</span><span>          </span><span style=color:#abb0b6;font-style:italic>// ozone
</span><span>          ScatteringTerm {
</span><span>              absorption</span><span style=color:#61676ccc>: </span><span>Vec3</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ff8f40>0.650e-6</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>1.881e-6</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.085e-6</span><span>)</span><span style=color:#61676ccc>,
</span><span>              scattering</span><span style=color:#61676ccc>: </span><span>Vec3</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ZERO</span><span style=color:#61676ccc>,
</span><span>              falloff</span><span style=color:#61676ccc>: </span><span>Falloff</span><span style=color:#ed9366>::</span><span>Tent {
</span><span>                  center</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>0.75</span><span style=color:#61676ccc>,
</span><span>                  width</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>0.3</span><span style=color:#61676ccc>,
</span><span>              }</span><span style=color:#61676ccc>,
</span><span>              phase</span><span style=color:#61676ccc>: </span><span>PhaseFunction</span><span style=color:#ed9366>::</span><span>Isotropic</span><span style=color:#61676ccc>,
</span><span>          }</span><span style=color:#61676ccc>,
</span><span>      ]</span><span style=color:#61676ccc>,
</span><span>  ))</span><span style=color:#61676ccc>;
</span><span>
</span><span>  commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((
</span><span>    Camera3d</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>, 
</span><span>    Atmosphere {
</span><span>      bottom_radius</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>6_360_000.0</span><span style=color:#61676ccc>,
</span><span>      top_radius</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>6_460_000.0</span><span style=color:#61676ccc>,
</span><span>      ground_albedo</span><span style=color:#61676ccc>: </span><span>Vec3</span><span style=color:#ed9366>::</span><span>splat(</span><span style=color:#ff8f40>0.3</span><span>)</span><span style=color:#61676ccc>,
</span><span>      medium</span><span style=color:#61676ccc>:</span><span> earth_atmosphere</span><span style=color:#61676ccc>,
</span><span>    }</span><span style=color:#61676ccc>,
</span><span>  ))</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre></details><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=the-problem-and-context>The Problem and Context</h3><p>Bevy’s atmospheric scattering system was limited to a fixed set of scattering terms, making it difficult to create diverse atmospheric effects. The original implementation hardcoded Rayleigh scattering, Mie scattering, and ozone absorption parameters directly in the <code>Atmosphere</code> component. This approach worked well for Earth-like atmospheres but couldn’t represent other environments like desert scenes with low-lying dust layers or extraterrestrial atmospheres with different scattering characteristics.<p>The technical constraints included maintaining real-time performance while allowing for customizable atmospheric properties. The existing system used lookup tables (LUTs) for efficient scattering calculations, but these were tied to the fixed scattering model.<h3 id=the-solution-approach>The Solution Approach</h3><p>The developer chose to replace the hardcoded scattering parameters with a customizable asset system. The core insight was that atmospheric scattering can be generalized as a combination of multiple scattering terms, each with its own absorption, scattering, falloff distribution, and phase function characteristics.<p>The solution introduces a <code>ScatteringMedium</code> asset that contains a list of <code>ScatteringTerm</code> components. Each term represents a distinct atmospheric component (like Rayleigh particles, Mie particles, or ozone) and defines how it scatters and absorbs light. The system processes these terms into two specialized LUTs that the existing scattering algorithms can use efficiently.<h3 id=the-implementation>The Implementation</h3><p>The implementation involved several key changes:<ol><li><p><strong>New Asset System</strong>: Created <code>ScatteringMedium</code> as a proper Bevy asset with configurable resolution parameters and a list of scattering terms.</p><li><p><strong>Flexible Scattering Terms</strong>: Each <code>ScatteringTerm</code> includes:</p> <ul><li>Absorption and scattering coefficients<li>Falloff distribution (Linear, Exponential, Tent, or custom curves)<li>Phase function (Isotropic, Rayleigh, Mie, or custom curves)</ul><li><p><strong>GPU Representation</strong>: The system generates two LUTs on the GPU:</p> <ul><li>Density LUT: Stores absorption and scattering densities across altitude<li>Scattering LUT: Combines scattering density with phase function evaluation</ul><li><p><strong>Shader Integration</strong>: Modified all atmospheric scattering shaders to sample from the new LUTs instead of using hardcoded calculations.</p><li><p><strong>Backward Compatibility</strong>: Provided an <code>EarthlikeAtmosphere</code> resource and helper methods to maintain the existing Earth-like atmosphere as the default.</p></ol><h3 id=technical-insights>Technical Insights</h3><p>The implementation demonstrates several advanced techniques:<p><strong>Lookup Table Optimization</strong>: By precomputing complex scattering calculations into LUTs, the system maintains real-time performance while supporting arbitrary scattering media. The density LUT uses a clever layout with absorption and scattering densities stored in separate rows of the same texture.<p><strong>Custom Curve Support</strong>: Both falloff distributions and phase functions support custom curves via Bevy’s <code>Curve</code> trait, enabling artists to create unique atmospheric effects without modifying shader code.<p><strong>Asset-Driven Rendering</strong>: The system leverages Bevy’s asset system to manage scattering media, allowing for runtime updates and efficient resource management.<p><strong>Performance Considerations</strong>: The PR acknowledges potential performance impacts from additional texture samples and uses resolution parameters to balance quality and performance.<h3 id=the-impact>The Impact</h3><p>This PR significantly expands Bevy’s atmospheric rendering capabilities:<ul><li><strong>Artistic Flexibility</strong>: Developers can now create diverse atmospheric effects beyond Earth-like conditions<li><strong>Modular Design</strong>: The asset-based approach allows for sharing and reusing scattering media across different scenes<li><strong>Performance Maintained</strong>: The LUT-based approach preserves the real-time performance characteristics of the original system<li><strong>Extensible Architecture</strong>: The custom curve support and modular scattering terms provide a foundation for future enhancements</ul><p>The changes affect multiple components in the rendering pipeline but maintain compatibility with existing camera and lighting systems.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TB
</span><span>    A[ScatteringMedium Asset] --> B[ScatteringTerm 1]
</span><span>    A --> C[ScatteringTerm 2]
</span><span>    A --> D[ScatteringTerm N]
</span><span>    
</span><span>    B --> E[Falloff Distribution]
</span><span>    B --> F[Phase Function]
</span><span>    
</span><span>    A --> G[Density LUT]
</span><span>    A --> H[Scattering LUT]
</span><span>    
</span><span>    G --> I[Atmosphere Shaders]
</span><span>    H --> I
</span><span>    I --> J[Final Rendering]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-pbr-src-medium-rs-555-0><code>crates/bevy_pbr/src/medium.rs</code> (+555/-0)</h3><p>This new file contains the core implementation of the scattering medium system.<p><strong>Key additions:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(TypePath</span><span style=color:#61676ccc>,</span><span> Asset</span><span style=color:#61676ccc>,</span><span> Clone)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>ScatteringMedium </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>label</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTCow<</span><span style=color:#fa6e32>'static</span><span>, </span><span style=color:#fa6e32>str</span><span>>>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>falloff_resolution</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u32</span><span>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>phase_resolution</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u32</span><span>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>terms</span><span style=color:#61676ccc>: </span><span>SmallVec<[ScatteringTerm</span><span style=color:#61676ccc>; </span><span style=color:#ff8f40>1</span><span>]>,
</span><span>}
</span><span>
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Default</span><span style=color:#61676ccc>,</span><span> Clone)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>ScatteringTerm </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>absorption</span><span style=color:#61676ccc>:</span><span> Vec3,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>scattering</span><span style=color:#61676ccc>:</span><span> Vec3,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>falloff</span><span style=color:#61676ccc>:</span><span> Falloff,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>phase</span><span style=color:#61676ccc>:</span><span> PhaseFunction,
</span><span>}
</span></code></pre><p><strong>Relationship to PR:</strong> This file defines the main data structures that enable customizable atmospheric scattering.<h3 id=crates-bevy-pbr-src-atmosphere-resources-rs-200-100><code>crates/bevy_pbr/src/atmosphere/resources.rs</code> (+200/-100)</h3><p>This file handles the preparation of atmosphere resources for rendering.<p><strong>Key changes:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#abb0b6;font-style:italic>// Hardcoded atmosphere parameters in shader uniforms
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Clone</span><span style=color:#61676ccc>,</span><span> Component</span><span style=color:#61676ccc>,</span><span> ShaderType)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>GpuAtmosphere </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>ground_albedo</span><span style=color:#61676ccc>:</span><span> Vec3,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>bottom_radius</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>top_radius</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>,
</span><span>}
</span></code></pre><p><strong>Relationship to PR:</strong> The changes remove hardcoded scattering parameters and add support for the new scattering medium LUTs in bind groups.<h3 id=crates-bevy-pbr-src-atmosphere-mod-rs-58-112><code>crates/bevy_pbr/src/atmosphere/mod.rs</code> (+58/-112)</h3><p>This file contains the main atmosphere component and plugin.<p><strong>Key changes:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Clone</span><span style=color:#61676ccc>,</span><span> Component</span><span style=color:#61676ccc>,</span><span> Reflect</span><span style=color:#61676ccc>,</span><span> ShaderType)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>Atmosphere </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Many hardcoded scattering parameters
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Clone</span><span style=color:#61676ccc>,</span><span> Component)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>Atmosphere </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>bottom_radius</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>top_radius</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>ground_albedo</span><span style=color:#61676ccc>:</span><span> Vec3,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>medium</span><span style=color:#61676ccc>: </span><span>Handle&LTScatteringMedium>,
</span><span>}
</span></code></pre><p><strong>Relationship to PR:</strong> This simplifies the <code>Atmosphere</code> component by moving scattering details to the asset system.<h3 id=crates-bevy-pbr-src-atmosphere-functions-wgsl-39-79><code>crates/bevy_pbr/src/atmosphere/functions.wgsl</code> (+39/-79)</h3><p>This WGSL file contains shader functions for atmospheric calculations.<p><strong>Key changes:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>sample_atmosphere</span><span>(</span><span style=color:#ff8f40>r</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>) </span><span style=color:#61676ccc>-></span><span> AtmosphereSample {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Hardcoded scattering calculations
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>sample_density_lut</span><span>(</span><span style=color:#ff8f40>r</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>, </span><span style=color:#ff8f40>component</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>) </span><span style=color:#61676ccc>-> </span><span>vec3<</span><span style=color:#fa6e32>f32</span><span>> {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Sample from the new density LUT
</span><span>}
</span><span>
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>sample_scattering_lut</span><span>(</span><span style=color:#ff8f40>r</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>, </span><span style=color:#ff8f40>neg_LdotV</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>) </span><span style=color:#61676ccc>-> </span><span>vec3<</span><span style=color:#fa6e32>f32</span><span>> {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Sample from the new scattering LUT
</span><span>}
</span></code></pre><p><strong>Relationship to PR:</strong> Replaces hardcoded scattering calculations with LUT sampling for generalized media.<h3 id=crates-bevy-pbr-src-atmosphere-environment-rs-45-40><code>crates/bevy_pbr/src/atmosphere/environment.rs</code> (+45/-40)</h3><p>This file handles environment map lighting with atmospheric scattering.<p><strong>Key changes:</strong> Updated bind group layouts and resource preparation to include the new scattering medium LUTs and sampler.<p><strong>Relationship to PR:</strong> Ensures environment map rendering works with the new generalized scattering system.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/tree/main/crates/bevy_pbr/src/atmosphere target=_blank>Bevy Atmosphere Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://www.pbr-book.org/4ed/Volume_Scattering/Contents target=_blank>Physically Based Rendering - Volume Scattering</a><li><a rel="noopener nofollow noreferrer" href=https://hal.inria.fr/inria-00288758/document target=_blank>Bruneton and Neyret’s Precomputed Atmospheric Scattering</a><li><a rel="noopener nofollow noreferrer" href=http://www.realtimerendering.com/ target=_blank>Real-Time Rendering - Atmospheric Scattering</a></ul><h1 id=full-code-diff>Full Code Diff</h1><p>[The full code diff is extensive and has been provided in the background context. Key changes have been highlighted in the narrative above.]</div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-10/pr_20838.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>