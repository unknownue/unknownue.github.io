<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20960 Added SSAO support on WebGPU, with R32Float fallback.
        
    </title><meta content="#20960 Added SSAO support on WebGPU, with R32Float fallback." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-10/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-10-29</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2025-10/pr-20960-en-20251029>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=added-ssao-support-on-webgpu-with-r32float-fallback>Added SSAO support on WebGPU, with R32Float fallback</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>标题</strong>: Added SSAO support on WebGPU, with R32Float fallback.<li><strong>PR链接</strong>: https://github.com/bevyengine/bevy/pull/20960<li><strong>作者</strong>: diyu-motif<li><strong>状态</strong>: 已合并<li><strong>标签</strong>: C-Feature, A-Rendering, S-Ready-For-Final-Review, O-WebGPU<li><strong>创建时间</strong>: 2025-09-11T01:54:27Z<li><strong>合并时间</strong>: 2025-10-29T18:38:57Z<li><strong>合并者</strong>: alice-i-cecile</ul><h2 id=miao-shu-fan-yi>描述翻译</h2><h1 id=mu-biao>目标</h1><p>此PR旨在为WebGPU添加SSAO支持。<h2 id=jie-jue-fang-an>解决方案</h2><p>添加r16float检测，如果不支持则回退到r32float。参考初始的ssao PR<a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/pull/7402 target=_blank>这里</a>。<h2 id=ce-shi>测试</h2><ul><li><p>你是否测试了这些更改？如果是，如何测试的？ 是的，以下是测试ssao示例的命令 <code>RUSTFLAGS="--cfg getrandom_backend=\"wasm_js\"" cargo run --example ssao --target wasm32-unknown-unknown --features webgpu</code> 然后访问 http://localhost:1334，确保支持<a rel="noopener nofollow noreferrer" href=https://caniuse.com/webgpu target=_blank>WebGPU</a></p><li><p>是否有任何部分需要更多测试？ 不适用</p><li><p>其他人（审阅者）如何测试你的更改？他们需要了解什么具体信息吗？</p> <ol><li>对于R32Float回退，只需要第一个提交。但是，我在Chrome（和Chrome Canary）上遇到了一些奇怪的闪烁问题，所以我添加了一个“detect_r16float_support“标志和在第二个和第三个提交中的临时修复，这些在合并时打算被还原。<li>使用第一个提交，Safari工作正常，但Chrome有闪烁，我通过部分还原来自https://github.com/bevyengine/bevy/pull/20313的着色器更改来修复了它，这很奇怪。这可能是由Chrome中的一些着色器优化问题引起的，我不知道为什么，因为更改只是将计算移动到不同的函数。<br> 这里是Mac Chrome(140.0.7339.133 (Official Build) (arm64))上的闪烁 <img alt=chrome_ssao height=327 src=https://github.com/user-attachments/assets/0666673f-508e-4b57-a152-19327ffdb6f3 width=353></ol><li><p>如果相关，你在哪些平台上测试了这些更改，有哪些重要的平台你无法测试？ 在原生(mac)和WebGPU上测试。要在原生上测试，将“detect_r16float_support“设置为false以强制使用R32Float。 我无法在Windows 11 Chrome或Firefox上运行WebGPU ssao示例，’taa_pipeline’中有一些错误。</p></ul><hr><h2 id=ci-la-qu-qing-qiu-de-gu-shi>此拉取请求的故事</h2><h3 id=wen-ti-he-bei-jing>问题和背景</h3><p>在WebGPU平台上实现SSAO（Screen Space Ambient Occlusion）功能时，开发团队面临一个关键的技术挑战：原有的SSAO实现依赖于R16Float纹理格式的存储绑定（storage binding）支持，但并非所有WebGPU实现都支持这一功能。<p>具体来说，在PR修改之前，代码在初始化阶段会进行严格的硬件能力检查：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 修改前的检查逻辑
</span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>render_app
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>world</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span>resource</span><span style=color:#ed9366>::</span><span>&LTRenderAdapter>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>get_texture_format_features</span><span>(TextureFormat</span><span style=color:#ed9366>::</span><span>R16Float)
</span><span>    </span><span style=color:#ed9366>.</span><span>allowed_usages
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>contains</span><span>(TextureUsages</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>STORAGE_BINDING</span><span>)
</span><span>{
</span><span>    </span><span style=color:#f07171>warn!</span><span>(</span><span style=color:#86b300>"ScreenSpaceAmbientOcclusionPlugin not loaded. GPU lacks support..."</span><span>)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>这种硬性检查导致在不支持R16Float存储绑定的WebGPU平台上，SSAO功能完全无法使用。这是一个典型的跨平台兼容性问题，需要在保持功能可用性的同时处理不同平台的硬件能力差异。<h3 id=jie-jue-fang-an-fang-fa>解决方案方法</h3><p>开发者采取了渐进式功能降级的策略，核心思路是：<ol><li><strong>运行时能力检测</strong>：在初始化时检测R16Float存储绑定的支持情况<li><strong>动态格式选择</strong>：根据检测结果选择使用R16Float或降级到R32Float<li><strong>条件编译支持</strong>：通过shader_defs在着色器中实现格式特定的代码路径</ol><p>这种方法的优势在于：<ul><li>保持了对高性能R16Float格式的向后兼容<li>为不支持该格式的平台提供了可用的替代方案<li>避免了硬性功能检查导致的完全不可用</ul><h3 id=ju-ti-shi-xian>具体实现</h3><p>实现的核心在于<code>SsaoPipelines</code>结构体的重构，添加了动态格式检测和选择逻辑：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 在FromWorld实现中添加格式检测
</span><span style=color:#fa6e32>let</span><span> depth_format </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>if</span><span> render_adapter
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>get_texture_format_features</span><span>(TextureFormat</span><span style=color:#ed9366>::</span><span>R16Float)
</span><span>    </span><span style=color:#ed9366>.</span><span>allowed_usages
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>contains</span><span>(TextureUsages</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>STORAGE_BINDING</span><span>)
</span><span>{
</span><span>    TextureFormat</span><span style=color:#ed9366>::</span><span>R16Float
</span><span>} </span><span style=color:#fa6e32>else </span><span>{
</span><span>    TextureFormat</span><span style=color:#ed9366>::</span><span>R32Float
</span><span>}</span><span style=color:#61676ccc>;
</span></code></pre><p>这个检测结果被存储在新的<code>depth_format</code>字段中，并在整个渲染管线的多个环节中使用：<ol><li><strong>管线创建</strong>：根据选择的格式配置存储纹理绑定</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#f07171>texture_storage_2d</span><span>(depth_format</span><span style=color:#61676ccc>, </span><span>StorageTextureAccess</span><span style=color:#ed9366>::</span><span>WriteOnly)</span><span style=color:#61676ccc>,
</span></code></pre><ol start=2><li><strong>着色器定义</strong>：通过shader_defs传递格式信息</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let mut</span><span> shader_defs </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>Vec</span><span style=color:#ed9366>::</span><span>new()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>if</span><span> depth_format </span><span style=color:#ed9366>== </span><span>TextureFormat</span><span style=color:#ed9366>::</span><span>R16Float {
</span><span>    shader_defs</span><span style=color:#ed9366>.</span><span style=color:#f07171>push</span><span>(</span><span style=color:#86b300>"USE_R16FLOAT"</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>())</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><ol start=3><li><strong>纹理准备</strong>：在运行时根据选择的格式创建纹理</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>format</span><span style=color:#61676ccc>:</span><span> pipelines</span><span style=color:#ed9366>.</span><span>depth_format</span><span style=color:#61676ccc>,
</span></code></pre><h3 id=zhao-se-qi-ceng-mian-de-gua-pei>着色器层面的适配</h3><p>在WGSL着色器代码中，通过条件编译实现了格式特定的绑定：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// preprocess_depth.wgsl中的修改
</span><span style=color:#ed9366>#</span><span>ifdef </span><span style=color:#ff8f40>USE_R16FLOAT
</span><span style=color:#ed9366>@</span><span style=color:#f07171>group</span><span>(</span><span style=color:#ff8f40>0</span><span>) </span><span style=color:#ed9366>@</span><span style=color:#f07171>binding</span><span>(</span><span style=color:#ff8f40>1</span><span>) var preprocessed_depth_mip0</span><span style=color:#61676ccc>: </span><span>texture_storage_2d&LTr16float, write></span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// ... 其他mip级别
</span><span style=color:#ed9366>#</span><span style=color:#fa6e32>else
</span><span style=color:#ed9366>@</span><span style=color:#f07171>group</span><span>(</span><span style=color:#ff8f40>0</span><span>) </span><span style=color:#ed9366>@</span><span style=color:#f07171>binding</span><span>(</span><span style=color:#ff8f40>1</span><span>) var preprocessed_depth_mip0</span><span style=color:#61676ccc>: </span><span>texture_storage_2d&LTr32float, write></span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// ... 其他mip级别
</span><span style=color:#ed9366>#</span><span>endif
</span></code></pre><p>同样的模式也应用在<code>spatial_denoise.wgsl</code>和<code>ssao.wgsl</code>中，确保所有使用深度数据的着色器阶段都能正确处理不同的格式。<h3 id=ji-shu-tiao-zhan-he-lin-shi-jie-jue-fang-an>技术挑战和临时解决方案</h3><p>开发过程中遇到了一个有趣的跨浏览器兼容性问题：在Chrome浏览器中出现了SSAO输出的闪烁现象。经过调试，开发者发现这与之前的一个着色器优化（PR #20313）有关。<p>临时解决方案是部分还原了该优化，通过调整计算在不同函数间的分布来避免Chrome的着色器编译器可能存在的优化问题。这凸显了WebGPU生态中不同实现之间行为差异的挑战。<h3 id=ying-xiang-he-yi-yi>影响和意义</h3><p>这个PR的合并带来了几个重要的改进：<ol><li><strong>平台兼容性扩展</strong>：SSAO功能现在可以在所有支持WebGPU的平台上运行，无论其R16Float存储绑定支持情况<li><strong>渐进增强</strong>：支持R16Float的平台继续获得最佳性能，其他平台则获得可用的降级体验<li><strong>架构改进</strong>：建立了可扩展的格式检测和回退机制，为未来处理类似平台差异提供了模板</ol><p>从工程角度看，这个实现展示了如何处理图形API中的硬件能力差异，以及如何通过条件编译和运行时检测来构建健壮的跨平台渲染功能。<h2 id=shi-jue-biao-shi>视觉表示</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TB
</span><span>    A[RenderAdapter] --> B{检测R16Float支持}
</span><span>    B -->|支持| C[使用R16Float格式]
</span><span>    B -->|不支持| D[使用R32Float格式]
</span><span>    
</span><span>    C --> E[设置USE_R16FLOAT定义]
</span><span>    D --> F[不使用USE_R16FLOAT]
</span><span>    
</span><span>    E --> G[创建R16Float存储纹理]
</span><span>    F --> H[创建R32Float存储纹理]
</span><span>    
</span><span>    G --> I[着色器条件编译R16Float路径]
</span><span>    H --> J[着色器条件编译R32Float路径]
</span><span>    
</span><span>    I --> K[SSAO渲染管线]
</span><span>    J --> K
</span></code></pre><h2 id=guan-jian-wen-jian-bian-geng>关键文件变更</h2><h3 id=crates-bevy-pbr-src-ssao-mod-rs-37-22><code>crates/bevy_pbr/src/ssao/mod.rs</code> (+37/-22)</h3><p>这是主要的逻辑变更文件，实现了格式检测和动态管线配置：<p><strong>关键修改：</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 移除原有的硬性检查
</span><span style=color:#ed9366>- </span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>render_app
</span><span style=color:#ed9366>-     .</span><span style=color:#f07171>world</span><span>()
</span><span style=color:#ed9366>-     .</span><span>resource</span><span style=color:#ed9366>::</span><span>&LTRenderAdapter>()
</span><span style=color:#ed9366>-     .</span><span style=color:#f07171>get_texture_format_features</span><span>(TextureFormat</span><span style=color:#ed9366>::</span><span>R16Float)
</span><span style=color:#ed9366>-     .</span><span>allowed_usages
</span><span style=color:#ed9366>-     .</span><span style=color:#f07171>contains</span><span>(TextureUsages</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>STORAGE_BINDING</span><span>)
</span><span style=color:#ed9366>- </span><span>{
</span><span style=color:#ed9366>-     </span><span style=color:#f07171>warn!</span><span>(</span><span style=color:#86b300>"ScreenSpaceAmbientOcclusionPlugin not loaded. GPU lacks support..."</span><span>)</span><span style=color:#61676ccc>;
</span><span style=color:#ed9366>-     </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span style=color:#ed9366>- </span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 添加动态格式检测
</span><span style=color:#ed9366>+ </span><span style=color:#fa6e32>let</span><span> depth_format </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>if</span><span> render_adapter
</span><span style=color:#ed9366>+     .</span><span style=color:#f07171>get_texture_format_features</span><span>(TextureFormat</span><span style=color:#ed9366>::</span><span>R16Float)
</span><span style=color:#ed9366>+     .</span><span>allowed_usages
</span><span style=color:#ed9366>+     .</span><span style=color:#f07171>contains</span><span>(TextureUsages</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>STORAGE_BINDING</span><span>)
</span><span style=color:#ed9366>+ </span><span>{
</span><span style=color:#ed9366>+     </span><span>TextureFormat</span><span style=color:#ed9366>::</span><span>R16Float
</span><span style=color:#ed9366>+ </span><span>} </span><span style=color:#fa6e32>else </span><span>{
</span><span style=color:#ed9366>+     </span><span>TextureFormat</span><span style=color:#ed9366>::</span><span>R32Float
</span><span style=color:#ed9366>+ </span><span>}</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-pbr-src-ssao-preprocess-depth-wgsl-8-0><code>crates/bevy_pbr/src/ssao/preprocess_depth.wgsl</code> (+8/-0)</h3><p>深度预处理着色器添加了格式条件编译：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 添加条件绑定的支持
</span><span style=color:#ed9366>+#</span><span>ifdef </span><span style=color:#ff8f40>USE_R16FLOAT
</span><span> </span><span style=color:#ed9366>@</span><span style=color:#f07171>group</span><span>(</span><span style=color:#ff8f40>0</span><span>) </span><span style=color:#ed9366>@</span><span style=color:#f07171>binding</span><span>(</span><span style=color:#ff8f40>1</span><span>) var preprocessed_depth_mip0</span><span style=color:#61676ccc>: </span><span>texture_storage_2d&LTr16float, write></span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// ...
</span><span style=color:#ed9366>+#</span><span style=color:#fa6e32>else
</span><span style=color:#ed9366>+@</span><span style=color:#f07171>group</span><span>(</span><span style=color:#ff8f40>0</span><span>) </span><span style=color:#ed9366>@</span><span style=color:#f07171>binding</span><span>(</span><span style=color:#ff8f40>1</span><span>) var preprocessed_depth_mip0</span><span style=color:#61676ccc>: </span><span>texture_storage_2d&LTr32float, write></span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// ...
</span><span style=color:#ed9366>+#</span><span>endif
</span></code></pre><h3 id=crates-bevy-pbr-src-ssao-spatial-denoise-wgsl-4-0-he-crates-bevy-pbr-src-ssao-ssao-wgsl-4-0><code>crates/bevy_pbr/src/ssao/spatial_denoise.wgsl</code> (+4/-0) 和 <code>crates/bevy_pbr/src/ssao/ssao.wgsl</code> (+4/-0)</h3><p>这两个着色器文件采用了相同的模式，为主SSAO计算和空间去噪添加了格式条件支持。<h2 id=jin-yi-bu-yue-du>进一步阅读</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://www.w3.org/TR/webgpu/#texture-format-caps target=_blank>WebGPU规范 - 纹理格式</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/pull/7402 target=_blank>Bevy SSAO初始实现PR #7402</a><li><a rel="noopener nofollow noreferrer" href=https://www.w3.org/TR/WGSL/#storage-texture target=_blank>WGSL存储纹理文档</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/gpuweb/gpuweb/wiki/Implementation-Status target=_blank>图形API功能检测最佳实践</a></ul><h1 id=full-code-diff>Full Code Diff</h1><p>diff –git a/crates/bevy_pbr/src/ssao/mod.rs b/crates/bevy_pbr/src/ssao/mod.rs index d9f24d4999aa7..9a94aa355ad3f 100644 — a/crates/bevy_pbr/src/ssao/mod.rs +++ b/crates/bevy_pbr/src/ssao/mod.rs @@ -60,17 +60,6 @@ impl Plugin for ScreenSpaceAmbientOcclusionPlugin { return; };<ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>   if !render_app
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       .world()
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       .resource::&LTRenderAdapter>()
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       .get_texture_format_features(TextureFormat::R16Float)
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       .allowed_usages
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       .contains(TextureUsages::STORAGE_BINDING)
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       warn!("ScreenSpaceAmbientOcclusionPlugin not loaded. GPU lacks support: TextureFormat::R16Float does not support TextureUsages::STORAGE_BINDING.");
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       return;
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   }
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   if render_app
</span><span>       .world()
</span><span>       .resource::&LTRenderDevice>()
</span></code></pre></ul><p>@@ -299,6 +288,7 @@ struct SsaoPipelines { linear_clamp_sampler: Sampler,<pre style=color:#61676c;background-color:#fafafa><code><span> shader: Handle&LTShader>,
</span></code></pre><ul><li>depth_format: TextureFormat, }</ul><p>impl FromWorld for SsaoPipelines { @@ -307,6 +297,18 @@ impl FromWorld for SsaoPipelines { let render_queue = world.resource::<renderqueue>(); let pipeline_cache = world.resource::<pipelinecache>(); <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>   // Detect the depth format support
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   let render_adapter = world.resource::&LTRenderAdapter>();
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   let depth_format = if render_adapter
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       .get_texture_format_features(TextureFormat::R16Float)
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       .allowed_usages
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       .contains(TextureUsages::STORAGE_BINDING)
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       TextureFormat::R16Float
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   } else {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       TextureFormat::R32Float
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   };
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   let hilbert_index_lut = render_device
</span><span>       .create_texture_with_data(
</span><span>           render_queue,
</span></code></pre></ul> <p>@@ -364,11 +366,11 @@ impl FromWorld for SsaoPipelines { ShaderStages::COMPUTE, ( texture_depth_2d(),</p> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>               texture_storage_2d(TextureFormat::R16Float, StorageTextureAccess::WriteOnly),
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>               texture_storage_2d(TextureFormat::R16Float, StorageTextureAccess::WriteOnly),
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>               texture_storage_2d(TextureFormat::R16Float, StorageTextureAccess::WriteOnly),
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>               texture_storage_2d(TextureFormat::R16Float, StorageTextureAccess::WriteOnly),
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>               texture_storage_2d(TextureFormat::R16Float, StorageTextureAccess::WriteOnly),
</span></code></pre></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>               texture_storage_2d(depth_format, StorageTextureAccess::WriteOnly),
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>               texture_storage_2d(depth_format, StorageTextureAccess::WriteOnly),
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>               texture_storage_2d(depth_format, StorageTextureAccess::WriteOnly),
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>               texture_storage_2d(depth_format, StorageTextureAccess::WriteOnly),
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>               texture_storage_2d(depth_format, StorageTextureAccess::WriteOnly),
</span><span>           ),
</span><span>       ),
</span><span>   );
</span></code></pre></ul> <p>@@ -381,7 +383,7 @@ impl FromWorld for SsaoPipelines { texture_2d(TextureSampleType::Float { filterable: true }), texture_2d(TextureSampleType::Float { filterable: false }), texture_2d(TextureSampleType::Uint),</p> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>               texture_storage_2d(TextureFormat::R16Float, StorageTextureAccess::WriteOnly),
</span></code></pre></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>               texture_storage_2d(depth_format, StorageTextureAccess::WriteOnly),
</span><span>               texture_storage_2d(TextureFormat::R32Uint, StorageTextureAccess::WriteOnly),
</span><span>               uniform_buffer::&LTGlobalsUniform>(false),
</span><span>               uniform_buffer::&LTf32>(false),
</span></code></pre></ul> <p>@@ -396,11 +398,16 @@ impl FromWorld for SsaoPipelines { ( texture_2d(TextureSampleType::Float { filterable: false }), texture_2d(TextureSampleType::Uint),</p> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>               texture_storage_2d(TextureFormat::R16Float, StorageTextureAccess::WriteOnly),
</span></code></pre></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>               texture_storage_2d(depth_format, StorageTextureAccess::WriteOnly),
</span><span>           ),
</span><span>       ),
</span><span>   );
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   let mut shader_defs = Vec::new();
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   if depth_format == TextureFormat::R16Float {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       shader_defs.push("USE_R16FLOAT".into());
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   }
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   let preprocess_depth_pipeline =
</span><span>       pipeline_cache.queue_compute_pipeline(ComputePipelineDescriptor {
</span><span>           label: Some("ssao_preprocess_depth_pipeline".into()),
</span></code></pre></ul> <p>@@ -409,6 +416,7 @@ impl FromWorld for SsaoPipelines { common_bind_group_layout.clone(), ], shader: load_embedded_asset!(world, “preprocess_depth.wgsl”),</p> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>           shader_defs: shader_defs.clone(),
</span><span>           ..default()
</span><span>       });
</span></code></pre></ul> <p>@@ -420,6 +428,7 @@ impl FromWorld for SsaoPipelines { common_bind_group_layout.clone(), ], shader: load_embedded_asset!(world, “spatial_denoise.wgsl”),</p> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>           shader_defs,
</span><span>           ..default()
</span><span>       });
</span></code></pre></ul> <p>@@ -437,6 +446,7 @@ impl FromWorld for SsaoPipelines { linear_clamp_sampler,</p> <pre style=color:#61676c;background-color:#fafafa><code><span>         shader: load_embedded_asset!(world, "ssao.wgsl"),
</span></code></pre> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>       depth_format,
</span><span>   }
</span></code></pre> <p>} } @@ -465,6 +475,10 @@ impl SpecializedComputePipeline for SsaoPipelines { shader_defs.push(“TEMPORAL_JITTER”.into()); }</p><li><pre style=color:#61676c;background-color:#fafafa><code><span>   if self.depth_format == TextureFormat::R16Float {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       shader_defs.push("USE_R16FLOAT".into());
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   }
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   ComputePipelineDescriptor {
</span><span>       label: Some("ssao_ssao_pipeline".into()),
</span><span>       layout: vec![
</span></code></pre></ul> <p>@@ -519,6 +533,7 @@ fn prepare_ssao_textures( mut commands: Commands, mut texture_cache: ResMut<texturecache>, render_device: Res<renderdevice>, <ul><li>pipelines: Res<ssaopipelines>, views: Query<(Entity, &ExtractedCamera, &ScreenSpaceAmbientOcclusion)>, ) { for (entity, camera, ssao_settings) in &views { @@ -535,7 +550,7 @@ fn prepare_ssao_textures( mip_level_count: 5, sample_count: 1, dimension: TextureDimension::D2, <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>           format: TextureFormat::R16Float,
</span></code></pre></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>           format: pipelines.depth_format,
</span><span>           usage: TextureUsages::STORAGE_BINDING | TextureUsages::TEXTURE_BINDING,
</span><span>           view_formats: &[],
</span><span>       },
</span></code></pre></ul> <p>@@ -549,7 +564,7 @@ fn prepare_ssao_textures( mip_level_count: 1, sample_count: 1, dimension: TextureDimension::D2,</p> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>           format: TextureFormat::R16Float,
</span></code></pre></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>           format: pipelines.depth_format,
</span><span>           usage: TextureUsages::STORAGE_BINDING | TextureUsages::TEXTURE_BINDING,
</span><span>           view_formats: &[],
</span><span>       },
</span></code></pre></ul> <p>@@ -563,7 +578,7 @@ fn prepare_ssao_textures( mip_level_count: 1, sample_count: 1, dimension: TextureDimension::D2,</p> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>           format: TextureFormat::R16Float,
</span></code></pre></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>           format: pipelines.depth_format,
</span><span>           usage: TextureUsages::STORAGE_BINDING | TextureUsages::TEXTURE_BINDING,
</span><span>           view_formats: &[],
</span><span>       },
</span></code></pre></ul> <p>@@ -670,7 +685,7 @@ fn prepare_ssao_bind_groups( .create_view(&TextureViewDescriptor { label: Some(“ssao_preprocessed_depth_texture_mip_view”), base_mip_level: mip_level,</p> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>               format: Some(TextureFormat::R16Float),
</span></code></pre></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>               format: Some(pipelines.depth_format),
</span><span>               dimension: Some(TextureViewDimension::D2),
</span><span>               mip_level_count: Some(1),
</span><span>               ..default()
</span></code></pre></ul> <p>diff –git a/crates/bevy_pbr/src/ssao/preprocess_depth.wgsl b/crates/bevy_pbr/src/ssao/preprocess_depth.wgsl index a386b09d9c23c..bce9e56f59e06 100644 — a/crates/bevy_pbr/src/ssao/preprocess_depth.wgsl +++ b/crates/bevy_pbr/src/ssao/preprocess_depth.wgsl @@ -8,11 +8,19 @@ #import bevy_render::view::View</p> <p>@group(0) @binding(0) var input_depth: texture_depth_2d; +#ifdef USE_R16FLOAT @group(0) @binding(1) var preprocessed_depth_mip0: texture_storage_2d&LTr16float, write>; @group(0) @binding(2) var preprocessed_depth_mip1: texture_storage_2d&LTr16float, write>; @group(0) @binding(3) var preprocessed_depth_mip2: texture_storage_2d&LTr16float, write>; @group(0) @binding(4) var preprocessed_depth_mip3: texture_storage_2d&LTr16float, write>; @group(0) @binding(5) var preprocessed_depth_mip4: texture_storage_2d&LTr16float, write>; +#else +@group(0) @binding(1) var preprocessed_depth_mip0: texture_storage_2d&LTr32float, write>; +@group(0) @binding(2) var preprocessed_depth_mip1: texture_storage_2d&LTr32float, write>; +@group(0) @binding(3) var preprocessed_depth_mip2: texture_storage_2d&LTr32float, write>; +@group(0) @binding(4) var preprocessed_depth_mip3: texture_storage_2d&LTr32float, write>; +@group(0) @binding(5) var preprocessed_depth_mip4: texture_storage_2d&LTr32float, write>; +#endif @group(1) @binding(0) var point_clamp_sampler: sampler; @group(1) @binding(1) var linear_clamp_sampler: sampler; @group(1) @binding(2) var<uniform> view: View; diff –git a/crates/bevy_pbr/src/ssao/spatial_denoise.wgsl b/crates/bevy_pbr/src/ssao/spatial_denoise.wgsl index 1c04f9cfab2f7..f61934fb462d5 100644 — a/crates/bevy_pbr/src/ssao/spatial_denoise.wgsl +++ b/crates/bevy_pbr/src/ssao/spatial_denoise.wgsl @@ -13,7 +13,11 @@ <p>@group(0) @binding(0) var ambient_occlusion_noisy: texture_2d<f32>; @group(0) @binding(1) var depth_differences: texture_2d<u32>; +#ifdef USE_R16FLOAT @group(0) @binding(2) var ambient_occlusion: texture_storage_2d&LTr16float, write>; +#else +@group(0) @binding(2) var ambient_occlusion: texture_storage_2d&LTr32float, write>; +#endif @group(1) @binding(0) var point_clamp_sampler: sampler; @group(1) @binding(1) var linear_clamp_sampler: sampler; @group(1) @binding(2) var<uniform> view: View; diff –git a/crates/bevy_pbr/src/ssao/ssao.wgsl b/crates/bevy_pbr/src/ssao/ssao.wgsl index ac64d5653f7a4..aa715be052152 100644 — a/crates/bevy_pbr/src/ssao/ssao.wgsl +++ b/crates/bevy_pbr/src/ssao/ssao.wgsl @@ -21,7 +21,11 @@ @group(0) @binding(0) var preprocessed_depth: texture_2d<f32>; @group(0) @binding(1) var normals: texture_2d<f32>; @group(0) @binding(2) var hilbert_index_lut: texture_2d<u32>; +#ifdef USE_R16FLOAT @group(0) @binding(3) var ambient_occlusion: texture_storage_2d&LTr16float, write>; +#else +@group(0) @binding(3) var ambient_occlusion: texture_storage_2d&LTr32float, write>; +#endif @group(0) @binding(4) var depth_differences: texture_storage_2d&LTr32uint, write>; @group(0) @binding(5) var<uniform> globals: Globals; @group(0) @binding(6) var<uniform> thickness: f32;    <div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-10/pr_20960.patch id=patch-info style=display:none></div>  <div class=bottom-spacer></div> 