<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21659 make bevy_input_focus dep on bevy_picking optional
        
    </title><meta content="#21659 make bevy_input_focus dep on bevy_picking optional" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-10/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-10-26</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-10/pr-21659-zh-cn-20251026>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>make bevy_input_focus dep on bevy_picking optional<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: make bevy_input_focus dep on bevy_picking optional<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21659<li><strong>Author</strong>: atlv24<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Windowing, A-UI, C-Code-Quality, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-10-26T15:21:09Z<li><strong>Merged</strong>: 2025-10-26T19:37:27Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Fixes #21413</ul><h2 id=solution>Solution</h2><ul><li>make bevy_input_focus dep on bevy_picking optional</ul><h2 id=testing>Testing</h2><ul><li>ci</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a dependency management issue in the Bevy engine’s input focus system. The core problem was that <code>bevy_input_focus</code> had a hard dependency on <code>bevy_picking</code>, which created unnecessary coupling and forced users to include picking functionality even when they didn’t need it.<p>The solution follows a straightforward conditional compilation approach. The key insight was that only one specific feature - click-to-focus functionality - actually required the picking system. By making the dependency optional and using Rust’s feature flags, we can maintain the existing functionality for users who need picking while allowing others to exclude it.<p>The implementation involved three coordinated changes across the codebase. First, in <code>Cargo.toml</code>, the dependency declaration was modified to mark <code>bevy_picking</code> as optional. This tells Cargo that the dependency doesn’t always need to be present:<pre class=language-toml data-lang=toml style=color:#61676c;background-color:#fafafa><code class=language-toml data-lang=toml><span style=color:#abb0b6;font-style:italic># Before:
</span><span style=color:#399ee6>bevy_picking </span><span>= { </span><span style=color:#399ee6>path </span><span>= </span><span style=color:#86b300>"../bevy_picking"</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>version </span><span>= </span><span style=color:#86b300>"0.18.0-dev"</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>default-features </span><span>= </span><span style=color:#ff8f40>false </span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic># After:
</span><span style=color:#399ee6>bevy_picking </span><span>= { </span><span style=color:#399ee6>path </span><span>= </span><span style=color:#86b300>"../bevy_picking"</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>version </span><span>= </span><span style=color:#86b300>"0.18.0-dev"</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>default-features </span><span>= </span><span style=color:#ff8f40>false</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>optional </span><span>= </span><span style=color:#ff8f40>true </span><span>}
</span></code></pre><p>Next, in the tab navigation implementation, the code was restructured to conditionally include picking-related functionality. The <code>click_to_focus</code> system, which handles mouse click interactions to change focus, was wrapped in a <code>#[cfg(feature = "bevy_picking")]</code> attribute. This ensures the system only compiles when the picking feature is enabled. The function signature was also updated to use fully qualified paths for the picking types, avoiding the need for the <code>use</code> statement that was removed:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>use </span><span>bevy_picking</span><span style=color:#ed9366>::</span><span>events</span><span style=color:#ed9366>::</span><span>{Pointer</span><span style=color:#61676ccc>,</span><span> Press}</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// ... later in the code without conditionals
</span><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_observer</span><span>(click_to_focus)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"bevy_picking"</span><span>)]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>click_to_focus</span><span>(
</span><span>    </span><span style=color:#ff8f40>press</span><span style=color:#61676ccc>: </span><span>On&LTbevy_picking</span><span style=color:#ed9366>::</span><span>events</span><span style=color:#ed9366>::</span><span>Pointer&LTbevy_picking</span><span style=color:#ed9366>::</span><span>events</span><span style=color:#ed9366>::</span><span>Press>>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... parameters
</span><span>)
</span></code></pre><p>Finally, the internal Cargo.toml was updated to properly propagate the feature flag, ensuring that when users enable the <code>bevy_picking</code> feature at the top level, it automatically enables the corresponding feature in <code>bevy_input_focus</code>.<p>This approach demonstrates a common pattern in Rust ecosystem development: using optional dependencies and feature flags to make functionality modular. The change reduces binary size and compile times for users who don’t need picking functionality, while maintaining full backward compatibility for those who do.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[bevy_input_focus] --> B[Core Input Systems]
</span><span>    A --> C[Click-to-Focus System]
</span><span>    C --> D{bevy_picking feature}
</span><span>    D -->|enabled| E[bevy_picking dependency]
</span><span>    D -->|disabled| F[No picking dependency]
</span><span>    
</span><span>    G[bevy_internal] --> H[Feature Propagation]
</span><span>    H --> I[bevy_picking feature enables&LTbr>bevy_input_focus?/bevy_picking]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-input-focus-cargo-toml><code>crates/bevy_input_focus/Cargo.toml</code></h3><p><strong>Changes</strong>: Made <code>bevy_picking</code> dependency optional by adding <code>optional = true</code><pre class=language-toml data-lang=toml style=color:#61676c;background-color:#fafafa><code class=language-toml data-lang=toml><span style=color:#abb0b6;font-style:italic># Before:
</span><span style=color:#399ee6>bevy_picking </span><span>= { </span><span style=color:#399ee6>path </span><span>= </span><span style=color:#86b300>"../bevy_picking"</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>version </span><span>= </span><span style=color:#86b300>"0.18.0-dev"</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>default-features </span><span>= </span><span style=color:#ff8f40>false </span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic># After:  
</span><span style=color:#399ee6>bevy_picking </span><span>= { </span><span style=color:#399ee6>path </span><span>= </span><span style=color:#86b300>"../bevy_picking"</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>version </span><span>= </span><span style=color:#86b300>"0.18.0-dev"</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>default-features </span><span>= </span><span style=color:#ff8f40>false</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>optional </span><span>= </span><span style=color:#ff8f40>true </span><span>}
</span></code></pre><h3 id=crates-bevy-input-focus-src-tab-navigation-rs><code>crates/bevy_input_focus/src/tab_navigation.rs</code></h3><p><strong>Changes</strong>: Conditionally compiled picking-related code and removed direct imports<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>use </span><span>bevy_picking</span><span style=color:#ed9366>::</span><span>events</span><span style=color:#ed9366>::</span><span>{Pointer</span><span style=color:#61676ccc>,</span><span> Press}</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// ... in Plugin implementation
</span><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_observer</span><span>(click_to_focus)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#abb0b6;font-style:italic>// use statement removed
</span><span style=color:#abb0b6;font-style:italic>// ... in Plugin implementation  
</span><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_observer</span><span>(acquire_focus)</span><span style=color:#61676ccc>;
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"bevy_picking"</span><span>)]
</span><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_observer</span><span>(click_to_focus)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Function made conditional:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"bevy_picking"</span><span>)]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>click_to_focus</span><span>(
</span><span>    </span><span style=color:#ff8f40>press</span><span style=color:#61676ccc>: </span><span>On&LTbevy_picking</span><span style=color:#ed9366>::</span><span>events</span><span style=color:#ed9366>::</span><span>Pointer&LTbevy_picking</span><span style=color:#ed9366>::</span><span>events</span><span style=color:#ed9366>::</span><span>Press>>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... rest of function
</span><span>)
</span></code></pre><h3 id=crates-bevy-internal-cargo-toml><code>crates/bevy_internal/Cargo.toml</code></h3><p><strong>Changes</strong>: Updated feature propagation to handle the optional dependency<pre class=language-toml data-lang=toml style=color:#61676c;background-color:#fafafa><code class=language-toml data-lang=toml><span style=color:#abb0b6;font-style:italic># Before:
</span><span style=color:#399ee6>bevy_picking </span><span>= [</span><span style=color:#86b300>"dep:bevy_picking"</span><span>]
</span><span>
</span><span style=color:#abb0b6;font-style:italic># After:
</span><span style=color:#399ee6>bevy_picking </span><span>= [</span><span style=color:#86b300>"dep:bevy_picking"</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"bevy_input_focus?/bevy_picking"</span><span>]
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/cargo/reference/features.html target=_blank>Rust Book: Features</a> - Official documentation on Cargo features and optional dependencies<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/ target=_blank>Bevy Engine Documentation</a> - General Bevy engine concepts and architecture<li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/reference/conditional-compilation.html target=_blank>Conditional Compilation in Rust</a> - Rust reference on <code>#[cfg]</code> attributes and feature-based compilation</ul><h1 id=full-code-diff>Full Code Diff</h1><pre style=color:#61676c;background-color:#fafafa><code><span>diff --git a/crates/bevy_input_focus/Cargo.toml b/crates/bevy_input_focus/Cargo.toml
</span><span>index 1766ee2243b31..45d6acb60539c 100644
</span><span>--- a/crates/bevy_input_focus/Cargo.toml
</span><span>+++ b/crates/bevy_input_focus/Cargo.toml
</span><span>@@ -64,7 +64,7 @@ bevy_app = { path = "../bevy_app", version = "0.18.0-dev", default-features = fa
</span><span> bevy_ecs = { path = "../bevy_ecs", version = "0.18.0-dev", default-features = false }
</span><span> bevy_input = { path = "../bevy_input", version = "0.18.0-dev", default-features = false }
</span><span> bevy_math = { path = "../bevy_math", version = "0.18.0-dev", default-features = false }
</span><span>-bevy_picking = { path = "../bevy_picking", version = "0.18.0-dev", default-features = false }
</span><span>+bevy_picking = { path = "../bevy_picking", version = "0.18.0-dev", default-features = false, optional = true }
</span><span> bevy_window = { path = "../bevy_window", version = "0.18.0-dev", default-features = false }
</span><span> bevy_reflect = { path = "../bevy_reflect", version = "0.18.0-dev", features = [
</span><span>   "glam",
</span><span>diff --git a/crates/bevy_input_focus/src/tab_navigation.rs b/crates/bevy_input_focus/src/tab_navigation.rs
</span><span>index a490d00dda10e..b8ce6a8d95375 100644
</span><span>--- a/crates/bevy_input_focus/src/tab_navigation.rs
</span><span>+++ b/crates/bevy_input_focus/src/tab_navigation.rs
</span><span>@@ -38,7 +38,6 @@ use bevy_input::{
</span><span>     keyboard::{KeyCode, KeyboardInput},
</span><span>     ButtonInput, ButtonState,
</span><span> };
</span><span>-use bevy_picking::events::{Pointer, Press};
</span><span> use bevy_window::{PrimaryWindow, Window};
</span><span> use log::warn;
</span><span> use thiserror::Error;
</span><span>@@ -346,6 +345,7 @@ impl Plugin for TabNavigationPlugin {
</span><span>     fn build(&self, app: &mut App) {
</span><span>         app.add_systems(Startup, setup_tab_navigation);
</span><span>         app.add_observer(acquire_focus);
</span><span>+        #[cfg(feature = "bevy_picking")]
</span><span>         app.add_observer(click_to_focus);
</span><span>     }
</span><span> }
</span><span>@@ -356,8 +356,9 @@ fn setup_tab_navigation(mut commands: Commands, window: Query&LTEntity, With&LTPrima
</span><span>     }
</span><span> }
</span><span> 
</span><span>+#[cfg(feature = "bevy_picking")]
</span><span> fn click_to_focus(
</span><span>-    press: On&LTPointer&LTPress>>,
</span><span>+    press: On&LTbevy_picking::events::Pointer&LTbevy_picking::events::Press>>,
</span><span>     mut focus_visible: ResMut&LTInputFocusVisible>,
</span><span>     windows: Query&LTEntity, With&LTPrimaryWindow>>,
</span><span>     mut commands: Commands,
</span><span>diff --git a/crates/bevy_internal/Cargo.toml b/crates/bevy_internal/Cargo.toml
</span><span>index 32784290611be..f6872757b04a7 100644
</span><span>--- a/crates/bevy_internal/Cargo.toml
</span><span>+++ b/crates/bevy_internal/Cargo.toml
</span><span>@@ -316,7 +316,7 @@ pan_camera = ["bevy_camera_controller/pan_camera"]
</span><span> bevy_remote = ["dep:bevy_remote", "serialize"]
</span><span> 
</span><span> # Provides picking functionality
</span><span>-bevy_picking = ["dep:bevy_picking"]
</span><span>+bevy_picking = ["dep:bevy_picking", "bevy_input_focus?/bevy_picking"]
</span><span> 
</span><span> # Provides a mesh picking backend
</span><span> mesh_picking = ["bevy_picking", "bevy_picking/mesh_picking"]
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-10/pr_21659.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>