<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21625 Atmosphere bindings cleanup
        
    </title><meta content="#21625 Atmosphere bindings cleanup" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-10/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-10-29</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-10/pr-21625-zh-cn-20251029>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>Atmosphere bindings cleanup<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Atmosphere bindings cleanup<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21625<li><strong>Author</strong>: ecoskey<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, C-Code-Quality, S-Ready-For-Final-Review, D-Straightforward<li><strong>Created</strong>: 2025-10-21T21:37:08Z<li><strong>Merged</strong>: 2025-10-29T19:31:42Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>Depends on #20838<h1 id=objective>Objective</h1><p>There’s some redundant sampler bindings in the atmosphere code<h2 id=solution>Solution</h2><p>Remove them<h2 id=testing>Testing</h2><p>Ran the example<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a straightforward but important optimization in Bevy’s atmospheric rendering system. The core issue was redundant sampler bindings across multiple lookup tables (LUTs) used for atmospheric scattering calculations. Each LUT - transmittance, multiscattering, sky view, and aerial view - was using its own dedicated sampler, even though they all shared identical sampling parameters.<p>The implementation approach was systematic and consistent. The developer consolidated four separate samplers into a single shared <code>AtmosphereSampler</code> resource. This required coordinated changes across multiple components:<p>In the bind group layout definitions, the individual sampler bindings at indices 9, 11, 13, and 15 were replaced with a single shared sampler at binding 12. The texture bindings were reorganized to use consecutive indices (8-11) for better grouping.<p>The Rust code saw significant simplification. The previous <code>AtmosphereSamplers</code> struct containing four separate samplers was replaced with a single <code>AtmosphereSampler</code> that uses the <code>Deref</code> trait for easy access. All bind group preparation functions were updated to reference this single sampler rather than the individual ones.<p>The WGSL shader code was updated consistently across all compute and render shaders. Each shader that previously referenced individual samplers (<code>transmittance_lut_sampler</code>, <code>multiscattering_lut_sampler</code>, etc.) now uses the unified <code>atmosphere_lut_sampler</code>. The binding indices for storage textures and depth textures were also updated from 16 to 13 to maintain consistency with the new binding layout.<p>This change demonstrates good engineering practice in reducing redundancy and simplifying the binding model. By using a single sampler for all atmospheric LUTs, the code becomes more maintainable and reduces the GPU binding overhead. The consistent sampling parameters (linear filtering with nearest mipmapping) across all LUTs made this consolidation possible without affecting visual quality.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TB
</span><span>    A[AtmosphereSamplers] --> B[transmittance_lut_sampler]
</span><span>    A --> C[multiscattering_lut_sampler]
</span><span>    A --> D[sky_view_lut_sampler]
</span><span>    A --> E[aerial_view_lut_sampler]
</span><span>    
</span><span>    F[AtmosphereSampler] --> G[single shared sampler]
</span><span>    
</span><span>    H[WGSL Shaders] --> I[transmittance_lut.wgsl]
</span><span>    H --> J[multiscattering_lut.wgsl]
</span><span>    H --> K[sky_view_lut.wgsl]
</span><span>    H --> L[aerial_view_lut.wgsl]
</span><span>    H --> M[environment.wgsl]
</span><span>    H --> N[render_sky.wgsl]
</span><span>    
</span><span>    G --> I
</span><span>    G --> J
</span><span>    G --> K
</span><span>    G --> L
</span><span>    G --> M
</span><span>    G --> N
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-pbr-src-atmosphere-resources-rs-74-105><code>crates/bevy_pbr/src/atmosphere/resources.rs</code> (+74/-105)</h3><p>This file saw the most significant changes, replacing the multi-sampler approach with a single unified sampler:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Resource)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>AtmosphereSamplers </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>transmittance_lut</span><span style=color:#61676ccc>:</span><span> Sampler,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>multiscattering_lut</span><span style=color:#61676ccc>:</span><span> Sampler,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>sky_view_lut</span><span style=color:#61676ccc>:</span><span> Sampler,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>aerial_view_lut</span><span style=color:#61676ccc>:</span><span> Sampler,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Resource</span><span style=color:#61676ccc>,</span><span> Deref)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>AtmosphereSampler</span><span>(Sampler)</span><span style=color:#61676ccc>;
</span></code></pre><p>The bind group preparation functions were updated to use the single sampler:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>(</span><span style=color:#ff8f40>9</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>samplers</span><span style=color:#ed9366>.</span><span>transmittance_lut)</span><span style=color:#61676ccc>,
</span><span>(</span><span style=color:#ff8f40>11</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>samplers</span><span style=color:#ed9366>.</span><span>multiscattering_lut)</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>(</span><span style=color:#ff8f40>12</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&**</span><span>atmosphere_sampler)</span><span style=color:#61676ccc>,
</span></code></pre><h3 id=crates-bevy-pbr-src-atmosphere-environment-rs-18-23><code>crates/bevy_pbr/src/atmosphere/environment.rs</code> (+18/-23)</h3><p>Updated the environment map probe system to use the new binding model:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>(</span><span style=color:#ff8f40>9</span><span style=color:#61676ccc>, </span><span style=color:#f07171>sampler</span><span>(SamplerBindingType</span><span style=color:#ed9366>::</span><span>Filtering))</span><span style=color:#61676ccc>,
</span><span>(</span><span style=color:#ff8f40>11</span><span style=color:#61676ccc>, </span><span style=color:#f07171>sampler</span><span>(SamplerBindingType</span><span style=color:#ed9366>::</span><span>Filtering))</span><span style=color:#61676ccc>,
</span><span>(</span><span style=color:#ff8f40>13</span><span style=color:#61676ccc>, </span><span style=color:#f07171>sampler</span><span>(SamplerBindingType</span><span style=color:#ed9366>::</span><span>Filtering))</span><span style=color:#61676ccc>,
</span><span>(</span><span style=color:#ff8f40>15</span><span style=color:#61676ccc>, </span><span style=color:#f07171>sampler</span><span>(SamplerBindingType</span><span style=color:#ed9366>::</span><span>Filtering))</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>(</span><span style=color:#ff8f40>12</span><span style=color:#61676ccc>, </span><span style=color:#f07171>sampler</span><span>(SamplerBindingType</span><span style=color:#ed9366>::</span><span>Filtering))</span><span style=color:#61676ccc>,
</span></code></pre><h3 id=crates-bevy-pbr-src-atmosphere-bindings-wgsl-4-7><code>crates/bevy_pbr/src/atmosphere/bindings.wgsl</code> (+4/-7)</h3><p>Consolidated the sampler bindings in the WGSL interface:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#ed9366>@</span><span style=color:#f07171>group</span><span>(</span><span style=color:#ff8f40>0</span><span>) </span><span style=color:#ed9366>@</span><span style=color:#f07171>binding</span><span>(</span><span style=color:#ff8f40>9</span><span>) var transmittance_lut_sampler</span><span style=color:#61676ccc>:</span><span> sampler</span><span style=color:#61676ccc>;
</span><span style=color:#ed9366>@</span><span style=color:#f07171>group</span><span>(</span><span style=color:#ff8f40>0</span><span>) </span><span style=color:#ed9366>@</span><span style=color:#f07171>binding</span><span>(</span><span style=color:#ff8f40>11</span><span>) var multiscattering_lut_sampler</span><span style=color:#61676ccc>:</span><span> sampler</span><span style=color:#61676ccc>;
</span><span style=color:#ed9366>@</span><span style=color:#f07171>group</span><span>(</span><span style=color:#ff8f40>0</span><span>) </span><span style=color:#ed9366>@</span><span style=color:#f07171>binding</span><span>(</span><span style=color:#ff8f40>13</span><span>) var sky_view_lut_sampler</span><span style=color:#61676ccc>:</span><span> sampler</span><span style=color:#61676ccc>;
</span><span style=color:#ed9366>@</span><span style=color:#f07171>group</span><span>(</span><span style=color:#ff8f40>0</span><span>) </span><span style=color:#ed9366>@</span><span style=color:#f07171>binding</span><span>(</span><span style=color:#ff8f40>15</span><span>) var aerial_view_lut_sampler</span><span style=color:#61676ccc>:</span><span> sampler</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#ed9366>@</span><span style=color:#f07171>group</span><span>(</span><span style=color:#ff8f40>0</span><span>) </span><span style=color:#ed9366>@</span><span style=color:#f07171>binding</span><span>(</span><span style=color:#ff8f40>12</span><span>) var atmosphere_lut_sampler</span><span style=color:#61676ccc>:</span><span> sampler</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-pbr-src-atmosphere-functions-wgsl-7-8><code>crates/bevy_pbr/src/atmosphere/functions.wgsl</code> (+7/-8)</h3><p>Updated all sampling functions to use the unified sampler:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>return</span><span> textureSampleLevel(transmittance_lut</span><span style=color:#61676ccc>,</span><span> transmittance_lut_sampler</span><span style=color:#61676ccc>,</span><span> uv</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.0</span><span>)</span><span style=color:#ed9366>.</span><span>rgb</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>return</span><span> textureSampleLevel(transmittance_lut</span><span style=color:#61676ccc>,</span><span> atmosphere_lut_sampler</span><span style=color:#61676ccc>,</span><span> uv</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.0</span><span>)</span><span style=color:#ed9366>.</span><span>rgb</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-pbr-src-atmosphere-mod-rs-2-2><code>crates/bevy_pbr/src/atmosphere/mod.rs</code> (+2/-2)</h3><p>Updated the plugin to register the new sampler resource:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#ed9366>.</span><span>init_resource</span><span style=color:#ed9366>::</span><span>&LTAtmosphereSamplers>()
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#ed9366>.</span><span>init_resource</span><span style=color:#ed9366>::</span><span>&LTAtmosphereSampler>()
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://github.com/gpuweb/gpuweb/wiki/Bind-Group-Limits target=_blank>WebGPU Bind Group Best Practices</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/getting-started/systems/ target=_blank>Bevy Rendering Architecture</a><li><a rel="noopener nofollow noreferrer" href=https://www.w3.org/TR/WGSL/#sampler-types target=_blank>WGSL Sampler Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://developer.nvidia.com/gpugems/gpugems2/part-ii-shading-lighting-and-shadows/chapter-16-accurate-atmospheric-scattering target=_blank>Atmospheric Scattering Theory</a></ul><h1 id=full-code-diff>Full Code Diff</h1><p>[Full diff content as provided in the original request]</div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-10/pr_21625.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>