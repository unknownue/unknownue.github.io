<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20960 Added SSAO support on WebGPU, with R32Float fallback.
        
    </title><meta content="#20960 Added SSAO support on WebGPU, with R32Float fallback." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-10/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-10-29</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-10/pr-20960-zh-cn-20251029>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>Added SSAO support on WebGPU, with R32Float fallback.<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Added SSAO support on WebGPU, with R32Float fallback.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20960<li><strong>Author</strong>: diyu-motif<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Feature, A-Rendering, S-Ready-For-Final-Review, O-WebGPU<li><strong>Created</strong>: 2025-09-11T01:54:27Z<li><strong>Merged</strong>: 2025-10-29T18:38:57Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>This PR is to add SSAO support on WebGPU.<h2 id=solution>Solution</h2><p>Add r16float detect and fallback to r32float if not supported. FYI the initial ssao PR <a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/pull/7402 target=_blank>here</a>.<h2 id=testing>Testing</h2><ul><li><p>Did you test these changes? If so, how? Yes, here is the command to test the ssao example <code>RUSTFLAGS="--cfg getrandom_backend=\"wasm_js\"" cargo run --example ssao --target wasm32-unknown-unknown --features webgpu</code> and then http://localhost:1334, make sure it supports <a rel="noopener nofollow noreferrer" href=https://caniuse.com/webgpu target=_blank>WebGPU</a></p><li><p>Are there any parts that need more testing? N/A</p><li><p>How can other people (reviewers) test your changes? Is there anything specific they need to know?</p> <ol><li>For the R32Float fallback, only the 1st commit is needed. However, I ran into some strange flickering issue on Chrome (and Chrome canary too), so I added a “detect_r16float_support” flag and a temp fix in the 2nd and 3rd commit, which are intended to be reverted when merging.<li>with the 1st commit, Safari works fine, but Chrome has the flickering, and I fixed it by partially reverting a shader change from https://github.com/bevyengine/bevy/pull/20313, which is very strange. It is probably caused by some shader optimization issue in Chrome, and I have no clue why, as the change is just moving the calculation to a different function.<br> Here is the flickering on Mac Chrome(140.0.7339.133 (Official Build) (arm64)) <img alt=chrome_ssao height=327 src=https://github.com/user-attachments/assets/0666673f-508e-4b57-a152-19327ffdb6f3 width=353></ol><li><p>If relevant, what platforms did you test these changes on, and are there any important ones you can’t test? Tested on native(mac) and WebGPU. To test on native, set “detect_r16float_support” to false to force R32Float. I couldn’t make the WebGPU ssao example running on Windows 11 Chrome or Firefox, there is some error in ‘taa_pipeline’ .</p></ul><hr><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a compatibility issue with Screen Space Ambient Occlusion (SSAO) on WebGPU platforms. The core problem was that the original SSAO implementation assumed support for R16Float texture format with storage binding capabilities, which isn’t universally available across all GPU platforms, particularly in WebGPU environments.<p>The solution implements a runtime detection mechanism for R16Float support with a fallback to R32Float. The implementation follows a systematic approach: during pipeline initialization, the code checks whether the current render adapter supports R16Float with storage binding usage. If supported, it uses the more memory-efficient R16Float format; otherwise, it falls back to R32Float.<p>The key architectural change involves making the texture format selection dynamic rather than hardcoded. The <code>SsaoPipelines</code> struct now stores the selected <code>depth_format</code> and propagates this information throughout the rendering pipeline. This includes:<ol><li><strong>Pipeline Configuration</strong>: The format is used when creating storage texture bindings in compute pipelines<li><strong>Texture Allocation</strong>: SSAO textures are created using the detected format<li><strong>Shader Selection</strong>: Conditional compilation via shader defines (<code>USE_R16FLOAT</code>) ensures the correct texture format is used in WGSL shaders</ol><p>The implementation required modifications across multiple shader files to support both texture formats. Each shader that interacts with SSAO textures now includes conditional blocks that select the appropriate texture format based on the <code>USE_R16FLOAT</code> define:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>#ifdef USE_R16FLOAT
</span><span>@group(0) @binding(1) var preprocessed_depth_mip0: texture_storage_2d&LTr16float, write>;
</span><span>#else
</span><span>@group(0) @binding(1) var preprocessed_depth_mip0: texture_storage_2d&LTr32float, write>;
</span><span>#endif
</span></code></pre><p>During testing, the author encountered a flickering issue specifically in Chrome, which was resolved by partially reverting a shader optimization from a previous PR. This suggests potential shader compiler differences between browsers that required careful testing and debugging.<p>The changes maintain backward compatibility while extending support to WebGPU platforms. Systems that previously supported R16Float continue to use it, while unsupported platforms automatically fall back to R32Float without requiring user intervention.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[SSAO Plugin Init] --> B{Check R16Float Support}
</span><span>    B -->|Supported| C[Use R16Float Format]
</span><span>    B -->|Not Supported| D[Use R32Float Format]
</span><span>    C --> E[Set USE_R16FLOAT shader define]
</span><span>    D --> F[No special shader define]
</span><span>    E --> G[Compile shaders for R16Float]
</span><span>    F --> H[Compile shaders for R32Float]
</span><span>    G --> I[Create SSAO textures]
</span><span>    H --> I
</span><span>    I --> J[Render SSAO effects]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-pbr-src-ssao-mod-rs-37-22><code>crates/bevy_pbr/src/ssao/mod.rs</code> (+37/-22)</h3><p>This is the main coordination file that handles SSAO pipeline setup and texture management. The key changes include:<ol><li><strong>Removed hard requirement for R16Float support</strong>: The plugin no longer fails to load if R16Float storage binding isn’t supported<li><strong>Dynamic format detection</strong>: Added runtime detection of R16Float support with fallback to R32Float<li><strong>Propagated format through pipeline</strong>: The selected format is stored in <code>SsaoPipelines</code> and used throughout the rendering process</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Hardcoded format check that could prevent plugin loading
</span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>render_adapter</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_texture_format_features</span><span>(TextureFormat</span><span style=color:#ed9366>::</span><span>R16Float)
</span><span>    </span><span style=color:#ed9366>.</span><span>allowed_usages</span><span style=color:#ed9366>.</span><span style=color:#f07171>contains</span><span>(TextureUsages</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>STORAGE_BINDING</span><span>) {
</span><span>    </span><span style=color:#f07171>warn!</span><span>(</span><span style=color:#86b300>"ScreenSpaceAmbientOcclusionPlugin not loaded..."</span><span>)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Dynamic format selection
</span><span style=color:#fa6e32>let</span><span> depth_format </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>if</span><span> render_adapter
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>get_texture_format_features</span><span>(TextureFormat</span><span style=color:#ed9366>::</span><span>R16Float)
</span><span>    </span><span style=color:#ed9366>.</span><span>allowed_usages</span><span style=color:#ed9366>.</span><span style=color:#f07171>contains</span><span>(TextureUsages</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>STORAGE_BINDING</span><span>) {
</span><span>    TextureFormat</span><span style=color:#ed9366>::</span><span>R16Float
</span><span>} </span><span style=color:#fa6e32>else </span><span>{
</span><span>    TextureFormat</span><span style=color:#ed9366>::</span><span>R32Float
</span><span>}</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-pbr-src-ssao-preprocess-depth-wgsl-8-0><code>crates/bevy_pbr/src/ssao/preprocess_depth.wgsl</code> (+8/-0)</h3><p>This shader handles depth preprocessing for SSAO. The changes add conditional texture format declarations:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Added conditional texture format support
</span><span>#ifdef USE_R16FLOAT
</span><span>@group(0) @binding(1) var preprocessed_depth_mip0: texture_storage_2d&LTr16float, write>;
</span><span>#else
</span><span>@group(0) @binding(1) var preprocessed_depth_mip0: texture_storage_2d&LTr32float, write>;
</span><span>#endif
</span></code></pre><h3 id=crates-bevy-pbr-src-ssao-spatial-denoise-wgsl-4-0><code>crates/bevy_pbr/src/ssao/spatial_denoise.wgsl</code> (+4/-0)</h3><p>This shader handles spatial denoising for SSAO. Similar conditional format support was added:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>#ifdef USE_R16FLOAT
</span><span>@group(0) @binding(2) var ambient_occlusion: texture_storage_2d&LTr16float, write>;
</span><span>#else
</span><span>@group(0) @binding(2) var ambient_occlusion: texture_storage_2d&LTr32float, write>;
</span><span>#endif
</span></code></pre><h3 id=crates-bevy-pbr-src-ssao-ssao-wgsl-4-0><code>crates/bevy_pbr/src/ssao/ssao.wgsl</code> (+4/-0)</h3><p>The main SSAO shader received the same conditional format treatment:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>#ifdef USE_R16FLOAT
</span><span>@group(0) @binding(3) var ambient_occlusion: texture_storage_2d&LTr16float, write>;
</span><span>#else
</span><span>@group(0) @binding(3) var ambient_occlusion: texture_storage_2d&LTr32float, write>;
</span><span>#endif
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://www.w3.org/TR/webgpu/ target=_blank>WebGPU Specification</a> - Official WebGPU standard<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/pull/7402 target=_blank>Bevy SSAO Initial Implementation</a> - Original SSAO PR for context<li><a rel="noopener nofollow noreferrer" href=https://gpuweb.github.io/gpuweb/wgsl/#texture-formats target=_blank>WGSL Texture Formats</a> - WGSL texture format specifications<li><a rel="noopener nofollow noreferrer" href=https://developer.mozilla.org/en-US/docs/Web/API/GPU/adapter/features target=_blank>WebGPU Feature Detection</a> - MDN documentation on WebGPU feature detection</ul><h1 id=full-code-diff>Full Code Diff</h1><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_pbr/src/ssao/mod.rs b/crates/bevy_pbr/src/ssao/mod.rs
</span><span>index d9f24d4999aa7..9a94aa355ad3f 100644
</span><span style=color:#c594c5>--- a/crates/bevy_pbr/src/ssao/mod.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_pbr/src/ssao/mod.rs
</span><span style=color:#c594c5>@@ -60,17 +60,6 @@ </span><span style=color:#399ee6>impl Plugin for ScreenSpaceAmbientOcclusionPlugin {
</span><span>             return;
</span><span>         };
</span><span> 
</span><span style=color:#f07171>-        if !render_app
</span><span style=color:#f07171>-            .world()
</span><span style=color:#f07171>-            .resource::&LTRenderAdapter>()
</span><span style=color:#f07171>-            .get_texture_format_features(TextureFormat::R16Float)
</span><span style=color:#f07171>-            .allowed_usages
</span><span style=color:#f07171>-            .contains(TextureUsages::STORAGE_BINDING)
</span><span style=color:#f07171>-        {
</span><span style=color:#f07171>-            warn!("ScreenSpaceAmbientOcclusionPlugin not loaded. GPU lacks support: TextureFormat::R16Float does not support TextureUsages::STORAGE_BINDING.");
</span><span style=color:#f07171>-            return;
</span><span style=color:#f07171>-        }
</span><span style=color:#f07171>-
</span><span>         if render_app
</span><span>             .world()
</span><span>             .resource::&LTRenderDevice>()
</span><span style=color:#c594c5>@@ -299,6 +288,7 @@ </span><span style=color:#399ee6>struct SsaoPipelines {
</span><span>     linear_clamp_sampler: Sampler,
</span><span> 
</span><span>     shader: Handle&LTShader>,
</span><span style=color:#86b300>+    depth_format: TextureFormat,
</span><span> }
</span><span> 
</span><span> impl FromWorld for SsaoPipelines {
</span><span style=color:#c594c5>@@ -307,6 +297,18 @@ </span><span style=color:#399ee6>impl FromWorld for SsaoPipelines {
</span><span>         let render_queue = world.resource::&LTRenderQueue>();
</span><span>         let pipeline_cache = world.resource::&LTPipelineCache>();
</span><span> 
</span><span style=color:#86b300>+        // Detect the depth format support
</span><span style=color:#86b300>+        let render_adapter = world.resource::&LTRenderAdapter>();
</span><span style=color:#86b300>+        let depth_format = if render_adapter
</span><span style=color:#86b300>+            .get_texture_format_features(TextureFormat::R16Float)
</span><span style=color:#86b300>+            .allowed_usages
</span><span style=color:#86b300>+            .contains(TextureUsages::STORAGE_BINDING)
</span><span style=color:#86b300>+        {
</span><span style=color:#86b300>+            TextureFormat::R16Float
</span><span style=color:#86b300>+        } else {
</span><span style=color:#86b300>+            TextureFormat::R32Float
</span><span style=color:#86b300>+        };
</span><span style=color:#86b300>+
</span><span>         let hilbert_index_lut = render_device
</span><span>             .create_texture_with_data(
</span><span>                 render_queue,
</span><span style=color:#c594c5>@@ -364,11 +366,11 @@ </span><span style=color:#399ee6>impl FromWorld for SsaoPipelines {
</span><span>                 ShaderStages::COMPUTE,
</span><span>                 (
</span><span>                     texture_depth_2d(),
</span><span style=color:#f07171>-                    texture_storage_2d(TextureFormat::R16Float, StorageTextureAccess::WriteOnly),
</span><span style=color:#f07171>-                    texture_storage_2d(TextureFormat::R16Float, StorageTextureAccess::WriteOnly),
</span><span style=color:#f07171>-                    texture_storage_2d(TextureFormat::R16Float, StorageTextureAccess::WriteOnly),
</span><span style=color:#f07171>-                    texture_storage_2d(TextureFormat::R16Float, StorageTextureAccess::WriteOnly),
</span><span style=color:#f07171>-                    texture_storage_2d(TextureFormat::R16Float, StorageTextureAccess::WriteOnly),
</span><span style=color:#86b300>+                    texture_storage_2d(depth_format, StorageTextureAccess::WriteOnly),
</span><span style=color:#86b300>+                    texture_storage_2d(depth_format, StorageTextureAccess::WriteOnly),
</span><span style=color:#86b300>+                    texture_storage_2d(depth_format, StorageTextureAccess::WriteOnly),
</span><span style=color:#86b300>+                    texture_storage_2d(depth_format, StorageTextureAccess::WriteOnly),
</span><span style=color:#86b300>+                    texture_storage_2d(depth_format, StorageTextureAccess::WriteOnly),
</span><span>                 ),
</span><span>             ),
</span><span>         );
</span><span style=color:#c594c5>@@ -381,7 +383,7 @@ </span><span style=color:#399ee6>impl FromWorld for SsaoPipelines {
</span><span>                     texture_2d(TextureSampleType::Float { filterable: true }),
</span><span>                     texture_2d(TextureSampleType::Float { filterable: false }),
</span><span>                     texture_2d(TextureSampleType::Uint),
</span><span style=color:#f07171>-                    texture_storage_2d(TextureFormat::R16Float, StorageTextureAccess::WriteOnly),
</span><span style=color:#86b300>+                    texture_storage_2d(depth_format, StorageTextureAccess::WriteOnly),
</span><span>                     texture_storage_2d(TextureFormat::R32Uint, StorageTextureAccess::WriteOnly),
</span><span>                     uniform_buffer::&LTGlobalsUniform>(false),
</span><span>                     uniform_buffer::&LTf32>(false),
</span><span style=color:#c594c5>@@ -396,11 +398,16 @@ </span><span style=color:#399ee6>impl FromWorld for SsaoPipelines {
</span><span>                 (
</span><span>                     texture_2d(TextureSampleType::Float { filterable: false }),
</span><span>                     texture_2d(TextureSampleType::Uint),
</span><span style=color:#f07171>-                    texture_storage_2d(TextureFormat::R16Float, StorageTextureAccess::WriteOnly),
</span><span style=color:#86b300>+                    texture_storage_2d(depth_format, StorageTextureAccess::WriteOnly),
</span><span>                 ),
</span><span>             ),
</span><span>         );
</span><span> 
</span><span style=color:#86b300>+        let mut shader_defs = Vec::new();
</span><span style=color:#86b300>+        if depth_format == TextureFormat::R16Float {
</span><span style=color:#86b300>+            shader_defs.push("USE_R16FLOAT".into());
</span><span style=color:#86b300>+        }
</span><span style=color:#86b300>+
</span><span>         let preprocess_depth_pipeline =
</span><span>             pipeline_cache.queue_compute_pipeline(ComputePipelineDescriptor {
</span><span>                 label: Some("ssao_preprocess_depth_pipeline".into()),
</span><span style=color:#c594c5>@@ -409,6 +416,7 @@ </span><span style=color:#399ee6>impl FromWorld for SsaoPipelines {
</span><span>                     common_bind_group_layout.clone(),
</span><span>                 ],
</span><span>                 shader: load_embedded_asset!(world, "preprocess_depth.wgsl"),
</span><span style=color:#86b300>+                shader_defs: shader_defs.clone(),
</span><span>                 ..default()
</span><span>             });
</span><span> 
</span><span style=color:#c594c5>@@ -420,6 +428,7 @@ </span><span style=color:#399ee6>impl FromWorld for SsaoPipelines {
</span><span>                     common_bind_group_layout.clone(),
</span><span>                 ],
</span><span>                 shader: load_embedded_asset!(world, "spatial_denoise.wgsl"),
</span><span style=color:#86b300>+                shader_defs,
</span><span>                 ..default()
</span><span>             });
</span><span> 
</span><span style=color:#c594c5>@@ -437,6 +446,7 @@ </span><span style=color:#399ee6>impl FromWorld for SsaoPipelines {
</span><span>             linear_clamp_sampler,
</span><span> 
</span><span>             shader: load_embedded_asset!(world, "ssao.wgsl"),
</span><span style=color:#86b300>+            depth_format,
</span><span>         }
</span><span>     }
</span><span> }
</span><span style=color:#c594c5>@@ -465,6 +475,10 @@ </span><span style=color:#399ee6>impl SpecializedComputePipeline for SsaoPipelines {
</span><span>             shader_defs.push("TEMPORAL_JITTER".into());
</span><span>         }
</span><span> 
</span><span style=color:#86b300>+        if self.depth_format == TextureFormat::R16Float {
</span><span style=color:#86b300>+            shader_defs.push("USE_R16FLOAT".into());
</span><span style=color:#86b300>+        }
</span><span style=color:#86b300>+
</span><span>         ComputePipelineDescriptor {
</span><span>             label: Some("ssao_ssao_pipeline".into()),
</span><span>             layout: vec![
</span><span style=color:#c594c5>@@ -519,6 +533,7 @@ </span><span style=color:#399ee6>fn prepare_ssao_textures(
</span><span>     mut commands: Commands,
</span><span>     mut texture_cache: ResMut&LTTextureCache>,
</span><span>     render_device: Res&LTRenderDevice>,
</span><span style=color:#86b300>+    pipelines: Res&LTSsaoPipelines>,
</span><span>     views: Query<(Entity, &ExtractedCamera, &ScreenSpaceAmbientOcclusion)>,
</span><span> ) {
</span><span>     for (entity, camera, ssao_settings) in &views {
</span><span style=color:#c594c5>@@ -535,7 +550,7 @@ </span><span style=color:#399ee6>fn prepare_ssao_textures(
</span><span>                 mip_level_count: 5,
</span><span>                 sample_count: 1,
</span><span>                 dimension: TextureDimension::D2,
</span><span style=color:#f07171>-                format: TextureFormat::R16Float,
</span><span style=color:#86b300>+                format: pipelines.depth_format,
</span><span>                 usage: TextureUsages::STORAGE_BINDING | TextureUsages::TEXTURE_BINDING,
</span><span>                 view_formats: &[],
</span><span>             },
</span><span style=color:#c594c5>@@ -549,7 +564,7 @@ </span><span style=color:#399ee6>fn prepare_ssao_textures(
</span><span>                 mip_level_count: 1,
</span><span>                 sample_count: 1,
</span><span>                 dimension: TextureDimension::D2,
</span><span style=color:#f07171>-                format: TextureFormat::R16Float,
</span><span style=color:#86b300>+                format: pipelines.depth_format,
</span><span>                 usage: TextureUsages::STORAGE_BINDING | TextureUsages::TEXTURE_BINDING,
</span><span>                 view_formats: &[],
</span><span>             },
</span><span style=color:#c594c5>@@ -563,7 +578,7 @@ </span><span style=color:#399ee6>fn prepare_ssao_textures(
</span><span>                 mip_level_count: 1,
</span><span>                 sample_count: 1,
</span><span>                 dimension: TextureDimension::D2,
</span><span style=color:#f07171>-                format: TextureFormat::R16Float,
</span><span style=color:#86b300>+                format: pipelines.depth_format,
</span><span>                 usage: TextureUsages::STORAGE_BINDING | TextureUsages::TEXTURE_BINDING,
</span><span>                 view_formats: &[],
</span><span>             },
</span><span style=color:#c594c5>@@ -670,7 +685,7 @@ </span><span style=color:#399ee6>fn prepare_ssao_bind_groups(
</span><span>                 .create_view(&TextureViewDescriptor {
</span><span>                     label: Some("ssao_preprocessed_depth_texture_mip_view"),
</span><span>                     base_mip_level: mip_level,
</span><span style=color:#f07171>-                    format: Some(TextureFormat::R16Float),
</span><span style=color:#86b300>+                    format: Some(pipelines.depth_format),
</span><span>                     dimension: Some(TextureViewDimension::D2),
</span><span>                     mip_level_count: Some(1),
</span><span>                     ..default()
</span><span>diff --git a/crates/bevy_pbr/src/ssao/preprocess_depth.wgsl b/crates/bevy_pbr/src/ssao/preprocess_depth.wgsl
</span><span>index a386b09d9c23c..bce9e56f59e06 100644
</span><span style=color:#c594c5>--- a/crates/bevy_pbr/src/ssao/preprocess_depth.wgsl
</span><span style=color:#c594c5>+++ b/crates/bevy_pbr/src/ssao/preprocess_depth.wgsl
</span><span style=color:#c594c5>@@ -8,11 +8,19 @@
</span><span> #import bevy_render::view::View
</span><span> 
</span><span> @group(0) @binding(0) var input_depth: texture_depth_2d;
</span><span style=color:#86b300>+#ifdef USE_R16FLOAT
</span><span> @group(0) @binding(1) var preprocessed_depth_mip0: texture_storage_2d&LTr16float, write>;
</span><span> @group(0) @binding(2) var preprocessed_depth_mip1: texture_storage_2d&LTr16float, write>;
</span><span> @group(0) @binding(3) var preprocessed_depth_mip2: texture_storage_2d&LTr16float, write>;
</span><span> @group(0) @binding(4) var preprocessed_depth_mip3: texture_storage_2d&LTr16float, write>;
</span><span> @group(0) @binding(5) var preprocessed_depth_mip4: texture_storage_2d&LTr16float, write>;
</span><span style=color:#86b300>+#else
</span><span style=color:#86b300>+@group(0) @binding(1) var preprocessed_depth_mip0: texture_storage_2d&LTr32float, write>;
</span><span style=color:#86b300>+@group(0) @binding(2) var preprocessed_depth_mip1: texture_storage_2d&LTr32float, write>;
</span><span style=color:#86b300>+@group(0) @binding(3) var preprocessed_depth_mip2: texture_storage_2d&LTr32float, write>;
</span><span style=color:#86b300>+@group(0) @binding(4) var preprocessed_depth_mip3: texture_storage_2d&LTr32float, write>;
</span><span style=color:#86b300>+@group(0) @binding(5) var preprocessed_depth_mip4: texture_storage_2d&LTr32float, write>;
</span><span style=color:#86b300>+#endif
</span><span> @group(1) @binding(0) var point_clamp_sampler: sampler;
</span><span> @group(1) @binding(1) var linear_clamp_sampler: sampler;
</span><span> @group(1) @binding(2) var&LTuniform> view: View;
</span><span>diff --git a/crates/bevy_pbr/src/ssao/spatial_denoise.wgsl b/crates/bevy_pbr/src/ssao/spatial_denoise.wgsl
</span><span>index 1c04f9cfab2f7..f61934fb462d5 100644
</span><span style=color:#c594c5>--- a/crates/bevy_pbr/src/ssao/spatial_denoise.wgsl
</span><span style=color:#c594c5>+++ b/crates/bevy_pbr/src/ssao/spatial_denoise.wgsl
</span><span style=color:#c594c5>@@ -13,7 +13,11 @@
</span><span> 
</span><span> @group(0) @binding(0) var ambient_occlusion_noisy: texture_2d&LTf32>;
</span><span> @group(0) @binding(1) var depth_differences: texture_2d&LTu32>;
</span><span style=color:#86b300>+#ifdef USE_R16FLOAT
</span><span> @group(0) @binding(2) var ambient_occlusion: texture_storage_2d&LTr16float, write>;
</span><span style=color:#86b300>+#else
</span><span style=color:#86b300>+@group(0) @binding(2) var ambient_occlusion: texture_storage_2d&LTr32float, write>;
</span><span style=color:#86b300>+#endif
</span><span> @group(1) @binding(0) var point_clamp_sampler: sampler;
</span><span> @group(1) @binding(1) var linear_clamp_sampler: sampler;
</span><span> @group(1) @binding(2) var&LTuniform> view: View;
</span><span>diff --git a/crates/bevy_pbr/src/ssao/ssao.wgsl b/crates/bevy_pbr/src/ssao/ssao.wgsl
</span><span>index ac64d5653f7a4..aa715be052152 100644
</span><span style=color:#c594c5>--- a/crates/bevy_pbr/src/ssao/ssao.wgsl
</span><span style=color:#c594c5>+++ b/crates/bevy_pbr/src/ssao/ssao.wgsl
</span><span style=color:#c594c5>@@ -21,7 +21,11 @@
</span><span> @group(0) @binding(0) var preprocessed_depth: texture_2d&LTf32>;
</span><span> @group(0) @binding(1) var normals: texture_2d&LTf32>;
</span><span> @group(0) @binding(2) var hilbert_index_lut: texture_2d&LTu32>;
</span><span style=color:#86b300>+#ifdef USE_R16FLOAT
</span><span> @group(0) @binding(3) var ambient_occlusion: texture_storage_2d&LTr16float, write>;
</span><span style=color:#86b300>+#else
</span><span style=color:#86b300>+@group(0) @binding(3) var ambient_occlusion: texture_storage_2d&LTr32float, write>;
</span><span style=color:#86b300>+#endif
</span><span> @group(0) @binding(4) var depth_differences: texture_storage_2d&LTr32uint, write>;
</span><span> @group(0) @binding(5) var&LTuniform> globals: Globals;
</span><span> @group(0) @binding(6) var&LTuniform> thickness: f32;
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-10/pr_20960.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>