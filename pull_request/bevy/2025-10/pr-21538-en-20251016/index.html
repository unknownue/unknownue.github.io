<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21538 refactor(free-cam): separate configuration settings and dynamic state for the free camera controller
        
    </title><meta content="#21538 refactor(free-cam): separate configuration settings and dynamic state for the free camera controller" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-10/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-10-16</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-10/pr-21538-zh-cn-20251016>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: refactor(free-cam): separate configuration settings and dynamic state for the free camera controller<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21538<li><strong>Author</strong>: syszery<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Usability, S-Ready-For-Final-Review, A-Camera<li><strong>Created</strong>: 2025-10-14T11:01:51Z<li><strong>Merged</strong>: 2025-10-16T22:14:15Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>This PR refactors the <code>FreeCam</code> controller to improve its modularity and flexibility. Happy to adjust based on feedback or suggestions!<p>Fixes #21456<h2 id=solution>Solution</h2><ul><li><strong>Splits the <code>FreeCam</code> system into two components</strong>: <ul><li><code>FreeCam</code>: Stores the <strong>configuration</strong> of the camera controller, including key bindings, movement speeds, and sensitivity. This struct is immutable during runtime, ensuring that the core settings stay consistent.<li><code>FreeCamState</code>: Manages the <strong>dynamic runtime state</strong> of the camera, such as the current pitch, yaw, velocity, and speed multiplier. This component allows for real-time adjustments to camera behavior without altering the original settings.</ul><li><strong>Improves the example for debugging and testing</strong>: A simplified example (<code>free_cam_simple</code>) has been introduced, allowing for easy testing and showcasing of the new FreeCam controller system.<li><strong>Fixes the bug with translation speed</strong>: As noted in #21483, the camera’s translation speed would “stick” after excessive scrolling. This bug was still present in the <code>free_cam_controller</code> example. Following the approach suggested in #21486, the bug has been resolved in the new <code>free_cam_simple</code> example (I did not yet verify the existing ones).<li><strong>Clarifies documentation</strong>: Documentation has been updated to reflect the new structure, clearly describing the roles of both <code>FreeCam</code> (static settings) and <code>FreeCamState</code> (dynamic state).</ul><h2 id=testing>Testing</h2><ul><li>For testing, I added a simple example <code>free_cam_simple</code> as a POC (this can be removed later if no longer needed).<li>Run with: <code>cargo run --example free_cam_simple --features="free_cam"</code></ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The FreeCam controller in Bevy was facing a fundamental architectural issue where configuration and runtime state were mixed together in a single component. This created problems with code organization, maintainability, and introduced subtle bugs in camera behavior.<p>The original <code>FreeCam</code> component contained both static configuration settings (like key bindings, movement speeds, and sensitivity) and dynamic runtime state (like current pitch, yaw, velocity, and enabled status). This mixing of concerns made the system difficult to reason about and modify. For example, if a developer wanted to change camera settings at runtime through a menu system, they would be modifying the same component that contained critical runtime state, potentially causing unexpected behavior.<p>The solution approach was to apply the separation of concerns principle by splitting the monolithic <code>FreeCam</code> component into two distinct components. The <code>FreeCam</code> component now exclusively handles configuration settings that are meant to be relatively stable during gameplay, while the new <code>FreeCamState</code> component manages all the dynamic state that changes frequently during camera operation.<p>Looking at the implementation, the key change was restructuring the component definitions:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Mixed configuration and state
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>FreeCam </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>enabled</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>bool</span><span>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>initialized</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>bool</span><span>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>sensitivity</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>key_forward</span><span style=color:#61676ccc>:</span><span> KeyCode,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... more config fields
</span><span>    </span><span style=color:#fa6e32>pub </span><span>pitch</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>yaw</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>velocity</span><span style=color:#61676ccc>:</span><span> Vec3,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Separate components
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>FreeCam </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>sensitivity</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>key_forward</span><span style=color:#61676ccc>:</span><span> KeyCode,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... only config fields
</span><span>}
</span><span>
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>FreeCamState </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>enabled</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>bool</span><span>,
</span><span>    initialized</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>bool</span><span>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>pitch</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>yaw</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>speed_multiplier</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>velocity</span><span style=color:#61676ccc>:</span><span> Vec3,
</span><span>}
</span></code></pre><p>This separation had significant technical benefits. The <code>FreeCam</code> component can now be treated as essentially immutable from the controller’s perspective, while <code>FreeCamState</code> handles all the volatile data. The relationship between these components is enforced using Bevy’s <code>#[require(FreeCamState)]</code> attribute, ensuring that any entity with a <code>FreeCam</code> component automatically gets the necessary state component.<p>The system logic was updated to query for both components:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>mut</span><span> query</span><span style=color:#61676ccc>: </span><span>Query<(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> Transform, </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> FreeCam), With&LTCamera>>
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:  
</span><span style=color:#fa6e32>mut</span><span> query</span><span style=color:#61676ccc>: </span><span>Query<(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> Transform, </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> FreeCamState, </span><span style=color:#ed9366>&</span><span>FreeCam), With&LTCamera>>
</span></code></pre><p>This change also fixed a known bug with camera translation speed. The original implementation directly modified the <code>walk_speed</code> and <code>run_speed</code> configuration values when scrolling, which could lead to the speed “sticking” at extreme values. The new approach introduces a <code>speed_multiplier</code> in the state component:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Fixed scroll handling:
</span><span>state</span><span style=color:#ed9366>.</span><span>speed_multiplier </span><span style=color:#ed9366>+=</span><span> scroll </span><span style=color:#ed9366>*</span><span> controller</span><span style=color:#ed9366>.</span><span>scroll_factor</span><span style=color:#61676ccc>;
</span><span>state</span><span style=color:#ed9366>.</span><span>speed_multiplier </span><span style=color:#ed9366>=</span><span> state</span><span style=color:#ed9366>.</span><span>speed_multiplier</span><span style=color:#ed9366>.</span><span style=color:#f07171>clamp</span><span>(</span><span style=color:#ff8f40>0.0</span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>f32</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>MAX</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><p>The speed calculation then uses this multiplier:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let</span><span> max_speed </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>if</span><span> key_input</span><span style=color:#ed9366>.</span><span style=color:#f07171>pressed</span><span>(controller</span><span style=color:#ed9366>.</span><span>key_run) {
</span><span>    controller</span><span style=color:#ed9366>.</span><span>run_speed </span><span style=color:#ed9366>*</span><span> state</span><span style=color:#ed9366>.</span><span>speed_multiplier
</span><span>} </span><span style=color:#fa6e32>else </span><span>{
</span><span>    controller</span><span style=color:#ed9366>.</span><span>walk_speed </span><span style=color:#ed9366>*</span><span> state</span><span style=color:#ed9366>.</span><span>speed_multiplier
</span><span>}</span><span style=color:#61676ccc>;
</span></code></pre><p>This approach keeps the base configuration values intact while allowing temporary speed adjustments through the state component.<p>The architectural impact of this change is substantial. It makes the camera controller more modular and easier to extend. For example, implementing features like camera presets, save/load functionality, or runtime configuration changes becomes much simpler because the configuration is cleanly separated from the operational state.<p>The example code was also updated to reflect these changes, with queries now needing to access both components where previously only one was needed. This demonstrates how the separation affects client code and ensures that the examples remain functional and educational.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[FreeCam Component] --> B[FreeCamState Component]
</span><span>    B --> C[Transform Component]
</span><span>    A --> D[Configuration Settings]
</span><span>    B --> E[Runtime State]
</span><span>    
</span><span>    subgraph "Configuration (Immutable)"
</span><span>        D[Key Bindings&LTbr/>Movement Speeds&LTbr/>Sensitivity&LTbr/>Scroll Factor&LTbr/>Friction]
</span><span>    end
</span><span>    
</span><span>    subgraph "Dynamic State (Mutable)" 
</span><span>        E[Enabled Flag&LTbr/>Pitch/Yaw&LTbr/>Velocity&LTbr/>Speed Multiplier&LTbr/>Initialized Flag]
</span><span>    end
</span><span>    
</span><span>    subgraph "Camera Entity"
</span><span>        C[Transform&LTbr/>Position/Rotation]
</span><span>    end
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-camera-controller-src-free-cam-rs-84-50><code>crates/bevy_camera_controller/src/free_cam.rs</code> (+84/-50)</h3><p>This file contains the core refactoring that separates configuration from state. The main changes include:<ol><li><strong>Component Separation</strong>: Split the original <code>FreeCam</code> struct into <code>FreeCam</code> (configuration) and <code>FreeCamState</code> (runtime state)<li><strong>System Updates</strong>: Modified the <code>run_freecam_controller</code> system to work with both components<li><strong>Bug Fixes</strong>: Implemented proper speed multiplier handling to fix scroll wheel issues<li><strong>Documentation</strong>: Updated comments to clearly explain the new architecture</ol><p>Key code changes:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Single component with mixed concerns
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>FreeCam </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>enabled</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>bool</span><span>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>initialized</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>bool</span><span>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>sensitivity</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... config fields
</span><span>    </span><span style=color:#fa6e32>pub </span><span>pitch</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>yaw</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>, 
</span><span>    </span><span style=color:#fa6e32>pub </span><span>velocity</span><span style=color:#61676ccc>:</span><span> Vec3,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Separate configuration component  
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>require</span><span>(FreeCamState)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>FreeCam </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>sensitivity</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... only configuration fields
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Removed: enabled, initialized, pitch, yaw, velocity
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// New state component
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>FreeCamState </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>enabled</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>bool</span><span>,
</span><span>    initialized</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>bool</span><span>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>pitch</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>yaw</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>speed_multiplier</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>velocity</span><span style=color:#61676ccc>:</span><span> Vec3,
</span><span>}
</span></code></pre><h3 id=examples-camera-free-cam-controller-rs-14-8><code>examples/camera/free_cam_controller.rs</code> (+14/-8)</h3><p>This example file was updated to work with the new component structure. The changes demonstrate how to properly query and modify both components in user code.<p>Key code changes:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Single component query
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>update_camera_settings</span><span>(</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>camera_query</span><span style=color:#61676ccc>: </span><span>Query<</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> FreeCam>, </span><span style=color:#ff8f40>input</span><span style=color:#61676ccc>: </span><span>Res&LTButtonInput&LTKeyCode>>) {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> free_cam </span><span style=color:#ed9366>=</span><span> camera_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>single_mut</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... modify free_cam fields
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Query both components
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>update_camera_settings</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>camera_query</span><span style=color:#61676ccc>: </span><span>Query<(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> FreeCam, </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> FreeCamState)>,
</span><span>    </span><span style=color:#ff8f40>input</span><span style=color:#61676ccc>: </span><span>Res&LTButtonInput&LTKeyCode>>,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>let </span><span>(</span><span style=color:#fa6e32>mut</span><span> free_cam</span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>mut</span><span> free_cam_state) </span><span style=color:#ed9366>=</span><span> camera_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>single_mut</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... modify free_cam for config, free_cam_state for runtime state
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/ecs/ target=_blank>Bevy ECS Documentation</a> - Understanding component composition and queries<li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Separation_of_concerns target=_blank>Separation of Concerns Principle</a> - Architectural pattern demonstrated in this PR<li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Entity_component_system target=_blank>Entity Component System Pattern</a> - Core architectural pattern used by Bevy<li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_camera_controller/latest/bevy_camera_controller/ target=_blank>Bevy Camera Controller Documentation</a> - Official documentation for the camera controller crate</ul><h1 id=full-code-diff>Full Code Diff</h1><p>diff –git a/crates/bevy_camera_controller/src/free_cam.rs b/crates/bevy_camera_controller/src/free_cam.rs index b640786b18bdc..37a064d00ba98 100644 — a/crates/bevy_camera_controller/src/free_cam.rs +++ b/crates/bevy_camera_controller/src/free_cam.rs @@ -10,7 +10,8 @@ //! By contrast, the default settings of this particular free cam are optimized for precise control. //! //! To use this controller, add [<code>FreeCamPlugin</code>] to your app, -//! and [<code>FreeCam</code>] to your camera entity. +//! and attach the [<code>FreeCam</code>] component to your camera entity. +//! The required [<code>FreeCamState</code>] component will be added automatically. //! //! To configure the settings of this controller, modify the fields of the [<code>FreeCam</code>] component.<p>@@ -32,8 +33,8 @@ use core::{f32::consts::*, fmt};<p>/// A freecam-style camera controller plugin. /// -/// Use [<code>FreeCam</code>] to add a freecam controller to a camera entity, -/// and change its values to customize the controls and change its behavior. +/// Use the [<code>FreeCam</code>] struct to add and customize the controller for a camera entity. +/// The camera’s dynamic state is managed by the [<code>FreeCamState</code>] struct. pub struct FreeCamPlugin;<p>impl Plugin for FreeCamPlugin { @@ -53,16 +54,22 @@ impl Plugin for FreeCamPlugin { /// it because it felt nice. const RADIANS_PER_DOT: f32 = 1.0 / 180.0;<p>-/// Freecam controller settings and state. +/// Stores the settings for the [<code>FreeCam</code>] controller. /// -/// Add this component to a [<code>Camera</code>] entity and add [<code>FreeCamPlugin</code>] -/// to your [<code>App</code>] to enable freecam controls. +/// This component defines static configuration for camera controls, +/// including movement speed, sensitivity, and input bindings. +/// +/// From the controller’s perspective, this data is treated as immutable, +/// but it may be modified externally (e.g., by a settings UI) at runtime. +/// +/// Add this component to a [<code>Camera</code>] entity to enable freecam controls. +/// The associated dynamic state is automatically handled by [<code>FreeCamState</code>], +/// which is added to the entity as a required component. +/// +/// To activate the controller, add the [<code>FreeCamPlugin</code>] to your [<code>App</code>]. #[derive(Component)] +#[require(FreeCamState)] pub struct FreeCam {<ul><li>/// Enables this [<code>FreeCam</code>] when <code>true</code>.<li>pub enabled: bool,<li>/// Indicates if this controller has been initialized by the [<code>FreeCamPlugin</code>].<li>pub initialized: bool, /// Multiplier for pitch and yaw rotation speed. pub sensitivity: f32, /// [<code>KeyCode</code>] for forward translation. @@ -84,28 +91,20 @@ pub struct FreeCam { pub mouse_key_cursor_grab: MouseButton, /// [<code>KeyCode</code>] for grabbing the keyboard focus. pub keyboard_key_toggle_cursor_grab: KeyCode,<li>/// Multiplier for unmodified translation speed.</ul><ul><li>/// Base multiplier for unmodified translation speed. pub walk_speed: f32,</ul><ul><li>/// Multiplier for running translation speed.</ul><ul><li>/// Base multiplier for running translation speed. pub run_speed: f32, /// Multiplier for how the mouse scroll wheel modifies <a href=FreeCam::walk_speed><code>walk_speed</code></a> /// and <a href=FreeCam::run_speed><code>run_speed</code></a>. pub scroll_factor: f32,</ul><ul><li>/// Friction factor used to exponentially decay <a href=FreeCam::velocity><code>velocity</code></a> over time.</ul><ul><li>/// Friction factor used to exponentially decay <a href=FreeCamState::velocity><code>velocity</code></a> over time. pub friction: f32,</ul><ul><li>/// This [<code>FreeCam</code>]’s pitch rotation.<li>pub pitch: f32,<li>/// This [<code>FreeCam</code>]’s yaw rotation.<li>pub yaw: f32,<li>/// This [<code>FreeCam</code>]’s translation velocity.<li>pub velocity: Vec3, }</ul><p>impl Default for FreeCam { fn default() -> Self { Self {<ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>       enabled: true,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       initialized: false,
</span><span>       sensitivity: 0.2,
</span><span>       key_forward: KeyCode::KeyW,
</span><span>       key_back: KeyCode::KeyS,
</span></code></pre></ul><p>@@ -120,9 +119,6 @@ impl Default for FreeCam { run_speed: 15.0, scroll_factor: 0.5, friction: 40.0,<ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>       pitch: 0.0,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       yaw: 0.0,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       velocity: Vec3::ZERO,
</span><span>   }
</span></code></pre> } } @@ -154,10 +150,48 @@ Freecam Controls: } }</ul><p>-/// This system is typically added via the [<code>FreeCamPlugin</code>]. +/// Tracks the runtime state of a [<code>FreeCam</code>] controller. /// -/// Reads inputs and then moves the camera entity according -/// to the settings given in [<code>FreeCam</code>]. +/// This component holds dynamic data that changes during camera operation, +/// such as pitch, yaw, velocity, and whether the controller is currently enabled. +/// +/// It is automatically added to any entity that has a [<code>FreeCam</code>] component, +/// and is updated by the [<code>FreeCamPlugin</code>] systems in response to user input. +#[derive(Component)] +pub struct FreeCamState {<ul><li>/// Enables [<code>FreeCam</code>] controls when <code>true</code>.<li>pub enabled: bool,<li>/// Internal flag indicating if this controller has been initialized by the [<code>FreeCamPlugin</code>].<li>initialized: bool,<li>/// This [<code>FreeCam</code>]’s pitch rotation.<li>pub pitch: f32,<li>/// This [<code>FreeCam</code>]’s yaw rotation.<li>pub yaw: f32,<li>/// Multiplier applied to movement speed.<li>pub speed_multiplier: f32,<li>/// This [<code>FreeCam</code>]’s translation velocity.<li>pub velocity: Vec3, +}<li></ul><p>+impl Default for FreeCamState {<ul><li>fn default() -> Self {<li><pre style=color:#61676c;background-color:#fafafa><code><span>   Self {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       enabled: true,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       initialized: false,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       pitch: 0.0,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       yaw: 0.0,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       speed_multiplier: 1.0,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       velocity: Vec3::ZERO,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   }
</span></code></pre><li>} +}<li></ul><p>+/// Updates the camera’s position and orientation based on user input. +/// +/// - [<code>FreeCam</code>] contains static configuration such as key bindings, movement speed, and sensitivity. +/// - [<code>FreeCamState</code>] stores the dynamic runtime state, including pitch, yaw, velocity, and enable flags. +/// +/// This system is typically added via the [<code>FreeCamPlugin</code>]. pub fn run_freecam_controller( time: Res&LTTime<real>>, mut windows: Query<(&Window, &mut CursorOptions)>, @@ -167,23 +201,23 @@ pub fn run_freecam_controller( key_input: Res&LTButtonInput<keycode>>, mut toggle_cursor_grab: Local<bool>, mut mouse_cursor_grab: Local<bool>, <ul><li>mut query: Query<(&mut Transform, &mut FreeCam), With<camera>>, <ul><li>mut query: Query<(&mut Transform, &mut FreeCamState, &FreeCam), With<camera>>, ) { let dt = time.delta_secs(); <ul><li>let Ok((mut transform, mut controller)) = query.single_mut() else {</ul> <ul><li>let Ok((mut transform, mut state, controller)) = query.single_mut() else { return; };</ul> <ul><li>if !controller.initialized {</ul> <ul><li>if !state.initialized { let (yaw, pitch, _roll) = transform.rotation.to_euler(EulerRot::YXZ);</ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>   controller.yaw = yaw;
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   controller.pitch = pitch;
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   controller.initialized = true;
</span></code></pre></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>   state.yaw = yaw;
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   state.pitch = pitch;
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   state.initialized = true;
</span><span>   info!("{}", *controller);
</span></code></pre> }</ul> <ul><li>if !controller.enabled {</ul> <ul><li>if !state.enabled { // don’t keep the cursor grabbed if the controller was disabled. if *toggle_cursor_grab || *mouse_cursor_grab { *toggle_cursor_grab = false; @@ -206,8 +240,9 @@ pub fn run_freecam_controller( } }; scroll += amount;</ul> <ul><li>controller.walk_speed += scroll * controller.scroll_factor * controller.walk_speed;<li>controller.run_speed = controller.walk_speed * 3.0;</ul> <ul><li><p>state.speed_multiplier += scroll * controller.scroll_factor;</p><li><p>// Clamp the speed multiplier for safety</p><li><p>state.speed_multiplier = state.speed_multiplier.clamp(0.0, f32::MAX);</p> <p>// Handle key input let mut axis_input = Vec3::ZERO; @@ -248,26 +283,26 @@ pub fn run_freecam_controller( // Update velocity if axis_input != Vec3::ZERO { let max_speed = if key_input.pressed(controller.key_run) {</p></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>       controller.run_speed
</span></code></pre></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>       controller.run_speed * state.speed_multiplier
</span><span>   } else {
</span></code></pre></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>       controller.walk_speed
</span></code></pre></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>       controller.walk_speed * state.speed_multiplier
</span><span>   };
</span></code></pre></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>   controller.velocity = axis_input.normalize() * max_speed;
</span></code></pre></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>   state.velocity = axis_input.normalize() * max_speed;
</span></code></pre> } else { let friction = controller.friction.clamp(0.0, f32::MAX);</ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>   controller.velocity.smooth_nudge(&Vec3::ZERO, friction, dt);
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   if controller.velocity.length_squared() < 1e-6 {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       controller.velocity = Vec3::ZERO;
</span></code></pre></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>   state.velocity.smooth_nudge(&Vec3::ZERO, friction, dt);
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   if state.velocity.length_squared() < 1e-6 {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       state.velocity = Vec3::ZERO;
</span><span>   }
</span></code></pre> <p>}</p> <p>// Apply movement update</p></ul> <ul><li>if controller.velocity != Vec3::ZERO {</ul> <ul><li>if state.velocity != Vec3::ZERO { let forward = *transform.forward(); let right = *transform.right();</ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>   transform.translation += controller.velocity.x * dt * right
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       + controller.velocity.y * dt * Vec3::Y
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       + controller.velocity.z * dt * forward;
</span></code></pre></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>   transform.translation += state.velocity.x * dt * right
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       + state.velocity.y * dt * Vec3::Y
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       + state.velocity.z * dt * forward;
</span></code></pre> <p>}</p> <p>// Handle cursor grab @@ -292,11 +327,10 @@ pub fn run_freecam_controller( // Handle mouse input if accumulated_mouse_motion.delta != Vec2::ZERO && cursor_grab { // Apply look update</p></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>   controller.pitch = (controller.pitch
</span></code></pre></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>   state.pitch = (state.pitch
</span><span>       - accumulated_mouse_motion.delta.y * RADIANS_PER_DOT * controller.sensitivity)
</span><span>       .clamp(-PI / 2., PI / 2.);
</span></code></pre></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>   controller.yaw -=
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       accumulated_mouse_motion.delta.x * RADIANS_PER_DOT * controller.sensitivity;
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   transform.rotation = Quat::from_euler(EulerRot::ZYX, 0.0, controller.yaw, controller.pitch);
</span></code></pre></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>   state.yaw -= accumulated_mouse_motion.delta.x * RADIANS_PER_DOT * controller.sensitivity;
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   transform.rotation = Quat::from_euler(EulerRot::ZYX, 0.0, state.yaw, state.pitch);
</span></code></pre> } } diff –git a/examples/camera/free_cam_controller.rs b/examples/camera/free_cam_controller.rs index 1443dda8519f3..05240e5c4e9c4 100644 — a/examples/camera/free_cam_controller.rs +++ b/examples/camera/free_cam_controller.rs @@ -41,7 +41,7 @@ use std::f32::consts::{FRAC_PI_4, PI};</ul> <p>use bevy::{</p> <ul><li>camera_controller::free_cam::{FreeCam, FreeCamPlugin},</ul> <ul><li>camera_controller::free_cam::{FreeCam, FreeCamPlugin, FreeCamState}, color::palettes::tailwind, prelude::*, }; @@ -130,8 +130,11 @@ fn spawn_text(mut commands: Commands, freecam_query: Query<&FreeCam>) { )); }</ul> <p>-fn update_camera_settings(mut camera_query: Query<&mut FreeCam>, input: Res&LTButtonInput<keycode>>) { <ul><li>let mut free_cam = camera_query.single_mut().unwrap(); +fn update_camera_settings(</ul> <ul><li><p>mut camera_query: Query<(&mut FreeCam, &mut FreeCamState)>,</p><li><p>input: Res&LTButtonInput<keycode>>, +) { <li><p>let (mut free_cam, mut free_cam_state) = camera_query.single_mut().unwrap();</p> <p>if input.pressed(KeyCode::KeyZ) { free_cam.sensitivity = (free_cam.sensitivity - 0.005).max(0.005); @@ -152,24 +155,27 @@ fn update_camera_settings(mut camera_query: Query<&mut FreeCam>, input: Res&LTButt free_cam.scroll_factor += 0.02; } if input.just_pressed(KeyCode::KeyB) {</p></li> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>   free_cam.enabled = !free_cam.enabled;
</span></code></pre></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>   free_cam_state.enabled = !free_cam_state.enabled;
</span></code></pre> } }</ul> <p>-fn update_text(mut text_query: Query<&mut Text, With<infotext>>, camera_query: Query<&FreeCam>) { +fn update_text( <ul><li>mut text_query: Query<&mut Text, With<infotext>>, <li>camera_query: Query<(&FreeCam, &FreeCamState)>, +) { let mut text = text_query.single_mut().unwrap();</li> <ul><li>let free_cam = camera_query.single().unwrap();</ul> <ul><li><p>let (free_cam, free_cam_state) = camera_query.single().unwrap();</p> <p>text.0 = format!( “Enabled: {},\nSensitivity: {:.03}\nFriction: {:.01}\nScroll factor: {:.02}\nWalk Speed: {:.02}\nRun Speed: {:.02}\nSpeed: {:.02}”,</p></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>   free_cam.enabled,
</span></code></pre></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>   free_cam_state.enabled,
</span><span>   free_cam.sensitivity,
</span><span>   free_cam.friction,
</span><span>   free_cam.scroll_factor,
</span><span>   free_cam.walk_speed,
</span><span>   free_cam.run_speed,
</span></code></pre></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>   free_cam.velocity.length(),
</span></code></pre></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>   free_cam_state.velocity.length(),
</span></code></pre> ); }</ul>    <div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-10/pr_21538.patch id=patch-info style=display:none></div>  <div class=bottom-spacer></div> 