<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21673 Add tests for asset processing under hot reloading and across asset sources.
        
    </title><meta content="#21673 Add tests for asset processing under hot reloading and across asset sources." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-10/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-10-30</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2025-10/pr-21673-en-20251030>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=add-tests-for-asset-processing-under-hot-reloading-and-across-asset-sources>Add tests for asset processing under hot reloading and across asset sources.</h1><h2 id=ji-ben-xin-xi>基本信息</h2><ul><li><strong>标题</strong>: Add tests for asset processing under hot reloading and across asset sources.<li><strong>PR链接</strong>: https://github.com/bevyengine/bevy/pull/21673<li><strong>作者</strong>: andriyDev<li><strong>状态</strong>: 已合并<li><strong>标签</strong>: A-Assets, S-Ready-For-Final-Review, C-Testing, D-StraightForward<li><strong>创建时间</strong>: 2025-10-28T07:20:10Z<li><strong>合并时间</strong>: 2025-10-30T16:20:13Z<li><strong>合并者</strong>: alice-i-cecile</ul><h2 id=miao-shu-fan-yi>描述翻译</h2><h3 id=mu-biao>目标</h3><ul><li>尝试重写资产处理以使其动态化是很困难的，特别是因为我们没有测试来验证资产处理应该能够处理的所有情况！</ul><h3 id=jie-jue-fang-an>解决方案</h3><ul><li>增加一些测试！一个测试用于检查处理多个源是否有效，另一个测试用于检查发送资产事件是否会触发处理（包括依赖处理）。</ul><h3 id=ce-shi>测试</h3><ul><li>;)</ul><h2 id=zhe-ge-prde-gu-shi>这个PR的故事</h2><h3 id=wen-ti-he-bei-jing>问题和背景</h3><p>在开发Bevy的资产处理系统时，团队面临一个关键挑战：重写资产处理逻辑以支持动态处理非常困难，因为缺乏全面的测试来验证系统在各种边界条件下的行为。具体来说，系统需要能够处理：<ol><li>跨多个资产源的处理<li>热重载场景下的资产事件处理<li>依赖资产的级联重新处理</ol><p>没有这些测试，任何对资产处理系统的重构都可能引入难以发现的回归问题。这个PR的目标就是填补这些测试空白，为未来的重构工作提供安全保障。<h3 id=jie-jue-fang-an-fang-fa>解决方案方法</h3><p>开发者采取了直接而实用的方法：编写两个新的集成测试来覆盖之前未经测试的关键场景。这些测试模拟了真实的使用情况，并验证了资产处理系统在复杂条件下的正确行为。<p>为了支持这些测试，首先重构了测试基础设施，使其能够：<ul><li>支持多个资产源的配置<li>模拟资产文件变更事件<li>跟踪处理过程中的状态变化</ul><h3 id=shi-xian-xi-jie>实现细节</h3><h4 id=ce-shi-ji-chu-she-shi-zhong-gou>测试基础设施重构</h4><p>核心的改进是引入了<code>ProcessingDirs</code>结构体来封装每个资产源的目录和事件通道：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Clone)]
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>ProcessingDirs </span><span>{
</span><span>    source</span><span style=color:#61676ccc>:</span><span> Dir,
</span><span>    processed</span><span style=color:#61676ccc>:</span><span> Dir,
</span><span>    source_event_sender</span><span style=color:#61676ccc>: </span><span>async_channel</span><span style=color:#ed9366>::</span><span>Sender&LTAssetSourceEvent>,
</span><span>}
</span></code></pre><p>这个结构体替代了之前测试中使用的简单目录对，增加了事件发送能力来模拟文件系统监视器。<p><code>create_app_with_asset_processor</code>函数被重构为支持多个资产源：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>fn </span><span style=color:#f29718>create_app_with_asset_processor</span><span>(</span><span style=color:#ff8f40>extra_sources</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>[String]) </span><span style=color:#61676ccc>-></span><span> AppWithProcessor {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 创建默认源
</span><span>    </span><span style=color:#fa6e32>let</span><span> default_source_dirs </span><span style=color:#ed9366>= </span><span style=color:#f07171>create_source</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> app</span><span style=color:#61676ccc>, </span><span>AssetSourceId</span><span style=color:#ed9366>::</span><span>Default)</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 创建额外源
</span><span>    </span><span style=color:#fa6e32>let</span><span> extra_sources_dirs </span><span style=color:#ed9366>=</span><span> extra_sources
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|</span><span style=color:#ff8f40>source_name</span><span>| {
</span><span>            (
</span><span>                source_name</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#61676ccc>,
</span><span>                </span><span style=color:#f07171>create_source</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> app</span><span style=color:#61676ccc>, </span><span>AssetSourceId</span><span style=color:#ed9366>::</span><span>Name(source_name</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()))</span><span style=color:#61676ccc>,
</span><span>            )
</span><span>        })
</span><span>        </span><span style=color:#ed9366>.</span><span>collect</span><span style=color:#ed9366>::</span><span><</span><span style=color:#55b4d4;font-style:italic>Vec</span><span><</span><span style=color:#ed9366>_</span><span>>>()</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>每个资产源现在都配置了模拟的监视器，通过<code>FakeWatcher</code>来捕获和处理资产事件：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>struct </span><span style=color:#399ee6>FakeWatcher</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>impl </span><span>AssetWatcher </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>FakeWatcher </span><span>{}
</span><span>
</span><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>register_asset_source</span><span>(
</span><span>    source_id</span><span style=color:#61676ccc>,
</span><span>    AssetSource</span><span style=color:#ed9366>::</span><span>build()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>with_reader</span><span>(</span><span style=color:#fa6e32>move </span><span style=color:#ed9366>|| </span><span style=color:#55b4d4;font-style:italic>Box</span><span style=color:#ed9366>::</span><span>new(source_memory_reader</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()))
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>with_watcher</span><span>(</span><span style=color:#fa6e32>move </span><span style=color:#ed9366>|</span><span>sender</span><span style=color:#61676ccc>: </span><span>async_channel</span><span style=color:#ed9366>::</span><span>Sender&LTAssetSourceEvent></span><span style=color:#ed9366>| </span><span>{
</span><span>            source_event_sender_sender</span><span style=color:#ed9366>.</span><span style=color:#f07171>send_blocking</span><span>(sender)</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span><span>            </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#55b4d4;font-style:italic>Box</span><span style=color:#ed9366>::</span><span>new(FakeWatcher))
</span><span>        })
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ... 其他配置
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><h4 id=duo-zi-chan-yuan-chu-li-ce-shi>多资产源处理测试</h4><p>第一个新测试<code>asset_processor_processes_all_sources</code>验证了系统能够正确处理来自不同资产源的资产：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>asset_processor_processes_all_sources</span><span>() {
</span><span>    </span><span style=color:#fa6e32>let</span><span> AppWithProcessor {
</span><span>        </span><span style=color:#fa6e32>mut</span><span> app</span><span style=color:#61676ccc>,
</span><span>        default_source_dirs</span><span style=color:#61676ccc>:</span><span> ProcessingDirs { source</span><span style=color:#61676ccc>:</span><span> default_source_dir</span><span style=color:#61676ccc>,</span><span> processed</span><span style=color:#61676ccc>:</span><span> default_processed_dir</span><span style=color:#61676ccc>,</span><span> source_event_sender</span><span style=color:#61676ccc>:</span><span> default_source_events }</span><span style=color:#61676ccc>,
</span><span>        extra_sources_dirs</span><span style=color:#61676ccc>,
</span><span>    } </span><span style=color:#ed9366>= </span><span style=color:#f07171>create_app_with_asset_processor</span><span>(</span><span style=color:#ed9366>&</span><span>[</span><span style=color:#86b300>"custom_1"</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"custom_2"</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()])</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 配置处理器
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>AddTextProcessor </span><span style=color:#ed9366>= </span><span>LoadTransformAndSave<</span><span style=color:#abb0b6;font-style:italic>/* ... */</span><span>></span><span style=color:#61676ccc>;
</span><span>    app</span><span style=color:#ed9366>.</span><span style=color:#f07171>register_asset_processor</span><span>(AddTextProcessor</span><span style=color:#ed9366>::</span><span>new(
</span><span>        RootAssetTransformer</span><span style=color:#ed9366>::</span><span>new(AddText(</span><span style=color:#86b300>" processed"</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()))</span><span style=color:#61676ccc>,
</span><span>        CoolTextSaver</span><span style=color:#61676ccc>,
</span><span>    ))</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 在多个源中创建相同路径的资产
</span><span>    </span><span style=color:#fa6e32>let</span><span> path </span><span style=color:#ed9366>= </span><span>Path</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#86b300>"asset.cool.ron"</span><span>)</span><span style=color:#61676ccc>;
</span><span>    default_source_dir</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_asset_text</span><span>(path</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span style=color:#f07171>serialize_as_cool_text</span><span>(</span><span style=color:#86b300>"default asset"</span><span>))</span><span style=color:#61676ccc>;
</span><span>    custom_1_source_dir</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_asset_text</span><span>(path</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span style=color:#f07171>serialize_as_cool_text</span><span>(</span><span style=color:#86b300>"custom 1 asset"</span><span>))</span><span style=color:#61676ccc>;
</span><span>    custom_2_source_dir</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_asset_text</span><span>(path</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span style=color:#f07171>serialize_as_cool_text</span><span>(</span><span style=color:#86b300>"custom 2 asset"</span><span>))</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#f07171>run_app_until_finished_processing</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> app)</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 验证每个源中的资产都被独立处理
</span><span>    </span><span style=color:#f07171>assert_eq!</span><span>(
</span><span>        </span><span style=color:#f07171>read_asset_as_string</span><span>(</span><span style=color:#ed9366>&</span><span>default_processed_dir</span><span style=color:#61676ccc>,</span><span> path)</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#f07171>serialize_as_cool_text</span><span>(</span><span style=color:#86b300>"default asset processed"</span><span>)
</span><span>    )</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... 验证其他源
</span><span>}
</span></code></pre><p>测试还验证了热重载场景 - 当某个源中的资产被修改时，只有该源的资产会被重新处理，其他源保持不变。<h4 id=qian-tao-zi-chan-yi-lai-ce-shi>嵌套资产依赖测试</h4><p>第二个测试<code>nested_loads_of_processed_asset_reprocesses_on_reload</code>验证了依赖资产的级联重新处理：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>nested_loads_of_processed_asset_reprocesses_on_reload</span><span>() {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 设置嵌套依赖：top.nest -> middle.nest -> bottom.nest
</span><span>    custom_source_dir</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_asset_text</span><span>(
</span><span>        Path</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#86b300>"top.nest"</span><span>)</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#ed9366>&</span><span>ron</span><span style=color:#ed9366>::</span><span>ser</span><span style=color:#ed9366>::</span><span>to_string(</span><span style=color:#ed9366>&</span><span>NesterSerialized</span><span style=color:#ed9366>::</span><span>Path(</span><span style=color:#86b300>"middle.nest"</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()))</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>,
</span><span>    )</span><span style=color:#61676ccc>;
</span><span>    default_source_dir</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_asset_text</span><span>(
</span><span>        Path</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#86b300>"middle.nest"</span><span>)</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#ed9366>&</span><span>ron</span><span style=color:#ed9366>::</span><span>ser</span><span style=color:#ed9366>::</span><span>to_string(</span><span style=color:#ed9366>&</span><span>NesterSerialized</span><span style=color:#ed9366>::</span><span>Path(</span><span style=color:#86b300>"custom://bottom.nest"</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()))</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>,
</span><span>    )</span><span style=color:#61676ccc>;
</span><span>    custom_source_dir</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_asset_text</span><span>(Path</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#86b300>"bottom.nest"</span><span>)</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span style=color:#f07171>serialize_as_leaf</span><span>(</span><span style=color:#86b300>"leaf"</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()))</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 初始处理
</span><span>    </span><span style=color:#f07171>run_app_until_finished_processing</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> app)</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 修改底层资产并发送事件
</span><span>    custom_source_dir</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_asset_text</span><span>(
</span><span>        Path</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#86b300>"bottom.nest"</span><span>)</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#ed9366>&</span><span style=color:#f07171>serialize_as_leaf</span><span>(</span><span style=color:#86b300>"leaf changed"</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>())</span><span style=color:#61676ccc>,
</span><span>    )</span><span style=color:#61676ccc>;
</span><span>    custom_source_events
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>send_blocking</span><span>(AssetSourceEvent</span><span style=color:#ed9366>::</span><span>ModifiedAsset(</span><span style=color:#86b300>"bottom.nest"</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()))
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#f07171>run_app_until_finished_processing</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> app)</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 验证所有依赖资产都被重新处理
</span><span>    </span><span style=color:#f07171>assert_eq!</span><span>(
</span><span>        </span><span style=color:#f07171>read_asset_as_string</span><span>(</span><span style=color:#ed9366>&</span><span>custom_processed_dir</span><span style=color:#61676ccc>, </span><span>Path</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#86b300>"bottom.nest"</span><span>))</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#f07171>serialize_as_leaf</span><span>(</span><span style=color:#86b300>"leaf changed-ref"</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>())
</span><span>    )</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#f07171>assert_eq!</span><span>(
</span><span>        </span><span style=color:#f07171>read_asset_as_string</span><span>(</span><span style=color:#ed9366>&</span><span>default_processed_dir</span><span style=color:#61676ccc>, </span><span>Path</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#86b300>"middle.nest"</span><span>))</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#f07171>serialize_as_leaf</span><span>(</span><span style=color:#86b300>"leaf changed-ref-ref"</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>())
</span><span>    )</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... 验证顶层资产
</span><span>}
</span></code></pre><p>这个测试使用了处理计数器来精确跟踪每个资产被处理的次数，确保只有受影响的资产被重新处理。<h3 id=ji-shu-dong-cha>技术洞察</h3><p>这个PR展示了几个重要的软件工程实践：<ol><li><p><strong>测试驱动的基础设施改进</strong>：为了编写有效的测试，首先需要改进测试基础设施。这导致了更健壮和可重用的测试工具。</p><li><p><strong>事件驱动的测试验证</strong>：通过模拟<code>AssetSourceEvent</code>，测试能够验证系统在真实热重载场景下的行为。</p><li><p><strong>跨源依赖处理</strong>：测试验证了资产处理系统能够正确处理跨不同资产源的依赖关系，这是一个复杂的边界情况。</p><li><p><strong>处理状态管理</strong>：改进的<code>run_app_until_finished_processing</code>函数现在包含重试逻辑来处理多线程环境下的竞态条件。</p></ol><h3 id=ying-xiang>影响</h3><p>这些测试为资产处理系统的未来重构提供了关键的安全网。它们覆盖了：<ul><li>多源隔离：确保不同源的资产处理互不干扰<li>事件驱动处理：验证热重载机制的正确性<li>依赖传播：确保资产依赖变更的正确级联处理</ul><p>通过提供这些测试，开发者现在可以更有信心地对资产处理系统进行改进和优化，知道这些关键场景都得到了验证。<h2 id=ke-shi-hua-biao-shi>可视化表示</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TB
</span><span>    A[测试基础设施] --> B[多资产源处理测试]
</span><span>    A --> C[嵌套依赖重新处理测试]
</span><span>    
</span><span>    B --> D[创建多个资产源]
</span><span>    D --> E[初始处理验证]
</span><span>    E --> F[热重载场景测试]
</span><span>    
</span><span>    C --> G[建立嵌套依赖链]
</span><span>    G --> H[初始处理验证]
</span><span>    H --> I[底层资产变更]
</span><span>    I --> J[级联重新处理验证]
</span><span>    
</span><span>    F --> K[确保源间隔离]
</span><span>    J --> L[确保依赖传播正确]
</span></code></pre><h2 id=guan-jian-wen-jian-geng-gai>关键文件更改</h2><ul><li><code>crates/bevy_asset/src/processor/tests.rs</code> (+501/-64)</ul><p>这个文件包含了所有的测试改进：<ol><li><strong>测试基础设施重构</strong>：</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 新增结构体
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Clone)]
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>ProcessingDirs </span><span>{
</span><span>    source</span><span style=color:#61676ccc>:</span><span> Dir,
</span><span>    processed</span><span style=color:#61676ccc>:</span><span> Dir,
</span><span>    source_event_sender</span><span style=color:#61676ccc>: </span><span>async_channel</span><span style=color:#ed9366>::</span><span>Sender&LTAssetSourceEvent>,
</span><span>}
</span><span>
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>AppWithProcessor </span><span>{
</span><span>    app</span><span style=color:#61676ccc>:</span><span> App,
</span><span>    default_source_dirs</span><span style=color:#61676ccc>:</span><span> ProcessingDirs,
</span><span>    extra_sources_dirs</span><span style=color:#61676ccc>: </span><span>HashMap<</span><span style=color:#55b4d4;font-style:italic>String</span><span>, ProcessingDirs>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 重构的创建函数
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>create_app_with_asset_processor</span><span>(</span><span style=color:#ff8f40>extra_sources</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>[String]) </span><span style=color:#61676ccc>-></span><span> AppWithProcessor {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 支持创建多个资产源
</span><span>}
</span></code></pre><ol start=2><li><strong>新的测试工具函数</strong>：</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>fn </span><span style=color:#f29718>read_asset_as_string</span><span>(</span><span style=color:#ff8f40>dir</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>Dir, </span><span style=color:#ff8f40>path</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>Path) </span><span style=color:#61676ccc>-></span><span> String {
</span><span>    </span><span style=color:#fa6e32>let</span><span> bytes </span><span style=color:#ed9366>=</span><span> dir</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_asset</span><span>(path)</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>str</span><span style=color:#ed9366>::</span><span>from_utf8(bytes</span><span style=color:#ed9366>.</span><span style=color:#f07171>value</span><span>())</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_string</span><span>()
</span><span>}
</span></code></pre><ol start=3><li><strong>两个主要的新测试</strong>：</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>asset_processor_processes_all_sources</span><span>() {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 测试多资产源处理
</span><span>}
</span><span>
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>] 
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>nested_loads_of_processed_asset_reprocesses_on_reload</span><span>() {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 测试嵌套依赖重新处理
</span><span>}
</span></code></pre><ol start=4><li><strong>现有测试的改进</strong>：</ol><ul><li>更新现有测试以使用新的测试基础设施<li>改进RON序列化输出格式以提高可读性<li>增强处理状态管理以处理多线程竞态条件</ul><h2 id=jin-yi-bu-yue-du>进一步阅读</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/assets/ target=_blank>Bevy资产系统文档</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/assets/processing/ target=_blank>资产处理指南</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/async-channel/latest/async_channel/ target=_blank>异步通道文档</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/ron-rs/ron target=_blank>RON序列化格式</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-10/pr_21673.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>