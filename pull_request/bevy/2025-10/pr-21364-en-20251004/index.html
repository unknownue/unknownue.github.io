<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21364 Fixing Entity Spawn/Despawn Tracking in Bevy ECS
        
    </title><meta content="#21364 Fixing Entity Spawn/Despawn Tracking in Bevy ECS" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-10/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-10-04</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-10/pr-21364-zh-cn-20251004>中文</a></div></div><div class=pr-content><h1 id=title-fixing-entity-spawn-despawn-tracking-in-bevy-ecs>Title: Fixing Entity Spawn/Despawn Tracking in Bevy ECS</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: set spawn_despawn on the correct entity when despawning<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21364<li><strong>Author</strong>: janis-bhm<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-ECS, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-10-03T14:41:17Z<li><strong>Merged</strong>: 2025-10-04T00:39:06Z<li><strong>Merged By</strong>: james7132</ul><h2 id=description-translation>Description Translation</h2><p><strong>Objective</strong><p>Fixes #21293 Fixes #17314 to ensure that this is tested correctly.<p><strong>Solution</strong><p>When despawning an entity, previously the swapped in (archetype) or moved in entity (table) (which both require extra bookkeeping to update archetype or table rows) were marked as <code>spawned_or_despawned</code> by the location and tick that the to-be-removed entity was meant to be marked, while the to-be-removed entity wasn’t marked.<p>As pointed out by @akimakinai in <a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/pull/19047 target=_blank>#19047</a>, I’ve re-added the correct <code>mark_spawn_despawn</code> call to <code>despawn_with_caller</code>.<p><strong>Testing</strong><p>I’ve added a test <code>spawned_after_swap_remove</code> that ensures that despawning an entity by swapping doesn’t affect other entities <code>spawned_or_despawned</code> location, and that it does affect the despawned entity’s index’s <code>spawned_or_despawned</code> location.<p>Co-Authored By: waterwhisperer24@qq.com<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a subtle but important bug in Bevy’s Entity Component System (ECS) related to how entity spawn and despawn events are tracked. The core issue was in the <code>despawn_with_caller</code> method, which handles the complex process of removing entities from the ECS world.<p>When an entity is despawned in Bevy, the ECS performs internal optimizations that involve entity swapping and movement. In the archetype-based storage system, when an entity is removed, another entity might be swapped into its position to maintain memory locality. Similarly, in table storage, entities might be moved to fill gaps. These optimizations are crucial for performance but require careful bookkeeping.<p>The bug occurred because the despawn tracking was being applied to the wrong entities. Instead of marking the actual entity being despawned, the code was incorrectly marking the entities that were swapped or moved during the despawn process. This meant that:<ul><li>The despawned entity wasn’t properly tracked as despawned<li>Other entities that were moved during the process were incorrectly marked as despawned<li>Systems relying on spawn/despawn tracking would receive incorrect information</ul><p>The fix involved removing the incorrect <code>mark_spawn_despawn</code> calls that were targeting the swapped and moved entities, and adding a single correct call that targets the actual entity being despawned. This ensures that spawn/despawn tracking accurately reflects which entities actually entered or left the world.<p>The implementation shows a good understanding of ECS internals. The key insight was recognizing that the <code>self.entity</code> (the entity being despawned) should be the one receiving the despawn marker, not the entities that get moved during the internal reorganization. The fix is concise and targeted, addressing the root cause without introducing unnecessary complexity.<p>To validate the fix, the PR adds a comprehensive test that verifies:<ol><li>Despawning one entity doesn’t affect the spawn tracking of other entities<li>The despawned entity’s tracking is properly updated<li>The fix works correctly with the swap-based removal optimization</ol><h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Entity Despawn Request] --> B[despawn_with_caller]
</span><span>    B --> C{Entity Storage Type}
</span><span>    C -->|Archetype| D[Remove from Archetype]
</span><span>    C -->|Table| E[Remove from Table]
</span><span>    D --> F[Swap Entity Position]
</span><span>    E --> G[Move Entity Position]
</span><span>    F --> H[Mark Correct Entity Despawned]
</span><span>    G --> H
</span><span>    H --> I[World Flush]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ecs-src-world-entity-ref-rs-31-6><code>crates/bevy_ecs/src/world/entity_ref.rs</code> (+31/-6)</h3><p>This file contains the core ECS implementation for entity references and world operations. The changes fix the despawn tracking bug and add a test to prevent regression.<p><strong>Key Changes:</strong><ol><li><strong>Removed incorrect spawn/despawn marking:</strong></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before (incorrectly marking swapped entity):
</span><span>world
</span><span>    </span><span style=color:#ed9366>.</span><span>entities
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>mark_spawn_despawn</span><span>(swapped_entity</span><span style=color:#ed9366>.</span><span style=color:#f07171>index</span><span>()</span><span style=color:#61676ccc>,</span><span> caller</span><span style=color:#61676ccc>,</span><span> change_tick)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Before (incorrectly marking moved entity):  
</span><span>world
</span><span>    </span><span style=color:#ed9366>.</span><span>entities
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>mark_spawn_despawn</span><span>(moved_entity</span><span style=color:#ed9366>.</span><span style=color:#f07171>index</span><span>()</span><span style=color:#61676ccc>,</span><span> caller</span><span style=color:#61676ccc>,</span><span> change_tick)</span><span style=color:#61676ccc>;
</span></code></pre><ol start=2><li><strong>Added correct spawn/despawn marking:</strong></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// After (correctly marking the actual despawned entity):
</span><span style=color:#abb0b6;font-style:italic>// SAFETY: `self.entity` is a valid entity index
</span><span style=color:#fa6e32>unsafe </span><span>{
</span><span>    world
</span><span>        </span><span style=color:#ed9366>.</span><span>entities
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>mark_spawn_despawn</span><span>(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>entity</span><span style=color:#ed9366>.</span><span style=color:#f07171>index</span><span>()</span><span style=color:#61676ccc>,</span><span> caller</span><span style=color:#61676ccc>,</span><span> change_tick)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><ol start=3><li><strong>Added comprehensive test:</strong></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>spawned_after_swap_remove</span><span>() {
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component)]
</span><span>    </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>Marker</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> world </span><span style=color:#ed9366>= </span><span>World</span><span style=color:#ed9366>::</span><span>new()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> id1 </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>(Marker)</span><span style=color:#ed9366>.</span><span style=color:#f07171>id</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> _id2 </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>(Marker)</span><span style=color:#ed9366>.</span><span style=color:#f07171>id</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> id3 </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>(Marker)</span><span style=color:#ed9366>.</span><span style=color:#f07171>id</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"track_location"</span><span>)]
</span><span>    </span><span style=color:#fa6e32>let</span><span> e1_spawned </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(id1)</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawned_by</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#fa6e32>let</span><span> spawn </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(id3)</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawned_by</span><span>()</span><span style=color:#61676ccc>;
</span><span>    world</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity_mut</span><span>(id1)</span><span style=color:#ed9366>.</span><span style=color:#f07171>despawn</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"track_location"</span><span>)]
</span><span>    </span><span style=color:#fa6e32>let</span><span> e1_despawned </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>entities</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity_get_spawned_or_despawned_by</span><span>(id1)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"track_location"</span><span>)]
</span><span>    </span><span style=color:#f07171>assert_ne!</span><span>(e1_spawned</span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(</span><span style=color:#55b4d4;font-style:italic>Some</span><span>)</span><span style=color:#61676ccc>,</span><span> e1_despawned)</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#fa6e32>let</span><span> spawn_after </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(id3)</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawned_by</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#f07171>assert_eq!</span><span>(spawn</span><span style=color:#61676ccc>,</span><span> spawn_after)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=tools-ci-src-commands-test-rs-1-1><code>tools/ci/src/commands/test.rs</code> (+1/-1)</h3><p>This file configures the CI test command. The change ensures that the new test runs with the required <code>track_location</code> feature enabled.<p><strong>Key Change:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#86b300>"cargo test --workspace --lib --bins --tests {no_fail_fast...} {jobs_ref...} -- {test_threads_ref...}"
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#86b300>"cargo test --workspace --lib --bins --tests --features bevy_ecs/track_location {no_fail_fast...} {jobs_ref...} -- {test_threads_ref...}"
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_ecs/latest/bevy_ecs/ target=_blank>Bevy ECS Documentation</a> - Comprehensive guide to Bevy’s Entity Component System<li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Entity_component_system target=_blank>Entity Component System Pattern</a> - Background on ECS architecture<li><a rel="noopener nofollow noreferrer" href=https://rust-lang.github.io/unsafe-code-guidelines/ target=_blank>Rust Unsafe Code Guidelines</a> - Understanding unsafe code patterns used in the fix<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/issues/21293 target=_blank>Bevy GitHub Issues #21293</a> - Original bug report<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/issues/17314 target=_blank>Bevy GitHub Issues #17314</a> - Related tracking issue</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-10/pr_21364.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>