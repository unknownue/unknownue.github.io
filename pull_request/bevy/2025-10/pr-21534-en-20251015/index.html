<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21534 Do not attempt to grab pointer on web if unsupported.
        
    </title><meta content="#21534 Do not attempt to grab pointer on web if unsupported." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-10/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-10-15</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-10/pr-21534-zh-cn-20251015>中文</a></div></div><div class=pr-content><h1 id=do-not-attempt-to-grab-pointer-on-web-if-unsupported>Do not attempt to grab pointer on web if unsupported.</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Do not attempt to grab pointer on web if unsupported.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21534<li><strong>Author</strong>: rectalogic<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Windowing, P-Crash, S-Ready-For-Final-Review, P-Regression, X-Contentious<li><strong>Created</strong>: 2025-10-13T21:02:57Z<li><strong>Merged</strong>: 2025-10-14T21:46:31Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Fixes https://github.com/bevyengine/bevy/issues/21497<h2 id=solution>Solution</h2><p>Mobile web does not support pointer APIs and panics if they are used. Check if they exist before using them.<h2 id=testing>Testing</h2><p>Tested on iOS Safari using https://github.com/rectalogic/pointerlock<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a critical crash issue that occurred when Bevy applications attempted to use pointer grab functionality on mobile web browsers. The problem stemmed from the fact that mobile web platforms like iOS Safari don’t support the Pointer Lock API, which is part of the web’s pointer handling capabilities.<p>The issue manifested as a panic when Bevy’s cursor grab system tried to use pointer APIs that simply don’t exist in mobile browser environments. This was a regression that broke Bevy applications on mobile web platforms, making them crash immediately when attempting to initialize cursor grab functionality.<p>The solution implemented here follows a defensive programming approach. Rather than assuming pointer APIs are available on all web platforms, the code now performs a runtime check to verify the existence of the required APIs before attempting to use them. This is particularly important for web targets where feature availability can vary significantly between desktop and mobile browsers, and even between different mobile browsers.<p>The implementation adds a new <code>pointer_supported()</code> function that uses JavaScript reflection to check for the presence of the <code>exitPointerLock</code> method on the document object. This method is part of the Pointer Lock API specification, so its presence indicates that the browser supports pointer locking functionality. The check is wrapped in proper error handling that returns <code>ExternalError::Ignored</code> if the necessary web APIs aren’t available, allowing the application to continue running without the pointer grab feature rather than crashing.<p>In the <code>attempt_grab</code> function, this check is now performed conditionally for wasm32 targets before any pointer operations are attempted. If pointer APIs aren’t supported, the function returns early with an <code>ExternalError::Ignored</code>, effectively making the pointer grab operation a no-op on unsupported platforms. This approach maintains compatibility with existing code while preventing crashes.<p>The technical approach demonstrates good cross-platform development practices. By checking for feature availability at runtime rather than relying solely on compile-time feature detection, the solution handles the reality that web platform capabilities can vary even within the same architecture (wasm32). The use of <code>js_sys::Reflect::has</code> provides a robust way to check for API availability without making assumptions about the execution environment.<p>This fix is minimal and surgical - it only affects the specific code path that was causing crashes and doesn’t change the behavior on platforms that properly support pointer APIs. The addition of the <code>js-sys</code> dependency is necessary for the JavaScript reflection capabilities but doesn’t significantly impact bundle size or performance.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[attempt_grab called] --> B{Is target wasm32?}
</span><span>    B -->|Yes| C[Check pointer_supported()]
</span><span>    B -->|No| D[Proceed with normal grab logic]
</span><span>    C -->|Not Supported| E[Return ExternalError::Ignored]
</span><span>    C -->|Supported| D
</span><span>    D --> F[Execute pointer grab operations]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-winit-cargo-toml><code>crates/bevy_winit/Cargo.toml</code></h3><p>Added the <code>js-sys</code> dependency for wasm32 targets, which provides Rust bindings for JavaScript’s standard library and enables JavaScript reflection capabilities needed for runtime feature detection.<pre class=language-toml data-lang=toml style=color:#61676c;background-color:#fafafa><code class=language-toml data-lang=toml><span>[</span><span style=color:#399ee6>target</span><span style=color:#61676ccc>.</span><span style=color:#86b300>'cfg(target_arch = "wasm32")'</span><span style=color:#61676ccc>.</span><span style=color:#399ee6>dependencies</span><span>]
</span><span style=color:#399ee6>wasm-bindgen </span><span>= { </span><span style=color:#399ee6>version </span><span>= </span><span style=color:#86b300>"0.2" </span><span>}
</span><span style=color:#399ee6>web-sys </span><span>= </span><span style=color:#86b300>"0.3"
</span><span style=color:#f51818>+ js-sys = "0.3"
</span></code></pre><h3 id=crates-bevy-winit-src-winit-windows-rs><code>crates/bevy_winit/src/winit_windows.rs</code></h3><p>Added runtime pointer API detection and early return for unsupported platforms.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(target_arch </span><span style=color:#ed9366>= </span><span style=color:#86b300>"wasm32"</span><span>)]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>pointer_supported</span><span>() </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><</span><span style=color:#fa6e32>bool</span><span>, ExternalError> {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(js_sys</span><span style=color:#ed9366>::</span><span>Reflect</span><span style=color:#ed9366>::</span><span>has(
</span><span>        web_sys</span><span style=color:#ed9366>::</span><span>window()
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>ok_or</span><span>(ExternalError</span><span style=color:#ed9366>::</span><span>Ignored)</span><span style=color:#ed9366>?
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>document</span><span>()
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>ok_or</span><span>(ExternalError</span><span style=color:#ed9366>::</span><span>Ignored)</span><span style=color:#ed9366>?
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>as_ref</span><span>()</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#ed9366>&</span><span style=color:#86b300>"exitPointerLock"</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()</span><span style=color:#61676ccc>,
</span><span>    )
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_or</span><span>(</span><span style=color:#ff8f40>false</span><span>))
</span><span>}
</span><span>
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>attempt_grab</span><span>(
</span><span>    </span><span style=color:#ff8f40>winit_window</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>WinitWindow,
</span><span>    </span><span style=color:#ff8f40>grab_mode</span><span style=color:#61676ccc>:</span><span> CursorGrabMode,
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><(), ExternalError> {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Do not attempt to grab on web if unsupported (e.g. mobile)
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(target_arch </span><span style=color:#ed9366>= </span><span style=color:#86b300>"wasm32"</span><span>)]
</span><span>    </span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span style=color:#f07171>pointer_supported</span><span>()</span><span style=color:#ed9366>? </span><span>{
</span><span>        </span><span style=color:#fa6e32>return </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(ExternalError</span><span style=color:#ed9366>::</span><span>Ignored)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#fa6e32>let</span><span> grab_result </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>match</span><span> grab_mode {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ... rest of the function unchanged
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://developer.mozilla.org/en-US/docs/Web/API/Pointer_Lock_API target=_blank>MDN Web Docs: Pointer Lock API</a><li><a rel="noopener nofollow noreferrer" href=https://rustwasm.github.io/wasm-bindgen/ target=_blank>WASM-bindgen documentation</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/js-sys/latest/js_sys/ target=_blank>js-sys crate documentation</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/platforms/wasm/ target=_blank>Bevy Web Assembly Guide</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-10/pr_21534.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>