<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21348 Solari: Fix world cache update using last frame's light tiles due to incorrect pass ordering
        
    </title><meta content="#21348 Solari: Fix world cache update using last frame's light tiles due to incorrect pass ordering" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-10/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-10-02</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-10/pr-21348-zh-cn-20251002>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Solari: Fix world cache update using last frame’s light tiles due to incorrect pass ordering<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21348<li><strong>Author</strong>: JMS55<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, S-Ready-For-Final-Review, D-Straightforward<li><strong>Created</strong>: 2025-10-02T15:11:39Z<li><strong>Merged</strong>: 2025-10-02T17:06:12Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>Light tiles used to be generated <em>after</em> the world cache update, despite the world cache update relying on them. This means that the world cache update used last frame’s light tiles, which is fine for static lights, but completely wrong for dynamic lights and lead to missing GI contributions from dynamic lights.<p>Moving the presample light tile step to before the world cache update fixes this.<p>Can be tested by running the solari example, turning off the directional light so there’s only the emissive robot light, enabling VISUALIZE_WORLD_CACHE, and then comparing before/after this PR.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a critical ordering bug in Bevy’s Solari global illumination system. The core issue was straightforward but had significant consequences for dynamic lighting scenarios.<p>The problem stemmed from incorrect execution ordering in the rendering pipeline. The world cache update, which depends on current frame light tile data, was being executed before the light tiles were actually generated. This created a one-frame lag where the world cache would use outdated light information from the previous frame.<p>For static lights, this wasn’t immediately apparent because light data remains consistent between frames. However, for dynamic lights - particularly emissive materials that change position or intensity - this caused missing or incorrect global illumination contributions. The world cache would be updated based on where lights were in the previous frame, not their current positions.<p>The solution was a simple but crucial reordering of operations. The presample_light_tiles_pipeline dispatch was moved from after the world cache update to before it. This ensures that when the world cache processes light contributions, it uses the current frame’s light tile data rather than stale data from the previous frame.<p>The implementation change is minimal - just seven lines of code moved from one location to another - but it fundamentally fixes the temporal coherence of dynamic lighting in the Solari system. The fix maintains all existing functionality while correcting the temporal misalignment that was causing dynamic lighting artifacts.<p>From an architectural perspective, this highlights the importance of proper dependency ordering in GPU compute pipelines. Even when individual operations are correct, their execution order can create subtle but significant bugs. The fix demonstrates how careful consideration of data dependencies is crucial in real-time graphics programming.<p>The testing approach described - using the solari example with directional lights disabled and the emissive robot light enabled, combined with the VISUALIZE_WORLD_CACHE debug visualization - provides a clear way to verify the fix. This would show immediate visual differences between the broken and fixed versions, particularly as dynamic lights move through the scene.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[Clear Light Tiles] --> B[Presample Light Tiles]
</span><span>    B --> C[World Cache Update]
</span><span>    C --> D[DI Initial & Temporal]
</span><span>    
</span><span>    style B fill:#9f9
</span><span>    style C fill:#f99
</span></code></pre><p>The diagram shows the corrected execution flow, with the critical fix highlighted: light tile sampling now properly precedes world cache updates.<h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-solari-src-realtime-node-rs-7-7><code>crates/bevy_solari/src/realtime/node.rs</code> (+7/-7)</h3><p>This file contains the core rendering node implementation for Solari’s real-time global illumination. The changes fix the execution order of compute shader dispatches.<p><strong>Key Changes:</strong> The presample_light_tiles_pipeline dispatch was moved from after the world cache update to before it, ensuring the world cache uses current frame light data.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before (incorrect order):
</span><span style=color:#abb0b6;font-style:italic>// World cache update operations...
</span><span>pass</span><span style=color:#ed9366>.</span><span style=color:#f07171>set_bind_group</span><span>(</span><span style=color:#ff8f40>2</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>bind_group_world_cache_active_cells_dispatch</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>[])</span><span style=color:#61676ccc>;
</span><span>pass</span><span style=color:#ed9366>.</span><span style=color:#f07171>set_pipeline</span><span>(decay_world_cache_pipeline)</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// ... more world cache operations
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Then light tile sampling (too late!)
</span><span>pass</span><span style=color:#ed9366>.</span><span style=color:#f07171>set_pipeline</span><span>(presample_light_tiles_pipeline)</span><span style=color:#61676ccc>;
</span><span>pass</span><span style=color:#ed9366>.</span><span style=color:#f07171>set_push_constants</span><span>(
</span><span>    </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>,
</span><span>    bytemuck</span><span style=color:#ed9366>::</span><span>cast_slice(</span><span style=color:#ed9366>&</span><span>[frame_index</span><span style=color:#61676ccc>,</span><span> solari_lighting</span><span style=color:#ed9366>.</span><span>reset </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>u32</span><span>])</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span><span>pass</span><span style=color:#ed9366>.</span><span style=color:#f07171>dispatch_workgroups</span><span>(</span><span style=color:#ff8f40>LIGHT_TILE_BLOCKS </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>u32</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>1</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After (correct order):
</span><span style=color:#abb0b6;font-style:italic>// Light tile sampling first
</span><span>pass</span><span style=color:#ed9366>.</span><span style=color:#f07171>set_pipeline</span><span>(presample_light_tiles_pipeline)</span><span style=color:#61676ccc>;
</span><span>pass</span><span style=color:#ed9366>.</span><span style=color:#f07171>set_push_constants</span><span>(
</span><span>    </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>,
</span><span>    bytemuck</span><span style=color:#ed9366>::</span><span>cast_slice(</span><span style=color:#ed9366>&</span><span>[frame_index</span><span style=color:#61676ccc>,</span><span> solari_lighting</span><span style=color:#ed9366>.</span><span>reset </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>u32</span><span>])</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span><span>pass</span><span style=color:#ed9366>.</span><span style=color:#f07171>dispatch_workgroups</span><span>(</span><span style=color:#ff8f40>LIGHT_TILE_BLOCKS </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>u32</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>1</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Then world cache update
</span><span>pass</span><span style=color:#ed9366>.</span><span style=color:#f07171>set_bind_group</span><span>(</span><span style=color:#ff8f40>2</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>bind_group_world_cache_active_cells_dispatch</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>[])</span><span style=color:#61676ccc>;
</span><span>pass</span><span style=color:#ed9366>.</span><span style=color:#f07171>set_pipeline</span><span>(decay_world_cache_pipeline)</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// ... world cache operations continue
</span></code></pre><p>The code movement is straightforward but crucial - it ensures that light tile data is available when the world cache update runs, eliminating the one-frame lag that was causing dynamic lighting issues.<h2 id=further-reading>Further Reading</h2><ul><li>Bevy Solari Documentation: Overview of Bevy’s real-time global illumination system<li>GPU Compute Pipeline Ordering: Technical details on dependency management in compute shaders<li>Temporal Coherence in Real-Time Rendering: Techniques for maintaining consistency across frames in dynamic lighting scenarios<li>Global Illumination Fundamentals: Core concepts behind indirect lighting and light propagation</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-10/pr_21348.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>