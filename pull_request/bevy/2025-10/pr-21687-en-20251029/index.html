<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21687 Add viewport_to_ndc
        
    </title><meta content="#21687 Add viewport_to_ndc" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-10/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-10-29</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-10/pr-21687-zh-cn-20251029>中文</a></div></div><div class=pr-content><h1 id=add-viewport-to-ndc>Add viewport_to_ndc</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Add viewport_to_ndc<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21687<li><strong>Author</strong>: IceSentry<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: D-Trivial, C-Usability, S-Needs-Review, A-Camera<li><strong>Created</strong>: 2025-10-29T18:26:34Z<li><strong>Merged</strong>: 2025-10-29T20:32:55Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Computing the ndc from a viewport coordinates is already done in a few places.<li>It’s can be useful for users, not just internally.</ul><h2 id=solution>Solution</h2><ul><li>Extract it to a function</ul><h2 id=testing>Testing</h2><ul><li>I’m using it in a currently unfinished PR for gpu picking and things worked as expected<li>I also tested 3d_viewport_to_world and 2d_viewport_to_world</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a straightforward but important code duplication issue in Bevy’s camera system. The core problem was that viewport-to-NDC (Normalized Device Coordinates) conversion logic was duplicated across multiple methods in the Camera implementation, which violates the DRY (Don’t Repeat Yourself) principle and makes maintenance more difficult.<p>The developer identified that two existing methods - <code>viewport_to_world</code> and <code>viewport_to_world_2d</code> - were both performing the same coordinate transformation steps internally. Both methods needed to convert from viewport coordinates to NDC space, but this conversion logic was implemented separately in each method, creating duplication.<p>The solution approach was clean and practical: extract the common coordinate transformation logic into a dedicated public method called <code>viewport_to_ndc</code>. This follows standard refactoring practices where repeated code blocks are identified and consolidated into reusable functions.<p>Looking at the implementation, the transformation involves several key steps:<ol><li>Getting the camera’s logical viewport rectangle<li>Calculating relative coordinates within the viewport<li>Converting to NDC range [-1, 1]<li>Flipping the Y-axis coordinate (from top-origin to bottom-origin)</ol><p>Here’s what the duplicated code looked like before extraction:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// In viewport_to_world:
</span><span style=color:#fa6e32>let</span><span> target_rect </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>logical_viewport_rect</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>ok_or</span><span>(ViewportConversionError</span><span style=color:#ed9366>::</span><span>NoViewportSize)</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> rect_relative </span><span style=color:#ed9366>= </span><span>(viewport_position </span><span style=color:#ed9366>-</span><span> target_rect</span><span style=color:#ed9366>.</span><span>min) </span><span style=color:#ed9366>/</span><span> target_rect</span><span style=color:#ed9366>.</span><span style=color:#f07171>size</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let mut</span><span> ndc_xy </span><span style=color:#ed9366>=</span><span> rect_relative </span><span style=color:#ed9366>* </span><span style=color:#ff8f40>2. </span><span style=color:#ed9366>- </span><span>Vec2</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ONE</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// Flip the Y co-ordinate from the top to the bottom to enter NDC.
</span><span>ndc_xy</span><span style=color:#ed9366>.</span><span>y </span><span style=color:#ed9366>= -</span><span>ndc_xy</span><span style=color:#ed9366>.</span><span>y</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// In viewport_to_world_2d:
</span><span style=color:#fa6e32>let</span><span> target_rect </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>logical_viewport_rect</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>ok_or</span><span>(ViewportConversionError</span><span style=color:#ed9366>::</span><span>NoViewportSize)</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let mut</span><span> rect_relative </span><span style=color:#ed9366>= </span><span>(viewport_position </span><span style=color:#ed9366>-</span><span> target_rect</span><span style=color:#ed9366>.</span><span>min) </span><span style=color:#ed9366>/</span><span> target_rect</span><span style=color:#ed9366>.</span><span style=color:#f07171>size</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// Flip the Y co-ordinate origin from the top to the bottom.
</span><span>rect_relative</span><span style=color:#ed9366>.</span><span>y </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>1.0 </span><span style=color:#ed9366>-</span><span> rect_relative</span><span style=color:#ed9366>.</span><span>y</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> ndc </span><span style=color:#ed9366>=</span><span> rect_relative </span><span style=color:#ed9366>* </span><span style=color:#ff8f40>2. </span><span style=color:#ed9366>- </span><span>Vec2</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ONE</span><span style=color:#61676ccc>;
</span></code></pre><p>The new implementation consolidates this into a single method:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>viewport_to_ndc</span><span>(
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>,
</span><span>    </span><span style=color:#ff8f40>viewport_position</span><span style=color:#61676ccc>:</span><span> Vec2,
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span>&LTVec2, ViewportConversionError> {
</span><span>    </span><span style=color:#fa6e32>let</span><span> target_rect </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>logical_viewport_rect</span><span>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>ok_or</span><span>(ViewportConversionError</span><span style=color:#ed9366>::</span><span>NoViewportSize)</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> rect_relative </span><span style=color:#ed9366>= </span><span>(viewport_position </span><span style=color:#ed9366>-</span><span> target_rect</span><span style=color:#ed9366>.</span><span>min) </span><span style=color:#ed9366>/</span><span> target_rect</span><span style=color:#ed9366>.</span><span style=color:#f07171>size</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> ndc </span><span style=color:#ed9366>=</span><span> rect_relative </span><span style=color:#ed9366>* </span><span style=color:#ff8f40>2. </span><span style=color:#ed9366>- </span><span>Vec2</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ONE</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Flip the Y co-ordinate from the top to the bottom to enter NDC.
</span><span>    ndc</span><span style=color:#ed9366>.</span><span>y </span><span style=color:#ed9366>= -</span><span>ndc</span><span style=color:#ed9366>.</span><span>y</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(ndc)
</span><span>}
</span></code></pre><p>The technical insight here is that by making this method public, the developer not only eliminates code duplication but also provides a useful utility for other developers working with camera coordinate systems. This is particularly valuable for features like GPU picking, which the author mentions they’re working on in another PR.<p>The impact of this change is threefold:<ol><li><strong>Reduced code duplication</strong>: The coordinate transformation logic now exists in one place<li><strong>Improved maintainability</strong>: Future changes to the coordinate transformation only need to be made once<li><strong>Enhanced API</strong>: External developers can now use this utility method for their own camera-related calculations</ol><p>The testing approach was practical - the author verified that the refactored methods (<code>viewport_to_world</code> and <code>viewport_to_world_2d</code>) still work correctly, and they’re already using the new method in another feature they’re developing.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Camera] --> B[viewport_to_world]
</span><span>    A --> C[viewport_to_world_2d]
</span><span>    A --> D[viewport_to_ndc]
</span><span>    
</span><span>    B --> D
</span><span>    C --> D
</span><span>    
</span><span>    E[Viewport Coordinates] --> D
</span><span>    D --> F[NDC Coordinates]
</span><span>    F --> B
</span><span>    F --> C
</span><span>    B --> G[World Coordinates 3D]
</span><span>    C --> H[World Coordinates 2D]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>File</strong>: <code>crates/bevy_camera/src/camera.rs</code> (+17/-16)<p>This file contains the core Camera implementation in Bevy. The changes involved:<ol><li><strong>Extracted viewport_to_ndc method</strong>: Created a new public method that handles the coordinate transformation<li><strong>Refactored existing methods</strong>: Updated <code>viewport_to_world</code> and <code>viewport_to_world_2d</code> to use the new utility method</ol><p>Key code changes:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before in viewport_to_world:
</span><span style=color:#fa6e32>let</span><span> target_rect </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>logical_viewport_rect</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>ok_or</span><span>(ViewportConversionError</span><span style=color:#ed9366>::</span><span>NoViewportSize)</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> rect_relative </span><span style=color:#ed9366>= </span><span>(viewport_position </span><span style=color:#ed9366>-</span><span> target_rect</span><span style=color:#ed9366>.</span><span>min) </span><span style=color:#ed9366>/</span><span> target_rect</span><span style=color:#ed9366>.</span><span style=color:#f07171>size</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let mut</span><span> ndc_xy </span><span style=color:#ed9366>=</span><span> rect_relative </span><span style=color:#ed9366>* </span><span style=color:#ff8f40>2. </span><span style=color:#ed9366>- </span><span>Vec2</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ONE</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// Flip the Y co-ordinate from the top to the bottom to enter NDC.
</span><span>ndc_xy</span><span style=color:#ed9366>.</span><span>y </span><span style=color:#ed9366>= -</span><span>ndc_xy</span><span style=color:#ed9366>.</span><span>y</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After in viewport_to_world:
</span><span style=color:#fa6e32>let</span><span> ndc_xy </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>viewport_to_ndc</span><span>(viewport_position)</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span></code></pre><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before in viewport_to_world_2d:
</span><span style=color:#fa6e32>let</span><span> target_rect </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>logical_viewport_rect</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>ok_or</span><span>(ViewportConversionError</span><span style=color:#ed9366>::</span><span>NoViewportSize)</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let mut</span><span> rect_relative </span><span style=color:#ed9366>= </span><span>(viewport_position </span><span style=color:#ed9366>-</span><span> target_rect</span><span style=color:#ed9366>.</span><span>min) </span><span style=color:#ed9366>/</span><span> target_rect</span><span style=color:#ed9366>.</span><span style=color:#f07171>size</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// Flip the Y co-ordinate origin from the top to the bottom.
</span><span>rect_relative</span><span style=color:#ed9366>.</span><span>y </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>1.0 </span><span style=color:#ed9366>-</span><span> rect_relative</span><span style=color:#ed9366>.</span><span>y</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> ndc </span><span style=color:#ed9366>=</span><span> rect_relative </span><span style=color:#ed9366>* </span><span style=color:#ff8f40>2. </span><span style=color:#ed9366>- </span><span>Vec2</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ONE</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After in viewport_to_world_2d:
</span><span style=color:#fa6e32>let</span><span> ndc </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>viewport_to_ndc</span><span>(viewport_position)</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span></code></pre><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// New method added:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>viewport_to_ndc</span><span>(
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>,
</span><span>    </span><span style=color:#ff8f40>viewport_position</span><span style=color:#61676ccc>:</span><span> Vec2,
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span>&LTVec2, ViewportConversionError> {
</span><span>    </span><span style=color:#fa6e32>let</span><span> target_rect </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>logical_viewport_rect</span><span>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>ok_or</span><span>(ViewportConversionError</span><span style=color:#ed9366>::</span><span>NoViewportSize)</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> rect_relative </span><span style=color:#ed9366>= </span><span>(viewport_position </span><span style=color:#ed9366>-</span><span> target_rect</span><span style=color:#ed9366>.</span><span>min) </span><span style=color:#ed9366>/</span><span> target_rect</span><span style=color:#ed9366>.</span><span style=color:#f07171>size</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> ndc </span><span style=color:#ed9366>=</span><span> rect_relative </span><span style=color:#ed9366>* </span><span style=color:#ff8f40>2. </span><span style=color:#ed9366>- </span><span>Vec2</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ONE</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Flip the Y co-ordinate from the top to the bottom to enter NDC.
</span><span>    ndc</span><span style=color:#ed9366>.</span><span>y </span><span style=color:#ed9366>= -</span><span>ndc</span><span style=color:#ed9366>.</span><span>y</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(ndc)
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_camera/latest/bevy_camera/ target=_blank>Bevy Camera Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://learnopengl.com/Getting-started/Coordinate-Systems target=_blank>Coordinate Systems in Computer Graphics</a><li><a rel="noopener nofollow noreferrer" href=https://www.khronos.org/opengl/wiki/Vertex_Post-Processing#Coordinate_systems target=_blank>Normalized Device Coordinates</a><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Don%27t_repeat_yourself target=_blank>DRY Principle</a></ul><h1 id=full-code-diff>Full Code Diff</h1><p>diff –git a/crates/bevy_camera/src/camera.rs b/crates/bevy_camera/src/camera.rs index 31d2913b97510..aa6733b427b1d 100644 — a/crates/bevy_camera/src/camera.rs +++ b/crates/bevy_camera/src/camera.rs @@ -614,13 +614,7 @@ impl Camera { camera_transform: &GlobalTransform, viewport_position: Vec2, ) -> Result&LTRay3d, ViewportConversionError> {<ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>   let target_rect = self
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       .logical_viewport_rect()
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       .ok_or(ViewportConversionError::NoViewportSize)?;
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   let rect_relative = (viewport_position - target_rect.min) / target_rect.size();
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   let mut ndc_xy = rect_relative * 2. - Vec2::ONE;
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   // Flip the Y co-ordinate from the top to the bottom to enter NDC.
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   ndc_xy.y = -ndc_xy.y;
</span></code></pre></ul><ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>   let ndc_xy = self.viewport_to_ndc(viewport_position)?;
</span><span>
</span><span>   let ndc_point_near = ndc_xy.extend(1.0).into();
</span><span>   // Using EPSILON because an ndc with Z = 0 returns NaNs.
</span></code></pre></ul><p>@@ -682,15 +676,7 @@ impl Camera { camera_transform: &GlobalTransform, viewport_position: Vec2, ) -> Result&LTVec2, ViewportConversionError> {<ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>   let target_rect = self
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       .logical_viewport_rect()
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       .ok_or(ViewportConversionError::NoViewportSize)?;
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   let mut rect_relative = (viewport_position - target_rect.min) / target_rect.size();
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   // Flip the Y co-ordinate origin from the top to the bottom.
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   rect_relative.y = 1.0 - rect_relative.y;
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   let ndc = rect_relative * 2. - Vec2::ONE;
</span></code></pre></ul><ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>   let ndc = self.viewport_to_ndc(viewport_position)?;
</span><span>
</span><span>   let world_near_plane = self
</span><span>       .ndc_to_world(camera_transform, ndc.extend(1.))
</span></code></pre></ul><p>@@ -773,6 +759,21 @@ impl Camera { -(self.clip_from_view().w_axis.z - ndc_depth) / self.clip_from_view().z_axis.z // [3][2] [2][2] } +<ul><li>/// Converts a position in viewport coordinates to NDC.<li>pub fn viewport_to_ndc(<li><pre style=color:#61676c;background-color:#fafafa><code><span>   &self,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   viewport_position: Vec2,
</span></code></pre><li>) -> Result&LTVec2, ViewportConversionError> {<li><pre style=color:#61676c;background-color:#fafafa><code><span>   let target_rect = self
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       .logical_viewport_rect()
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       .ok_or(ViewportConversionError::NoViewportSize)?;
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   let rect_relative = (viewport_position - target_rect.min) / target_rect.size();
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   let mut ndc = rect_relative * 2. - Vec2::ONE;
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   // Flip the Y co-ordinate from the top to the bottom to enter NDC.
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   ndc.y = -ndc.y;
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   Ok(ndc)
</span></code></pre><li>} }</ul><p>/// Control how this [<code>Camera</code>] outputs once rendering is completed.</div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-10/pr_21687.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>