<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21360 Relax deferred UnsafeWorldCell visibility
        
    </title><meta content="#21360 Relax deferred UnsafeWorldCell visibility" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-10/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-10-04</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-10/pr-21360-zh-cn-20251004>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>Relax deferred UnsafeWorldCell visibility<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Relax deferred UnsafeWorldCell visibility<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21360<li><strong>Author</strong>: CorvusPrudens<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: D-Trivial, A-ECS, S-Ready-For-Final-Review, D-Unsafe<li><strong>Created</strong>: 2025-10-03T12:28:35Z<li><strong>Merged</strong>: 2025-10-04T18:25:19Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Addresses the immediate blocker in #21354 by relaxing the <code>(crate)</code> visibility restriction on <code>DeferredWorld::as_unsafe_world_cell</code>.<p>This method already has documentation, including a safety comment. While sparse, I think they communicate the function clearly.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a specific visibility constraint that was blocking progress on another development effort. The core issue was straightforward: the <code>as_unsafe_world_cell</code> method in the <code>DeferredWorld</code> struct had <code>pub(crate)</code> visibility, which prevented external crates from accessing it. This was preventing work on PR #21354 from moving forward.<p>The <code>DeferredWorld</code> type in Bevy’s ECS system provides a way to queue up world modifications and apply them later. The <code>as_unsafe_world_cell</code> method is particularly important because it allows accessing the underlying <code>UnsafeWorldCell</code>, which enables performing unsafe ECS operations. However, the method’s <code>pub(crate)</code> visibility meant it could only be used within the <code>bevy_ecs</code> crate itself.<p>The solution implemented here is minimal and surgical. By changing the visibility modifier from <code>pub(crate)</code> to <code>pub</code>, the method becomes accessible to external crates while maintaining all the same safety guarantees. The method already contained appropriate safety documentation:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>/// # Safety
</span><span style=color:#abb0b6;font-style:italic>/// - must only be used to make non-structural ECS changes
</span></code></pre><p>This safety comment is crucial because it reminds callers that while they can perform unsafe operations through the returned <code>UnsafeWorldCell</code>, they must avoid making structural changes to the ECS - meaning they shouldn’t add or remove components, create or destroy entities, or perform other operations that would change the fundamental structure of the world.<p>The implementation change is technically simple but strategically important. It follows the principle of making the smallest possible change to unblock dependent work. The method signature and behavior remain identical; only the visibility scope expands.<p>From an architectural perspective, this change acknowledges that the functionality provided by <code>as_unsafe_world_cell</code> is useful beyond the immediate crate boundaries. The safety documentation provides sufficient guidance for external callers to use the method correctly, and the existing implementation doesn’t require modification to support broader usage.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[External Crate] --> B[DeferredWorld]
</span><span>    B --> C[as_unsafe_world_cell]
</span><span>    C --> D[UnsafeWorldCell]
</span><span>    D --> E[Non-structural ECS Operations]
</span><span>    
</span><span>    style C fill:#e1f5fe
</span><span>    style D fill:#fff3e0
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>File: <code>crates/bevy_ecs/src/world/deferred_world.rs</code></strong> (+1/-1)<p>This file contains the core change that relaxes the visibility constraint on the <code>as_unsafe_world_cell</code> method.<p><strong>Before:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>as_unsafe_world_cell</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span>UnsafeWorldCell<'</span><span style=color:#ed9366>_</span><span>> {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>world
</span><span>}
</span></code></pre><p><strong>After:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>as_unsafe_world_cell</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span>UnsafeWorldCell<'</span><span style=color:#ed9366>_</span><span>> {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>world
</span><span>}
</span></code></pre><p>The change is minimal but significant. The method now has public visibility (<code>pub</code>) instead of crate-only visibility (<code>pub(crate)</code>), allowing external crates to access the <code>UnsafeWorldCell</code> from a <code>DeferredWorld</code> instance. This directly addresses the blocking issue in PR #21354 while maintaining all existing safety guarantees through the method’s documentation.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/reference/visibility-and-privacy.html target=_blank>Rust Visibility and Privacy</a> - Official Rust documentation on visibility modifiers<li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_ecs/latest/bevy_ecs/world/struct.World.html target=_blank>Bevy ECS World Documentation</a> - Bevy’s ECS World API<li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_ecs/latest/bevy_ecs/world/struct.UnsafeWorldCell.html target=_blank>UnsafeWorldCell Documentation</a> - Bevy’s unsafe world operations<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/pull/21354 target=_blank>PR #21354</a> - The dependent PR that required this change</ul><h1 id=full-code-diff>Full Code Diff</h1><p>diff –git a/crates/bevy_ecs/src/world/deferred_world.rs b/crates/bevy_ecs/src/world/deferred_world.rs index b30792207731c..099d58a6935bb 100644 — a/crates/bevy_ecs/src/world/deferred_world.rs +++ b/crates/bevy_ecs/src/world/deferred_world.rs @@ -831,7 +831,7 @@ impl<’w> DeferredWorld<’w> { /// # Safety /// - must only be used to make non-structural ECS changes #[inline]<ul><li>pub(crate) fn as_unsafe_world_cell(&mut self) -> UnsafeWorldCell<’_> {</ul><ul><li>pub fn as_unsafe_world_cell(&mut self) -> UnsafeWorldCell<’_> { self.world } }</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-10/pr_21360.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>