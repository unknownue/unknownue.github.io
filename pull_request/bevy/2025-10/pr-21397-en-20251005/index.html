<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21397 Call `world.flush()` after `mark_spawn_despawn()`
        
    </title><meta content="#21397 Call `world.flush()` after `mark_spawn_despawn()`" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-10/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-10-05</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-10/pr-21397-zh-cn-20251005>中文</a></div></div><div class=pr-content><h1 id=call-world-flush-after-mark-spawn-despawn>Call <code>world.flush()</code> after <code>mark_spawn_despawn()</code></h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Call <code>world.flush()</code> after <code>mark_spawn_despawn()</code><li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21397<li><strong>Author</strong>: chescock<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-ECS, S-Needs-Review<li><strong>Created</strong>: 2025-10-05T15:23:59Z<li><strong>Merged</strong>: 2025-10-05T20:03:19Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>During despawn, commands are flushed before writing the <code>despawned_by</code> location. This means that commands run by observers will not see the updated value. It also means an entity spawned by one of those commands that re-uses the entity index may have its <code>spawned_by</code> overwritten by the <code>despawned_by</code> meant for the original entity.<h2 id=solution>Solution</h2><p>Move the call to <code>world.flush()</code> after the call to <code>mark_spawn_despawn()</code>.<h2 id=testing>Testing</h2><p>Added a unit test demonstrating the issue.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a subtle but important timing issue in Bevy’s ECS (Entity Component System) despawn mechanism. The core problem revolves around the order of operations when despawning entities and how this interacts with Bevy’s command system and entity lifecycle tracking.<p>The issue occurred in the <code>despawn</code> method of <code>EntityWorldMut</code>. In the original implementation, the code was structured like this:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Original problematic order:
</span><span style=color:#abb0b6;font-style:italic>// 1. Various cleanup operations
</span><span style=color:#abb0b6;font-style:italic>// 2. world.flush() - commands executed here
</span><span style=color:#abb0b6;font-style:italic>// 3. mark_spawn_despawn() - entity tracking updated here
</span></code></pre><p>This ordering created two specific problems. First, when observers (systems that react to component changes or entity lifecycle events) ran during the command flush, they would query for the <code>despawned_by</code> information, but this data hadn’t been written yet. Second, if a new entity was spawned during the command flush and happened to reuse the same entity index, the new entity’s <code>spawned_by</code> information could be incorrectly overwritten by the <code>despawned_by</code> data intended for the original entity.<p>The solution was straightforward but critical: simply swap the order of these two operations:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Fixed order:
</span><span style=color:#abb0b6;font-style:italic>// 1. Various cleanup operations  
</span><span style=color:#abb0b6;font-style:italic>// 2. mark_spawn_despawn() - entity tracking updated first
</span><span style=color:#abb0b6;font-style:italic>// 3. world.flush() - commands executed after tracking is updated
</span></code></pre><p>This ensures that when commands (including observer systems) run during the flush, they see the correct entity tracking state. The <code>despawned_by</code> information is properly recorded before any systems have a chance to react to the despawn event.<p>The fix demonstrates an important principle in systems programming: the order of state transitions matters, especially when those transitions can trigger other systems. In this case, we need to ensure the entity’s lifecycle state is fully updated before allowing other systems to observe or react to that state change.<p>To validate the fix, the PR includes a comprehensive unit test that specifically reproduces the problematic scenario. The test uses Bevy’s hook system to attach a despawn observer that verifies the <code>despawned_by</code> information is correctly available when the observer runs:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>spawned_by_set_before_flush</span><span>() {
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component)]
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>component</span><span>(on_despawn </span><span style=color:#ed9366>=</span><span> on_despawn)]
</span><span>    </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>C</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>on_despawn</span><span>(</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>:</span><span> DeferredWorld, </span><span style=color:#ff8f40>context</span><span style=color:#61676ccc>:</span><span> HookContext) {
</span><span>        </span><span style=color:#fa6e32>let</span><span> spawned </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(context</span><span style=color:#ed9366>.</span><span>entity)</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawned_by</span><span>()</span><span style=color:#61676ccc>;
</span><span>        world</span><span style=color:#ed9366>.</span><span style=color:#f07171>commands</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>queue</span><span>(</span><span style=color:#fa6e32>move </span><span style=color:#ed9366>|</span><span>world</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> World</span><span style=color:#ed9366>| </span><span>{
</span><span>            </span><span style=color:#abb0b6;font-style:italic>// The entity has finished despawning...
</span><span>            </span><span style=color:#f07171>assert!</span><span>(world</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_entity</span><span>(context</span><span style=color:#ed9366>.</span><span>entity)</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_err</span><span>())</span><span style=color:#61676ccc>;
</span><span>            </span><span style=color:#fa6e32>let</span><span> despawned </span><span style=color:#ed9366>=</span><span> world
</span><span>                </span><span style=color:#ed9366>.</span><span style=color:#f07171>entities</span><span>()
</span><span>                </span><span style=color:#ed9366>.</span><span style=color:#f07171>entity_get_spawned_or_despawned_by</span><span>(context</span><span style=color:#ed9366>.</span><span>entity)</span><span style=color:#61676ccc>;
</span><span>            </span><span style=color:#abb0b6;font-style:italic>// These assertions are only possible if the `track_location` feature is enabled
</span><span>            </span><span style=color:#fa6e32>if let </span><span>(</span><span style=color:#55b4d4;font-style:italic>Some</span><span>(spawned)</span><span style=color:#61676ccc>, </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(despawned)) </span><span style=color:#ed9366>=
</span><span>                (spawned</span><span style=color:#ed9366>.</span><span style=color:#f07171>into_option</span><span>()</span><span style=color:#61676ccc>,</span><span> despawned</span><span style=color:#ed9366>.</span><span style=color:#f07171>into_option</span><span>())
</span><span>            {
</span><span>                </span><span style=color:#abb0b6;font-style:italic>// ... so ensure that `despawned_by` has been written
</span><span>                </span><span style=color:#f07171>assert!</span><span>(despawned</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_some</span><span>())</span><span style=color:#61676ccc>;
</span><span>                </span><span style=color:#f07171>assert_ne!</span><span>(</span><span style=color:#55b4d4;font-style:italic>Some</span><span>(spawned)</span><span style=color:#61676ccc>,</span><span> despawned)</span><span style=color:#61676ccc>;
</span><span>            }
</span><span>        })</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> world </span><span style=color:#ed9366>= </span><span>World</span><span style=color:#ed9366>::</span><span>new()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> original </span><span style=color:#ed9366>=</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>(C)</span><span style=color:#ed9366>.</span><span style=color:#f07171>id</span><span>()</span><span style=color:#61676ccc>;
</span><span>    world</span><span style=color:#ed9366>.</span><span style=color:#f07171>despawn</span><span>(original)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>This test creates a component with a despawn hook, spawns an entity with that component, then despawns it. The hook verifies that the <code>despawned_by</code> information is properly set and available when the observer runs, which wouldn’t have been true with the original buggy ordering.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Entity Despawn Process] --> B[Cleanup Operations]
</span><span>    B --> C[mark_spawn_despawn]
</span><span>    C --> D[Update Entity Tracking]
</span><span>    D --> E[world.flush]
</span><span>    E --> F[Execute Commands/Observers]
</span><span>    F --> G[Observers see correct tracking data]
</span><span>    
</span><span>    H[Original Buggy Flow] --> I[Cleanup Operations]
</span><span>    I --> J[world.flush]
</span><span>    J --> K[Execute Commands/Observers]
</span><span>    K --> L[Observers see stale tracking data]
</span><span>    J --> M[mark_spawn_despawn]
</span><span>    M --> N[Update Entity Tracking - TOO LATE]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ecs-src-world-entity-ref-rs-32-1><code>crates/bevy_ecs/src/world/entity_ref.rs</code> (+32/-1)</h3><p>This file contains the core implementation of entity references and world operations in Bevy’s ECS. The changes fix a critical timing issue in the entity despawn process.<p><strong>Key modification in the <code>despawn</code> method:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#abb0b6;font-style:italic>// ... various cleanup operations ...
</span><span>world</span><span style=color:#ed9366>.</span><span style=color:#f07171>flush</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// SAFETY: `self.entity` is a valid entity index
</span><span style=color:#fa6e32>unsafe </span><span>{
</span><span>    world
</span><span>        </span><span style=color:#ed9366>.</span><span>entities
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>mark_spawn_despawn</span><span>(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>entity</span><span style=color:#ed9366>.</span><span style=color:#f07171>index</span><span>()</span><span style=color:#61676ccc>,</span><span> caller</span><span style=color:#61676ccc>,</span><span> change_tick)</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#abb0b6;font-style:italic>// ... various cleanup operations (same as before) ...
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// SAFETY: `self.entity` is a valid entity index
</span><span style=color:#fa6e32>unsafe </span><span>{
</span><span>    world
</span><span>        </span><span style=color:#ed9366>.</span><span>entities
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>mark_spawn_despawn</span><span>(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>entity</span><span style=color:#ed9366>.</span><span style=color:#f07171>index</span><span>()</span><span style=color:#61676ccc>,</span><span> caller</span><span style=color:#61676ccc>,</span><span> change_tick)</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span>world</span><span style=color:#ed9366>.</span><span style=color:#f07171>flush</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><p>The change is minimal but significant - it ensures that entity tracking information is updated before any commands or observers run during the flush.<p><strong>New test added:</strong><p>The PR also adds a comprehensive unit test (<code>spawned_by_set_before_flush</code>) that specifically validates the fix by creating a scenario where an observer needs to access the <code>despawned_by</code> information during the despawn process.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_ecs/latest/bevy_ecs/ target=_blank>Bevy ECS Documentation</a> - Official documentation for Bevy’s Entity Component System<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/ecs-observers/ target=_blank>Bevy Observers Guide</a> - How to use observers in Bevy<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/crates/bevy_ecs/src/entity/entities.rs target=_blank>Entity Lifecycle Tracking</a> - Source code for entity tracking implementation<li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/programming/commands.html target=_blank>Command System in Bevy</a> - Explanation of Bevy’s command execution model</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-10/pr_21397.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>