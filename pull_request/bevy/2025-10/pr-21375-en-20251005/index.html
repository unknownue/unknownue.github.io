<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21375 `Interaction::Hovered` fix
        
    </title><meta content="#21375 `Interaction::Hovered` fix" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-10/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-10-05</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-10/pr-21375-zh-cn-20251005>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: <code>Interaction::Hovered</code> fix<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21375<li><strong>Author</strong>: ickshonpe<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-UI, S-Ready-For-Final-Review, D-Straightforward<li><strong>Created</strong>: 2025-10-04T11:38:52Z<li><strong>Merged</strong>: 2025-10-05T20:06:41Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p><strong>Objective</strong><p>The <code>Interaction</code> component only gets set to <code>None</code> and <code>Pressed</code> atm.<p>fixes #21374<p><strong>Solution</strong><p>The second while loop through <code>hovered_nodes</code> needs to reuse the iterator from the first while loop. Instead it creates a new iterator and sets <code>Interaction::None</code> for all hovered nodes, not just the ones that are blocked.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a subtle but important bug in Bevy’s UI focus system where the <code>Interaction</code> component wasn’t being properly managed for hovered UI elements. The core issue was in how the system handled iterator state across multiple processing phases.<p>The problem manifested when users hovered over UI elements that had blocking focus policies. In the original implementation, the system would correctly process interactions for the top nodes but then incorrectly reset the interaction state for all hovered nodes in a subsequent pass. This occurred because the second loop created a fresh iterator rather than continuing from where the first loop left off.<p>Looking at the technical implementation, the <code>ui_focus_system</code> processes hovered nodes in two phases. The first phase sets nodes to either <code>Pressed</code> or <code>Hovered</code> state, stopping when it encounters a node with a blocking focus policy. The second phase is supposed to reset the remaining lower nodes to <code>None</code> state, but only those that weren’t already processed in the first phase.<p>The bug occurred because both loops were using independent iterators:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Original problematic code
</span><span style=color:#fa6e32>let mut</span><span> iter </span><span style=color:#ed9366>=</span><span> node_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter_many_mut</span><span>(hovered_nodes</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>())</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// First loop processes top nodes...
</span><span>
</span><span style=color:#fa6e32>let mut</span><span> iter </span><span style=color:#ed9366>=</span><span> node_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter_many_mut</span><span>(hovered_nodes</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>())</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// Second loop incorrectly processes ALL nodes again
</span></code></pre><p>The fix leverages iterator state persistence by storing the iterator and using it across both loops:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Fixed code
</span><span style=color:#fa6e32>let mut</span><span> hovered_nodes </span><span style=color:#ed9366>=</span><span> hovered_nodes</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let mut</span><span> iter </span><span style=color:#ed9366>=</span><span> node_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter_many_mut</span><span>(hovered_nodes</span><span style=color:#ed9366>.</span><span style=color:#f07171>by_ref</span><span>())</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// First loop processes top nodes and advances the iterator...
</span><span>
</span><span style=color:#fa6e32>let mut</span><span> iter </span><span style=color:#ed9366>=</span><span> node_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter_many_mut</span><span>(hovered_nodes)</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// Second loop continues from where first loop left off
</span></code></pre><p>The key insight here is that <code>hovered_nodes.by_ref()</code> in the first loop allows the iterator to be advanced, and then the same iterator state is passed to the second loop. This ensures that only the unprocessed nodes get their interaction state reset to <code>None</code>.<p>This is a classic example of iterator state management in Rust systems programming. The solution demonstrates understanding of how Rust iterators work and how to properly manage their state across multiple processing phases. The fix is minimal but precise - only three lines changed, with one line added and two modified.<p>The impact of this fix is that UI elements now correctly maintain their hover state when they’re blocked by other elements with blocking focus policies. This prevents visual glitches where hover effects would disappear unexpectedly when interacting with complex UI hierarchies.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[ui_focus_system] --> B[First Loop: Process top nodes]
</span><span>    B --> C[Iterator advances past processed nodes]
</span><span>    C --> D[Second Loop: Reset remaining nodes]
</span><span>    D --> E[Correct Interaction states]
</span><span>    
</span><span>    F[Original Bug] --> G[Two independent iterators]
</span><span>    G --> H[All nodes processed twice]
</span><span>    H --> I[Incorrect state reset]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>File: <code>crates/bevy_ui/src/focus.rs</code> (+3/-2)</strong><p>This file contains the UI focus system that manages interaction states for UI elements. The changes fix how hovered nodes are processed across multiple iteration phases.<p><strong>Key Changes:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let mut</span><span> iter </span><span style=color:#ed9366>=</span><span> node_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter_many_mut</span><span>(hovered_nodes</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>())</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// ... first loop processing
</span><span style=color:#fa6e32>let mut</span><span> iter </span><span style=color:#ed9366>=</span><span> node_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter_many_mut</span><span>(hovered_nodes</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>())</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// ... second loop processing
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let mut</span><span> hovered_nodes </span><span style=color:#ed9366>=</span><span> hovered_nodes</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let mut</span><span> iter </span><span style=color:#ed9366>=</span><span> node_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter_many_mut</span><span>(hovered_nodes</span><span style=color:#ed9366>.</span><span style=color:#f07171>by_ref</span><span>())</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// ... first loop processing
</span><span style=color:#fa6e32>let mut</span><span> iter </span><span style=color:#ed9366>=</span><span> node_query</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter_many_mut</span><span>(hovered_nodes)</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// ... second loop processing
</span></code></pre><p>The changes ensure that:<ol><li>The iterator state is preserved between the two processing loops<li>Only unprocessed nodes get their interaction state reset<li>Nodes with blocking focus policies correctly capture and block interactions</ol><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_ui/latest/bevy_ui/struct.Interaction.html target=_blank>Bevy UI Interaction Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/std/iter/trait.Iterator.html target=_blank>Rust Iterator Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/programming/iterating-entities.html target=_blank>Bevy ECS Query Iteration Patterns</a></ul><h1 id=full-code-diff>Full Code Diff</h1><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_ui/src/focus.rs b/crates/bevy_ui/src/focus.rs
</span><span>index ed61ce9e3cb1e..41c133697f590 100644
</span><span style=color:#c594c5>--- a/crates/bevy_ui/src/focus.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_ui/src/focus.rs
</span><span style=color:#c594c5>@@ -302,7 +302,8 @@ </span><span style=color:#399ee6>pub fn ui_focus_system(
</span><span> 
</span><span>     // set Pressed or Hovered on top nodes. as soon as a node with a `Block` focus policy is detected,
</span><span>     // the iteration will stop on it because it "captures" the interaction.
</span><span style=color:#f07171>-    let mut iter = node_query.iter_many_mut(hovered_nodes.iter());
</span><span style=color:#86b300>+    let mut hovered_nodes = hovered_nodes.iter();
</span><span style=color:#86b300>+    let mut iter = node_query.iter_many_mut(hovered_nodes.by_ref());
</span><span>     while let Some(node) = iter.fetch_next() {
</span><span>         if let Some(mut interaction) = node.interaction {
</span><span>             if mouse_clicked {
</span><span style=color:#c594c5>@@ -329,7 +330,7 @@ </span><span style=color:#399ee6>pub fn ui_focus_system(
</span><span>     }
</span><span>     // reset `Interaction` for the remaining lower nodes to `None`. those are the nodes that remain in
</span><span>     // `moused_over_nodes` after the previous loop is exited.
</span><span style=color:#f07171>-    let mut iter = node_query.iter_many_mut(hovered_nodes.iter());
</span><span style=color:#86b300>+    let mut iter = node_query.iter_many_mut(hovered_nodes);
</span><span>     while let Some(node) = iter.fetch_next() {
</span><span>         if let Some(mut interaction) = node.interaction {
</span><span>             // don't reset pressed nodes because they're handled separately
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-10/pr_21375.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>