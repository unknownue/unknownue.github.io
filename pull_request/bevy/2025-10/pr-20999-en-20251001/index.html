<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20999 make Prepass/ShadowsEnabled methods on Material
        
    </title><meta content="#20999 make Prepass/ShadowsEnabled methods on Material" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-10/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-10-01</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-10/pr-20999-zh-cn-20251001>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>make Prepass/ShadowsEnabled methods on Material<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: make Prepass/ShadowsEnabled methods on Material<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20999<li><strong>Author</strong>: ecoskey<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, C-Usability, S-Ready-For-Final-Review, M-Needs-Migration-Guide<li><strong>Created</strong>: 2025-09-13T05:23:58Z<li><strong>Merged</strong>: 2025-10-01T19:46:45Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>enabling prepass/shadows should be done like the rest of a material’s properties</ul><h2 id=solution>Solution</h2><ul><li>remove <code>Prepass/ShadowsEnabled</code> resources and associated fields on <code>MaterialPlugin</code><li>add <code>Material::enable_prepass</code> and <code>Material::enable_shadows</code></ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a consistency issue in Bevy’s material system where enabling prepass and shadows was handled differently from other material properties. Previously, these features were controlled through plugin configuration and global resources, which created an inconsistent API compared to how other material behaviors are defined.<p>The core problem was architectural: prepass and shadow enabling used a plugin-centric approach rather than following the established material trait pattern. This meant developers had to configure these features in two different places - some properties on the material trait itself, and others through plugin configuration. This inconsistency made the API harder to learn and use correctly.<p>The solution refactors this to use a material-centric approach. Instead of configuring prepass and shadows through <code>MaterialPlugin</code> fields and checking for the existence of marker resources, the system now uses trait methods on the <code>Material</code> and <code>MaterialExtension</code> traits. This aligns with how other material properties are defined and makes the configuration more discoverable.<p>Looking at the implementation, the key change was adding default trait methods to the <code>Material</code> trait:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>/// Controls if the prepass is enabled for the Material.
</span><span style=color:#abb0b6;font-style:italic>/// For more information about what a prepass is, see the [`bevy_core_pipeline::prepass`] docs.
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>inline</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>enable_prepass</span><span>() </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>bool </span><span>{
</span><span>    </span><span style=color:#ff8f40>true
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>/// Controls if shadows are enabled for the Material.
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>inline</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>enable_shadows</span><span>() </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>bool </span><span>{
</span><span>    </span><span style=color:#ff8f40>true
</span><span>}
</span></code></pre><p>These methods provide sensible defaults (both enabled) while allowing materials to override the behavior. The corresponding changes were made to <code>MaterialExtension</code> to maintain consistency across the extension system.<p>The plugin system was then updated to use these trait methods instead of checking for marker resources. In <code>MaterialPlugin</code>, the conditional system additions now directly call the trait methods:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>if </span><span>M</span><span style=color:#ed9366>::</span><span>enable_shadows() {
</span><span>    app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(
</span><span>        PostUpdate</span><span style=color:#61676ccc>,
</span><span>        check_light_entities_needing_specialization</span><span style=color:#ed9366>::</span><span>&LTM>
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>in_set</span><span>(RenderSet</span><span style=color:#ed9366>::</span><span>CheckLightEntitiesNeedingSpecialization)</span><span style=color:#61676ccc>,
</span><span>    )</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>This approach eliminates the need for the <code>PrepassEnabled</code> and <code>ShadowsEnabled</code> marker resources entirely. The material preparation system also switched from checking resource existence to calling the trait methods:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let</span><span> shadows_enabled </span><span style=color:#ed9366>= </span><span>M</span><span style=color:#ed9366>::</span><span>enable_shadows()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> prepass_enabled </span><span style=color:#ed9366>= </span><span>M</span><span style=color:#ed9366>::</span><span>enable_prepass()</span><span style=color:#61676ccc>;
</span></code></pre><p>One important technical consideration is that these methods are static - they don’t have access to material instance data. This was a deliberate design choice since prepass and shadow enabling are typically material-type-level decisions rather than per-instance configurations. This keeps the API simple and avoids runtime overhead.<p>The migration required updating existing code that used the old plugin configuration approach. For example, the <code>PrepassOutputMaterial</code> in the shader prepass example was updated to override the trait method instead of using plugin configuration:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>impl </span><span>Material </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>PrepassOutputMaterial </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other methods ...
</span><span>    
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>enable_prepass</span><span>() </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>bool </span><span>{
</span><span>        </span><span style=color:#ff8f40>false
</span><span>    }
</span><span>}
</span></code></pre><p>This change improves API consistency and makes material configuration more intuitive. Developers now have a single, unified pattern for configuring material behavior through the trait system.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Material Trait] --> B[enable_prepass method]
</span><span>    A --> C[enable_shadows method]
</span><span>    D[MaterialExtension Trait] --> E[enable_prepass method]
</span><span>    D --> F[enable_shadows method]
</span><span>    G[MaterialPlugin] --> H[Uses trait methods directly]
</span><span>    B --> H
</span><span>    C --> H
</span><span>    E --> H
</span><span>    F --> H
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-pbr-src-material-rs-18-36><code>crates/bevy_pbr/src/material.rs</code> (+18/-36)</h3><p>This file saw the most significant changes, adding the new trait methods and removing the old resource-based approach.<p><strong>Key additions:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>/// Controls if the prepass is enabled for the Material.
</span><span style=color:#abb0b6;font-style:italic>/// For more information about what a prepass is, see the [`bevy_core_pipeline::prepass`] docs.
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>inline</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>enable_prepass</span><span>() </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>bool </span><span>{
</span><span>    </span><span style=color:#ff8f40>true
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>/// Controls if shadows are enabled for the Material.
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>inline</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>enable_shadows</span><span>() </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>bool </span><span>{
</span><span>    </span><span style=color:#ff8f40>true
</span><span>}
</span></code></pre><p><strong>Key removals:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Removed from MaterialPlugin struct:
</span><span style=color:#fa6e32>pub</span><span> prepass_enabled</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>bool</span><span style=color:#61676ccc>,
</span><span style=color:#fa6e32>pub</span><span> shadows_enabled</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>bool</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Removed resource:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Resource</span><span style=color:#61676ccc>,</span><span> Debug)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>ShadowsEnabled</span><span>&LTM</span><span style=color:#61676ccc>:</span><span> Material>(PhantomData&LTM>)</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-pbr-src-extended-material-rs-21-0><code>crates/bevy_pbr/src/extended_material.rs</code> (+21/-0)</h3><p>Added the same trait methods to <code>MaterialExtension</code> to maintain consistency.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>/// Controls if the prepass is enabled for the Material.
</span><span style=color:#abb0b6;font-style:italic>/// For more information about what a prepass is, see the [`bevy_core_pipeline::prepass`] docs.
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>inline</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>enable_prepass</span><span>() </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>bool </span><span>{
</span><span>    </span><span style=color:#ff8f40>true
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>/// Controls if shadows are enabled for the Material.
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>inline</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>enable_shadows</span><span>() </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>bool </span><span>{
</span><span>    </span><span style=color:#ff8f40>true
</span><span>}
</span></code></pre><h3 id=crates-bevy-pbr-src-prepass-mod-rs-1-12><code>crates/bevy_pbr/src/prepass/mod.rs</code> (+1/-12)</h3><p>Removed the <code>PrepassEnabled</code> resource that was no longer needed.<h3 id=examples-shader-shader-prepass-rs-5-6><code>examples/shader/shader_prepass.rs</code> (+5/-6)</h3><p>Updated the example to use the new trait method approach:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>MaterialPlugin</span><span style=color:#ed9366>::</span><span>&LTPrepassOutputMaterial> {
</span><span>    prepass_enabled</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>false</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#ed9366>..</span><span style=color:#f07171>default</span><span>()
</span><span>}</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>impl </span><span>Material </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>PrepassOutputMaterial </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>enable_prepass</span><span>() </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>bool </span><span>{
</span><span>        </span><span style=color:#ff8f40>false
</span><span>    }
</span><span>}
</span></code></pre><h3 id=release-content-migration-guides-enable-prepass-md-25-0><code>release-content/migration-guides/enable_prepass.md</code> (+25/-0)</h3><p>Added comprehensive migration guide showing how to update code from the old plugin-based approach to the new trait-based approach.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_pbr/latest/bevy_pbr/trait.Material.html target=_blank>Bevy Material System Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_core_pipeline/latest/bevy_core_pipeline/prepass/index.html target=_blank>Bevy Prepass Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/book/ch10-02-traits.html target=_blank>Rust Trait System</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-10/pr_20999.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>