<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20650 Add a way for the `AssetServer` to report how many asset loads started.
        
    </title><meta content="#20650 Add a way for the `AssetServer` to report how many asset loads started." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-10/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-10-16</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-10/pr-20650-zh-cn-20251016>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Add a way for the <code>AssetServer</code> to report how many asset loads started.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20650<li><strong>Author</strong>: andriyDev<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Assets, C-Usability, S-Ready-For-Final-Review, C-Testing, D-Straightforward<li><strong>Created</strong>: 2025-08-19T04:01:59Z<li><strong>Merged</strong>: 2025-10-16T18:52:08Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li><code>bevy_asset</code> needs better testing.<li>It is useful to know how many load tasks the asset server launched. For example, #12756 is difficult to test because we are literally looking for whether another load <strong>doesn’t</strong> happen.</ul><h2 id=solution>Solution</h2><ul><li>Add an <code>AssetServerStats</code> struct.<li>Increment the number of loads whenever we start a load.</ul><h2 id=testing>Testing</h2><ul><li>Updated several tests to also assert about the number of expected loads.<li>The testing here is not exhaustive, but should cover the common cases.<li>I will be looking into more testing in the future.</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a testing limitation in Bevy’s asset system. The core problem was that while the asset system provides ways to track when assets are loaded or failed, there was no straightforward way to verify that a load operation was actually initiated. This made certain types of tests difficult - particularly negative tests where you need to ensure that an asset load does NOT occur under specific conditions.<p>The solution implemented here follows a straightforward pattern: add instrumentation to track when asset load tasks start. The developer created a new <code>AssetServerStats</code> struct to hold this metric and increment a counter at every point in the codebase where asset loading begins.<p>Looking at the implementation, the approach is comprehensive but surgical. The changes touch multiple loading pathways to ensure all types of asset loads are tracked:<ol><li>Standard asset loading via <code>AssetServer::load()</code><li>Untyped asset loading<li>Folder loading<li>Asset reloading<li>Nested asset loading through loader builders</ol><p>The implementation integrates with Bevy’s existing diagnostic system, making the load count available through the standard diagnostics interface. This means the metric can be accessed through the <code>DiagnosticsStore</code> resource and is automatically available to diagnostic tools and UI.<p>One interesting aspect of the implementation is how it handles the diagnostic publishing. The system uses a run condition to only publish when the <code>DiagnosticsStore</code> resource exists, with a TODO comment noting they plan to use a more idiomatic approach once a related Bevy issue is resolved.<p>The testing updates demonstrate the practical value of this feature. Multiple existing tests were enhanced to verify the expected number of load operations, providing concrete examples of how this instrumentation can be used to validate asset loading behavior. The tests cover various scenarios including dependency chains, duplicate loading prevention, and folder loading.<p>From an architectural perspective, this change follows good practices by:<ul><li>Keeping the statistics collection internal to the asset system<li>Using atomic increments where appropriate<li>Maintaining separation of concerns by having a dedicated system for publishing diagnostics<li>Not breaking existing APIs</ul><p>The implementation is minimal and focused, adding only what’s necessary to solve the stated problem without over-engineering.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[AssetServer] --> B[AssetInfos]
</span><span>    B --> C[AssetServerStats]
</span><span>    C --> D[started_load_tasks counter]
</span><span>    A --> E[Diagnostics System]
</span><span>    E --> F[DiagnosticsStore]
</span><span>    F --> G[STARTED_LOAD_COUNT metric]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-asset-src-server-info-rs><code>crates/bevy_asset/src/server/info.rs</code></h3><p>Added the core statistics tracking structure:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>/// Tracks statistics of the asset server.
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Default</span><span style=color:#61676ccc>,</span><span> Clone</span><span style=color:#61676ccc>,</span><span> PartialEq</span><span style=color:#61676ccc>,</span><span> Eq)]
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>AssetServerStats </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>/// The number of load tasks that have been started.
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) started_load_tasks</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize</span><span>,
</span><span>}
</span></code></pre><p>This struct is then added to the <code>AssetInfos</code> struct as a new field:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>AssetInfos </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... existing fields ...
</span><span>    </span><span style=color:#abb0b6;font-style:italic>/// The stats that have collected during usage of the asset server.
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) stats</span><span style=color:#61676ccc>:</span><span> AssetServerStats,
</span><span>}
</span></code></pre><h3 id=crates-bevy-asset-src-server-mod-rs><code>crates/bevy_asset/src/server/mod.rs</code></h3><p>Multiple loading methods were updated to increment the load counter:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// In load_untyped_internal method
</span><span>infos</span><span style=color:#ed9366>.</span><span>stats</span><span style=color:#ed9366>.</span><span>started_load_tasks </span><span style=color:#ed9366>+= </span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// In load_untyped_async method  
</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>write_infos</span><span>()</span><span style=color:#ed9366>.</span><span>stats</span><span style=color:#ed9366>.</span><span>started_load_tasks </span><span style=color:#ed9366>+= </span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// In load_untyped_with_meta_transform_internal method
</span><span>infos</span><span style=color:#ed9366>.</span><span>stats</span><span style=color:#ed9366>.</span><span>started_load_tasks </span><span style=color:#ed9366>+= </span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// In reload_asset method (for each reload)
</span><span>server</span><span style=color:#ed9366>.</span><span style=color:#f07171>write_infos</span><span>()</span><span style=color:#ed9366>.</span><span>stats</span><span style=color:#ed9366>.</span><span>started_load_tasks </span><span style=color:#ed9366>+= </span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// In load_folder method
</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>write_infos</span><span>()</span><span style=color:#ed9366>.</span><span>stats</span><span style=color:#ed9366>.</span><span>started_load_tasks </span><span style=color:#ed9366>+= </span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>;
</span></code></pre><p>Added diagnostic constant and publishing system:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>impl </span><span style=color:#399ee6>AssetServer </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>/// The number of loads that have been started by the server.
</span><span>    </span><span style=color:#fa6e32>pub const </span><span style=color:#ff8f40>STARTED_LOAD_COUNT</span><span style=color:#61676ccc>:</span><span> DiagnosticPath </span><span style=color:#ed9366>= </span><span>DiagnosticPath</span><span style=color:#ed9366>::</span><span>const_new(</span><span style=color:#86b300>"started_load_count"</span><span>)</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>/// A system publishing asset server statistics to [`bevy_diagnostic`].
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>publish_asset_server_diagnostics</span><span>(
</span><span>    </span><span style=color:#ff8f40>asset_server</span><span style=color:#61676ccc>: </span><span>Res&LTAssetServer>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>diagnostics</span><span style=color:#61676ccc>:</span><span> Diagnostics,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>let</span><span> infos </span><span style=color:#ed9366>=</span><span> asset_server</span><span style=color:#ed9366>.</span><span style=color:#f07171>read_infos</span><span>()</span><span style=color:#61676ccc>;
</span><span>    diagnostics</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_measurement</span><span>(</span><span style=color:#ed9366>&</span><span>AssetServer</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>STARTED_LOAD_COUNT</span><span style=color:#61676ccc>, </span><span>|| {
</span><span>        infos</span><span style=color:#ed9366>.</span><span>stats</span><span style=color:#ed9366>.</span><span>started_load_tasks </span><span style=color:#ed9366>as _
</span><span>    })</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=crates-bevy-asset-src-loader-builders-rs><code>crates/bevy_asset/src/loader_builders.rs</code></h3><p>Updated nested loader to track load starts:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>load_context
</span><span>    </span><span style=color:#ed9366>.</span><span>asset_server
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>write_infos</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span>stats
</span><span>    </span><span style=color:#ed9366>.</span><span>started_load_tasks </span><span style=color:#ed9366>+= </span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-asset-src-lib-rs><code>crates/bevy_asset/src/lib.rs</code></h3><p>Integrated the diagnostic system and updated tests:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added to AssetPlugin build method
</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(
</span><span>    PreUpdate</span><span style=color:#61676ccc>,
</span><span>    (
</span><span>        handle_internal_asset_events</span><span style=color:#ed9366>.</span><span style=color:#f07171>ambiguous_with_all</span><span>()</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// TODO: Remove the run condition and use `If` once
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// https://github.com/bevyengine/bevy/issues/21549 is resolved.
</span><span>        publish_asset_server_diagnostics</span><span style=color:#ed9366>.</span><span style=color:#f07171>run_if</span><span>(resource_exists</span><span style=color:#ed9366>::</span><span>&LTDiagnosticsStore>)</span><span style=color:#61676ccc>,
</span><span>    )
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>chain</span><span>()</span><span style=color:#61676ccc>,
</span><span>)
</span><span style=color:#ed9366>.</span><span style=color:#f07171>register_diagnostic</span><span>(Diagnostic</span><span style=color:#ed9366>::</span><span>new(AssetServer</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>STARTED_LOAD_COUNT</span><span>))</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-asset-cargo-toml><code>crates/bevy_asset/Cargo.toml</code></h3><p>Added dependency on bevy_diagnostic:<pre class=language-toml data-lang=toml style=color:#61676c;background-color:#fafafa><code class=language-toml data-lang=toml><span style=color:#399ee6>bevy_diagnostic </span><span>= { </span><span style=color:#399ee6>path </span><span>= </span><span style=color:#86b300>"../bevy_diagnostic"</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>version </span><span>= </span><span style=color:#86b300>"0.18.0-dev"</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>default-features </span><span>= </span><span style=color:#ff8f40>false </span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/resources/assets/ target=_blank>Bevy Assets Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_diagnostic/latest/bevy_diagnostic/ target=_blank>Bevy Diagnostics System</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/pull/12756 target=_blank>PR #12756</a> - Referenced as an example where this functionality would be useful<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/next-steps/testing/ target=_blank>Bevy Testing Guide</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-10/pr_20650.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>