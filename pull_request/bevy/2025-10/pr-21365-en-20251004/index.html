<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21365 Fix u32 overflow when window is resize
        
    </title><meta content="#21365 Fix u32 overflow when window is resize" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-10/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-10-04</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-10/pr-21365-zh-cn-20251004>中文</a></div></div><div class=pr-content><h1 id=fix-u32-overflow-when-window-is-resize>Fix u32 overflow when window is resize</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix u32 overflow when window is resize<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21365<li><strong>Author</strong>: baozaolaoba-top<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, C-Examples, A-Windowing, S-Ready-For-Final-Review, D-Straightforward<li><strong>Created</strong>: 2025-10-03T16:12:30Z<li><strong>Merged</strong>: 2025-10-04T19:07:15Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>The original description is in English, so it is preserved as-is:<h1 id=objective>Objective</h1><p>bevy v0.17.1, archlinux + i3wm.<p><code>cargo run --example 2d_viewport_to_world</code><pre style=color:#61676c;background-color:#fafafa><code><span>thread 'Compute Task Pool (1)' (470531) panicked at /home/go/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/glam-0.30.8/src/u32/uvec2.rs:1071:23:
</span><span>attempt to subtract with overflow
</span><span>note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
</span><span>Encountered a panic in system `2d_viewport_to_world::controls`!
</span><span>Encountered a panic in system `bevy_app::main_schedule::FixedMain::run_fixed_main`!
</span><span>Encountered a panic in system `bevy_time::fixed::run_fixed_main_schedule`!
</span><span>Encountered a panic in system `bevy_app::main_schedule::Main::run_main`!
</span></code></pre><h2 id=solution>Solution</h2><p>Consider window resize。<h2 id=testing>Testing</h2><p>no panic.<hr><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a specific integer overflow bug that occurs when resizing windows in the Bevy game engine’s 2D viewport example. The issue manifested as a panic in the <code>glam</code> library’s vector mathematics code when attempting to perform subtraction operations that would underflow unsigned integers.<p>The core problem occurred in the <code>2d_viewport_to_world</code> example’s control system. When users resized their application window to a smaller size, the viewport’s physical dimensions could become larger than the window itself. This mismatch created a scenario where subsequent arithmetic operations in the viewport positioning logic would attempt to subtract larger values from smaller ones, causing unsigned integer underflow.<p>The solution implemented is straightforward and defensive. Before processing viewport movement controls, the code now checks if either dimension of the viewport’s physical size exceeds the corresponding window dimension. If this condition is met, the viewport is automatically resized to 75% of the window dimensions, ensuring the viewport always fits within the window bounds.<p>This fix demonstrates an important principle in game engine development: robust handling of dynamic window resizing. The implementation uses saturation arithmetic (<code>saturating_sub</code>) for viewport movement to prevent similar overflow issues, and the new resize check acts as a safety net against invalid viewport configurations.<p>The change is minimal but effective - it adds only three lines of code that prevent a crash scenario while maintaining the example’s intended functionality. The solution preserves the viewport’s relative size (75% of window) while ensuring mathematical operations remain within safe bounds.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Window Resize Event] --> B[Viewport Size Check]
</span><span>    B --> C{Viewport > Window?}
</span><span>    C -->|Yes| D[Resize Viewport to 75%]
</span><span>    C -->|No| E[Continue Normal Processing]
</span><span>    D --> F[Safe Arithmetic Operations]
</span><span>    E --> F
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=examples-2d-2d-viewport-to-world-rs><code>examples/2d/2d_viewport_to_world.rs</code></h3><p>This file contains the 2D viewport to world example that demonstrates how to work with viewports and convert between viewport coordinates and world coordinates.<p><strong>Key Changes:</strong><ul><li>Added viewport size validation logic to prevent integer overflow<li>Implemented defensive programming against window resize edge cases</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// File: examples/2d/2d_viewport_to_world.rs
</span><span style=color:#abb0b6;font-style:italic>// Added code:
</span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(viewport) </span><span style=color:#ed9366>=</span><span> camera</span><span style=color:#ed9366>.</span><span>viewport</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_mut</span><span>() {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Reset viewport size on window resize
</span><span>    </span><span style=color:#fa6e32>if</span><span> viewport</span><span style=color:#ed9366>.</span><span>physical_size</span><span style=color:#ed9366>.</span><span>x </span><span style=color:#ed9366>></span><span> window_size</span><span style=color:#ed9366>.</span><span>x </span><span style=color:#ed9366>||</span><span> viewport</span><span style=color:#ed9366>.</span><span>physical_size</span><span style=color:#ed9366>.</span><span>y </span><span style=color:#ed9366>></span><span> window_size</span><span style=color:#ed9366>.</span><span>y {
</span><span>        viewport</span><span style=color:#ed9366>.</span><span>physical_size </span><span style=color:#ed9366>= </span><span>(window_size</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_vec2</span><span>() </span><span style=color:#ed9366>* </span><span style=color:#ff8f40>0.75</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_uvec2</span><span>()</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Viewport movement controls
</span><span>    </span><span style=color:#fa6e32>if</span><span> input</span><span style=color:#ed9366>.</span><span style=color:#f07171>pressed</span><span>(KeyCode</span><span style=color:#ed9366>::</span><span>KeyW) {
</span><span>        viewport</span><span style=color:#ed9366>.</span><span>physical_position</span><span style=color:#ed9366>.</span><span>y </span><span style=color:#ed9366>=</span><span> viewport</span><span style=color:#ed9366>.</span><span>physical_position</span><span style=color:#ed9366>.</span><span>y</span><span style=color:#ed9366>.</span><span style=color:#f07171>saturating_sub</span><span>(uspeed)</span><span style=color:#61676ccc>;
</span></code></pre><p>The change integrates seamlessly with the existing viewport movement controls, placing the validation check at the beginning of the viewport modification logic. This ensures the viewport is in a valid state before any movement operations occur.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/render/view/struct.Viewport.html target=_blank>Bevy Viewport Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/book/ch03-02-data-types.html#integer-overflow target=_blank>Rust Integer Overflow Handling</a><li><a rel="noopener nofollow noreferrer" href=https://gamedev.stackexchange.com/questions/140469/what-is-saturation-arithmetic target=_blank>Saturation Arithmetic in Game Development</a><li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/features/camera.html target=_blank>Bevy Camera and Viewport Systems</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-10/pr_21365.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>