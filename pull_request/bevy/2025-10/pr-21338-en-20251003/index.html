<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21338 Avoid a "RefCell already borrowed" error with WINIT_WINDOWS
        
    </title><meta content='#21338 Avoid a "RefCell already borrowed" error with WINIT_WINDOWS' property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-10/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-10-03</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-10/pr-21338-zh-cn-20251003>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>Avoid a “RefCell already borrowed” error with WINIT_WINDOWS<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Avoid a “RefCell already borrowed” error with WINIT_WINDOWS<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21338<li><strong>Author</strong>: ejrh<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Windowing, O-Windows, S-Ready-For-Final-Review, D-Straightforward<li><strong>Created</strong>: 2025-10-02T07:46:25Z<li><strong>Merged</strong>: 2025-10-03T02:40:38Z<li><strong>Merged By</strong>: james7132</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Fixes #21319.<h2 id=solution>Solution</h2><p>In the “about_to_wait” state of Bevy’s winit event loop, we borrow WINIT_WINDOWS only to check the conditions for a redraw, and perform the call after that check is concluded.<h2 id=testing>Testing</h2><p>Tested by confirming that the RefCell error no longer occurs in my application. In my application, the error occurred when the <code>bevy-egui-inspector</code> crate was used.<p>I do not know whether the original reporter of #21319 was also using third-party Bevy plugins that might have caused the issue. It would be good if they could check whether this change fixes it for them.<p>Tested on Windows 11, where the bug is known to occur. The code that was changed is only included in Windows builds so there is little need to test on other platforms.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a specific race condition in Bevy’s windowing system on Windows that manifested as a “RefCell already borrowed” panic. The issue occurred in the <code>about_to_wait</code> event loop handler where the code was performing a nested borrow of the WINIT_WINDOWS thread-local storage.<p>The core problem was in the interaction between Bevy’s event processing and the WINIT_WINDOWS RefCell. In the original implementation, the code borrowed WINIT_WINDOWS and then, while still holding that borrow, called <code>self.redraw_requested(event_loop)</code>. This created a situation where if the redraw processing also needed to access WINIT_WINDOWS, it would attempt to borrow the already-borrowed RefCell, causing a panic.<p>The solution demonstrates a clear understanding of Rust’s borrowing rules and RefCell semantics. Instead of performing the redraw request inside the WINIT_WINDOWS borrow scope, the implementation extracts the necessary state checking into a separate function <code>headless_or_all_invisible()</code>. This function performs the minimal borrow of WINIT_WINDOWS needed to determine the window visibility state, then returns a boolean result. The actual redraw request is made outside of any WINIT_WINDOWS borrow.<p>Here’s the key transformation in the code structure:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Redraw called inside WINIT_WINDOWS borrow
</span><span style=color:#ff8f40>WINIT_WINDOWS</span><span style=color:#ed9366>.</span><span style=color:#f07171>with_borrow</span><span>(|</span><span style=color:#ff8f40>winit_windows</span><span>| {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... condition checks
</span><span>    </span><span style=color:#fa6e32>if</span><span> condition {
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>redraw_requested</span><span>(event_loop)</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// Potential nested borrow
</span><span>    }
</span><span>})</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Conditions extracted, redraw called outside borrow
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>headless_or_all_invisible</span><span>() </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>bool </span><span>{
</span><span>    </span><span style=color:#ff8f40>WINIT_WINDOWS</span><span style=color:#ed9366>.</span><span style=color:#f07171>with_borrow</span><span>(|</span><span style=color:#ff8f40>winit_windows</span><span>| {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// Minimal borrow for state checking only
</span><span>    })
</span><span>}
</span><span>
</span><span style=color:#fa6e32>if</span><span> condition {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>redraw_requested</span><span>(event_loop)</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// Safe outside WINIT_WINDOWS borrow
</span><span>}
</span></code></pre><p>The implementation also simplifies the condition checking logic by inlining several variables that were previously computed inside the borrow scope. The <code>reactive</code> check is now done directly with a pattern match, and the <code>exiting</code> condition is checked using <code>self.app_exit.is_some()</code> directly.<p>This change is particularly important because it addresses a timing-sensitive bug that only manifested under specific conditions, often when third-party plugins like <code>bevy-egui-inspector</code> were involved. The fix ensures that the windowing system maintains proper borrowing discipline, preventing potential deadlocks or panics in complex application scenarios.<p>The Windows-specific nature of this fix is appropriate because the problematic code was already conditionally compiled only for Windows, addressing the platform-specific window creation behavior mentioned in the linked issue #18027.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[about_to_wait Event] --> B[Borrow WINIT_WINDOWS]
</span><span>    B --> C[Check Conditions]
</span><span>    C --> D[Release Borrow]
</span><span>    D --> E[Condition Met?]
</span><span>    E -->|Yes| F[Call redraw_requested]
</span><span>    E -->|No| G[Continue]
</span><span>    
</span><span>    F --> H[Potential Nested Borrow]
</span><span>    H --> I[PANIC: RefCell already borrowed]
</span><span>    
</span><span>    style I fill:#ff9999
</span><span>    
</span><span>    subgraph "Fixed Implementation"
</span><span>    J[about_to_wait Event] --> K[headless_or_all_invisible]
</span><span>    K --> L[Borrow WINIT_WINDOWS]
</span><span>    L --> M[Compute Visibility State]
</span><span>    M --> N[Return Boolean]
</span><span>    N --> O[Release Borrow]
</span><span>    O --> P[Check All Conditions]
</span><span>    P -->|Yes| Q[Call redraw_requested]
</span><span>    P -->|No| R[Continue]
</span><span>    end
</span><span>    
</span><span>    style I stroke:#ff0000,stroke-width:4px
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-winit-src-state-rs-21-22><code>crates/bevy_winit/src/state.rs</code> (+21/-22)</h3><p>This file contains the core windowing state management for Bevy’s winit integration. The changes focus on the Windows-specific event handling in the <code>about_to_wait</code> method.<p><strong>Key Changes:</strong><ol><li><strong>Extracted visibility checking into a separate function:</strong></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#ff8f40>WINIT_WINDOWS</span><span style=color:#ed9366>.</span><span style=color:#f07171>with_borrow</span><span>(|</span><span style=color:#ff8f40>winit_windows</span><span>| {
</span><span>    </span><span style=color:#fa6e32>let</span><span> headless </span><span style=color:#ed9366>=</span><span> winit_windows</span><span style=color:#ed9366>.</span><span>windows</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_empty</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> exiting </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>app_exit</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_some</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> reactive </span><span style=color:#ed9366>= </span><span style=color:#f07171>matches!</span><span>(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>update_mode</span><span style=color:#61676ccc>, </span><span>UpdateMode</span><span style=color:#ed9366>::</span><span>Reactive { </span><span style=color:#ed9366>.. </span><span>})</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> all_invisible </span><span style=color:#ed9366>=</span><span> winit_windows
</span><span>        </span><span style=color:#ed9366>.</span><span>windows
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>all</span><span>(|(_</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>w</span><span>)| </span><span style=color:#ed9366>!</span><span>w</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_visible</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_or</span><span>(</span><span style=color:#ff8f40>false</span><span>))</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>exiting
</span><span>        </span><span style=color:#ed9366>&& </span><span>(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>startup_forced_updates </span><span style=color:#ed9366>> </span><span style=color:#ff8f40>0
</span><span>            </span><span style=color:#ed9366>||</span><span> headless
</span><span>            </span><span style=color:#ed9366>||</span><span> all_invisible
</span><span>            </span><span style=color:#ed9366>||</span><span> reactive
</span><span>            </span><span style=color:#ed9366>|| </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>window_event_received)
</span><span>    {
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>redraw_requested</span><span>(event_loop)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>})</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>headless_or_all_invisible</span><span>() </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>bool </span><span>{
</span><span>    </span><span style=color:#ff8f40>WINIT_WINDOWS</span><span style=color:#ed9366>.</span><span style=color:#f07171>with_borrow</span><span>(|</span><span style=color:#ff8f40>winit_windows</span><span>| {
</span><span>        winit_windows
</span><span>            </span><span style=color:#ed9366>.</span><span>windows
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>()
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>all</span><span>(|(_</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>w</span><span>)| </span><span style=color:#ed9366>!</span><span>w</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_visible</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_or</span><span>(</span><span style=color:#ff8f40>false</span><span>))
</span><span>    })
</span><span>}
</span><span>
</span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>app_exit</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_some</span><span>()
</span><span>    </span><span style=color:#ed9366>&& </span><span>(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>startup_forced_updates </span><span style=color:#ed9366>> </span><span style=color:#ff8f40>0
</span><span>        </span><span style=color:#ed9366>|| </span><span style=color:#f07171>matches!</span><span>(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>update_mode</span><span style=color:#61676ccc>, </span><span>UpdateMode</span><span style=color:#ed9366>::</span><span>Reactive { </span><span style=color:#ed9366>.. </span><span>})
</span><span>        </span><span style=color:#ed9366>|| </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>window_event_received
</span><span>        </span><span style=color:#ed9366>|| </span><span style=color:#f07171>headless_or_all_invisible</span><span>())
</span><span>{
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>redraw_requested</span><span>(event_loop)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><ol start=2><li><strong>Minor formatting fix in test code:</strong></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>mut</span><span> window_backend_scale_factor_changed</span><span style=color:#61676ccc>: </span><span>MessageWriter<
</span><span>    WindowBackendScaleFactorChanged,
</span><span>></span><span style=color:#61676ccc>,
</span><span style=color:#fa6e32>mut</span><span> window_scale_factor_changed</span><span style=color:#61676ccc>: </span><span>MessageWriter&LTWindowScaleFactorChanged></span><span style=color:#ed9366>| </span><span>{
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>mut</span><span> window_backend_scale_factor_changed</span><span style=color:#61676ccc>: </span><span>MessageWriter<
</span><span>    WindowBackendScaleFactorChanged,
</span><span>></span><span style=color:#61676ccc>,
</span><span style=color:#fa6e32>mut</span><span> window_scale_factor_changed</span><span style=color:#61676ccc>: </span><span>MessageWriter&LTWindowScaleFactorChanged></span><span style=color:#ed9366>| </span><span>{
</span></code></pre><p>The changes ensure that the WINIT_WINDOWS borrow is held for the shortest possible time and that no nested operations that might require re-borrowing are performed within the borrow scope.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/std/cell/struct.RefCell.html target=_blank>Rust RefCell Documentation</a> - Understanding interior mutability and borrowing rules<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/getting-started/window/ target=_blank>Bevy Window Management</a> - Bevy’s windowing system overview<li><a rel="noopener nofollow noreferrer" href=https://docs.rs/winit/latest/winit/event_loop/struct.EventLoop.html target=_blank>Winit Event Loop</a> - Winit’s event handling model<li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/std/macro.thread_local.html target=_blank>Thread Local Storage in Rust</a> - How WINIT_WINDOWS thread-local storage works</ul><h1 id=full-code-diff>Full Code Diff</h1><p>diff –git a/crates/bevy_winit/src/state.rs b/crates/bevy_winit/src/state.rs index 0eef31fb96640..93db66446038e 100644 — a/crates/bevy_winit/src/state.rs +++ b/crates/bevy_winit/src/state.rs @@ -466,24 +466,23 @@ impl&LTM: Message> ApplicationHandler<m> for WinitAppRunnerState<m> { // invisible window creation. https://github.com/bevyengine/bevy/issues/18027 #[cfg(target_os = “windows”)] { <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>       WINIT_WINDOWS.with_borrow(|winit_windows| {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           let headless = winit_windows.windows.is_empty();
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           let exiting = self.app_exit.is_some();
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           let reactive = matches!(self.update_mode, UpdateMode::Reactive { .. });
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           let all_invisible = winit_windows
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>               .windows
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>               .iter()
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>               .all(|(_, w)| !w.is_visible().unwrap_or(false));
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           if !exiting
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>               && (self.startup_forced_updates > 0
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>                   || headless
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>                   || all_invisible
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>                   || reactive
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>                   || self.window_event_received)
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>               self.redraw_requested(event_loop);
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           }
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       });
</span></code></pre></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>       fn headless_or_all_invisible() -> bool {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           WINIT_WINDOWS.with_borrow(|winit_windows| {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>               winit_windows
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>                   .windows
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>                   .iter()
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>                   .all(|(_, w)| !w.is_visible().unwrap_or(false))
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           })
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       }
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>       if !self.app_exit.is_some()
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           && (self.startup_forced_updates > 0
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>               || matches!(self.update_mode, UpdateMode::Reactive { .. })
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>               || self.window_event_received
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>               || headless_or_all_invisible())
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           self.redraw_requested(event_loop);
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       }
</span><span>   }
</span></code></pre> }</ul> <p>@@ -1023,10 +1022,10 @@ mod tests { app.add_systems( Update, move |mut window: Single<(Entity, &mut Window)>,</p> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>        mut window_backend_scale_factor_changed: MessageWriter<
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           WindowBackendScaleFactorChanged,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       >,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>        mut window_scale_factor_changed: MessageWriter&LTWindowScaleFactorChanged>| {
</span></code></pre></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>             mut window_backend_scale_factor_changed: MessageWriter<
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>                 WindowBackendScaleFactorChanged,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>             >,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>             mut window_scale_factor_changed: MessageWriter&LTWindowScaleFactorChanged>| {
</span><span>           react_to_scale_factor_change(
</span><span>               window.0,
</span><span>               &mut window.1,</span></code></pre></ul>    <div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-10/pr_21338.patch id=patch-info style=display:none></div>  <div class=bottom-spacer></div> 