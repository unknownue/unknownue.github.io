<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21348 Solari: Fix world cache update using last frame's light tiles due to incorrect pass ordering
        
    </title><meta content="#21348 Solari: Fix world cache update using last frame's light tiles due to incorrect pass ordering" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-10/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-10-02</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2025-10/pr-21348-en-20251002>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=solari-fix-world-cache-update-using-last-frame-s-light-tiles-due-to-incorrect-pass-ordering>Solari: Fix world cache update using last frame’s light tiles due to incorrect pass ordering</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Solari: Fix world cache update using last frame’s light tiles due to incorrect pass ordering<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21348<li><strong>Author</strong>: JMS55<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, S-Ready-For-Final-Review, D-Straightforward<li><strong>Created</strong>: 2025-10-02T15:11:39Z<li><strong>Merged</strong>: 2025-10-02T17:06:12Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>Light tiles used to be generated <em>after</em> the world cache update, despite the world cache update relying on them. This means that the world cache update used last frame’s light tiles, which is fine for static lights, but completely wrong for dynamic lights and lead to missing GI contributions from dynamic lights.<p>Moving the presample light tile step to before the world cache update fixes this.<p>Can be tested by running the solari example, turning off the directional light so there’s only the emissive robot light, enabling VISUALIZE_WORLD_CACHE, and then comparing before/after this PR.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>这个PR解决了一个渲染管线中执行顺序错误导致的bug。问题出现在Bevy引擎的Solari全局光照系统中，具体涉及光照瓦片（light tiles）和世界缓存（world cache）的更新时序。<p>问题的核心在于依赖关系被错误地处理了。在渲染管线中，世界缓存的更新需要依赖当前帧的光照瓦片数据，但原来的执行顺序却是先更新世界缓存，然后再生成光照瓦片。这导致世界缓存实际上使用的是上一帧的光照瓦片数据。<p>对于静态光源来说，这种时序问题可能不会立即显现，因为静态光源的位置和属性在帧之间不会改变。但对于动态光源，比如移动的发射光机器人，使用上一帧的数据就会导致全局光照计算错误，具体表现为动态光源的贡献丢失。<p>从技术实现角度看，这个bug的修复相对简单直接：只需要调整两个计算步骤的执行顺序。原来的代码流程是：<ol><li>设置世界缓存活动单元格的dispatch<li>执行世界缓存衰减（decay_world_cache）<li>执行世界缓存更新（update_world_cache）<li>最后才预采样光照瓦片（presample_light_tiles）</ol><p>修复后的正确顺序是：<ol><li>先预采样光照瓦片（presample_light_tiles）<li>设置世界缓存活动单元格的dispatch<li>执行世界缓存衰减（decay_world_cache）<li>执行世界缓存更新（update_world_cache）</ol><p>这种调整确保了当世界缓存更新执行时，它能够访问到当前帧最新生成的光照瓦片数据，而不是过时的上一帧数据。<p>从代码层面看，这个修复涉及将<code>presample_light_tiles_pipeline</code>相关的代码块从管线末尾移动到世界缓存更新操作之前。具体的修改包括设置管线、推送常量（包含帧索引和重置标志），以及dispatch工作组的调用。<p>这种类型的bug在图形编程中比较常见，特别是在复杂的多阶段渲染管线中。它强调了正确理解数据依赖关系的重要性，以及在GPU计算中确保计算步骤按正确顺序执行的必要性。虽然修复本身只是简单的代码重排，但识别出这种时序问题需要对渲染管线的数据流有深入的理解。<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[渲染管线开始] --> B[预采样光照瓦片]
</span><span>    B --> C[世界缓存活动单元格dispatch]
</span><span>    C --> D[世界缓存衰减]
</span><span>    D --> E[世界缓存更新]
</span><span>    E --> F[渲染管线继续]
</span><span>    
</span><span>    style B fill:#9f9
</span><span>    style E fill:#f99
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-solari-src-realtime-node-rs-7-7><code>crates/bevy_solari/src/realtime/node.rs</code> (+7/-7)</h3><p>这个文件包含了渲染节点的实现，是修复的核心所在。修改涉及重新排列渲染管线中计算步骤的执行顺序。<p><strong>关键修改：</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 修复后的执行顺序：
</span><span style=color:#abb0b6;font-style:italic>// 光照瓦片预采样被移到世界缓存更新之前
</span><span>pass</span><span style=color:#ed9366>.</span><span style=color:#f07171>set_pipeline</span><span>(presample_light_tiles_pipeline)</span><span style=color:#61676ccc>;
</span><span>pass</span><span style=color:#ed9366>.</span><span style=color:#f07171>set_push_constants</span><span>(
</span><span>    </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>,
</span><span>    bytemuck</span><span style=color:#ed9366>::</span><span>cast_slice(</span><span style=color:#ed9366>&</span><span>[frame_index</span><span style=color:#61676ccc>,</span><span> solari_lighting</span><span style=color:#ed9366>.</span><span>reset </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>u32</span><span>])</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span><span>pass</span><span style=color:#ed9366>.</span><span style=color:#f07171>dispatch_workgroups</span><span>(</span><span style=color:#ff8f40>LIGHT_TILE_BLOCKS </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>u32</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>1</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 世界缓存相关操作
</span><span>pass</span><span style=color:#ed9366>.</span><span style=color:#f07171>set_bind_group</span><span>(</span><span style=color:#ff8f40>2</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>bind_group_world_cache_active_cells_dispatch</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>[])</span><span style=color:#61676ccc>;
</span><span>pass</span><span style=color:#ed9366>.</span><span style=color:#f07171>set_pipeline</span><span>(decay_world_cache_pipeline)</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// ... 其他世界缓存操作
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 原来的错误顺序（被移除的代码位置）：
</span><span style=color:#abb0b6;font-style:italic>// pass.set_pipeline(presample_light_tiles_pipeline);
</span><span style=color:#abb0b6;font-style:italic>// pass.set_push_constants(
</span><span style=color:#abb0b6;font-style:italic>//     0,
</span><span style=color:#abb0b6;font-style:italic>//     bytemuck::cast_slice(&[frame_index, solari_lighting.reset as u32]),
</span><span style=color:#abb0b6;font-style:italic>// );
</span><span style=color:#abb0b6;font-style:italic>// pass.dispatch_workgroups(LIGHT_TILE_BLOCKS as u32, 1, 1);
</span></code></pre><p>这个修改确保了世界缓存更新操作能够使用当前帧生成的光照瓦片数据，而不是上一帧的过时数据。<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/getting-started/rendering/ target=_blank>Bevy Engine Rendering Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Global_illumination target=_blank>Global Illumination Concepts</a><li><a rel="noopener nofollow noreferrer" href=https://vkguide.dev/docs/gpudriven/compute_pipelines/ target=_blank>GPU Compute Pipelines and Data Dependencies</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-10/pr_21348.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>