<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21387 Fixed fog contribution for point and spotlights
        
    </title><meta content="#21387 Fixed fog contribution for point and spotlights" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-10/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-10-04</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2025-10/pr-21387-en-20251004>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=fixed-fog-contribution-for-point-and-spotlights>Fixed fog contribution for point and spotlights</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fixed fog contribution for point and spotlights<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21387<li><strong>Author</strong>: JeroenHoogers<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-10-04T20:44:47Z<li><strong>Merged</strong>: 2025-10-04T22:55:21Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h3 id=mu-biao>目标</h3><p>修复 #21327 点光源和聚光灯的体积极雾贡献与光照强度不成比例。<h3 id=jie-jue-fang-an>解决方案</h3><p>对于点光源和聚光灯，考虑 <code>exposure</code> 值以匹配定向光的实现。<h3 id=ce-shi>测试</h3><ul><li>运行更新后的 <code>volumetric_fog</code> 示例。您现在可以看到点光源和聚光灯的体积极效果现在与这些光源在房间表面的强度相匹配。</ul><hr><h3 id=zhan-shi>展示</h3><p>在原始的 <code>volumetric_fog</code> 示例中，点光源和聚光灯的强度太低，无法照亮房间，尽管它们具有非常强的体积极贡献。此更新提高了光照强度并降低了点光源和聚光灯的体积极贡献。<p>在此更改之前，<code>volumetric_fog</code> 示例中点光源和聚光灯的光照强度为10倍： <img alt=brightness_10x_on height=1126 src=https://github.com/user-attachments/assets/7562585c-bc1b-4cbf-9d52-4ffb083d65f4 width=1922><p>更改后： <img alt=brightness_10x_on_fix height=1126 src=https://github.com/user-attachments/assets/2a17fec8-0272-4c4e-9d88-d0916027a7c5 width=1922><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=wen-ti-shi-bie-yu-bei-jing>问题识别与背景</h3><p>在 Bevy 引擎的体积极雾渲染系统中，开发者发现点光源和聚光灯的体积极雾贡献存在不一致的问题。具体表现为：这些光源在体积极雾中的视觉效果与它们对场景表面的实际照明强度不匹配。问题 #21327 报告了体积极雾贡献与光照强度不成比例的情况。<p>问题的核心在于着色器计算中使用了硬编码的乘数 0.1，而没有考虑曝光（exposure）设置。这导致了体积极雾效果与场景照明的视觉不一致——点光源和聚光灯在雾中看起来过于强烈，而实际上它们对场景表面的照明却很弱。<h3 id=jie-jue-fang-an-fen-xi>解决方案分析</h3><p>开发者采用了直接且有效的修复方法：将点光源和聚光灯的体积极雾计算与定向光保持一致。具体来说，将硬编码的系数 0.1 替换为 <code>exposure</code> 变量，这样所有类型的光源都使用相同的曝光计算逻辑。<p>这个解决方案的优势在于：<ul><li>保持代码一致性：所有光源类型使用相同的计算方法<li>符合物理渲染原则：曝光设置应该影响所有光照计算<li>最小化代码变更：只修改必要的计算部分</ul><h3 id=shi-xian-xi-jie>实现细节</h3><p>在 <code>volumetric_fog.wgsl</code> 着色器中，关键修改位于光照因子计算部分。原来的实现对点光源和聚光灯使用了固定的衰减系数：<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// 修改前：
</span><span>let light_factors_per_step = fog_color * light_tint * light_attenuation *
</span><span>    scattering * density * step_size_world * light_intensity * 0.1;
</span></code></pre><p>修改后使用曝光值：<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// 修改后：
</span><span>let light_factors_per_step = fog_color * light_tint * light_attenuation *
</span><span>    scattering * density * step_size_world * light_intensity * exposure;
</span></code></pre><p>这个变更确保了体积极雾的贡献计算与场景的曝光设置保持一致，使得视觉效果更加真实。<h3 id=ji-shu-dong-cha>技术洞察</h3><p>从技术角度看，这个修复涉及了体积极渲染中的光照传输计算。在体积极介质中，光照的散射和吸收遵循特定的物理模型。使用曝光值而不是固定系数，使得计算更符合真实的物理行为：<ul><li><strong>曝光（exposure）</strong> 在渲染管线中用于模拟相机传感器对光线的敏感度<li><strong>光照强度（light_intensity）</strong> 表示光源的物理强度<li><strong>散射系数（scattering）</strong> 控制雾对光线的散射程度</ul><p>通过将固定系数替换为曝光值，系统现在能够正确处理高动态范围（HDR）渲染场景，其中不同的曝光设置会产生不同的视觉效果。<h3 id=ying-xiang-yu-diao-zheng>影响与调整</h3><p>由于修复改变了体积极雾的计算方式，开发者还需要调整示例中的光照强度值以保持视觉平衡：<ul><li>点光源强度从 1000.0 增加到 10,000.0<li>聚光灯强度从 5000.0 增加到 50,000.0</ul><p>这些调整确保了修复后的视觉效果与修复前相当，同时保持了正确的物理计算关系。从展示图片可以看出，修复后的场景中，体积极雾效果与表面照明更加协调一致。<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Volumetric Fog Shader] --> B[Light Contribution Calculation]
</span><span>    B --> C[Directional Lights]
</span><span>    B --> D[Point Lights]
</span><span>    B --> E[Spot Lights]
</span><span>    
</span><span>    C --> F[Uses exposure]
</span><span>    D --> G[Fixed 0.1 multiplier - BUG]
</span><span>    E --> G
</span><span>    
</span><span>    G --> H[Changed to use exposure - FIXED]
</span><span>    F --> I[Consistent behavior]
</span><span>    H --> I
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=1-crates-bevy-pbr-src-volumetric-fog-volumetric-fog-wgsl>1. <code>crates/bevy_pbr/src/volumetric_fog/volumetric_fog.wgsl</code></h3><p>这个文件包含了体积极雾的着色器实现。主要修改是将点光源和聚光灯的体积极雾贡献计算从使用固定乘数改为使用曝光值。<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// 关键修改：
</span><span>// 修改前：
</span><span>let light_factors_per_step = fog_color * light_tint * light_attenuation *
</span><span>    scattering * density * step_size_world * light_intensity * 0.1;
</span><span>
</span><span>// 修改后：
</span><span>let light_factors_per_step = fog_color * light_tint * light_attenuation *
</span><span>    scattering * density * step_size_world * light_intensity * exposure;
</span></code></pre><p>这个修改确保了所有类型的光源在体积极雾计算中都使用相同的曝光逻辑。<h3 id=2-examples-3d-volumetric-fog-rs>2. <code>examples/3d/volumetric_fog.rs</code></h3><p>这个示例文件进行了相应的光照强度调整，以配合着色器的修复：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 点光源强度调整：
</span><span style=color:#abb0b6;font-style:italic>// 修改前：
</span><span>intensity</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>1000.0</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 修改后：
</span><span>intensity</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>10_000.0</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 聚光灯强度调整：
</span><span style=color:#abb0b6;font-style:italic>// 修改前：
</span><span>intensity</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>5000.0</span><span style=color:#61676ccc>, </span><span style=color:#abb0b6;font-style:italic>// lumens
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 修改后：
</span><span>intensity</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>50_000.0</span><span style=color:#61676ccc>, </span><span style=color:#abb0b6;font-style:italic>// lumens
</span></code></pre><p>这些调整确保了修复后的视觉效果保持合理，同时展示了修复的正确性。<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/introduction/ target=_blank>Bevy 渲染管线文档</a><li><a rel="noopener nofollow noreferrer" href=https://gpuweb.github.io/gpuweb/wgsl/ target=_blank>WGSL 着色器语言规范</a><li><a rel="noopener nofollow noreferrer" href=https://developer.nvidia.com/gpugems/gpugems/part-vi-beyond-triangles/chapter-19-volume-rendering-techniques target=_blank>体积极渲染理论基础</a><li><a rel="noopener nofollow noreferrer" href=https://learnopengl.com/Advanced-Lighting/HDR target=_blank>物理基础渲染中的曝光控制</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-10/pr_21387.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>