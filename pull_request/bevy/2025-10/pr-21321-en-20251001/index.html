<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21321 bevy_render: improve panic message when render graph node doesn't exist
        
    </title><meta content="#21321 bevy_render: improve panic message when render graph node doesn't exist" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-10/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-10-01</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-10/pr-21321-zh-cn-20251001>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>Improving Render Graph Error Messages for Better Developer Experience<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: bevy_render: improve panic message when render graph node doesn’t exist<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21321<li><strong>Author</strong>: jakobhellermann<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, C-Usability, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-10-01T15:26:22Z<li><strong>Merged</strong>: 2025-10-01T20:09:44Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>It should be possible to enable minimal bevy features by disabling all and then progressively enabling them until everything works. This however requires, that bevy has good error reporting and gracefully supports different featuresets.<p>I ran my code with minimal features and got this unhelpful error:<pre style=color:#61676c;background-color:#fafafa><code><span>thread 'main' (993068) panicked at /home/jakob/dev/rust/bevy/crates/bevy_render/src/render_graph/graph.rs:158:26:
</span><span>InvalidNode(PostProcessing)
</span></code></pre><h2 id=solution>Solution</h2><p>With this PR it looks like this:<pre style=color:#61676c;background-color:#fafafa><code><span>thread 'main' (989393) panicked at /home/jakob/dev/rust/bevy/crates/bevy_pbr/src/wireframe.rs:136:14:
</span><span>node PostProcessing does not exist
</span></code></pre><p>Which immediately helps me figure out that I need some feature for the <code>WireframePlugin</code> I added.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a common development workflow challenge in Bevy: incrementally enabling features while maintaining clear error messages. The author encountered a practical problem when working with minimal feature sets - the render graph system was producing unhelpful panic messages that made debugging difficult.<p>The core issue was in the error reporting mechanism of the render graph system. When a render graph node didn’t exist, the system would panic with a debug-formatted error variant like <code>InvalidNode(PostProcessing)</code>. While technically accurate, this message lacked the context needed for developers to quickly understand and resolve the issue, especially when working with feature flags that conditionally include render graph nodes.<p>The solution involved two key improvements to the error handling system. First, the error formatting was changed from debug representation (<code>{:?}</code>) to display representation (<code>{}</code>), which provides a more human-readable error message. Second, the <code>#[track_caller]</code> attribute was added to relevant methods to ensure panic locations point to the actual calling code rather than the internal implementation, making it easier to trace the source of the problem.<p>The technical implementation demonstrates a common pattern in Rust error handling: leveraging the difference between <code>Display</code> and <code>Debug</code> trait implementations. The <code>RenderGraphError</code> type likely has a <code>Display</code> implementation that provides a more descriptive error message, while the <code>Debug</code> implementation shows the raw enum variant and payload. By switching from <code>panic!("{err:?}")</code> to <code>panic!("{err}")</code>, the system now uses the user-friendly display format.<p>The addition of <code>#[track_caller]</code> to three methods (<code>add_node_edges</code>, <code>add_render_graph_edges</code> for both <code>World</code> and <code>SubApp</code>) ensures that when these methods panic, the error location reported will be the caller’s location rather than the internal method implementation. This is particularly valuable in complex systems like render graphs where the same utility methods might be called from multiple places.<p>These changes significantly improve the developer experience by providing immediate, actionable information. Instead of seeing an obscure <code>InvalidNode(PostProcessing)</code> error deep in the render graph internals, developers now see a clear message “node PostProcessing does not exist” pointing directly to the code that attempted to use the missing node. This immediately guides developers to check their feature flags and dependencies.<p>The impact is most noticeable during the incremental feature development workflow described in the PR description. When starting with minimal features and gradually enabling them, developers can now quickly identify which features are missing based on the clear error messages, rather than having to trace through the codebase to understand what <code>InvalidNode</code> means in context.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Developer Code] --> B[add_render_graph_edges]
</span><span>    A --> C[add_node_edges]
</span><span>    B --> D[Render Graph System]
</span><span>    C --> D
</span><span>    D --> E{Node Exists?}
</span><span>    E -->|Yes| F[Continue Execution]
</span><span>    E -->|No| G[Panic with Clear Error Message]
</span><span>    G --> H[Developer Sees Actionable Error]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-render-src-render-graph-graph-rs-2-1><code>crates/bevy_render/src/render_graph/graph.rs</code> (+2/-1)</h3><p>This file contains the core render graph implementation where the main error message improvement was made.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>add_node_edges</span><span><</span><span style=color:#fa6e32>const</span><span> N</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize</span><span>>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>edges</span><span style=color:#61676ccc>:</span><span> impl IntoRenderNodeArray&LTN>) {
</span><span>    </span><span style=color:#fa6e32>for</span><span> window </span><span style=color:#ed9366>in</span><span> edges</span><span style=color:#ed9366>.</span><span style=color:#f07171>into_array</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>windows</span><span>(</span><span style=color:#ff8f40>2</span><span>) {
</span><span>        </span><span style=color:#fa6e32>let </span><span>[a</span><span style=color:#61676ccc>,</span><span> b] </span><span style=color:#ed9366>=</span><span> window </span><span style=color:#fa6e32>else </span><span>{
</span><span>            </span><span style=color:#f07171>unreachable!</span><span>()
</span><span>        }</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(err) </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_node_edge</span><span>(a</span><span style=color:#61676ccc>,</span><span> b) {
</span><span>            </span><span style=color:#fa6e32>match</span><span> err {
</span><span>                </span><span style=color:#abb0b6;font-style:italic>// Already existing edges are very easy to produce with this api
</span><span>                </span><span style=color:#abb0b6;font-style:italic>// and shouldn't cause a panic
</span><span>                RenderGraphError</span><span style=color:#ed9366>::</span><span>EdgeAlreadyExists(</span><span style=color:#ed9366>_</span><span>) </span><span style=color:#ed9366>=> </span><span>{}
</span><span>                </span><span style=color:#ed9366>_ => </span><span style=color:#f07171>panic!</span><span>(</span><span style=color:#86b300>"{err:?}"</span><span>)</span><span style=color:#61676ccc>,
</span><span>            }
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>track_caller</span><span>]
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>add_node_edges</span><span><</span><span style=color:#fa6e32>const</span><span> N</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize</span><span>>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>edges</span><span style=color:#61676ccc>:</span><span> impl IntoRenderNodeArray&LTN>) {
</span><span>    </span><span style=color:#fa6e32>for</span><span> window </span><span style=color:#ed9366>in</span><span> edges</span><span style=color:#ed9366>.</span><span style=color:#f07171>into_array</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>windows</span><span>(</span><span style=color:#ff8f40>2</span><span>) {
</span><span>        </span><span style=color:#fa6e32>let </span><span>[a</span><span style=color:#61676ccc>,</span><span> b] </span><span style=color:#ed9366>=</span><span> window </span><span style=color:#fa6e32>else </span><span>{
</span><span>            </span><span style=color:#f07171>unreachable!</span><span>()
</span><span>        }</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(err) </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_node_edge</span><span>(a</span><span style=color:#61676ccc>,</span><span> b) {
</span><span>            </span><span style=color:#fa6e32>match</span><span> err {
</span><span>                </span><span style=color:#abb0b6;font-style:italic>// Already existing edges are very easy to produce with this api
</span><span>                </span><span style=color:#abb0b6;font-style:italic>// and shouldn't cause a panic
</span><span>                RenderGraphError</span><span style=color:#ed9366>::</span><span>EdgeAlreadyExists(</span><span style=color:#ed9366>_</span><span>) </span><span style=color:#ed9366>=> </span><span>{}
</span><span>                </span><span style=color:#ed9366>_ => </span><span style=color:#f07171>panic!</span><span>(</span><span style=color:#86b300>"{err}"</span><span>)</span><span style=color:#61676ccc>,
</span><span>            }
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre><p>The key changes are:<ol><li>Added <code>#[track_caller]</code> attribute to improve panic location reporting<li>Changed panic format from <code>{err:?}</code> (debug) to <code>{err}</code> (display)</ol><h3 id=crates-bevy-render-src-render-graph-app-rs-2-0><code>crates/bevy_render/src/render_graph/app.rs</code> (+2/-0)</h3><p>This file contains the application-level render graph integration where caller tracking was added.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added #[track_caller] to both methods:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>track_caller</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>add_render_graph_edges</span><span><</span><span style=color:#fa6e32>const</span><span> N</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize</span><span>>(
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>,
</span><span>    </span><span style=color:#ff8f40>sub_graph</span><span style=color:#61676ccc>:</span><span> impl RenderSubGraph,
</span><span>    </span><span style=color:#ff8f40>edges</span><span style=color:#61676ccc>:</span><span> [</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>str</span><span>; N],
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut Self </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... method implementation unchanged
</span><span>}
</span></code></pre><p>The change ensures consistent caller tracking across the render graph API surface.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/std/panic/fn.set_hook.html target=_blank>Rust <code>#[track_caller]</code> attribute documentation</a><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/std/fmt/trait.Display.html target=_blank>Rust Display vs Debug formatting</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/rendering/render-graph/ target=_blank>Bevy Render Graph documentation</a><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/book/ch09-00-error-handling.html target=_blank>Error Handling in Rust</a></ul><h1 id=full-code-diff>Full Code Diff</h1><p>diff –git a/crates/bevy_render/src/render_graph/app.rs b/crates/bevy_render/src/render_graph/app.rs index fce6a13ad33e0..879f28fe54015 100644 — a/crates/bevy_render/src/render_graph/app.rs +++ b/crates/bevy_render/src/render_graph/app.rs @@ -53,6 +53,7 @@ impl RenderGraphExt for World { self }<ul><li><p>#[track_caller] fn add_render_graph_edges<const n: usize>( &mut self, sub_graph: impl RenderSubGraph, @@ -121,6 +122,7 @@ impl RenderGraphExt for SubApp { self } <li><p>#[track_caller] fn add_render_graph_edges<const n: usize>( &mut self, sub_graph: impl RenderSubGraph, diff –git a/crates/bevy_render/src/render_graph/graph.rs b/crates/bevy_render/src/render_graph/graph.rs index a7c4851d869b5..b7f8328610054 100644 — a/crates/bevy_render/src/render_graph/graph.rs +++ b/crates/bevy_render/src/render_graph/graph.rs @@ -145,6 +145,7 @@ impl RenderGraph { /// /// Defining an edge that already exists is not considered an error with this api. /// It simply won’t create a new edge. <li><p>#[track_caller] pub fn add_node_edges<const n: usize>(&mut self, edges: impl IntoRenderNodeArray<n>) { for window in edges.into_array().windows(2) { let [a, b] = window else { @@ -155,7 +156,7 @@ impl RenderGraph { // Already existing edges are very easy to produce with this api // and shouldn’t cause a panic RenderGraphError::EdgeAlreadyExists(_) => {} <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>               _ => panic!("{err:?}"),
</span></code></pre></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>               _ => panic!("{err}"),
</span><span>           }
</span><span>       }
</span><span>   }</span></code></pre></ul>    <div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-10/pr_21321.patch id=patch-info style=display:none></div>  <div class=bottom-spacer></div> 