<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21564 Fix lightmaps freeing the wrong slab on removal.
        
    </title><meta content="#21564 Fix lightmaps freeing the wrong slab on removal." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-10/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-10-16</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-10/pr-21564-zh-cn-20251016>中文</a></div></div><div class=pr-content><h1 id=fix-lightmaps-freeing-the-wrong-slab-on-removal>Fix lightmaps freeing the wrong slab on removal</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix lightmaps freeing the wrong slab on removal.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21564<li><strong>Author</strong>: andriyDev<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, D-Trivial, A-Rendering, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-10-16T20:07:01Z<li><strong>Merged</strong>: 2025-10-16T21:28:24Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Fixes #21551.<li>Fixes #20688.</ul><h2 id=solution>Solution</h2><ul><li>Insert slab_index instead of slot_index into free_slabs.</ul><h2 id=testing>Testing</h2><p>Ran the repro in #20688 and it works!<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The problem stemmed from a simple but critical indexing error in Bevy’s lightmap management system. Lightmaps in Bevy are organized using a slab allocator pattern, where multiple lightmaps are packed into texture arrays called “slabs.” Each slab contains multiple slots, and the system maintains tracking data to know which slabs have available capacity.<p>The core issue was in the <code>RenderLightmaps::remove</code> method, where when removing a lightmap from a slab, the code was incorrectly using the <code>slot_index</code> (the position within a specific slab) instead of the <code>slab_index</code> (which identifies which slab in the collection) when marking slabs as available for reuse. This meant that when a lightmap was removed, the system would mark the wrong slab as having free capacity, leading to allocation failures and rendering artifacts.<p>The fix is straightforward but crucial: change one line from inserting <code>slot_index</code> to inserting <code>slab_index</code> into the <code>free_slabs</code> collection. This ensures that when a lightmap slot becomes available, the correct slab is marked as having free capacity.<p>Additionally, the PR adds a defensive assertion in the <code>LightmapSlab::allocate</code> method to catch cases where allocation is attempted on a full slab. This assertion serves as a safety net that would have made the original bug easier to diagnose by providing a clear error message instead of silent misbehavior.<p>The impact of this fix is significant for users relying on lightmaps in their Bevy applications. Before this fix, lightmap removal could cause the rendering system to incorrectly track available capacity, leading to either failed lightmap allocations or visual artifacts where lightmaps would appear incorrectly or not at all. The bug affected multiple users, as evidenced by the two separate issues (#21551 and #20688) that this PR resolves.<p>From an engineering perspective, this fix demonstrates the importance of careful indexing in resource management systems and the value of defensive programming through assertions. The addition of the assertion in the allocate method provides an extra layer of protection that could prevent similar bugs in the future.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[RenderLightmaps.remove] --> B{Check slab capacity}
</span><span>    B -->|Not full| C[Mark slab as free]
</span><span>    B -->|Full| D[Keep slab in use]
</span><span>    
</span><span>    E[Before Fix] --> F[Used slot_index]
</span><span>    G[After Fix] --> H[Uses slab_index]
</span><span>    
</span><span>    F --> I[Wrong slab marked free]
</span><span>    H --> J[Correct slab marked free]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-pbr-src-lightmap-mod-rs-5-1><code>crates/bevy_pbr/src/lightmap/mod.rs</code> (+5/-1)</h3><p>This file contains the core lightmap management logic in Bevy’s physically-based rendering system. The changes fix the slab indexing bug and add a defensive assertion.<p><strong>Key modifications:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>slab</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_full</span><span>() {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>free_slabs</span><span style=color:#ed9366>.</span><span style=color:#f07171>grow_and_insert</span><span>(slot_index</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>())</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>slab</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_full</span><span>() {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>free_slabs</span><span style=color:#ed9366>.</span><span style=color:#f07171>grow_and_insert</span><span>(slab_index</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>())</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>The critical change replaces <code>slot_index.into()</code> with <code>slab_index.into()</code>, ensuring the correct slab is marked as having available capacity.<p>Additionally, a new assertion was added to prevent allocation on full slabs:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#f07171>assert!</span><span>(
</span><span>    </span><span style=color:#ed9366>!</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_full</span><span>()</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#86b300>"Attempting to allocate on a full lightmap slab"
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><p>This assertion provides immediate feedback if the system attempts an invalid allocation, making debugging easier and preventing silent failures.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_pbr/latest/bevy_pbr/lightmap/index.html target=_blank>Bevy Lightmap Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Slab_allocation target=_blank>Slab Allocator Pattern</a><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/std/macro.assert.html target=_blank>Rust Assertions</a><li><a rel="noopener nofollow noreferrer" href=https://www.khronos.org/opengl/wiki/Array_Texture target=_blank>Texture Arrays in Graphics Programming</a></ul><h1 id=full-code-diff>Full Code Diff</h1><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_pbr/src/lightmap/mod.rs b/crates/bevy_pbr/src/lightmap/mod.rs
</span><span>index f4adb94738c48..a05d3ebd12db7 100644
</span><span style=color:#c594c5>--- a/crates/bevy_pbr/src/lightmap/mod.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_pbr/src/lightmap/mod.rs
</span><span style=color:#c594c5>@@ -388,7 +388,7 @@ </span><span style=color:#399ee6>impl RenderLightmaps {
</span><span>         slab.remove(fallback_images, slot_index);
</span><span> 
</span><span>         if !slab.is_full() {
</span><span style=color:#f07171>-            self.free_slabs.grow_and_insert(slot_index.into());
</span><span style=color:#86b300>+            self.free_slabs.grow_and_insert(slab_index.into());
</span><span>         }
</span><span>     }
</span><span> }
</span><span style=color:#c594c5>@@ -417,6 +417,10 @@ </span><span style=color:#399ee6>impl LightmapSlab {
</span><span>     }
</span><span> 
</span><span>     fn allocate(&mut self, image_id: AssetId&LTImage>) -> LightmapSlotIndex {
</span><span style=color:#86b300>+        assert!(
</span><span style=color:#86b300>+            !self.is_full(),
</span><span style=color:#86b300>+            "Attempting to allocate on a full lightmap slab"
</span><span style=color:#86b300>+        );
</span><span>         let index = LightmapSlotIndex::from(self.free_slots_bitmask.trailing_zeros());
</span><span>         self.free_slots_bitmask &= !(1 << u32::from(index));
</span><span>         self.lightmaps[usize::from(index)].asset_id = Some(image_id);
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-10/pr_21564.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>