<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #20825 Configure ureq to use platform-verifier for web assets
        
    </title><meta content="#20825 Configure ureq to use platform-verifier for web assets" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-10/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-10-25</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-10/pr-20825-zh-cn-20251025>中文</a></div></div><div class=pr-content><h1 id=configure-ureq-to-use-platform-verifier-for-web-assets>Configure ureq to use platform-verifier for web assets</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Configure ureq to use platform-verifier for web assets<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/20825<li><strong>Author</strong>: jf908<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Assets, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-09-02T11:08:09Z<li><strong>Merged</strong>: 2025-10-25T08:14:56Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Fixes #20803<li>See issue for motivations on this change</ul><h2 id=solution>Solution</h2><ul><li>Use ureq’s <code>platform-verifier</code> feature and enable it in the agent config.</ul><p>I’ve gone the simple route and made this non-configurable, for now at least.<p>The downside of this change is that you can longer use webpki-roots but if bevy only supports one certificate verification method then I think platform-verifier is the more sensible option.<h2 id=testing>Testing</h2><ul><li>Tested the web_asset example on Windows and macOS</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a certificate verification issue that was preventing Bevy from loading web assets over HTTPS in certain environments. The problem stemmed from how the ureq HTTP client was configured to validate SSL certificates when fetching assets from web servers.<p>The core issue was that Bevy’s web asset loader used ureq with its default certificate verification setup, which relies on <code>webpki-roots</code> - a set of root certificates bundled with the application. This approach has limitations because it doesn’t automatically pick up system-wide certificate updates or include custom certificates that users might have installed on their systems.<p>The solution implemented here takes a more robust approach by switching to ureq’s <code>platform-verifier</code> feature. This feature delegates certificate validation to the operating system’s native certificate store, which provides several advantages:<ol><li><strong>Automatic updates</strong>: System certificate updates are automatically applied without requiring Bevy updates<li><strong>Custom certificates</strong>: Any custom certificates installed in the system store are automatically recognized<li><strong>Platform consistency</strong>: Certificate validation behaves consistently with other applications on the same system</ol><p>The implementation required changes in two key areas. First, the Cargo.toml dependency configuration needed to enable the new feature. Second, the HTTP agent configuration in the web asset loader needed to be updated to use the platform verifier.<p>One important engineering consideration was the trade-off between configurability and simplicity. The author explicitly chose to make this non-configurable for now, recognizing that having a single, well-tested certificate verification method is preferable to maintaining multiple configurations. This decision reduces complexity and ensures consistent behavior across all Bevy applications.<p>The changes were tested on both Windows and macOS to verify that the platform verifier works correctly across different operating systems. This cross-platform testing was crucial since the platform verifier relies on OS-specific certificate stores.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Web Asset Request] --> B[HTTP Agent]
</span><span>    B --> C[Platform Certificate Verifier]
</span><span>    C --> D[System Certificate Store]
</span><span>    C --> E[HTTPS Server]
</span><span>    E --> F[Asset Data]
</span><span>    
</span><span>    G[ureq Library] --> B
</span><span>    H[bevy_asset Web Module] --> G
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-asset-cargo-toml><code>crates/bevy_asset/Cargo.toml</code></h3><p>This file was modified to add the <code>platform-verifier</code> feature to ureq when the <code>https</code> feature is enabled.<pre class=language-toml data-lang=toml style=color:#61676c;background-color:#fafafa><code class=language-toml data-lang=toml><span style=color:#abb0b6;font-style:italic># Before:
</span><span style=color:#399ee6>https </span><span>= [</span><span style=color:#86b300>"blocking"</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"ureq"</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"ureq/rustls"</span><span>]
</span><span>
</span><span style=color:#abb0b6;font-style:italic># After:  
</span><span style=color:#399ee6>https </span><span>= [</span><span style=color:#86b300>"blocking"</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"ureq"</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"ureq/rustls"</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"ureq/platform-verifier"</span><span>]
</span></code></pre><p>This change ensures that when Bevy is compiled with HTTPS support, it includes ureq’s platform certificate verification capabilities.<h3 id=crates-bevy-asset-src-io-web-rs><code>crates/bevy_asset/src/io/web.rs</code></h3><p>The main implementation change was in the HTTP agent configuration, where the TLS configuration was updated to use the platform certificate verifier.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>static </span><span style=color:#ff8f40>AGENT</span><span style=color:#61676ccc>: </span><span>LazyLock&LTAgent> </span><span style=color:#ed9366>= </span><span>LazyLock</span><span style=color:#ed9366>::</span><span>new(|| Agent</span><span style=color:#ed9366>::</span><span>config_builder()</span><span style=color:#ed9366>.</span><span style=color:#f07171>build</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>new_agent</span><span>())</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>static </span><span style=color:#ff8f40>AGENT</span><span style=color:#61676ccc>: </span><span>LazyLock&LTAgent> </span><span style=color:#ed9366>= </span><span>LazyLock</span><span style=color:#ed9366>::</span><span>new(|| {
</span><span>    Agent</span><span style=color:#ed9366>::</span><span>config_builder()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>tls_config</span><span>(
</span><span>            TlsConfig</span><span style=color:#ed9366>::</span><span>builder()
</span><span>                </span><span style=color:#ed9366>.</span><span style=color:#f07171>root_certs</span><span>(RootCerts</span><span style=color:#ed9366>::</span><span>PlatformVerifier)
</span><span>                </span><span style=color:#ed9366>.</span><span style=color:#f07171>build</span><span>()</span><span style=color:#61676ccc>,
</span><span>        )
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>build</span><span>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>new_agent</span><span>()
</span><span>})</span><span style=color:#61676ccc>;
</span></code></pre><p>The key addition is the <code>.tls_config()</code> call that explicitly configures ureq to use <code>RootCerts::PlatformVerifier</code> instead of the default certificate store. This change ensures that all HTTPS requests made by the web asset loader will validate certificates against the system’s certificate store.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/ureq/latest/ureq/struct.TlsConfig.html target=_blank>ureq TLS Configuration Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/rustls/latest/rustls/struct.ClientConfig.html target=_blank>Rust TLS Certificate Verification Patterns</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/books/assets/ target=_blank>Bevy Asset System Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Certificate_store target=_blank>Platform Certificate Stores Overview</a></ul><h1 id=full-code-diff>Full Code Diff</h1><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_asset/Cargo.toml b/crates/bevy_asset/Cargo.toml
</span><span>index b4797dd4c8a7d..7c3c25cf29b68 100644
</span><span style=color:#c594c5>--- a/crates/bevy_asset/Cargo.toml
</span><span style=color:#c594c5>+++ b/crates/bevy_asset/Cargo.toml
</span><span style=color:#c594c5>@@ -15,7 +15,7 @@ </span><span style=color:#399ee6>file_watcher = ["notify-debouncer-full", "watch", "multi_threaded"]
</span><span> embedded_watcher = ["file_watcher"]
</span><span> multi_threaded = ["bevy_tasks/multi_threaded"]
</span><span> http = ["blocking", "ureq"]
</span><span style=color:#f07171>-https = ["blocking", "ureq", "ureq/rustls"]
</span><span style=color:#86b300>+https = ["blocking", "ureq", "ureq/rustls", "ureq/platform-verifier"]
</span><span> web_asset_cache = []
</span><span> asset_processor = []
</span><span> watch = []
</span><span>diff --git a/crates/bevy_asset/src/io/web.rs b/crates/bevy_asset/src/io/web.rs
</span><span>index 20aaafd20e8c7..15a684dadbc6a 100644
</span><span style=color:#c594c5>--- a/crates/bevy_asset/src/io/web.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_asset/src/io/web.rs
</span><span style=color:#c594c5>@@ -138,9 +138,19 @@ </span><span style=color:#399ee6>async fn get(path: PathBuf) -> Result&LTBox&LTdyn Reader>, AssetReaderError> {
</span><span>     if let Some(data) = web_asset_cache::try_load_from_cache(str_path).await? {
</span><span>         return Ok(Box::new(VecReader::new(data)));
</span><span>     }
</span><span style=color:#86b300>+    use ureq::tls::{RootCerts, TlsConfig};
</span><span>     use ureq::Agent;
</span><span> 
</span><span style=color:#f07171>-    static AGENT: LazyLock&LTAgent> = LazyLock::new(|| Agent::config_builder().build().new_agent());
</span><span style=color:#86b300>+    static AGENT: LazyLock&LTAgent> = LazyLock::new(|| {
</span><span style=color:#86b300>+        Agent::config_builder()
</span><span style=color:#86b300>+            .tls_config(
</span><span style=color:#86b300>+                TlsConfig::builder()
</span><span style=color:#86b300>+                    .root_certs(RootCerts::PlatformVerifier)
</span><span style=color:#86b300>+                    .build(),
</span><span style=color:#86b300>+            )
</span><span style=color:#86b300>+            .build()
</span><span style=color:#86b300>+            .new_agent()
</span><span style=color:#86b300>+    });
</span><span> 
</span><span>     let uri = str_path.to_owned();
</span><span>     // Use [`unblock`] to run the http request on a separately spawned thread as to not block bevy's
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-10/pr_20825.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>