<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21508 Improve Frustum struct readability
        
    </title><meta content="#21508 Improve Frustum struct readability" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-10/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-10-29</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-10/pr-21508-zh-cn-20251029>中文</a></div></div><div class=pr-content><h1 id=improve-frustum-struct-readability>Improve Frustum struct readability</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Improve Frustum struct readability<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21508<li><strong>Author</strong>: Breakdown-Dog<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: D-Trivial, C-Code-Quality, S-Ready-For-Final-Review, A-Camera<li><strong>Created</strong>: 2025-10-11T14:00:52Z<li><strong>Merged</strong>: 2025-10-29T19:31:18Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>This PR refactors the Frustum struct to improve code readability and maintainability by replacing magic numbers with named constants and unrolling a loop for clarity.</ul><h2 id=testing>Testing</h2><ul><li>I ran the command ‘cargo test –package bevy_camera –lib – primitives::tests –show-output’ and all the test are passed.</ul><hr><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a common code quality issue in the Bevy engine’s frustum implementation: the use of hard-coded indices and complex loop logic that made the code difficult to understand and maintain. The changes focus on improving readability through straightforward refactoring techniques.<p>The core problem was that the <code>Frustum</code> struct used magic numbers like <code>4</code> and <code>5</code> to represent specific plane indices (near and far planes) throughout the codebase. These magic numbers appeared in multiple methods including <code>from_clip_from_world</code>, <code>intersects_sphere</code>, and <code>intersects_aabb</code>. When reading the code, developers had to mentally track what each index represented, which increased cognitive load and made the code more error-prone during modifications.<p>The solution approach was systematic and practical. The developer introduced named constants to replace the magic numbers:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub const </span><span style=color:#ff8f40>NEAR_PLANE_IDX</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>4</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>const </span><span style=color:#ff8f40>FAR_PLANE_IDX</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>5</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>const </span><span style=color:#ff8f40>INACTIVE_HALF_SPACE</span><span style=color:#61676ccc>:</span><span> Vec4 </span><span style=color:#ed9366>= </span><span>Vec4</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ff8f40>0.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.0</span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>f32</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>INFINITY</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><p>These constants immediately clarify the purpose of each index. For example, instead of seeing <code>half_spaces[5]</code>, developers now see <code>half_spaces[Self::FAR_PLANE_IDX]</code>, which is self-documenting.<p>One of the most significant changes was in the <code>from_clip_from_world_no_far</code> method, where a complex loop with conditional logic was replaced with explicit array construction:<p><strong>Before:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let mut</span><span> half_spaces </span><span style=color:#ed9366>= </span><span>[HalfSpace</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>; </span><span style=color:#ff8f40>6</span><span>]</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>for </span><span>(i</span><span style=color:#61676ccc>,</span><span> half_space) </span><span style=color:#ed9366>in</span><span> half_spaces</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter_mut</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>enumerate</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>take</span><span>(</span><span style=color:#ff8f40>5</span><span>) {
</span><span>    </span><span style=color:#fa6e32>let</span><span> row </span><span style=color:#ed9366>=</span><span> clip_from_world</span><span style=color:#ed9366>.</span><span style=color:#f07171>row</span><span>(i </span><span style=color:#ed9366>/ </span><span style=color:#ff8f40>2</span><span>)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#ed9366>*</span><span>half_space </span><span style=color:#ed9366>= </span><span>HalfSpace</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#fa6e32>if </span><span>(i </span><span style=color:#ed9366>& </span><span style=color:#ff8f40>1</span><span>) </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0 </span><span style=color:#ed9366>&&</span><span> i </span><span style=color:#ed9366>!= </span><span style=color:#ff8f40>4 </span><span>{
</span><span>        row3 </span><span style=color:#ed9366>+</span><span> row
</span><span>    } </span><span style=color:#fa6e32>else </span><span>{
</span><span>        row3 </span><span style=color:#ed9366>-</span><span> row
</span><span>    })</span><span style=color:#61676ccc>;
</span><span>}
</span><span>half_spaces[</span><span style=color:#ff8f40>5</span><span>] </span><span style=color:#ed9366>= </span><span>HalfSpace</span><span style=color:#ed9366>::</span><span>new(Vec4</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ff8f40>0.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.0</span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>f32</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>MAX</span><span>))</span><span style=color:#61676ccc>;
</span></code></pre><p><strong>After:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>Self </span><span>{
</span><span>    half_spaces</span><span style=color:#61676ccc>: </span><span>[
</span><span>        HalfSpace</span><span style=color:#ed9366>::</span><span>new(row3 </span><span style=color:#ed9366>+</span><span> row0)</span><span style=color:#61676ccc>,
</span><span>        HalfSpace</span><span style=color:#ed9366>::</span><span>new(row3 </span><span style=color:#ed9366>-</span><span> row0)</span><span style=color:#61676ccc>,
</span><span>        HalfSpace</span><span style=color:#ed9366>::</span><span>new(row3 </span><span style=color:#ed9366>+</span><span> row1)</span><span style=color:#61676ccc>,
</span><span>        HalfSpace</span><span style=color:#ed9366>::</span><span>new(row3 </span><span style=color:#ed9366>-</span><span> row1)</span><span style=color:#61676ccc>,
</span><span>        HalfSpace</span><span style=color:#ed9366>::</span><span>new(row3 </span><span style=color:#ed9366>+</span><span> row2)</span><span style=color:#61676ccc>,
</span><span>        HalfSpace</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>INACTIVE_HALF_SPACE</span><span>)</span><span style=color:#61676ccc>,
</span><span>    ]</span><span style=color:#61676ccc>,
</span><span>}
</span></code></pre><p>This unrolled loop is much easier to understand because it clearly shows how each plane is constructed from the matrix rows. The relationship between the matrix components and the resulting frustum planes becomes immediately apparent.<p>The changes also improved the <code>intersects_aabb</code> method by combining two separate condition checks into a single, more readable condition:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>if </span><span>(idx </span><span style=color:#ed9366>== </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>NEAR_PLANE_IDX </span><span style=color:#ed9366>&& !</span><span>intersect_near)
</span><span>    </span><span style=color:#ed9366>|| </span><span>(idx </span><span style=color:#ed9366>== </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>FAR_PLANE_IDX </span><span style=color:#ed9366>&& !</span><span>intersect_far)
</span><span>{
</span><span>    </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>This consolidation makes the skip logic more explicit and reduces the chance of missing one of the conditions during future modifications.<p>The impact of these changes is primarily on code maintainability. The refactored code is easier to read, understand, and modify. The use of named constants reduces the risk of off-by-one errors when working with plane indices, and the explicit array construction eliminates the mental overhead of deciphering complex loop logic.<p>From a technical perspective, these changes don’t affect performance since they’re primarily syntactic improvements that compile to the same machine code. The constants are resolved at compile time, and the unrolled loop produces identical instructions to the original loop.<p>The changes also demonstrate good software engineering practices by making the code more self-documenting and reducing the reliance on comments to explain what specific numerical values represent.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Frustum Struct] --> B[Plane Indices]
</span><span>    B --> C[NEAR_PLANE_IDX: 4]
</span><span>    B --> D[FAR_PLANE_IDX: 5]
</span><span>    A --> E[Construction Methods]
</span><span>    E --> F[from_clip_from_world]
</span><span>    E --> G[from_clip_from_world_no_far]
</span><span>    E --> H[from_view_projection_custom_far_plane]
</span><span>    A --> I[Intersection Tests]
</span><span>    I --> J[intersects_sphere]
</span><span>    I --> K[intersects_aabb]
</span><span>    L[bevy_pbr light.rs] --> M[prepare_lights]
</span><span>    M --> C
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-camera-src-primitives-rs-29-18><code>crates/bevy_camera/src/primitives.rs</code> (+29/-18)</h3><p>This file contains the core frustum implementation changes. The modifications replace magic numbers with named constants and simplify complex loop logic.<p><strong>Key changes:</strong><ul><li>Added named constants for plane indices<li>Replaced loop with explicit array construction<li>Improved condition checks in intersection methods</ul><p><strong>Code examples:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>frustum</span><span style=color:#ed9366>.</span><span>half_spaces[</span><span style=color:#ff8f40>5</span><span>] </span><span style=color:#ed9366>= </span><span>HalfSpace</span><span style=color:#ed9366>::</span><span>new(clip_from_world</span><span style=color:#ed9366>.</span><span style=color:#f07171>row</span><span>(</span><span style=color:#ff8f40>2</span><span>))</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>frustum</span><span style=color:#ed9366>.</span><span>half_spaces[</span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>FAR_PLANE_IDX</span><span>] </span><span style=color:#ed9366>= </span><span>HalfSpace</span><span style=color:#ed9366>::</span><span>new(clip_from_world</span><span style=color:#ed9366>.</span><span style=color:#f07171>row</span><span>(</span><span style=color:#ff8f40>2</span><span>))</span><span style=color:#61676ccc>;
</span></code></pre><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> max </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>if</span><span> intersect_far { </span><span style=color:#ff8f40>6 </span><span>} </span><span style=color:#fa6e32>else </span><span>{ </span><span style=color:#ff8f40>5 </span><span>}</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>for</span><span> half_space </span><span style=color:#ed9366>in &</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>half_spaces[</span><span style=color:#ed9366>..</span><span>max] {
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> max </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>if</span><span> intersect_far {
</span><span>    </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>FAR_PLANE_IDX
</span><span>} </span><span style=color:#fa6e32>else </span><span>{
</span><span>    </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>NEAR_PLANE_IDX
</span><span>}</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>for</span><span> half_space </span><span style=color:#ed9366>in &</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>half_spaces[</span><span style=color:#ed9366>..=</span><span>max] {
</span></code></pre><h3 id=crates-bevy-pbr-src-render-light-rs-5-2><code>crates/bevy_pbr/src/render/light.rs</code> (+5/-2)</h3><p>This file was updated to use the new named constant from the Frustum struct, ensuring consistency across the codebase.<p><strong>Code example:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>frustum</span><span style=color:#ed9366>.</span><span>half_spaces[</span><span style=color:#ff8f40>4</span><span>] </span><span style=color:#ed9366>=
</span><span>    HalfSpace</span><span style=color:#ed9366>::</span><span>new(frustum</span><span style=color:#ed9366>.</span><span>half_spaces[</span><span style=color:#ff8f40>4</span><span>]</span><span style=color:#ed9366>.</span><span style=color:#f07171>normal</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend</span><span>(</span><span style=color:#fa6e32>f32</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>INFINITY</span><span>))</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>frustum</span><span style=color:#ed9366>.</span><span>half_spaces[Frustum</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>NEAR_PLANE_IDX</span><span>] </span><span style=color:#ed9366>= </span><span>HalfSpace</span><span style=color:#ed9366>::</span><span>new(
</span><span>    frustum</span><span style=color:#ed9366>.</span><span>half_spaces[Frustum</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>NEAR_PLANE_IDX</span><span>]
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>normal</span><span>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>extend</span><span>(</span><span style=color:#fa6e32>f32</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>INFINITY</span><span>)</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/getting-started/camera/ target=_blank>Bevy Engine Documentation on Cameras and Projection</a><li><a rel="noopener nofollow noreferrer" href=https://learnopengl.com/Guest-Articles/2021/Scene/Frustum-Culling target=_blank>Frustum Culling Techniques</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/rust-lang/rfcs/blob/master/style-guide/README.md target=_blank>Rust Code Style Guidelines</a><li><a rel="noopener nofollow noreferrer" href=https://refactoring.guru/replace-magic-number-with-symbolic-constant target=_blank>Magic Numbers in Software Development</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-10/pr_21508.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>