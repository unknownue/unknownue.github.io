<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21566 Add tests to document three separate asset issues.
        
    </title><meta content="#21566 Add tests to document three separate asset issues." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-10/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-10-17</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-10/pr-21566-zh-cn-20251017>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>Add tests to document three separate asset issues<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Add tests to document three separate asset issues.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21566<li><strong>Author</strong>: andriyDev<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Assets, S-Ready-For-Final-Review, C-Testing, D-Straightforward<li><strong>Created</strong>: 2025-10-16T21:11:01Z<li><strong>Merged</strong>: 2025-10-17T00:41:17Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Add tests “showing off” the problems with #20651, #12756, and #21564.</ul><h2 id=solution>Solution</h2><ul><li>Added some tests!</ul><h2 id=testing>Testing</h2><ul><li>Yes</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a common problem in software development: documenting known bugs with failing tests. Rather than fixing the underlying issues, the developer created three comprehensive test cases that reproduce specific asset system problems, serving as both documentation and validation targets for future fixes.<p>The developer identified three distinct asset-related issues that needed proper test coverage:<ol><li><strong>Issue #21564</strong>: The asset system fails to distinguish between the same asset loaded with different loader settings<li><strong>Issue #12756</strong>: Loading multiple subassets from the same source file triggers duplicate load operations<li><strong>Issue #20651</strong>: Asset reloading occurs even when strong handles keep assets alive</ol><p>Each test follows a similar pattern: create a minimal reproduction scenario, implement custom asset loaders with specific behaviors, and assert the current broken behavior while documenting what the correct behavior should be. This approach ensures that when the underlying issues are fixed, the tests will fail and can be updated to verify the correct implementation.<p>The implementation demonstrates several key engineering practices. Each test is self-contained with custom asset types and loaders, avoiding dependencies on existing asset types. The tests use the existing test infrastructure like <code>MemoryAssetReader</code> and <code>Dir</code> to simulate file systems without actual I/O operations. Most importantly, the tests include detailed comments explaining both the current broken behavior and the expected correct behavior, making them valuable documentation.<p>For the first test, <code>same_asset_different_settings</code>, the developer created a <code>U8Asset</code> that stores a single byte value derived from loader settings. This simple design clearly demonstrates the problem: when loading the same asset file with different settings (values 1 and 2), the system should produce two distinct assets but currently produces identical ones.<p>The second test, <code>loading_two_subassets_does_not_start_two_loads</code>, uses a loader that creates two labeled subassets from a single file. The test verifies that only one load operation should be initiated, but currently two occur due to the bug.<p>The third test, <code>get_strong_handle_prevents_reload_when_asset_still_alive</code>, demonstrates that creating a strong handle should prevent asset reloading when the original handle is dropped, but currently the system incorrectly initiates a new load.<p>These tests serve multiple purposes: they document the exact conditions under which the bugs occur, provide reproducible test cases for developers working on fixes, and will automatically validate when the underlying issues are resolved. The approach of writing tests that expect broken behavior with clear comments about the intended behavior is a practical strategy for tracking known issues in a codebase.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Test Infrastructure] --> B[same_asset_different_settings]
</span><span>    A --> C[loading_two_subassets_does_not_start_two_loads]
</span><span>    A --> D[get_strong_handle_prevents_reload_when_asset_still_alive]
</span><span>    
</span><span>    B --> E[U8Asset & U8Loader]
</span><span>    C --> F[TwoSubassetLoader]
</span><span>    D --> G[TrivialLoader]
</span><span>    
</span><span>    E --> H[Issue #21564]
</span><span>    F --> I[Issue #12756]
</span><span>    G --> J[Issue #20651]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-asset-src-lib-rs-227-0><code>crates/bevy_asset/src/lib.rs</code> (+227/-0)</h3><p>This file contains all three new test cases added to document the asset system issues.<p><strong>Test 1: Same Asset with Different Settings</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>same_asset_different_settings</span><span>() {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Test loading the same asset twice with different settings. This should
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// produce two distinct assets.
</span><span>
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Asset</span><span style=color:#61676ccc>,</span><span> TypePath)]
</span><span>    </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>U8Asset</span><span>(</span><span style=color:#fa6e32>u8</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Serialize</span><span style=color:#61676ccc>,</span><span> Deserialize</span><span style=color:#61676ccc>,</span><span> Default)]
</span><span>    </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>U8LoaderSettings</span><span>(</span><span style=color:#fa6e32>u8</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>U8Loader</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#fa6e32>impl </span><span>AssetLoader </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>U8Loader </span><span>{
</span><span>        </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Asset </span><span style=color:#ed9366>=</span><span> U8Asset</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Settings </span><span style=color:#ed9366>=</span><span> U8LoaderSettings</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Error </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>crate</span><span style=color:#ed9366>::</span><span>loader</span><span style=color:#ed9366>::</span><span>LoadDirectError</span><span style=color:#61676ccc>;
</span><span>
</span><span>        async </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>load</span><span>(
</span><span>            </span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>,
</span><span>            </span><span style=color:#ed9366>_</span><span>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> dyn Reader,
</span><span>            </span><span style=color:#ff8f40>settings</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Settings,
</span><span>            </span><span style=color:#ed9366>_</span><span>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span>LoadContext<'</span><span style=color:#ed9366>_</span><span>>,
</span><span>        ) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><</span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Asset, </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Error> {
</span><span>            </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(U8Asset(settings</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0</span><span>))
</span><span>        }
</span><span>
</span><span>        </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>extensions</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span>[</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>str</span><span>] {
</span><span>            </span><span style=color:#ed9366>&</span><span>[</span><span style=color:#86b300>"u8"</span><span>]
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... test setup and assertions
</span><span>}
</span></code></pre><p><strong>Test 2: Multiple Subassets Loading</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>loading_two_subassets_does_not_start_two_loads</span><span>() {
</span><span>    </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>TwoSubassetLoader</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#fa6e32>impl </span><span>AssetLoader </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>TwoSubassetLoader </span><span>{
</span><span>        </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Asset </span><span style=color:#ed9366>=</span><span> TestAsset</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Settings </span><span style=color:#ed9366>= </span><span>()</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Error </span><span style=color:#ed9366>= </span><span>std</span><span style=color:#ed9366>::</span><span>io</span><span style=color:#ed9366>::</span><span>Error</span><span style=color:#61676ccc>;
</span><span>
</span><span>        async </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>load</span><span>(
</span><span>            </span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>,
</span><span>            </span><span style=color:#ff8f40>_reader</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> dyn Reader,
</span><span>            </span><span style=color:#ff8f40>_settings</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Settings,
</span><span>            </span><span style=color:#ff8f40>load_context</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span>LoadContext<'</span><span style=color:#ed9366>_</span><span>>,
</span><span>        ) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><</span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Asset, </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Error> {
</span><span>            load_context</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_labeled_asset</span><span>(</span><span style=color:#86b300>"A"</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()</span><span style=color:#61676ccc>,</span><span> TestAsset)</span><span style=color:#61676ccc>;
</span><span>            load_context</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_labeled_asset</span><span>(</span><span style=color:#86b300>"B"</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()</span><span style=color:#61676ccc>,</span><span> TestAsset)</span><span style=color:#61676ccc>;
</span><span>            </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(TestAsset)
</span><span>        }
</span><span>
</span><span>        </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>extensions</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span>[</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>str</span><span>] {
</span><span>            </span><span style=color:#ed9366>&</span><span>[</span><span style=color:#86b300>"txt"</span><span>]
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... test setup and assertions
</span><span>}
</span></code></pre><p><strong>Test 3: Strong Handle Prevention</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>get_strong_handle_prevents_reload_when_asset_still_alive</span><span>() {
</span><span>    </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>TrivialLoader</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#fa6e32>impl </span><span>AssetLoader </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>TrivialLoader </span><span>{
</span><span>        </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Asset </span><span style=color:#ed9366>=</span><span> TestAsset</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Settings </span><span style=color:#ed9366>= </span><span>()</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Error </span><span style=color:#ed9366>= </span><span>std</span><span style=color:#ed9366>::</span><span>io</span><span style=color:#ed9366>::</span><span>Error</span><span style=color:#61676ccc>;
</span><span>
</span><span>        async </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>load</span><span>(
</span><span>            </span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>,
</span><span>            </span><span style=color:#ff8f40>_reader</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> dyn Reader,
</span><span>            </span><span style=color:#ff8f40>_settings</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Settings,
</span><span>            </span><span style=color:#ff8f40>_load_context</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span>LoadContext<'</span><span style=color:#ed9366>_</span><span>>,
</span><span>        ) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><</span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Asset, </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>Error> {
</span><span>            </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(TestAsset)
</span><span>        }
</span><span>
</span><span>        </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>extensions</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span>[</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>str</span><span>] {
</span><span>            </span><span style=color:#ed9366>&</span><span>[</span><span style=color:#86b300>"txt"</span><span>]
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... test setup and assertions
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/assets/ target=_blank>Bevy Asset System Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/book/ch11-00-testing.html target=_blank>Rust Testing Guide</a><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Test-driven_development target=_blank>Test-Driven Development (TDD) Principles</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/features/ecs/ target=_blank>Bevy ECS and Asset Management</a></ul><h1 id=full-code-diff>Full Code Diff</h1><p>diff –git a/crates/bevy_asset/src/lib.rs b/crates/bevy_asset/src/lib.rs index 2a185c50f5a15..92ff7a9b22941 100644 — a/crates/bevy_asset/src/lib.rs +++ b/crates/bevy_asset/src/lib.rs @@ -3258,4 +3258,231 @@ mod tests { // This assertion exists to “prove” that this problem exists. assert!(processed_dir.get_asset(gltfx_path).is_none()); } +<ul><li>#[test]<li>fn same_asset_different_settings() {<li><pre style=color:#61676c;background-color:#fafafa><code><span>   // Test loading the same asset twice with different settings. This should
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   // produce two distinct assets.
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   // First, implement an asset that's a single u8, whose value is copied from
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   // the loader settings.
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   #[derive(Asset, TypePath)]
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   struct U8Asset(u8);
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   #[derive(Serialize, Deserialize, Default)]
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   struct U8LoaderSettings(u8);
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   struct U8Loader;
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   impl AssetLoader for U8Loader {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       type Asset = U8Asset;
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       type Settings = U8LoaderSettings;
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       type Error = crate::loader::LoadDirectError;
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>       async fn load(
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           &self,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           _: &mut dyn Reader,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           settings: &Self::Settings,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           _: &mut LoadContext<'_>,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       ) -> Result&LTSelf::Asset, Self::Error> {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           Ok(U8Asset(settings.0))
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       }
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>       fn extensions(&self) -> &[&str] {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           &["u8"]
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       }
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   }
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   // Create a test asset.
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   let dir = Dir::default();
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   dir.insert_asset(Path::new("test.u8"), &[]);
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   let asset_source = AssetSource::build()
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       .with_reader(move || Box::new(MemoryAssetReader { root: dir.clone() }));
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   // Set up the app.
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   let mut app = App::new();
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   app.register_asset_source(AssetSourceId::Default, asset_source)
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       .add_plugins((TaskPoolPlugin::default(), AssetPlugin::default()))
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       .init_asset::&LTU8Asset>()
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       .register_asset_loader(U8Loader);
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   let asset_server = app.world().resource::&LTAssetServer>();
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   // Load the test asset twice but with different settings.
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   fn load(asset_server: &AssetServer, path: &'static str, value: u8) -> Handle&LTU8Asset> {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       asset_server.load_with_settings::&LTU8Asset, U8LoaderSettings>(
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           path,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           move |s: &mut U8LoaderSettings| s.0 = value,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       )
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   }
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   let handle_1 = load(asset_server, "test.u8", 1);
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   let handle_2 = load(asset_server, "test.u8", 2);
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   // Handles should be different.
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   // These handles should be different, but due to
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   // https://github.com/bevyengine/bevy/pull/21564, they are not. Once 21564 is fixed, we
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   // should replace these expects.
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   //
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   // assert_ne!(handle_1, handle_2);
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   assert_eq!(handle_1, handle_2);
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   run_app_until(&mut app, |world| {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       let (Some(asset_1), Some(asset_2)) = (
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           world.resource::&LTAssets&LTU8Asset>>().get(&handle_1),
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           world.resource::&LTAssets&LTU8Asset>>().get(&handle_2),
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       ) else {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           return None;
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       };
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>       // Values should match the settings.
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>       // These values should be different, but due to
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       // https://github.com/bevyengine/bevy/pull/21564, they are not. Once 21564 is fixed, we
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       // should replace these expects.
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       //
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       // assert_eq!(asset_1.0, 1);
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       // assert_eq!(asset_2.0, 2);
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       assert_eq!(asset_1.0, asset_2.0);
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>       Some(())
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   });
</span></code></pre><li>}<li><li>#[test]<li>fn loading_two_subassets_does_not_start_two_loads() {<li><pre style=color:#61676c;background-color:#fafafa><code><span>   let mut app = App::new();
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   let dir = Dir::default();
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   dir.insert_asset(Path::new("test.txt"), &[]);
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   let asset_source = AssetSource::build()
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       .with_reader(move || Box::new(MemoryAssetReader { root: dir.clone() }));
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   app.register_asset_source(AssetSourceId::Default, asset_source)
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       .add_plugins((TaskPoolPlugin::default(), AssetPlugin::default()))
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       .init_asset::&LTTestAsset>();
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   struct TwoSubassetLoader;
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   impl AssetLoader for TwoSubassetLoader {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       type Asset = TestAsset;
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       type Settings = ();
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       type Error = std::io::Error;
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>       async fn load(
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           &self,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           _reader: &mut dyn Reader,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           _settings: &Self::Settings,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           load_context: &mut LoadContext<'_>,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       ) -> Result&LTSelf::Asset, Self::Error> {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           load_context.add_labeled_asset("A".into(), TestAsset);
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           load_context.add_labeled_asset("B".into(), TestAsset);
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           Ok(TestAsset)
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       }
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>       fn extensions(&self) -> &[&str] {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           &["txt"]
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       }
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   }
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   app.register_asset_loader(TwoSubassetLoader);
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   let asset_server = app.world().resource::&LTAssetServer>().clone();
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   let _subasset_1: Handle&LTTestAsset> = asset_server.load("test.txt#A");
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   let _subasset_2: Handle&LTTestAsset> = asset_server.load("test.txt#B");
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   app.update();
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   // Due to https://github.com/bevyengine/bevy/issues/12756, this expectation fails. Once
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   // #12756 is fixed, we should swap these asserts.
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   //
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   // assert_eq!(get_started_load_count(app.world()), 1);
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   assert_eq!(get_started_load_count(app.world()), 2);
</span></code></pre><li>}<li><li>#[test]<li>fn get_strong_handle_prevents_reload_when_asset_still_alive() {<li><pre style=color:#61676c;background-color:#fafafa><code><span>   let mut app = App::new();
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   let dir = Dir::default();
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   dir.insert_asset(Path::new("test.txt"), &[]);
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   let asset_source = AssetSource::build()
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       .with_reader(move || Box::new(MemoryAssetReader { root: dir.clone() }));
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   app.register_asset_source(AssetSourceId::Default, asset_source)
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       .add_plugins((TaskPoolPlugin::default(), AssetPlugin::default()))
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       .init_asset::&LTTestAsset>();
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   struct TrivialLoader;
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   impl AssetLoader for TrivialLoader {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       type Asset = TestAsset;
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       type Settings = ();
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       type Error = std::io::Error;
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>       async fn load(
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           &self,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           _reader: &mut dyn Reader,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           _settings: &Self::Settings,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           _load_context: &mut LoadContext<'_>,
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       ) -> Result&LTSelf::Asset, Self::Error> {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           Ok(TestAsset)
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       }
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>       fn extensions(&self) -> &[&str] {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           &["txt"]
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       }
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   }
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   app.register_asset_loader(TrivialLoader);
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   let asset_server = app.world().resource::&LTAssetServer>().clone();
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   let original_handle: Handle&LTTestAsset> = asset_server.load("test.txt");
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   // Wait for the asset to load.
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   run_app_until(&mut app, |world| {
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       world
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           .resource::&LTAssets&LTTestAsset>>()
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           .get(&original_handle)
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>           .map(|_| ())
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   });
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   assert_eq!(get_started_load_count(app.world()), 1);
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   // Get a new strong handle from the original handle's ID.
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   let new_handle = app
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       .world_mut()
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       .resource_mut::&LTAssets&LTTestAsset>>()
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       .get_strong_handle(original_handle.id())
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       .unwrap();
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   // Drop the original handle. This should still leave the asset alive.
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   drop(original_handle);
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   app.update();
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   assert!(app
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       .world()
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       .resource::&LTAssets&LTTestAsset>>()
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       .get(&new_handle)
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       .is_some());
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   let _other_handle: Handle&LTTestAsset> = asset_server.load("test.txt");
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   app.update();
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   // The asset server should **not** have started a new load, since the asset is still alive.
</span></code></pre><li><li><pre style=color:#61676c;background-color:#fafafa><code><span>   // Due to https://github.com/bevyengine/bevy/issues/20651, we do get a second load. Once
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   // #20651 is fixed, we should swap these asserts.
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   //
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   // assert_eq!(get_started_load_count(app.world()), 1);
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   assert_eq!(get_started_load_count(app.world()), 2);
</span></code></pre><li>} }</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-10/pr_21566.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>