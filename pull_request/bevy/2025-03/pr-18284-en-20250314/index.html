<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18284 bevy_reflect: Deprecate `PartialReflect::clone_value`
        
    </title><meta content="#18284 bevy_reflect: Deprecate `PartialReflect::clone_value`" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-03/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-03-14</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span></div></div><div class=pr-content><h1 id=18284-bevy-reflect-deprecate-partialreflect-clone-value>#18284 bevy_reflect: Deprecate <code>PartialReflect::clone_value</code></h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: bevy_reflect: Deprecate <code>PartialReflect::clone_value</code><li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18284<li><strong>Author</strong>: MrGVSV<li><strong>Status</strong>: MERGED<li><strong>Created</strong>: 2025-03-12T22:13:26Z<li><strong>Merged</strong>: Not merged<li><strong>Merged By</strong>: N/A</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>#13432 added proper reflection-based cloning. This is a better method than cloning via <code>clone_value</code> for reasons detailed in the description of that PR. However, it may not be immediately apparent to users why one should be used over the other, and what the gotchas of <code>clone_value</code> are.<h2 id=solution>Solution</h2><p>This PR marks <code>PartialReflect::clone_value</code> as deprecated, with the deprecation notice pointing users to <code>PartialReflect::reflect_clone</code>. However, it also suggests using a new method introduced in this PR: <code>PartialReflect::to_dynamic</code>.<p><code>PartialReflect::to_dynamic</code> is essentially a renaming of <code>PartialReflect::clone_value</code>. By naming it <code>to_dynamic</code>, we make it very obvious that what’s returned is a dynamic type. The one caveat to this is that opaque types still use <code>reflect_clone</code> as they have no corresponding dynamic type.<p>Along with changing the name, the method is now optional, and comes with a default implementation that calls out to the respective reflection subtrait method. This was done because there was really no reason to require manual implementors provide a method that almost always calls out to a known set of methods.<p>Lastly, to make this default implementation work, this PR also did a similar thing with the <code>clone_dynamic </code> methods on the reflection subtraits. For example, <code>Struct::clone_dynamic</code> has been marked deprecated and is superseded by <code>Struct::to_dynamic_struct</code>. This was necessary to avoid the “multiple names in scope” issue.<h3 id=open-questions>Open Questions</h3><p>This PR maintains the original signature of <code>clone_value</code> on <code>to_dynamic</code>. That is, it takes <code>&self</code> and returns <code>Box&LTdyn PartialReflect></code>.<p>However, in order for this to work, it introduces a panic if the value is opaque and doesn’t override the default <code>reflect_clone</code> implementation.<p>One thing we could do to avoid the panic would be to make the conversion fallible, either returning <code>Option&LTBox&LTdyn PartialReflect>></code> or <code>Result&LTBox&LTdyn PartialReflect>, ReflectCloneError></code>.<p>This makes using the method a little more involved (i.e. users have to either unwrap or handle the rare possibility of an error), but it would set us up for a world where opaque types don’t strictly need to be <code>Clone</code>. Right now this bound is sort of implied by the fact that <code>clone_value</code> is a required trait method, and the default behavior of the macro is to use <code>Clone</code> for opaque types.<p>Alternatively, we could keep the signature but make the method required. This maintains that implied bound where manual implementors must provide some way of cloning the value (or YOLO it and just panic), but also makes the API simpler to use.<p>Finally, we could just leave it with the panic. It’s unlikely this would occur in practice since our macro still requires <code>Clone</code> for opaque types, and thus this would only ever be an issue if someone were to manually implement <code>PartialReflect</code> without a valid <code>to_dynamic</code> or <code>reflect_clone</code> method.<h2 id=testing>Testing</h2><p>You can test locally using the following command:<pre style=color:#61676c;background-color:#fafafa><code><span>cargo test --package bevy_reflect --all-features
</span></code></pre><hr><h2 id=migration-guide>Migration Guide</h2><p><code>PartialReflect::clone_value</code> is being deprecated. Instead, use <code>PartialReflect::to_dynamic</code> if wanting to create a new dynamic instance of the reflected value. Alternatively, use <code>PartialReflect::reflect_clone</code> to attempt to create a true clone of the underlying value.<p>Similarly, the following methods have been deprecated and should be replaced with these alternatives:<ul><li><code>Array::clone_dynamic</code> → <code>Array::to_dynamic_array</code><li><code>Enum::clone_dynamic</code> → <code>Enum::to_dynamic_enum</code><li><code>List::clone_dynamic</code> → <code>List::to_dynamic_list</code><li><code>Map::clone_dynamic</code> → <code>Map::to_dynamic_map</code><li><code>Set::clone_dynamic</code> → <code>Set::to_dynamic_set</code><li><code>Struct::clone_dynamic</code> → <code>Struct::to_dynamic_struct</code><li><code>Tuple::clone_dynamic</code> → <code>Tuple::to_dynamic_tuple</code><li><code>TupleStruct::clone_dynamic</code> → <code>TupleStruct::to_dynamic_tuple_struct</code></ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The reflection system in Bevy needed clearer cloning semantics after PR #13432 introduced <code>reflect_clone</code>. While the new method provided proper reflection-aware cloning, the existing <code>clone_value</code> method remained ambiguous in purpose and potentially misleading in its name. This PR addresses that confusion through strategic deprecation and renaming.<p>The core issue stemmed from <code>clone_value</code> returning a dynamic type (<code>Box&LTdyn PartialReflect></code>) while its name suggested simple value cloning. This could lead developers to misuse it as a general cloning mechanism rather than understanding its specific role in dynamic type creation. The solution required three key changes:<ol><li><p><strong>Semantic Renaming</strong>: <code>clone_value</code> became <code>to_dynamic</code> to explicitly communicate its purpose of creating dynamic type instances. This aligns with Rust’s naming conventions where <code>to_*</code> methods typically imply conversions:</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>deprecated </span><span style=color:#ed9366>= </span><span style=color:#86b300>"use `to_dynamic` instead"</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>clone_value</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Box</span><span>&LTdyn PartialReflect> {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_dynamic</span><span>()
</span><span>}
</span></code></pre><li><p><strong>Optional Trait Methods</strong>: The PR made <code>to_dynamic</code> optional in the <code>PartialReflect</code> trait with a default implementation calling <code>reflect_clone</code>. This reduced boilerplate for implementors while maintaining backward compatibility:</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>fn </span><span style=color:#f29718>to_dynamic</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Box</span><span>&LTdyn PartialReflect> {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>reflect_clone</span><span>()
</span><span>}
</span></code></pre><li><p><strong>Subtrait Method Alignment</strong>: Related methods like <code>Struct::clone_dynamic</code> were renamed to <code>to_dynamic_struct</code> to maintain naming consistency across the reflection hierarchy. This prevented method name collisions and improved API discoverability.</p></ol><p>The implementation carefully balanced API stability with clarity. By keeping the original method signatures but marking them deprecated, the changes allow gradual migration while immediately improving documentation and method names. The panic introduced for opaque types without <code>reflect_clone</code> implementations was deemed acceptable given Bevy’s macro system enforces <code>Clone</code> for such types through derive macros.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[PartialReflect] --> B[clone_value: deprecated]
</span><span>    A --> C[to_dynamic: new preferred]
</span><span>    A --> D[reflect_clone: true cloning]
</span><span>    B --> E[Dynamic types]
</span><span>    C --> E
</span><span>    D --> F[Concrete types]
</span><span>    E --> G[Reflection subtraits]
</span><span>    G --> H[to_dynamic_* methods]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ol><li><p><strong><code>crates/bevy_reflect/src/reflect.rs</code></strong></p> <ul><li>Added <code>to_dynamic</code> trait method with default implementation<li>Deprecated <code>clone_value</code> with automatic forwarding<li>Updated documentation to emphasize dynamic type creation</ul><li><p><strong><code>crates/bevy_reflect/src/impls/std.rs</code></strong></p> <ul><li>Removed redundant <code>clone_value</code> implementations<li>Updated collection types to use new <code>to_dynamic_*</code> methods</ul> <p>Before:</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>impl</span><span>&LTT</span><span style=color:#61676ccc>:</span><span> PartialReflect> PartialReflect </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>Vec</span><span>&LTT> {
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>clone_value</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Box</span><span>&LTdyn PartialReflect> {
</span><span>        </span><span style=color:#55b4d4;font-style:italic>Box</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone_dynamic</span><span>())
</span><span>    }
</span><span>}
</span></code></pre> <p>After:</p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>impl</span><span>&LTT</span><span style=color:#61676ccc>:</span><span> PartialReflect> PartialReflect </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>Vec</span><span>&LTT> {
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>to_dynamic</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Box</span><span>&LTdyn PartialReflect> {
</span><span>        </span><span style=color:#55b4d4;font-style:italic>Box</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_dynamic_list</span><span>())
</span><span>    }
</span><span>}
</span></code></pre><li><p><strong><code>crates/bevy_ecs/src/entity/clone_entities.rs</code></strong></p> <ul><li>Updated entity cloning to use <code>reflect_clone</code> instead of deprecated methods<li>Ensured proper deep cloning of reflected components</ul></ol><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/pull/13432 target=_blank>PR #13432</a> - Original reflection cloning implementation<li><a rel="noopener nofollow noreferrer" href=https://rust-lang.github.io/api-guidelines/naming.html target=_blank>Rust API Guidelines: Naming</a> - Rationale for <code>to_*</code> method naming<li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_reflect/latest/bevy_reflect/ target=_blank>Bevy Reflection Documentation</a> - Core reflection concepts<li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/reference/attributes/diagnostics.html#the-deprecated-attribute target=_blank>Rust Deprecation Attributes</a> - Proper deprecation practices</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-03/pr_18284.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>