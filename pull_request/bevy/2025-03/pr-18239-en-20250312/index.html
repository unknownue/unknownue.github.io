<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18239 Upgrade to cosmic-text 0.13
        
    </title><meta content="#18239 Upgrade to cosmic-text 0.13" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-03/>‚Üê Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-03-12</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-03/pr-18239-zh-cn-20250312>‰∏≠Êñá</a></div></div><div class=pr-content><h1 id=18239-upgrade-to-cosmic-text-0-13>#18239 Upgrade to cosmic-text 0.13</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Upgrade to cosmic-text 0.13<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18239<li><strong>Author</strong>: rparrett<li><strong>Status</strong>: MERGED<li><strong>Created</strong>: 2025-03-10T20:05:22Z<li><strong>Merged</strong>: Not merged<li><strong>Merged By</strong>: N/A</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Upgrade to <code>cosmic-text</code> 0.13<p>https://github.com/pop-os/cosmic-text/releases<p>This should include some performance improvements for layout and system font loading.<h2 id=solution>Solution</h2><p>Bump version, fix the one changed API.<h2 id=testing>Testing</h2><p>Tested some examples locally, will invoke the example runner.<h2 id=layout-perf>Layout Perf</h2><table><thead><tr><th><th>main fps<th>cosmic-13 fps<tbody><tr><td>many_buttons ‚Äìrecompute-text ‚Äìno-borders<td>6.79<td>9.42 üü© +38.7%<tr><td>many_text2d ‚Äìno-frustum-culling ‚Äìrecompute<td>3.19<td>4.28 üü© +34.0%<tr><td>many_glyphs ‚Äìrecompute-text<td>7.09<td>11.17 üü© +57.6%<tr><td>text_pipeline<td>140.15<td>139.90 ‚¨ú -0.2%</table><h2 id=system-font-loading-perf>System Font Loading Perf</h2><p>I tested on macOS somewhat lazily by adding the following system to the <code>system_fonts</code> example from #16365.<details><summary>Expand code</summary> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>fn </span><span style=color:#f29718>exit_on_load</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>reader</span><span style=color:#61676ccc>: </span><span>EventReader&LTbevy</span><span style=color:#ed9366>::</span><span>text</span><span style=color:#ed9366>::</span><span>SystemFontsAvailable>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>writer</span><span style=color:#61676ccc>: </span><span>EventWriter&LTAppExit>,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>for</span><span> _evt </span><span style=color:#ed9366>in</span><span> reader</span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>() {
</span><span>        writer</span><span style=color:#ed9366>.</span><span style=color:#f07171>write</span><span>(AppExit</span><span style=color:#ed9366>::</span><span>Success)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre></details><p>And running:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>cargo build </span><span style=color:#ed9366>--</span><span>release </span><span style=color:#ed9366>--</span><span>example system_fonts </span><span style=color:#ed9366>--</span><span>features</span><span style=color:#ed9366>=</span><span>system_font
</span><span>hyperfine target</span><span style=color:#ed9366>/</span><span>release</span><span style=color:#ed9366>/</span><span>examples</span><span style=color:#ed9366>/</span><span>system_fonts 
</span></code></pre><p>And there was seemingly no change.<details><summary>Expand results</summary> <p>Before</p> <pre style=color:#61676c;background-color:#fafafa><code><span>Benchmark 1: target/release/examples/system_fonts
</span><span>  Time (mean ¬± œÉ):     258.0 ms ¬±  14.2 ms    [User: 136.2 ms, System: 95.8 ms]
</span><span>  Range (min ‚Ä¶ max):   245.9 ms ‚Ä¶ 294.0 ms    10 runs
</span></code></pre> <p>After</p> <pre style=color:#61676c;background-color:#fafafa><code><span>Benchmark 1: target/release/examples/system_fonts
</span><span>  Time (mean ¬± œÉ):     261.9 ms ¬±   8.9 ms    [User: 141.8 ms, System: 95.5 ms]
</span><span>  Range (min ‚Ä¶ max):   252.3 ms ‚Ä¶ 281.4 ms    10 runs
</span></code></pre></details><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The PR addresses a routine but impactful dependency upgrade in Bevy‚Äôs text rendering system. The core objective was straightforward: update the <code>cosmic-text</code> library from version 0.12 to 0.13 to leverage its advertised performance improvements in text layout and font loading.<p><strong>The Upgrade Challenge</strong><br> <code>cosmic-text</code> 0.13 introduced API changes that required adjustments in Bevy‚Äôs text pipeline. The primary technical constraint was maintaining backward compatibility while adopting the new version‚Äôs improvements. The author needed to verify that the upgrade wouldn‚Äôt introduce regressions in text rendering or system font handling.<p><strong>Implementation Strategy</strong><br> The solution involved two key changes:<ol><li>Version bump in <code>Cargo.toml</code>:</ol><pre class=language-toml data-lang=toml style=color:#61676c;background-color:#fafafa><code class=language-toml data-lang=toml><span style=color:#399ee6>cosmic-text </span><span>= </span><span style=color:#86b300>"0.13"
</span></code></pre><ol start=2><li>Adaptation to API changes in the text pipeline‚Äôs font system initialization:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: 0.12 syntax
</span><span style=color:#fa6e32>let</span><span> font_system </span><span style=color:#ed9366>= </span><span>FontSystem</span><span style=color:#ed9366>::</span><span>new_with_fonts(fonts)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: 0.13 syntax
</span><span style=color:#fa6e32>let</span><span> font_system </span><span style=color:#ed9366>= </span><span>FontSystem</span><span style=color:#ed9366>::</span><span>new_with_locale_and_db(
</span><span>    locale</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_string</span><span>()</span><span style=color:#61676ccc>,
</span><span>    FontSystem</span><span style=color:#ed9366>::</span><span>font_db()</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><p><strong>Performance Validation</strong><br> The author conducted rigorous benchmarking across multiple scenarios:<ul><li>Layout-intensive examples showed dramatic improvements (up to 57.6% FPS increase)<li>Text pipeline microbenchmarks remained stable<li>System font loading on macOS showed negligible difference</ul><p>This selective performance impact aligns with <code>cosmic-text</code>‚Äôs release notes that emphasized layout optimizations rather than font loading changes.<p><strong>Tradeoffs and Considerations</strong><br> The minimal code changes suggest:<ol><li>The API changes were backward-compatible in most cases<li>Bevy‚Äôs text abstraction layer successfully insulated most systems from upstream changes<li>Focused testing on areas most likely to be affected by layout improvements</ol><h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[cosmic-text 0.13] --> B[Text Layout System]
</span><span>    B --> C[many_buttons Example]
</span><span>    B --> D[many_glyphs Example]
</span><span>    B --> E[text_pipeline Benchmarks]
</span><span>    A --> F[Font System]
</span><span>    F --> G[system_fonts Example]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ol><li><code>crates/bevy_text/Cargo.toml</code></ol><pre class=language-toml data-lang=toml style=color:#61676c;background-color:#fafafa><code class=language-toml data-lang=toml><span style=color:#abb0b6;font-style:italic># Before:
</span><span style=color:#399ee6>cosmic-text </span><span>= </span><span style=color:#86b300>"0.12"
</span><span>
</span><span style=color:#abb0b6;font-style:italic># After:
</span><span style=color:#399ee6>cosmic-text </span><span>= </span><span style=color:#86b300>"0.13"
</span></code></pre><ul><li>Direct dependency version bump to access new features and optimizations</ul><ol start=2><li><code>crates/bevy_text/src/pipeline.rs</code></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before (hypothetical based on context):
</span><span style=color:#fa6e32>let</span><span> font_system </span><span style=color:#ed9366>= </span><span>FontSystem</span><span style=color:#ed9366>::</span><span>new_with_fonts(fonts)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> font_system </span><span style=color:#ed9366>= </span><span>FontSystem</span><span style=color:#ed9366>::</span><span>new_with_locale_and_db(
</span><span>    locale</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_string</span><span>()</span><span style=color:#61676ccc>,
</span><span>    FontSystem</span><span style=color:#ed9366>::</span><span>font_db()</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><ul><li>Adapts to cosmic-text‚Äôs updated FontSystem initialization API<li>Maintains locale handling while using the default font database</ul><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://github.com/pop-os/cosmic-text/releases/tag/v0.13.0 target=_blank>cosmic-text 0.13 Release Notes</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_text/latest/bevy_text/ target=_blank>Bevy Text System Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/cargo/reference/managing-dependencies.html target=_blank>Rust Dependency Management Best Practices</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-03/pr_18239.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>