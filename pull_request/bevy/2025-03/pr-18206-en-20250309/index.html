<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18206
        
    </title><meta content=#18206 property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-03/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-03-09</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-03/pr-18206-zh-cn-20250309>中文</a></div></div><div class=pr-content><h1 id=18206-improve-segment2d-segment3d-api-and-docs>#18206 Improve <code>Segment2d</code>/<code>Segment3d</code> API and docs</h1><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=from-minimal-to-mighty-empowering-bevy-s-geometric-primitives>From Minimal to Mighty: Empowering Bevy’s Geometric Primitives</h3><p>The journey of this PR begins with a paradox of progress - the recent rework of <code>Segment2d</code> and <code>Segment3d</code> in #17404 had modernized their internal representation but left them functionally underdeveloped. Like a newly constructed bridge with no entry ramps, these geometric primitives needed better access points and safety features for developers.<p><strong>The Catalyst</strong><br> While working with collision detection and spatial queries, developers found themselves constantly reconstructing basic segment properties that should have been readily available. The existing API forced redundant calculations for fundamental attributes like direction vectors and lengths. Documentation inconsistencies further complicated matters, making the types feel like unfinished prototypes rather than production-ready primitives.<p><strong>The Vision</strong><br> The solution emerged as a threefold mission:<ol><li>Complete the transition from direction+length to endpoint-based representation<li>Add essential geometric operations mirroring real-world use cases<li>Create intuitive conversion pathways matching Rust’s idiomatic patterns</ol><h3 id=building-the-toolbox>Building the Toolbox</h3><p>The implementation strategy focused on ergonomics and mathematical completeness. Let’s examine key additions through the lens of practical geometry problems:<p><strong>Problem 1: “I have a ray and need a specific length segment”</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// New constructor pattern
</span><span style=color:#fa6e32>let</span><span> ray </span><span style=color:#ed9366>= </span><span>Ray2d</span><span style=color:#ed9366>::</span><span>new(Vec2</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ZERO</span><span style=color:#61676ccc>, </span><span>Vec2</span><span style=color:#ed9366>::</span><span>X)</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> segment </span><span style=color:#ed9366>= </span><span>Segment2d</span><span style=color:#ed9366>::</span><span>from_ray_and_length(</span><span style=color:#ed9366>&</span><span>ray</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>5.0</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><p><strong>Problem 2: “I need to handle degenerate segments safely”</strong><br> The <code>try_direction</code> method gracefully handles zero-length segments:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>impl </span><span style=color:#399ee6>Segment3d </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>try_direction</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTVec3> {
</span><span>        </span><span style=color:#fa6e32>let</span><span> direction </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>direction</span><span>()</span><span style=color:#61676ccc>;
</span><span>        (direction </span><span style=color:#ed9366>!= </span><span>Vec3</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ZERO</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>then_some</span><span>(direction)
</span><span>    }
</span><span>}
</span></code></pre><p><strong>3D Transformation Harmony</strong><br> The <code>transformed</code> method bridges segments with Bevy’s transform system:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>segment</span><span style=color:#ed9366>.</span><span style=color:#f07171>transformed</span><span>(</span><span style=color:#ed9366>&</span><span>Transform</span><span style=color:#ed9366>::</span><span>from_translation(Vec3</span><span style=color:#ed9366>::</span><span>Y))</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=the-2d-advantage>The 2D Advantage</h3><p>Recognizing planar geometry’s unique needs, the PR adds specialized normals handling:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Computing perpendicular directions
</span><span style=color:#fa6e32>let</span><span> left_normal </span><span style=color:#ed9366>=</span><span> segment</span><span style=color:#ed9366>.</span><span style=color:#f07171>scaled_left_normal</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>normalize</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> right_normal </span><span style=color:#ed9366>=</span><span> segment</span><span style=color:#ed9366>.</span><span style=color:#f07171>scaled_right_normal</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>normalize</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><p>These additions enable immediate use in collision response calculations without manual vector mathematics.<h3 id=conversion-pathways>Conversion Pathways</h3><p>The <code>From</code> implementations create natural interoperability:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Array to Segment2d
</span><span style=color:#fa6e32>let</span><span> points </span><span style=color:#ed9366>= </span><span>[Vec2</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ZERO</span><span style=color:#61676ccc>, </span><span>Vec2</span><span style=color:#ed9366>::</span><span>X]</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> segment</span><span style=color:#61676ccc>:</span><span> Segment2d </span><span style=color:#ed9366>=</span><span> points</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><p>This pattern aligns with Rust’s collection idioms, reducing friction when working with existing point data.<h3 id=documentation-renaissance>Documentation Renaissance</h3><p>The documentation overhaul serves as a silent hero - transforming sparse comments into guided tutorials. Each method now includes:<ul><li>Clear mathematical definitions<li>Panic conditions<li>Example use cases<li>Cross-references to related operations</ul><h3 id=the-ripple-effect>The Ripple Effect</h3><p>These changes propagate through Bevy’s ecosystem:<ol><li><strong>Gizmos</strong> benefit from simplified segment rendering<li><strong>Collision detection</strong> systems gain precision through normalized directions<li><strong>Transform hierarchies</strong> can now manipulate segments directly</ol><p>The 185-line diff in <code>dim2.rs</code> and 123-line diff in <code>dim3.rs</code> tell a story of thoughtful API design - each new method filling a specific gap in geometric manipulation capabilities.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    S[Segment2d/Segment3d] --> C[Constructors]
</span><span>    S --> O[Geometric Operations]
</span><span>    S --> T[Transformations]
</span><span>    C --> F[from_scaled_direction]
</span><span>    C --> R[from_ray_and_length]
</span><span>    O --> D[direction/try_direction]
</span><span>    O --> L[length_squared]
</span><span>    T --> M[transformed]
</span><span>    T --> V[reversed]
</span><span>    S --> N[2D Normals]
</span><span>    N --> LN[left_normal]
</span><span>    N --> RN[right_normal]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ol><li><strong>crates/bevy_math/src/primitives/dim2.rs</strong><br> Added 2D-specific normal calculations and conversion traits:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// From implementation example
</span><span style=color:#fa6e32>impl </span><span style=color:#55b4d4;font-style:italic>From</span><span><[Vec2</span><span style=color:#61676ccc>; </span><span style=color:#ff8f40>2</span><span>]> </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>Segment2d </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>from</span><span>(</span><span style=color:#ff8f40>points</span><span style=color:#61676ccc>:</span><span> [Vec2; 2]) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>        </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>new(points[</span><span style=color:#ff8f40>0</span><span>]</span><span style=color:#61676ccc>,</span><span> points[</span><span style=color:#ff8f40>1</span><span>])
</span><span>    }
</span><span>}
</span></code></pre><ol start=2><li><strong>crates/bevy_math/src/primitives/dim3.rs</strong><br> Enhanced 3D operations with transformation support:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>transformed</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>transform</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>Transform) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>    </span><span style=color:#fa6e32>Self </span><span>{
</span><span>        start</span><span style=color:#61676ccc>:</span><span> transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>transform_point</span><span>(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>start)</span><span style=color:#61676ccc>,
</span><span>        end</span><span style=color:#61676ccc>:</span><span> transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>transform_point</span><span>(</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>end)</span><span style=color:#61676ccc>,
</span><span>    }
</span><span>}
</span></code></pre><ol start=3><li><strong>crates/bevy_gizmos/src/primitives/dim3.rs</strong><br> Updated gizmo rendering to leverage new API:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: manual direction calculation
</span><span style=color:#abb0b6;font-style:italic>// After: using built-in direction()
</span><span style=color:#fa6e32>let</span><span> direction </span><span style=color:#ed9366>=</span><span> segment</span><span style=color:#ed9366>.</span><span style=color:#f07171>direction</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>normalize</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/parry2d/latest/parry2d/shape/struct.Segment.html target=_blank>Parry Physics Engine Segment Documentation</a> - Inspiration source for geometric operations<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/getting-started/transforms/ target=_blank>Bevy Transform System</a> - Context for <code>transformed</code> method usage<li><a rel="noopener nofollow noreferrer" href=https://arxiv.org/abs/1205.5935 target=_blank>Geometric Algebra Primer</a> - Mathematical foundation for segment operations</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-03/pr_18206.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>