<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18578 Required Components: pass through all tokens in {} and () syntax
        
    </title><meta content="#18578 Required Components: pass through all tokens in {} and () syntax" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-03/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-03-27</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-03/pr-18578-zh-cn-20250327>中文</a></div></div><div class=pr-content><h1 id=18578-required-components-pass-through-all-tokens-in-and-syntax>#18578 Required Components: pass through all tokens in {} and () syntax</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Required Components: pass through all tokens in {} and () syntax<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18578<li><strong>Author</strong>: cart<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: <code>C-Bug</code>, <code>A-ECS</code>, <code>C-Usability</code>, <code>S-Ready-For-Final-Review</code><li><strong>Created</strong>: 2025-03-27T19:17:58Z<li><strong>Merged</strong>: 2025-03-28T09:14:22Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>#18555 added improved require syntax, but inline structs didn’t support <code>..Default::default()</code> syntax (for technical reasons we can’t parse the struct directly, so there is manual logic that missed this case).<h2 id=solution>Solution</h2><p>When a <code>{}</code> or <code>()</code> section is encountered for a required component, rather than trying to parse the fields directly, just pass <em>all</em> of the tokens through. This ensures no tokens are dropped, protects us against any future syntax changes, and optimizes our parsing logic (as we’re dropping the field parsing logic entirely).<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The PR addresses a limitation in Bevy’s ECS component requirement syntax that emerged after previous improvements to the system. While #18555 enhanced require syntax capabilities, it introduced an edge case where struct initialization patterns using <code>..Default::default()</code> weren’t properly handled due to limitations in the macro parsing logic.<p>The root issue stemmed from the macro’s attempt to parse struct fields directly, which couldn’t account for the spread operator (<code>..</code>) in struct initialization. This led to syntax tokens being dropped during parsing, breaking valid Rust patterns that users might reasonably expect to work.<p>The solution pivoted from field-level parsing to a more robust token-passing approach. When encountering braces <code>{}</code> or parentheses <code>()</code>, the macro now forwards all contained tokens without inspection. This achieves three key benefits:<ol><li><strong>Syntax Preservation</strong>: Ensures no tokens are lost during macro expansion<li><strong>Future Compatibility</strong>: Accommodates potential Rust syntax changes<li><strong>Simplified Maintenance</strong>: Reduces parser complexity by eliminating field-specific logic</ol><p>In the macro implementation, this translated to replacing targeted field parsing with direct token capture. For example:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Attempted field-by-field parsing
</span><span style=color:#fa6e32>let</span><span> fields </span><span style=color:#ed9366>=</span><span> input</span><span style=color:#ed9366>.</span><span>parse</span><span style=color:#ed9366>::</span><span>&LTFields>()</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Direct token capture
</span><span style=color:#fa6e32>let</span><span> content</span><span style=color:#61676ccc>;
</span><span style=color:#f07171>braced!</span><span>(content </span><span style=color:#ed9366>in</span><span> input)</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> tokens </span><span style=color:#ed9366>=</span><span> content</span><span style=color:#ed9366>.</span><span>parse</span><span style=color:#ed9366>::</span><span>&LTTokenStream2>()</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span></code></pre><p>This change affected the core parsing logic in <code>bevy_ecs/macros/src/component.rs</code>, where component requirements are processed. By letting Rust’s own compiler handle the final syntax validation, the implementation becomes both more reliable and less maintenance-heavy.<p>The PR also included test updates to verify the new behavior with various syntax patterns, ensuring cases like <code>MyComponent { ..Default::default() }</code> now work as expected. These tests validate both struct and tuple struct initialization patterns.<p>From an architectural perspective, this change aligns with Rust’s macro philosophy of deferring detailed syntax validation to the compiler where possible. The Bevy ECS system benefits from reduced maintenance burden while gaining more flexible component initialization syntax.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[User Input Syntax] --> B{Macro Parser}
</span><span>    B -->|Braces {}| C[Token Stream Capture]
</span><span>    B -->|Parentheses ()| C
</span><span>    C --> D[Compiler Validation]
</span><span>    D --> E[Valid Component Initialization]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=file-crates-bevy-ecs-macros-src-component-rs>File: <code>crates/bevy_ecs/macros/src/component.rs</code></h3><p><strong>Changes</strong>: Modified component attribute parsing to handle brace/paren blocks as token streams<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Field-specific parsing
</span><span style=color:#fa6e32>let</span><span> fields </span><span style=color:#ed9366>=</span><span> input</span><span style=color:#ed9366>.</span><span>parse</span><span style=color:#ed9366>::</span><span>&LTFields>()</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> member </span><span style=color:#ed9366>= </span><span style=color:#f07171>parse_member</span><span>(field</span><span style=color:#ed9366>.</span><span>ident</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_ref</span><span>())</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Full token capture
</span><span style=color:#fa6e32>let</span><span> content</span><span style=color:#61676ccc>;
</span><span style=color:#f07171>braced!</span><span>(content </span><span style=color:#ed9366>in</span><span> input)</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> tokens </span><span style=color:#ed9366>=</span><span> content</span><span style=color:#ed9366>.</span><span>parse</span><span style=color:#ed9366>::</span><span>&LTTokenStream2>()</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span><span style=color:#f07171>quote! </span><span>{ </span><span style=color:#ed9366>#</span><span>tokens }
</span></code></pre><h3 id=file-crates-bevy-ecs-src-component-rs>File: <code>crates/bevy_ecs/src/component.rs</code></h3><p><strong>Changes</strong>: Updated tests to verify new syntax support<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added test case
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>required_component_with_default</span><span>() {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> world </span><span style=color:#ed9366>= </span><span>World</span><span style=color:#ed9366>::</span><span>new()</span><span style=color:#61676ccc>;
</span><span>    world</span><span style=color:#ed9366>.</span><span>init_component</span><span style=color:#ed9366>::</span><span>&LTMyComponent>()</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// This syntax would previously fail
</span><span>    world</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity_mut</span><span>(entities[</span><span style=color:#ff8f40>0</span><span>])
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(MyComponent { </span><span style=color:#ed9366>..</span><span style=color:#55b4d4;font-style:italic>Default</span><span style=color:#ed9366>::</span><span>default() })</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/reference/macros.html target=_blank>Rust Macro Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/ecs/components/ target=_blank>Bevy ECS Component System Guide</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/pull/18555 target=_blank>Previous PR #18555</a> - Original require syntax improvements</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-03/pr_18578.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>