<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18644 0.16 Regression fix: re-expose the display handle via a wrapper resource
        
    </title><meta content="#18644 0.16 Regression fix: re-expose the display handle via a wrapper resource" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-03/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-03-31</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-03/pr-18644-zh-cn-20250331>中文</a></div></div><div class=pr-content><h1 id=18644-0-16-regression-fix-re-expose-the-display-handle-via-a-wrapper-resource>#18644 0.16 Regression fix: re-expose the display handle via a wrapper resource</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: 0.16 Regression fix: re-expose the display handle via a wrapper resource<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18644<li><strong>Author</strong>: HugoPeters1024<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: <code>A-Windowing</code>, <code>C-Usability</code>, <code>S-Ready-For-Final-Review</code>, <code>P-Regression</code>, <code>D-Straightforward</code><li><strong>Created</strong>: 2025-03-31T08:20:55Z<li><strong>Merged</strong>: Not merged<li><strong>Merged By</strong>: N/A</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>In the latest released version (15.3) I am able to obtain this information by getting the actual <code>EventLoop</code> via <code>non_send_resource</code>. Now that this object has (probably rightfully so) been replaced by the <code>EventLoopProxy</code>, I can no longer maintain my custom render backend: https://github.com/HugoPeters1024/bevy_vulkan. I also need the display handle for a custom winit integration, for which I’ve made patches to bevy before: XREF: https://github.com/bevyengine/bevy/pull/15884</ul><h2 id=solution>Solution</h2><ul><li>Luckily, all that is required is exposing the <code>OwnedDisplayHandle</code> in its own wrapper resource.</ul><h2 id=testing>Testing</h2><ul><li>Aforementioned custom rendering backend works on this commit.</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The PR addresses a regression introduced in Bevy 0.16 where access to the windowing system’s display handle was lost during architectural changes. Previously, users could access the winit <code>EventLoop</code> directly through Bevy’s <code>NonSend</code> resources to obtain critical platform-specific handles needed for low-level graphics operations. However, when Bevy replaced direct <code>EventLoop</code> access with an <code>EventLoopProxy</code> for better thread safety and architectural isolation, this broke existing integrations that relied on accessing the underlying display handle.<p>The core problem manifested in projects like the author’s bevy_vulkan render backend, which required the display handle to create Vulkan surfaces. The display handle (represented as <code>OwnedDisplayHandle</code> in winit) is essential for:<ul><li>Creating graphics API surfaces (Vulkan/Metal/DirectX)<li>Querying display capabilities<li>Platform-specific windowing system integration</ul><p>The solution introduces a minimal wrapper resource to safely re-expose the display handle while maintaining Bevy’s architectural boundaries. Instead of providing full access to the <code>EventLoop</code>, the implementation adds a dedicated <code>DisplayHandleWrapper</code> resource containing just the <code>OwnedDisplayHandle</code>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Resource</span><span style=color:#61676ccc>,</span><span> Deref</span><span style=color:#61676ccc>,</span><span> Default)]
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>DisplayHandleWrapper</span><span>(</span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTOwnedDisplayHandle>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// In window creation system
</span><span>world</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_non_send_resource</span><span>(DisplayHandleWrapper(</span><span style=color:#55b4d4;font-style:italic>Some</span><span>(
</span><span>    event_loop_builder</span><span style=color:#ed9366>.</span><span style=color:#f07171>build</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>owned_display_handle</span><span>()
</span><span>)))</span><span style=color:#61676ccc>;
</span></code></pre><p>This approach:<ol><li>Preserves encapsulation by exposing only necessary data<li>Maintains thread safety through <code>NonSend</code> resource semantics<li>Avoids reintroducing direct <code>EventLoop</code> dependencies<li>Requires minimal code changes (10 lines added)</ol><p>The implementation leverages Bevy’s existing resource system, inserting the wrapper during window creation when the event loop is initialized. Consumers can now access the display handle through standard Bevy resource queries:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>fn </span><span style=color:#f29718>vulkan_initialization_system</span><span>(</span><span style=color:#ff8f40>display_handle</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTNonSend&LTDisplayHandleWrapper>>) {
</span><span>    </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(handle) </span><span style=color:#ed9366>=</span><span> display_handle</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_ref</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>and_then</span><span>(|</span><span style=color:#ff8f40>h</span><span>| h</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0.</span><span style=color:#f07171>as_ref</span><span>()) {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// Create Vulkan surface using raw handle
</span><span>    }
</span><span>}
</span></code></pre><p>Key technical considerations included:<ul><li>Maintaining compatibility with multiple platforms (X11/Wayland/Windows/macOS)<li>Preserving the existing event loop architecture changes from #15884<li>Ensuring proper lifetime management of the display handle<li>Avoiding unnecessary allocations or indirections</ul><p>The fix restores critical functionality for low-level graphics integrations while aligning with Bevy’s evolving windowing architecture. It demonstrates a pattern for safely exposing platform-specific handles through controlled wrapper types, balancing accessibility with architectural constraints.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[EventLoopBuilder] --> B[Create EventLoop]
</span><span>    B --> C[Extract OwnedDisplayHandle]
</span><span>    C --> D[DisplayHandleWrapper]
</span><span>    D --> E[NonSend Resource]
</span><span>    E --> F[Vulkan Backend]
</span><span>    E --> G[Custom Integrations]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=file-crates-bevy-winit-src-lib-rs>File: <code>crates/bevy_winit/src/lib.rs</code></h3><p><strong>Changes</strong>: Added new <code>DisplayHandleWrapper</code> resource to store the winit display handle<p>Key additions:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Resource</span><span style=color:#61676ccc>,</span><span> Deref</span><span style=color:#61676ccc>,</span><span> Default)]
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>DisplayHandleWrapper</span><span>(</span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTOwnedDisplayHandle>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// In create_windows system initialization:
</span><span>world</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_non_send_resource</span><span>(DisplayHandleWrapper(</span><span style=color:#55b4d4;font-style:italic>Some</span><span>(
</span><span>    event_loop_builder</span><span style=color:#ed9366>.</span><span style=color:#f07171>build</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>owned_display_handle</span><span>()
</span><span>)))</span><span style=color:#61676ccc>;
</span></code></pre><p><strong>Impact</strong>:<ul><li>Re-exposes critical display handle through controlled interface<li>Maintains architectural boundaries introduced with EventLoopProxy<li>Enables low-level graphics integrations without compromising safety</ul><h2 id=further-reading>Further Reading</h2><ol><li>Winit documentation on display handles: <a rel="noopener nofollow noreferrer" href=https://docs.rs/winit/latest/winit/platform/raw_window_handle/index.html target=_blank>winit::platform::raw_window_handle</a><li>Bevy NonSend resources guide: <a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/next/ecs/non-send-resources/ target=_blank>Bevy Engine: Non-Send Resources</a><li>Vulkan surface creation with raw handles: <a rel="noopener nofollow noreferrer" href=https://vulkan-tutorial.com/Drawing_a_triangle/Presentation/Window_surface target=_blank>Vulkan Tutorial: Window Surface</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-03/pr_18644.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>