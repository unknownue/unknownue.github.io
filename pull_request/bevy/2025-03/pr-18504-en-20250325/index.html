<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18504 Define system param validation on a per-system parameter basis
        
    </title><meta content="#18504 Define system param validation on a per-system parameter basis" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-03/>‚Üê Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-03-25</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-03/pr-18504-zh-cn-20250325>‰∏≠Êñá</a></div></div><div class=pr-content><h1 id=18504-define-system-param-validation-on-a-per-system-parameter-basis>#18504 Define system param validation on a per-system parameter basis</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Define system param validation on a per-system parameter basis<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18504<li><strong>Author</strong>: alice-i-cecile<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: <code>C-Bug</code>, <code>C-Feature</code>, <code>A-ECS</code>, <code>S-Ready-For-Final-Review</code>, <code>M-Needs-Migration-Guide</code><li><strong>Created</strong>: 2025-03-23T23:40:48Z</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>When introduced, <code>Single</code> was intended to simply be silently skipped, allowing for graceful and efficient handling of systems during invalid game states (such as when the player is dead).<p>However, this also caused missing resources to <em>also</em> be silently skipped, leading to confusing and very hard to debug failures. In 0.15.1, this behavior was reverted to a panic, making missing resources easier to debug, but largely making <code>Single</code> (and <code>Populated</code>) worthless, as they would panic during expected game states.<p>Ultimately, the consensus is that this behavior should differ on a per-system-param basis. However, there was no sensible way to <em>do</em> that before this PR.<h2 id=solution>Solution</h2><p>Swap <code>SystemParam::validate_param</code> from a <code>bool</code> to:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>/// The outcome of system / system param validation,
</span><span style=color:#abb0b6;font-style:italic>/// used by system executors to determine what to do with a system.
</span><span style=color:#fa6e32>pub enum </span><span style=color:#399ee6>ValidationOutcome </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>/// All system parameters were validated successfully and the system can be run.
</span><span>    Valid</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>/// At least one system parameter failed validation, and an error must be handled.
</span><span>    </span><span style=color:#abb0b6;font-style:italic>/// By default, this will result in1 a panic. See [crate::error] for more information.
</span><span>    </span><span style=color:#abb0b6;font-style:italic>///
</span><span>    </span><span style=color:#abb0b6;font-style:italic>/// This is the default behavior, and is suitable for system params that should *always* be valid,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>/// either because sensible fallback behavior exists (like [`Query`] or because
</span><span>    </span><span style=color:#abb0b6;font-style:italic>/// failures in validation should be considered a bug in the user's logic that must be immediately addressed (like [`Res`]).
</span><span>    Invalid</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>/// At least one system parameter failed validation, but the system should be skipped due to [`ValidationBehavior::Skip`].
</span><span>    </span><span style=color:#abb0b6;font-style:italic>/// This is suitable for system params that are intended to only operate in certain application states, such as [`Single`].
</span><span>    Skipped</span><span style=color:#61676ccc>,
</span><span>}
</span></code></pre><p>Then, inside of each <code>SystemParam</code> implementation, return either Valid, Invalid or Skipped.<p>Currently, only <code>Single</code>, <code>Option&LTSingle></code> and <code>Populated</code> use the <code>Skipped</code> behavior. Other params (like resources) retain their current failing<h2 id=testing>Testing</h2><p>Messed around with the fallible_params example. Added a pair of tests: one for panicking when resources are missing, and another for properly skipping <code>Single</code> and <code>Populated</code> system params.<h2 id=to-do>To do</h2><ul><li><input checked disabled type=checkbox> get https://github.com/bevyengine/bevy/pull/18454 merged<li><input checked disabled type=checkbox> fix the todo!() in the macro-powered tuple implementation (please help ü•∫)<li><input checked disabled type=checkbox> test<li><input checked disabled type=checkbox> write a migration guide<li><input checked disabled type=checkbox> update the example comments</ul><h2 id=migration-guide>Migration Guide</h2><p>Various system and system parameter validation methods (<code>SystemParam::validate_param</code>, <code>System::validate_param</code> and <code>System::validate_param_unsafe</code>) now return and accept a <code>ValidationOutcome</code> enum, rather than a <code>bool</code>. The previous <code>true</code> values map to <code>ValidationOutcome::Valid</code>, while <code>false</code> maps to <code>ValidationOutcome::Invalid</code>.<p>However, if you wrote a custom schedule executor, you should now respect the new <code>ValidationOutcome::Skipped</code> parameter, skipping any systems whose validation was skipped. By contrast, <code>ValidationOutcome::Invalid</code> systems should also be skipped, but you should call the <code>default_error_handler</code> on them first, which by default will result in a panic.<p>If you are implementing a custom <code>SystemParam</code>, you should consider whether failing system param validation is an error or an expected state, and choose between <code>Invalid</code> and <code>Skipped</code> accordingly. In Bevy itself, <code>Single</code> and <code>Populated</code> now once again skip the system when their conditions are not met. This is the 0.15.0 behavior, but stands in contrast to the 0.15.1 behavior, where they would panic.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The core problem stemmed from conflicting validation requirements for different system parameters. Parameters like <code>Single</code> needed to gracefully skip systems when their conditions weren‚Äôt met, while resource parameters like <code>Res</code> required strict validation to prevent silent failures. Previous implementations used a boolean validation approach that couldn‚Äôt differentiate between these cases, leading to either overly strict or overly permissive behavior.<p>The solution introduces a three-state validation system through the <code>ValidationOutcome</code> enum. This allows each system parameter to declare its failure mode:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub enum </span><span style=color:#399ee6>ValidationOutcome </span><span>{
</span><span>    Valid</span><span style=color:#61676ccc>,
</span><span>    Invalid</span><span style=color:#61676ccc>,
</span><span>    Skipped</span><span style=color:#61676ccc>,
</span><span>}
</span></code></pre><p>Key implementation changes occurred in the validation infrastructure:<ol><li><strong>System Parameter Traits</strong>:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>validate_param</span><span>(...) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>bool</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>validate_param</span><span>(...) </span><span style=color:#61676ccc>-></span><span> ValidationOutcome</span><span style=color:#61676ccc>;
</span></code></pre><ol start=2><li><strong>Executor Handling</strong>: All executors (single-threaded, multi-threaded, simple) were updated to handle the new validation states. For example in <code>single_threaded.rs</code>:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>match</span><span> outcome {
</span><span>    ValidationOutcome</span><span style=color:#ed9366>::</span><span>Valid </span><span style=color:#ed9366>=> </span><span>{}
</span><span>    ValidationOutcome</span><span style=color:#ed9366>::</span><span>Invalid </span><span style=color:#ed9366>=> </span><span>{
</span><span>        (error_handler)(error</span><span style=color:#61676ccc>, </span><span>ErrorContext</span><span style=color:#ed9366>::</span><span>SystemParamValidation)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>    ValidationOutcome</span><span style=color:#ed9366>::</span><span>Skipped </span><span style=color:#ed9366>=> </span><span>{
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>completed_systems</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(system_index)</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><ol start=3><li><strong>Parameter Implementations</strong>: Critical parameters were updated to return appropriate outcomes. For <code>Single&LTT></code>:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>fn </span><span style=color:#f29718>validate_param</span><span>(...) </span><span style=color:#61676ccc>-></span><span> ValidationOutcome {
</span><span>    </span><span style=color:#fa6e32>if</span><span> entity</span><span style=color:#ed9366>.</span><span style=color:#f07171>exists</span><span>() {
</span><span>        ValidationOutcome</span><span style=color:#ed9366>::</span><span>Valid
</span><span>    } </span><span style=color:#fa6e32>else </span><span>{
</span><span>        ValidationOutcome</span><span style=color:#ed9366>::</span><span>Skipped
</span><span>    }
</span><span>}
</span></code></pre><p>This approach maintains strict validation for essential parameters while allowing optional ones to skip systems cleanly. The migration required updating all system parameter implementations and executors to handle the new enum, ensuring consistent error handling across the ECS framework.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[SystemParam Validation] --> B{ValidationOutcome}
</span><span>    B -->|Valid| C[Run System]
</span><span>    B -->|Invalid| D[Handle Error]
</span><span>    B -->|Skipped| E[Skip System]
</span><span>    D --> F[Panic by Default]
</span><span>    E --> G[Continue Execution]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ecs-src-system-system-param-rs><code>crates/bevy_ecs/src/system/system_param.rs</code></h3><ul><li>Introduced <code>ValidationOutcome</code> enum<li>Updated all <code>SystemParam</code> implementations to return specific outcomes<li>Modified validation logic for <code>Single</code>, <code>Option&LTSingle></code>, and <code>Populated</code></ul><p>Critical code change:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>impl</span><span><</span><span style=color:#fa6e32>'w</span><span>, T</span><span style=color:#61676ccc>:</span><span> Component> SystemParam </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>Single</span><span><</span><span style=color:#fa6e32>'w</span><span>, T> {
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>validate_param</span><span>(...) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>bool </span><span>{
</span><span>        entity</span><span style=color:#ed9366>.</span><span style=color:#f07171>exists</span><span>()
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>impl</span><span><</span><span style=color:#fa6e32>'w</span><span>, T</span><span style=color:#61676ccc>:</span><span> Component> SystemParam </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>Single</span><span><</span><span style=color:#fa6e32>'w</span><span>, T> {
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>validate_param</span><span>(...) </span><span style=color:#61676ccc>-></span><span> ValidationOutcome {
</span><span>        </span><span style=color:#fa6e32>if</span><span> entity</span><span style=color:#ed9366>.</span><span style=color:#f07171>exists</span><span>() {
</span><span>            ValidationOutcome</span><span style=color:#ed9366>::</span><span>Valid
</span><span>        } </span><span style=color:#fa6e32>else </span><span>{
</span><span>            ValidationOutcome</span><span style=color:#ed9366>::</span><span>Skipped
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre><h3 id=crates-bevy-ecs-src-schedule-executor-mod-rs><code>crates/bevy_ecs/src/schedule/executor/mod.rs</code></h3><ul><li>Updated executor trait definitions<li>Modified system validation flow</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Updated executor interface:
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>super</span><span>) </span><span style=color:#fa6e32>trait </span><span style=color:#399ee6>SystemExecutor</span><span>: Send + Sync {
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>run</span><span>(
</span><span>        </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>,
</span><span>        </span><span style=color:#ff8f40>schedule</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> SystemSchedule,
</span><span>        </span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> World,
</span><span>        </span><span style=color:#ff8f40>skip_systems</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#ed9366>&</span><span>FixedBitSet>,
</span><span>        </span><span style=color:#ff8f40>error_handler</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>fn</span><span>(BevyError, ErrorContext),
</span><span>    )</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=executor-implementations>Executor Implementations</h3><p>All executors received similar updates to handle validation outcomes:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// In multi_threaded.rs:
</span><span style=color:#fa6e32>let</span><span> outcome </span><span style=color:#ed9366>=</span><span> system</span><span style=color:#ed9366>.</span><span style=color:#f07171>validate_param</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>match</span><span> outcome {
</span><span>    ValidationOutcome</span><span style=color:#ed9366>::</span><span>Valid </span><span style=color:#ed9366>=> </span><span>{}
</span><span>    ValidationOutcome</span><span style=color:#ed9366>::</span><span>Invalid </span><span style=color:#ed9366>=> </span><span>{
</span><span>        (error_handler)(error</span><span style=color:#61676ccc>, </span><span>ErrorContext</span><span style=color:#ed9366>::</span><span>SystemParamValidation)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>    ValidationOutcome</span><span style=color:#ed9366>::</span><span>Skipped </span><span style=color:#ed9366>=> </span><span>{
</span><span>        completed_systems</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert</span><span>(system_index)</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/ecs/system-params/ target=_blank>Bevy ECS System Param Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/book/ch06-01-defining-an-enum.html target=_blank>Rust Enums for State Management</a><li><a rel="noopener nofollow noreferrer" href=https://www.amethyst.rs/book/master/concepts/system.html#error-handling target=_blank>Error Handling in ECS Frameworks</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-03/pr_18504.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>