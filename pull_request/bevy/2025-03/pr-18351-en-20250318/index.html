<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18351 Unify and simplify command and system error handling
        
    </title><meta content="#18351 Unify and simplify command and system error handling" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-03/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-03-18</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-03/pr-18351-zh-cn-20250318>中文</a></div></div><div class=pr-content><h1 id=18351-unify-and-simplify-command-and-system-error-handling>#18351 Unify and simplify command and system error handling</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Unify and simplify command and system error handling<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18351<li><strong>Author</strong>: alice-i-cecile<li><strong>Status</strong>: MERGED<li><strong>Created</strong>: 2025-03-17T04:57:31Z<li><strong>Merged</strong>: Not merged<li><strong>Merged By</strong>: N/A</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>ECS error handling is a lovely flagship feature for Bevy 0.16, all in the name of reducing panics and encouraging better error handling (#14275).<li>Currently though, command and system error handling are completely disjoint and use different mechanisms.<li>Additionally, there’s a number of distinct ways to set the default/fallback/global error handler that have limited value. As far as I can tell, this will be cfg flagged to toggle between dev and production builds in 99.9% of cases, with no real value in more granular settings or helpers.<li>Fixes #17272</ul><h2 id=solution>Solution</h2><ul><li>Standardize error handling on the OnceLock global error mechanisms ironed out in https://github.com/bevyengine/bevy/pull/17215 <ul><li>As discussed there, there are serious performance concerns there, especially for commands<li>I also think this is a better fit for the use cases, as it’s truly global</ul><li>Move from <code>SystemErrorContext</code> to a more general purpose <code>ErrorContext</code>, which can handle observers and commands more clearly<li>Cut the superfluous setter methods on <code>App</code> and <code>SubApp</code><li>Rename the limited (and unhelpful) <code>fallible_systems</code> example to <code>error_handling</code>, and add an example of command error handling</ul><h2 id=testing>Testing</h2><p>Ran the <code>error_handling</code> example.<h2 id=notes-for-reviewers>Notes for reviewers</h2><ul><li>Do you see a clear way to allow commands to retain &mut World access in the per-command custom error handlers? IMO that’s a key feature here (allowing the ad-hoc creation of custom commands), but I’m not sure how to get there without exploding complexity.<li>I’ve removed the feature gate on the default_error_handler: contrary to @cart’s opinion in #17215 I think that virtually all apps will want to use this. Can you think of a category of app that a) is extremely performance sensitive b) is fine with shipping to production with the panic error handler? If so, I can try to gather performance numbers and/or reintroduce the feature flag. UPDATE: see benches at the end of this message.<li><del><code>OnceLock</code> is in <code>std</code>: @bushrat011899 what should we do here?</del><li>Do you have ideas for more automated tests for this collection of features?</ul><h2 id=benchmarks>Benchmarks</h2><p>I checked the impact of the feature flag introduced: benchmarks might show regressions. This bears more investigation. I’m still skeptical that there are users who are well-served by a fast always panicking approach, but I’m going to re-add the feature flag here to avoid stalling this out.<p><img alt=image src=https://github.com/user-attachments/assets/237f644a-b36d-4332-9b45-76fd5cbff4d0><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The Bevy engine’s ECS error handling needed consolidation. Before this PR, command execution and system execution used separate error handling mechanisms, creating maintenance overhead and inconsistent patterns. Developers faced multiple ways to configure global error handlers with limited practical benefits, while performance-sensitive applications risked unnecessary overhead.<p>The core solution standardized error handling using Rust’s <code>OnceLock</code> for global initialization. This replaced the dual <code>SystemErrorContext</code>/command error handling with a unified <code>ErrorContext</code> that handles both execution paths. The implementation removed seven redundant setter methods from <code>App</code> and <code>SubApp</code>, simplifying the public API.<p>Key changes involved refactoring command execution to use the same error reporting infrastructure as systems. Previously, commands used bespoke error handling:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Command error handling was separate
</span><span style=color:#fa6e32>impl </span><span style=color:#399ee6>MyCommand </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>apply</span><span>(</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>world</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> World) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><(), CommandError> {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// implementation
</span><span>    }
</span><span>}
</span></code></pre><p>Now both systems and commands route errors through <code>ErrorContext</code>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// After: Unified error handling
</span><span>world</span><span style=color:#ed9366>.</span><span style=color:#f07171>handle_error</span><span>(|| {
</span><span>    system</span><span style=color:#ed9366>.</span><span style=color:#f07171>run</span><span>(()</span><span style=color:#61676ccc>,</span><span> world)</span><span style=color:#61676ccc>;
</span><span>})</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Command execution uses same pattern
</span><span>world</span><span style=color:#ed9366>.</span><span style=color:#f07171>handle_error</span><span>(|| {
</span><span>    command</span><span style=color:#ed9366>.</span><span style=color:#f07171>apply</span><span>(world)</span><span style=color:#61676ccc>;
</span><span>})</span><span style=color:#61676ccc>;
</span></code></pre><p>Performance considerations drove the decision to keep error handlers global rather than per-entity. Benchmarks showed potential regressions from dynamic dispatch, leading to reintroduction of a feature flag for panic-only handling in performance-critical scenarios.<p>The <code>error_handling</code> example demonstrates both system and command error handling:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added command error demonstration
</span><span>commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(|</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>entities</span><span style=color:#61676ccc>:</span><span> Entities| {
</span><span>    </span><span style=color:#f07171>spawn_error</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> entities)</span><span style=color:#61676ccc>;
</span><span>})</span><span style=color:#61676ccc>;
</span></code></pre><p>Architecturally, this change:<ol><li>Reduces code duplication between system/command error paths<li>Enables shared observer patterns for error monitoring<li>Lowers cognitive load through consistent APIs</ol><p>Future work could explore per-command error handlers with world access, but this PR establishes the foundational structure for unified error processing.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[System Execution] --> C[ErrorContext]
</span><span>    B[Command Execution] --> C
</span><span>    C --> D[Global Handler]
</span><span>    C --> E[Observers]
</span><span>    style C fill:#f9f,stroke:#333
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ol><li><code>crates/bevy_ecs/src/error/handler.rs</code> (+118/-22)</ol><ul><li>Consolidated error handling logic into <code>ErrorContext</code><li>Added observer registration for error events<li>Removed system-specific error context implementation</ul><ol start=2><li><code>crates/bevy_ecs/src/error/command_handling.rs</code> (+108/-0)</ol><ul><li>New module handling command error propagation<li>Implements <code>CommandError</code> reporting through <code>ErrorContext</code></ul><ol start=3><li><code>crates/bevy_ecs/src/system/commands/mod.rs</code> (+34/-53)</ol><ul><li>Refactored command application to use unified error handling:</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before
</span><span style=color:#fa6e32>let</span><span> result </span><span style=color:#ed9366>=</span><span> command</span><span style=color:#ed9366>.</span><span style=color:#f07171>apply</span><span>(world)</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(e) </span><span style=color:#ed9366>=</span><span> result {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Command-specific handling
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After
</span><span>world</span><span style=color:#ed9366>.</span><span style=color:#f07171>handle_error</span><span>(|| command</span><span style=color:#ed9366>.</span><span style=color:#f07171>apply</span><span>(world))</span><span style=color:#61676ccc>;
</span></code></pre><ol start=4><li><code>examples/ecs/error_handling.rs</code> (+46/-22)</ol><ul><li>Expanded example showing command errors:</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>fn </span><span style=color:#f29718>spawn_error</span><span>(</span><span style=color:#ff8f40>entities</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> Entities) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><(), InvalidSpawn> {
</span><span>    entities</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn_empty</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(InvalidSpawn)
</span><span>}
</span></code></pre><ol start=5><li><code>crates/bevy_ecs/src/error/mod.rs</code> (+32/-33)</ol><ul><li>Reorganized exports for new error handling structure<li>Deprecated legacy system error types</ul><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/std/sync/struct.OnceLock.html target=_blank>Rust OnceLock documentation</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/pull/17215 target=_blank>Original error handling RFC (#17215)</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/error-handling/ target=_blank>Bevy ECS error handling guide</a> (post-0.16)</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-03/pr_18351.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>