<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18424 Fix `bevy_ecs` doc tests with `--all-features`
        
    </title><meta content="#18424 Fix `bevy_ecs` doc tests with `--all-features`" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-03/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-03-19</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-03/pr-18424-zh-cn-20250319>中文</a></div></div><div class=pr-content><h1 id=18424-fix-bevy-ecs-doc-tests-with-all-features>#18424 Fix <code>bevy_ecs</code> doc tests with <code>--all-features</code></h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix <code>bevy_ecs</code> doc tests with <code>--all-features</code><li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18424<li><strong>Author</strong>: greeble-dev<li><strong>Status</strong>: MERGED<li><strong>Created</strong>: 2025-03-19T18:57:48Z<li><strong>Merged</strong>: 2025-03-20T09:14:32Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h3 id=objective>Objective</h3><p>Fix <code>bevy_ecs</code> doc tests failing when used with <code>--all-features</code>.<pre style=color:#61676c;background-color:#fafafa><code><span>---- crates\bevy_ecs\src\error\handler.rs - error::handler::GLOBAL_ERROR_HANDLER (line 87) stdout ----
</span><span>error[E0425]: cannot find function `default_error_handler` in this scope
</span><span> --> crates\bevy_ecs\src\error\handler.rs:92:24
</span><span>  |
</span><span>8 |    let error_handler = default_error_handler();
</span><span>  |                        ^^^^^^^^^^^^^^^^^^^^^ not found in this scope
</span></code></pre><p>I happened to come across this while testing #12207. I’m not sure it actually needs fixing but seemed worth a go<h3 id=testing>Testing</h3><pre style=color:#61676c;background-color:#fafafa><code><span>cargo test --doc -p bevy_ecs --all-features
</span></code></pre><h3 id=side-notes>Side Notes</h3><p>The CI misses this error as it doesn’t use <code>--all-features</code>. Perhaps it should?<p>I tried adding <code>--all-features</code> to <code>ci/src/commands/doc_tests.rs</code> but this triggered a linker error:<pre style=color:#61676c;background-color:#fafafa><code><span>Compiling bevy_dylib v0.16.0-dev (C:\Projects\bevy\crates\bevy_dylib)
</span><span>error: linking with `link.exe` failed: exit code: 1189
</span><span>= note: LINK : fatal error LNK1189: library limit of 65535 objects exceeded␍
</span></code></pre><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The PR addresses a documentation test failure that only manifests when building Bevy’s ECS module with all features enabled. The core issue stemmed from conditional compilation attributes not properly guarding documentation examples when multiple features are active simultaneously.<p>The failure occurred in <code>bevy_ecs</code>’s error handling documentation tests, specifically around the <code>GLOBAL_ERROR_HANDLER</code> example. The <code>default_error_handler</code> function is conditionally available only when the <code>configurable_error_handler</code> feature is enabled. However, the documentation test lacked proper feature gating, leading to compilation failures when testing with <code>--all-features</code>.<p>The solution involved adding precise conditional compilation attributes to the documentation example. By using <code>#[cfg_attr(doc, cfg(feature = "configurable_error_handler"))]</code>, the example becomes properly guarded in two scenarios:<ol><li>For regular compilation: Uses standard <code>#[cfg]</code> attributes<li>For documentation builds: Applies the feature flag conditionally</ol><p>This approach ensures the documentation example only appears when the required feature is active, while maintaining visibility in generated docs. The implementation respects Bevy’s existing patterns for feature-gated documentation while fixing the test execution path.<p>An important secondary consideration was CI configuration. The original CI setup didn’t catch this issue because it didn’t test documentation with all features enabled. While attempting to add <code>--all-features</code> to CI would be ideal, practical limitations (like linker errors from excessive object files) prevented this from being a viable immediate solution.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Doc Test Failure] --> B[Missing Feature Guard]
</span><span>    B --> C[Add cfg_attr to Example]
</span><span>    C --> D[Proper Feature Gating]
</span><span>    D --> E[Successful --all-features Test]
</span><span>    B --> F[CI Configuration Limitation]
</span><span>    F --> G[Linker Error Prevention]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ecs-src-error-handler-rs-1-1><code>crates/bevy_ecs/src/error/handler.rs</code> (+1/-1)</h3><p>Added conditional compilation attributes to fix documentation test:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#abb0b6;font-style:italic>/// # Example
</span><span style=color:#abb0b6;font-style:italic>///
</span><span style=color:#abb0b6;font-style:italic>/// ```
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#abb0b6;font-style:italic>/// # Example
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg_attr</span><span>(doc</span><span style=color:#61676ccc>, </span><span style=color:#f29718>cfg</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"configurable_error_handler"</span><span>))]
</span><span style=color:#abb0b6;font-style:italic>/// ```
</span></code></pre><p>This change ensures the documentation test example for <code>GLOBAL_ERROR_HANDLER</code> is only compiled when the required feature is active, resolving the missing <code>default_error_handler</code> function error.<h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/rustdoc/write-documentation/documentation-tests.html target=_blank>Rust Documentation Tests</a><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/reference/conditional-compilation.html target=_blank>Conditional Compilation in Rust</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/docs/features.md target=_blank>Bevy’s Feature Flags Documentation</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-03/pr_18424.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>