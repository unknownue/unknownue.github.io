<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18519 bugfix(frustra of point lights were not recalculated when a camera changes)
        
    </title><meta content="#18519 bugfix(frustra of point lights were not recalculated when a camera changes)" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-03/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-03-25</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-03/pr-18519-zh-cn-20250325>中文</a></div></div><div class=pr-content><h1 id=18519-bugfix-frustra-of-point-lights-were-not-recalculated-when-a-camera-changes>#18519 bugfix(frustra of point lights were not recalculated when a camera changes)</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: bugfix(frustra of point lights were not recalculated when a camera changes)<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18519<li><strong>Author</strong>: HugoPeters1024<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: <code>C-Bug</code>, <code>A-Rendering</code>, <code>C-Performance</code>, <code>S-Ready-For-Final-Review</code><li><strong>Created</strong>: 2023-03-24T17:51:03Z<li><strong>Merged</strong>: 2023-03-27T14:22:15Z<li><strong>Merged By</strong>: cart</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Fixes https://github.com/bevyengine/bevy/issues/11682</ul><h2 id=solution>Solution</h2><ul><li>https://github.com/bevyengine/bevy/pull/4086 introduced an optimization to not do redundant calculations, but did not take into account changes to the resource <code>global_lights</code>. I believe that my patch includes the optimization benefit but adds the required nuance to fix said bug.</ul><h2 id=testing>Testing</h2><p>The example originally given by <a rel="noopener nofollow noreferrer" href=https://github.com/kirillsurkov target=_blank>@kirillsurkov</a> and then updated by me to bevy 15.3 here: https://github.com/bevyengine/bevy/issues/11682#issuecomment-2746287416 will not have shadows without this patch:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>use </span><span>bevy</span><span style=color:#ed9366>::</span><span>prelude</span><span style=color:#ed9366>::*</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Resource)]
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>State </span><span>{
</span><span>    x</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>,
</span><span>}
</span><span>
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>main</span><span>() {
</span><span>    App</span><span style=color:#ed9366>::</span><span>new()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>add_plugins</span><span>(DefaultPlugins)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(Startup</span><span style=color:#61676ccc>,</span><span> setup)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(Update</span><span style=color:#61676ccc>,</span><span> update)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_resource</span><span>(State { x</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>-</span><span style=color:#ff8f40>40.0 </span><span>})
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>run</span><span>()</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>setup</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>meshes</span><span style=color:#61676ccc>: </span><span>ResMut&LTAssets&LTMesh>>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>materials</span><span style=color:#61676ccc>: </span><span>ResMut&LTAssets&LTStandardMaterial>>,
</span><span>) {
</span><span>    commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((
</span><span>        Mesh3d(meshes</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(Circle</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ff8f40>4.0</span><span>)))</span><span style=color:#61676ccc>,
</span><span>        MeshMaterial3d(materials</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(Color</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>WHITE</span><span>))</span><span style=color:#61676ccc>,
</span><span>    ))</span><span style=color:#61676ccc>;
</span><span>    commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((
</span><span>        Mesh3d(meshes</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(Cuboid</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ff8f40>1.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>1.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>1.0</span><span>)))</span><span style=color:#61676ccc>,
</span><span>        MeshMaterial3d(materials</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(Color</span><span style=color:#ed9366>::</span><span>linear_rgb(</span><span style=color:#ff8f40>0.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>1.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.0</span><span>)))</span><span style=color:#61676ccc>,
</span><span>    ))</span><span style=color:#61676ccc>;
</span><span>    commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((
</span><span>        PointLight {
</span><span>            shadows_enabled</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>true</span><span style=color:#61676ccc>,
</span><span>            </span><span style=color:#ed9366>..</span><span style=color:#f07171>default</span><span>()
</span><span>        }</span><span style=color:#61676ccc>,
</span><span>        Transform</span><span style=color:#ed9366>::</span><span>from_xyz(</span><span style=color:#ff8f40>4.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>8.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>4.0</span><span>)</span><span style=color:#61676ccc>,
</span><span>    ))</span><span style=color:#61676ccc>;
</span><span>    commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>(Camera3d</span><span style=color:#ed9366>::</span><span>default())</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>update</span><span>(</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>state</span><span style=color:#61676ccc>: </span><span>ResMut&LTState>, </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>camera</span><span style=color:#61676ccc>: </span><span>Query<</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> Transform, With&LTCamera3d>>) {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> camera </span><span style=color:#ed9366>=</span><span> camera</span><span style=color:#ed9366>.</span><span style=color:#f07171>single_mut</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#fa6e32>let</span><span> t </span><span style=color:#ed9366>= </span><span>Vec3</span><span style=color:#ed9366>::</span><span>new(state</span><span style=color:#ed9366>.</span><span>x</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>10.0</span><span>)</span><span style=color:#61676ccc>;
</span><span>    camera</span><span style=color:#ed9366>.</span><span>translation </span><span style=color:#ed9366>=</span><span> t</span><span style=color:#61676ccc>;
</span><span>    camera</span><span style=color:#ed9366>.</span><span style=color:#f07171>look_at</span><span>(t </span><span style=color:#ed9366>- </span><span>Vec3</span><span style=color:#ed9366>::</span><span>Z</span><span style=color:#61676ccc>, </span><span>Vec3</span><span style=color:#ed9366>::</span><span>Y)</span><span style=color:#61676ccc>;
</span><span>
</span><span>    state</span><span style=color:#ed9366>.</span><span>x </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0.0</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The core issue stemmed from an optimization introduced in #4086 that reduced redundant light frusta calculations. While this improved performance, it inadvertently broke shadow updates when cameras moved because the system wasn’t accounting for changes in global lighting data.<p>In Bevy’s rendering pipeline, point lights use cubemap frusta (CubemapFrusta) to determine shadow casting regions. These need recalculation when either the light or camera transforms change. The original optimization only tracked view entity and tonemapping changes, missing the critical dependency on GlobalLights resource updates.<p>The fix modifies the system’s run condition in <code>check_light_mesh_visibility</code> to include <code>GlobalLights</code> changes:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before condition:
</span><span style=color:#ed9366>.</span><span style=color:#f07171>run_if</span><span>(
</span><span>    resource_changed</span><span style=color:#ed9366>::</span><span>&LTGlobalLights>()
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// We check for view entity changes to handle added cameras
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>or_else</span><span>(any_with_component_added</span><span style=color:#ed9366>::</span><span>&LTView>())
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>or_else</span><span>(tonemapping_changed)</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After fix:
</span><span style=color:#ed9366>.</span><span style=color:#f07171>run_if</span><span>(
</span><span>    resource_changed</span><span style=color:#ed9366>::</span><span>&LTGlobalLights>()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>or_else</span><span>(any_with_component_added</span><span style=color:#ed9366>::</span><span>&LTView>())
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>or_else</span><span>(tonemapping_changed)
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// Add detection for GlobalLights changes
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>or_else</span><span>(resource_changed</span><span style=color:#ed9366>::</span><span>&LTGlobalLights>())</span><span style=color:#61676ccc>, 
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><p>This change ensures the system activates when:<ol><li>Camera views change (new cameras added)<li>Tonemapping settings update<li>Global lighting configuration changes<li>The GlobalLights resource itself is modified</ol><p>The provided test case demonstrates the failure scenario: a moving camera wouldn’t trigger frusta updates because the system wasn’t monitoring GlobalLights changes. With the fix, camera movement now properly invalidates the light frusta cache through the GlobalLights change detection.<p>Performance-wise, this maintains the original optimization’s benefits while adding a necessary condition. The GlobalLights resource changes infrequently enough that the added check doesn’t introduce significant overhead.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Camera Movement] --> B{GlobalLights Changed?}
</span><span>    B -->|Yes| C[Recalculate Light Frusta]
</span><span>    B -->|No| D[Use Cached Frusta]
</span><span>    C --> E[Update Shadow Maps]
</span><span>    D --> E
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-pbr-src-light-mod-rs-13-3><code>crates/bevy_pbr/src/light/mod.rs</code> (+13/-3)</h3><p><strong>Purpose</strong>: Fix light frusta update logic<p>Key modification in the system initialization:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>check_light_mesh_visibility
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>run_if</span><span>(
</span><span>        resource_changed</span><span style=color:#ed9366>::</span><span>&LTGlobalLights>()
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>or_else</span><span>(any_with_component_added</span><span style=color:#ed9366>::</span><span>&LTView>())
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>or_else</span><span>(tonemapping_changed)</span><span style=color:#61676ccc>,
</span><span>    )</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>check_light_mesh_visibility
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>run_if</span><span>(
</span><span>        resource_changed</span><span style=color:#ed9366>::</span><span>&LTGlobalLights>()
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>or_else</span><span>(any_with_component_added</span><span style=color:#ed9366>::</span><span>&LTView>())
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>or_else</span><span>(tonemapping_changed)
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>or_else</span><span>(resource_changed</span><span style=color:#ed9366>::</span><span>&LTGlobalLights>())</span><span style=color:#61676ccc>, </span><span style=color:#abb0b6;font-style:italic>// Added line
</span><span>    )</span><span style=color:#61676ccc>;
</span></code></pre><p>This change ensures the light frusta update system triggers when the GlobalLights resource changes, which happens when camera transforms update. The dual check (both resource change and explicit GlobalLights tracking) provides redundant safeguards against missed updates.<h2 id=further-reading>Further Reading</h2><ol><li>Bevy’s ECS System Conditions: https://bevyengine.org/learn/book/getting-started/ecs/#system-params<li>Spatial Culling Techniques: https://learnopengl.com/Guest-Articles/2021/Scene/Frustum-Culling<li>Shadow Mapping Fundamentals: https://learnopengl.com/Advanced-Lighting/Shadows/Shadow-Mapping</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-03/pr_18519.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>