<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18309 Required components accept const values (#16720)
        
    </title><meta content="#18309 Required components accept const values (#16720)" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-03/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-03-21</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-03/pr-18309-zh-cn-20250321>中文</a></div></div><div class=pr-content><h1 id=18309-required-components-accept-const-values-16720>#18309 Required components accept const values (#16720)</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Required components accept const values (#16720)<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18309<li><strong>Author</strong>: Wuketuke<li><strong>Status</strong>: MERGED<li><strong>Created</strong>: 2025-03-14T11:04:18Z<li><strong>Merged</strong>: 2025-03-15T14:22:35Z<li><strong>Merged By</strong>: cart</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Const values should be more ergonomic to insert, since this is too verbose<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>require</span><span>(
</span><span>    </span><span style=color:#f29718>LockedAxes</span><span>(||LockedAxes::ROTATION_LOCKED)</span><span style=color:#61676ccc>,
</span><span>)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>CharacterController</span><span style=color:#61676ccc>;
</span></code></pre><p>instead, users can now abbreviate that nonsense like this<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>require</span><span>(
</span><span>    LockedAxes </span><span style=color:#ed9366>=</span><span> ROTATION_LOCKED),
</span><span>)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>CharacterController</span><span style=color:#61676ccc>;
</span></code></pre><p>it also works for enum labels. I chose to omit the type, since were trying to reduce typing here. The alternative would have been this:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>require</span><span>(
</span><span>    LockedAxes </span><span style=color:#ed9366>=</span><span> LockedAxes::ROTATION_LOCKED),
</span><span>)]
</span></code></pre><p>This of course has its disadvantages, since the const has to be associated, but the old closure method is still possible, so I dont think its a problem.<ul><li>Fixes #16720</ul><h2 id=testing>Testing</h2><p>I added one new test in the docs, which also explain the new change. I also saw that the docs for the required components on line 165 was missing an assertion, so I added it back in<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The PR addresses a verbosity issue in Bevy’s component requirement system. Previously, developers needed to wrap constant values in closures when using the <code>#[require]</code> attribute for components:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>require</span><span>(</span><span style=color:#f29718>LockedAxes</span><span>(||LockedAxes::ROTATION_LOCKED))]
</span></code></pre><p>This closure-based approach added unnecessary boilerplate, particularly frustrating when dealing with associated constants. The core problem stemmed from the macro’s expectation of function-like syntax, which didn’t align with Rust’s native constant handling patterns.<p>The solution introduces a more idiomatic assignment syntax for constant values:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>require</span><span>(LockedAxes </span><span style=color:#ed9366>=</span><span> ROTATION_LOCKED)]
</span></code></pre><p>Key implementation changes occurred in the procedural macro handling component derivation. The macro’s parsing logic was modified to recognize both closure-based and assignment-style syntax. This maintains backward compatibility while adding the new, cleaner syntax.<p>In <code>component.rs</code> macros, the attribute parsing was enhanced to handle <code>=</code> operators:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Only handled closure syntax
</span><span>meta</span><span style=color:#ed9366>.</span><span>input</span><span style=color:#ed9366>.</span><span>parse</span><span style=color:#ed9366>::</span><span>&LTTokenStream2>()</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Handles both closure and assignment
</span><span style=color:#fa6e32>if</span><span> meta</span><span style=color:#ed9366>.</span><span>input</span><span style=color:#ed9366>.</span><span style=color:#f07171>peek</span><span>(Token</span><span style=color:#ed9366>!</span><span>[</span><span style=color:#ed9366>=</span><span>]) {
</span><span>    meta</span><span style=color:#ed9366>.</span><span>input</span><span style=color:#ed9366>.</span><span>parse</span><span style=color:#ed9366>::</span><span>&LTToken</span><span style=color:#f51818>!</span><span>[</span><span style=color:#ed9366>=</span><span>]</span><span style=color:#ed9366>></span><span>()</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> value </span><span style=color:#ed9366>=</span><span> meta</span><span style=color:#ed9366>.</span><span>input</span><span style=color:#ed9366>.</span><span>parse</span><span style=color:#ed9366>::</span><span>&LTExpr>()</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Process constant value
</span><span>} </span><span style=color:#fa6e32>else </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Existing closure handling
</span><span>}
</span></code></pre><p>This change required careful handling of the proc-macro2 token stream to correctly parse both syntax forms while maintaining existing functionality. The implementation preserves type safety by ensuring constants are properly associated with their types through Rust’s type system, rather than requiring explicit type annotations.<p>The PR includes updated documentation and tests that validate both syntax forms. A key test addition verifies that the assignment syntax compiles and functions equivalently to the closure-based approach:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>require</span><span>(TestComponent </span><span style=color:#ed9366>=</span><span> VALUE)]
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>TestRequirementAssignment</span><span style=color:#61676ccc>;
</span></code></pre><p>From an architectural perspective, this change improves Bevy’s ECS ergonomics without modifying the underlying component requirement system. The macro layer absorbs the syntax variation, leaving the actual component validation logic unchanged.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[User Component] --> B[#[derive(Component)]
</span><span>    B --> C[Macro Processing]
</span><span>    C --> D{Requirement Syntax}
</span><span>    D -->|Assignment| E[Constant Value]
</span><span>    D -->|Closure| F[Function Evaluation]
</span><span>    E --> G[Code Generation]
</span><span>    F --> G
</span><span>    G --> H[Component Metadata]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ecs-macros-src-component-rs><code>crates/bevy_ecs/macros/src/component.rs</code></h3><p><strong>Modification</strong>: Enhanced attribute parsing to handle assignment syntax<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Closure-only parsing
</span><span style=color:#fa6e32>let</span><span> value </span><span style=color:#ed9366>=</span><span> meta</span><span style=color:#ed9366>.</span><span>input</span><span style=color:#ed9366>.</span><span>parse</span><span style=color:#ed9366>::</span><span>&LTExprCall>()</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Dual syntax support
</span><span style=color:#fa6e32>if</span><span> meta</span><span style=color:#ed9366>.</span><span>input</span><span style=color:#ed9366>.</span><span style=color:#f07171>peek</span><span>(Token</span><span style=color:#ed9366>!</span><span>[</span><span style=color:#ed9366>=</span><span>]) {
</span><span>    meta</span><span style=color:#ed9366>.</span><span>input</span><span style=color:#ed9366>.</span><span>parse</span><span style=color:#ed9366>::</span><span>&LTToken</span><span style=color:#f51818>!</span><span>[</span><span style=color:#ed9366>=</span><span>]</span><span style=color:#ed9366>></span><span>()</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> value </span><span style=color:#ed9366>=</span><span> meta</span><span style=color:#ed9366>.</span><span>input</span><span style=color:#ed9366>.</span><span>parse</span><span style=color:#ed9366>::</span><span>&LTExpr>()</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Handle constant value
</span><span>} </span><span style=color:#fa6e32>else </span><span>{
</span><span>    </span><span style=color:#fa6e32>let</span><span> value </span><span style=color:#ed9366>=</span><span> meta</span><span style=color:#ed9366>.</span><span>input</span><span style=color:#ed9366>.</span><span>parse</span><span style=color:#ed9366>::</span><span>&LTExprCall>()</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Existing closure handling
</span><span>}
</span></code></pre><h3 id=crates-bevy-ecs-src-component-rs><code>crates/bevy_ecs/src/component.rs</code></h3><p><strong>Modification</strong>: Updated documentation and tests<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added test case for assignment syntax
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>test_required_components_assignment</span><span>() {
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component)]
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>require</span><span>(TestComponent </span><span style=color:#ed9366>=</span><span> VALUE)]
</span><span>    </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>TestRequirementAssignment</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Validation logic remains unchanged
</span><span>    assert_component_requirements</span><span style=color:#ed9366>::</span><span>&LTTestRequirementAssignment>()</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/reference/procedural-macros.html target=_blank>Rust Procedural Macros Guide</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/ecs/components/ target=_blank>Bevy ECS Component Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/syn/latest/syn/ target=_blank>Syn Crate for Macro Parsing</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-03/pr_18309.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>