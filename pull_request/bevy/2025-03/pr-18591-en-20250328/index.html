<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18591 Fix wesl in wasm and webgl2
        
    </title><meta content="#18591 Fix wesl in wasm and webgl2" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-03/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-03-28</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-03/pr-18591-zh-cn-20250328>中文</a></div></div><div class=pr-content><h1 id=18591-fix-wesl-in-wasm-and-webgl2>#18591 Fix wesl in wasm and webgl2</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix wesl in wasm and webgl2<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18591<li><strong>Author</strong>: mockersf<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: <code>A-Rendering</code>, <code>O-Web</code>, <code>S-Ready-For-Final-Review</code>, <code>P-Compile-Failure</code>, <code>O-WebGL2</code><li><strong>Created</strong>: 2025-03-28T11:20:44Z<li><strong>Merged</strong>: Not merged<li><strong>Merged By</strong>: N/A</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>feature <code>shader_format_wesl</code> doesn’t compile in Wasm<li>once fixed, example <code>shader_material_wesl</code> doesn’t work in WebGL2</ul><h2 id=solution>Solution</h2><ul><li>remove special path handling when loading shaders. this seems like a way to escape the asset folder which we don’t want to allow, and can’t compile on android or wasm, and can’t work on iOS (filesystem is rooted there)<li>pad material so that it’s 16 bits. I couldn’t get conditional compilation to work in wesl for type declaration, it fails to parse<li>the shader renders the color <code>(0.0, 0.0, 0.0, 0.0)</code> when it’s not a polka dot. this renders as black on WebGPU/metal/…, and white on WebGL2. change it to <code>(0.0, 0.0, 0.0, 1.0)</code> so that it’s black everywhere</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The PR addresses three interconnected issues preventing WESL shaders from working correctly in WebAssembly and WebGL2 contexts. The core challenges stemmed from platform-specific constraints in shader compilation and rendering behavior.<p><strong>1. Asset Path Sanitization</strong><br> The first hurdle was incorrect shader loading in Wasm. The original implementation contained special path handling that attempted to escape the asset folder. This approach caused failures on restricted filesystems like those in Android and iOS, and prevented WebAssembly compilation. The solution removed this fragile path manipulation, enforcing strict asset directory containment.<p><strong>2. WebGL2 Memory Alignment</strong><br> Even after fixing compilation, the <code>shader_material_wesl</code> example failed on WebGL2 due to struct alignment issues. The WGSL specification requires 16-byte alignment for uniform buffers, but the original shader struct:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>struct </span><span style=color:#399ee6>CustomMaterial </span><span>{
</span><span>    time</span><span style=color:#61676ccc>: </span><span>vec4<</span><span style=color:#fa6e32>f32</span><span>>,
</span><span>}
</span></code></pre><p>Needed additional padding when used with WebGL2’s stricter memory requirements. The fix added explicit padding:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>struct </span><span style=color:#399ee6>CustomMaterial </span><span>{
</span><span>    time</span><span style=color:#61676ccc>: </span><span>vec4<</span><span style=color:#fa6e32>f32</span><span>>,
</span><span>    _pad</span><span style=color:#61676ccc>: </span><span>vec3<</span><span style=color:#fa6e32>f32</span><span>>,
</span><span>}
</span></code></pre><p>This ensures proper 16-byte alignment while maintaining compatibility with other platforms.<p><strong>3. Cross-Platform Color Consistency</strong><br> The shader’s transparent black (<code>vec4(0.0, 0.0, 0.0, 0.0)</code>) rendered differently across platforms due to varying alpha interpretation. The solution standardized on opaque black (<code>vec4(0.0, 0.0, 0.0, 1.0)</code>), ensuring consistent visualization while maintaining the polka dot pattern effect.<p><strong>Shader Logic Refinement</strong><br> The <code>util.wesl</code> shader received crucial updates for conditional behavior:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#ed9366>@</span><span style=color:#fa6e32>if</span><span>(</span><span style=color:#ed9366>!</span><span style=color:#ff8f40>PARTY_MODE</span><span>) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Static color logic
</span><span>} </span><span style=color:#ed9366>@</span><span style=color:#fa6e32>else </span><span>{ 
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Animated party mode logic
</span><span>}
</span></code></pre><p>This structure allows runtime toggling via a <code>party_mode</code> uniform while avoiding parser issues with conditional type declarations.<h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-render-src-render-resource-shader-rs><code>crates/bevy_render/src/render_resource/shader.rs</code></h3><ul><li>Removed special path handling that caused Wasm failures<li>Simplified shader import logic to use direct asset paths</ul><h3 id=assets-shaders-custom-material-wesl><code>assets/shaders/custom_material.wesl</code></h3><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>CustomMaterial </span><span>{
</span><span>    time</span><span style=color:#61676ccc>: </span><span>vec4<</span><span style=color:#fa6e32>f32</span><span>>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>CustomMaterial </span><span>{
</span><span>    time</span><span style=color:#61676ccc>: </span><span>vec4<</span><span style=color:#fa6e32>f32</span><span>>,
</span><span>    _pad</span><span style=color:#61676ccc>: </span><span>vec3<</span><span style=color:#fa6e32>f32</span><span>>,
</span><span>}
</span></code></pre><p>Added padding to meet WebGL2’s 16-byte alignment requirements<h3 id=assets-shaders-util-wesl><code>assets/shaders/util.wesl</code></h3><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>return </span><span>vec4<</span><span style=color:#fa6e32>f32</span><span>>(dot_color </span><span style=color:#ed9366>*</span><span> is_dot</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.0</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: 
</span><span style=color:#fa6e32>return </span><span>vec4<</span><span style=color:#fa6e32>f32</span><span>>(dot_color </span><span style=color:#ed9366>*</span><span> is_dot</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>1.0</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><p>Fixed alpha channel for cross-platform consistency<h3 id=examples-shader-shader-material-wesl-rs><code>examples/shader/shader_material_wesl.rs</code></h3><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added shader defines for conditional compilation
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>fragment_shader</span><span>() </span><span style=color:#61676ccc>-></span><span> ShaderRef {
</span><span>    ShaderRef</span><span style=color:#ed9366>::</span><span>Path(</span><span style=color:#ff8f40>FRAGMENT_SHADER_ASSET_PATH</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>())
</span><span>}
</span><span>
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>specialize</span><span>(
</span><span>    </span><span style=color:#ff8f40>descriptor</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> RenderPipelineDescriptor,
</span><span>    </span><span style=color:#ed9366>_</span><span>: </span><span style=color:#ed9366>&</span><span>MeshVertexBufferLayoutRef,
</span><span>    </span><span style=color:#ff8f40>key</span><span style=color:#61676ccc>:</span><span> CustomMaterialKey,
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><(), SpecializedMeshPipelineError> {
</span><span>    descriptor</span><span style=color:#ed9366>.</span><span>fragment</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_mut</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#ed9366>.</span><span>shader_defs</span><span style=color:#ed9366>.</span><span style=color:#f07171>push</span><span>(
</span><span>        ShaderDefVal</span><span style=color:#ed9366>::</span><span>Bool(</span><span style=color:#86b300>"PARTY_MODE"</span><span style=color:#61676ccc>,</span><span> key</span><span style=color:#ed9366>.</span><span>party_mode)</span><span style=color:#61676ccc>,
</span><span>    )</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(())
</span><span>}
</span></code></pre><p>Implemented runtime shader configuration through specialization constants<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Shader Loading] --> B[WebGL2 Alignment]
</span><span>    A --> C[Cross-Platform Rendering]
</span><span>    B --> D[Material Struct Padding]
</span><span>    C --> E[Alpha Channel Fix]
</span><span>    D --> F[Example Stability]
</span><span>    E --> F
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://www.w3.org/TR/WGSL/#memory-layout target=_blank>WGSL Memory Layout Rules</a><li><a rel="noopener nofollow noreferrer" href=https://developer.mozilla.org/en-US/docs/Web/API/WebGL2RenderingContext/uniform target=_blank>WebGL2 Uniform Buffer Best Practices</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/getting-started/shaders/ target=_blank>Bevy Shader Materials Guide</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-03/pr_18591.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>