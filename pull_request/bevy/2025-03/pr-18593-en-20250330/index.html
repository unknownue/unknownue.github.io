<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18593 Improve error message for missing resources
        
    </title><meta content="#18593 Improve error message for missing resources" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-03/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-03-30</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-03/pr-18593-zh-cn-20250330>中文</a></div></div><div class=pr-content><h1 id=18593-improve-error-message-for-missing-resources>#18593 Improve error message for missing resources</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Improve error message for missing resources<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18593<li><strong>Author</strong>: chescock<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: <code>A-ECS</code>, <code>C-Usability</code>, <code>S-Ready-For-Final-Review</code><li><strong>Created</strong>: 2025-03-28T15:07:11Z<li><strong>Merged</strong>: Not merged<li><strong>Merged By</strong>: N/A</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Fixes #18515<p>After the recent changes to system param validation, the panic message for a missing resource is currently:<pre style=color:#61676c;background-color:#fafafa><code><span>Encountered an error in system `missing_resource_error::res_system`: SystemParamValidationError { skipped: false }
</span></code></pre><p>Add the parameter type name and a descriptive message, improving the panic message to:<pre style=color:#61676c;background-color:#fafafa><code><span>Encountered an error in system `missing_resource_error::res_system`: SystemParamValidationError { skipped: false, message: "Resource does not exist", param: "bevy_ecs::change_detection::Res&LTmissing_resource_error::MissingResource>" }
</span></code></pre><h2 id=solution>Solution</h2><p>Add fields to <code>SystemParamValidationError</code> for error context. Include the <code>type_name</code> of the param and a message.<p>Store them as <code>Cow<'static, str></code> and only format them into a friendly string in the <code>Display</code> impl. This lets us create errors using a <code>&'static str</code> with no allocation or formatting, while still supporting runtime <code>String</code> values if necessary.<p>Add a unit test that verifies the panic message.<h2 id=future-work>Future Work</h2><p>If we change the default error handling to use <code>Display</code> instead of <code>Debug</code>, and to use <code>ShortName</code> for the system name, the panic message could be further improved to:<pre style=color:#61676c;background-color:#fafafa><code><span>Encountered an error in system `res_system`: Parameter `Res&LTMissingResource>` failed validation: Resource does not exist
</span></code></pre><p>However, <code>BevyError</code> currently includes the backtrace in <code>Debug</code> but not <code>Display</code>, and I didn’t want to try to change that in this PR.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The core issue addressed in this PR stemmed from unhelpful error messages when systems attempted to access non-existent resources. Prior to these changes, a missing resource would produce a cryptic error containing only a boolean <code>skipped</code> flag, offering no context about which resource was missing or why the validation failed. This made debugging systems significantly more difficult than necessary.<p>The solution focused on enhancing the <code>SystemParamValidationError</code> structure to carry contextual information. By adding <code>message</code> and <code>param</code> fields using <code>Cow<'static, str></code>, the implementation achieves zero-cost static strings for common cases while retaining flexibility for dynamic messages. The key implementation steps were:<ol><li><strong>Error Structure Enhancement</strong>:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>SystemParamValidationError </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>skipped</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>bool</span><span>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>SystemParamValidationError </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>skipped</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>bool</span><span>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>message</span><span style=color:#61676ccc>: </span><span>Cow<</span><span style=color:#fa6e32>'static</span><span>, </span><span style=color:#fa6e32>str</span><span>>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>param</span><span style=color:#61676ccc>: </span><span>Cow<</span><span style=color:#fa6e32>'static</span><span>, </span><span style=color:#fa6e32>str</span><span>>,
</span><span>}
</span></code></pre><ol start=2><li><strong>Error Construction</strong>:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Updated validation code in extract_param.rs
</span><span style=color:#55b4d4;font-style:italic>Err</span><span>(SystemParamValidationError {
</span><span>    skipped</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>false</span><span style=color:#61676ccc>,
</span><span>    message</span><span style=color:#61676ccc>: </span><span style=color:#86b300>"Resource does not exist"</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()</span><span style=color:#61676ccc>,
</span><span>    param</span><span style=color:#61676ccc>: </span><span>std</span><span style=color:#ed9366>::</span><span>any</span><span style=color:#ed9366>::</span><span>type_name</span><span style=color:#ed9366>::</span><span>&LTP>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()</span><span style=color:#61676ccc>,
</span><span>})
</span></code></pre><ol start=3><li><strong>Display Implementation</strong>:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>impl </span><span>Display </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>SystemParamValidationError </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>fmt</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>f</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span>std</span><span style=color:#ed9366>::</span><span>fmt</span><span style=color:#ed9366>::</span><span>Formatter<'</span><span style=color:#ed9366>_</span><span>>) </span><span style=color:#61676ccc>-> </span><span>std</span><span style=color:#ed9366>::</span><span>fmt</span><span style=color:#ed9366>::</span><span>Result {
</span><span>        </span><span style=color:#f07171>write!</span><span>(
</span><span>            f,
</span><span>            </span><span style=color:#86b300>"Parameter `</span><span style=color:#ff8f40>{}</span><span style=color:#86b300>` failed validation: </span><span style=color:#ff8f40>{}</span><span style=color:#86b300>"</span><span style=color:#61676ccc>,
</span><span>            </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>param</span><span style=color:#61676ccc>, </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>message
</span><span>        )
</span><span>    }
</span><span>}
</span></code></pre><p>The implementation strategically uses <code>Cow</code> to avoid unnecessary allocations for static error messages while allowing runtime-generated messages when needed. This balances performance with diagnostic utility.<p>A unit test was added to verify the enhanced error messaging:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>should_panic</span><span>(expected </span><span style=color:#ed9366>= </span><span style=color:#86b300>"Resource does not exist"</span><span>)]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>missing_resource_panic</span><span>() {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> world </span><span style=color:#ed9366>= </span><span>World</span><span style=color:#ed9366>::</span><span>new()</span><span style=color:#61676ccc>;
</span><span>    world</span><span style=color:#ed9366>.</span><span style=color:#f07171>run_system</span><span>(res_system)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>The changes particularly impact Bevy’s ECS validation system, where parameter validation now carries sufficient context to identify problematic system parameters. This improvement directly addresses developer experience pain points when working with resource dependencies.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[SystemParamValidationError] --> B[Add message field]
</span><span>    A --> C[Add param field]
</span><span>    B --> D[Cow<'static, str> for efficiency]
</span><span>    C --> D
</span><span>    D --> E[Improved error display]
</span><span>    E --> F[Better developer experience]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ecs-src-system-system-param-rs-77-17><code>crates/bevy_ecs/src/system/system_param.rs</code> (+77/-17)</h3><ol><li>Enhanced error structure and display logic:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>SystemParamValidationError </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>skipped</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>bool</span><span>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>SystemParamValidationError </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>skipped</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>bool</span><span>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>message</span><span style=color:#61676ccc>: </span><span>Cow<</span><span style=color:#fa6e32>'static</span><span>, </span><span style=color:#fa6e32>str</span><span>>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>param</span><span style=color:#61676ccc>: </span><span>Cow<</span><span style=color:#fa6e32>'static</span><span>, </span><span style=color:#fa6e32>str</span><span>>,
</span><span>}
</span></code></pre><ol start=2><li>Updated Display implementation:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>impl </span><span>Display </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>SystemParamValidationError </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>fmt</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>f</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span>std</span><span style=color:#ed9366>::</span><span>fmt</span><span style=color:#ed9366>::</span><span>Formatter<'</span><span style=color:#ed9366>_</span><span>>) </span><span style=color:#61676ccc>-> </span><span>std</span><span style=color:#ed9366>::</span><span>fmt</span><span style=color:#ed9366>::</span><span>Result {
</span><span>        </span><span style=color:#f07171>write!</span><span>(
</span><span>            f,
</span><span>            </span><span style=color:#86b300>"Parameter `</span><span style=color:#ff8f40>{}</span><span style=color:#86b300>` failed validation: </span><span style=color:#ff8f40>{}</span><span style=color:#86b300>"</span><span style=color:#61676ccc>,
</span><span>            </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>param</span><span style=color:#61676ccc>, </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>message
</span><span>        )
</span><span>    }
</span><span>}
</span></code></pre><h3 id=crates-bevy-render-src-extract-param-rs-3-1><code>crates/bevy_render/src/extract_param.rs</code> (+3/-1)</h3><ol><li>Added contextual error information:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Updated error return
</span><span style=color:#55b4d4;font-style:italic>Err</span><span>(SystemParamValidationError {
</span><span>    skipped</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>false</span><span style=color:#61676ccc>,
</span><span>    message</span><span style=color:#61676ccc>: </span><span style=color:#86b300>"Resource does not exist"</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()</span><span style=color:#61676ccc>,
</span><span>    param</span><span style=color:#61676ccc>: </span><span>std</span><span style=color:#ed9366>::</span><span>any</span><span style=color:#ed9366>::</span><span>type_name</span><span style=color:#ed9366>::</span><span>&LTP>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()</span><span style=color:#61676ccc>,
</span><span>})
</span></code></pre><p>These changes work together to provide specific resource missing information while maintaining Bevy’s performance characteristics through careful use of zero-cost abstractions.<h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/std/borrow/enum.Cow.html target=_blank>Rust Cow type documentation</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/ecs/system-params/ target=_blank>Bevy ECS System Parameters</a><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/std/any/fn.type_name.html target=_blank>Type Name introspection in Rust</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/error-handling/ target=_blank>Error Handling in Bevy</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-03/pr_18593.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>