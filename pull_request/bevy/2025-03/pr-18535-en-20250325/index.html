<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18535 don't flip sprites twice
        
    </title><meta content="#18535 don't flip sprites twice" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-03/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-03-25</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-03/pr-18535-zh-cn-20250325>中文</a></div></div><div class=pr-content><h1 id=18535-don-t-flip-sprites-twice>#18535 don’t flip sprites twice</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: don’t flip sprites twice<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18535<li><strong>Author</strong>: mockersf<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: <code>C-Bug</code>, <code>A-Rendering</code>, <code>S-Ready-For-Final-Review</code><li><strong>Created</strong>: 2025-03-25T11:14:26Z<li><strong>Merged</strong>: 2025-03-25T15:22:17Z<li><strong>Merged By</strong>: cart</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>After #17041, sprite flipping doesn’t work</ul><h2 id=solution>Solution</h2><ul><li>Sprite flipping is applied twice: https://github.com/bevyengine/bevy/blob/b6ccc2a2a0fac4d1a8d717920166b32f39b40cd9/crates/bevy_sprite/src/render/mod.rs#L766-L773 https://github.com/bevyengine/bevy/blob/b6ccc2a2a0fac4d1a8d717920166b32f39b40cd9/crates/bevy_sprite/src/render/mod.rs#L792-L799<li>Keep one</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The PR addresses a regression in sprite rendering introduced by #17041, where sprite flipping functionality stopped working correctly. The root cause was identified as duplicate transformation logic being applied during the rendering process.<p>In Bevy’s sprite rendering pipeline, sprite flipping (both horizontal and vertical) is implemented through affine transformations. Prior to this fix, the flip transformations were being applied in two separate locations:<ol><li>During the initial transform matrix construction using <code>Affine3A::from_scale_rotation_translation</code><li>Later in the pipeline through explicit scaling factors in the transform calculation</ol><p>This double application resulted in the flip operations canceling each other out. For example, a horizontal flip (scale_x = -1) applied twice would result in scale_x = 1, making sprites appear unflipped.<p>The solution involved removing the secondary transformation logic while preserving the initial flip application. By consolidating the flip handling to a single location, the PR restores correct flipping behavior while maintaining the architectural improvements from #17041.<p>Key code changes show the removal of redundant scaling factors:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Double flip application
</span><span style=color:#fa6e32>let</span><span> scale </span><span style=color:#ed9366>= </span><span>Vec2</span><span style=color:#ed9366>::</span><span>new(
</span><span>    sprite</span><span style=color:#ed9366>.</span><span>flip_x </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>u8 </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32 </span><span style=color:#ed9366>* </span><span style=color:#ff8f40>2.0 </span><span style=color:#ed9366>- </span><span style=color:#ff8f40>1.0</span><span style=color:#61676ccc>,
</span><span>    sprite</span><span style=color:#ed9366>.</span><span>flip_y </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>u8 </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32 </span><span style=color:#ed9366>* </span><span style=color:#ff8f40>2.0 </span><span style=color:#ed9366>- </span><span style=color:#ff8f40>1.0</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Single flip application preserved in Affine3A construction
</span><span style=color:#fa6e32>let</span><span> transform </span><span style=color:#ed9366>= </span><span>Affine3A</span><span style=color:#ed9366>::</span><span>from_scale_rotation_translation(
</span><span>    Vec2</span><span style=color:#ed9366>::</span><span>new(
</span><span>        sprite</span><span style=color:#ed9366>.</span><span>flip_x </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>u8 </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32 </span><span style=color:#ed9366>* </span><span style=color:#ff8f40>2.0 </span><span style=color:#ed9366>- </span><span style=color:#ff8f40>1.0</span><span style=color:#61676ccc>,
</span><span>        sprite</span><span style=color:#ed9366>.</span><span>flip_y </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>u8 </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32 </span><span style=color:#ed9366>* </span><span style=color:#ff8f40>2.0 </span><span style=color:#ed9366>- </span><span style=color:#ff8f40>1.0</span><span style=color:#61676ccc>,
</span><span>    )</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend</span><span>(</span><span style=color:#ff8f40>1.0</span><span>)</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... rest of transform parameters
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><p>This fix demonstrates the importance of maintaining clear ownership of spatial transformations in rendering pipelines. The regression occurred when flip handling was moved during refactoring without fully removing the original implementation.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Sprite Flipping Logic] --> B[Transform Matrix Construction]
</span><span>    B --> C[Vertex Shader]
</span><span>    X[Redundant Scaling] -.-> C
</span><span>    PR18535 -->|Removes| X
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>File</strong>: <code>crates/bevy_sprite/src/render/mod.rs</code><br> <strong>Changes</strong>: Removed 9 lines of redundant scaling logic<p>Before:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let</span><span> scale </span><span style=color:#ed9366>= </span><span>Vec2</span><span style=color:#ed9366>::</span><span>new(
</span><span>    sprite</span><span style=color:#ed9366>.</span><span>flip_x </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>u8 </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32 </span><span style=color:#ed9366>* </span><span style=color:#ff8f40>2.0 </span><span style=color:#ed9366>- </span><span style=color:#ff8f40>1.0</span><span style=color:#61676ccc>,
</span><span>    sprite</span><span style=color:#ed9366>.</span><span>flip_y </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>u8 </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32 </span><span style=color:#ed9366>* </span><span style=color:#ff8f40>2.0 </span><span style=color:#ed9366>- </span><span style=color:#ff8f40>1.0</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span><span>transform </span><span style=color:#ed9366>=</span><span> transform </span><span style=color:#ed9366>* </span><span>Affine3A</span><span style=color:#ed9366>::</span><span>from_scale(scale</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend</span><span>(</span><span style=color:#ff8f40>1.0</span><span>))</span><span style=color:#61676ccc>;
</span></code></pre><p>After:<br> (This code block was completely removed)<p>These changes eliminate the secondary transformation application while preserving the primary flip handling in the initial transform matrix construction.<h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Affine_transformation target=_blank>Affine Transformations in Computer Graphics</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_sprite/latest/bevy_sprite/ target=_blank>Bevy Sprite Rendering Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://gpuweb.github.io/gpuweb/#pipelines target=_blank>WebGPU Shader Pipeline Overview</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-03/pr_18535.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>