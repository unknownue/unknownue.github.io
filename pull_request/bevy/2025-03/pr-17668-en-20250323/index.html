<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #17668 Skip camera look ups in queue uinodes
        
    </title><meta content="#17668 Skip camera look ups in queue uinodes" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-03/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-03-23</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-03/pr-17668-zh-cn-20250323>中文</a></div></div><div class=pr-content><h1 id=17668-skip-camera-look-ups-in-queue-uinodes>#17668 Skip camera look ups in queue uinodes</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Skip camera look ups in queue uinodes<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/17668<li><strong>Author</strong>: ickshonpe<li><strong>Status</strong>: MERGED<li><strong>Created</strong>: 2025-02-03T23:21:47Z<li><strong>Merged</strong>: 2025-02-04T08:14:22Z<li><strong>Merged By</strong>: cart</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p><code>queue_uinodes</code> looks up the <code>ExtractedView</code> for every extracted UI node, but there’s no need to look it up again if consecutive nodes have the same <code>extracted_camera_entity</code>.<h2 id=solution>Solution</h2><p>In queue uinodes reuse the previously looked up extracted view if the <code>extracted_camera_entity</code> doesn’t change<h2 id=showcase>Showcase</h2><pre style=color:#61676c;background-color:#fafafa><code><span>cargo run --example many_buttons --release --features "trace_tracy"
</span></code></pre><img alt=queue-ui-improvement src=https://github.com/user-attachments/assets/2f111837-8c2e-4a6d-94cd-3c3462c58bc9 width=521><p>yellow is this PR, red is main<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The PR addresses a performance bottleneck in Bevy’s UI rendering system. When processing UI nodes, the existing implementation performed redundant camera lookups for nodes sharing the same camera context. This optimization reduces CPU overhead by minimizing expensive lookups in a hot path.<p>In the original implementation, <code>queue_uinodes</code> iterated through extracted UI nodes and performed a camera lookup for <em>every</em> node using <code>extracted_camera_entity</code>. This became costly in scenes with many UI elements, as demonstrated by the <code>many_buttons</code> example showing significant frame time improvements (23% reduction in <code>queue_uinodes</code> time).<p>The solution introduces state tracking between iterations:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let mut</span><span> current_extracted_view </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>None</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let mut</span><span> current_camera_entity </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>None</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>for </span><span>(stack_index</span><span style=color:#61676ccc>,</span><span> extracted_node) </span><span style=color:#ed9366>in</span><span> extracted_uinodes</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>enumerate</span><span>() {
</span><span>    </span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(extracted_camera_entity) </span><span style=color:#ed9366>=</span><span> extracted_node</span><span style=color:#ed9366>.</span><span>extracted_camera_entity </span><span style=color:#fa6e32>else </span><span>{
</span><span>        </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>    }</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#fa6e32>if </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(extracted_camera_entity) </span><span style=color:#ed9366>!=</span><span> current_camera_entity {
</span><span>        current_extracted_view </span><span style=color:#ed9366>=</span><span> views</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(extracted_camera_entity)</span><span style=color:#61676ccc>;
</span><span>        current_camera_entity </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(extracted_camera_entity)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>    
</span><span>    </span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(extracted_view) </span><span style=color:#ed9366>=</span><span> current_extracted_view </span><span style=color:#fa6e32>else </span><span>{
</span><span>        </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>    }</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Processing continues with extracted_view...
</span><span>}
</span></code></pre><p>This stateful approach eliminates repeated <code>HashMap</code> lookups when consecutive nodes share the same camera. The cache invalidation strategy is simple but effective - only update when the camera entity changes.<p>Key implementation details:<ol><li>Uses Rust’s <code>Option</code> types for safe state management<li>Maintains two tracking variables to avoid double lookups<li>Preserves existing error handling through early continues<li>Requires no API changes or new dependencies</ol><p>The optimization demonstrates several important patterns:<ol><li><strong>Temporal locality exploitation</strong>: Groups operations by shared context<li><strong>Hot loop optimization</strong>: Reduces O(n) operations in critical paths<li><strong>Cache-friendly design</strong>: Uses entity identifiers as lightweight keys</ol><p>Performance testing with Tracy profiler showed measurable improvements, particularly in UI-heavy scenes. The approach balances memory usage (storing two additional pointers) against CPU savings from avoided lookups.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Process UI Node 1] --> B{Check Camera Entity}
</span><span>    B -->|Same as Previous| C[Reuse Cached View]
</span><span>    B -->|Different| D[Lookup New View]
</span><span>    C --> E[Render Processing]
</span><span>    D --> E
</span><span>    E --> F[Process Next Node]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ui-src-render-mod-rs-23-14><code>crates/bevy_ui/src/render/mod.rs</code> (+23/-14)</h3><p>The core optimization occurs in the UI node queueing logic:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>for </span><span>(stack_index</span><span style=color:#61676ccc>,</span><span> extracted_node) </span><span style=color:#ed9366>in</span><span> extracted_uinodes</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>enumerate</span><span>() {
</span><span>    </span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(extracted_camera_entity) </span><span style=color:#ed9366>=</span><span> extracted_node</span><span style=color:#ed9366>.</span><span>extracted_camera_entity </span><span style=color:#fa6e32>else </span><span>{
</span><span>        </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>    }</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(extracted_view) </span><span style=color:#ed9366>=</span><span> views</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(extracted_camera_entity) </span><span style=color:#fa6e32>else </span><span>{
</span><span>        </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>    }</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Processing...
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let mut</span><span> current_extracted_view </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>None</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let mut</span><span> current_camera_entity </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>None</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>for </span><span>(stack_index</span><span style=color:#61676ccc>,</span><span> extracted_node) </span><span style=color:#ed9366>in</span><span> extracted_uinodes</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>enumerate</span><span>() {
</span><span>    </span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(extracted_camera_entity) </span><span style=color:#ed9366>=</span><span> extracted_node</span><span style=color:#ed9366>.</span><span>extracted_camera_entity </span><span style=color:#fa6e32>else </span><span>{
</span><span>        </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>    }</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#fa6e32>if </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(extracted_camera_entity) </span><span style=color:#ed9366>!=</span><span> current_camera_entity {
</span><span>        current_extracted_view </span><span style=color:#ed9366>=</span><span> views</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(extracted_camera_entity)</span><span style=color:#61676ccc>;
</span><span>        current_camera_entity </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(extracted_camera_entity)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>    
</span><span>    </span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(extracted_view) </span><span style=color:#ed9366>=</span><span> current_extracted_view </span><span style=color:#fa6e32>else </span><span>{
</span><span>        </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>    }</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Processing...
</span><span>}
</span></code></pre><p>This change reduces hash map lookups from O(n) to O(m) where m ≤ n, particularly effective when UI nodes are batched by camera.<h2 id=further-reading>Further Reading</h2><ol><li>Bevy ECS System Query Documentation: https://bevyengine.org/learn/book/ecs/system-queries/<li>Rust HashMap Performance Characteristics: https://nnethercote.github.io/perf-book/collections.html#hash-maps<li>Data Locality Optimization Patterns: https://gameprogrammingpatterns.com/data-locality.html</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-03/pr_17668.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>