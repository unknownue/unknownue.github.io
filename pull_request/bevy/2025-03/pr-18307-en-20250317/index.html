<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18307 bevy_reflect: Add clone registrations project-wide
        
    </title><meta content="#18307 bevy_reflect: Add clone registrations project-wide" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-03/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-03-17</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-03/pr-18307-zh-cn-20250317>中文</a></div></div><div class=pr-content><h1 id=18307-bevy-reflect-add-clone-registrations-project-wide>#18307 bevy_reflect: Add clone registrations project-wide</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: bevy_reflect: Add clone registrations project-wide<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18307<li><strong>Author</strong>: MrGVSV<li><strong>Status</strong>: MERGED<li><strong>Created</strong>: 2025-03-14T06:24:37Z<li><strong>Merged</strong>: Not merged<li><strong>Merged By</strong>: N/A</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Now that #13432 has been merged, it’s important we update our reflected types to properly opt into this feature. If we do not, then this could cause issues for users downstream who want to make use of reflection-based cloning.<h2 id=solution>Solution</h2><p>This PR is broken into 4 commits:<ol><li><p>Add <code>#[reflect(Clone)]</code> on all types marked <code>#[reflect(opaque)]</code> that are also <code>Clone</code>. This is mandatory as these types would otherwise cause the cloning operation to fail for any type that contains it at any depth.</p><li><p>Update the reflection example to suggest adding <code>#[reflect(Clone)]</code> on opaque types.</p><li><p>Add <code>#[reflect(clone)]</code> attributes on all fields marked <code>#[reflect(ignore)]</code> that are also <code>Clone</code>. This prevents the ignored field from causing the cloning operation to fail.</p> <p>Note that some of the types that contain these fields are also <code>Clone</code>, and thus can be marked <code>#[reflect(Clone)]</code>. This makes the <code>#[reflect(clone)]</code> attribute redundant. However, I think it’s safer to keep it marked in the case that the <code>Clone</code> impl/derive is ever removed. I’m open to removing them, though, if people disagree.</p><li><p>Finally, I added <code>#[reflect(Clone)]</code> on all types that are also <code>Clone</code>. While not strictly necessary, it enables us to reduce the generated output since we can just call <code>Clone::clone</code> directly instead of calling <code>PartialReflect::reflect_clone</code> on each variant/field. It also means we benefit from any optimizations or customizations made in the <code>Clone</code> impl, including directly dereferencing <code>Copy</code> values and increasing reference counters.</p> <p>Along with that change I also took the liberty of adding any missing registrations that I saw could be applied to the type as well, such as <code>Default</code>, <code>PartialEq</code>, and <code>Hash</code>. There were hundreds of these to edit, though, so it’s possible I missed quite a few.</p></ol><p>That last commit is <strong><em>massive</em></strong>. There were nearly 700 types to update. So it’s recommended to review the first three before moving onto that last one.<p>Additionally, I can break the last commit off into its own PR or into smaller PRs, but I figured this would be the easiest way of doing it (and in a timely manner since I unfortunately don’t have as much time as I used to for code contributions).<h2 id=testing>Testing</h2><p>You can test locally with a <code>cargo check</code>:<pre style=color:#61676c;background-color:#fafafa><code><span>cargo check --workspace --all-features
</span></code></pre><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a systemic gap in Bevy’s reflection system following the introduction of reflection-based cloning in #13432. While the core cloning functionality was established, many types lacked proper registration for reflection-based cloning, creating potential failures for downstream users.<p>The implementation follows a layered approach across four commits:<ol><li><strong>Opaque Type Foundation</strong>: For types marked with <code>#[reflect(opaque)]</code> that implement <code>Clone</code>, explicit <code>#[reflect(Clone)]</code> registration was added. This is critical because opaque types don’t expose their internal structure to reflection, requiring explicit cloning directives. For example:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Clone</span><span style=color:#61676ccc>,</span><span> Reflect)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>reflect</span><span>(opaque</span><span style=color:#61676ccc>,</span><span> Clone)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>MyOpaqueType</span><span>(String)</span><span style=color:#61676ccc>;
</span></code></pre><ol start=2><li><p><strong>Example Guidance Update</strong>: The reflection example was modified to demonstrate proper usage patterns, ensuring new users adopt the correct patterns from the start.</p><li><p><strong>Ignored Field Handling</strong>: Fields marked with <code>#[reflect(ignore)]</code> but implementing <code>Clone</code> received <code>#[reflect(clone)]</code> attributes. This ensures these fields use their native <code>Clone</code> implementation rather than reflection-based cloning, preventing type mismatches. For instance:</p></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Reflect)]
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>MyStruct </span><span>{
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>reflect</span><span>(ignore</span><span style=color:#61676ccc>,</span><span> clone)]
</span><span>    hidden_data</span><span style=color:#61676ccc>: </span><span>Arc&LTTexture>,
</span><span>}
</span></code></pre><ol start=4><li><strong>System-wide Optimization</strong>: The final commit performs bulk registration of <code>Clone</code> and other common traits (<code>Default</code>, <code>PartialEq</code>, <code>Hash</code>) across ~700 types. This achieves two key benefits: <ul><li>Direct <code>Clone::clone</code> invocation instead of reflection-based cloning<li>Leverage optimized <code>Clone</code> implementations (including <code>Copy</code> types and smart pointer optimizations)</ul></ol><p>A critical technical decision was maintaining <code>#[reflect(clone)]</code> on fields even when their containing type implements <code>Clone</code>. This defensive programming approach guards against future removal of <code>Clone</code> implementations on container types.<p>The testing strategy focused on compile-time verification through <code>cargo check --workspace --all-features</code>, ensuring all trait registrations are syntactically valid without introducing runtime regressions.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Reflection Cloning System] --> B[Opaque Types]
</span><span>    A --> C[Ignored Fields]
</span><span>    A --> D[Clone Implementors]
</span><span>    B --> E[Explicit Clone Registration]
</span><span>    C --> F[Field-level Clone Directives]
</span><span>    D --> G[Direct Clone Optimization]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ol><li><strong><code>crates/bevy_input/src/gamepad.rs</code> (+83/-19)</strong></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Debug</span><span style=color:#61676ccc>,</span><span> Copy</span><span style=color:#61676ccc>,</span><span> Clone</span><span style=color:#61676ccc>,</span><span> PartialEq</span><span style=color:#61676ccc>,</span><span> Eq</span><span style=color:#61676ccc>,</span><span> Hash)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>GamepadButtonType</span><span>(pub GamepadButtonTypeName)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Debug</span><span style=color:#61676ccc>,</span><span> Copy</span><span style=color:#61676ccc>,</span><span> Clone</span><span style=color:#61676ccc>,</span><span> PartialEq</span><span style=color:#61676ccc>,</span><span> Eq</span><span style=color:#61676ccc>,</span><span> Hash</span><span style=color:#61676ccc>,</span><span> Reflect)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>reflect</span><span>(Debug</span><span style=color:#61676ccc>,</span><span> Clone</span><span style=color:#61676ccc>,</span><span> PartialEq</span><span style=color:#61676ccc>,</span><span> Hash)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>GamepadButtonType</span><span>(pub GamepadButtonTypeName)</span><span style=color:#61676ccc>;
</span></code></pre><p>Added reflection traits to gamepad-related types to enable proper cloning.<ol start=2><li><strong><code>crates/bevy_math/src/primitives/dim2.rs</code> (+37/-17)</strong></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added to multiple primitives:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Clone</span><span style=color:#61676ccc>,</span><span> Copy</span><span style=color:#61676ccc>,</span><span> Reflect)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>reflect</span><span>(Clone</span><span style=color:#61676ccc>,</span><span> Copy)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>Rectangle </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>half_size</span><span style=color:#61676ccc>:</span><span> Vec2,
</span><span>}
</span></code></pre><p>Ensured geometric primitives participate in reflection cloning through direct Copy optimizations.<ol start=3><li><strong><code>crates/bevy_input/src/mouse.rs</code> (+23/-7)</strong></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Updated MouseButton input handling:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Clone</span><span style=color:#61676ccc>,</span><span> Reflect)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>reflect</span><span>(Clone)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>MouseButtonInput </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>button</span><span style=color:#61676ccc>:</span><span> MouseButton,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>state</span><span style=color:#61676ccc>:</span><span> ButtonState,
</span><span>}
</span></code></pre><p>Enabled reflection cloning for input event types critical to UI interactions.<h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/features/reflection/ target=_blank>Bevy Reflection Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/std/clone/trait.Clone.html target=_blank>Rust Clone Trait Best Practices</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/pull/13432 target=_blank>Original Reflection Cloning PR #13432</a><li><a rel="noopener nofollow noreferrer" href=https://blog.logrocket.com/procedural-macros-rust/ target=_blank>Macro-based Reflection in Rust</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-03/pr_18307.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>