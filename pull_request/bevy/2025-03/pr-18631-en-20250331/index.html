<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18631 Fix mesh extraction for meshes without associated material.
        
    </title><meta content="#18631 Fix mesh extraction for meshes without associated material." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-03/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-03-31</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-03/pr-18631-zh-cn-20250331>中文</a></div></div><div class=pr-content><h1 id=18631-fix-mesh-extraction-for-meshes-without-associated-material>#18631 Fix mesh extraction for meshes without associated material.</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix mesh extraction for meshes without associated material.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18631<li><strong>Author</strong>: tychedelia<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: <code>C-Bug</code>, <code>A-Rendering</code>, <code>S-Ready-For-Final-Review</code><li><strong>Created</strong>: 2025-03-30T21:50:21Z<li><strong>Merged</strong>: 2025-04-01T14:22:17Z<li><strong>Merged By</strong>: cart</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Fixes #17986 Fixes #18608<h2 id=solution>Solution</h2><p>Guard against situations where an extracted mesh does not have an associated material. The way that mesh is dependent on the material api (although decoupled) here is a bit unfortunate and we might consider ways in the future to support these material features without this indirect dependency.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The core issue stemmed from Bevy’s mesh extraction system assuming all meshes would have associated materials. This created hard failures when rendering MeshletMesh entities without materials, particularly affecting shadow rendering pipelines. The problem manifested in two forms: panics during material ID lookups and incorrect shadow culling behavior.<p>The implementation challenge centered around the InstanceManager’s material management system. The original code used direct hash map lookups for material IDs without handling missing entries:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Original problematic lookup
</span><span style=color:#fa6e32>let</span><span> material_id </span><span style=color:#ed9366>= *</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>material_id_lookup</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#ed9366>&</span><span>material_id)</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><p>This approach caused panics when materials were missing. The fix required:<ol><li>Creating default material entries for missing cases<li>Ensuring consistent material ID generation<li>Propagating material presence information through the rendering pipeline</ol><p>The solution introduced a fallback mechanism using Rust’s entry API to handle missing materials gracefully:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Fixed implementation using entry API
</span><span style=color:#fa6e32>let</span><span> material_id </span><span style=color:#ed9366>= *</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>material_id_lookup
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>entry</span><span>(material_id)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>or_insert_with</span><span>(|| {
</span><span>        </span><span style=color:#fa6e32>let</span><span> id </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>next_material_id</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>next_material_id </span><span style=color:#ed9366>+= </span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>;
</span><span>        id
</span><span>    })</span><span style=color:#61676ccc>;
</span></code></pre><p>This change ensures missing materials receive unique IDs while maintaining existing material mappings. The system now tracks used material IDs separately from the lookup table, allowing proper cleanup of unused materials while preserving ID stability.<p>In the mesh extraction system (mesh.rs), additional guards were added to handle null material bindings:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Assumed material presence
</span><span style=color:#fa6e32>let</span><span> material_id </span><span style=color:#ed9366>=</span><span> material_bindings</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(material_handle)</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Fallback to default
</span><span style=color:#fa6e32>let</span><span> material_id </span><span style=color:#ed9366>=</span><span> material_bindings</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(material_handle)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_or</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>DEFAULT_MATERIAL_ID</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><p>This change prevents panics when materials are missing while maintaining rendering functionality. The DEFAULT_MATERIAL_ID serves as a temporary solution until a more robust material system can be implemented.<p>The implementation reveals an architectural tension between Bevy’s ECS design and renderer-specific data management. While materials and meshes are conceptually separate, the current rendering implementation creates an implicit dependency that this PR mitigates through defensive programming practices.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Mesh Extraction] --> B{Material Present?}
</span><span>    B -->|Yes| C[Use Existing Material ID]
</span><span>    B -->|No| D[Generate Default ID]
</span><span>    C --> E[Rendering Pipeline]
</span><span>    D --> E
</span><span>    E --> F[Instance Manager]
</span><span>    F --> G[GPU Buffers]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-pbr-src-meshlet-instance-manager-rs-14-8><code>crates/bevy_pbr/src/meshlet/instance_manager.rs</code> (+14/-8)</h3><p><strong>Purpose</strong>: Handle missing materials in mesh instance management<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Key change in material ID lookup
</span><span style=color:#ed9366>- </span><span style=color:#fa6e32>let</span><span> material_id </span><span style=color:#ed9366>= *</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>material_id_lookup</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#ed9366>&</span><span>material_id)</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#ed9366>+ </span><span style=color:#fa6e32>let</span><span> material_id </span><span style=color:#ed9366>= *</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>material_id_lookup
</span><span style=color:#ed9366>+     .</span><span style=color:#f07171>entry</span><span>(material_id)
</span><span style=color:#ed9366>+     .</span><span style=color:#f07171>or_insert_with</span><span>(|| {
</span><span style=color:#ed9366>+         </span><span style=color:#fa6e32>let</span><span> id </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>next_material_id</span><span style=color:#61676ccc>;
</span><span style=color:#ed9366>+         </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>next_material_id </span><span style=color:#ed9366>+= </span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>;
</span><span style=color:#ed9366>+</span><span>         id
</span><span style=color:#ed9366>+     </span><span>})</span><span style=color:#61676ccc>;
</span></code></pre><p>This change ensures missing materials get unique IDs rather than causing panics.<h3 id=crates-bevy-pbr-src-render-mesh-rs-13-7><code>crates/bevy_pbr/src/render/mesh.rs</code> (+13/-7)</h3><p><strong>Purpose</strong>: Add fallback for missing materials during mesh extraction<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added default material handling
</span><span style=color:#ed9366>+ </span><span style=color:#fa6e32>const </span><span style=color:#ff8f40>DEFAULT_MATERIAL_ID</span><span style=color:#61676ccc>:</span><span> MaterialBindingId </span><span style=color:#ed9366>=</span><span> MaterialBindingId(</span><span style=color:#ff8f40>0</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Modified material lookup
</span><span style=color:#ed9366>- </span><span style=color:#fa6e32>let</span><span> material_id </span><span style=color:#ed9366>=</span><span> material_bindings</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(material_handle)</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#ed9366>+ </span><span style=color:#fa6e32>let</span><span> material_id </span><span style=color:#ed9366>=</span><span> material_bindings</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(material_handle)
</span><span style=color:#ed9366>+     .</span><span style=color:#f07171>unwrap_or</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>DEFAULT_MATERIAL_ID</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><p>This prevents extraction failures when materials are missing while maintaining render pipeline compatibility.<h2 id=further-reading>Further Reading</h2><ol><li>Bevy Material System Documentation: https://bevyengine.org/learn/book/materials/<li>Rust HashMap Entry API: https://doc.rust-lang.org/std/collections/hash_map/struct.HashMap.html#method.entry<li>ECS Design Patterns: https://github.com/bevyengine/bevy/discussions/4523<li>Defensive Programming in Rust: https://doc.rust-lang.org/book/ch09-00-error-handling.html</ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-03/pr_18631.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>