<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18636 Fix mesh tag feature for 2d.
        
    </title><meta content="#18636 Fix mesh tag feature for 2d." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-03/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-03-31</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-03/pr-18636-zh-cn-20250331>中文</a></div></div><div class=pr-content><h1 id=18636-fix-mesh-tag-feature-for-2d>#18636 Fix mesh tag feature for 2d.</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix mesh tag feature for 2d.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18636<li><strong>Author</strong>: tychedelia<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: <code>C-Bug</code>, <code>A-Rendering</code>, <code>S-Ready-For-Final-Review</code><li><strong>Created</strong>: 2025-03-30T23:53:14Z<li><strong>Merged</strong>: Not merged<li><strong>Merged By</strong>: N/A</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Fixes #18564<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The PR addresses a critical gap in Bevy’s 2D rendering system where mesh tags weren’t accessible in shaders. Mesh tags enable custom rendering logic like selective effects and object identification, particularly evident in the 2D gizmos example that needed to filter meshes by tag. While 3D pipelines already exposed this functionality through <code>mesh.wgsl</code>, the 2D equivalent was missing the required plumbing.<p>The core issue stemmed from incomplete data exposure in the 2D mesh shader infrastructure. The <code>Mesh2d</code> struct definition lacked the <code>tag</code> field present in its 3D counterpart, and no shader function existed to retrieve this value. This prevented 2D shaders from accessing mesh tags despite the underlying data being available in Rust code.<p>The solution involved two coordinated changes in WGSL shader code. First, the <code>Mesh2d</code> struct in <code>mesh2d_types.wgsl</code> received a new <code>tag: u32</code> field to store the identifier. Second, <code>mesh2d_functions.wgsl</code> gained a <code>get_tag</code> helper function that accesses this field through the mesh instance index:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Added to mesh2d_functions.wgsl
</span><span>fn get_tag(instance_index: u32) -> u32 {
</span><span>    return mesh[instance_index].tag;
</span><span>}
</span></code></pre><p>This implementation mirrors 3D’s approach in <code>mesh_functions.wgsl</code> while maintaining 2D’s separate type definitions. The changes maintain consistency with Bevy’s rendering architecture where mesh data is exposed through structured buffer access and helper functions.<p>The fix required careful consideration of data alignment and buffer layouts. The <code>Mesh2d</code> struct already contained packed matrix data and flags field, but the addition of the 4-byte <code>tag</code> field didn’t affect existing alignment due to WGSL’s struct padding rules. This allowed adding the new field without breaking existing shaders or requiring data layout changes on the Rust side.<p>These changes unblock 2D rendering features that require tag-based filtering, like the gizmo highlighting system. Developers can now access mesh tags in 2D fragment shaders using the same patterns established in 3D pipelines:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>#import bevy_sprite::mesh2d_functions::get_tag
</span><span>
</span><span>@fragment
</span><span>fn fragment(in: VertexOutput) -> @location(0) vec4&LTf32> {
</span><span>    let tag = get_tag(in.instance_index);
</span><span>    // Use tag for custom rendering logic
</span><span>}
</span></code></pre><p>The implementation demonstrates Bevy’s pattern of maintaining parallel implementations for 2D and 3D rendering systems while sharing core concepts. Future improvements could consider consolidating common functionality, but this fix prioritizes immediate compatibility and minimal change surface.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[Mesh2d Struct] --> B[tag Field Added]
</span><span>    C[Shader Functions] --> D[get_tag Implementation]
</span><span>    B --> E[2D Shaders]
</span><span>    D --> E
</span><span>    E --> F[Tag-Based Rendering]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=file-crates-bevy-sprite-src-mesh2d-mesh2d-types-wgsl>File: <code>crates/bevy_sprite/src/mesh2d/mesh2d_types.wgsl</code></h3><p>Added <code>tag: u32</code> field to <code>Mesh2d</code> struct:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>struct Mesh2d {
</span><span>    ...
</span><span>    tag: u32,
</span><span>};
</span></code></pre><p>This stores the mesh tag value in each instance’s data structure, making it accessible in shaders.<h3 id=file-crates-bevy-sprite-src-mesh2d-mesh2d-functions-wgsl>File: <code>crates/bevy_sprite/src/mesh2d/mesh2d_functions.wgsl</code></h3><p>Added tag accessor function:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>fn get_tag(instance_index: u32) -> u32 {
</span><span>    return mesh[instance_index].tag;
</span><span>}
</span></code></pre><p>Provides shaders with a standard way to retrieve the tag value for a given mesh instance.<h2 id=further-reading>Further Reading</h2><ul><li>WGSL Struct Layout Rules: https://gpuweb.github.io/gpuweb/wgsl/#structure-layout-rules<li>Bevy Rendering Architecture: https://bevyengine.org/learn/book/getting-started/rendering/<li>Mesh Tags in 3D: See <code>crates/bevy_pbr/src/render/mesh_functions.wgsl</code></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-03/pr_18636.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>