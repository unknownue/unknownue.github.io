<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18326 Use 4-byte LightmapSlabIndex for batching instead of 16-byte AssetId<Image>
        
    </title><meta content="#18326 Use 4-byte LightmapSlabIndex for batching instead of 16-byte AssetId<Image>" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-03/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-03-15</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-03/pr-18326-zh-cn-20250315>中文</a></div></div><div class=pr-content><h1 id=18326-use-4-byte-lightmapslabindex-for-batching-instead-of-16-byte-assetid>#18326 Use 4-byte LightmapSlabIndex for batching instead of 16-byte AssetId<image> <h2 id=basic-information>Basic Information</h2> <ul><li><strong>Title</strong>: Use 4-byte LightmapSlabIndex for batching instead of 16-byte AssetId<image> <li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18326</li> <li><strong>Author</strong>: superdump</li> <li><strong>Status</strong>: MERGED</li> <li><strong>Created</strong>: 2025-03-15T11:33:44Z</li> <li><strong>Merged</strong>: 2025-03-15T14:22:10Z</li> <li><strong>Merged By</strong>: cart</li> <h2 id=description-translation>Description Translation</h2> <p>Less data accessed and compared gives better batching performance.</p> <h1 id=objective>Objective</h1> <ul><li>Use a smaller id to represent the lightmap in batch data to enable a faster implementation of draw streams.<li>Improve batching performance for 3D sorted render phases.</ul> <h2 id=solution>Solution</h2> <ul><li>3D batching can use <code>LightmapSlabIndex</code> (a <code>NonMaxU32</code> which is 4 bytes) instead of the lightmap <code>AssetId&LTImage></code> (an enum where the largest variant is a 16-byte UUID) to discern the ability to batch.</ul> <h2 id=testing>Testing</h2> <p>Tested main (yellow) vs this PR (red) on an M4 Max using the <code>many_cubes</code> example with <code>WGPU_SETTINGS_PRIO=webgl2</code> to avoid GPU-preprocessing, and modifying the materials in <code>many_cubes</code> to have <code>AlphaMode::Blend</code> so that they would rely on the less efficient sorted render phase batching. <img alt="Screenshot_2025-03-15_at_12 17 21" src=https://github.com/user-attachments/assets/14709bd3-6d06-40fb-aa51-e1d2d606ebe3 width=1500> A 44.75us or 7.5% reduction in median execution time of the batch and prepare sorted render phase system for the <code>Transparent3d</code> phase (handling 160k cubes).</p> <hr> <h2 id=migration-guide>Migration Guide</h2> <ul><li>Changed: <code>RenderLightmap::new()</code> no longer takes an <code>AssetId&LTImage></code> argument for the asset id of the lightmap image.</ul> <h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2> <p>The PR addresses a performance bottleneck in Bevy’s 3D rendering pipeline when processing large numbers of transparent objects. The core issue stemmed from using 16-byte AssetId<image> identifiers for lightmap comparison during batching. This large data type caused two main problems: <ol><li>Increased memory bandwidth usage during batch comparisons<li>Reduced cache efficiency when processing batches</ol> <p>The solution replaces AssetId<image> with a custom LightmapSlabIndex type (NonMaxU32), reducing the comparison size by 75%. This optimization leverages several key insights: <ul><li>Lightmaps are already managed through a slab allocator, allowing safe index-based referencing<li>NonMaxU32 provides compact storage while maintaining type safety<li>Batch comparison becomes a simple integer check instead of deep struct comparison</ul> <p>In the implementation, the team modified the batching logic to use lightmap indices instead of full asset IDs. This required changes to both the lightmap management system and the mesh rendering components. The key modification appears in the batch preparation code where lightmap comparisons now operate on 4-byte values instead of 16-byte UUIDs.</p> <p>The performance impact was measured using a stress test with 160,000 transparent cubes. Benchmarks showed a 7.5% reduction in median execution time for the batch preparation system, translating to 44.75μs savings per frame. This improvement directly results from:</p> <ul><li>Reduced data movement during batch comparisons<li>Better cache utilization in hot loops<li>Simplified equality checks between batches</ul> <p>An important trade-off was introducing an indirect lookup step through the slab index, but this cost is offset by the gains in batch processing efficiency. The migration path remains straightforward as the changes are contained within internal rendering systems.</p> <h2 id=visual-representation>Visual Representation</h2> <pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Transparent3d Phase] --> B[Batch Preparation]
</span><span>    B --> C{Compare Lightmap IDs}
</span><span>    C -->|16-byte AssetId&LTImage>| D[Slower Batching]
</span><span>    C -->|4-byte LightmapSlabIndex| E[Faster Batching]
</span><span>    E --> F[Draw Command Generation]
</span></code></pre> <h2 id=key-files-changed>Key Files Changed</h2> <ol><li><code>crates/bevy_pbr/src/lightmap/mod.rs</code></ol> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Removed AssetId parameter from RenderLightmap construction
</span><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>RenderLightmap</span><span style=color:#ed9366>::</span><span>new(lightmap</span><span style=color:#ed9366>.</span><span>image</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#61676ccc>,</span><span> lightmap_asset</span><span style=color:#ed9366>.</span><span>id)
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>RenderLightmap</span><span style=color:#ed9366>::</span><span>new(lightmap</span><span style=color:#ed9366>.</span><span>image</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>())
</span></code></pre> <ol start=2><li><code>crates/bevy_pbr/src/render/mesh.rs</code></ol> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Changed batch key from AssetId to LightmapSlabIndex
</span><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub</span><span> lightmap</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTAssetId&LTImage>></span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub</span><span> lightmap</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTLightmapSlabIndex></span><span style=color:#61676ccc>,
</span></code></pre> <p>These changes propagate through the batching system where lightmap comparisons now use the compact index instead of full asset IDs. The slab index is derived during lightmap preparation and cached for efficient access.</p> <h2 id=further-reading>Further Reading</h2> <ol><li>Bevy’s ECS and rendering architecture: https://bevyengine.org/learn/book/introduction/<li>Slab allocation patterns: https://docs.rs/slab/latest/slab/<li>NonMax integer optimizations: https://doc.rust-lang.org/std/num/struct.NonZeroU32.html<li>WebGPU performance best practices: https://gpuweb.github.io/gpuweb/#performance-considerations</ol>    <div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-03/pr_18326.patch id=patch-info style=display:none></div>  <div class=bottom-spacer></div> 