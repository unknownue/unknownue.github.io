<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #15441 Remove render_resource_wrapper
        
    </title><meta content="#15441 Remove render_resource_wrapper" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-03/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-03-12</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-03/pr-15441-zh-cn-20250312>中文</a></div></div><div class=pr-content><h1 id=15441-remove-render-resource-wrapper>#15441 Remove render_resource_wrapper</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Remove render_resource_wrapper<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/15441<li><strong>Author</strong>: bes<li><strong>Status</strong>: MERGED<li><strong>Created</strong>: 2024-09-26T09:59:08Z<li><strong>Merged</strong>: Not merged<li><strong>Merged By</strong>: N/A</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Remove all uses of render_resource_wrapper.<li>Make it easier to share a <code>wgpu::Device</code> between Bevy and application code.</ul><h2 id=solution>Solution</h2><p>Removed the <code>render_resource_wrapper</code> macro.<p>To improve the <code>RenderCreation:: Manual </code> API, <code>ErasedRenderDevice</code> was replaced by <code>Arc</code>. Unfortunately I had to introduce one more usage of <code>WgpuWrapper</code> which seems like an unwanted constraint on the caller.<h2 id=testing>Testing</h2><ul><li><p>Did you test these changes? If so, how?</p> <ul><li>Ran <code>cargo test</code>.<li>Ran a few examples.<li>Used <code>RenderCreation::Manual</code> in my own project<li>Exercised <code>RenderCreation::Automatic</code> through examples</ul><li><p>Are there any parts that need more testing?</p> <ul><li>No</ul><li><p>How can other people (reviewers) test your changes? Is there anything specific they need to know?</p> <ul><li>Run examples<li>Use <code>RenderCreation::Manual</code> in their own project</ul></ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The PR addresses technical debt in Bevy’s rendering infrastructure by eliminating the <code>render_resource_wrapper</code> macro, a legacy pattern that complicated resource management and hindered device sharing. The core problem stemmed from how Bevy managed GPU resources through generated wrapper types, which created unnecessary abstraction layers and made it difficult to integrate external <code>wgpu::Device</code> instances.<p>The solution required a systematic removal of the macro while maintaining type safety and API compatibility. Key changes included:<ol><li><p><strong>Macro Elimination</strong>: The <code>render_resource_wrapper!</code> macro in <code>resource_macros.rs</code> was fully removed (-149 LOC), eliminating generated wrapper types in favor of explicit implementations.</p><li><p><strong>Concrete Type Adoption</strong>: Resources like <code>Texture</code> and pipeline objects transitioned to manual <code>RenderResourceWrapper</code> implementations. For example in <code>texture.rs</code>:</p></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before (macro-generated):
</span><span style=color:#f07171>render_resource_wrapper!</span><span>(</span><span style=color:#fa6e32>pub</span><span> Texture</span><span style=color:#61676ccc>, </span><span>wgpu</span><span style=color:#ed9366>::</span><span>Texture)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After (explicit implementation):
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>Texture </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>value</span><span style=color:#61676ccc>: </span><span>WgpuWrapper&LTwgpu</span><span style=color:#ed9366>::</span><span>Texture>,
</span><span>}
</span><span>
</span><span style=color:#fa6e32>impl </span><span>RenderResourceWrapper </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>Texture </span><span>{
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Wrapped </span><span style=color:#ed9366>= </span><span>wgpu</span><span style=color:#ed9366>::</span><span>Texture</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...Deref/DerefMut implementations...
</span><span>}
</span></code></pre><ol start=3><li><strong>Device Sharing Improvements</strong>: The <code>RenderCreation::Manual</code> API replaced <code>ErasedRenderDevice</code> with standard Rust smart pointers:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>ErasedRenderDevice</span><span style=color:#ed9366>::</span><span>new(device)
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>Arc</span><span style=color:#ed9366>::</span><span>new(WgpuWrapper</span><span style=color:#ed9366>::</span><span>new(device))
</span></code></pre><p>This shift to <code>Arc&LTwgpu::Device></code> enables straightforward device sharing between Bevy and external code while maintaining thread safety. The trade-off was introducing an additional <code>WgpuWrapper</code> layer to handle device lifecycle management, creating a minor API constraint for manual device creation scenarios.<p>The changes demonstrate several engineering principles:<ul><li>Preferring explicit implementations over macro magic for better debuggability<li>Using standard Rust types (Arc) instead of custom abstractions<li>Maintaining backward compatibility through careful API surface adjustments</ul><p>Testing validated both automatic device creation (existing examples) and manual integration scenarios. The removal of 149 lines of macro code simplifies the codebase while making low-level device management more accessible to advanced users.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[render_resource_wrapper Macro] -->|Generated| B[Wrapper Types]
</span><span>    B --> C[Texture/Pipeline Resources]
</span><span>    D[RenderDevice Creation] -->|Used| E[ErasedRenderDevice]
</span><span>    PR((PR #15441)) -->|Removes| A
</span><span>    PR -->|Replaces| E --> F[Arc&LTwgpu::Device>]
</span><span>    PR -->|Implements| G[Explicit Wrapper Structs]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ol><li><p><code>crates/bevy_render/src/render_resource/resource_macros.rs</code> (+0/-149)</p> <ul><li>Complete removal of the macro system that generated resource wrappers<li>Eliminated indirect code generation in favor of explicit implementations</ul><li><p><code>crates/bevy_render/src/render_resource/texture.rs</code> (+13/-15)</p></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before (macro usage):
</span><span style=color:#f07171>render_resource_wrapper!</span><span>(</span><span style=color:#fa6e32>pub</span><span> Texture</span><span style=color:#61676ccc>, </span><span>wgpu</span><span style=color:#ed9366>::</span><span>Texture)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After (manual implementation):
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>Texture </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>value</span><span style=color:#61676ccc>: </span><span>WgpuWrapper&LTwgpu</span><span style=color:#ed9366>::</span><span>Texture>,
</span><span>}
</span><span>
</span><span style=color:#fa6e32>impl </span><span>RenderResourceWrapper </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>Texture </span><span>{
</span><span>    </span><span style=color:#fa6e32>type </span><span style=color:#399ee6>Wrapped </span><span style=color:#ed9366>= </span><span>wgpu</span><span style=color:#ed9366>::</span><span>Texture</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...Deref implementations...
</span><span>}
</span></code></pre><ol start=3><li><code>crates/bevy_render/src/renderer/render_device.rs</code> (+9/-10)</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before (custom erased type):
</span><span>RenderCreation</span><span style=color:#ed9366>::</span><span>Manual(ErasedRenderDevice</span><span style=color:#ed9366>::</span><span>new(device))
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After (standard Arc):
</span><span>RenderCreation</span><span style=color:#ed9366>::</span><span>Manual(Arc</span><span style=color:#ed9366>::</span><span>new(WgpuWrapper</span><span style=color:#ed9366>::</span><span>new(device)))
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://wgpu.rs/book/architecture/resource-management.html target=_blank>wgpu Resource Management</a><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/std/sync/struct.Arc.html target=_blank>Rust Arc Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/implementation/render-architecture/ target=_blank>Bevy Render Architecture</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-03/pr_15441.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>