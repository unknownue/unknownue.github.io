<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18419 Gltf handle missing bindposes
        
    </title><meta content="#18419 Gltf handle missing bindposes" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-03/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-03-19</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-03/pr-18419-zh-cn-20250319>中文</a></div></div><div class=pr-content><h1 id=18419-gltf-handle-missing-bindposes>#18419 Gltf handle missing bindposes</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Gltf handle missing bindposes<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18419<li><strong>Author</strong>: robtfm<li><strong>Status</strong>: MERGED<li><strong>Created</strong>: 2025-03-19T11:59:16Z<li><strong>Merged</strong>: 2025-03-20T08:14:22Z<li><strong>Merged By</strong>: cart</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>correctly load gltfs without explicit bindposes<h2 id=solution>Solution</h2><p>use identity matrices if bindposes are not found.<p>note: currently does nothing, as gltfs without explicit explicit bindposes fail to load, see <a rel="noopener nofollow noreferrer" href=https://github.com/gltf-rs/gltf/pull/449 target=_blank>https://github.com/gltf-rs/gltf/pull/449</a><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The PR addresses a critical gap in Bevy’s GLTF loader implementation regarding skinning support. When loading 3D models using skeletal animation, inverse bind pose matrices (bindposes) are essential for proper skin deformation. However, some GLTF files omit these matrices, particularly when exported from certain tools.<p>The core issue stemmed from Bevy’s strict expectation of explicit bindpose data. When absent, the loader would fail entirely, preventing valid models from loading. The solution implements a fallback mechanism using identity matrices when bindposes are missing, maintaining compatibility while waiting for upstream fixes in the gltf-rs parser.<p>Key implementation details in <code>crates/bevy_gltf/src/loader/mod.rs</code> show how the skin processing logic was modified:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before (simplified)
</span><span style=color:#fa6e32>let</span><span> inverse_bindposes </span><span style=color:#ed9366>=</span><span> skin</span><span style=color:#ed9366>.</span><span style=color:#f07171>inverse_bind_matrices</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// Would panic if missing
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After
</span><span style=color:#fa6e32>let</span><span> inverse_bindposes </span><span style=color:#ed9366>=</span><span> skin</span><span style=color:#ed9366>.</span><span style=color:#f07171>inverse_bind_matrices</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|</span><span style=color:#ff8f40>acc</span><span>| {
</span><span>    </span><span style=color:#f07171>load_buffer</span><span>(acc</span><span style=color:#61676ccc>,</span><span> buffers</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>blob</span><span style=color:#61676ccc>,</span><span> load_context)
</span><span>})</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_or_else</span><span>(|| </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(</span><span style=color:#f07171>vec!</span><span>[Mat4</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>IDENTITY</span><span style=color:#61676ccc>;</span><span> skin</span><span style=color:#ed9366>.</span><span style=color:#f07171>joints</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>count</span><span>()]))</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span></code></pre><p>This change:<ol><li>Uses <code>map</code> to handle existing bindpose data<li>Implements <code>unwrap_or_else</code> fallback to identity matrices<li>Maintains joint count compatibility through <code>skin.joints().count()</code></ol><p>The technical decision to use identity matrices (Mat4::IDENTITY) serves as a reasonable default since these matrices represent no transformation. This allows models to load with basic functionality while artists can address missing bindposes in their assets.<p>However, the solution’s effectiveness was initially blocked by an upstream limitation in gltf-rs (tracked in <a rel="noopener nofollow noreferrer" href=https://github.com/gltf-rs/gltf/pull/449 target=_blank>gltf-rs#449</a>). The Bevy implementation proactively handles the data availability while remaining compatible with future parser updates.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[GLTF Loader] --> B{Check Bindposes}
</span><span>    B -->|Present| C[Use Provided Matrices]
</span><span>    B -->|Missing| D[Generate Identity Matrices]
</span><span>    D --> E[Create SkinnedMesh]
</span><span>    C --> E
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-gltf-src-loader-mod-rs-4-3><code>crates/bevy_gltf/src/loader/mod.rs</code> (+4/-3)</h3><p><strong>Purpose</strong>: Implement fallback for missing inverse bind matrices<p>Key changes:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before
</span><span style=color:#fa6e32>let</span><span> inverse_bindposes </span><span style=color:#ed9366>=</span><span> skin</span><span style=color:#ed9366>.</span><span style=color:#f07171>inverse_bind_matrices</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|</span><span style=color:#ff8f40>acc</span><span>| {
</span><span>    </span><span style=color:#f07171>load_buffer</span><span>(acc</span><span style=color:#61676ccc>,</span><span> buffers</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>blob</span><span style=color:#61676ccc>,</span><span> load_context)
</span><span>})</span><span style=color:#ed9366>.</span><span style=color:#f07171>transpose</span><span>()</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After
</span><span style=color:#fa6e32>let</span><span> inverse_bindposes </span><span style=color:#ed9366>=</span><span> skin</span><span style=color:#ed9366>.</span><span style=color:#f07171>inverse_bind_matrices</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|</span><span style=color:#ff8f40>acc</span><span>| {
</span><span>    </span><span style=color:#f07171>load_buffer</span><span>(acc</span><span style=color:#61676ccc>,</span><span> buffers</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>blob</span><span style=color:#61676ccc>,</span><span> load_context)
</span><span>})</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_or_else</span><span>(|| </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(</span><span style=color:#f07171>vec!</span><span>[Mat4</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>IDENTITY</span><span style=color:#61676ccc>;</span><span> skin</span><span style=color:#ed9366>.</span><span style=color:#f07171>joints</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>count</span><span>()]))</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span></code></pre><p>This modification:<ol><li>Replaces mandatory <code>.transpose()</code> with fallback handling<li>Uses <code>unwrap_or_else</code> to generate identity matrices matching joint count<li>Maintains error propagation through <code>?</code> operator</ol><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://www.khronos.org/registry/glTF/specs/2.0/glTF-2.0.html#skins target=_blank>glTF Skinning Specification</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/3d-rendering/advanced/3d-skinning/ target=_blank>Bevy Skinning Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/gltf-rs/gltf/pull/449 target=_blank>gltf-rs PR #449</a> - Upstream parser fix enabling this feature<li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Transformation_matrix target=_blank>Matrix Transformations in Computer Graphics</a> - Background on identity matrices</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-03/pr_18419.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>