<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18530 Fix relationship macro for multiple named members fields
        
    </title><meta content="#18530 Fix relationship macro for multiple named members fields" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-03/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-03-27</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-03/pr-18530-zh-cn-20250327>中文</a></div></div><div class=pr-content><h1 id=18530-fix-relationship-macro-for-multiple-named-members-fields>#18530 Fix relationship macro for multiple named members fields</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix relationship macro for multiple named members fields<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18530<li><strong>Author</strong>: krunchington<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: <code>C-Bug</code>, <code>A-ECS</code>, <code>S-Ready-For-Final-Review</code>, <code>D-Straightforward</code>, <code>D-Macros</code><li><strong>Created</strong>: 2025-03-25T04:21:50Z<li><strong>Merged</strong>: 2025-03-26T15:22:18Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Fixes #18466<h2 id=solution>Solution</h2><p>Updated the macro generation pattern to place the comma in the correct place in the pattern.<h2 id=testing>Testing</h2><ul><li>Tried named and unnamed fields in combination, and used rust expand macro tooling to see the generated code and verify its correctness (see screenshots in example below)</ul><hr><h2 id=showcase>Showcase</h2><p>Screenshot showing expanded macro with multiple named fields <img alt=image src=https://github.com/user-attachments/assets/7ecd324c-10ba-4b23-9b53-b94da03567d3><p>Screenshot showing expanded macro with single unnamed field <img alt=image src=https://github.com/user-attachments/assets/be72f061-5f07-4d19-b5f6-7ff6c35ec679><h2 id=migration-guide>Migration Guide</h2><p>n/a<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The PR addresses a specific issue in Bevy’s ECS macros where deriving relationship components with multiple named fields would generate invalid Rust syntax. The root problem stemmed from incorrect comma placement in macro-generated code when handling structs with multiple fields.<p>In Bevy’s relationship system, the <code>#[derive(Component)]</code> macro generates boilerplate code for managing entity relationships. The bug manifested when developers tried to create relationship components with multiple named fields, resulting in syntax errors like trailing commas in struct initialization. This violated Rust’s syntax rules and broke compilation for valid use cases.<p>The solution involved modifying the procedural macro’s code generation logic in <code>component.rs</code>. The original implementation used a pattern that incorrectly placed commas when generating field initializations. By restructuring the token generation sequence, the PR ensures commas only appear between fields, not after the last one.<p>Key changes occurred in the <code>derive_relationship</code> function’s code generation logic. The macro now uses a more precise pattern for field initialization:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before (simplified):
</span><span style=color:#f07171>quote! </span><span>{ </span><span style=color:#ed9366>#</span><span>field_name</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>#</span><span>field_value</span><span style=color:#61676ccc>, </span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After (simplified):
</span><span style=color:#f07171>quote! </span><span>{ </span><span style=color:#ed9366>#</span><span>field_name</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>#</span><span>field_value }
</span></code></pre><p>This adjustment prevents trailing commas in single-field cases while maintaining proper separation for multiple fields. The PR adds explicit comma tokens between fields rather than appending them to each field’s generation.<p>The implementation maintains backward compatibility while expanding functionality. Developers can now create relationship components with mixed field types:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>relationship</span><span>(relationship_target </span><span style=color:#ed9366>=</span><span> Children)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>ChildOf </span><span>{
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>relationship</span><span>]
</span><span>    </span><span style=color:#fa6e32>pub </span><span>parent</span><span style=color:#61676ccc>:</span><span> Entity,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>timestamp</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u64</span><span>,
</span><span>    internal</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u8</span><span>,
</span><span>}</span><span style=color:#61676ccc>;
</span></code></pre><p>The testing approach leveraged Rust’s macro expansion inspection tools to verify generated code correctness. Screenshots in the PR demonstrate proper code generation for both single unnamed fields and multiple named fields.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Macro Input] --> B[Parser]
</span><span>    B --> C[Code Generator]
</span><span>    C --> D{Multiple Fields?}
</span><span>    D -->|Yes| E[Generate comma-separated fields]
</span><span>    D -->|No| F[Generate single field without comma]
</span><span>    E --> G[Valid Rust Output]
</span><span>    F --> G
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=file-crates-bevy-ecs-macros-src-component-rs>File: <code>crates/bevy_ecs/macros/src/component.rs</code></h3><p><strong>Changes</strong>: Fixed comma placement in generated field initializations<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> fields </span><span style=color:#ed9366>=</span><span> fields</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|</span><span style=color:#ff8f40>field</span><span>| {
</span><span>    </span><span style=color:#f07171>quote! </span><span>{ </span><span style=color:#ed9366>#</span><span>field_name</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>#</span><span>field_value</span><span style=color:#61676ccc>, </span><span>}
</span><span>})</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> fields </span><span style=color:#ed9366>=</span><span> fields</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|</span><span style=color:#ff8f40>field</span><span>| {
</span><span>    </span><span style=color:#f07171>quote! </span><span>{ </span><span style=color:#ed9366>#</span><span>field_name</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>#</span><span>field_value }
</span><span>})</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=file-crates-bevy-ecs-src-relationship-mod-rs>File: <code>crates/bevy_ecs/src/relationship/mod.rs</code></h3><p><strong>Changes</strong>: Updated documentation examples to demonstrate valid multi-field usage<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before example showed single field:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>ChildOf </span><span>{
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>relationship</span><span>]
</span><span>    </span><span style=color:#fa6e32>pub </span><span>parent</span><span style=color:#61676ccc>:</span><span> Entity,
</span><span>}</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After shows multiple fields with Default:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>ChildOf </span><span>{
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>relationship</span><span>]
</span><span>    </span><span style=color:#fa6e32>pub </span><span>parent</span><span style=color:#61676ccc>:</span><span> Entity,
</span><span>    internal</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>u8</span><span>,
</span><span>}</span><span style=color:#61676ccc>;
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/reference/procedural-macros.html target=_blank>Rust Procedural Macros Guide</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/ecs/relationships/ target=_blank>Bevy ECS Relationships Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/syn/latest/syn/ target=_blank>syn crate for parsing Rust code</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-03/pr_18530.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>