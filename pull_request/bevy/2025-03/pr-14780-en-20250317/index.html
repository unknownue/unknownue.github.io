<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #14780 Link iOS example with `rustc`, and avoid C trampoline
        
    </title><meta content="#14780 Link iOS example with `rustc`, and avoid C trampoline" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-03/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-03-17</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-03/pr-14780-zh-cn-20250317>中文</a></div></div><div class=pr-content><h1 id=14780-link-ios-example-with-rustc-and-avoid-c-trampoline>#14780 Link iOS example with <code>rustc</code>, and avoid C trampoline</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Link iOS example with <code>rustc</code>, and avoid C trampoline<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/14780<li><strong>Author</strong>: madsmtm<li><strong>Status</strong>: MERGED<li><strong>Created</strong>: 2024-08-16T13:42:07Z<li><strong>Merged</strong>: 2024-08-19T15:40:57Z<li><strong>Merged By</strong>: cart</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>On iOS:<ul><li>Allow <code>std</code> to do its runtime initialization.<li>Avoid requiring the user to specify linked libraries and framework in Xcode.<li>Reduce the amount of work that <code>#[bevy_main]</code> does <ul><li>In the future we may also be able to eliminate the need for it on Android, cc @daxpedda.</ul></ul><h2 id=solution>Solution</h2><p>We previously:<ul><li>Exposed an <code>extern "C" fn main_rs</code> entry point.<li>Ran Cargo in a separate Xcode target as an external build system.<li>Imported that as a dependency of <code>bevy_mobile_example.app</code>.<li>Compiled a trampoline C file with Xcode that called <code>main_rs</code>.<li>Linked that via. Xcode.</ul><p>All of this is unnecessary; <code>rustc</code> is well capable of creating iOS executables, the trick is just to place it at the correct location for Xcode to understand it, namely <code>$TARGET_BUILD_DIR/$EXECUTABLE_PATH</code> (places it in <code>bevy_mobile_example.app/bevy_mobile_example</code>).<p>Note: We might want to wait with the changes to <code>#[bevy_main]</code> until the problem is resolved on Android too, to make the migration easier.<h2 id=testing>Testing</h2><p>Open the Xcode project, and build for an iOS target.<hr><h2 id=migration-guide>Migration Guide</h2><p><strong>If you have been building your application for iOS:</strong><p>Previously, the <code>#[bevy_main]</code> attribute created a <code>main_rs</code> entry point that most Xcode templates were using to run your Rust code from C. This was found to be unnecessary, as you can simply let Rust build your application as a binary, and run that directly.<p>You have two options for dealing with this:<p>If you’ve added further C code and Xcode customizations, or it makes sense for your use-case to continue link with Xcode, you can revert to the old behaviour by adding <code>#[no_mangle] extern "C" main_rs() { main() }</code> to your <code>main.rs</code>. Note that the old approach of linking a static library prevents the Rust standard library from doing runtime initialization, so certain functionality provided by <code>std</code> might be unavailable (stack overflow handlers, stdout/stderr flushing and other such functionality provided by the initialization routines).<p>The other, preferred option is to remove your “compile” and “link” build phases, and instead replace it with a “run script” phase that invokes <code>cargo build --bin ...</code>, and moves the built binary to the Xcode path <code>$TARGET_BUILD_DIR/$EXECUTABLE_PATH</code>. An example of how to do this can be viewed at [INSERT LINK TO UPDATED EXAMPLE PROJECT]. To make the debugging experience in Xcode nicer after this, you might also want to consider either enabling <code>panic = "abort"</code> or to set a breakpoint on the <code>rust_panic</code> symbol.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The iOS example in Bevy faced unnecessary complexity in its build process. Previously, the setup required a C trampoline function and manual Xcode configuration to bridge between Objective-C and Rust. This approach introduced several pain points:<ol><li><p><strong>Runtime Initialization Limitations</strong>: The existing method of linking a static library prevented proper initialization of Rust’s standard library, disabling critical features like stack overflow handlers and proper I/O flushing.</p><li><p><strong>Build Process Complexity</strong>: Developers had to maintain:</p> <ul><li>Separate Xcode targets for Rust compilation<li>A C source file (<code>main.m</code>) acting as entry point<li>Manual linking of frameworks and libraries<li>Custom build phases in Xcode</ul></ol><p>The key insight driving this PR was recognizing that <code>rustc</code> could directly produce iOS executables compatible with Xcode’s expected bundle structure. By outputting the binary to <code>$TARGET_BUILD_DIR/$EXECUTABLE_PATH</code>, we eliminate the need for C glue code while maintaining Xcode integration.<p>The implementation involved three main changes:<ol><li><p><strong>Removing C Interop Code</strong></p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before in lib.rs:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>no_mangle</span><span>]
</span><span style=color:#fa6e32>pub extern </span><span style=color:#86b300>"C" </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>main_rs</span><span>() {
</span><span>    </span><span style=color:#f07171>main</span><span>()
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Direct main() definition
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>main</span><span>() {
</span><span>    App</span><span style=color:#ed9366>::</span><span>new()</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_plugins</span><span>(DefaultPlugins)</span><span style=color:#ed9366>.</span><span style=color:#f07171>run</span><span>()</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre> <p>This change simplifies the entry point and removes FFI boilerplate.</p><li><p><strong>Xcode Project Restructuring</strong> The <code>project.pbxproj</code> file saw significant simplification (-174/+19 lines), replacing compile/link phases with a single script:</p> <pre class=language-bash data-lang=bash style=color:#61676c;background-color:#fafafa><code class=language-bash data-lang=bash><span style=color:#abb0b6;font-style:italic># build_rust_deps.sh
</span><span style=color:#f29718>cargo</span><span> build</span><span style=color:#ff8f40> --bin</span><span> bevy_mobile_example</span><span style=color:#ff8f40> --target</span><span> aarch64-apple-ios
</span><span style=color:#f29718>cp</span><span> target/aarch64-apple-ios/debug/bevy_mobile_example </span><span style=color:#61676ccc>\
</span><span>   </span><span style=color:#86b300>"$</span><span>{TARGET_BUILD_DIR}</span><span style=color:#86b300>/$</span><span>{EXECUTABLE_PATH}</span><span style=color:#86b300>"
</span></code></pre> <p>This script handles Rust compilation and proper binary placement.</p><li><p><strong>Bevy Main Macro Simplification</strong> The <code>#[bevy_main]</code> attribute macro was simplified by removing iOS-specific code generation (-9 lines), pushing platform-specific initialization responsibilities to the build system.</p></ol><p>The migration guide provides two paths: either retain compatibility with C interop through manual FFI definitions, or fully adopt the streamlined Rust-centric approach. The latter is recommended for new projects, while the former maintains compatibility for projects with existing Objective-C/Swift integrations.<p>Key technical considerations included:<ul><li>Preserving Xcode’s debugging capabilities through panic handling configuration<li>Maintaining compatibility with iOS simulator and physical device targets<li>Ensuring proper code signing by placing the binary in expected locations</ul><p>This change reduces maintenance overhead while improving Rust standard library functionality. It also aligns iOS builds more closely with standard Rust tooling, making Bevy mobile development more accessible to Rust developers without Xcode expertise.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[Rust Code] --> B[cargo build]
</span><span>    B --> C[iOS Binary]
</span><span>    C --> D[Xcode App Bundle]
</span><span>    D --> E[iOS Device]
</span><span>    
</span><span>    style A fill:#ffa07a,stroke:#333
</span><span>    style B fill:#98fb98,stroke:#333
</span><span>    style C fill:#87cefa,stroke:#333
</span><span>    style D fill:#da70d6,stroke:#333
</span><span>    style E fill:#fffacd,stroke:#333
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ol><li><p><code>examples/mobile/bevy_mobile_example.xcodeproj/project.pbxproj</code></p> <ul><li>Removed 174 lines of build phase configurations<li>Added 19 lines for simplified script phase<li>Key change: Replaced C compilation steps with Rust build script</ul><li><p><code>examples/mobile/build_rust_deps.sh</code></p> <pre class=language-bash data-lang=bash style=color:#61676c;background-color:#fafafa><code class=language-bash data-lang=bash><span style=color:#abb0b6;font-style:italic># Before: Complex library handling
</span><span style=color:#f29718>lipo</span><span style=color:#ff8f40> -create</span><span> ... </span><span style=color:#abb0b6;font-style:italic># Multiple architecture merging
</span><span>
</span><span style=color:#abb0b6;font-style:italic># After: Direct binary copy
</span><span style=color:#f29718>cargo</span><span> build</span><span style=color:#ff8f40> --bin</span><span> bevy_mobile_example
</span><span style=color:#f29718>cp</span><span> target/... </span><span style=color:#86b300>"$</span><span>{TARGET_BUILD_DIR}</span><span style=color:#86b300>/..."
</span></code></pre> <p>Simplified build process by leveraging cargo’s native iOS support</p><li><p><code>crates/bevy_derive/src/bevy_main.rs</code></p> <ul><li>Removed 9 lines of iOS-specific code generation<li>No longer needs to generate <code>main_rs</code> FFI entry point</ul><li><p><code>examples/mobile/ios-src/main.m</code></p> <ul><li>Entire 6-line C file deleted<li>Eliminated Objective-C to Rust bridge code</ul><li><p><code>examples/mobile/src/lib.rs</code></p> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: FFI wrapper
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>no_mangle</span><span>]
</span><span style=color:#fa6e32>pub extern </span><span style=color:#86b300>"C" </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>main_rs</span><span>() { </span><span style=color:#f07171>main</span><span>() }
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Direct main
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>main</span><span>() { </span><span style=color:#abb0b6;font-style:italic>/* app setup */ </span><span>}
</span></code></pre> <p>Simplified entry point definition</p></ol><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/nightly/rustc/platform-support.html#apple-platforms target=_blank>Rust on iOS Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://developer.apple.com/documentation/xcode/build-settings-reference target=_blank>Xcode Build System Guide</a><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/nomicon/panic-handling.html target=_blank>Rust Panic Handling Strategies</a><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/cargo/reference/config.html target=_blank>Cargo Configuration for iOS Targets</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-03/pr_14780.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>