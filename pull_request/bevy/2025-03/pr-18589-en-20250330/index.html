<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18589 Transform Propagation Optimization: Static Subtree Marking
        
    </title><meta content="#18589 Transform Propagation Optimization: Static Subtree Marking" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-03/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-03-30</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-03/pr-18589-zh-cn-20250330>中文</a></div></div><div class=pr-content><h1 id=18589-transform-propagation-optimization-static-subtree-marking>#18589 Transform Propagation Optimization: Static Subtree Marking</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Transform Propagation Optimization: Static Subtree Marking<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18589<li><strong>Author</strong>: aevyrie<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: <code>C-Performance</code>, <code>S-Ready-For-Final-Review</code>, <code>A-Transform</code><li><strong>Created</strong>: 2025-03-28T07:10:11Z<li><strong>Merged</strong>: Not merged (placeholder data)<li><strong>Merged By</strong>: N/A (placeholder data)</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Optimize static scene performance by marking unchanged subtrees.<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/pull/18589/commits/bef0209de1f11d9d67bae70fe5aec0feaee9936e target=_blank>bef0209</a> fixes #18255 and #18363.<li>Closes #18365<li>Includes change from #18321</ul><h2 id=solution>Solution</h2><ul><li>Mark hierarchy subtrees with dirty bits to avoid transform propagation where not needed<li>This causes a performance regression when spawning many entities, or when the scene is entirely dynamic.<li>This results in massive speedups for largely static scenes.<li>In the future we could allow the user to change this behavior, or add some threshold based on how dynamic the scene is?</ul><h2 id=testing>Testing</h2><ul><li>Caldera Hotel scene</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The core problem addressed in this PR stemmed from inefficient transform propagation in static scenes. Prior to these changes, Bevy’s transform system would recalculate global transforms for all entities every frame, regardless of whether their local transforms had changed. This became particularly problematic in large, mostly static scenes like the Caldera Hotel test case, where unnecessary calculations were wasting CPU cycles.<p>The solution introduces a dirty flag system using a new <code>TransformTreeChanged</code> component. The implementation follows these key steps:<ol><li><strong>Dirty Marking</strong>: When any transform changes (via <code>Changed&LTTransform></code>), parent-child relationships change (<code>Changed&LTChildOf></code>), or new global transforms are added (<code>Added&LTGlobalTransform></code>), a <code>mark_dirty_trees</code> system propagates a dirty flag up the hierarchy:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>fn </span><span style=color:#f29718>mark_dirty_trees</span><span>(
</span><span>    </span><span style=color:#ff8f40>changed_transforms</span><span style=color:#61676ccc>: </span><span>Query&LTEntity, Or<(Changed&LTTransform>, Changed&LTChildOf>, Added&LTGlobalTransform>)>>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>orphaned</span><span style=color:#61676ccc>: </span><span>RemovedComponents&LTChildOf>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>transforms</span><span style=color:#61676ccc>: </span><span>Query<(</span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#ed9366>&</span><span>ChildOf>, </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> TransformTreeChanged)>
</span><span>) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Propagates dirty flags up hierarchy
</span><span>}
</span></code></pre><ol start=2><li><strong>Selective Propagation</strong>: The <code>propagate_parent_transforms</code> system was modified to only process entities with dirty flags, skipping entire subtrees that haven’t changed:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// In propagate_parent_transforms:
</span><span style=color:#ed9366>.</span><span style=color:#f07171>filter</span><span>(|</span><span style=color:#ff8f40>tree</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>TransformTreeChanged| tree</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_changed</span><span>() </span><span style=color:#ed9366>||</span><span> tree</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_added</span><span>())
</span></code></pre><ol start=3><li><strong>Optimized Synchronization</strong>: A new <code>sync_simple_transforms</code> system handles orphaned entities and simple cases without hierarchy relationships more efficiently using parallel iteration:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>query</span><span style=color:#ed9366>.</span><span style=color:#f07171>p0</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>par_iter_mut</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>for_each</span><span>(|(</span><span style=color:#ff8f40>transform</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>mut global_transform</span><span>)| {
</span><span>    </span><span style=color:#ed9366>*</span><span>global_transform </span><span style=color:#ed9366>= </span><span>GlobalTransform</span><span style=color:#ed9366>::</span><span>from(</span><span style=color:#ed9366>*</span><span>transform)</span><span style=color:#61676ccc>;
</span><span>})</span><span style=color:#61676ccc>;
</span></code></pre><p>The implementation required careful balancing between performance gains for static scenes and potential regressions in dynamic scenarios. Key engineering decisions included:<ul><li>Using a bitset-like approach with <code>TransformTreeChanged</code> for minimal memory overhead<li>Propagating dirty flags upward through parent hierarchies rather than downward<li>Maintaining backward compatibility through component derivation macros</ul><p>Testing revealed significant performance improvements in static scenes (10x+ speedups in some cases) while introducing minor overhead in fully dynamic scenarios. The team accepted this tradeoff given the common use case of largely static environments.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Transform Change] --> B[mark_dirty_trees]
</span><span>    B --> C[Propagate Dirty Flag Up Hierarchy]
</span><span>    C --> D[propagate_parent_transforms]
</span><span>    D --> E{Check TransformTreeChanged}
</span><span>    E -->|Clean| F[Skip Subtree]
</span><span>    E -->|Dirty| G[Process Transforms]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-transform-src-systems-rs-90-94><code>crates/bevy_transform/src/systems.rs</code> (+90/-94)</h3><ol><li>Introduced parallel processing for simple transforms<li>Implemented dirty flag propagation logic<li>Optimized hierarchy traversal</ol><p>Key change in propagation logic:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>propagate_parent_transforms</span><span>(</span><span style=color:#ff8f40>query</span><span style=color:#61676ccc>: </span><span>Query<(</span><span style=color:#ed9366>&</span><span>Transform, </span><span style=color:#ed9366>&</span><span>Children)>)
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>propagate_parent_transforms</span><span>(
</span><span>    </span><span style=color:#ff8f40>query</span><span style=color:#61676ccc>: </span><span>Query<(</span><span style=color:#ed9366>&</span><span>Transform, </span><span style=color:#ed9366>&</span><span>Children), 
</span><span>    With&LTTransformTreeChanged>>
</span><span>)
</span></code></pre><h3 id=crates-bevy-transform-src-plugins-rs-24-36><code>crates/bevy_transform/src/plugins.rs</code> (+24/-36)</h3><ol><li>Reorganized system ordering<li>Added new systems to startup and update sets</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Systems now run in this order:
</span><span>PostStartup</span><span style=color:#ed9366>/</span><span>PostUpdate </span><span style=color:#ed9366>=> 
</span><span>    mark_dirty_trees
</span><span>    propagate_parent_transforms
</span><span>    sync_simple_transforms
</span></code></pre><h3 id=crates-bevy-transform-src-components-transform-rs-22-1><code>crates/bevy_transform/src/components/transform.rs</code> (+22/-1)</h3><ol><li>Added debug assertions for normalized transforms<li>Extended component metadata</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg_attr</span><span>(
</span><span>    feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"bevy-support"</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#f29718>derive</span><span>(Component)</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#f29718>require</span><span>(GlobalTransform</span><span style=color:#61676ccc>,</span><span> TransformTreeChanged) // New requirement
</span><span>)]
</span></code></pre><h3 id=crates-bevy-ui-src-layout-mod-rs-3-2><code>crates/bevy_ui/src/layout/mod.rs</code> (+3/-2)</h3><ol><li>Minor adjustments to handle removed components<li>Ensured UI system compatibility with new transform flow</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added handling for removed ContentSize components
</span><span style=color:#fa6e32>for</span><span> entity </span><span style=color:#ed9366>in</span><span> removed_content_sizes</span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>() {
</span><span>    ui_surface</span><span style=color:#ed9366>.</span><span style=color:#f07171>try_remove_node_context</span><span>(entity)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://gameprogrammingpatterns.com/component.html target=_blank>Entity Component System Patterns</a><li><a rel="noopener nofollow noreferrer" href=https://martinfowler.com/eaaCatalog/dirtyFlag.html target=_blank>Dirty Flag Pattern</a><li><a rel="noopener nofollow noreferrer" href=https://www.3dgep.com/understanding-the-transformation-matrices/ target=_blank>Hierarchical Transform Systems in Game Engines</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_transform/latest/bevy_transform/ target=_blank>Bevy Transform Documentation</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-03/pr_18589.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>