<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18572 Fix animation transitions affecting other entities
        
    </title><meta content="#18572 Fix animation transitions affecting other entities" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-03/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-03-27</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-03/pr-18572-zh-cn-20250327>中文</a></div></div><div class=pr-content><h1 id=18572-fix-animation-transitions-affecting-other-entities>#18572 Fix animation transitions affecting other entities</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix animation transitions affecting other entities<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18572<li><strong>Author</strong>: greeble-dev<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: None<li><strong>Created</strong>: 2025-03-27T11:50:21Z<li><strong>Merged</strong>: 2025-03-28T09:15:47Z<li><strong>Merged By</strong>: cart</ul><h2 id=description-translation>Description Translation</h2><h2 id=objective>Objective</h2><p>Fix #18557.<h2 id=solution>Solution</h2><p>As described in the bug, <code>remaining_weight</code> should have been inside the loop.<h2 id=testing>Testing</h2><p>Locally changed the <code>animated_mesh_control</code> example to spawn multiple meshes and play different transitions.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The PR addresses a critical bug in Bevy’s animation system where transition weight calculations were improperly affecting multiple entities. This occurred because the <code>remaining_weight</code> variable was incorrectly scoped outside the loop processing animation transitions, leading to residual values carrying over between different entities’ animations.<h3 id=the-problem-and-context>The Problem and Context</h3><p>In the original implementation, when multiple entities with animation players were present, transitioning one entity’s animation could inadvertently influence others. This manifested as irregular blending weights and unexpected visual artifacts. The root cause was identified in weight calculation logic where <code>remaining_weight</code> maintained state across different animation transitions rather than being reset per-entity.<h3 id=the-solution-approach>The Solution Approach</h3><p>The fix required localizing the <code>remaining_weight</code> variable to each transition processing iteration. By moving the variable declaration inside the loop that handles individual transitions, each animation transition calculation starts with a fresh baseline. This ensures weight calculations are properly isolated between different entities and their respective animations.<h3 id=the-implementation>The Implementation</h3><p>The key modification occurs in the transition weight calculation logic. Here’s the critical code change:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before (incorrect scope):
</span><span style=color:#fa6e32>let mut</span><span> remaining_weight </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>1.0</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>for</span><span> transition </span><span style=color:#ed9366>in &</span><span style=color:#fa6e32>mut </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>transitions {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After (corrected scope):
</span><span style=color:#fa6e32>for</span><span> transition </span><span style=color:#ed9366>in &</span><span style=color:#fa6e32>mut </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>transitions {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> remaining_weight </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>1.0</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ...
</span><span>}
</span></code></pre><p>This change ensures each transition’s weight calculation begins with a clean <code>remaining_weight</code> value rather than accumulating from previous transitions. The scoping fix prevents cross-contamination of weight values between different entities’ animation transitions.<h3 id=technical-insights>Technical Insights</h3><p>The repair demonstrates three important principles:<ol><li><strong>Variable Scoping</strong>: Critical calculations should use the narrowest possible scope to prevent state leakage<li><strong>Entity Isolation</strong>: Systems processing multiple entities must ensure per-entity state doesn’t persist between iterations<li><strong>Animation Blending</strong>: Proper weight management is essential for correct interpolation between animation states</ol><h3 id=the-impact>The Impact</h3><p>This correction:<ul><li>Eliminates cross-entity animation transition interference<li>Ensures accurate weight calculations for each individual entity<li>Maintains expected behavior when multiple animated entities exist in a scene<li>Preserves the existing API while fixing underlying logic</ul><p>The fix required minimal code changes but had significant impact on system correctness. It reinforces the importance of careful state management in ECS-based game engines, particularly when processing multiple entities through shared systems.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[AnimationPlayer System] --> B[Process Entities]
</span><span>    B --> C{For each entity}
</span><span>    C --> D[Initialize remaining_weight]
</span><span>    D --> E[Calculate transition weights]
</span><span>    E --> F[Apply to ActiveAnimation]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=file-crates-bevy-animation-src-transition-rs-2-1>File: <code>crates/bevy_animation/src/transition.rs</code> (+2/-1)</h3><p><strong>Change Summary</strong>: Fixed variable scoping in animation transition weight calculation<p><strong>Code Diff</strong>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let mut</span><span> remaining_weight </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>1.0</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>for</span><span> transition </span><span style=color:#ed9366>in &</span><span style=color:#fa6e32>mut </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>transitions {
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>for</span><span> transition </span><span style=color:#ed9366>in &</span><span style=color:#fa6e32>mut </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>transitions {
</span><span>    </span><span style=color:#fa6e32>let mut</span><span> remaining_weight </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>1.0</span><span style=color:#61676ccc>;
</span></code></pre><p><strong>Rationale</strong>:<ul><li>Moved <code>remaining_weight</code> initialization inside transition processing loop<li>Prevents residual weight values affecting subsequent entities<li>Ensures correct weight distribution for each animation transition</ul><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/getting-started/ecs/ target=_blank>Bevy ECS System Execution Model</a><li><a rel="noopener nofollow noreferrer" href=https://www.gameenginebook.com/animation-blending/ target=_blank>Animation Blending Techniques</a><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/rust-by-example/variable_bindings/scope.html target=_blank>Rust Variable Scoping Rules</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-03/pr_18572.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>