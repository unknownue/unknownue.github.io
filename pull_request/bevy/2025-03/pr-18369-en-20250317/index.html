<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18369 bevy: Replace unnecessary tuple type registrations
        
    </title><meta content="#18369 bevy: Replace unnecessary tuple type registrations" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-03/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-03-17</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-03/pr-18369-zh-cn-20250317>中文</a></div></div><div class=pr-content><h1 id=18369-bevy-replace-unnecessary-tuple-type-registrations>#18369 bevy: Replace unnecessary tuple type registrations</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: bevy: Replace unnecessary tuple type registrations<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18369<li><strong>Author</strong>: MrGVSV<li><strong>Status</strong>: MERGED<li><strong>Created</strong>: 2025-03-17T20:00:03Z<li><strong>Merged</strong>: 2025-03-18T08:12:15Z<li><strong>Merged By</strong>: cart</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>As pointed out by @cart on <a rel="noopener nofollow noreferrer" href=https://discord.com/channels/691052431525675048/1002362493634629796/1351279139872571462 target=_blank>Discord</a>, we should be careful when using tuple shorthand to register types. Doing so incurs some unnecessary penalties such as memory/compile/performance cost to generate registrations for a tuple type that will never be used.<p>A better solution would be to create a custom lint for this, but for now we can at least remove the existing usages of this pattern.<blockquote><p>[!note] This pattern of using tuples to register multiple types at once isn’t inherently bad. Users should feel free to use this pattern, knowing the side effects it may have. What this problem really is about is using this in <em>library</em> code, where users of Bevy have no choice in whether a tuple is unnecessarily registered in an internal plugin or not.</blockquote><h2 id=solution>Solution</h2><p>Replace tuple registrations with single-type registrations.<p>Note that I left the tuple registrations in test code since I feel like brevity is more important in those cases. But let me know if I should change them or leave a comment above them!<h2 id=testing>Testing</h2><p>You can test locally by running:<pre style=color:#61676c;background-color:#fafafa><code><span>cargo check --workspace --all-features
</span></code></pre><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The PR addresses a systemic optimization opportunity in Bevy’s type registration system. The core issue stemmed from using tuple type registrations in internal library code, which created unnecessary overhead. When developers register types using tuple syntax like <code>app.register_type::<(A, B, C)>()</code>, Bevy generates reflection data for both the individual types and the tuple type itself. While this syntax provides developer convenience, it introduces three concrete costs in library code:<ol><li><strong>Memory overhead</strong>: Storing unused type information in the final binary<li><strong>Compile-time impact</strong>: Generating extra reflection data during compilation<li><strong>Runtime performance</strong>: Processing unused type registrations at startup</ol><p>The problem was particularly acute in library code because end users have no way to opt out of these unnecessary registrations. While tuple registrations remain acceptable in user code where developers can make conscious tradeoffs, they become technical debt when baked into the engine’s core systems.<p>The solution implemented follows a straightforward but systematic approach:<ol><li>Identify all instances of tuple type registrations in non-test code<li>Replace each tuple registration with individual type registrations<li>Preserve tuple syntax in test code where brevity outweighs optimization needs</ol><p>For example, in the picking system implementation:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before
</span><span>app</span><span style=color:#ed9366>.</span><span>register_type</span><span style=color:#ed9366>::</span><span><(Entity, HitData)>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After
</span><span>app</span><span style=color:#ed9366>.</span><span>register_type</span><span style=color:#ed9366>::</span><span>&LTEntity>()</span><span style=color:#61676ccc>;
</span><span>app</span><span style=color:#ed9366>.</span><span>register_type</span><span style=color:#ed9366>::</span><span>&LTHitData>()</span><span style=color:#61676ccc>;
</span></code></pre><p>This change eliminates the registration of the <code>(Entity, HitData)</code> tuple type while maintaining the necessary registrations for the component types themselves. The pattern was consistently applied across multiple subsystems including sprite handling and mesh picking.<p>The technical decision to preserve tuple registrations in test code reflects a pragmatic balance between optimization and maintainability. Test code benefits more from concise syntax since it’s:<ul><li>Less performance-sensitive<li>More frequently modified<li>Subject to different maintenance priorities</ul><p>The changes were validated through compile-time verification (<code>cargo check</code>) rather than runtime tests, as the modifications primarily affect type system behavior rather than functional logic. This approach aligns with Rust’s strong compile-time guarantees for type registration validity.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Tuple Registration] --> B[Unused Tuple Type]
</span><span>    B --> C[Memory Overhead]
</span><span>    B --> D[Compile-Time Cost]
</span><span>    B --> E[Runtime Penalty]
</span><span>    F[Individual Registration] --> G[Essential Types Only]
</span><span>    G --> H[Reduced Overhead]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ol><li><code>crates/bevy_sprite/src/picking_backend.rs</code></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before
</span><span>app</span><span style=color:#ed9366>.</span><span>register_type</span><span style=color:#ed9366>::</span><span><(Entity, HitData)>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After
</span><span>app</span><span style=color:#ed9366>.</span><span>register_type</span><span style=color:#ed9366>::</span><span>&LTEntity>()</span><span style=color:#61676ccc>;
</span><span>app</span><span style=color:#ed9366>.</span><span>register_type</span><span style=color:#ed9366>::</span><span>&LTHitData>()</span><span style=color:#61676ccc>;
</span></code></pre><ul><li>Removed tuple registration for picking backend components<li>Maintains individual type registrations for essential types</ul><ol start=2><li><code>crates/bevy_picking/src/mesh_picking/mod.rs</code></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before
</span><span>app</span><span style=color:#ed9366>.</span><span>register_type</span><span style=color:#ed9366>::</span><span><(Entity, HitData)>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After
</span><span>app</span><span style=color:#ed9366>.</span><span>register_type</span><span style=color:#ed9366>::</span><span>&LTEntity>()</span><span style=color:#61676ccc>;
</span><span>app</span><span style=color:#ed9366>.</span><span>register_type</span><span style=color:#ed9366>::</span><span>&LTHitData>()</span><span style=color:#61676ccc>;
</span></code></pre><ul><li>Similar optimization applied to mesh picking system<li>Ensures consistency across different picking implementations</ul><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/features/reflection/ target=_blank>Bevy Reflection System Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/stable/nomicon/performance.html target=_blank>Rust Performance Optimization Patterns</a><li><a rel="noopener nofollow noreferrer" href=https://rust-lang.github.io/api-guidelines/type-safety.html target=_blank>Type-Driven API Design in Rust</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-03/pr_18369.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>