<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18213 Return an error when direct-nested-loading a subasset
        
    </title><meta content="#18213 Return an error when direct-nested-loading a subasset" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-03/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-03-13</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-03/pr-18213-zh-cn-20250313>中文</a></div></div><div class=pr-content><h1 id=18213-return-an-error-when-direct-nested-loading-a-subasset>#18213 Return an error when direct-nested-loading a subasset</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Return an error when direct-nested-loading a subasset<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18213<li><strong>Author</strong>: andriyDev<li><strong>Status</strong>: MERGED<li><strong>Created</strong>: 2025-03-09T21:42:27Z<li><strong>Merged</strong>: Not merged<li><strong>Merged By</strong>: N/A</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Prevents #18291.<li>Previously, attempting to direct-nested-load a subasset would return the root of the nested-loaded asset. This is most problematic when doing direct-nested-<strong>untyped</strong>-loads of subassets, where you may not even realize you’re dealing with the entirely wrong asset (at least with typed loads, <em>most of the time</em> the root asset has a different type from the subasset, and so at least you’d get an error that the types don’t match).</ul><h2 id=solution>Solution</h2><ul><li>We now return an error when doing these kinds of loads.</ul><p>Note an alternative would be to “solve” this problem, by just looking up the appropriate subasset after doing the nested load. However there’s two problems: 1) we don’t know which subassets of the root asset are necessary for the subasset we are looking up (so any handles in that subasset may never get registered), 2) a solution will likely hamper attempts to resolve #18010. AFAICT, no one has complained about this issue, so it doesn’t seem critical to fix this for now.<h2 id=testing>Testing</h2><ul><li>Added a test to ensure this returns an error. I also checked that the error before this was just a mismatched type error, meaning it was trying to pass off the root asset type <code>CoolText</code> as the subasset type <code>SubText</code> (which would have worked had I not been using typed loads).</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The PR addresses a subtle but potentially dangerous issue in Bevy’s asset loading system. When loading subassets through nested asset loading, the system previously returned the root asset instead of the requested subasset. This could lead to silent failures where developers might unknowingly work with incorrect assets, particularly when using untyped handles.<p>The core problem stemmed from how nested asset loading handled subasset paths. Consider a scenario where Asset A contains a reference to Subasset B. If a developer tried to load B directly through nested loading (e.g., while processing A), the system would incorrectly return A’s root handle instead of B’s subasset handle. This was especially problematic with untyped handles (<code>HandleUntyped</code>), as there was no type checking to catch the mismatch.<p>The solution involved adding explicit error checking in the asset loading pipeline. The implementation introduced validation logic that detects when a direct nested load attempts to access a subasset. Instead of silently returning the root asset, the system now throws an error early in the loading process.<p>Key technical decisions included:<ol><li>Choosing error generation over automatic subasset resolution to: <ul><li>Avoid incomplete handle registration (since dependencies can’t be guaranteed)<li>Prevent conflicts with ongoing work on asset processing (#18010)</ul><li>Maintaining type safety by leveraging Bevy’s existing type system infrastructure<li>Adding targeted test coverage to verify error generation while preserving existing loading behaviors</ol><p>The implementation affected three core areas of the asset system:<ol><li><strong>Asset path resolution</strong> - Added validation for subasset paths in nested contexts<li><strong>Error handling</strong> - Introduced new error variants for invalid subasset loading attempts<li><strong>Loader infrastructure</strong> - Modified loader behavior to short-circuit invalid loads</ol><p>A critical test was added that simulates a nested subasset load scenario:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>direct_nested_subasset_load_errors</span><span>() {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Setup asset server and load parent asset
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Attempt to load subasset through nested context
</span><span>    </span><span style=color:#f07171>assert!</span><span>(</span><span style=color:#f07171>matches!</span><span>(
</span><span>        result</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(AssetLoadError</span><span style=color:#ed9366>::</span><span>SubassetNestedLoad { </span><span style=color:#ed9366>.. </span><span>})
</span><span>    ))</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>This test ensures the system properly rejects invalid loading patterns rather than returning incorrect assets.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Asset Load Request] --> B{Is Nested Load?}
</span><span>    B -->|Yes| C{Requests Subasset?}
</span><span>    B -->|No| D[Proceed Normally]
</span><span>    C -->|Yes| E[Return Error]
</span><span>    C -->|No| D
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ol><li><p><code>crates/bevy_asset/src/lib.rs</code></p> <ul><li>Added new error type <code>AssetLoadError::SubassetNestedLoad</code><li>Modified error handling infrastructure to support new validation</ul><li><p><code>crates/bevy_asset/src/loader_builders.rs</code></p> <ul><li>Updated loader construction to include nested load validation<li>Example change:</ul></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>build_nested_loader</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Box</span><span>&LTdyn AssetLoader> {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// No subasset checking
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>build_nested_loader</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><</span><span style=color:#55b4d4;font-style:italic>Box</span><span>&LTdyn AssetLoader>> {
</span><span>    </span><span style=color:#fa6e32>if </span><span style=color:#f07171>is_subasset_request</span><span>() {
</span><span>        </span><span style=color:#fa6e32>return </span><span style=color:#55b4d4;font-style:italic>Err</span><span>(AssetLoadError</span><span style=color:#ed9366>::</span><span>SubassetNestedLoad)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Proceed with loader
</span><span>}
</span></code></pre><ol start=3><li><code>crates/bevy_asset/src/loader.rs</code> <ul><li>Enhanced path resolution logic with subasset validation<li>Added error propagation for invalid load attempts</ul></ol><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/assets/ target=_blank>Bevy Asset System Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/discussions/18010 target=_blank>Handling Assets in Complex Games</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/ecs/#components target=_blank>Type-Safe Handles in ECS</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-03/pr_18213.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>