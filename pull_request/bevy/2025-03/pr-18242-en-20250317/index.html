<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18242 Incorporate viewport position into clamping in `camera_system`
        
    </title><meta content="#18242 Incorporate viewport position into clamping in `camera_system`" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-03/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-03-17</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-03/pr-18242-zh-cn-20250317>中文</a></div></div><div class=pr-content><h1 id=18242-incorporate-viewport-position-into-clamping-in-camera-system>#18242 Incorporate viewport position into clamping in <code>camera_system</code></h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Incorporate viewport position into clamping in <code>camera_system</code><li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18242<li><strong>Author</strong>: mweatherley<li><strong>Status</strong>: MERGED<li><strong>Created</strong>: 2025-03-10T21:21:46Z<li><strong>Merged</strong>: Not merged<li><strong>Merged By</strong>: N/A</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>In its existing form, the clamping that’s done in <code>camera_system</code> doesn’t work well when the <code>physical_position</code> of the associated viewport is nonzero. In such cases, it may produce invalid viewport rectangles (i.e. not lying inside the render target), which may result in crashes during the render pass.<p>The goal of this PR is to eliminate this possibility by making the clamping behavior always result in a valid viewport rectangle when possible.<h2 id=solution>Solution</h2><p>Incorporate the <code>physical_position</code> information into the clamping behavior. In particular, always cut off enough so that it’s contained in the render target rather than clamping it to the same dimensions as the target itself. In weirder situations, still try to produce a valid viewport rectangle to avoid crashes.<h2 id=testing>Testing</h2><p>Tested these changes on my work branch where I encountered the crash.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The core issue stemmed from how Bevy’s camera system handled viewport rectangles when viewports had non-zero positions. The original clamping logic only considered the render target’s dimensions without accounting for the viewport’s offset, potentially creating rectangles extending beyond target boundaries. This could lead to GPU API validation errors and application crashes during rendering.<p>The solution required reworking the clamping logic in <code>camera_system</code> to properly factor in both the viewport’s position and size. The key insight was that valid clamping must consider:<ol><li>Maximum available space relative to the viewport’s starting position<li>Edge cases where position itself might be outside render target bounds</ol><p>In <code>camera.rs</code>, the clamping implementation was updated to:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Calculate maximum allowable dimensions considering position
</span><span style=color:#fa6e32>let</span><span> max_width </span><span style=color:#ed9366>=</span><span> render_target</span><span style=color:#ed9366>.</span><span style=color:#f07171>physical_size</span><span>()</span><span style=color:#ed9366>.</span><span>x</span><span style=color:#ed9366>.</span><span style=color:#f07171>saturating_sub</span><span>(viewport</span><span style=color:#ed9366>.</span><span>physical_position</span><span style=color:#ed9366>.</span><span>x)</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> max_height </span><span style=color:#ed9366>=</span><span> render_target</span><span style=color:#ed9366>.</span><span style=color:#f07171>physical_size</span><span>()</span><span style=color:#ed9366>.</span><span>y</span><span style=color:#ed9366>.</span><span style=color:#f07171>saturating_sub</span><span>(viewport</span><span style=color:#ed9366>.</span><span>physical_position</span><span style=color:#ed9366>.</span><span>y)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Clamp width/height to available space
</span><span style=color:#fa6e32>let</span><span> clamped_width </span><span style=color:#ed9366>=</span><span> viewport</span><span style=color:#ed9366>.</span><span>physical_size</span><span style=color:#ed9366>.</span><span>x</span><span style=color:#ed9366>.</span><span style=color:#f07171>clamp</span><span>(</span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>,</span><span> max_width)</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> clamped_height </span><span style=color:#ed9366>=</span><span> viewport</span><span style=color:#ed9366>.</span><span>physical_size</span><span style=color:#ed9366>.</span><span>y</span><span style=color:#ed9366>.</span><span style=color:#f07171>clamp</span><span>(</span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>,</span><span> max_height)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Adjust position if it exceeds target bounds
</span><span style=color:#fa6e32>let</span><span> clamped_x </span><span style=color:#ed9366>=</span><span> viewport</span><span style=color:#ed9366>.</span><span>physical_position</span><span style=color:#ed9366>.</span><span>x</span><span style=color:#ed9366>.</span><span style=color:#f07171>clamp</span><span>(</span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>,</span><span> render_target</span><span style=color:#ed9366>.</span><span style=color:#f07171>physical_size</span><span>()</span><span style=color:#ed9366>.</span><span>x)</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> clamped_y </span><span style=color:#ed9366>=</span><span> viewport</span><span style=color:#ed9366>.</span><span>physical_position</span><span style=color:#ed9366>.</span><span>y</span><span style=color:#ed9366>.</span><span style=color:#f07171>clamp</span><span>(</span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>,</span><span> render_target</span><span style=color:#ed9366>.</span><span style=color:#f07171>physical_size</span><span>()</span><span style=color:#ed9366>.</span><span>y)</span><span style=color:#61676ccc>;
</span></code></pre><p>This approach ensures:<ol><li>Viewport size never exceeds available space given its position<li>Position is clamped to render target boundaries<li>Degenerate cases (negative/oversized positions) are handled safely</ol><p>The implementation prioritizes maintaining valid GPU API parameters over strict dimensional accuracy, as invalid viewports would cause hard crashes. This trade-off ensures system stability even with malformed input.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Viewport Position] --> B[Clamping Logic]
</span><span>    C[Render Target Size] --> B
</span><span>    B --> D[Valid Viewport Rectangle]
</span><span>    D --> E[Render Pass Execution]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><code>crates/bevy_render/src/camera/camera.rs</code> (+37/-6)<ul><li>Updated <code>Camera::viewport_to_physical_size_and_position</code> method<li>Added position-aware clamping logic<li>Implemented saturating arithmetic to prevent negative values</ul><p>Key code changes:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Basic size clamping
</span><span style=color:#fa6e32>let</span><span> physical_size </span><span style=color:#ed9366>= </span><span>UVec2</span><span style=color:#ed9366>::</span><span>new(
</span><span>    viewport</span><span style=color:#ed9366>.</span><span>size</span><span style=color:#ed9366>.</span><span>x</span><span style=color:#ed9366>.</span><span style=color:#f07171>min</span><span>(physical_width)</span><span style=color:#61676ccc>,
</span><span>    viewport</span><span style=color:#ed9366>.</span><span>size</span><span style=color:#ed9366>.</span><span>y</span><span style=color:#ed9366>.</span><span style=color:#f07171>min</span><span>(physical_height)</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Position-aware clamping
</span><span style=color:#fa6e32>let</span><span> physical_position </span><span style=color:#ed9366>= </span><span>UVec2</span><span style=color:#ed9366>::</span><span>new(
</span><span>    viewport</span><span style=color:#ed9366>.</span><span>position</span><span style=color:#ed9366>.</span><span>x</span><span style=color:#ed9366>.</span><span style=color:#f07171>min</span><span>(physical_width</span><span style=color:#ed9366>.</span><span style=color:#f07171>saturating_sub</span><span>(</span><span style=color:#ff8f40>1</span><span>))</span><span style=color:#61676ccc>,
</span><span>    viewport</span><span style=color:#ed9366>.</span><span>position</span><span style=color:#ed9366>.</span><span>y</span><span style=color:#ed9366>.</span><span style=color:#f07171>min</span><span>(physical_height</span><span style=color:#ed9366>.</span><span style=color:#f07171>saturating_sub</span><span>(</span><span style=color:#ff8f40>1</span><span>))</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>let</span><span> max_x </span><span style=color:#ed9366>=</span><span> physical_width</span><span style=color:#ed9366>.</span><span style=color:#f07171>saturating_sub</span><span>(physical_position</span><span style=color:#ed9366>.</span><span>x)</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> max_y </span><span style=color:#ed9366>=</span><span> physical_height</span><span style=color:#ed9366>.</span><span style=color:#f07171>saturating_sub</span><span>(physical_position</span><span style=color:#ed9366>.</span><span>y)</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> physical_size </span><span style=color:#ed9366>= </span><span>UVec2</span><span style=color:#ed9366>::</span><span>new(
</span><span>    viewport</span><span style=color:#ed9366>.</span><span>size</span><span style=color:#ed9366>.</span><span>x</span><span style=color:#ed9366>.</span><span style=color:#f07171>min</span><span>(max_x)</span><span style=color:#61676ccc>,
</span><span>    viewport</span><span style=color:#ed9366>.</span><span>size</span><span style=color:#ed9366>.</span><span>y</span><span style=color:#ed9366>.</span><span style=color:#f07171>min</span><span>(max_y)</span><span style=color:#61676ccc>,
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://www.w3.org/TR/webgpu/#validation-using-viewports target=_blank>WebGPU Viewport Validation Rules</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/3d-rendering/cameras/ target=_blank>Bevy Camera System Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://registry.khronos.org/vulkan/specs/1.3-extensions/html/chap27.html#fxviewport-depthrange target=_blank>Vulkan Viewport Depth Range Requirements</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-03/pr_18242.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>