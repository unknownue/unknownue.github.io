<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #18232 (Adoped) Remove panics and optimise mesh picking
        
    </title><meta content="#18232 (Adoped) Remove panics and optimise mesh picking" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-03/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-03-11</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-03/pr-18232-zh-cn-20250311>中文</a></div></div><div class=pr-content><h1 id=18232-adoped-remove-panics-and-optimise-mesh-picking>#18232 (Adoped) Remove panics and optimise mesh picking</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: (Adoped) Remove panics and optimise mesh picking<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/18232<li><strong>Author</strong>: BD103<li><strong>Status</strong>: MERGED<li><strong>Created</strong>: 2025-03-10T16:36:25Z<li><strong>Merged</strong>: Not merged<li><strong>Merged By</strong>: N/A</ul><h2 id=description-translation>Description Translation</h2><p><em>Note from BD103: this PR was adopted from #16148. The majority of this PR’s description is copied from the original.</em><h1 id=objective>Objective</h1><p>Adds tests to cover various mesh picking cases and removes sources of panics.<p>It should prevent users being able to trigger panics in <code>bevy_picking</code> code via bad mesh data such as #15891, and is a follow up to my comments in <a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/pull/15800#pullrequestreview-2361694213 target=_blank>#15800 (review)</a>.<p>This is motivated by #15979<h2 id=testing>Testing</h2><p>Adds 8 new tests to cover <code>ray_mesh_intersection</code> code.<h2 id=changes-from-original-pr>Changes from original PR</h2><p>I reverted the changes to the benchmarks, since that was the largest factor blocking it merging. I’ll open a follow-up issue so that those benchmark changes can be implemented.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The PR addresses a critical stability issue in Bevy’s mesh picking system where invalid mesh data could trigger runtime panics. This problem manifested in several user-reported issues (#15891, #15979) where malformed meshes would crash applications using Bevy’s picking features. The core challenge lay in the <code>ray_mesh_intersection</code> function, which made assumptions about mesh data validity without proper error handling.<p>The solution approach focused on two main pillars: hardening the error handling in mesh intersection calculations, and establishing comprehensive test coverage. The author systematically replaced panic-prone unwrap() calls and unchecked array accesses with Result-based error propagation. This transformation allowed the code to gracefully handle edge cases like missing vertex attributes or degenerate triangles instead of crashing.<p>In the implementation, several key changes stand out. The mesh intersection logic was refactored to return <code>Option&LTIntersectionData></code> instead of panicking on invalid input. This required careful validation of mesh attributes before processing:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before panic-prone access
</span><span style=color:#fa6e32>let</span><span> positions </span><span style=color:#ed9366>=</span><span> mesh</span><span style=color:#ed9366>.</span><span style=color:#f07171>attribute</span><span>(Mesh</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ATTRIBUTE_POSITION</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After error handling
</span><span style=color:#fa6e32>let</span><span> positions </span><span style=color:#ed9366>=</span><span> mesh</span><span style=color:#ed9366>.</span><span style=color:#f07171>attribute</span><span>(Mesh</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ATTRIBUTE_POSITION</span><span>)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>ok_or</span><span>(PickingError</span><span style=color:#ed9366>::</span><span>MissingPositions)</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span></code></pre><p>Eight new test cases were added to validate different failure scenarios:<ol><li>Meshes missing position attributes<li>Meshes missing normal attributes<li>Invalid triangle indices<li>Zero-area triangles<li>Non-finite position values<li>Non-finite normal values<li>Degenerate barycentric coordinates<li>Ray missing origin/direction</ol><p>These tests ensure the system correctly handles edge cases that previously caused panics. The test suite now explicitly verifies that these problematic inputs result in graceful errors rather than crashes.<p>The PR maintains backward compatibility by preserving existing public APIs while changing internal error handling. Performance considerations were addressed by keeping the error checks lightweight and avoiding unnecessary allocations. The decision to revert benchmark changes shows a pragmatic approach to incremental improvement, deferring optimization work to a follow-up PR while securing the critical stability fixes first.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[ray_mesh_intersection] --> B[Input Validation]
</span><span>    B --> C[Position Checks]
</span><span>    B --> D[Normal Checks]
</span><span>    B --> E[Triangle Validation]
</span><span>    C --> F[Test Cases]
</span><span>    D --> F
</span><span>    E --> F
</span><span>    F --> G[Error Handling]
</span><span>    G --> H[Stable Picking System]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-picking-src-mesh-picking-ray-cast-intersections-rs-277-132><code>crates/bevy_picking/src/mesh_picking/ray_cast/intersections.rs</code> (+277/-132)</h3><ol><li><strong>Error Handling Implementation</strong><br> Replaced panic-inducing unwrap() calls with proper Result returns and error variants. Added new error type <code>PickingError</code> to categorize failure reasons.</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before
</span><span style=color:#fa6e32>let</span><span> triangle </span><span style=color:#ed9366>=</span><span> mesh_indices[i]</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After
</span><span style=color:#fa6e32>let</span><span> triangle </span><span style=color:#ed9366>=</span><span> mesh_indices</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(i)</span><span style=color:#ed9366>.</span><span style=color:#f07171>copied</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>ok_or</span><span>(PickingError</span><span style=color:#ed9366>::</span><span>InvalidTriangleIndex(i))</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span></code></pre><ol start=2><li><strong>Test Coverage Expansion</strong><br> Added 8 new test functions covering various edge cases. Each test verifies proper error handling rather than successful intersections.</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>missing_positions</span><span>() {
</span><span>    </span><span style=color:#fa6e32>let</span><span> mesh </span><span style=color:#ed9366>= </span><span>Mesh</span><span style=color:#ed9366>::</span><span>new(PrimitiveTopology</span><span style=color:#ed9366>::</span><span>TriangleList)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> ray </span><span style=color:#ed9366>= </span><span>Ray</span><span style=color:#ed9366>::</span><span>new(Vec3</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ZERO</span><span style=color:#61676ccc>, </span><span>Vec3</span><span style=color:#ed9366>::</span><span>Z)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#f07171>assert!</span><span>(</span><span style=color:#f07171>ray_mesh_intersection</span><span>(</span><span style=color:#ed9366>&</span><span>ray</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>mesh</span><span style=color:#61676ccc>, </span><span>Mat4</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>IDENTITY</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>true</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_none</span><span>())</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><ol start=3><li><strong>Barycentric Coordinate Validation</strong><br> Added checks for degenerate triangles and invalid barycentric coordinates to prevent NaN propagation.</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before (potential NaN)
</span><span style=color:#fa6e32>let</span><span> barycentric </span><span style=color:#ed9366>= </span><span>Vec2</span><span style=color:#ed9366>::</span><span>new(dot00 </span><span style=color:#ed9366>*</span><span> dot11 </span><span style=color:#ed9366>-</span><span> dot01 </span><span style=color:#ed9366>*</span><span> dot01</span><span style=color:#61676ccc>,</span><span> denominator)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After
</span><span style=color:#fa6e32>if</span><span> denominator </span><span style=color:#ed9366>< </span><span style=color:#fa6e32>f32</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>EPSILON </span><span>{
</span><span>    </span><span style=color:#fa6e32>return </span><span style=color:#55b4d4;font-style:italic>None</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// Skip degenerate triangles
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ol><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/render/mesh/struct.Mesh.html target=_blank>Bevy Mesh Data Structure Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://www.scratchapixel.com/lessons/3d-basic-rendering/ray-tracing-rendering-a-triangle/ray-triangle-intersection-geometric-solution.html target=_blank>Ray-Mesh Intersection Algorithms</a><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/book/ch09-00-error-handling.html target=_blank>Rust Error Handling Guide</a><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/IEEE_754#Special_values target=_blank>IEEE Floating-Point Special Values</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-03/pr_18232.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>