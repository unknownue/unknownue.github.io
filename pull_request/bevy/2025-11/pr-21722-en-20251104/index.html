<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21722 Solari: Fallback to point temporal reprojection when permutation fails
        
    </title><meta content="#21722 Solari: Fallback to point temporal reprojection when permutation fails" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-11/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-11-04</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-11/pr-21722-zh-cn-20251104>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Solari: Fallback to point temporal reprojection when permutation fails<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21722<li><strong>Author</strong>: JMS55<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, S-Ready-For-Final-Review, C-Refinement<li><strong>Created</strong>: 2025-11-03T01:30:05Z<li><strong>Merged</strong>: 2025-11-04T06:57:42Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>Permutation tends to lead to temporal reprojection failures on the edges of objects (not a huge deal for DI, very problematic for GI).<p>Now when the initial permuted reprojection fails, we instead fallback to non-permuted reprojection.<p>Before:</p><img alt=image height=1500 src=https://github.com/user-attachments/assets/ba169a63-a982-4706-8708-9d57d2f4bb70 width=2564><p>After: <img alt=image height=1500 src=https://github.com/user-attachments/assets/23f96815-2271-4260-a35e-c9fbf27419b0 width=2564><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a specific issue in Bevy’s Solari rendering system related to temporal reprojection failures at object edges. The problem occurs when using pixel permutation for temporal reprojection, which can fail on object boundaries and cause visual artifacts.<p>The core issue stems from how temporal reprojection works in ReSTIR (Reusable Spatio-Temporal Importance Resampling) implementations. When reprojecting pixels from previous frames to the current frame, the system uses motion vectors to find corresponding pixels. Pixel permutation is a technique that helps reduce bias by randomly shuffling pixel coordinates, but it has a weakness: it can fail at object edges where geometry changes abruptly between frames.<p>The solution implemented here is straightforward but effective: when the initial permuted reprojection fails, the system falls back to non-permuted (point) reprojection. This creates a two-stage approach that maintains the benefits of permutation while providing a safety net for edge cases.<p>The implementation required changes to both Direct Illumination (DI) and Global Illumination (GI) shaders. In each case, the existing <code>load_temporal_reservoir</code> function was refactored to extract the core reprojection logic into a new <code>load_temporal_reservoir_inner</code> function. This allowed the main function to first attempt permuted reprojection, then fall back to point reprojection if the initial attempt failed.<p>For DI, the validity check uses a dedicated <code>reservoir_valid</code> function, while for GI it checks if the reservoir radiance is all zeros. This difference reflects the different data structures and validation requirements between the two illumination systems.<p>The engineering trade-off here is clear: we’re adding a fallback path that may be slightly more expensive computationally, but the benefit is significantly improved visual quality, especially for GI where temporal artifacts are more problematic. The approach maintains the anti-bias benefits of permutation while ensuring robustness at object boundaries.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Temporal Reprojection] --> B{Permuted Reprojection}
</span><span>    B -->|Success| C[Use Permuted Result]
</span><span>    B -->|Failure| D[Point Reprojection]
</span><span>    D -->|Success| E[Use Point Result]
</span><span>    D -->|Failure| F[Empty Reservoir]
</span><span>    
</span><span>    G[DI System] --> A
</span><span>    H[GI System] --> A
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-solari-src-realtime-restir-di-wgsl-17-8><code>crates/bevy_solari/src/realtime/restir_di.wgsl</code> (+17/-8)</h3><p>This file handles Direct Illumination temporal reprojection. The main change refactors the reprojection logic to support fallback behavior.<p><strong>Key changes:</strong><ul><li>Extracted core reprojection logic into <code>load_temporal_reservoir_inner</code><li>Added fallback from permuted to point reprojection<li>Maintains existing validity checks for lights and pixel dissimilarity</ul><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>let temporal_pixel_id = permute_pixel(vec2&LTu32>(temporal_pixel_id_float), constants.frame_index, view.viewport.zw);
</span><span>
</span><span>// Check if the pixel features have changed heavily between the current and previous frame
</span><span>let temporal_depth = textureLoad(previous_depth_buffer, temporal_pixel_id, 0);
</span><span>let temporal_surface = gpixel_resolve(textureLoad(previous_gbuffer, temporal_pixel_id, 0), temporal_depth, temporal_pixel_id, view.main_pass_viewport.zw, previous_view.world_from_clip);
</span><span>if pixel_dissimilar(depth, world_position, temporal_surface.world_position, world_normal, temporal_surface.world_normal, view) {
</span><span>    return empty_reservoir();
</span><span>}
</span><span>
</span><span>var temporal_reservoir = load_reservoir_a(temporal_pixel_id);
</span><span>
</span><span>// After:
</span><span>let permuted_temporal_pixel_id = permute_pixel(vec2&LTu32>(temporal_pixel_id_float), constants.frame_index, view.viewport.zw);
</span><span>var temporal_reservoir = load_temporal_reservoir_inner(permuted_temporal_pixel_id, depth, world_position, world_normal);
</span><span>
</span><span>// If permuted reprojection failed (tends to happen on object edges), try point reprojection
</span><span>if !reservoir_valid(temporal_reservoir) {
</span><span>    temporal_reservoir = load_temporal_reservoir_inner(vec2&LTu32>(temporal_pixel_id_float), depth, world_position, world_normal);
</span><span>}
</span></code></pre><h3 id=crates-bevy-solari-src-realtime-restir-gi-wgsl-15-4><code>crates/bevy_solari/src/realtime/restir_gi.wgsl</code> (+15/-4)</h3><p>This file handles Global Illumination temporal reprojection with similar refactoring.<p><strong>Key changes:</strong><ul><li>Same fallback pattern as DI but with GI-specific data structures<li>Uses radiance zero-check for validity instead of dedicated function<li>Maintains confidence weight capping</ul><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>let temporal_pixel_id = permute_pixel(vec2&LTu32>(temporal_pixel_id_float), constants.frame_index, view.viewport.zw);
</span><span>
</span><span>// Check if the current pixel was off screen during the previous frame (current pixel is newly visible),
</span><span>// or if all temporal history should assumed to be invalid
</span><span>if any(temporal_pixel_id_float < vec2(0.0)) || any(temporal_pixel_id_float >= view.main_pass_viewport.zw) || constants.temporal_history_invalid {
</span><span>    return NeighborInfo(empty_reservoir(), vec3(0.0), vec3(0.0), vec3(0.0));
</span><span>}
</span><span>
</span><span>// After:
</span><span>let permuted_temporal_pixel_id = permute_pixel(vec2&LTu32>(temporal_pixel_id_float), constants.frame_index, view.viewport.zw);
</span><span>var temporal = load_temporal_reservoir_inner(permuted_temporal_pixel_id, depth, world_position, world_normal);
</span><span>
</span><span>// If permuted reprojection failed (tends to happen on object edges), try point reprojection
</span><span>if all(temporal.reservoir.radiance == vec3(0.0)) {
</span><span>    temporal = load_temporal_reservoir_inner(vec2&LTu32>(temporal_pixel_id_float), depth, world_position, world_normal);
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://research.nvidia.com/publication/2020-07_restir-reusable-spatio-temporal-importance-resampling target=_blank>ReSTIR: Reusable Spatio-Temporal Importance Resampling</a> - Original paper on ReSTIR technique<li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Temporal_anti-aliasing target=_blank>Temporal Anti-Aliasing</a> - Background on temporal techniques in rendering<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/tree/main/crates/bevy_solari target=_blank>Bevy Solari Documentation</a> - Bevy’s real-time GI system implementation</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-11/pr_21722.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>