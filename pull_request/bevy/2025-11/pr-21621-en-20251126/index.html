<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21621 order rhombus vertices in "hull-order"
        
    </title><meta content='#21621 order rhombus vertices in "hull-order"' property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-11/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-11-26</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-11/pr-21621-zh-cn-20251126>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>order rhombus vertices in “hull-order”<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: order rhombus vertices in “hull-order”<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21621<li><strong>Author</strong>: ChristopherBiscardi<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, S-Ready-For-Final-Review, A-Math<li><strong>Created</strong>: 2025-10-21T16:07:38Z<li><strong>Merged</strong>: 2025-11-26T20:38:05Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Most Mesh2d primitives order their vertices in what I’ll call “hull order”, which is to say, in an sequential outline of the shape. A Rectangle, for example, is:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let</span><span> positions </span><span style=color:#ed9366>= </span><span style=color:#f07171>vec!</span><span>[
</span><span>  [hw</span><span style=color:#61676ccc>,</span><span> hh</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.0</span><span>]</span><span style=color:#61676ccc>,
</span><span>  [</span><span style=color:#ed9366>-</span><span>hw</span><span style=color:#61676ccc>,</span><span> hh</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.0</span><span>]</span><span style=color:#61676ccc>,
</span><span>  [</span><span style=color:#ed9366>-</span><span>hw</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>-</span><span>hh</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.0</span><span>]</span><span style=color:#61676ccc>,
</span><span>  [hw</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>-</span><span>hh</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.0</span><span>]</span><span style=color:#61676ccc>,
</span><span>]</span><span style=color:#61676ccc>;
</span></code></pre><p>The Rhombus does not follow this pattern, instead using “right, left, top, bottom” order for the vertex buffer.<p>This isn’t a general issue, but there is definitely a pattern to the way the shapes are laid out, and Rhombus doesn’t follow it. This means you can use the vertex buffer alone to define a hull for most 2d shapes (regular polygons, lines, circles, capsules, etc), except the rhombus (also not valid for annulus/ring afaik)<h2 id=solution>Solution</h2><p>Re-order the indices and vertices for Rhombus, resulting in the same output, but enabling the vertex buffer to be used to define a “hull” directly, without the index buffer.<h2 id=testing>Testing</h2><p>Run the 2d_shapes demo, see wireframe is as expected.</p><img alt="screenshot-2025-10-21-at-09 03 12@2x" height=910 src=https://github.com/user-attachments/assets/d95237a0-5fe1-4cd8-a4a5-0b8849557427 width=2432><hr><h2 id=showcase>Showcase</h2><p>In a 2d visibility mesh demo I was building, this caused an issue when trying to directly use the vertex buffer to define the outer “hull” shape.<p>old rhombus on left, new rhombus on right.</p><img alt="screenshot-2025-10-21-at-08 40 14@2x" height=238 src=https://github.com/user-attachments/assets/22cb2ff2-7070-4c46-bc7f-d6d18372af79 width=334><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a consistency issue in Bevy’s 2D mesh primitives where the Rhombus shape didn’t follow the established “hull order” pattern used by other shapes. The problem emerged when the author was building a 2D visibility mesh system and discovered that the rhombus vertex buffer couldn’t be used directly to define the outer hull shape, unlike other primitives.<p>The core issue was that most Bevy 2D primitives organize their vertices in sequential outline order, creating a natural hull when traversed. For example, a rectangle’s vertices follow a clockwise or counter-clockwise path around the shape. However, the rhombus used a different ordering scheme: “right, left, top, bottom” - essentially grouping vertices by axis alignment rather than sequential position around the perimeter.<p>The solution involved reordering the triangle indices while keeping the vertex positions unchanged. The change from <code>[0, 1, 2, 2, 3, 0]</code> to <code>[2, 0, 1, 2, 3, 0]</code> maintains the same visual output but reorganizes how the triangles are constructed. This subtle change enables the vertex buffer to be interpreted as a sequential hull when needed, while preserving backward compatibility for rendering purposes.<p>From an engineering perspective, this change demonstrates the importance of consistent data organization patterns in graphics programming. The vertex buffer serves dual purposes: it defines the geometry for rendering through the index buffer, but can also be used directly for computational geometry tasks like hull detection and visibility calculations. By aligning the rhombus with the established pattern, the PR maintains consistency across the 2D primitive ecosystem.<p>The implementation is minimal and surgical - a single line change that modifies only the index ordering. This approach ensures zero performance impact while enabling new use cases. The testing strategy was straightforward: verify that the wireframe rendering remains identical, confirming that the visual output is preserved while the underlying data organization improves.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[Rhombus Mesh Builder] --> B[Vertex Buffer]
</span><span>    A --> C[Index Buffer]
</span><span>    C --> D[Triangle 1: 2,0,1]
</span><span>    C --> E[Triangle 2: 2,3,0]
</span><span>    B --> F[Hull Order Consistency]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ul><li><code>crates/bevy_mesh/src/primitives/dim2.rs</code> (+1/-1)</ul><p>The only change modifies the index buffer ordering in the RhombusMeshBuilder implementation:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// File: crates/bevy_mesh/src/primitives/dim2.rs
</span><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> indices </span><span style=color:#ed9366>= </span><span>Indices</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>U32</span><span>(</span><span style=color:#f07171>vec!</span><span>[</span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>2</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>2</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>3</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span>])</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> indices </span><span style=color:#ed9366>= </span><span>Indices</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>U32</span><span>(</span><span style=color:#f07171>vec!</span><span>[</span><span style=color:#ff8f40>2</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>2</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>3</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span>])</span><span style=color:#61676ccc>;
</span></code></pre><p>This change reorganizes the triangle construction while maintaining the same geometric output. The vertex positions remain unchanged at:<ul><li><code>[self.half_diagonals.x, 0.0, 0.0]</code> (right)<li><code>[-self.half_diagonals.x, 0.0, 0.0]</code> (left)<li><code>[0.0, self.half_diagonals.y, 0.0]</code> (top)<li><code>[0.0, -self.half_diagonals.y, 0.0]</code> (bottom)</ul><p>The new index ordering creates triangles that follow a more sequential pattern around the shape, enabling direct use of the vertex buffer for hull detection without requiring index buffer processing.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_mesh/latest/bevy_mesh/primitives/index.html target=_blank>Bevy Mesh Primitives Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Triangle_mesh target=_blank>Computer Graphics: Triangle Mesh Representation</a><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Convex_hull_algorithms target=_blank>2D Convex Hull Algorithms</a></ul><h1 id=full-code-diff>Full Code Diff</h1><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_mesh/src/primitives/dim2.rs b/crates/bevy_mesh/src/primitives/dim2.rs
</span><span>index f2a5862c6f390..2a8bb4edf50cf 100644
</span><span style=color:#c594c5>--- a/crates/bevy_mesh/src/primitives/dim2.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_mesh/src/primitives/dim2.rs
</span><span style=color:#c594c5>@@ -906,7 +906,7 @@ </span><span style=color:#399ee6>impl MeshBuilder for RhombusMeshBuilder {
</span><span>         ];
</span><span>         let normals = vec![[0.0, 0.0, 1.0]; 4];
</span><span>         let uvs = vec![[1.0, 0.5], [0.5, 0.0], [0.0, 0.5], [0.5, 1.0]];
</span><span style=color:#f07171>-        let indices = Indices::U32(vec![0, 1, 2, 2, 3, 0]);
</span><span style=color:#86b300>+        let indices = Indices::U32(vec![2, 0, 1, 2, 3, 0]);
</span><span> 
</span><span>         Mesh::new(
</span><span>             PrimitiveTopology::TriangleList,
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-11/pr_21621.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>