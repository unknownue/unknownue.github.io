<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21672 Update taffy to 0.9 and fix Grid errors #21240
        
    </title><meta content="#21672 Update taffy to 0.9 and fix Grid errors #21240" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-11/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-11-03</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-11/pr-21672-zh-cn-20251103>中文</a></div></div><div class=pr-content><h1 id=update-taffy-to-0-9-and-fix-grid-errors-21240>Update taffy to 0.9 and fix Grid errors #21240</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Update taffy to 0.9 and fix Grid errors #21240<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21672<li><strong>Author</strong>: rossleonardy<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Dependencies, A-UI, S-Ready-For-Final-Review, X-Contentious<li><strong>Created</strong>: 2025-10-28T00:20:03Z<li><strong>Merged</strong>: 2025-11-03T19:06:01Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p><strong>Objective</strong><ul><li>#21240<li>Update taffy to 0.9.1 and grid placement with start and ends works again.</ul><p><strong>Solution</strong> I had to make some rather un-ergonomic changes I would like advice on, so I’ve left comments below.<p><strong>Testing</strong><ul><li>Pending…</ul><hr><p><strong>Showcase</strong></p><img alt="Screenshot 2025-10-27 at 8 18 50 PM" height=740 src=https://github.com/user-attachments/assets/50ec2de2-288f-4f8a-9e20-216bd9d1474d width=912><p>Fixes issue with grid start and ends…<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a dependency upgrade challenge where the Bevy UI system needed to migrate from Taffy 0.7 to 0.9.1 to fix broken grid placement functionality. The core problem was that Taffy’s API underwent significant breaking changes between versions, requiring substantial refactoring of Bevy’s layout conversion layer.<p>The migration began with updating the dependency specification in <code>Cargo.toml</code>. The Taffy 0.9 version required explicit feature flags and disabled default features, reflecting the library’s more modular architecture in the newer version:<pre class=language-toml data-lang=toml style=color:#61676c;background-color:#fafafa><code class=language-toml data-lang=toml><span style=color:#399ee6>taffy </span><span>= { </span><span style=color:#399ee6>version </span><span>= </span><span style=color:#86b300>"0.9"</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>default-features </span><span>= </span><span style=color:#ff8f40>false</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>features </span><span>= [
</span><span>  </span><span style=color:#86b300>"std"</span><span style=color:#61676ccc>,
</span><span>  </span><span style=color:#86b300>"block_layout"</span><span style=color:#61676ccc>,
</span><span>  </span><span style=color:#86b300>"flexbox"</span><span style=color:#61676ccc>,
</span><span>  </span><span style=color:#86b300>"grid"</span><span style=color:#61676ccc>,
</span><span>  </span><span style=color:#86b300>"content_size"</span><span style=color:#61676ccc>,
</span><span>  </span><span style=color:#86b300>"taffy_tree"</span><span style=color:#61676ccc>,
</span><span>] }
</span></code></pre><p>The most extensive changes occurred in <code>convert.rs</code>, where the conversion logic between Bevy’s layout types and Taffy’s types needed complete restructuring. The Taffy 0.9 API introduced helper functions and changed enum variants from direct constructors to function calls. For example, converting <code>Val::Auto</code> changed from:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before (Taffy 0.7):
</span><span>Val</span><span style=color:#ed9366>::</span><span>Auto </span><span style=color:#ed9366>=> </span><span>taffy</span><span style=color:#ed9366>::</span><span>style</span><span style=color:#ed9366>::</span><span>LengthPercentageAuto</span><span style=color:#ed9366>::</span><span>Auto</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After (Taffy 0.9):
</span><span>Val</span><span style=color:#ed9366>::</span><span>Auto </span><span style=color:#ed9366>=> </span><span>style_helpers</span><span style=color:#ed9366>::</span><span>auto()</span><span style=color:#61676ccc>,
</span></code></pre><p>This pattern repeated throughout the conversion functions, affecting length percentages, track sizing functions, and grid templates. The grid system required particular attention because Taffy 0.9 introduced generic types for grid placement and changed the <code>GridTemplateComponent</code> structure.<p>One significant technical challenge was maintaining thread safety. Taffy 0.9’s <code>TaffyTree</code> isn’t thread-safe when using the <code>calc</code> feature, so the solution wrapped it in a custom <code>UiTree</code> type with manual <code>Send</code> and <code>Sync</code> implementations:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>UiTree</span><span>&LTT>(TaffyTree&LTT>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>expect</span><span>(unsafe_code</span><span style=color:#61676ccc>,</span><span> reason </span><span style=color:#ed9366>= </span><span style=color:#86b300>"TaffyTree is safe as long as calc is not used"</span><span>)]
</span><span style=color:#fa6e32>unsafe impl </span><span>Send </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>UiTree</span><span>&LTNodeMeasure> {}
</span><span>
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>expect</span><span>(unsafe_code</span><span style=color:#61676ccc>,</span><span> reason </span><span style=color:#ed9366>= </span><span style=color:#86b300>"TaffyTree is safe as long as calc is not used"</span><span>)]
</span><span style=color:#fa6e32>unsafe impl </span><span>Sync </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>UiTree</span><span>&LTNodeMeasure> {}
</span></code></pre><p>The image widget measurement system also needed adaptation because Taffy 0.9 changed the <code>maybe_resolve</code> method signature to require a function pointer for calc resolution. Since Bevy doesn’t use this feature, a no-op function was provided:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>fn </span><span style=color:#f29718>resolve_calc</span><span>(</span><span style=color:#ff8f40>_calc_ptr</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>*const </span><span>(), </span><span style=color:#ff8f40>_parent_size</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>f32 </span><span>{
</span><span>    </span><span style=color:#ff8f40>0.0
</span><span>}
</span></code></pre><p>Throughout the conversion, the developer maintained the existing Bevy UI semantics while adapting to Taffy’s new API patterns. The changes ensured that grid placement with start and end specifications worked correctly again, as demonstrated by the showcase image showing properly positioned grid elements.<p>The migration required careful attention to detail because many Taffy enum variants changed from direct constructors to function calls, and the grid system API underwent significant restructuring. The solution maintains backward compatibility for Bevy UI users while fixing the underlying grid placement issues.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Taffy 0.7] --> B[API Breaking Changes]
</span><span>    B --> C[Convert.rs Refactor]
</span><span>    B --> D[Thread Safety Wrapper]
</span><span>    B --> E[Grid System Updates]
</span><span>    C --> F[Helper Function Migration]
</span><span>    D --> G[UiTree Wrapper]
</span><span>    E --> H[Grid Placement Fix]
</span><span>    F --> I[Working Grid System]
</span><span>    G --> I
</span><span>    H --> I
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ui-src-layout-convert-rs-100-103><code>crates/bevy_ui/src/layout/convert.rs</code> (+100/-103)</h3><p>This file underwent the most extensive changes, converting from Taffy 0.7’s direct enum constructors to Taffy 0.9’s helper function API. The changes affected value conversions, grid placement, and track sizing functions.<p><strong>Key changes:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>Val</span><span style=color:#ed9366>::</span><span>Auto </span><span style=color:#ed9366>=> </span><span>taffy</span><span style=color:#ed9366>::</span><span>style</span><span style=color:#ed9366>::</span><span>LengthPercentageAuto</span><span style=color:#ed9366>::</span><span>Auto</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>Val</span><span style=color:#ed9366>::</span><span>Auto </span><span style=color:#ed9366>=> </span><span>style_helpers</span><span style=color:#ed9366>::</span><span>auto()</span><span style=color:#61676ccc>,
</span></code></pre><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Grid placement conversion updated:
</span><span style=color:#fa6e32>impl </span><span style=color:#55b4d4;font-style:italic>From</span><span>&LTGridPlacement> </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>taffy</span><span>::</span><span style=color:#399ee6>geometry</span><span>::</span><span style=color:#399ee6>Line</span><span>&LTtaffy</span><span style=color:#ed9366>::</span><span>style</span><span style=color:#ed9366>::</span><span>GridPlacement<</span><span style=color:#55b4d4;font-style:italic>String</span><span>>> {
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>from</span><span>(</span><span style=color:#ff8f40>value</span><span style=color:#61676ccc>:</span><span> GridPlacement) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// Implementation adapted for new generic type
</span><span>    }
</span><span>}
</span></code></pre><h3 id=crates-bevy-ui-src-layout-ui-surface-rs-29-5><code>crates/bevy_ui/src/layout/ui_surface.rs</code> (+29/-5)</h3><p>Added thread safety wrapper for TaffyTree and updated viewport node styling to use new helper functions.<p><strong>Key addition:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>UiTree</span><span>&LTT>(TaffyTree&LTT>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Manual Send/Sync implementations for thread safety
</span><span style=color:#fa6e32>unsafe impl </span><span>Send </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>UiTree</span><span>&LTNodeMeasure> {}
</span><span style=color:#fa6e32>unsafe impl </span><span>Sync </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>UiTree</span><span>&LTNodeMeasure> {}
</span></code></pre><h3 id=crates-bevy-ui-src-widget-image-rs-23-6><code>crates/bevy_ui/src/widget/image.rs</code> (+23/-6)</h3><p>Updated measurement system to work with Taffy 0.9’s new <code>maybe_resolve</code> method signature.<p><strong>Key change:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added no-op function for calc resolution
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>resolve_calc</span><span>(</span><span style=color:#ff8f40>_calc_ptr</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>*const </span><span>(), </span><span style=color:#ff8f40>_parent_size</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>f32 </span><span>{
</span><span>    </span><span style=color:#ff8f40>0.0
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Updated method calls:
</span><span style=color:#fa6e32>let</span><span> s_width </span><span style=color:#ed9366>=</span><span> style</span><span style=color:#ed9366>.</span><span>size</span><span style=color:#ed9366>.</span><span>width</span><span style=color:#ed9366>.</span><span style=color:#f07171>maybe_resolve</span><span>(parent_width</span><span style=color:#61676ccc>,</span><span> resolve_calc)</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-ui-cargo-toml-8-1><code>crates/bevy_ui/Cargo.toml</code> (+8/-1)</h3><p>Updated Taffy dependency with explicit feature flags and disabled default features.<h3 id=crates-bevy-ui-src-layout-mod-rs-1-1><code>crates/bevy_ui/src/layout/mod.rs</code> (+1/-1)</h3><p>Updated error type to match Taffy 0.9’s reorganized module structure.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://github.com/DioxusLabs/taffy/blob/main/UPGRADE_GUIDE.md target=_blank>Taffy 0.9 Migration Guide</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/ui/ target=_blank>Bevy UI Layout System Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Grid_Layout target=_blank>CSS Grid Layout Specification</a> (relevant for understanding grid placement concepts)</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-11/pr_21672.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>