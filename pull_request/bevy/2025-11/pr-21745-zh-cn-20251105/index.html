<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21745 Add a dense layout to the `many_cubes` stress test
        
    </title><meta content="#21745 Add a dense layout to the `many_cubes` stress test" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-11/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-11-05</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2025-11/pr-21745-en-20251105>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=tian-jia-mi-ji-bu-ju-dao-many-cubes-ya-li-ce-shi>添加密集布局到 <code>many_cubes</code> 压力测试</h1><h2 id=ji-ben-xin-xi>基本信息</h2><ul><li><strong>标题</strong>: Add a dense layout to the <code>many_cubes</code> stress test<li><strong>PR链接</strong>: https://github.com/bevyengine/bevy/pull/21745<li><strong>作者</strong>: DeVelox<li><strong>状态</strong>: 已合并<li><strong>标签</strong>: A-Rendering, C-Examples, S-Ready-For-Final-Review, C-Testing<li><strong>创建时间</strong>: 2025-11-05T00:52:07Z<li><strong>合并时间</strong>: 2025-11-05T18:37:48Z<li><strong>合并者</strong>: alice-i-cecile</ul><h2 id=miao-shu-fan-yi>描述翻译</h2><h1 id=mu-biao>目标</h1><ul><li>测试大量重叠立方体（全部位于相机视锥体内）对可见性/遮挡计算的影响，特别是在启用连续旋转和阴影的情况下。</ul><h2 id=jie-jue-fang-an>解决方案</h2><ul><li>使用静态相机添加密集立方体布局，并添加切换单个立方体旋转的选项。</ul><h2 id=ce-shi>测试</h2><ul><li>我分几个阶段运行了测试，每个阶段都导致了显著的性能下降。 <ul><li>阶段1：仅使用密集布局。<li>阶段2：使用密集布局并启用旋转或阴影。<li>阶段3：使用密集布局同时启用旋转和阴影。</ul></ul><pre style=color:#61676c;background-color:#fafafa><code><span>cargo run --release --example many_cubes -- --layout dense --rotate-cubes --shadows
</span></code></pre><hr><h2 id=zhan-shi>展示</h2><img alt=image height=940 src=https://github.com/user-attachments/assets/6fc811aa-81fa-4130-a6e0-0a017bc99f19 width=1904><h2 id=zhe-ge-pull-requestde-gu-shi>这个Pull Request的故事</h2><h3 id=wen-ti-bei-jing-yu-ce-shi-xu-qiu>问题背景与测试需求</h3><p>在游戏引擎开发中，渲染性能测试是确保引擎稳定性的关键环节。Bevy引擎的<code>many_cubes</code>示例原本提供了两种布局模式：立方体阵列和球体分布，主要用于测试视锥体剔除和基本渲染性能。然而，这些测试场景未能充分模拟真实游戏中常见的密集物体重叠情况。<p>开发者DeVelox识别到一个重要的测试缺口：当大量物体在视锥体内重叠时，可见性计算和遮挡剔除的性能表现。特别是在启用动态效果（如旋转）和复杂光照（如阴影）的情况下，渲染管线的压力会显著增加。现有的测试布局无法有效验证这些边界情况下的性能表现。<h3 id=ji-shu-fang-an-she-ji>技术方案设计</h3><p>为了解决这个问题，PR采用了三个核心改进：<ol><li><strong>新增密集布局模式</strong>：创建一个所有立方体都在相机视锥体内的密集排列<li><strong>条件化系统调度</strong>：根据布局模式动态调整启用的系统<li><strong>独立旋转控制</strong>：为每个立方体添加独立的旋转动画选项</ol><h3 id=shi-xian-xi-jie-fen-xi>实现细节分析</h3><h4 id=bu-ju-mei-ju-kuo-zhan>布局枚举扩展</h4><p>首先扩展了<code>Layout</code>枚举，新增<code>Dense</code>变体：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Default</span><span style=color:#61676ccc>,</span><span> Clone</span><span style=color:#61676ccc>,</span><span> PartialEq)]
</span><span style=color:#fa6e32>enum </span><span style=color:#399ee6>Layout </span><span>{
</span><span>    Cube</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>default</span><span>]
</span><span>    Sphere</span><span style=color:#61676ccc>,
</span><span>    Dense</span><span style=color:#61676ccc>,  </span><span style=color:#abb0b6;font-style:italic>// 新增密集布局
</span><span>}
</span></code></pre><p>这个变更保持了向后兼容性，同时为新的测试场景提供了明确的类型标识。<h4 id=tiao-jian-hua-xi-tong-diao-du>条件化系统调度</h4><p>在应用构建过程中，根据布局和参数动态调整系统：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>if</span><span> args</span><span style=color:#ed9366>.</span><span>layout </span><span style=color:#ed9366>!= </span><span>Layout</span><span style=color:#ed9366>::</span><span>Dense {
</span><span>    app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(Update</span><span style=color:#61676ccc>,</span><span> move_camera)</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#fa6e32>if</span><span> args</span><span style=color:#ed9366>.</span><span>rotate_cubes {
</span><span>    app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(Update</span><span style=color:#61676ccc>,</span><span> rotate_cubes)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>这种条件化调度体现了Bevy ECS系统的灵活性——密集布局使用静态相机，而其他布局保持相机移动；旋转系统只在明确启用时才加入更新循环。<h4 id=mi-ji-bu-ju-shi-xian>密集布局实现</h4><p>密集布局的核心算法使用立方根计算来创建紧凑的三维网格：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>Layout</span><span style=color:#ed9366>::</span><span>Dense </span><span style=color:#ed9366>=> </span><span>{
</span><span>    </span><span style=color:#fa6e32>let</span><span> count </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>WIDTH </span><span style=color:#ed9366>* </span><span style=color:#ff8f40>HEIGHT </span><span style=color:#ed9366>* </span><span style=color:#ff8f40>2</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> size </span><span style=color:#ed9366>= </span><span style=color:#f07171>cbrt</span><span>(count </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>round</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> gap </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>1.25</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#fa6e32>let</span><span> cubes </span><span style=color:#ed9366>= </span><span>(</span><span style=color:#ff8f40>0</span><span style=color:#ed9366>..</span><span>count)</span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(</span><span style=color:#fa6e32>move </span><span style=color:#ed9366>|</span><span>i</span><span style=color:#ed9366>| </span><span>{
</span><span>        </span><span style=color:#fa6e32>let</span><span> x </span><span style=color:#ed9366>=</span><span> i </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32 </span><span style=color:#ed9366>%</span><span> size</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#fa6e32>let</span><span> y </span><span style=color:#ed9366>= </span><span>(i </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32 </span><span style=color:#ed9366>/</span><span> size) </span><span style=color:#ed9366>%</span><span> size</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#fa6e32>let</span><span> z </span><span style=color:#ed9366>=</span><span> i </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32 </span><span style=color:#ed9366>/ </span><span>(size </span><span style=color:#ed9366>*</span><span> size)</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#fa6e32>let</span><span> pos </span><span style=color:#ed9366>= </span><span>Vec3</span><span style=color:#ed9366>::</span><span>new(x </span><span style=color:#ed9366>*</span><span> gap</span><span style=color:#61676ccc>,</span><span> y </span><span style=color:#ed9366>*</span><span> gap</span><span style=color:#61676ccc>,</span><span> z </span><span style=color:#ed9366>*</span><span> gap)</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// 创建变换和材质
</span><span>    })</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>这种布局确保了所有立方体都在相机视锥体内，为可见性计算提供了最大压力测试。<h4 id=xuan-zhuan-xi-tong-shi-xian>旋转系统实现</h4><p>新增的旋转系统使用并行迭代器处理大量实体的变换更新：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>fn </span><span style=color:#f29718>rotate_cubes</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>query</span><span style=color:#61676ccc>: </span><span>Query<</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> Transform, (With&LTMesh3d>, Without&LTNotShadowCaster>)>,
</span><span>    </span><span style=color:#ff8f40>time</span><span style=color:#61676ccc>: </span><span>Res&LTTime>,
</span><span>) {
</span><span>    query</span><span style=color:#ed9366>.</span><span style=color:#f07171>par_iter_mut</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>for_each</span><span>(|</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>transform</span><span>| {
</span><span>        transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>rotate_y</span><span>(</span><span style=color:#ff8f40>10.0 </span><span style=color:#ed9366>*</span><span> time</span><span style=color:#ed9366>.</span><span style=color:#f07171>delta_secs</span><span>())</span><span style=color:#61676ccc>;
</span><span>    })</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>这种实现充分利用了Bevy的并行查询能力，确保即使处理数千个旋转立方体也能保持良好性能。<h3 id=ji-shu-dong-cha-yu-gong-cheng-kao-liang>技术洞察与工程考量</h3><h4 id=xing-neng-ce-shi-de-fen-ceng-fang-fa>性能测试的分层方法</h4><p>PR作者采用了分层测试策略，逐步增加复杂度：<ol><li>基础密集布局测试渲染管线压力<li>添加旋转测试动态场景性能<li>启用阴影测试光照计算开销<li>组合所有特性测试极限情况</ol><p>这种渐进式方法有助于精确识别性能瓶颈所在。<h4 id=shu-xue-ji-suan-de-you-hua>数学计算的优化</h4><p>使用<code>cbrt</code>（立方根）函数而不是手动计算<code>count.powf(1.0/3.0)</code>，体现了对标准库函数的合理利用，既提高了代码可读性又确保了计算精度。<h4 id=jia-gou-she-ji-de-ling-huo-xing>架构设计的灵活性</h4><p>通过条件化系统添加，这个实现展示了Bevy ECS架构的模块化优势。系统可以根据运行时配置动态组合，而不需要复杂的继承或条件逻辑。<h3 id=ying-xiang-yu-jia-zhi>影响与价值</h3><p>这个PR为Bevy引擎添加了重要的压力测试能力：<ol><li><strong>更全面的性能覆盖</strong>：密集布局填补了现有测试场景的空白<li><strong>可配置的测试复杂度</strong>：通过命令行参数灵活组合测试条件<li><strong>真实的性能基准</strong>：为引擎优化提供了更有代表性的性能数据</ol><p>特别是对于可见性系统和遮挡剔除算法的开发，这个测试场景能够暴露在密集物体情况下的性能问题。<h2 id=ke-shi-hua-biao-shi>可视化表示</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TB
</span><span>    A[ManyCubes示例] --> B[布局选择]
</span><span>    B --> C[立方体布局]
</span><span>    B --> D[球体布局]
</span><span>    B --> E[密集布局]
</span><span>    
</span><span>    E --> F[静态相机]
</span><span>    E --> G[密集立方体阵列]
</span><span>    
</span><span>    H[旋转参数] --> I[旋转系统]
</span><span>    I --> G
</span><span>    
</span><span>    J[阴影参数] --> K[阴影渲染]
</span><span>    K --> G
</span></code></pre><h2 id=guan-jian-wen-jian-bian-geng>关键文件变更</h2><h3 id=examples-stress-tests-many-cubes-rs-57-5><code>examples/stress_tests/many_cubes.rs</code> (+57/-5)</h3><p>这是PR中唯一修改的文件，包含了所有核心实现：<ol><li><strong>布局枚举扩展</strong>：</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 之前：
</span><span style=color:#fa6e32>enum </span><span style=color:#399ee6>Layout </span><span>{
</span><span>    Cube</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>default</span><span>]
</span><span>    Sphere</span><span style=color:#61676ccc>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 之后：
</span><span style=color:#fa6e32>enum </span><span style=color:#399ee6>Layout </span><span>{
</span><span>    Cube</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>default</span><span>]
</span><span>    Sphere</span><span style=color:#61676ccc>,
</span><span>    Dense</span><span style=color:#61676ccc>,  </span><span style=color:#abb0b6;font-style:italic>// 新增密集布局
</span><span>}
</span></code></pre><ol start=2><li><strong>命令行参数扩展</strong>：</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 新增旋转立方体选项
</span><span style=color:#abb0b6;font-style:italic>/// whether to continuously rotate individual cubes.
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>argh</span><span>(switch)]
</span><span>rotate_cubes</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>bool</span><span style=color:#61676ccc>,
</span></code></pre><ol start=3><li><strong>密集布局实现</strong>：</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>Layout</span><span style=color:#ed9366>::</span><span>Dense </span><span style=color:#ed9366>=> </span><span>{
</span><span>    </span><span style=color:#fa6e32>let</span><span> count </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>WIDTH </span><span style=color:#ed9366>* </span><span style=color:#ff8f40>HEIGHT </span><span style=color:#ed9366>* </span><span style=color:#ff8f40>2</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> size </span><span style=color:#ed9366>= </span><span style=color:#f07171>cbrt</span><span>(count </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>round</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> gap </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>1.25</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 创建密集立方体网格
</span><span>    </span><span style=color:#fa6e32>let</span><span> cubes </span><span style=color:#ed9366>= </span><span>(</span><span style=color:#ff8f40>0</span><span style=color:#ed9366>..</span><span>count)</span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(</span><span style=color:#fa6e32>move </span><span style=color:#ed9366>|</span><span>i</span><span style=color:#ed9366>| </span><span>{
</span><span>        </span><span style=color:#fa6e32>let</span><span> x </span><span style=color:#ed9366>=</span><span> i </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32 </span><span style=color:#ed9366>%</span><span> size</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#fa6e32>let</span><span> y </span><span style=color:#ed9366>= </span><span>(i </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32 </span><span style=color:#ed9366>/</span><span> size) </span><span style=color:#ed9366>%</span><span> size</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#fa6e32>let</span><span> z </span><span style=color:#ed9366>=</span><span> i </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>f32 </span><span style=color:#ed9366>/ </span><span>(size </span><span style=color:#ed9366>*</span><span> size)</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#fa6e32>let</span><span> pos </span><span style=color:#ed9366>= </span><span>Vec3</span><span style=color:#ed9366>::</span><span>new(x </span><span style=color:#ed9366>*</span><span> gap</span><span style=color:#61676ccc>,</span><span> y </span><span style=color:#ed9366>*</span><span> gap</span><span style=color:#61676ccc>,</span><span> z </span><span style=color:#ed9366>*</span><span> gap)</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// 变换和材质配置
</span><span>    })</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 静态相机配置
</span><span>    commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((
</span><span>        Camera3d</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>,
</span><span>        Transform</span><span style=color:#ed9366>::</span><span>from_xyz(</span><span style=color:#ff8f40>100.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>90.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>100.0</span><span>)
</span><span>            </span><span style=color:#ed9366>.</span><span style=color:#f07171>looking_at</span><span>(Vec3</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ff8f40>0.0</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>-</span><span style=color:#ff8f40>10.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.0</span><span>)</span><span style=color:#61676ccc>, </span><span>Vec3</span><span style=color:#ed9366>::</span><span>Y)</span><span style=color:#61676ccc>,
</span><span>    ))</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><ol start=4><li><strong>旋转系统实现</strong>：</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 新增旋转系统
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>rotate_cubes</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>query</span><span style=color:#61676ccc>: </span><span>Query<</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> Transform, (With&LTMesh3d>, Without&LTNotShadowCaster>)>,
</span><span>    </span><span style=color:#ff8f40>time</span><span style=color:#61676ccc>: </span><span>Res&LTTime>,
</span><span>) {
</span><span>    query</span><span style=color:#ed9366>.</span><span style=color:#f07171>par_iter_mut</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>for_each</span><span>(|</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>transform</span><span>| {
</span><span>        transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>rotate_y</span><span>(</span><span style=color:#ff8f40>10.0 </span><span style=color:#ed9366>*</span><span> time</span><span style=color:#ed9366>.</span><span style=color:#f07171>delta_secs</span><span>())</span><span style=color:#61676ccc>;
</span><span>    })</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>这些变更共同实现了为压力测试添加密集布局的目标，提供了更全面的性能测试覆盖。<h2 id=jin-yi-bu-yue-du>进一步阅读</h2><p>对于想要深入了解相关概念的开发者，建议参考：<ol><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/ecs/system-scheduling/ target=_blank>Bevy ECS系统调度文档</a><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Hidden-surface_determination target=_blank>可见性剔除算法研究</a><li><a rel="noopener nofollow noreferrer" href=https://gameprogrammingpatterns.com/component.html target=_blank>并行计算在游戏引擎中的应用</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/docs/plugins_guidelines.md#performance-benchmarks target=_blank>性能分析与基准测试最佳实践</a></ol></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-11/pr_21745.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>