<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21835 Fix bevy_ui_widgets scrollbar bug where scrollbar_size wasn't taken into account
        
    </title><meta content="#21835 Fix bevy_ui_widgets scrollbar bug where scrollbar_size wasn't taken into account" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-11/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-11-17</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-11/pr-21835-zh-cn-20251117>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix bevy_ui_widgets scrollbar bug where scrollbar_size wasn’t taken into account<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21835<li><strong>Author</strong>: PPakalns<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-UI, S-Ready-For-Final-Review, D-Straightforward<li><strong>Created</strong>: 2025-11-14T10:35:35Z<li><strong>Merged</strong>: 2025-11-17T00:12:36Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Bevy ui widget scrollbar implementation didn’t correctly handle scrollbar width inserted by taffy.<h2 id=solution>Solution</h2><p>Correctly handle scrollbar width similarly as it is done in bevy engine scroll position calculation:<p>https://github.com/bevyengine/bevy/blob/0d46518eb21df54ba951f503930501bc2639e2a2/crates/bevy_ui/src/layout/mod.rs#L334-L336<h2 id=testing>Testing</h2><ul><li>In personal project added scrollareas with scrollbars that automatically attach to overflow: scroll elements and utilize space provided by taffy scrollbar-width.</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a subtle but important bug in the bevy_ui_widgets scrollbar implementation. The core issue was that the scrollbar calculations weren’t accounting for the space reserved by Taffy (Bevy’s layout engine) for the scrollbars themselves, leading to incorrect scroll position calculations and visual misalignments.<p>The problem manifested in three key interaction points where scrollbar calculations occur: when clicking on the scrollbar track, during drag operations, and when updating the scrollbar thumb position. In each case, the visible area calculation was using the full container size without subtracting the space allocated for scrollbars.<p>The fix follows the established pattern already present in Bevy’s core scroll position calculations. By subtracting <code>scrollbar_size</code> from the container size before calculating the visible area, the implementation now correctly accounts for the actual content display area rather than the total container dimensions.<p>Looking at the specific changes, each affected function now calculates the visible size as:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> visible_size </span><span style=color:#ed9366>=</span><span> scroll_content</span><span style=color:#ed9366>.</span><span style=color:#f07171>size</span><span>() </span><span style=color:#ed9366>*</span><span> scroll_content</span><span style=color:#ed9366>.</span><span>inverse_scale_factor</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> visible_size </span><span style=color:#ed9366>= </span><span>(scroll_content</span><span style=color:#ed9366>.</span><span style=color:#f07171>size</span><span>() </span><span style=color:#ed9366>-</span><span> scroll_content</span><span style=color:#ed9366>.</span><span>scrollbar_size)
</span><span>    </span><span style=color:#ed9366>*</span><span> scroll_content</span><span style=color:#ed9366>.</span><span>inverse_scale_factor</span><span style=color:#61676ccc>;
</span></code></pre><p>This change ensures that scroll position calculations, thumb sizing, and drag behavior all work with the correct dimensions. The scrollbar thumb now properly represents the proportional relationship between visible content and total content, and clicking on the scrollbar track moves the content by the correct amount.<p>The implementation maintains consistency with Bevy’s existing scroll handling patterns, which is evident from the reference to the core layout module where similar calculations are performed. This alignment with established patterns makes the fix more maintainable and reduces the cognitive load for developers working across different parts of the UI system.<p>From an engineering perspective, this fix demonstrates the importance of understanding how layout engines allocate space and ensuring that interaction logic respects those allocations. The bug was particularly subtle because it only manifested when scrollbars were actually present and taking up space - in cases where content fit entirely within the container, the calculations would appear correct.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[User Interaction] --> B[Scrollbar Calculation]
</span><span>    B --> C[Visible Size Calculation]
</span><span>    C --> D{Includes scrollbar_size?}
</span><span>    D -->|No| E[Bug: Incorrect scrolling]
</span><span>    D -->|Yes| F[Fixed: Proper scrolling]
</span><span>    B --> G[Thumb Position Update]
</span><span>    G --> H{Accounts for scrollbar space?}
</span><span>    H -->|No| I[Bug: Misaligned thumb]
</span><span>    H -->|Yes| J[Fixed: Correct thumb position]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ui-widgets-src-scrollbar-rs-8-3><code>crates/bevy_ui_widgets/src/scrollbar.rs</code> (+8/-3)</h3><p>This file contains the scrollbar widget implementation. The changes fix the scrollbar_size calculation in three key functions:<ol><li><strong>scrollbar_on_pointer_down</strong> - Handles click events on the scrollbar track<li><strong>scrollbar_on_drag</strong> - Handles drag interactions with the scrollbar thumb<li><strong>update_scrollbar_thumb</strong> - Updates the scrollbar thumb position and size</ol><p><strong>Key changes:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before (line ~133):
</span><span style=color:#fa6e32>let</span><span> visible_size </span><span style=color:#ed9366>=</span><span> scroll_content</span><span style=color:#ed9366>.</span><span style=color:#f07171>size</span><span>() </span><span style=color:#ed9366>*</span><span> scroll_content</span><span style=color:#ed9366>.</span><span>inverse_scale_factor</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> visible_size </span><span style=color:#ed9366>= </span><span>(scroll_content</span><span style=color:#ed9366>.</span><span style=color:#f07171>size</span><span>() </span><span style=color:#ed9366>-</span><span> scroll_content</span><span style=color:#ed9366>.</span><span>scrollbar_size)
</span><span>    </span><span style=color:#ed9366>*</span><span> scroll_content</span><span style=color:#ed9366>.</span><span>inverse_scale_factor</span><span style=color:#61676ccc>;
</span></code></pre><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before (line ~196):
</span><span style=color:#fa6e32>let</span><span> visible_size </span><span style=color:#ed9366>=</span><span> scroll_content</span><span style=color:#ed9366>.</span><span style=color:#f07171>size</span><span>() </span><span style=color:#ed9366>*</span><span> scroll_content</span><span style=color:#ed9366>.</span><span>inverse_scale_factor</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> visible_size </span><span style=color:#ed9366>= </span><span>(scroll_content</span><span style=color:#ed9366>.</span><span style=color:#f07171>size</span><span>() </span><span style=color:#ed9366>-</span><span> scroll_content</span><span style=color:#ed9366>.</span><span>scrollbar_size)
</span><span>    </span><span style=color:#ed9366>*</span><span> scroll_content</span><span style=color:#ed9366>.</span><span>inverse_scale_factor</span><span style=color:#61676ccc>;
</span></code></pre><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before (line ~257):
</span><span style=color:#fa6e32>let</span><span> visible_size </span><span style=color:#ed9366>=</span><span> scroll_area</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>1.</span><span style=color:#f07171>size</span><span>() </span><span style=color:#ed9366>*</span><span> scroll_area</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>1.</span><span>inverse_scale_factor</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> visible_size </span><span style=color:#ed9366>= </span><span>(scroll_area</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>1.</span><span style=color:#f07171>size</span><span>() </span><span style=color:#ed9366>-</span><span> scroll_area</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>1.</span><span>scrollbar_size)
</span><span>    </span><span style=color:#ed9366>*</span><span> scroll_area</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>1.</span><span>inverse_scale_factor</span><span style=color:#61676ccc>;
</span></code></pre><p>These changes ensure that all scrollbar calculations properly account for the space allocated to scrollbars by the layout system, making the scrolling behavior accurate and consistent with user expectations.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/books/introduction/bevy-ui/ target=_blank>Bevy UI Documentation</a> - Official Bevy UI guide<li><a rel="noopener nofollow noreferrer" href=https://github.com/DioxusLabs/taffy target=_blank>Taffy Layout Engine</a> - The layout engine used by Bevy<li><a rel="noopener nofollow noreferrer" href=https://developer.mozilla.org/en-US/docs/Web/CSS/scrollbar-width target=_blank>Scroll Containment MDN</a> - CSS scrollbar width property documentation<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/examples/ui/scroll.rs target=_blank>Bevy Scroll Example</a> - Example of scrolling implementation in Bevy</ul><h1 id=full-code-diff>Full Code Diff</h1><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_ui_widgets/src/scrollbar.rs b/crates/bevy_ui_widgets/src/scrollbar.rs
</span><span>index 4d8b53cdb8de3..db3a166ac0be9 100644
</span><span style=color:#c594c5>--- a/crates/bevy_ui_widgets/src/scrollbar.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_ui_widgets/src/scrollbar.rs
</span><span style=color:#c594c5>@@ -130,7 +130,8 @@ </span><span style=color:#399ee6>fn scrollbar_on_pointer_down(
</span><span>         // Convert the click coordinates into a scroll position. If it's greater than the
</span><span>         // current scroll position, scroll forward by one step (visible size) otherwise scroll
</span><span>         // back.
</span><span style=color:#f07171>-        let visible_size = scroll_content.size() * scroll_content.inverse_scale_factor;
</span><span style=color:#86b300>+        let visible_size = (scroll_content.size() - scroll_content.scrollbar_size)
</span><span style=color:#86b300>+            * scroll_content.inverse_scale_factor;
</span><span>         let content_size = scroll_content.content_size() * scroll_content.inverse_scale_factor;
</span><span>         let max_range = (content_size - visible_size).max(Vec2::ZERO);
</span><span> 
</span><span style=color:#c594c5>@@ -193,8 +194,11 @@ </span><span style=color:#399ee6>fn scrollbar_on_drag(
</span><span> 
</span><span>         if drag.dragging {
</span><span>             let distance = ev.event().distance / ui_scale.0;
</span><span style=color:#f07171>-            let visible_size = scroll_content.size() * scroll_content.inverse_scale_factor;
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+            let visible_size = (scroll_content.size() - scroll_content.scrollbar_size)
</span><span style=color:#86b300>+                * scroll_content.inverse_scale_factor;
</span><span>             let content_size = scroll_content.content_size() * scroll_content.inverse_scale_factor;
</span><span style=color:#86b300>+
</span><span>             let scrollbar_size = (node.size() * node.inverse_scale_factor).max(Vec2::ONE);
</span><span> 
</span><span>             match scrollbar.orientation {
</span><span style=color:#c594c5>@@ -250,7 +254,8 @@ </span><span style=color:#399ee6>fn update_scrollbar_thumb(
</span><span>         };
</span><span> 
</span><span>         // Size of the visible scrolling area.
</span><span style=color:#f07171>-        let visible_size = scroll_area.1.size() * scroll_area.1.inverse_scale_factor;
</span><span style=color:#86b300>+        let visible_size = (scroll_area.1.size() - scroll_area.1.scrollbar_size)
</span><span style=color:#86b300>+            * scroll_area.1.inverse_scale_factor;
</span><span> 
</span><span>         // Size of the scrolling content.
</span><span>         let content_size = scroll_area.1.content_size() * scroll_area.1.inverse_scale_factor;
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-11/pr_21835.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>