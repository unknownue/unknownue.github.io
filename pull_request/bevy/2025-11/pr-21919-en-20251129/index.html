<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21919 Fix solari GI shadow regression
        
    </title><meta content="#21919 Fix solari GI shadow regression" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-11/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-11-29</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-11/pr-21919-zh-cn-20251129>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>Fix solari GI shadow regression<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix solari GI shadow regression<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21919<li><strong>Author</strong>: JMS55<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, S-Ready-For-Final-Review, P-Regression<li><strong>Created</strong>: 2025-11-23T21:20:39Z<li><strong>Merged</strong>: 2025-11-29T02:34:28Z<li><strong>Merged By</strong>: james7132</ul><h2 id=description-translation>Description Translation</h2><p>In https://github.com/bevyengine/bevy/pull/21649, I switched where visibility rays get traced, and while it improved DI, it regressed GI. I’m reverting the GI change to fix.<p>Before: <img alt=image height=1875 src=https://github.com/user-attachments/assets/379c613a-2a36-4fe0-81f1-9e278b28ca37 width=3206><p>After: <img alt=image height=1875 src=https://github.com/user-attachments/assets/56f5c457-6639-4b48-9472-8cd2ad4936d8 width=3206><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a regression in Global Illumination (GI) shadows that was introduced by a previous optimization. The core issue revolves around the timing and placement of visibility ray tracing in the ReSTIR GI implementation.<p>The problem originated from PR #21649, where the author changed the location where visibility rays were traced. While this change improved Direct Illumination (DI) performance, it inadvertently caused a regression in GI quality. The regression manifested as incorrect shadowing in GI calculations, which is clearly visible in the before/after comparison images.<p>The technical issue was that visibility ray tracing was being applied at the wrong stage in the GI pipeline. In the previous implementation, visibility was being checked after reservoir merging in the <code>spatial_and_shade</code> function. This meant that the combined reservoir’s radiance was being multiplied by the visibility factor after the merge operation, which disrupted the correct GI calculations.<p>The solution implemented here is a targeted revert of the GI-specific visibility ray tracing changes. The key insight is that for GI to work correctly, visibility checks need to be applied earlier in the pipeline - specifically when loading spatial reservoirs rather than after merging them.<p>In the <code>spatial_and_shade</code> function, the code was modified to remove the post-merge visibility check:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>var combined_reservoir = merge_result.merged_reservoir;
</span><span>combined_reservoir.radiance *= trace_point_visibility(surface.world_position, combined_reservoir.sample_point_world_position);
</span><span>
</span><span>// After: 
</span><span>let combined_reservoir = merge_result.merged_reservoir;
</span></code></pre><p>This change alone would break visibility checking entirely, so the visibility check was moved to the <code>load_spatial_reservoir</code> function:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>let spatial_reservoir = gi_reservoirs_b[spatial_pixel_index];
</span><span>
</span><span>// After:
</span><span>var spatial_reservoir = gi_reservoirs_b[spatial_pixel_index];
</span><span>spatial_reservoir.radiance *= trace_point_visibility(world_position, spatial_reservoir.sample_point_world_position);
</span></code></pre><p>The engineering decision here reflects a fundamental understanding of how ReSTIR GI works. By applying visibility checks when loading spatial reservoirs, we ensure that each neighboring reservoir’s contribution is properly validated for visibility before being considered for merging. This maintains the statistical correctness of the reservoir sampling while ensuring that occluded samples don’t contribute to the final illumination.<p>The change also required switching from <code>let</code> to <code>var</code> for the spatial reservoir declaration, since the reservoir’s radiance field now needs to be modified in-place to apply the visibility factor.<p>This fix demonstrates an important principle in graphics programming: optimizations that work well for one lighting component (DI) may have unintended consequences for another (GI). The solution maintains the DI improvements from the original change while restoring correct GI behavior through targeted adjustments to the visibility checking logic.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[spatial_and_shade function] --> B[Remove visibility check after merge]
</span><span>    C[load_spatial_reservoir function] --> D[Add visibility check before merge]
</span><span>    B --> E[Fixed GI calculations]
</span><span>    D --> E
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-solari-src-realtime-restir-gi-wgsl><code>crates/bevy_solari/src/realtime/restir_gi.wgsl</code></h3><p>This file contains the WebGPU Shading Language code for the ReSTIR GI implementation. The changes involve moving visibility ray tracing from after reservoir merging to before spatial reservoir loading.<p><strong>Key changes in <code>spatial_and_shade</code> function:</strong><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>var combined_reservoir = merge_result.merged_reservoir;
</span><span>combined_reservoir.radiance *= trace_point_visibility(surface.world_position, combined_reservoir.sample_point_world_position);
</span><span>
</span><span>// After:
</span><span>let combined_reservoir = merge_result.merged_reservoir;
</span></code></pre><p><strong>Key changes in <code>load_spatial_reservoir</code> function:</strong><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>let spatial_reservoir = gi_reservoirs_b[spatial_pixel_index];
</span><span>
</span><span>// After:
</span><span>var spatial_reservoir = gi_reservoirs_b[spatial_pixel_index];
</span><span>spatial_reservoir.radiance *= trace_point_visibility(world_position, spatial_reservoir.sample_point_world_position);
</span></code></pre><p>These changes ensure that visibility checks are performed at the appropriate stage in the GI pipeline, fixing the shadow regression while maintaining the DI improvements from the previous optimization.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://research.nvidia.com/publication/2021-06_restir-gi-path-resampling-real-time-path-tracing target=_blank>ReSTIR GI Paper</a> - The original paper on Resampled Importance Sampling for Global Illumination<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/rendering/ target=_blank>Bevy Rendering Documentation</a> - Bevy’s rendering system documentation<li><a rel="noopener nofollow noreferrer" href=https://www.w3.org/TR/WGSL/ target=_blank>WebGPU Shading Language Specification</a> - Official WGSL specification for understanding the shader code changes</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-11/pr_21919.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>