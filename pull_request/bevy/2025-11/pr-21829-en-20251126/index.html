<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21829 Trim imports atmosphere shaders
        
    </title><meta content="#21829 Trim imports atmosphere shaders" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-11/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-11-26</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-11/pr-21829-zh-cn-20251126>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>Trim imports atmosphere shaders<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Trim imports atmosphere shaders<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21829<li><strong>Author</strong>: hukasu<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, C-Code-Quality, S-Ready-For-Final-Review, D-Shaders<li><strong>Created</strong>: 2025-11-14T01:18:37Z<li><strong>Merged</strong>: 2025-11-26T22:35:50Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Some shaders on the <code>atmosphere</code> module of <code>bevy_pbr</code> have many unused imports<h2 id=solution>Solution</h2><p>Trim imports of the offending shaders.<h2 id=testing>Testing</h2><p><code>atmosphere</code> example<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a common code quality issue in the Bevy engine’s atmosphere rendering system: unused import statements in WGSL shader files. The problem emerged as the atmosphere shader code evolved over time, accumulating import statements that were no longer needed due to refactoring or changes in implementation approach.<p>The developer identified six shader files in the <code>bevy_pbr/src/atmosphere</code> module that contained unnecessary imports. These imports were likely left behind during previous development cycles when functions or types were moved between modules or when shader implementations were simplified. While unused imports don’t affect runtime performance in compiled shaders, they create maintenance overhead and reduce code clarity.<p>The solution approach was straightforward but systematic: carefully analyze each shader file to identify which imports were actually being used, then remove the unused ones. This required understanding the dependencies between different shader modules and ensuring that no required functionality was accidentally removed. The testing approach was practical - verifying that the atmosphere example still rendered correctly, confirming that the visual output remained unchanged.<p>The implementation touches multiple shader files, each serving a specific role in the atmosphere rendering pipeline:<ul><li><code>aerial_view_lut.wgsl</code> handles aerial perspective calculations<li><code>multiscattering_lut.wgsl</code> computes multiple scattering effects<li><code>transmittance_lut.wgsl</code> calculates light transmission through atmosphere<li><code>sky_view_lut.wgsl</code> generates sky view look-up tables<li><code>render_sky.wgsl</code> performs the final sky rendering<li><code>functions.wgsl</code> contains shared utility functions</ul><p>Each file showed a similar pattern of cleanup - removing imports for types, bindings, and functions that weren’t referenced in the actual shader code. For example, several shaders were importing lighting-related types from <code>mesh_view_types</code> that weren’t used in atmospheric calculations. Other shaders had imports for mathematical functions or Bruneton atmosphere model utilities that had been superseded by different implementations.<p>One notable aspect of these changes is the preservation of code formatting and style. In <code>multiscattering_lut.wgsl</code>, the developer fixed a minor formatting issue by adding a missing comma in an import statement, demonstrating attention to code quality beyond just the functional changes.<p>The technical impact of this PR is primarily on code maintainability. By removing unused imports, the shader code becomes easier to read and understand. New developers working on the atmosphere system can more clearly see which dependencies each shader actually uses. Additionally, future refactoring becomes safer since there are fewer unused imports that could potentially mask missing dependencies.<p>This type of cleanup is particularly valuable in shader code, where debugging can be challenging. With cleaner import statements, it’s easier to trace the flow of data and functions through the rendering pipeline. The changes also reduce the cognitive load for developers reviewing shader code, as they don’t need to mentally filter out irrelevant imports.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Atmosphere Shader System] --> B[aerial_view_lut.wgsl]
</span><span>    A --> C[multiscattering_lut.wgsl]
</span><span>    A --> D[transmittance_lut.wgsl]
</span><span>    A --> E[sky_view_lut.wgsl]
</span><span>    A --> F[render_sky.wgsl]
</span><span>    A --> G[functions.wgsl]
</span><span>    
</span><span>    G --> B
</span><span>    G --> C
</span><span>    G --> D
</span><span>    G --> E
</span><span>    G --> F
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-pbr-src-atmosphere-aerial-view-lut-wgsl-4-9><code>crates/bevy_pbr/src/atmosphere/aerial_view_lut.wgsl</code> (+4/-9)</h3><p>This shader handles aerial view look-up table generation. The changes removed unused imports related to lighting types and various atmosphere functions that weren’t actually used in the implementation.<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>#import bevy_pbr::{
</span><span>    mesh_view_types::{Lights, DirectionalLight},
</span><span>    atmosphere::{
</span><span>        types::{Atmosphere, AtmosphereSettings},
</span><span>        bindings::{atmosphere, settings, view, lights, aerial_view_lut_out},
</span><span>        functions::{
</span><span>            sample_transmittance_lut, sample_density_lut, rayleigh, henyey_greenstein,
</span><span>            sample_multiscattering_lut, AtmosphereSample, sample_local_inscattering,
</span><span>            uv_to_ndc, max_atmosphere_distance, uv_to_ray_direction, 
</span><span>            MIDPOINT_RATIO, get_view_position, MIN_EXTINCTION, ABSORPTION_DENSITY,
</span><span>            SCATTERING_DENSITY,
</span><span>        },
</span><span>    }
</span><span>}
</span><span>
</span><span>// After:
</span><span>#import bevy_pbr::{
</span><span>    atmosphere::{
</span><span>        bindings::settings,
</span><span>        functions::{
</span><span>            sample_density_lut, sample_local_inscattering, uv_to_ray_direction, get_view_position,
</span><span>            MIDPOINT_RATIO, MIN_EXTINCTION, ABSORPTION_DENSITY, SCATTERING_DENSITY,
</span><span>        },
</span><span>    }
</span><span>}
</span></code></pre><h3 id=crates-bevy-pbr-src-atmosphere-multiscattering-lut-wgsl-4-9><code>crates/bevy_pbr/src/atmosphere/multiscattering_lut.wgsl</code> (+4/-9)</h3><p>This shader computes multiple scattering effects. The cleanup removed unused lighting imports and several mathematical functions that weren’t referenced.<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>#import bevy_pbr::{
</span><span>    mesh_view_types::{Lights, DirectionalLight},
</span><span>    atmosphere::{
</span><span>        types::{Atmosphere, AtmosphereSettings},
</span><span>        bindings::{atmosphere, settings},
</span><span>        functions::{
</span><span>            multiscattering_lut_uv_to_r_mu, sample_transmittance_lut,
</span><span>            get_local_r, get_local_up, sample_density_lut, FRAC_4_PI,
</span><span>            max_atmosphere_distance, rayleigh, henyey_greenstein,
</span><span>            zenith_azimuth_to_ray_dir, MIN_EXTINCTION, ABSORPTION_DENSITY,
</span><span>            SCATTERING_DENSITY,
</span><span>        },
</span><span>        bruneton_functions::{
</span><span>            distance_to_top_atmosphere_boundary, distance_to_bottom_atmosphere_boundary, ray_intersects_ground
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span>#import bevy_render::maths::{PI,PI_2}
</span><span>
</span><span>// After:
</span><span>#import bevy_pbr::{
</span><span>    atmosphere::{
</span><span>        bindings::{atmosphere, settings},
</span><span>        functions::{
</span><span>            multiscattering_lut_uv_to_r_mu, sample_transmittance_lut,
</span><span>            get_local_r, get_local_up, sample_density_lut, FRAC_4_PI,
</span><span>            max_atmosphere_distance,
</span><span>            MIN_EXTINCTION, ABSORPTION_DENSITY, SCATTERING_DENSITY,
</span><span>        },
</span><span>        bruneton_functions::ray_intersects_ground
</span><span>    }
</span><span>}
</span><span>
</span><span>#import bevy_render::maths::{PI, PI_2}
</span></code></pre><h3 id=crates-bevy-pbr-src-atmosphere-transmittance-lut-wgsl-6-5><code>crates/bevy_pbr/src/atmosphere/transmittance_lut.wgsl</code> (+6/-5)</h3><p>This shader handles transmittance calculations. The changes streamlined the imports to only include necessary bindings and functions.<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>#import bevy_pbr::atmosphere::{
</span><span>    types::{Atmosphere, AtmosphereSettings},
</span><span>    bindings::{settings, atmosphere},
</span><span>    functions::{AtmosphereSample, sample_density_lut, get_local_r, max_atmosphere_distance, MIDPOINT_RATIO, ABSORPTION_DENSITY, SCATTERING_DENSITY},
</span><span>    bruneton_functions::{transmittance_lut_uv_to_r_mu, distance_to_bottom_atmosphere_boundary, distance_to_top_atmosphere_boundary},
</span><span>}
</span><span>
</span><span>// After:
</span><span>#import bevy_pbr::atmosphere::{
</span><span>    bindings::settings,
</span><span>    functions::{
</span><span>        sample_density_lut, get_local_r, max_atmosphere_distance,
</span><span>        MIDPOINT_RATIO, ABSORPTION_DENSITY, SCATTERING_DENSITY
</span><span>    },
</span><span>    bruneton_functions::transmittance_lut_uv_to_r_mu,
</span><span>}
</span></code></pre><h3 id=crates-bevy-pbr-src-atmosphere-functions-wgsl-3-4><code>crates/bevy_pbr/src/atmosphere/functions.wgsl</code> (+3/-4)</h3><p>This file contains shared utility functions. The cleanup removed two unused Bruneton function imports.<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>#import bevy_pbr::{
</span><span>    atmosphere::{
</span><span>        types::Atmosphere,
</span><span>        bindings::{
</span><span>            atmosphere, settings, view, lights, transmittance_lut, atmosphere_lut_sampler,
</span><span>            multiscattering_lut, sky_view_lut, aerial_view_lut, atmosphere_transforms, 
</span><span>            medium_density_lut, medium_scattering_lut, medium_sampler,
</span><span>        },
</span><span>        bruneton_functions::{
</span><span>            transmittance_lut_r_mu_to_uv, transmittance_lut_uv_to_r_mu, 
</span><span>            ray_intersects_ground, distance_to_top_atmosphere_boundary, 
</span><span>            distance_to_bottom_atmosphere_boundary
</span><span>        },
</span><span>    }
</span><span>}
</span><span>
</span><span>// After:
</span><span>#import bevy_pbr::{
</span><span>    atmosphere::{
</span><span>        types::Atmosphere,
</span><span>        bindings::{
</span><span>            atmosphere, settings, view, lights, transmittance_lut, atmosphere_lut_sampler,
</span><span>            multiscattering_lut, sky_view_lut, aerial_view_lut, atmosphere_transforms,
</span><span>            medium_density_lut, medium_scattering_lut, medium_sampler,
</span><span>        },
</span><span>        bruneton_functions::{
</span><span>            transmittance_lut_r_mu_to_uv, ray_intersects_ground,
</span><span>            distance_to_top_atmosphere_boundary, distance_to_bottom_atmosphere_boundary
</span><span>        },
</span><span>    }
</span><span>}
</span></code></pre><h3 id=crates-bevy-pbr-src-atmosphere-render-sky-wgsl-1-3><code>crates/bevy_pbr/src/atmosphere/render_sky.wgsl</code> (+1/-3)</h3><p>This is the main sky rendering shader. The changes removed unused atmosphere type imports and view-related imports.<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>#import bevy_pbr::atmosphere::{
</span><span>    types::{Atmosphere, AtmosphereSettings},
</span><span>    bindings::{atmosphere, view, atmosphere_transforms, settings},
</span><span>    functions::{
</span><span>        sample_transmittance_lut, sample_transmittance_lut_segment,
</span><span>        sample_sky_view_lut, direction_world_to_atmosphere,
</span><span>        direction_atmosphere_to_world, sample_aerial_view_lut,
</span><span>        get_view_position, max_atmosphere_distance
</span><span>    },
</span><span>};
</span><span>#import bevy_render::view::View;
</span><span>
</span><span>// After:
</span><span>#import bevy_pbr::atmosphere::{
</span><span>    bindings::{view, settings},
</span><span>    functions::{
</span><span>        sample_transmittance_lut, sample_transmittance_lut_segment,
</span><span>        sample_sky_view_lut, direction_world_to_atmosphere,
</span><span>        direction_atmosphere_to_world, sample_aerial_view_lut,
</span><span>        get_view_position, max_atmosphere_distance
</span><span>    },
</span><span>};
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://www.w3.org/TR/WGSL/ target=_blank>WGSL Shader Language Specification</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/rendering/ target=_blank>Bevy Engine Rendering Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://developer.nvidia.com/gpugems/gpugems2/part-ii-shading-lighting-and-shadows/chapter-16-accurate-atmospheric-scattering target=_blank>Atmospheric Scattering Models</a><li><a rel="noopener nofollow noreferrer" href=https://rust-unofficial.github.io/patterns/ target=_blank>Code Quality Best Practices</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-11/pr_21829.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>