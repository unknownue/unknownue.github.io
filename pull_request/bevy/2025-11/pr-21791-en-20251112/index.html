<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21791 Fix binding in generated environment map downsampling pipeline
        
    </title><meta content="#21791 Fix binding in generated environment map downsampling pipeline" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-11/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-11-12</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-11/pr-21791-zh-cn-20251112>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix binding in generated environment map downsampling pipeline<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21791<li><strong>Author</strong>: ashivaram23<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, O-WebGPU, S-Needs-Review<li><strong>Created</strong>: 2025-11-09T13:54:13Z<li><strong>Merged</strong>: 2025-11-09T20:05:45Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>When Bevy splits mip generation for environment maps into two passes due to limits, the second pass binds a view to the the original texture when it’s supposed to be the 6th mip level of an intermediate one. This causes an error on WebGPU in browsers if that original texture doesn’t already have mipmaps.<p>This affects the atmosphere example on WebGPU, but there are other issues there too so it still won’t work after this.<h2 id=solution>Solution</h2><p>Create texture view from the texture in the <code>IntermediateTextures</code> component instead of in <code>RenderEnvironmentMap</code><h2 id=testing>Testing</h2><details><summary>Example that doesn't work on WebGPU before this (replace square.png with any power of 2 square image that doesn't store mipmaps)</summary> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>use </span><span>bevy</span><span style=color:#ed9366>::</span><span>prelude</span><span style=color:#ed9366>::*</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>main</span><span>() {
</span><span>    App</span><span style=color:#ed9366>::</span><span>new()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>add_plugins</span><span>(DefaultPlugins)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(Startup</span><span style=color:#61676ccc>,</span><span> setup)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>run</span><span>()</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>setup</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands,
</span><span>    </span><span style=color:#ff8f40>asset_server</span><span style=color:#61676ccc>: </span><span>Res&LTAssetServer>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>meshes</span><span style=color:#61676ccc>: </span><span>ResMut&LTAssets&LTMesh>>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>materials</span><span style=color:#61676ccc>: </span><span>ResMut&LTAssets&LTStandardMaterial>>,
</span><span>) {
</span><span>    commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((
</span><span>        Camera3d</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>,
</span><span>        Transform</span><span style=color:#ed9366>::</span><span>from_xyz(</span><span style=color:#ff8f40>0.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>5.0</span><span>)</span><span style=color:#61676ccc>,
</span><span>        GeneratedEnvironmentMapLight {
</span><span>            environment_map</span><span style=color:#61676ccc>:</span><span> asset_server</span><span style=color:#ed9366>.</span><span style=color:#f07171>load</span><span>(</span><span style=color:#86b300>"square.png"</span><span>)</span><span style=color:#61676ccc>,
</span><span>            intensity</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>1000.0</span><span style=color:#61676ccc>,
</span><span>            </span><span style=color:#ed9366>..</span><span style=color:#55b4d4;font-style:italic>Default</span><span style=color:#ed9366>::</span><span>default()
</span><span>        }</span><span style=color:#61676ccc>,
</span><span>    ))</span><span style=color:#61676ccc>;
</span><span>
</span><span>    commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((
</span><span>        Mesh3d(meshes</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(Sphere</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ff8f40>1.0</span><span>)</span><span style=color:#ed9366>.</span><span style=color:#f07171>mesh</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>build</span><span>()))</span><span style=color:#61676ccc>,
</span><span>        MeshMaterial3d(materials</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(StandardMaterial {
</span><span>            perceptual_roughness</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>0.1</span><span style=color:#61676ccc>,
</span><span>            metallic</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>1.0</span><span style=color:#61676ccc>,
</span><span>            </span><span style=color:#ed9366>..</span><span style=color:#55b4d4;font-style:italic>Default</span><span style=color:#ed9366>::</span><span>default()
</span><span>        }))</span><span style=color:#61676ccc>,
</span><span>    ))</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre></details><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a specific bug in Bevy’s environment map downsampling pipeline that manifested primarily on WebGPU platforms. The issue occurred when the mipmap generation process for environment maps needed to be split into two passes due to hardware limitations.<p>The core problem was in the texture binding logic for the second pass of the split mip generation. When generating mipmaps, Bevy creates a pyramid of progressively smaller versions of the original texture. In cases where the hardware can’t generate all mip levels in a single pass, the process splits into two passes. The first pass generates mips 0-6, and the second pass continues from mip 6 onward.<p>The bug was in how the second pass accessed its input texture. Instead of reading from the intermediate texture that contained the partially generated mip chain (specifically mip level 6), it was incorrectly trying to read from the original source texture. This caused WebGPU validation errors because the original texture often doesn’t have pre-generated mipmaps, making mip level 6 inaccessible.<p>The fix was straightforward but critical: change the texture view creation to use the intermediate texture from the <code>IntermediateTextures</code> component rather than the original <code>RenderEnvironmentMap</code> texture. This ensures that when the second pass executes, it reads from the correct mip level that was generated by the first pass.<p>The implementation change is minimal but impactful. In the <code>prepare_generated_environment_map_bind_groups</code> function, the code now creates the texture view from <code>textures.environment_map.texture</code> instead of <code>env_map_texture</code>. This subtle difference ensures proper pipeline continuity between the two passes.<p>This bug is particularly relevant for WebGPU because WebGPU has stricter validation rules compared to native graphics APIs. While the incorrect binding might have worked on some native implementations due to more lenient validation, WebGPU correctly flags this as an error, making the bug more apparent in web environments.<p>The provided test case demonstrates the issue clearly - using a simple power-of-2 texture without pre-generated mipmaps would trigger the WebGPU validation error before this fix. While the atmosphere example still has other issues on WebGPU, this specific binding error is now resolved.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[Original Texture] --> B[First Pass: Mips 0-6]
</span><span>    B --> C[Intermediate Texture]
</span><span>    C --> D[Second Pass: Mips 6+]
</span><span>    D --> E[Final Environment Map]
</span><span>    
</span><span>    F[BUG: Second pass reading from A] --> G[FIX: Second pass reading from C]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-pbr-src-light-probe-generate-rs-10-6><code>crates/bevy_pbr/src/light_probe/generate.rs</code> (+10/-6)</h3><p>This file contains the core logic for generating environment maps and their mip chains. The change fixes the texture binding in the split mip generation path.<p><strong>Key modification:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> input_env_map_second </span><span style=color:#ed9366>=</span><span> env_map_texture</span><span style=color:#ed9366>.</span><span style=color:#f07171>create_view</span><span>(</span><span style=color:#ed9366>&</span><span>TextureViewDescriptor {
</span><span>    dimension</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(TextureViewDimension</span><span style=color:#ed9366>::</span><span>D2Array)</span><span style=color:#61676ccc>,
</span><span>    base_mip_level</span><span style=color:#61676ccc>: </span><span style=color:#f07171>min</span><span>(</span><span style=color:#ff8f40>6</span><span style=color:#61676ccc>,</span><span> last_mip)</span><span style=color:#61676ccc>,
</span><span>    mip_level_count</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#ff8f40>1</span><span>)</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#ed9366>..</span><span style=color:#55b4d4;font-style:italic>Default</span><span style=color:#ed9366>::</span><span>default()
</span><span>})</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> input_env_map_second </span><span style=color:#ed9366>=
</span><span>    textures
</span><span>        </span><span style=color:#ed9366>.</span><span>environment_map
</span><span>        </span><span style=color:#ed9366>.</span><span>texture
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>create_view</span><span>(</span><span style=color:#ed9366>&</span><span>TextureViewDescriptor {
</span><span>            dimension</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(TextureViewDimension</span><span style=color:#ed9366>::</span><span>D2Array)</span><span style=color:#61676ccc>,
</span><span>            base_mip_level</span><span style=color:#61676ccc>: </span><span style=color:#f07171>min</span><span>(</span><span style=color:#ff8f40>6</span><span style=color:#61676ccc>,</span><span> last_mip)</span><span style=color:#61676ccc>,
</span><span>            mip_level_count</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#ff8f40>1</span><span>)</span><span style=color:#61676ccc>,
</span><span>            </span><span style=color:#ed9366>..</span><span style=color:#55b4d4;font-style:italic>Default</span><span style=color:#ed9366>::</span><span>default()
</span><span>        })</span><span style=color:#61676ccc>;
</span></code></pre><p>The change ensures that when creating the texture view for the second pass of split mip generation, we use the intermediate texture (<code>textures.environment_map.texture</code>) that contains the partially generated mip chain, rather than the original source texture (<code>env_map_texture</code>). This maintains the correct data flow through the multi-pass mip generation pipeline.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://www.w3.org/TR/webgpu/ target=_blank>WebGPU Specification</a> - Understanding WebGPU’s validation rules<li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Mipmap target=_blank>Mipmapping Theory</a> - Background on mipmap generation<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/3d/ target=_blank>Bevy Rendering Documentation</a> - Bevy’s 3D rendering pipeline<li><a rel="noopener nofollow noreferrer" href=https://gpuweb.github.io/gpuweb/#texture-view-creation target=_blank>Texture Views in Graphics APIs</a> - How texture views work in modern graphics APIs</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-11/pr_21791.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>