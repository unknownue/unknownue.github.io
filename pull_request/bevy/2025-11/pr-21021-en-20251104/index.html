<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21021 make material draw functions instance independent
        
    </title><meta content="#21021 make material draw functions instance independent" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-11/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-11-04</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-11/pr-21021-zh-cn-20251104>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: make material draw functions instance independent<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21021<li><strong>Author</strong>: ecoskey<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, C-Code-Quality, S-Ready-For-Final-Review, M-Migration-Guide<li><strong>Created</strong>: 2025-09-13T21:26:53Z<li><strong>Merged</strong>: 2025-11-04T21:09:58Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>#19667 introduced a type-erased material system that effectively puts all material instances through a single cache: during asset preparation (<code>ErasedRenderAssetPlugin</code>), materials are processed into a set of <code>MaterialProperties</code> that contains all the data needed to render them, and these are all cached and deduplicated as needed.<p>This allows for maximal flexibility (every single material instance could have a different “type”) but complicates the logic and makes cache keys really big. So, one goal for the material revamp I have (and I think @tychedelia is on board) is to cache materials at two levels: material “types” and material “instances”, where material types roughly map to the rust types that currently implement <code>Material</code>. Without getting into implementation details, storing mostly static data separate from instance data would let us simplify a lot of the logic, while only requiring a little more work for fully-dynamic use cases.<p>This PR is a first step in that direction, which stores <em>all</em> the available draw functions in <code>MaterialProperties</code>, and pushes the decision for “what draw function should I use for this material?” to queue time, where before it was split between there and asset preparation. This makes the list of available draw functions instance-independent, and will later allow us to store it with other “static” material data.<h2 id=solution>Solution</h2><ul><li>Make draw function labels 1:1 with render phases, and include all of them in the list in <code>MaterialProperties</code></ul><h2 id=testing>Testing</h2><ul><li>Ran <code>3d_scene</code><li>Ran <code>manual_material</code></ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The Bevy rendering system was facing a challenge with its material caching architecture. PR #19667 had introduced a type-erased material system that processed all material instances through a single unified cache during asset preparation. While this provided maximum flexibility by allowing each material instance to potentially have a different “type,” it came with significant complexity costs. The cache keys were becoming large, and the logic for managing material instances was growing increasingly complex.<p>The long-term vision for the material system involves implementing a two-level caching strategy that separates material “types” from material “instances.” Material types would roughly correspond to the Rust types implementing the <code>Material</code> trait, containing mostly static data, while instances would hold the per-instance variations. This architectural shift would simplify the system while maintaining support for fully dynamic use cases.<p>This PR represents the first concrete step toward that vision by addressing how draw functions are managed. Previously, the system made decisions about which draw function to use for a material at both asset preparation time and queue time. This mixed approach meant that draw function selection was partially tied to material instances, complicating the separation of static and instance data.<p>The solution involved refactoring the draw function system to make it instance-independent. Instead of having generic draw function labels that could vary per instance, the system now uses specific draw function labels that correspond directly to render phases. All available draw functions are now stored in <code>MaterialProperties</code>, and the decision about which one to use is deferred until queue time when the specific render phase is known.<p>The implementation required changes across multiple components of the rendering system. In the material preparation phase, instead of conditionally adding draw functions based on the material’s render phase type, the system now collects all possible draw functions upfront. This includes draw functions for main pass rendering (opaque, alpha mask, transmissive, transparent), prepass rendering (opaque, alpha mask), deferred rendering (opaque, alpha mask), and shadow rendering.<p>During queue time, the rendering systems now look up the specific draw function needed for each render phase directly from the material properties. This eliminates the need for complex conditional logic that was previously spread across both preparation and queueing phases.<p>The key technical insight here is that by making draw functions instance-independent and storing them all upfront, the system becomes more predictable and easier to reason about. This approach also paves the way for future optimizations where static material data (including draw functions) can be cached separately from instance-specific data.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Material Preparation] --> B[MaterialProperties]
</span><span>    B --> C[Draw Functions Collection]
</span><span>    C --> D[MainPassOpaqueDrawFunction]
</span><span>    C --> E[MainPassAlphaMaskDrawFunction]
</span><span>    C --> F[MainPassTransmissiveDrawFunction]
</span><span>    C --> G[MainPassTransparentDrawFunction]
</span><span>    C --> H[PrepassOpaqueDrawFunction]
</span><span>    C --> I[PrepassAlphaMaskDrawFunction]
</span><span>    C --> J[DeferredOpaqueDrawFunction]
</span><span>    C --> K[DeferredAlphaMaskDrawFunction]
</span><span>    C --> L[ShadowsDrawFunction]
</span><span>    
</span><span>    M[Queue Time] --> N[Render Phase Selection]
</span><span>    N --> O[Draw Function Lookup]
</span><span>    O --> P[Specific Draw Function Execution]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-pbr-src-material-rs-66-45><code>crates/bevy_pbr/src/material.rs</code> (+66/-45)</h3><p>This file contains the core material system implementation. The changes refactored how draw functions are defined and managed:<p><strong>Key changes:</strong><ul><li>Replaced generic draw function labels with specific per-render-phase labels<li>Modified material preparation to collect all draw functions upfront<li>Updated queueing logic to look up specific draw functions per render phase</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: Single generic draw function
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(DrawFunctionLabel</span><span style=color:#61676ccc>,</span><span> Debug</span><span style=color:#61676ccc>,</span><span> Hash</span><span style=color:#61676ccc>,</span><span> PartialEq</span><span style=color:#61676ccc>,</span><span> Eq</span><span style=color:#61676ccc>,</span><span> Clone</span><span style=color:#61676ccc>,</span><span> Default)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>MaterialDrawFunction</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After: Specific draw functions per render phase
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(DrawFunctionLabel</span><span style=color:#61676ccc>,</span><span> Debug</span><span style=color:#61676ccc>,</span><span> Hash</span><span style=color:#61676ccc>,</span><span> PartialEq</span><span style=color:#61676ccc>,</span><span> Eq</span><span style=color:#61676ccc>,</span><span> Clone</span><span style=color:#61676ccc>,</span><span> Default)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>MainPassOpaqueDrawFunction</span><span style=color:#61676ccc>;
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(DrawFunctionLabel</span><span style=color:#61676ccc>,</span><span> Debug</span><span style=color:#61676ccc>,</span><span> Hash</span><span style=color:#61676ccc>,</span><span> PartialEq</span><span style=color:#61676ccc>,</span><span> Eq</span><span style=color:#61676ccc>,</span><span> Clone</span><span style=color:#61676ccc>,</span><span> Default)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>MainPassAlphaMaskDrawFunction</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// ... and several others
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Queue time lookup changes:
</span><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(draw_function) </span><span style=color:#ed9366>=</span><span> material</span><span style=color:#ed9366>.</span><span>properties</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_draw_function</span><span>(MaterialDrawFunction)
</span><span style=color:#fa6e32>else </span><span>{
</span><span>    </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>}</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(draw_function) </span><span style=color:#ed9366>=</span><span> material
</span><span>    </span><span style=color:#ed9366>.</span><span>properties
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>get_draw_function</span><span>(MainPassOpaqueDrawFunction)
</span><span style=color:#fa6e32>else </span><span>{
</span><span>    </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>}</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-pbr-src-prepass-mod-rs-35-22><code>crates/bevy_pbr/src/prepass/mod.rs</code> (+35/-22)</h3><p>This file handles prepass rendering. The changes updated the prepass queueing system to use the new per-render-phase draw function labels:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>draw_function</span><span style=color:#61676ccc>:</span><span> material
</span><span>    </span><span style=color:#ed9366>.</span><span>properties
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>get_draw_function</span><span>(PrepassDrawFunction)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(draw_function) </span><span style=color:#ed9366>=</span><span> material
</span><span>    </span><span style=color:#ed9366>.</span><span>properties
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>get_draw_function</span><span>(PrepassOpaqueDrawFunction)
</span><span style=color:#fa6e32>else </span><span>{
</span><span>    </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>}</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=examples-shader-advanced-manual-material-rs-3-3><code>examples/shader_advanced/manual_material.rs</code> (+3/-3)</h3><p>Updated the manual material example to use the new draw function labeling system:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>properties</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_draw_function</span><span>(MaterialDrawFunction</span><span style=color:#61676ccc>,</span><span> draw_function_id)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>properties</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_draw_function</span><span>(MainPassOpaqueDrawFunction</span><span style=color:#61676ccc>,</span><span> draw_function_id)</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=release-content-migration-guides-draw-functions-md-24-0><code>release-content/migration-guides/draw_functions.md</code> (+24/-0)</h3><p>Added a comprehensive migration guide explaining the changes for users of the low-level manual material API:<pre class=language-markdown data-lang=markdown style=color:#61676c;background-color:#fafafa><code class=language-markdown data-lang=markdown><span style=color:#4cbf99>- </span><span>Removed </span><span style=color:#ed9366;background-color:#61676c10>`MaterialDrawFunction`</span><span> in favor of:
</span><span>  </span><span style=color:#4cbf99>- </span><span style=color:#ed9366;background-color:#61676c10>`MainPassOpaqueDrawFunction`</span><span>
</span><span>  </span><span style=color:#4cbf99>- </span><span style=color:#ed9366;background-color:#61676c10>`MainPassAlphaMaskDrawFunction`</span><span>
</span><span>  </span><span style=color:#4cbf99>- </span><span style=color:#ed9366;background-color:#61676c10>`MainPassTransmissiveDrawFunction`</span><span>
</span><span>  </span><span style=color:#4cbf99>- </span><span style=color:#ed9366;background-color:#61676c10>`MainPassTransparentDrawFunction`</span><span>
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/next-steps/materials/ target=_blank>Bevy Material System Documentation</a> - Official documentation on Bevy’s material system<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/next-steps/rendering/#render-phases target=_blank>Render Phases in Bevy</a> - Explanation of how render phases work in the Bevy engine<li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/book/ch17-02-trait-objects.html target=_blank>Type Erasure Patterns in Rust</a> - Background on type erasure techniques used in the material system</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-11/pr_21021.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>