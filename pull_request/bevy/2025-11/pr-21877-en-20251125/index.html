<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21877 ssr fix and add some documents
        
    </title><meta content="#21877 ssr fix and add some documents" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-11/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-11-25</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-11/pr-21877-zh-cn-20251125>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>SSR Fix and Documentation Enhancement<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: ssr fix and add some documents<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21877<li><strong>Author</strong>: newDINO<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, S-Ready-For-Final-Review, D-Straightforward<li><strong>Created</strong>: 2025-11-18T06:21:14Z<li><strong>Merged</strong>: 2025-11-25T02:24:08Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Screen space reflection didn’t work for my program, so I tried cloning bevy repo and running the ssr example to see whether it works or not, and it didn’t. I figured out that the problem is that <code>prepare_ssr_pipelines</code> system only runs for views with <code>ExtractedAtmosphere</code>. So I removed this filter because it already uses <code>Has&LTExtractedAtmosphere></code>. And the example works afterwards.<p>I later found that the <code>With&LTExtractedAtmosphere></code> filter is not added to bevy 0.17, so the problem in my own program is not the same as the ssr example. I compared the ssr example and my program and found that I didn’t add <code>DefaultOpaqueRendererMethod::deferred()</code> resource. So I added a few docs to state that deferred rendering is not automatically enabled when ssr is added.<h2 id=solution>Solution</h2><ol><li>remove <code>With&LTExtractedAtmosphere></code> filter in <code>prepare_ssr_pipelines</code>.<li>add more documentation.</ol><h2 id=testing>Testing</h2><p>I tested the ssr example and atmosphere example and both look fine.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses two distinct but related issues with Bevy’s Screen Space Reflections (SSR) implementation. The developer encountered SSR not working in their program and began a systematic debugging process that revealed both a bug in the current codebase and a documentation gap that could confuse other users.<p>The investigation started when the developer noticed that SSR wasn’t functioning in their application. To isolate the problem, they cloned the Bevy repository and ran the official SSR example, expecting it to work correctly. Surprisingly, the example also failed, indicating a deeper issue in the SSR implementation itself.<p>Through code analysis, the developer identified the root cause: the <code>prepare_ssr_pipelines</code> system was using an overly restrictive filter. The system query included <code>With&LTExtractedAtmosphere></code>, which meant it would only process views that had an atmosphere component. This was problematic because SSR should work independently of atmospheric effects. The system already used <code>Has&LTExtractedAtmosphere></code> internally, making the additional filter redundant and incorrect.<p>After fixing this issue, the developer discovered that their original program still had problems. By comparing their code with the working SSR example, they identified a second issue: deferred rendering wasn’t automatically enabled when SSR was added. This revealed a documentation gap - while the existing documentation mentioned that SSR requires deferred rendering, it didn’t explicitly state that users need to manually enable it.<p>The solution implemented two key changes. First, the unnecessary <code>With&LTExtractedAtmosphere></code> filter was removed from the system query, allowing SSR to work correctly regardless of atmospheric effects. Second, the documentation was updated to clearly state that deferred rendering must be explicitly enabled, preventing other developers from encountering the same confusion.<p>The technical insight here is about system query design in Bevy’s ECS. When designing systems, it’s important to ensure that filters accurately reflect the actual requirements of the system logic. Overly restrictive filters can prevent systems from running when they should, leading to subtle bugs. In this case, the system internally handled the presence or absence of atmosphere data, so the filter was both unnecessary and incorrect.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[prepare_ssr_pipelines System] --> B[Query Filter Logic]
</span><span>    B --> C[Before: With&LTExtractedAtmosphere>]
</span><span>    B --> D[After: No Atmosphere Filter]
</span><span>    E[SSR Requirements] --> F[DepthPrepass]
</span><span>    E --> G[DeferredPrepass]
</span><span>    E --> H[Manual Deferred Enable]
</span><span>    D --> F
</span><span>    D --> G
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>File: <code>crates/bevy_pbr/src/ssr/mod.rs</code></strong><ol><li><strong>Documentation Enhancement</strong>: Added clarification that deferred rendering must be manually enabled</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#abb0b6;font-style:italic>/// Screen-space reflections currently require deferred rendering in order to
</span><span style=color:#abb0b6;font-style:italic>/// appear. Therefore, they also need the [`DepthPrepass`] and [`DeferredPrepass`]
</span><span style=color:#abb0b6;font-style:italic>/// components, which are inserted automatically.
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#abb0b6;font-style:italic>/// Screen-space reflections currently require deferred rendering in order to
</span><span style=color:#abb0b6;font-style:italic>/// appear. Therefore, they also need the [`DepthPrepass`] and [`DeferredPrepass`]
</span><span style=color:#abb0b6;font-style:italic>/// components, which are inserted automatically,
</span><span style=color:#abb0b6;font-style:italic>/// but deferred rendering itself is not automatically enabled.
</span></code></pre><ol start=2><li><strong>System Query Fix</strong>: Removed unnecessary atmosphere filter</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>    </span><span style=color:#fa6e32>mut</span><span> views</span><span style=color:#61676ccc>: </span><span>Query<
</span><span>        (
</span><span>            </span><span style=color:#ed9366>&</span><span>ViewTarget,
</span><span>            </span><span style=color:#ed9366>&</span><span>ScreenSpaceReflectionsSettings,
</span><span>            </span><span style=color:#ed9366>&</span><span>ScreenSpaceReflectionsUniform,
</span><span>        ),
</span><span>        (
</span><span>            With&LTScreenSpaceReflectionsUniform>,
</span><span>            With&LTDepthPrepass>,
</span><span>            With&LTDeferredPrepass>,
</span><span>            With&LTExtractedAtmosphere>,
</span><span>        ),
</span><span>    ></span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>    </span><span style=color:#fa6e32>mut</span><span> views</span><span style=color:#61676ccc>: </span><span>Query<
</span><span>        (
</span><span>            </span><span style=color:#ed9366>&</span><span>ViewTarget,
</span><span>            </span><span style=color:#ed9366>&</span><span>ScreenSpaceReflectionsSettings,
</span><span>            </span><span style=color:#ed9366>&</span><span>ScreenSpaceReflectionsUniform,
</span><span>        ),
</span><span>        (
</span><span>            With&LTScreenSpaceReflectionsUniform>,
</span><span>            With&LTDepthPrepass>,
</span><span>            With&LTDeferredPrepass>,
</span><span>        ),
</span><span>    ></span><span style=color:#61676ccc>,
</span></code></pre><p>The changes are minimal but impactful. The documentation update addresses user confusion by explicitly stating that deferred rendering must be manually configured. The system query fix removes an incorrect filter that was preventing SSR from working in scenes without atmospheric effects.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/ecs/#queries target=_blank>Bevy ECS System Queries Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Screen_space_reflection target=_blank>Screen Space Reflections in Computer Graphics</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/deferred-rendering/ target=_blank>Bevy Deferred Rendering Guide</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-11/pr_21877.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>