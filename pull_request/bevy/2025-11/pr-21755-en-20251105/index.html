<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21755 Update `rotate_cubes` system to use `par_iter_mut()` to reduce its impact on performance
        
    </title><meta content="#21755 Update `rotate_cubes` system to use `par_iter_mut()` to reduce its impact on performance" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-11/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-11-05</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-11/pr-21755-zh-cn-20251105>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>Update <code>rotate_cubes</code> system to use <code>par_iter_mut()</code> to reduce its impact on performance<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Update <code>rotate_cubes</code> system to use <code>par_iter_mut()</code> to reduce its impact on performance<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21755<li><strong>Author</strong>: DeVelox<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Examples, C-Performance, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-11-05T19:01:04Z<li><strong>Merged</strong>: 2025-11-05T21:48:02Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>Quick follow-up to #21745.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This pull request addresses a straightforward but impactful performance optimization in one of Bevy’s stress test examples. The <code>many_cubes</code> example is designed to test the engine’s capabilities under heavy load by rendering thousands of entities. Within this example, the <code>rotate_cubes</code> system was identified as a candidate for parallelization.<p>The original implementation used a sequential iteration approach with <code>iter_mut()</code>, which processed each cube’s transform update one at a time on a single thread. Given that this example can involve thousands of cubes, this created unnecessary performance bottlenecks, especially on multi-core systems.<p>The solution leverages Bevy’s built-in parallel iteration capabilities through <code>par_iter_mut()</code>. This change allows the system to distribute the workload of updating cube transforms across multiple CPU cores. The transformation logic itself remains unchanged - each cube still rotates around the Y-axis at the same rate - but the execution strategy now takes advantage of modern CPU architectures.<p>The implementation is minimal and focused. Only two lines of code were modified, replacing the sequential for-loop with a parallel iterator. The key insight here is recognizing that cube rotations are independent operations - updating one cube’s transform doesn’t affect others, making this an ideal candidate for parallel processing.<p>From a technical perspective, this change demonstrates several important concepts:<ol><li><strong>Embarrassing Parallelism</strong>: Each cube rotation is completely independent, requiring no synchronization between iterations<li><strong>Zero-Cost Abstractions</strong>: The parallel iterator provides significant performance benefits without changing the core logic<li><strong>Progressive Optimization</strong>: This follows up on previous work (#21745), showing continuous improvement in the codebase</ol><p>The impact is particularly noticeable in stress testing scenarios where the number of entities is high. While the exact performance improvement depends on hardware configuration (particularly core count), this change reduces the system’s impact on frame times and better utilizes available CPU resources.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[rotate_cubes System] --> B[Sequential Processing]
</span><span>    A --> C[Parallel Processing]
</span><span>    B --> D[Single Thread]
</span><span>    C --> E[Multiple Threads]
</span><span>    C --> F[Work Stealing]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=examples-stress-tests-many-cubes-rs-2-2><code>examples/stress_tests/many_cubes.rs</code> (+2/-2)</h3><p>This file contains the stress test example that renders many cubes. The changes optimize the cube rotation system by parallelizing the transform updates.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// File: examples/stress_tests/many_cubes.rs
</span><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>for mut</span><span> transform </span><span style=color:#ed9366>in</span><span> query</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter_mut</span><span>() {
</span><span>    transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>rotate_y</span><span>(</span><span style=color:#ff8f40>10.0 </span><span style=color:#ed9366>*</span><span> time</span><span style=color:#ed9366>.</span><span style=color:#f07171>delta_secs</span><span>())</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>query</span><span style=color:#ed9366>.</span><span style=color:#f07171>par_iter_mut</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>for_each</span><span>(|</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>transform</span><span>| {
</span><span>    transform</span><span style=color:#ed9366>.</span><span style=color:#f07171>rotate_y</span><span>(</span><span style=color:#ff8f40>10.0 </span><span style=color:#ed9366>*</span><span> time</span><span style=color:#ed9366>.</span><span style=color:#f07171>delta_secs</span><span>())</span><span style=color:#61676ccc>;
</span><span>})</span><span style=color:#61676ccc>;
</span></code></pre><p>The key change replaces the sequential <code>iter_mut()</code> with parallel <code>par_iter_mut()</code>, distributing the workload of updating cube rotations across multiple threads. The transformation logic (<code>rotate_y</code>) remains identical, ensuring the visual behavior of the example is unchanged while improving performance.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/ecs/system/struct.Query.html target=_blank>Bevy ECS Queries Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/programming/parallel-query.html target=_blank>Parallel Iteration in Bevy</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/rayon/latest/rayon/iter/trait.ParallelIterator.html target=_blank>Rayon Parallel Iterators</a> (the underlying parallelization library used by Bevy)<li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Embarrassingly_parallel target=_blank>Embarrassingly Parallel Problems</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-11/pr_21755.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>