<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21763 Share `AssetSources` between the `AssetServer`, the asset processor, and the asset processor's internal asset server.
        
    </title><meta content="#21763 Share `AssetSources` between the `AssetServer`, the asset processor, and the asset processor's internal asset server." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-11/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-11-20</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-11/pr-21763-zh-cn-20251120>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Share <code>AssetSources</code> between the <code>AssetServer</code>, the asset processor, and the asset processor’s internal asset server.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21763<li><strong>Author</strong>: andriyDev<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Assets, C-Code-Quality, S-Ready-For-Final-Review, M-Migration-Guide, D-Modest<li><strong>Created</strong>: 2025-11-06T07:30:54Z<li><strong>Merged</strong>: 2025-11-20T01:00:48Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Previously, we would build the sources up to 3 times with different options: once for the regular asset server, once for the asset processor, and once for the asset processor’s internal asset server.<li>This is a step towards #21758 (since now adding a source to this shared <code>AssetSources</code> will be reflected in all the uses.</ul><h2 id=solution>Solution</h2><ol><li>Skip all the hot-reloading polling if <code>watch_for_changes</code> is false. If we don’t do this, sharing the sources between the asset server and the processor-internal asset server will result in two tasks consuming asset events, so the regular asset server will miss asset events.<li>Move the state of the asset processor into a separate struct that we then Arc. We need to be able to gate the processed asset reader, but we can’t create an asset processor without the sources. So instead we allow ourselves to create the state first, so that we can gate on that state, and then create the processor with that state.<li>Split the processed reader into a gated and an ungated form. The gate first blocks on the processor being done initialized, followed by gating on the per-asset lock. However the asset processor needs to iterate through all the directories in order to finish initializing. So just unconditionally gating doesn’t work - we hit a deadlock. So we provide access to the ungated processed reader, so that the processor can use that to initialize its state.<li>Finally do the sharing!</ol><p>One thing I’m starting in this PR is making things more private. For example, it’s not clear why <code>ProcessorGatedReader</code> was <code>pub</code>. I’ve also made <code>AssetSources::gate_on_processor</code> no longer <code>pub</code>. This does mean that users can no longer initialize their own <code>AssetServer</code> properly (e.g., gated on the processor), but I don’t think we should really support this - our focus should be on the <code>AssetServer</code> initialized by <code>AssetPlugin</code>, not hypothetical uses where someone wants to insert their own <code>AssetServer</code>.<h2 id=testing>Testing</h2><ul><li>CI</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a fundamental inefficiency in Bevy’s asset system where <code>AssetSources</code> were being constructed multiple times with different configurations. The core problem was that the system built separate instances for the regular asset server, the asset processor, and the processor’s internal asset server, leading to code duplication and potential synchronization issues.<p>The implementation approach involved several interconnected changes to enable sharing a single <code>AssetSources</code> instance across all components. First, the PR introduces logic to skip hot-reloading polling when <code>watch_for_changes</code> is false, preventing duplicate event consumption that would cause the regular asset server to miss asset events when sources are shared.<p>To enable proper gating of processed asset readers, the asset processor’s state was extracted into a separate <code>ProcessingState</code> struct that can be Arc-wrapped and shared independently. This allows creating the state first, gating asset sources on that state, and then creating the processor with the shared state. The processed reader was split into gated and ungated versions to resolve a deadlock situation where the processor needed to iterate through directories during initialization but would be blocked by its own gating mechanism.<p>The key architectural insight was recognizing that the processor initialization requires ungated access to processed assets to build its internal state, while normal operations should remain gated. This led to the introduction of <code>ungated_processed_reader</code> alongside the existing gated processed reader in <code>AssetSource</code>.<p>Throughout the implementation, the author focused on improving encapsulation by making several previously public types and methods private, particularly <code>ProcessorGatedReader</code> and <code>AssetSources::gate_on_processor</code>. This reflects a deliberate design choice to prioritize the standard <code>AssetPlugin</code> initialization path over hypothetical custom use cases.<p>The changes required updating the constructors for both <code>AssetServer</code> and <code>AssetProcessor</code> to use <code>Arc&LTAssetSources></code>, which represents a breaking change that necessitated the creation of a comprehensive migration guide. The PR demonstrates careful consideration of initialization order and state management to achieve the sharing goal while maintaining system correctness.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TB
</span><span>    A[AssetSourceBuilders] --> B[Build AssetSources]
</span><span>    B --> C[Arc&LTAssetSources>]
</span><span>    C --> D[AssetServer]
</span><span>    C --> E[AssetProcessor]
</span><span>    C --> F[Processor's Internal AssetServer]
</span><span>    
</span><span>    G[ProcessingState] --> H[ProcessorGatedReader]
</span><span>    G --> I[AssetProcessorData]
</span><span>    
</span><span>    C --> J[AssetSource]
</span><span>    J --> K[Gated Processed Reader]
</span><span>    J --> L[Ungated Processed Reader]
</span><span>    
</span><span>    E --> M[Uses Ungated Reader for Init]
</span><span>    D --> N[Uses Gated Reader for Normal Ops]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-asset-src-processor-mod-rs-122-50><code>crates/bevy_asset/src/processor/mod.rs</code> (+122/-50)</h3><p>This file underwent the most significant changes, introducing the <code>ProcessingState</code> struct and refactoring the asset processor initialization.<p><strong>Key Changes:</strong><ul><li>Extracted processing state into separate <code>ProcessingState</code> struct<li>Modified <code>AssetProcessor::new</code> to return both processor and shared sources<li>Updated state management to use the new <code>ProcessingState</code></ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>AssetProcessorData </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) asset_infos</span><span style=color:#61676ccc>: </span><span>async_lock</span><span style=color:#ed9366>::</span><span>RwLock&LTProcessorAssetInfos>,
</span><span>    state</span><span style=color:#61676ccc>: </span><span>async_lock</span><span style=color:#ed9366>::</span><span>RwLock&LTProcessorState>,
</span><span>    sources</span><span style=color:#61676ccc>:</span><span> AssetSources,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other fields
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>AssetProcessorData </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) processing_state</span><span style=color:#61676ccc>: </span><span>Arc&LTProcessingState>,
</span><span>    sources</span><span style=color:#61676ccc>: </span><span>Arc&LTAssetSources>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other fields
</span><span>}
</span><span>
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>ProcessingState </span><span>{
</span><span>    state</span><span style=color:#61676ccc>: </span><span>async_lock</span><span style=color:#ed9366>::</span><span>RwLock&LTProcessorState>,
</span><span>    asset_infos</span><span style=color:#61676ccc>: </span><span>async_lock</span><span style=color:#ed9366>::</span><span>RwLock&LTProcessorAssetInfos>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... channel fields
</span><span>}
</span></code></pre><h3 id=crates-bevy-asset-src-io-source-rs-26-8><code>crates/bevy_asset/src/io/source.rs</code> (+26/-8)</h3><p>This file was modified to support both gated and ungated processed readers and to use the new <code>ProcessingState</code>.<p><strong>Key Changes:</strong><ul><li>Added <code>ungated_processed_reader</code> field to <code>AssetSource</code><li>Updated <code>gate_on_processor</code> to use <code>ProcessingState</code> instead of <code>AssetProcessorData</code><li>Made <code>gate_on_processor</code> method crate-private</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>AssetSource </span><span>{
</span><span>    processed_reader</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Option</span><span><</span><span style=color:#55b4d4;font-style:italic>Box</span><span>&LTdyn ErasedAssetReader>>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other fields
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>AssetSource </span><span>{
</span><span>    processed_reader</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTArc&LTdyn ErasedAssetReader>>,
</span><span>    ungated_processed_reader</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTArc&LTdyn ErasedAssetReader>>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other fields
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Updated gate_on_processor method:
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>gate_on_processor</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>processing_state</span><span style=color:#61676ccc>: </span><span>Arc&LTProcessingState>) {
</span><span>    </span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(reader) </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>processed_reader</span><span style=color:#ed9366>.</span><span style=color:#f07171>take</span><span>() {
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>ungated_processed_reader </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(reader</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>())</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>processed_reader </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(Arc</span><span style=color:#ed9366>::</span><span>new(ProcessorGatedReader</span><span style=color:#ed9366>::</span><span>new(
</span><span>            </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>id</span><span>()</span><span style=color:#61676ccc>,
</span><span>            reader</span><span style=color:#61676ccc>,
</span><span>            processing_state</span><span style=color:#61676ccc>,
</span><span>        )))</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><h3 id=crates-bevy-asset-src-io-processor-gated-rs-20-27><code>crates/bevy_asset/src/io/processor_gated.rs</code> (+20/-27)</h3><p>This file was updated to use the new <code>ProcessingState</code> and improve encapsulation.<p><strong>Key Changes:</strong><ul><li>Made <code>ProcessorGatedReader</code> crate-private<li>Moved transaction lock logic to <code>ProcessingState</code><li>Updated to use <code>Arc&LTdyn ErasedAssetReader></code> instead of <code>Box</code></ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>ProcessorGatedReader </span><span>{
</span><span>    reader</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Box</span><span>&LTdyn ErasedAssetReader>,
</span><span>    processor_data</span><span style=color:#61676ccc>: </span><span>Arc&LTAssetProcessorData>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>ProcessorGatedReader </span><span>{
</span><span>    reader</span><span style=color:#61676ccc>: </span><span>Arc&LTdyn ErasedAssetReader>,
</span><span>    processing_state</span><span style=color:#61676ccc>: </span><span>Arc&LTProcessingState>,
</span><span>}
</span></code></pre><h3 id=crates-bevy-asset-src-server-mod-rs-10-4><code>crates/bevy_asset/src/server/mod.rs</code> (+10/-4)</h3><p>This file was updated to use shared <code>AssetSources</code> and optimize hot-reloading.<p><strong>Key Changes:</strong><ul><li>Changed <code>AssetServer</code> to use <code>Arc&LTAssetSources></code><li>Added early return to skip hot-reloading when not watching for changes</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>AssetServerData </span><span>{
</span><span>    sources</span><span style=color:#61676ccc>:</span><span> AssetSources,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other fields
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>AssetServerData </span><span>{
</span><span>    sources</span><span style=color:#61676ccc>: </span><span>Arc&LTAssetSources>,
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other fields
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Hot-reloading optimization:
</span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>infos</span><span style=color:#ed9366>.</span><span>watching_for_changes {
</span><span>    </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=release-content-migration-guides-changed-asset-server-init-md-62-0><code>release-content/migration-guides/changed_asset_server_init.md</code> (+62/-0)</h3><p>This new file provides migration guidance for the breaking changes introduced by this PR.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/books/introduction/assets/ target=_blank>Bevy Assets Documentation</a> - Official Bevy asset system documentation<li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/std/sync/struct.Arc.html target=_blank>Arc and Thread Safety in Rust</a> - Understanding shared ownership patterns<li><a rel="noopener nofollow noreferrer" href=https://rust-lang.github.io/async-book/ target=_blank>Async Programming in Rust</a> - Background on async patterns used in this PR</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-11/pr_21763.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>