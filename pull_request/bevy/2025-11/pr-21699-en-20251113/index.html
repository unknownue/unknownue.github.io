<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21699 Update to cosmic-text 0.15
        
    </title><meta content="#21699 Update to cosmic-text 0.15" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-11/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-11-13</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-11/pr-21699-zh-cn-20251113>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>Update to cosmic-text 0.15<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Update to cosmic-text 0.15<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21699<li><strong>Author</strong>: ickshonpe<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Dependencies, S-Ready-For-Final-Review, A-Text, D-Modest<li><strong>Created</strong>: 2025-10-30T20:39:29Z<li><strong>Merged</strong>: 2025-11-13T01:56:35Z<li><strong>Merged By</strong>: cart</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>Update <code>bevy_text</code>’s cosmic-text dependency to 0.15<p>Fixes #21766<h2 id=solution>Solution</h2><p>Very minimal changes here, nothing user facing except an error return type.<ul><li>Cosmic-text no longer uses <code>ttf_parser</code>, so, to validate fonts during asset loading, a <code>skrifa::FontRef</code> is constructed instead. If the font is invalid, the font asset loader now returns a <code>skrifa::ReadError</code>, not a <code>ttf_parser::FaceParsingError</code>.<li>To get a font from the global <code>CosmicFontSystem</code> instance, the <code>get_font</code> function requires a weight now. The weight is looked up from the <code>CosmicFontSystems</code> font database, immediately before the <code>get_font</code> call.</ul><p>The changes here are a little hackish, but that’s a symptom of our lack of support for font collections.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This pull request addresses a dependency update from cosmic-text 0.14 to 0.15, which required adapting to breaking changes in the underlying font parsing library. The core issue was that cosmic-text migrated from using <code>ttf_parser</code> to <code>skrifa</code> for font handling, which necessitated changes in how Bevy validates fonts and retrieves font metrics.<p>The problem emerged because cosmic-text 0.15’s API changes broke Bevy’s existing font loading pipeline. Specifically, the font validation mechanism needed to transition from <code>ttf_parser::Face</code> to <code>skrifa::FontRef</code>, and the font retrieval API now required additional parameters that weren’t previously needed.<p>The solution approach was straightforward but required careful adaptation of the font loading and retrieval logic. The implementation involved two main changes:<p>First, the font validation in <code>Font::try_from_bytes</code> was updated to use <code>skrifa::FontRef::from_index</code> instead of <code>ttf_parser::Face::parse</code>. This change also required updating the error type throughout the font loading pipeline from <code>ttf_parser::FaceParsingError</code> to <code>skrifa::raw::ReadError</code>.<p>Second, the text rendering pipeline needed to adapt to cosmic-text’s new <code>get_font</code> API, which now requires a font weight parameter. Since Bevy’s current font system doesn’t store font weights directly, the implementation looks up the weight from the cosmic-text font database right before calling <code>get_font</code>.<p>The technical insights from this update reveal some architectural limitations in Bevy’s current font handling. The author notes that the solution is “a little hackish” because it exposes Bevy’s lack of proper support for font collections and comprehensive font metadata management. The current approach works around these limitations by querying the cosmic-text database directly when needed.<p>The impact of these changes is minimal from a user perspective - the main observable difference is the different error type returned when font loading fails. However, the update ensures compatibility with the latest cosmic-text version and maintains the text rendering functionality without performance regressions.<p>From an engineering perspective, this PR demonstrates a common pattern in dependency management: adapting to upstream API changes while maintaining backward compatibility for users. The changes are surgical and focused, affecting only the necessary components to make the upgrade work.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Font Asset Loading] --> B[Font Validation]
</span><span>    B --> C[FontRef Validation]
</span><span>    C --> D[ReadError Handling]
</span><span>    
</span><span>    E[Text Rendering] --> F[Font Retrieval]
</span><span>    F --> G[Weight Lookup]
</span><span>    G --> H[get_font with Weight]
</span><span>    
</span><span>    C -.-> I[cosmic-text 0.15]
</span><span>    H -.-> I
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-text-cargo-toml><code>crates/bevy_text/Cargo.toml</code></h3><p>Updated the cosmic-text dependency from 0.14 to 0.15:<pre class=language-toml data-lang=toml style=color:#61676c;background-color:#fafafa><code class=language-toml data-lang=toml><span style=color:#abb0b6;font-style:italic># Before:
</span><span style=color:#399ee6>cosmic-text </span><span>= { </span><span style=color:#399ee6>version </span><span>= </span><span style=color:#86b300>"0.14"</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>features </span><span>= [</span><span style=color:#86b300>"shape-run-cache"</span><span>] }
</span><span>
</span><span style=color:#abb0b6;font-style:italic># After:
</span><span style=color:#399ee6>cosmic-text </span><span>= { </span><span style=color:#399ee6>version </span><span>= </span><span style=color:#86b300>"0.15"</span><span style=color:#61676ccc>, </span><span style=color:#399ee6>features </span><span>= [</span><span style=color:#86b300>"shape-run-cache"</span><span>] }
</span></code></pre><h3 id=crates-bevy-text-src-font-rs><code>crates/bevy_text/src/font.rs</code></h3><p>Updated font validation to use skrifa instead of ttf_parser:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>try_from_bytes</span><span>(</span><span style=color:#ff8f40>font_data</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Vec</span><span><</span><span style=color:#fa6e32>u8</span><span>>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><</span><span style=color:#fa6e32>Self</span><span>, cosmic_text</span><span style=color:#ed9366>::</span><span>ttf_parser</span><span style=color:#ed9366>::</span><span>FaceParsingError> {
</span><span>    </span><span style=color:#fa6e32>use </span><span>cosmic_text</span><span style=color:#ed9366>::</span><span>ttf_parser</span><span style=color:#61676ccc>;
</span><span>    ttf_parser</span><span style=color:#ed9366>::</span><span>Face</span><span style=color:#ed9366>::</span><span>parse(</span><span style=color:#ed9366>&</span><span>font_data</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span>)</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(</span><span style=color:#fa6e32>Self </span><span>{
</span><span>        data</span><span style=color:#61676ccc>: </span><span>Arc</span><span style=color:#ed9366>::</span><span>new(font_data)</span><span style=color:#61676ccc>,
</span><span>    })
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>try_from_bytes</span><span>(</span><span style=color:#ff8f40>font_data</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Vec</span><span><</span><span style=color:#fa6e32>u8</span><span>>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span><</span><span style=color:#fa6e32>Self</span><span>, ReadError> {
</span><span>    </span><span style=color:#fa6e32>let </span><span style=color:#ed9366>_ = </span><span>FontRef</span><span style=color:#ed9366>::</span><span>from_index(</span><span style=color:#ed9366>&</span><span>font_data</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span>)</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(</span><span style=color:#fa6e32>Self </span><span>{
</span><span>        data</span><span style=color:#61676ccc>: </span><span>Arc</span><span style=color:#ed9366>::</span><span>new(font_data)</span><span style=color:#61676ccc>,
</span><span>    })
</span><span>}
</span></code></pre><h3 id=crates-bevy-text-src-font-loader-rs><code>crates/bevy_text/src/font_loader.rs</code></h3><p>Updated error type to match the new validation mechanism:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>error</span><span>(transparent)]
</span><span>Content(</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>from</span><span>] cosmic_text</span><span style=color:#ed9366>::</span><span>ttf_parser</span><span style=color:#ed9366>::</span><span>FaceParsingError)</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>error</span><span>(transparent)]
</span><span>Content(</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>from</span><span>] ReadError)</span><span style=color:#61676ccc>,
</span></code></pre><h3 id=crates-bevy-text-src-pipeline-rs><code>crates/bevy_text/src/pipeline.rs</code></h3><p>Updated font retrieval to include weight parameter:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(font) </span><span style=color:#ed9366>=</span><span> font_system</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_font</span><span>(</span><span style=color:#ed9366>*</span><span>id) {
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> weight </span><span style=color:#ed9366>=</span><span> font_system
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>db</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>face</span><span>(</span><span style=color:#ed9366>*</span><span>id)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|</span><span style=color:#ff8f40>f</span><span>| f</span><span style=color:#ed9366>.</span><span>weight)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap_or</span><span>(cosmic_text</span><span style=color:#ed9366>::</span><span>Weight</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>NORMAL</span><span>)</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>if let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(font) </span><span style=color:#ed9366>=</span><span> font_system</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_font</span><span>(</span><span style=color:#ed9366>*</span><span>id</span><span style=color:#61676ccc>,</span><span> weight) {
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://github.com/pop-os/cosmic-text target=_blank>cosmic-text GitHub Repository</a> - The text shaping and layout library used by Bevy<li><a rel="noopener nofollow noreferrer" href=https://docs.rs/skrifa/ target=_blank>skrifa crate documentation</a> - The new font parsing backend used by cosmic-text 0.15<li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_text/ target=_blank>Bevy Text Documentation</a> - Bevy’s text rendering capabilities<li><a rel="noopener nofollow noreferrer" href=https://developer.mozilla.org/en-US/docs/Web/CSS/font-weight target=_blank>Font Weight in Typography</a> - Understanding font weight values in CSS (similar concepts apply)</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-11/pr_21699.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>