<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21708 Fix asset processing tests being flaky from hot reloading.
        
    </title><meta content="#21708 Fix asset processing tests being flaky from hot reloading." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-11/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-11-01</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-11/pr-21708-zh-cn-20251101>中文</a></div></div><div class=pr-content><h1 id=fix-asset-processing-tests-being-flaky-from-hot-reloading>Fix asset processing tests being flaky from hot reloading</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix asset processing tests being flaky from hot reloading.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21708<li><strong>Author</strong>: andriyDev<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Assets, S-Ready-For-Final-Review, C-Testing, D-Straightforward<li><strong>Created</strong>: 2025-10-31T23:50:30Z<li><strong>Merged</strong>: 2025-11-01T01:01:56Z<li><strong>Merged By</strong>: cart</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Fixes flaky asset processing tests introduced in #21673.<li>Previously the hot-reloading processor tests would just check for the finished processor state. However it was possible for processing to not start quickly enough in multi_threaded, resulting in the test still seeing the state as finished.</ul><h2 id=solution>Solution</h2><ul><li>Use a lock to block reading the source directory until after processing has started. This way the asset processor can’t even check if there’s work to do until the guard is released, so we can’t miss the processing state.</ul><h2 id=testing>Testing</h2><ul><li>Ran it locally with singlethreaded and multithreaded mode.</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a race condition in asset processing tests that was causing intermittent failures in multi-threaded environments. The core issue stemmed from how the tests were verifying that asset processing had completed.<p>The problem occurred because the test code would check for the <code>ProcessorState::Finished</code> state, but in multi-threaded scenarios, the asset processor might not have started processing yet when the check occurred. This created a timing-dependent failure where tests could pass or fail randomly based on thread scheduling.<p>The solution implements a synchronization mechanism using an <code>RwLock</code> to coordinate between the test code and the asset processor. Here’s how it works:<ol><li><p><strong>The Gate Mechanism</strong>: A new <code>LockGatedReader</code> struct wraps the existing <code>MemoryAssetReader</code> and uses an <code>RwLock</code> to control when the asset processor can read from source directories.</p><li><p><strong>Test Control Flow</strong>: Tests now acquire a write lock on the gate before making any changes to source assets. This prevents the asset processor from starting to process assets until the test is ready.</p><li><p><strong>State Monitoring</strong>: The <code>run_app_until_finished_processing</code> function was modified to first wait for the processor to enter a processing state (<code>ProcessorState::Processing</code> or <code>ProcessorState::Initializing</code>) before releasing the lock and then waiting for completion.</p></ol><p>The key insight here is that by controlling when the asset processor can access source files, the test can ensure it observes the entire processing lifecycle rather than potentially missing the processing phase entirely.<p>This approach is particularly elegant because:<ul><li>It doesn’t require complex timing adjustments or arbitrary delays<li>It provides deterministic test behavior regardless of thread scheduling<li>It maintains the existing test structure while fixing the underlying race condition</ul><p>The implementation required changes across multiple test functions, but the pattern is consistent: acquire the lock, set up test data, then run processing with the coordination mechanism.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Test Function] --> B[Acquire Write Lock]
</span><span>    B --> C[Setup Test Assets]
</span><span>    C --> D[Wait for Processing to Start]
</span><span>    D --> E[Release Lock]
</span><span>    E --> F[Wait for Processing to Finish]
</span><span>    F --> G[Verify Results]
</span><span>    
</span><span>    H[Asset Processor] --> I[Attempt to Read Source]
</span><span>    I --> J{Lock Available?}
</span><span>    J -->|No| I
</span><span>    J -->|Yes| K[Process Assets]
</span><span>    K --> L[Complete Processing]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-asset-src-processor-tests-rs-115-33><code>crates/bevy_asset/src/processor/tests.rs</code> (+115/-33)</h3><p>This file contains all the asset processing tests and received significant modifications to implement the synchronization mechanism.<p><strong>Key Changes:</strong><ol><li><strong>New LockGatedReader Implementation:</strong></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>/// Similar to [`crate::io::gated::GatedReader`], but uses a lock instead of a channel to avoid
</span><span style=color:#abb0b6;font-style:italic>/// needing to send the "correct" number of messages.
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Clone)]
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>LockGatedReader</span><span>&LTR</span><span style=color:#61676ccc>:</span><span> AssetReader> {
</span><span>    reader</span><span style=color:#61676ccc>:</span><span> R,
</span><span>    gate</span><span style=color:#61676ccc>: </span><span>Arc&LTRwLock<()>>,
</span><span>}
</span><span>
</span><span style=color:#fa6e32>impl</span><span>&LTR</span><span style=color:#61676ccc>:</span><span> AssetReader> AssetReader </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>LockGatedReader</span><span>&LTR> {
</span><span>    async </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>read</span><span><</span><span style=color:#fa6e32>'a</span><span>>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'a </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>path</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'a</span><span> Path) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Result</span><span>&LTimpl Reader </span><span style=color:#ed9366>+ </span><span style=color:#fa6e32>'a</span><span>, AssetReaderError> {
</span><span>        </span><span style=color:#fa6e32>let</span><span> _guard </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>gate</span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>()</span><span style=color:#ed9366>.</span><span>await</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>reader</span><span style=color:#ed9366>.</span><span style=color:#f07171>read</span><span>(path)</span><span style=color:#ed9366>.</span><span>await
</span><span>    }
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... other methods follow same pattern
</span><span>}
</span></code></pre><ol start=2><li><strong>Modified App Structure:</strong></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>struct </span><span style=color:#399ee6>AppWithProcessor </span><span>{
</span><span>    app</span><span style=color:#61676ccc>:</span><span> App,
</span><span>    source_gate</span><span style=color:#61676ccc>: </span><span>Arc&LTRwLock<()>>,  </span><span style=color:#abb0b6;font-style:italic>// New field
</span><span>    default_source_dirs</span><span style=color:#61676ccc>:</span><span> ProcessingDirs,
</span><span>    extra_sources_dirs</span><span style=color:#61676ccc>: </span><span>HashMap<</span><span style=color:#55b4d4;font-style:italic>String</span><span>, ProcessingDirs>,
</span><span>}
</span></code></pre><ol start=3><li><strong>Updated Processing Coordination:</strong></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>fn </span><span style=color:#f29718>run_app_until_finished_processing</span><span>(</span><span style=color:#ff8f40>app</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> App, </span><span style=color:#ff8f40>guard</span><span style=color:#61676ccc>: </span><span>RwLockWriteGuard<'</span><span style=color:#ed9366>_</span><span>, ()>) {
</span><span>    </span><span style=color:#fa6e32>let</span><span> processor </span><span style=color:#ed9366>=</span><span> app</span><span style=color:#ed9366>.</span><span style=color:#f07171>world</span><span>()</span><span style=color:#ed9366>.</span><span>resource</span><span style=color:#ed9366>::</span><span>&LTAssetProcessor>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Wait for processing to start, then finish
</span><span>    </span><span style=color:#f07171>run_app_until</span><span>(app</span><span style=color:#61676ccc>, </span><span>|_| {
</span><span>        </span><span style=color:#fa6e32>let</span><span> state </span><span style=color:#ed9366>= </span><span>bevy_tasks</span><span style=color:#ed9366>::</span><span>block_on(processor</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_state</span><span>())</span><span style=color:#61676ccc>;
</span><span>        (state </span><span style=color:#ed9366>== </span><span>ProcessorState</span><span style=color:#ed9366>::</span><span>Processing </span><span style=color:#ed9366>||</span><span> state </span><span style=color:#ed9366>== </span><span>ProcessorState</span><span style=color:#ed9366>::</span><span>Initializing)</span><span style=color:#ed9366>.</span><span style=color:#f07171>then_some</span><span>(())
</span><span>    })</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#f07171>drop</span><span>(guard)</span><span style=color:#61676ccc>;  </span><span style=color:#abb0b6;font-style:italic>// Release the lock, allowing processing to proceed
</span><span>    </span><span style=color:#f07171>run_app_until</span><span>(app</span><span style=color:#61676ccc>, </span><span>|_| {
</span><span>        (bevy_tasks</span><span style=color:#ed9366>::</span><span>block_on(processor</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_state</span><span>()) </span><span style=color:#ed9366>== </span><span>ProcessorState</span><span style=color:#ed9366>::</span><span>Finished)</span><span style=color:#ed9366>.</span><span style=color:#f07171>then_some</span><span>(())
</span><span>    })</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><ol start=4><li><strong>Test Pattern Updates:</strong> Each test now follows this pattern:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let</span><span> guard </span><span style=color:#ed9366>=</span><span> source_gate</span><span style=color:#ed9366>.</span><span style=color:#f07171>write_blocking</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// Setup test assets...
</span><span style=color:#f07171>run_app_until_finished_processing</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> app</span><span style=color:#61676ccc>,</span><span> guard)</span><span style=color:#61676ccc>;
</span><span style=color:#abb0b6;font-style:italic>// Verify results...
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/std/sync/struct.RwLock.html target=_blank>RwLock documentation</a> - Understanding reader-writer locks<li><a rel="noopener nofollow noreferrer" href=https://docs.rs/async-lock/ target=_blank>Async locks in Rust</a> - The async_lock crate used in this implementation<li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/book/ch16-00-concurrency.html target=_blank>Testing concurrent systems</a> - General principles for testing multi-threaded code<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/assets/ target=_blank>Bevy Asset System</a> - Bevy’s asset processing architecture</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-11/pr_21708.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>