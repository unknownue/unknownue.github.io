<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21760 enable tracy subscriber layer on android
        
    </title><meta content="#21760 enable tracy subscriber layer on android" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-11/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-11-12</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-11/pr-21760-zh-cn-20251112>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>enable tracy subscriber layer on android<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: enable tracy subscriber layer on android<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21760<li><strong>Author</strong>: WireWhiz<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Feature, O-Android, S-Ready-For-Final-Review, A-Diagnostics<li><strong>Created</strong>: 2025-11-06T02:29:16Z<li><strong>Merged</strong>: 2025-11-09T18:22:35Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>I really need tracing on android right now as I’m attempting to profile bevy running on a quest 3.<h2 id=solution>Solution</h2><p>I saw <a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/issues/21612 target=_blank>this issue</a> already opened about it around 2 weeks ago, and I was able to use it to figure out how to enable tracy to run on android. However I did not enable it for IOS and made sure to retain the same behavior for other flags such as chrome style profiling.<h2 id=testing>Testing</h2><p>I’ve tested that the engine still builds on both windows and to android. Additionally the flame graph will now show complete frames of info, instead of one single mono-frame with 4 different render events.<p>Android also requires: <code>android.permission.INTERNET</code> and possibly <code>android.permission.NEARBY_WIFI_DEVICES</code> to be able to host the debug server.<h2 id=showcase>Showcase</h2><p>Tracy running for an apk deployed to a quest 3. <img alt=image height=687 src=https://github.com/user-attachments/assets/16e249c4-48db-46fd-baa0-604ec9a12856 width=2090><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The developer needed to profile Bevy performance on Android devices, specifically a Quest 3 VR headset, but encountered a limitation where Tracy tracing wasn’t available on Android. This made performance analysis difficult because the flame graphs showed incomplete frame information - just “one single mono-frame with 4 different render events” instead of the detailed profiling data needed for optimization.<p>The root cause was in Bevy’s logging configuration, where Android was explicitly excluded from Tracy support alongside iOS and WebAssembly. The implementation used conditional compilation flags that prevented the Tracy subscriber layer from being initialized on Android targets.<p>The solution involved restructuring the conditional compilation logic in the LogPlugin to treat Android more like desktop platforms rather than mobile restrictions. The key change was modifying the platform exclusion criteria from excluding <code>wasm32</code>, <code>android</code>, and <code>ios</code> to only excluding <code>wasm32</code> and <code>ios</code>. This allowed Android to enter the main logging configuration block where Tracy and other profiling tools are set up.<p>However, the developer made careful engineering decisions to maintain platform-specific behavior where appropriate. Chrome-style profiling (<code>tracing-chrome</code>) remained disabled on Android since it wasn’t needed, while Tracy profiling was enabled. The Android-specific tracing layer (<code>android_tracing::AndroidLayer</code>) was moved into the main configuration block rather than being handled in a separate platform-specific section, creating a more unified initialization flow.<p>The implementation demonstrates good platform-aware design by:<ul><li>Enabling the needed feature (Tracy) on the target platform<li>Preserving existing behavior for other platforms<li>Maintaining feature flags for optional components<li>Organizing the code logically by platform capabilities rather than arbitrary exclusions</ul><p>From a technical perspective, the changes show how Rust’s conditional compilation system (<code>#[cfg]</code> attributes) can be used to create platform-specific feature sets while maintaining clean code organization. The restructuring also improves maintainability by reducing code duplication - the Android layer initialization is now colocated with other layer initializations rather than in a separate block.<p>The impact is significant for Android development with Bevy. Developers can now use Tracy for detailed performance profiling on Android devices, which is crucial for optimizing VR applications on Quest devices where performance is critical. The permissions note about requiring <code>android.permission.INTERNET</code> is important since Tracy needs network access to communicate with its profiling server.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[LogPlugin Setup] --> B{Platform Check}
</span><span>    B --> C[WASM32]
</span><span>    B --> D[iOS]
</span><span>    B --> E[Android]
</span><span>    B --> F[Other Platforms]
</span><span>    
</span><span>    C --> G[Minimal Logging]
</span><span>    D --> H[OS Logger]
</span><span>    E --> I[Tracy Enabled]
</span><span>    E --> J[Android Layer]
</span><span>    E --> K[No Chrome Profiling]
</span><span>    F --> L[Full Feature Set]
</span><span>    F --> M[Chrome Profiling]
</span><span>    F --> N[Tracy Enabled]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>File: <code>crates/bevy_log/src/lib.rs</code></strong><p>This file contains the main logging configuration for Bevy. The changes restructured how different platforms initialize their logging and tracing subsystems, specifically enabling Tracy profiling on Android.<p><strong>Key Changes:</strong><ol><li><strong>Platform Exclusion Logic Modified:</strong></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(</span><span style=color:#f29718>all</span><span>(
</span><span>    </span><span style=color:#f29718>not</span><span>(target_arch </span><span style=color:#ed9366>= </span><span style=color:#86b300>"wasm32"</span><span>)</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#f29718>not</span><span>(target_os </span><span style=color:#ed9366>= </span><span style=color:#86b300>"android"</span><span>)</span><span style=color:#61676ccc>, 
</span><span>    </span><span style=color:#f29718>not</span><span>(target_os </span><span style=color:#ed9366>= </span><span style=color:#86b300>"ios"</span><span>)
</span><span>))]
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(</span><span style=color:#f29718>all</span><span>(</span><span style=color:#f29718>not</span><span>(target_arch </span><span style=color:#ed9366>= </span><span style=color:#86b300>"wasm32"</span><span>)</span><span style=color:#61676ccc>, </span><span style=color:#f29718>not</span><span>(target_os </span><span style=color:#ed9366>= </span><span style=color:#86b300>"ios"</span><span>)))]
</span></code></pre><p>This change removes Android from the exclusion list, allowing it to use the same logging configuration as desktop platforms.<ol start=2><li><strong>Chrome Profiling Limited on Android:</strong></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Chrome layer only enabled when NOT on Android
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(</span><span style=color:#f29718>all</span><span>(feature </span><span style=color:#ed9366>= </span><span style=color:#86b300>"tracing-chrome"</span><span style=color:#61676ccc>, </span><span style=color:#f29718>not</span><span>(target_os </span><span style=color:#ed9366>= </span><span style=color:#86b300>"android"</span><span>)))]
</span><span style=color:#fa6e32>let</span><span> chrome_layer </span><span style=color:#ed9366>= </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// chrome layer initialization
</span><span>}</span><span style=color:#61676ccc>;
</span></code></pre><ol start=3><li><strong>Android Layer Integration:</strong></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Android layer now integrated into main configuration block
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(target_os </span><span style=color:#ed9366>= </span><span style=color:#86b300>"android"</span><span>)]
</span><span style=color:#fa6e32>let</span><span> subscriber </span><span style=color:#ed9366>=</span><span> subscriber</span><span style=color:#ed9366>.</span><span style=color:#f07171>with</span><span>(android_tracing</span><span style=color:#ed9366>::</span><span>AndroidLayer</span><span style=color:#ed9366>::</span><span>default())</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Removed separate Android configuration block that was here before
</span></code></pre><ol start=4><li><strong>Tracy Layer Now Available on Android:</strong> Since Android now enters the main configuration block, the Tracy layer is automatically included when the <code>tracing-tracy</code> feature is enabled.</ol><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://github.com/wolfpld/tracy target=_blank>Tracy Profiler Documentation</a> - The profiling tool enabled by this change<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/advanced/diagnostics/ target=_blank>Bevy Diagnostics Documentation</a> - Bevy’s approach to performance monitoring<li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/reference/conditional-compilation.html target=_blank>Rust Conditional Compilation</a> - How <code>#[cfg]</code> attributes work<li><a rel="noopener nofollow noreferrer" href=https://developer.android.com/topic/performance/tracing target=_blank>Android Tracing</a> - Android’s native tracing capabilities</ul><h1 id=full-code-diff>Full Code Diff</h1><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_log/src/lib.rs b/crates/bevy_log/src/lib.rs
</span><span>index 988fa8e23ad71..0abe1941c5793 100644
</span><span style=color:#c594c5>--- a/crates/bevy_log/src/lib.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_log/src/lib.rs
</span><span style=color:#c594c5>@@ -336,13 +336,9 @@ </span><span style=color:#399ee6>impl Plugin for LogPlugin {
</span><span>         #[cfg(feature = "trace")]
</span><span>         let subscriber = subscriber.with(tracing_error::ErrorLayer::default());
</span><span> 
</span><span style=color:#f07171>-        #[cfg(all(
</span><span style=color:#f07171>-            not(target_arch = "wasm32"),
</span><span style=color:#f07171>-            not(target_os = "android"),
</span><span style=color:#f07171>-            not(target_os = "ios")
</span><span style=color:#f07171>-        ))]
</span><span style=color:#86b300>+        #[cfg(all(not(target_arch = "wasm32"), not(target_os = "ios")))]
</span><span>         {
</span><span style=color:#f07171>-            #[cfg(feature = "tracing-chrome")]
</span><span style=color:#86b300>+            #[cfg(all(feature = "tracing-chrome", not(target_os = "android")))]
</span><span>             let chrome_layer = {
</span><span>                 let mut layer = tracing_chrome::ChromeLayerBuilder::new();
</span><span>                 if let Ok(path) = std::env::var("TRACE_CHROME") {
</span><span style=color:#c594c5>@@ -386,10 +382,12 @@ </span><span style=color:#399ee6>impl Plugin for LogPlugin {
</span><span> 
</span><span>             let subscriber = subscriber.with(fmt_layer);
</span><span> 
</span><span style=color:#f07171>-            #[cfg(feature = "tracing-chrome")]
</span><span style=color:#86b300>+            #[cfg(all(feature = "tracing-chrome", not(target_os = "android")))]
</span><span>             let subscriber = subscriber.with(chrome_layer);
</span><span>             #[cfg(feature = "tracing-tracy")]
</span><span>             let subscriber = subscriber.with(tracy_layer);
</span><span style=color:#86b300>+            #[cfg(target_os = "android")]
</span><span style=color:#86b300>+            let subscriber = subscriber.with(android_tracing::AndroidLayer::default());
</span><span>             finished_subscriber = subscriber;
</span><span>         }
</span><span> 
</span><span style=color:#c594c5>@@ -400,11 +398,6 @@ </span><span style=color:#399ee6>impl Plugin for LogPlugin {
</span><span>             ));
</span><span>         }
</span><span> 
</span><span style=color:#f07171>-        #[cfg(target_os = "android")]
</span><span style=color:#f07171>-        {
</span><span style=color:#f07171>-            finished_subscriber = subscriber.with(android_tracing::AndroidLayer::default());
</span><span style=color:#f07171>-        }
</span><span style=color:#f07171>-
</span><span>         #[cfg(target_os = "ios")]
</span><span>         {
</span><span>             finished_subscriber = subscriber.with(tracing_oslog::OsLogger::default());
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-11/pr_21760.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>