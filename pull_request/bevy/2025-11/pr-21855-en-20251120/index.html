<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21855 Add tests for processor initialization and fix a bug with initialization.
        
    </title><meta content="#21855 Add tests for processor initialization and fix a bug with initialization." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-11/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-11-20</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-11/pr-21855-zh-cn-20251120>中文</a></div></div><div class=pr-content><h1 id=add-tests-for-processor-initialization-and-fix-a-bug-with-initialization>Add tests for processor initialization and fix a bug with initialization.</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Add tests for processor initialization and fix a bug with initialization.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21855<li><strong>Author</strong>: andriyDev<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Assets, S-Ready-For-Final-Review, C-Testing, D-Straightforward<li><strong>Created</strong>: 2025-11-16T05:21:29Z<li><strong>Merged</strong>: 2025-11-20T01:00:48Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>We have no tests on the initialization process with an existing processing state.<li>There was a bug (caught by these tests!) where we were deleting directories while we were iterating through them, resulting in us missing directories in some cases.</ul><h2 id=solution>Solution</h2><ul><li>Add two tests to ensure processor init does what we expect with existing processed assets.<li>Store all the empty directories in a Vec while iterating and then delete them all after we’re done iterating.</ul><h2 id=testing>Testing</h2><ul><li>Yup!</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a gap in the Bevy asset processor’s test coverage and fixes a subtle bug discovered during that testing effort. The core issue revolves around how the asset processor handles initialization when there are already processed assets present.<p>The problem emerged from the processor’s directory cleanup logic. During initialization, the processor scans the processed asset directory to determine which assets need to be processed or re-processed. As part of this process, it removes empty directories to clean up after assets that may have been deleted. However, the original implementation was deleting these directories <em>while</em> iterating through the directory structure.<p>The bug occurred because modifying the directory structure during iteration can cause the directory iterator to skip over paths. This is similar to the common programming error of modifying a collection while iterating over it. In file system terms, when you remove a directory during traversal, the iterator’s internal state may become invalid, potentially causing it to miss subsequent directories.<p>The solution implemented here takes a straightforward approach: instead of deleting empty directories immediately upon discovery, the code now collects them in a <code>Vec&LTPathBuf></code> during iteration and then deletes them all after the iteration is complete. This ensures the directory structure remains stable during traversal.<p>The PR adds two comprehensive tests that validate the processor’s behavior with existing processed assets:<ol><li><p><strong><code>clears_invalid_data_from_processed_dir</code></strong> - Tests that the processor correctly cleans up orphaned assets (assets present in processed directory but not in source) and removes empty directories.</p><li><p><strong><code>only_reprocesses_wrong_hash_on_startup</code></strong> - Tests that the processor only reprocesses assets whose source has changed or whose dependencies have changed, avoiding unnecessary reprocessing of unchanged assets.</p></ol><p>These tests revealed the directory deletion bug and now serve as regression tests to prevent similar issues in the future. The test scenarios are carefully constructed to simulate real-world conditions where processed assets might be present from previous runs, including assets with correct data but missing metadata, orphaned assets, and complex dependency chains.<p>The implementation demonstrates good software engineering practices by first writing tests that expose the problem, then fixing the bug, and finally using those same tests to validate the fix and prevent regressions.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Asset Processor Initialization] --> B[Traverse Processed Directory]
</span><span>    B --> C[Collect Empty Directories]
</span><span>    B --> D[Build Asset Path List]
</span><span>    C --> E[Delete Empty Directories]
</span><span>    D --> F[Compare with Source Assets]
</span><span>    E --> G[Process Required Assets]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-asset-src-processor-mod-rs><code>crates/bevy_asset/src/processor/mod.rs</code></h3><p>This file contains the core asset processor logic. The key change modifies how empty directories are handled during initialization.<p><strong>Key changes:</strong><ul><li>Modified <code>get_asset_paths</code> function signature to accept an optional <code>empty_dirs</code> vector<li>Changed from immediate directory deletion to collection and batch deletion<li>Added explicit comment explaining why deletion must happen after iteration</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>contains_files
</span><span>    </span><span style=color:#ed9366>&&</span><span> path</span><span style=color:#ed9366>.</span><span style=color:#f07171>parent</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_some</span><span>()
</span><span>    </span><span style=color:#ed9366>&& </span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(writer) </span><span style=color:#ed9366>=</span><span> clean_empty_folders_writer
</span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// it is ok for this to fail as it is just a cleanup job.
</span><span>    </span><span style=color:#fa6e32>let </span><span style=color:#ed9366>_ =</span><span> writer</span><span style=color:#ed9366>.</span><span style=color:#f07171>remove_empty_directory</span><span>(</span><span style=color:#ed9366>&</span><span>path)</span><span style=color:#ed9366>.</span><span>await</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#abb0b6;font-style:italic>// Add the current directory after all its subdirectories so we delete any empty
</span><span style=color:#abb0b6;font-style:italic>// subdirectories before the current directory.
</span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>contains_files
</span><span>    </span><span style=color:#ed9366>&&</span><span> path</span><span style=color:#ed9366>.</span><span style=color:#f07171>parent</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>is_some</span><span>()
</span><span>    </span><span style=color:#ed9366>&& </span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(empty_dirs) </span><span style=color:#ed9366>=</span><span> empty_dirs
</span><span>{
</span><span>    empty_dirs</span><span style=color:#ed9366>.</span><span style=color:#f07171>push</span><span>(path)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=crates-bevy-asset-src-processor-tests-rs><code>crates/bevy_asset/src/processor/tests.rs</code></h3><p>This file received extensive additions with two new comprehensive tests and a helper function.<p><strong>Key additions:</strong><ul><li>Added <code>serialize_as_cool_text</code> helper function for test asset creation<li>Added <code>clears_invalid_data_from_processed_dir</code> test<li>Added <code>only_reprocesses_wrong_hash_on_startup</code> test</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// New helper function for creating test assets
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>serialize_as_cool_text</span><span>(</span><span style=color:#ff8f40>text</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>str</span><span>) </span><span style=color:#61676ccc>-></span><span> String {
</span><span>    </span><span style=color:#fa6e32>let</span><span> cool_text_ron </span><span style=color:#ed9366>=</span><span> CoolTextRon {
</span><span>        text</span><span style=color:#61676ccc>:</span><span> text</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()</span><span style=color:#61676ccc>,
</span><span>        dependencies</span><span style=color:#61676ccc>: </span><span style=color:#f07171>vec!</span><span>[]</span><span style=color:#61676ccc>,
</span><span>        embedded_dependencies</span><span style=color:#61676ccc>: </span><span style=color:#f07171>vec!</span><span>[]</span><span style=color:#61676ccc>,
</span><span>        sub_texts</span><span style=color:#61676ccc>: </span><span style=color:#f07171>vec!</span><span>[]</span><span style=color:#61676ccc>,
</span><span>    }</span><span style=color:#61676ccc>;
</span><span>    ron</span><span style=color:#ed9366>::</span><span>ser</span><span style=color:#ed9366>::</span><span>to_string_pretty(</span><span style=color:#ed9366>&</span><span>cool_text_ron</span><span style=color:#61676ccc>, </span><span>PrettyConfig</span><span style=color:#ed9366>::</span><span>new()</span><span style=color:#ed9366>.</span><span style=color:#f07171>new_line</span><span>(</span><span style=color:#86b300>"</span><span style=color:#4cbf99>\n</span><span style=color:#86b300>"</span><span>))</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Example test structure showing comprehensive scenario setup
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>test</span><span>]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>clears_invalid_data_from_processed_dir</span><span>() {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Test setup creates various scenarios:
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// - Assets with correct data but no metadata (should be reprocessed)
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// - Orphaned assets not present in source (should be deleted)
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// - Empty directories (should be deleted)
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Complex assertions verify the expected state after processing
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/std/iter/trait.Iterator.html target=_blank>Rust Iterator Documentation</a> - Understanding iterator behavior and the risks of modifying during iteration<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/getting-started/assets/ target=_blank>Bevy Asset System Documentation</a> - Context for how the asset processor fits into Bevy’s architecture<li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Software_testing target=_blank>Software Testing Principles</a> - Background on the testing methodology used in this PR</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-11/pr_21855.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>