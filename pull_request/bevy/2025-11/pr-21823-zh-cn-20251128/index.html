<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21823 Improve `ThinSlicePtr` API
        
    </title><meta content="#21823 Improve `ThinSlicePtr` API" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-11/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-11-28</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2025-11/pr-21823-en-20251128>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=improve-thinsliceptr-api>Improve <code>ThinSlicePtr</code> API</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Improve <code>ThinSlicePtr</code> API<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21823<li><strong>Author</strong>: BD103<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Docs, C-Code-Quality, S-Ready-For-Final-Review, M-Migration-Guide, A-Pointers, D-Straightforward, D-Unsafe<li><strong>Created</strong>: 2025-11-13T02:10:27Z<li><strong>Merged</strong>: 2025-11-28T08:30:42Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><h1 id=mu-biao>目标</h1><ul><li>尽管是不安全的，<code>ThinSlicePtr::get()</code> 并没有明确表示它不执行边界检查，除非你对这个API很熟悉。<li><code>ThinSlicePtr::get()</code> 接受 <code>self</code>，而不是 <code>&self</code>，意味着每次调用 <code>get()</code> 都会消耗 <code>ThinSlicePtr</code>。这与 <a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/stable/std/primitive.slice.html#method.get target=_blank><code>slice.get()</code></a> 的行为不匹配，后者接受 <code>&self</code>。 <ul><li>这个小问题被 <code>ThinSlicePtr</code> 实现了 <code>Copy</code> 这一事实所掩盖。这不是一个大问题，因为最终编译出的机器代码是一样的，但是 <code>get()</code> 要求 <code>self</code> 是没有意义的。</ul><li><code>ThinSlicePtr</code> 可以使用更好的文档，并且可以在某些方面稍作改进。</ul><h2 id=jie-jue-fang-an>解决方案</h2><ul><li>将 <code>ThinSlicePtr::get()</code> 重命名为 <code>get_unchecked()</code>，使API镜像 <a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/stable/std/primitive.slice.html#method.get_unchecked target=_blank><code>slice.get_unchecked()</code></a>。旧的 <code>get()</code> 作为已弃用的方法保留，将在 1.19.0 中移除。<li>使新的 <code>slice.get_unchecked()</code> 接受 <code>&self</code> 而不是 <code>self</code>。<li>添加更多文档并稍微重新整理代码，同时保持原始行为。</ul><h2 id=ce-shi>测试</h2><ul><li>任何意外的更改都应该被 Rust 编译器和 Miri 捕获！</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>这个PR的核心问题是关于API设计和开发者体验的改进。<code>ThinSlicePtr</code> 是一个性能优化的数据结构，它在概念上等价于 <code>&[T]</code>，但为了性能原因去掉了长度信息。然而，原有的API设计存在几个问题，可能给开发者带来困惑。<p>问题的根源在于 <code>ThinSlicePtr::get()</code> 方法的设计与Rust标准库的惯例不一致。在标准库中，<code>get()</code> 方法通常进行边界检查并返回 <code>Option</code>，而不进行边界检查的方法通常命名为 <code>get_unchecked()</code>。原有的 <code>ThinSlicePtr::get()</code> 实际上是不安全的，因为它不进行边界检查，但名称并没有明确传达这一点。<p>此外，方法签名也存在不一致性。<code>ThinSlicePtr::get()</code> 接受 <code>self</code> 而不是 <code>&self</code>，这意味着每次调用都会消耗所有权。虽然由于 <code>ThinSlicePtr</code> 实现了 <code>Copy</code> trait，这在实践中不会造成问题，但这种设计与标准库的切片API不一致，可能让开发者感到困惑。<p>解决方案采用了渐进式改进的方法。首先，引入新的 <code>get_unchecked()</code> 方法，它接受 <code>&self</code> 参数，与标准库保持一致。同时，将原有的 <code>get()</code> 方法标记为已弃用，为开发者提供迁移路径。这种方法确保了向后兼容性，同时引导开发者转向更清晰、更符合惯例的API。<p>在实现层面，PR还对代码进行了重构以提高可读性。特别是在调试模式下，现在使用了 <code>assert!</code> 而不是 <code>debug_assert!</code> 来进行边界检查，因为 <code>self.len</code> 字段在非调试模式下不存在。这种改进使得调试体验更加友好。<p>文档方面也得到了显著加强。现在 <code>ThinSlicePtr</code> 有了完整的文档说明，包括使用示例和安全性要求，这有助于开发者正确理解和使用这个API。<p>整个PR的影响是双重的：一方面，它提高了API的一致性和可预测性，使开发者更容易理解代码的行为；另一方面，它通过更好的文档和错误消息改善了开发体验。这些改进虽然看起来很小，但对于一个底层的数据结构来说至关重要，因为它直接影响到底层系统的可维护性和可靠性。<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[ThinSlicePtr API Issues] --> B[API Inconsistency]
</span><span>    A --> C[Poor Documentation]
</span><span>    A --> D[Method Signature Problems]
</span><span>    
</span><span>    B --> E[Rename get to get_unchecked]
</span><span>    C --> F[Add Comprehensive Documentation]
</span><span>    D --> G[Change self to &self]
</span><span>    
</span><span>    E --> H[Improved API Clarity]
</span><span>    F --> I[Better Developer Experience]
</span><span>    G --> J[Consistent with Stdlib]
</span><span>    
</span><span>    H --> K[Safer Unsafe Code]
</span><span>    I --> K
</span><span>    J --> K
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ptr-src-lib-rs-48-11><code>crates/bevy_ptr/src/lib.rs</code> (+48/-11)</h3><p>这是主要的修改文件，包含了 <code>ThinSlicePtr</code> API 的核心改进：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 主要改进：重命名方法并改进参数
</span><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub unsafe fn </span><span style=color:#f29718>get</span><span>(</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>index</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'a</span><span> T {
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(debug_assertions)]
</span><span>    </span><span style=color:#f07171>debug_assert!</span><span>(index </span><span style=color:#ed9366>< </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>len)</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#fa6e32>let</span><span> ptr </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>ptr</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_ptr</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>unsafe </span><span>{ </span><span style=color:#ed9366>&*</span><span>ptr</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(index) }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub unsafe fn </span><span style=color:#f29718>get_unchecked</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>index</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'a</span><span> T {
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(debug_assertions)]
</span><span>    </span><span style=color:#f07171>assert!</span><span>(index </span><span style=color:#ed9366>< </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>len</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"tried to index out-of-bounds of a slice"</span><span>)</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#fa6e32>unsafe </span><span>{ </span><span style=color:#ed9366>&*</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>ptr</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(index)</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_ptr</span><span>() }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 保留向后兼容的已弃用方法
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>deprecated</span><span>(since </span><span style=color:#ed9366>= </span><span style=color:#86b300>"0.18.0"</span><span style=color:#61676ccc>,</span><span> note </span><span style=color:#ed9366>= </span><span style=color:#86b300>"use get_unchecked() instead"</span><span>)]
</span><span style=color:#fa6e32>pub unsafe fn </span><span style=color:#f29718>get</span><span>(</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>index</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'a</span><span> T {
</span><span>    </span><span style=color:#fa6e32>unsafe </span><span>{ </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_unchecked</span><span>(index) }
</span><span>}
</span></code></pre><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 改进的 From 实现
</span><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>from</span><span>(</span><span style=color:#ff8f40>slice</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'a</span><span> [T]) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>    </span><span style=color:#fa6e32>let</span><span> ptr </span><span style=color:#ed9366>=</span><span> slice</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_ptr</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>cast_mut</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>Self </span><span>{
</span><span>        ptr</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>unsafe </span><span>{ NonNull</span><span style=color:#ed9366>::</span><span>new_unchecked(ptr</span><span style=color:#ed9366>.</span><span style=color:#f07171>debug_ensure_aligned</span><span>()) }</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(debug_assertions)]
</span><span>        len</span><span style=color:#61676ccc>:</span><span> slice</span><span style=color:#ed9366>.</span><span style=color:#f07171>len</span><span>()</span><span style=color:#61676ccc>,
</span><span>        _marker</span><span style=color:#61676ccc>:</span><span> PhantomData</span><span style=color:#61676ccc>,
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>from</span><span>(</span><span style=color:#ff8f40>slice</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'a</span><span> [T]) </span><span style=color:#61676ccc>-> </span><span style=color:#fa6e32>Self </span><span>{
</span><span>    </span><span style=color:#fa6e32>let</span><span> ptr </span><span style=color:#ed9366>=</span><span> slice</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_ptr</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>cast_mut</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>debug_ensure_aligned</span><span>()</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#fa6e32>Self </span><span>{
</span><span>        ptr</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>unsafe </span><span>{ NonNull</span><span style=color:#ed9366>::</span><span>new_unchecked(ptr) }</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(debug_assertions)]
</span><span>        len</span><span style=color:#61676ccc>:</span><span> slice</span><span style=color:#ed9366>.</span><span style=color:#f07171>len</span><span>()</span><span style=color:#61676ccc>,
</span><span>        _marker</span><span style=color:#61676ccc>:</span><span> PhantomData</span><span style=color:#61676ccc>,
</span><span>    }
</span><span>}
</span></code></pre><h3 id=release-content-migration-guides-thin-slice-ptr-get-unchecked-md-21-0><code>release-content/migration-guides/thin_slice_ptr_get_unchecked.md</code> (+21/-0)</h3><p>新增了迁移指南，帮助开发者从旧API迁移到新API：<pre class=language-markdown data-lang=markdown style=color:#61676c;background-color:#fafafa><code class=language-markdown data-lang=markdown><span style=color:#abb0b6;background-color:#61676c10;font-weight:700>---
</span><span>title: Rename </span><span style=color:#ed9366;background-color:#61676c10>`ThinSlicePtr::get()`</span><span> to </span><span style=color:#ed9366;background-color:#61676c10>`ThinSlicePtr::get_unchecked()`</span><span>
</span><span>pull_requests: [21823]
</span><span style=color:#fa6e32;font-weight:700>---
</span><span>
</span><span style=color:#ed9366;background-color:#61676c10>`ThinSlicePtr::get()`</span><span> has been deprecated in favor of the new </span><span style=color:#ed9366;background-color:#61676c10>`ThinSlicePtr::get_unchecked()`</span><span>
</span><span>method in order to more clearly signal that bounds checking is not performed. Beyond the name
</span><span>change, the only difference between these two methods is that </span><span style=color:#ed9366;background-color:#61676c10>`get_unchecked()`</span><span> takes </span><span style=color:#ed9366;background-color:#61676c10>`&self`</span><span> while
</span><span style=color:#ed9366;background-color:#61676c10>`get()`</span><span> takes </span><span style=color:#ed9366;background-color:#61676c10>`self`</span><span>. In order to migrate, simply rename all usages of </span><span style=color:#ed9366;background-color:#61676c10>`get()`</span><span> with
</span><span style=color:#ed9366;background-color:#61676c10>`get_unchecked()`</span><span>:
</span><span>
</span><span>```</span><span style=color:#ff8f40>rust
</span><span style=color:#fa6e32;background-color:#61676c07>let</span><span style=color:#61676c;background-color:#61676c07> slice</span><span style=color:#61676ccc;background-color:#61676c07>: </span><span style=color:#ed9366;background-color:#61676c07>&</span><span style=color:#61676c;background-color:#61676c07>[</span><span style=color:#fa6e32;background-color:#61676c07>u32</span><span style=color:#61676c;background-color:#61676c07>] </span><span style=color:#ed9366;background-color:#61676c07>= &</span><span style=color:#61676c;background-color:#61676c07>[</span><span style=color:#ff8f40;background-color:#61676c07>2</span><span style=color:#61676ccc;background-color:#61676c07>, </span><span style=color:#ff8f40;background-color:#61676c07>4</span><span style=color:#61676ccc;background-color:#61676c07>, </span><span style=color:#ff8f40;background-color:#61676c07>8</span><span style=color:#61676c;background-color:#61676c07>]</span><span style=color:#61676ccc;background-color:#61676c07>;
</span><span style=color:#fa6e32;background-color:#61676c07>let</span><span style=color:#61676c;background-color:#61676c07> thin_slice </span><span style=color:#ed9366;background-color:#61676c07>= </span><span style=color:#61676c;background-color:#61676c07>ThinSlicePtr</span><span style=color:#ed9366;background-color:#61676c07>::</span><span style=color:#61676c;background-color:#61676c07>from(slice)</span><span style=color:#61676ccc;background-color:#61676c07>;
</span><span style=color:#61676c;background-color:#61676c07>
</span><span style=color:#abb0b6;background-color:#61676c07;font-style:italic>// 0.17
</span><span style=color:#fa6e32;background-color:#61676c07>let</span><span style=color:#61676c;background-color:#61676c07> x </span><span style=color:#ed9366;background-color:#61676c07>= </span><span style=color:#fa6e32;background-color:#61676c07>unsafe </span><span style=color:#61676c;background-color:#61676c07>{ thin_slice</span><span style=color:#ed9366;background-color:#61676c07>.</span><span style=color:#f07171;background-color:#61676c07>get</span><span style=color:#61676c;background-color:#61676c07>(</span><span style=color:#ff8f40;background-color:#61676c07>0</span><span style=color:#61676c;background-color:#61676c07>) }</span><span style=color:#61676ccc;background-color:#61676c07>;
</span><span style=color:#61676c;background-color:#61676c07>
</span><span style=color:#abb0b6;background-color:#61676c07;font-style:italic>// 0.18
</span><span style=color:#fa6e32;background-color:#61676c07>let</span><span style=color:#61676c;background-color:#61676c07> x </span><span style=color:#ed9366;background-color:#61676c07>= </span><span style=color:#fa6e32;background-color:#61676c07>unsafe </span><span style=color:#61676c;background-color:#61676c07>{ thin_slice</span><span style=color:#ed9366;background-color:#61676c07>.</span><span style=color:#f07171;background-color:#61676c07>get_unchecked</span><span style=color:#61676c;background-color:#61676c07>(</span><span style=color:#ff8f40;background-color:#61676c07>0</span><span style=color:#61676c;background-color:#61676c07>) }</span><span style=color:#61676ccc;background-color:#61676c07>;
</span></code></pre><pre style=color:#61676c;background-color:#fafafa><code><span>
</span><span>### `crates/bevy_ecs/src/query/fetch.rs` (+11/-9) 和 `crates/bevy_ecs/src/query/filter.rs` (+2/-2)
</span><span>
</span><span>这些文件更新了使用 `ThinSlicePtr` 的代码，将 `.get()` 调用改为 `.get_unchecked()`：
</span><span>
</span><span>```rust
</span><span>// 在多个地方进行了类似的更新
</span><span>// Before:
</span><span>let item = unsafe { table.get(table_row.index()) };
</span><span>
</span><span>// After:
</span><span>let item = unsafe { table.get_unchecked(table_row.index()) };
</span></code></pre><p>这些更新确保了整个代码库与新的API保持一致。<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/stable/std/primitive.slice.html#method.get_unchecked target=_blank>Rust Standard Library - slice::get_unchecked</a><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/nomicon/working-with-unsafe.html target=_blank>Rustonomicon - Working with Unsafe Code</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/UNSAFE_GUIDELINES.md target=_blank>Bevy Engine - Unsafe Code Guidelines</a><li><a rel="noopener nofollow noreferrer" href=https://rust-lang.github.io/api-guidelines/naming.html target=_blank>Rust API Guidelines - Naming Conventions</a></ul><h1 id=full-code-diff>Full Code Diff</h1><p>diff –git a/crates/bevy_ecs/src/query/fetch.rs b/crates/bevy_ecs/src/query/fetch.rs index 82f4976c49f1d..d672b6ae4d0b7 100644 — a/crates/bevy_ecs/src/query/fetch.rs +++ b/crates/bevy_ecs/src/query/fetch.rs @@ -1653,7 +1653,7 @@ unsafe impl&LTT: Component> QueryData for &T { // SAFETY: set_table was previously called let table = unsafe { table.debug_checked_unwrap() }; // SAFETY: Caller ensures <code>table_row</code> is in range.<ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>           let item = unsafe { table.get(table_row.index()) };
</span></code></pre></ul><ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>           let item = unsafe { table.get_unchecked(table_row.index()) };
</span><span>           item.deref()
</span><span>       },
</span><span>       |sparse_set| {
</span></code></pre></ul><p>@@ -1841,13 +1841,14 @@ unsafe impl<‘__w, T: Component> QueryData for Ref<’__w, T> { unsafe { table.debug_checked_unwrap() };<pre style=color:#61676c;background-color:#fafafa><code><span>             // SAFETY: The caller ensures `table_row` is in range.
</span></code></pre><ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>           let component = unsafe { table_components.get(table_row.index()) };
</span></code></pre></ul><ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>           let component = unsafe { table_components.get_unchecked(table_row.index()) };
</span><span>           // SAFETY: The caller ensures `table_row` is in range.
</span></code></pre></ul><ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>           let added = unsafe { added_ticks.get(table_row.index()) };
</span></code></pre></ul><ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>           let added = unsafe { added_ticks.get_unchecked(table_row.index()) };
</span><span>           // SAFETY: The caller ensures `table_row` is in range.
</span></code></pre></ul><ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>           let changed = unsafe { changed_ticks.get(table_row.index()) };
</span></code></pre></ul><ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>           let changed = unsafe { changed_ticks.get_unchecked(table_row.index()) };
</span><span>           // SAFETY: The caller ensures `table_row` is in range.
</span></code></pre></ul><ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>           let caller = callers.map(|callers| unsafe { callers.get(table_row.index()) });
</span></code></pre></ul><ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>           let caller =
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>               callers.map(|callers| unsafe { callers.get_unchecked(table_row.index()) });
</span><span>
</span><span>           Ref {
</span><span>               value: component.deref(),
</span></code></pre></ul><p>@@ -2053,13 +2054,14 @@ unsafe impl<‘__w, T: Component&LTMutability = Mutable>> QueryData for &’__w mut T unsafe { table.debug_checked_unwrap() };<pre style=color:#61676c;background-color:#fafafa><code><span>             // SAFETY: The caller ensures `table_row` is in range.
</span></code></pre><ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>           let component = unsafe { table_components.get(table_row.index()) };
</span></code></pre></ul><ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>           let component = unsafe { table_components.get_unchecked(table_row.index()) };
</span><span>           // SAFETY: The caller ensures `table_row` is in range.
</span></code></pre></ul><ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>           let added = unsafe { added_ticks.get(table_row.index()) };
</span></code></pre></ul><ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>           let added = unsafe { added_ticks.get_unchecked(table_row.index()) };
</span><span>           // SAFETY: The caller ensures `table_row` is in range.
</span></code></pre></ul><ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>           let changed = unsafe { changed_ticks.get(table_row.index()) };
</span></code></pre></ul><ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>           let changed = unsafe { changed_ticks.get_unchecked(table_row.index()) };
</span><span>           // SAFETY: The caller ensures `table_row` is in range.
</span></code></pre></ul><ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>           let caller = callers.map(|callers| unsafe { callers.get(table_row.index()) });
</span></code></pre></ul><ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>           let caller =
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>               callers.map(|callers| unsafe { callers.get_unchecked(table_row.index()) });
</span><span>
</span><span>           Mut {
</span><span>               value: component.deref_mut(),
</span></code></pre></ul><p>diff –git a/crates/bevy_ecs/src/query/filter.rs b/crates/bevy_ecs/src/query/filter.rs index d0261fae976a4..f8578d5d21705 100644 — a/crates/bevy_ecs/src/query/filter.rs +++ b/crates/bevy_ecs/src/query/filter.rs @@ -850,7 +850,7 @@ unsafe impl&LTT: Component> QueryFilter for Added<t> { // SAFETY: set_table was previously called let table = unsafe { table.debug_checked_unwrap() }; // SAFETY: The caller ensures <code>table_row</code> is in range. <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>           let tick = unsafe { table.get(table_row.index()) };
</span></code></pre></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>           let tick = unsafe { table.get_unchecked(table_row.index()) };
</span><span>
</span><span>           tick.deref().is_newer_than(fetch.last_run, fetch.this_run)
</span><span>       },
</span></code></pre></ul> <p>@@ -1078,7 +1078,7 @@ unsafe impl&LTT: Component> QueryFilter for Changed<t> { // SAFETY: set_table was previously called let table = unsafe { table.debug_checked_unwrap() }; // SAFETY: The caller ensures <code>table_row</code> is in range. <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>           let tick = unsafe { table.get(table_row.index()) };
</span></code></pre></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>           let tick = unsafe { table.get_unchecked(table_row.index()) };
</span><span>
</span><span>           tick.deref().is_newer_than(fetch.last_run, fetch.this_run)
</span><span>       },
</span></code></pre></ul> <p>diff –git a/crates/bevy_ptr/src/lib.rs b/crates/bevy_ptr/src/lib.rs index d4db3462d6af9..e76fcc9f57250 100644 — a/crates/bevy_ptr/src/lib.rs +++ b/crates/bevy_ptr/src/lib.rs @@ -1056,7 +1056,29 @@ impl<’a> OwningPtr<’a, Unaligned> { } }</p> <p>-/// Conceptually equivalent to <code>&'a [T]</code> but with length information cut out for performance reasons +/// Conceptually equivalent to <code>&'a [T]</code> but with length information cut out for performance +/// reasons. +/// +/// Because this type does not store the length of the slice, it is unable to do any sort of bounds +/// checking. As such, only [<code>Self::get_unchecked()</code>] is available for indexing into the slice, +/// where the user is responsible for checking the bounds. +/// +/// When compiled in debug mode (<code>#[cfg(debug_assertion)]</code>), this type will store the length of the +/// slice and perform bounds checking in [<code>Self::get_unchecked()</code>]. +/// +/// # Example +/// +/// <code>+/// # use core::mem::size_of; +/// # use bevy_ptr::ThinSlicePtr; +/// # +/// let slice: &[u32] = &[2, 4, 8]; +/// let thin_slice = ThinSlicePtr::from(slice); +/// +/// assert_eq!(*unsafe { thin_slice.get_unchecked(0) }, 2); +/// assert_eq!(*unsafe { thin_slice.get_unchecked(1) }, 4); +/// assert_eq!(*unsafe { thin_slice.get_unchecked(2) }, 8); +///</code> pub struct ThinSlicePtr<’a, T> { ptr: NonNull<t>, #[cfg(debug_assertions)] @@ -1065,18 +1087,32 @@ pub struct ThinSlicePtr<’a, T> { } <p>impl<’a, T> ThinSlicePtr<’a, T> {</p> <ul><li>#[inline]<li>/// Indexes the slice without doing bounds checks</ul> <ul><li>/// Indexes the slice without performing bounds checks. /// /// # Safety<li>/// /// <code>index</code> must be in-bounds.</ul> <ul><li>pub unsafe fn get(self, index: usize) -> &’a T {</ul> <ul><li>#[inline]<li>pub unsafe fn get_unchecked(&self, index: usize) -> &’a T {<li><pre style=color:#61676c;background-color:#fafafa><code><span>   // We cannot use `debug_assert!` here because `self.len` does not exist when not in debug
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   // mode.
</span><span>   #[cfg(debug_assertions)]
</span></code></pre></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>   debug_assert!(index < self.len);
</span></code></pre></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>   assert!(index < self.len, "tried to index out-of-bounds of a slice");
</span></code></pre></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>   let ptr = self.ptr.as_ptr();
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   // SAFETY: `index` is in-bounds so the resulting pointer is valid to dereference.
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   unsafe { &*ptr.add(index) }
</span></code></pre></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>   // SAFETY: The caller guarantees `index` is in-bounds so that the resulting pointer is
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   // valid to dereference.
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   unsafe { &*self.ptr.add(index).as_ptr() }
</span></code></pre><li>}<li><li>/// Indexes the slice without performing bounds checks.<li>///<li>/// # Safety<li>///<li>/// <code>index</code> must be in-bounds.<li>#[deprecated(since = “0.18.0”, note = “use get_unchecked() instead”)]<li>pub unsafe fn get(self, index: usize) -> &’a T {<li><pre style=color:#61676c;background-color:#fafafa><code><span>   // SAFETY: The caller guarantees that `index` is in-bounds.
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   unsafe { self.get_unchecked(index) }
</span></code></pre> } }</ul> <p>@@ -1091,10 +1127,11 @@ impl<’a, T> Copy for ThinSlicePtr<’a, T> {} impl<’a, T> From<&’a [T]> for ThinSlicePtr<’a, T> { #[inline] fn from(slice: &’a [T]) -> Self {</p> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>   let ptr = slice.as_ptr().cast_mut();
</span></code></pre></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>   let ptr = slice.as_ptr().cast_mut().debug_ensure_aligned();
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>   Self {
</span></code></pre></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>       // SAFETY: a reference can never be null
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       ptr: unsafe { NonNull::new_unchecked(ptr.debug_ensure_aligned()) },
</span></code></pre></ul> <ul><li><pre style=color:#61676c;background-color:#fafafa><code><span>       // SAFETY: A reference can never be null.
</span></code></pre><li><pre style=color:#61676c;background-color:#fafafa><code><span>       ptr: unsafe { NonNull::new_unchecked(ptr) },
</span><span>       #[cfg(debug_assertions)]
</span><span>       len: slice.len(),
</span><span>       _marker: PhantomData,
</span></code></pre></ul> <p>diff –git a/release-content/migration-guides/thin_slice_ptr_get_unchecked.md b/release-content/migration-guides/thin_slice_ptr_get_unchecked.md new file mode 100644 index 0000000000000..b9101992783c8 — /dev/null +++ b/release-content/migration-guides/thin_slice_ptr_get_unchecked.md @@ -0,0 +1,21 @@ +— +title: Rename <code>ThinSlicePtr::get()</code> to <code>ThinSlicePtr::get_unchecked()</code> +pull_requests: [21823] +— + +<code>ThinSlicePtr::get()</code> has been deprecated in favor of the new <code>ThinSlicePtr::get_unchecked()</code> +method in order to more clearly signal that bounds checking is not performed. Beyond the name +change, the only difference between these two methods is that <code>get_unchecked()</code> takes <code>&self</code> while +<code>get()</code> takes <code>self</code>. In order to migrate, simply rename all usages of <code>get()</code> with +<code>get_unchecked()</code>: + +<code>rust +let slice: &[u32] = &[2, 4, 8]; +let thin_slice = ThinSlicePtr::from(slice); + +// 0.17 +let x = unsafe { thin_slice.get(0) }; + +// 0.18 +let x = unsafe { thin_slice.get_unchecked(0) }; +</code> +```</p>    <div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-11/pr_21823.patch id=patch-info style=display:none></div>  <div class=bottom-spacer></div> 