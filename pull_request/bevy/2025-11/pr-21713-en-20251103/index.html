<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21713 Make `LoadContext::path` return an `AssetPath` instead of `std::path::Path`.
        
    </title><meta content="#21713 Make `LoadContext::path` return an `AssetPath` instead of `std::path::Path`." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-11/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-11-03</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-11/pr-21713-zh-cn-20251103>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>Make <code>LoadContext::path</code> return an <code>AssetPath</code> instead of <code>std::path::Path</code><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Make <code>LoadContext::path</code> return an <code>AssetPath</code> instead of <code>std::path::Path</code>.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21713<li><strong>Author</strong>: andriyDev<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: D-Trivial, A-Assets, C-Usability, S-Ready-For-Final-Review, M-Migration-Guide<li><strong>Created</strong>: 2025-11-01T18:33:01Z<li><strong>Merged</strong>: 2025-11-03T19:08:09Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>In #21643, <code>LoadContext::path</code> was incorrectly being used to reference relative files. Since this was a <code>std::path::Path</code> instead of an <code>AssetPath</code>, it did not behave correctly in reference to custom asset sources.</ul><h2 id=solution>Solution</h2><ul><li>Make <code>LoadContext::path</code> return an <code>AssetPath</code> and remove <code>LoadContext::asset_path</code>.</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a fundamental issue in Bevy’s asset loading system where the <code>LoadContext::path</code> method was returning a <code>std::path::Path</code> instead of an <code>AssetPath</code>. The problem surfaced in PR #21643 where developers were using this method to reference relative files, but it failed to work correctly with custom asset sources because <code>std::path::Path</code> lacks the context needed for proper asset resolution.<p>The core issue stems from the architectural mismatch between raw file system paths and Bevy’s asset system. While <code>std::path::Path</code> represents a simple filesystem path, <code>AssetPath</code> encapsulates additional metadata and resolution logic needed for Bevy’s asset pipeline, including support for custom asset sources and embedded assets.<p>The solution approach was straightforward but required careful implementation across multiple subsystems. The developer chose to:<ol><li>Change the return type of <code>LoadContext::path</code> from <code>&Path</code> to <code>&AssetPath<'static></code><li>Remove the redundant <code>LoadContext::asset_path</code> method entirely<li>Update all call sites throughout the codebase to use the new API</ol><p>This change represents a consolidation of the API surface while maintaining backward compatibility through careful migration. The implementation required updates across multiple asset loaders including image loading, shader compilation, GLTF model loading, and example code.<p>Key technical insights from this change:<ol><li><p><strong>Asset Path Resolution</strong>: The <code>AssetPath</code> type provides proper resolution for embedded assets and custom asset sources through methods like <code>resolve_embed()</code>, which <code>std::path::Path</code> cannot support.</p><li><p><strong>API Simplification</strong>: By removing the duplicate <code>asset_path()</code> method, the API becomes more intuitive - there’s now only one way to get the asset path from a load context.</p><li><p><strong>Cross-Platform Consistency</strong>: The migration guide specifically mentions that <code>AssetPath</code> enforces cross-platform “slash” consistency, addressing issues like Windows path separators that were previously handled with manual string replacement.</p></ol><p>The impact of this change is significant for asset loader developers. While the migration is technically straightforward (changing method calls), the behavioral difference is important: code that previously worked with simple filesystem paths now properly supports Bevy’s complete asset system including custom sources and embedded assets.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[LoadContext] --> B[path(): AssetPath]
</span><span>    B --> C[Custom Asset Sources]
</span><span>    B --> D[Embedded Assets]
</span><span>    B --> E[Filesystem Paths]
</span><span>    
</span><span>    F[Old API] --> G[path(): Path]
</span><span>    F --> H[asset_path(): AssetPath]
</span><span>    
</span><span>    style A fill:#e1f5fe
</span><span>    style B fill:#c8e6c9
</span><span>    style F fill:#ffcdd2
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-asset-src-loader-rs-10-4><code>crates/bevy_asset/src/loader.rs</code> (+10/-4)</h3><p>This file contains the core <code>LoadContext</code> implementation where the API changes were made:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>path</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span>Path {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>asset_path</span><span style=color:#ed9366>.</span><span style=color:#f07171>path</span><span>()
</span><span>}
</span><span>
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>asset_path</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span>AssetPath<</span><span style=color:#fa6e32>'static</span><span>> {
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>asset_path
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>path</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span>AssetPath<</span><span style=color:#fa6e32>'static</span><span>> {
</span><span>    </span><span style=color:#ed9366>&</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>asset_path
</span><span>}
</span></code></pre><p>The change consolidates the two methods into one, making <code>path()</code> return the more useful <code>AssetPath</code> directly.<h3 id=crates-bevy-image-src-image-loader-rs-10-4><code>crates/bevy_image/src/image_loader.rs</code> (+10/-4)</h3><p>The image loader needed updates to handle the new return type:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> ext </span><span style=color:#ed9366>=</span><span> load_context</span><span style=color:#ed9366>.</span><span style=color:#f07171>path</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>extension</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_str</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> ext </span><span style=color:#ed9366>=</span><span> load_context
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>path</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>path</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>extension</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>to_str</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><p>When file system path operations are still needed, callers now access the underlying path via <code>asset_path.path()</code>.<h3 id=crates-bevy-shader-src-shader-rs-9-3><code>crates/bevy_shader/src/shader.rs</code> (+9/-3)</h3><p>Similar changes were needed in the shader loader:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> ext </span><span style=color:#ed9366>=</span><span> load_context</span><span style=color:#ed9366>.</span><span style=color:#f07171>path</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>extension</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_str</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> path </span><span style=color:#ed9366>=</span><span> load_context</span><span style=color:#ed9366>.</span><span style=color:#f07171>asset_path</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_string</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> ext </span><span style=color:#ed9366>=</span><span> load_context
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>path</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>path</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>extension</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>to_str</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let</span><span> path </span><span style=color:#ed9366>=</span><span> load_context</span><span style=color:#ed9366>.</span><span style=color:#f07171>path</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_string</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-gltf-src-loader-mod-rs-4-4><code>crates/bevy_gltf/src/loader/mod.rs</code> (+4/-4)</h3><p>The GLTF loader updates demonstrate proper asset path resolution:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> image_path </span><span style=color:#ed9366>=</span><span> load_context
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>asset_path</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>resolve_embed</span><span>(uri)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>expect</span><span>(</span><span style=color:#86b300>"all URIs were already validated"</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> image_path </span><span style=color:#ed9366>=</span><span> load_context
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>path</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>resolve_embed</span><span>(uri)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>expect</span><span>(</span><span style=color:#86b300>"all URIs were already validated"</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=examples-asset-asset-decompression-rs-3-3><code>examples/asset/asset_decompression.rs</code> (+3/-3)</h3><p>The example shows how to properly resolve embedded paths:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let</span><span> contained_path </span><span style=color:#ed9366>=</span><span> compressed_path</span><span style=color:#ed9366>.</span><span style=color:#f07171>join</span><span>(uncompressed_file_name)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let</span><span> contained_path </span><span style=color:#ed9366>=</span><span> compressed_path
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>resolve_embed</span><span>(uncompressed_file_name)
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>map_err</span><span>(|_| GzAssetLoaderError</span><span style=color:#ed9366>::</span><span>IndeterminateFilePath)</span><span style=color:#ed9366>?</span><span style=color:#61676ccc>;
</span></code></pre><p>This change ensures the example works correctly with custom asset sources.<h3 id=release-content-migration-guides-load-context-asset-path-md-14-0><code>release-content/migration-guides/load_context_asset_path.md</code> (+14/-0)</h3><p>The migration guide provides clear instructions:<pre class=language-markdown data-lang=markdown style=color:#61676c;background-color:#fafafa><code class=language-markdown data-lang=markdown><span style=color:#4cbf99>- </span><span style=color:#ed9366;background-color:#61676c10>`load_context.asset_path()`</span><span> -> </span><span style=color:#ed9366;background-color:#61676c10>`load_context.path()`</span><span>
</span><span style=color:#4cbf99>- </span><span style=color:#ed9366;background-color:#61676c10>`load_context.path()`</span><span> -> </span><span style=color:#ed9366;background-color:#61676c10>`load_context.asset_path().path()`</span><span>
</span></code></pre><p>It also includes an important note about considering whether direct <code>Path</code> usage is appropriate given the limitations with custom asset sources.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_asset/latest/bevy_asset/ target=_blank>Bevy Asset System Documentation</a> - Comprehensive guide to Bevy’s asset system<li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_asset/latest/bevy_asset/struct.AssetPath.html target=_blank>AssetPath API Documentation</a> - Details on AssetPath methods and capabilities<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/examples/asset/custom_asset_source.rs target=_blank>Custom Asset Sources</a> - Example of implementing custom asset sources<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/pull/21643 target=_blank>PR #21643</a> - The original PR that identified the issue</ul><h1 id=full-code-diff>Full Code Diff</h1><p><em>(Note: The full code diff was provided in the original request but is omitted here for brevity since the key changes are covered in the sections above.)</em></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-11/pr_21713.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>