<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21961 Don't render meshes that have prepass disabled to the prepass, even if they have shadows enabled.
        
    </title><meta content="#21961 Don't render meshes that have prepass disabled to the prepass, even if they have shadows enabled." property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-11/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-11-28</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-11/pr-21961-zh-cn-20251128>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Don’t render meshes that have prepass disabled to the prepass, even if they have shadows enabled.<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21961<li><strong>Author</strong>: pcwalton<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, D-Straightforward, S-Needs-Review<li><strong>Created</strong>: 2025-11-28T00:28:47Z<li><strong>Merged</strong>: 2025-11-28T08:04:14Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><p>Currently, the <code>specialize_prepass_material_meshes</code> function adds meshes to the prepass unless both <code>prepass_enabled</code> <em>and</em> <code>shadows_enabled</code> are false for that material. This seems incorrect, as (1) the flags are separate for a reason and (2) meshes are added to the shadow pass not in <code>specialize_prepass_material_meshes</code> but in <code>specialize_shadows</code>.<p>This patch changes <code>specialize_prepass_material_meshes</code> to skip adding meshes to the prepass if <code>prepass_enabled</code> is false, even if <code>shadows_enabled</code> is true.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a logical inconsistency in Bevy’s rendering pipeline where material flags were being interpreted incorrectly during the prepass specialization phase. The core issue stemmed from how the <code>specialize_prepass_material_meshes</code> function was making decisions about which meshes to include in the prepass render pipeline.<p>In the original implementation, the function used a compound condition that checked both <code>prepass_enabled</code> AND <code>shadows_enabled</code> flags:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>material</span><span style=color:#ed9366>.</span><span>properties</span><span style=color:#ed9366>.</span><span>prepass_enabled </span><span style=color:#ed9366>&& !</span><span>material</span><span style=color:#ed9366>.</span><span>properties</span><span style=color:#ed9366>.</span><span>shadows_enabled {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Skip this mesh for prepass
</span><span>}
</span></code></pre><p>This logic was problematic because it meant that a mesh with <code>prepass_enabled: false</code> but <code>shadows_enabled: true</code> would still be included in the prepass. This didn’t align with the intended separation of concerns between the two rendering passes.<p>The fix was straightforward but important - changing the condition to only check the <code>prepass_enabled</code> flag:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>material</span><span style=color:#ed9366>.</span><span>properties</span><span style=color:#ed9366>.</span><span>prepass_enabled {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Skip this mesh for prepass
</span><span>}
</span></code></pre><p>This change makes logical sense because the prepass specialization function should only care about whether prepass is enabled for a material. The shadow rendering logic is handled separately in the <code>specialize_shadows</code> function, which correctly uses the <code>shadows_enabled</code> flag to determine which meshes to include in shadow passes.<p>The bug had performance implications because it caused unnecessary rendering work. Meshes that didn’t need prepass rendering were still being processed through the prepass pipeline, wasting GPU resources and potentially affecting frame times. This was particularly problematic for scenes with many objects where the prepass overhead could become significant.<p>The fix demonstrates good separation of concerns in rendering systems - each specialization function should focus on its specific rendering pass and use only the relevant flags for decision making. This aligns with Bevy’s modular architecture where different rendering features can be enabled or disabled independently.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Material Properties] --> B[prepass_enabled flag]
</span><span>    A --> C[shadows_enabled flag]
</span><span>    B --> D[specialize_prepass_material_meshes]
</span><span>    C --> E[specialize_shadows function]
</span><span>    D --> F[Prepass Rendering]
</span><span>    E --> G[Shadow Rendering]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ul><li><code>crates/bevy_pbr/src/prepass/mod.rs</code> (+1/-1)</ul><p>This file contains the core change that fixes the logical inconsistency in prepass material specialization.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// File: crates/bevy_pbr/src/prepass/mod.rs
</span><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>material</span><span style=color:#ed9366>.</span><span>properties</span><span style=color:#ed9366>.</span><span>prepass_enabled </span><span style=color:#ed9366>&& !</span><span>material</span><span style=color:#ed9366>.</span><span>properties</span><span style=color:#ed9366>.</span><span>shadows_enabled {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// If the material was previously specialized for prepass, remove it
</span><span>    view_specialized_material_pipeline_cache</span><span style=color:#ed9366>.</span><span style=color:#f07171>remove</span><span>(visible_entity)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>if </span><span style=color:#ed9366>!</span><span>material</span><span style=color:#ed9366>.</span><span>properties</span><span style=color:#ed9366>.</span><span>prepass_enabled {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// If the material was previously specialized for prepass, remove it
</span><span>    view_specialized_material_pipeline_cache</span><span style=color:#ed9366>.</span><span style=color:#f07171>remove</span><span>(visible_entity)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>The change is minimal but significant - it removes the unnecessary check for <code>shadows_enabled</code> in the prepass specialization logic. This ensures that meshes are only included in the prepass if they explicitly have prepass enabled, regardless of their shadow configuration.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/rendering/ target=_blank>Bevy Rendering Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/book/rendering/prepass/ target=_blank>Prepass Rendering in Bevy</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/crates/bevy_pbr/src/material.rs target=_blank>Material Properties in Bevy PBR</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-11/pr_21961.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>