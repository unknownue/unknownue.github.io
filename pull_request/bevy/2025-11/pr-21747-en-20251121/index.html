<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21747 Solari fixes
        
    </title><meta content="#21747 Solari fixes" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-11/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-11-21</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-11/pr-21747-zh-cn-20251121>中文</a></div></div><div class=pr-content><h1 id=solari-fixes>Solari fixes</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Solari fixes<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21747<li><strong>Author</strong>: JMS55<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, S-Ready-For-Final-Review, C-Refinement<li><strong>Created</strong>: 2025-11-05T02:55:27Z<li><strong>Merged</strong>: 2025-11-21T19:13:07Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><ul><li>Fix overflow/nans in BRDF evaluation<li>Reduce jacobian rejection threshold to prevent light leaks (more aggressive cutoff now)</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This pull request addresses two distinct but related issues in Bevy’s Solari rendering system: numerical stability problems in BRDF evaluation and light leakage artifacts in the ReSTIR GI implementation.<p>The core problem stemmed from numerical instability in material property calculations. When material properties like roughness and metallic values approached extreme values, the BRDF evaluation could produce NaN (Not a Number) values or overflow conditions. These numerical errors would then propagate through the rendering pipeline, causing visual artifacts or even crashes in the rendering system.<p>The solution approach involved clamping material properties to safe numerical ranges. In both the gbuffer processing and raytracing scene bindings, the code now enforces minimum and maximum bounds on perceptual roughness values. The specific clamping value of 0.0316227766 corresponds to the square root of 0.001, ensuring that when squared to compute the actual roughness, it doesn’t drop below the minimum safe threshold of 0.001. This prevents division by zero and other numerical instability issues that occur with extremely small roughness values.<p>Looking at the implementation in <code>gbuffer_utils.wgsl</code>, the key change was replacing a simple roughness calculation with a clamped approach:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>let perceptual_roughness = base_rough.a;
</span><span>let roughness = clamp(perceptual_roughness * perceptual_roughness, 0.001, 1.0);
</span><span>
</span><span>// After:
</span><span>let perceptual_roughness = clamp(base_rough.a, 0.0316227766, 1.0);
</span><span>let roughness = perceptual_roughness * perceptual_roughness;
</span></code></pre><p>The same pattern was applied in <code>raytracing_scene_bindings.wgsl</code> for consistency across different rendering paths. The author also added saturation to metallic values to prevent NaN generation, though they noted this was a defensive measure whose exact necessity wasn’t fully understood.<p>The second issue addressed light leakage in the ReSTIR GI implementation. ReSTIR (ReSTIRred Sampling) is a reservoir-based sampling technique that can suffer from variance explosion when samples with large Jacobian determinants are included in the merging process. The previous threshold of 2.0 was too permissive, allowing samples with excessive variance to contribute to the final result.<p>The fix in <code>restir_gi.wgsl</code> reduces the Jacobian rejection threshold from 2.0 to 1.2:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>if canonical_target_function_other_sample_jacobian > 2.0 {
</span><span>
</span><span>// After:
</span><span>if canonical_target_function_other_sample_jacobian > 1.2 {
</span></code></pre><p>This more aggressive cutoff prevents the merging of samples that would introduce excessive variance, effectively reducing light leakage artifacts while maintaining the benefits of the ReSTIR algorithm.<p>The changes also included minor code cleanup, replacing <code>0.f</code> with <code>0.0</code> for consistency in the pathtracer code, though these were primarily stylistic improvements rather than functional fixes.<p>From a technical perspective, these changes demonstrate important principles in real-time graphics programming:<ol><li><strong>Defensive numerical programming</strong>: Always validate and clamp inputs to prevent numerical instability<li><strong>Consistent treatment of material properties</strong>: Apply the same safety measures across different rendering pipelines<li><strong>Conservative sampling thresholds</strong>: Better to reject potentially problematic samples than to allow artifacts</ol><p>The impact of these changes is improved rendering stability and visual quality. The numerical clamping prevents rendering crashes and visual artifacts from NaN propagation, while the tighter Jacobian threshold reduces light leakage in global illumination, resulting in more physically plausible lighting.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[GBuffer Processing] --> B[Raytracing Scene]
</span><span>    A --> C[Pathtracer BRDF]
</span><span>    B --> D[ReSTIR GI Sampling]
</span><span>    C --> E[Final Rendering]
</span><span>    D --> E
</span><span>    
</span><span>    A --> F[Clamp Roughness]
</span><span>    B --> F
</span><span>    D --> G[Jacobian Threshold]
</span><span>    
</span><span>    F --> H[Prevent NaN/Overflow]
</span><span>    G --> I[Reduce Light Leaks]
</span><span>    
</span><span>    H --> J[Stable Rendering]
</span><span>    I --> J
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-solari-src-realtime-gbuffer-utils-wgsl-4-3><code>crates/bevy_solari/src/realtime/gbuffer_utils.wgsl</code> (+4/-3)</h3><p>This file processes geometry buffer data. The changes prevent numerical instability by clamping material properties.<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>let perceptual_roughness = base_rough.a;
</span><span>let roughness = clamp(perceptual_roughness * perceptual_roughness, 0.001, 1.0);
</span><span>
</span><span>// After:
</span><span>// Clamp roughness to prevent NaNs
</span><span>let perceptual_roughness = clamp(base_rough.a, 0.0316227766, 1.0); // Clamp roughness to 0.001
</span><span>let roughness = perceptual_roughness * perceptual_roughness;
</span><span>let metallic = saturate(props.g); // TODO: Not sure why saturate is needed here to prevent NaNs
</span></code></pre><h3 id=crates-bevy-solari-src-scene-raytracing-scene-bindings-wgsl-4-1><code>crates/bevy_solari/src/scene/raytracing_scene_bindings.wgsl</code> (+4/-1)</h3><p>Applies the same roughness clamping logic to the raytracing pipeline for consistency.<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>m.roughness = clamp(m.perceptual_roughness * m.perceptual_roughness, 0.001, 1.0);
</span><span>
</span><span>// After:
</span><span>// Clamp roughness to prevent NaNs
</span><span>m.perceptual_roughness = clamp(m.perceptual_roughness, 0.0316227766, 1.0); // Clamp roughness to 0.001
</span><span>m.roughness = m.perceptual_roughness * m.perceptual_roughness;
</span></code></pre><h3 id=crates-bevy-solari-src-pathtracer-pathtracer-wgsl-2-2><code>crates/bevy_solari/src/pathtracer/pathtracer.wgsl</code> (+2/-2)</h3><p>Minor code cleanup replacing float literals for consistency.<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>let diffuse_weight = mix(mix(0.4f, 0.9f, ray_hit.material.perceptual_roughness), 0.f, ray_hit.material.metallic);
</span><span>
</span><span>// After:
</span><span>let diffuse_weight = mix(mix(0.4, 0.9, ray_hit.material.perceptual_roughness), 0.0, ray_hit.material.metallic);
</span></code></pre><h3 id=crates-bevy-solari-src-realtime-restir-gi-wgsl-1-1><code>crates/bevy_solari/src/realtime/restir_gi.wgsl</code> (+1/-1)</h3><p>Reduces the Jacobian threshold to prevent light leakage in global illumination.<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>if canonical_target_function_other_sample_jacobian > 2.0 {
</span><span>
</span><span>// After:
</span><span>if canonical_target_function_other_sample_jacobian > 1.2 {
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://pbr-book.org/ target=_blank>Physically Based Rendering</a> - Comprehensive reference on BRDF theory and implementation<li><a rel="noopener nofollow noreferrer" href=https://research.nvidia.com/publication/2020-07_spatiotemporal-reservoir-resampling-real-time-ray-tracing-dynamic-direct target=_blank>ReSTIR Paper</a> - Original paper on Spatiotemporal reservoir resampling<li><a rel="noopener nofollow noreferrer" href=https://graphics.stanford.edu/courses/cs448-01-winter/ target=_blank>Numerical Methods for Computer Graphics</a> - Stanford course covering numerical stability in graphics<li><a rel="noopener nofollow noreferrer" href=https://www.w3.org/TR/WGSL/ target=_blank>WGSL Specification</a> - WebGPU Shading Language reference</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-11/pr_21747.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>