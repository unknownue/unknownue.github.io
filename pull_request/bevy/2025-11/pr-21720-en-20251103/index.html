<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21720 Move wgsl color space utils to separate plugin
        
    </title><meta content="#21720 Move wgsl color space utils to separate plugin" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-11/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-11-03</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-11/pr-21720-zh-cn-20251103>中文</a></div></div><div class=pr-content><h1 id=move-wgsl-color-space-utils-to-separate-plugin>Move wgsl color space utils to separate plugin</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Move wgsl color space utils to separate plugin<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21720<li><strong>Author</strong>: rossleonardy<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, C-Code-Quality, C-Usability, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-11-02T14:03:57Z<li><strong>Merged</strong>: 2025-11-03T19:22:50Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Color conversion functions for shaders #20523</ul><h2 id=solution>Solution</h2><ul><li><p>Moving these wgsl functions to a separate plugin so they can be reused</p><li><p>Users can import the plugin itself or import UiRenderPlugin, which also adds the plugin.</p><li><p>Not sure how to make it more clear that GradientPlugin now requires ColorSpacePlugin to be added first for any users that don’t import all of UiRenderPlugin https://github.com/bevyengine/bevy/issues/69</p><li><p>Because shader libraries needs to be added in a plugin, I left this in bevy_ui_render. If non-ui consumers want to use this and not have a bevy_ui_render dependency, it might need to be moved. bevy_color is the logical place for this but it would introduce a dependency to bevy_ecs and bevy_shader there</p></ul><h2 id=testing>Testing</h2><ul><li>I retested the gradient shaders on the testbed example</ul><h2 id=showcase>Showcase</h2><img alt="Screenshot 2025-11-02 at 8 53 52 AM" height=860 src=https://github.com/user-attachments/assets/9d3c90cc-96ab-4a76-b4ff-09b2aa1b9343 width=1392><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a code organization issue where color space conversion utilities were embedded within gradient shader code, limiting their reusability across the codebase. The problem stemmed from the fact that these color space functions—including conversions between sRGB, linear RGB, HSL, HSV, and Oklab color spaces—were only accessible to gradient shaders, preventing other shaders from leveraging the same functionality.<p>The developer’s approach was to extract these color space utilities into a separate, dedicated plugin that could be imported independently. This follows established software engineering principles of separation of concerns and code reuse. The implementation required creating a new <code>ColorSpacePlugin</code> that loads the color space shader library, then refactoring the existing gradient code to import these functions rather than defining them inline.<p>Looking at the technical implementation, the key insight was recognizing that color space conversion is a distinct concern from gradient rendering. The color space functions handle mathematical transformations between different color representations, while the gradient code focuses on interpolating colors across geometric spaces. By separating these concerns, the codebase gains modularity—other rendering features can now use color space conversions without depending on gradient functionality.<p>The implementation involved significant code movement. The developer extracted 264 lines of color space conversion code from <code>gradient.wgsl</code> into a new <code>color_space.wgsl</code> file. This included functions like:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>fn srgb_to_linear_rgb(color: vec3&LTf32>) -> vec3&LTf32> {
</span><span>    return vec3(
</span><span>        gamma(color.x),
</span><span>        gamma(color.y),
</span><span>        gamma(color.z)
</span><span>    );
</span><span>}
</span><span>
</span><span>fn hsl_to_linear_rgb(hsl: vec3&LTf32>) -> vec3&LTf32> {
</span><span>    let h = hsl.x;
</span><span>    let s = hsl.y;
</span><span>    let l = hsl.z;
</span><span>    let c = (1.0 - abs(2.0 * l - 1.0)) * s;
</span><span>    let hp = h * 6.0;
</span><span>    let x = c * (1.0 - abs(hp % 2.0 - 1.0));
</span><span>    // ... color conversion logic
</span><span>}
</span></code></pre><p>The gradient shader was then updated to import these functions:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>#import bevy_ui_render::color_space::{
</span><span>    convert_to_linear_rgba,
</span><span>    mix_oklch,
</span><span>    mix_oklch_long,
</span><span>    mix_hsv,
</span><span>    mix_hsv_long,
</span><span>    mix_hsl,
</span><span>    mix_hsl_long,
</span><span>    oklch_to_linear_rgb,
</span><span>    hsv_to_linear_rgb,
</span><span>    hsl_to_linear_rgb,
</span><span>    oklab_to_linear_rgb,
</span><span>}
</span></code></pre><p>One important consideration was dependency management. The <code>GradientPlugin</code> now requires the <code>ColorSpacePlugin</code> to be added first, creating an explicit dependency relationship. The developer addressed this by ensuring <code>UiRenderPlugin</code> includes both plugins in the correct order, but noted this as a potential pain point for users who only import individual plugins.<p>The impact of this change is improved code organization and reusability. Other rendering features can now easily incorporate color space conversions by importing the color space plugin. The gradient code is more focused and maintainable, having been reduced from 307 lines to 60 lines in the gradient-specific file. Testing confirmed that the refactoring didn’t break existing gradient functionality, as demonstrated by the provided screenshot showing gradients working correctly.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[ColorSpacePlugin] --> B[UiRenderPlugin]
</span><span>    C[GradientPlugin] --> B
</span><span>    A --> C
</span><span>    D[Other Shaders] --> A
</span><span>    
</span><span>    style A fill:#e1f5fe
</span><span>    style C fill:#f3e5f5
</span><span>    style B fill:#e8f5e8
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ui-render-src-color-space-rs-11-0><code>crates/bevy_ui_render/src/color_space.rs</code> (+11/-0)</h3><p><strong>Purpose</strong>: Creates the new ColorSpacePlugin that loads the color space shader library.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>use </span><span>bevy_app</span><span style=color:#ed9366>::</span><span>{App</span><span style=color:#61676ccc>,</span><span> Plugin}</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>use </span><span>bevy_shader</span><span style=color:#ed9366>::</span><span>load_shader_library</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>/// A plugin for WGSL color space utility functions
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>ColorSpacePlugin</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>impl </span><span>Plugin </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>ColorSpacePlugin </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>build</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>app</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> App) {
</span><span>        </span><span style=color:#f07171>load_shader_library!</span><span>(app</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"color_space.wgsl"</span><span>)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><h3 id=crates-bevy-ui-render-src-color-space-wgsl-264-0><code>crates/bevy_ui_render/src/color_space.wgsl</code> (+264/-0)</h3><p><strong>Purpose</strong>: Contains all the extracted color space conversion and mixing functions.<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>#define_import_path bevy_ui_render::color_space
</span><span>#import bevy_render::maths::PI
</span><span>
</span><span>const TAU: f32 = 2. * PI;
</span><span>const HUE_GUARD: f32 = 0.0001;
</span><span>
</span><span>// https://en.wikipedia.org/wiki/SRGB
</span><span>fn gamma(value: f32) -> f32 {
</span><span>    if value <= 0.0 {
</span><span>        return value;
</span><span>    }
</span><span>    if value <= 0.04045 {
</span><span>        return value / 12.92; // linear falloff in dark values
</span><span>    } else {
</span><span>        return pow((value + 0.055) / 1.055, 2.4); // gamma curve in other area
</span><span>    }
</span><span>}
</span><span>
</span><span>// Additional color space functions...
</span></code></pre><h3 id=crates-bevy-ui-render-src-gradient-wgsl-60-307><code>crates/bevy_ui_render/src/gradient.wgsl</code> (+60/-307)</h3><p><strong>Purpose</strong>: Refactored gradient shader that now imports color space functions instead of defining them.<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before: 307 lines of embedded color space functions
</span><span>// After: Clean imports and gradient-specific logic only
</span><span>
</span><span>#import bevy_ui_render::color_space::{
</span><span>    convert_to_linear_rgba,
</span><span>    mix_oklch,
</span><span>    mix_oklch_long,
</span><span>    mix_hsv,
</span><span>    mix_hsv_long,
</span><span>    mix_hsl,
</span><span>    mix_hsl_long,
</span><span>    oklch_to_linear_rgb,
</span><span>    hsv_to_linear_rgb,
</span><span>    hsl_to_linear_rgb,
</span><span>    oklab_to_linear_rgb,
</span><span>}
</span><span>
</span><span>// Gradient-specific functions remain...
</span></code></pre><h3 id=crates-bevy-ui-render-src-lib-rs-4-0><code>crates/bevy_ui_render/src/lib.rs</code> (+4/-0)</h3><p><strong>Purpose</strong>: Integrates the new ColorSpacePlugin into the UI rendering system.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>use </span><span>color_space</span><span style=color:#ed9366>::</span><span>ColorSpacePlugin</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>impl </span><span>Plugin </span><span style=color:#fa6e32>for </span><span style=color:#399ee6>UiRenderPlugin </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>build</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>app</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> App) {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ... existing setup
</span><span>        
</span><span>        app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_plugins</span><span>(UiTextureSlicerPlugin)</span><span style=color:#61676ccc>;
</span><span>        app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_plugins</span><span>(ColorSpacePlugin)</span><span style=color:#61676ccc>;  </span><span style=color:#abb0b6;font-style:italic>// New plugin addition
</span><span>        app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_plugins</span><span>(GradientPlugin)</span><span style=color:#61676ccc>;
</span><span>        app</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_plugins</span><span>(BoxShadowPlugin)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/plugins/ target=_blank>Bevy Plugin System Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://www.w3.org/TR/WGSL/ target=_blank>WGSL Shader Language Specification</a><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Color_space target=_blank>Color Space Conversions in Computer Graphics</a><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/SRGB target=_blank>sRGB Color Space Specification</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-11/pr_21720.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>