<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21816 Prevent DoF effect disappearing at small `focus_distances`
        
    </title><meta content="#21816 Prevent DoF effect disappearing at small `focus_distances`" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-11/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-11-12</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-11/pr-21816-zh-cn-20251112>中文</a></div></div><div class=pr-content><h1 id=prevent-dof-effect-disappearing-at-small-focus-distances>Prevent DoF effect disappearing at small <code>focus_distances</code></h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Prevent DoF effect disappearing at small <code>focus_distances</code><li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21816<li><strong>Author</strong>: Breakdown-Dog<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, A-Rendering, S-Needs-Review<li><strong>Created</strong>: 2025-11-12T14:29:44Z<li><strong>Merged</strong>: 2025-11-12T19:54:36Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>In the <code>depth_of_field</code> example, setting <code>focal_distance</code> to a small value (<= 0.02) causes the DoF effect to disappear unexpectedly.</ul><img alt=before height=1129 src=https://github.com/user-attachments/assets/ea12016e-b9d5-4232-b8e0-b354efdecaae width=1936><ul><li><p>I believe that a small focal_distance makes <code>(focus - f)</code> zero or negative. This leads to a non-positive candidate_coc, which is then clamped to 0.0, effectively disabling the DoF effect.</p><li><p>Although the formula is physically accurate, we cannot assume users have a deep understanding of the depth of field effect. This will make them confused.</p></ul><h2 id=solution>Solution</h2><ul><li><p>Use <code>max(focus - f, EPSILON)</code> to ensure the denominator is always positive.</p><li><p>Now, the effect looks correct.</p></ul><img alt=later height=1135 src=https://github.com/user-attachments/assets/4462bc78-e5d1-4d74-a9c7-d69ed111b4c6 width=1938><h2 id=testing>Testing</h2><ul><li>CI</ul><hr><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a subtle but important issue in Bevy’s Depth of Field (DoF) post-processing effect where the blur effect would unexpectedly disappear when users set very small focal distance values. The problem was rooted in the mathematical precision of the circle of confusion calculation within the shader code.<p>The core issue occurred in the DoF shader’s <code>calculate_circle_of_confusion</code> function. When users set a focal distance of 0.02 or smaller, the term <code>(focus - f)</code> in the denominator could become zero or negative due to floating-point precision limitations. This caused the calculated <code>candidate_coc</code> value to become non-positive, which was then clamped to 0.0 by the subsequent <code>clamp()</code> call, effectively disabling the Depth of Field effect entirely.<p>The developer took a practical approach to solve this problem. Instead of requiring users to understand the complex physics behind depth of field calculations, they introduced a small epsilon value to ensure numerical stability. The solution adds a constant <code>EPSILON</code> set to <code>1.19209290e-07</code> (which is the machine epsilon for 32-bit floating point numbers) and modifies the denominator calculation to use <code>max(focus - f, EPSILON)</code>. This guarantees that the denominator remains positive even when <code>focus - f</code> approaches zero, preventing the circle of confusion from being clamped to zero.<p>The implementation demonstrates good software engineering practices. The epsilon value is defined as a named constant with a clear comment explaining its purpose: “used to ensure <code>depth * (focus - f)</code> is always a positive number”. This makes the code more maintainable and the intent obvious to future developers.<p>An additional minor but thoughtful change was made to the example code - increasing the decimal precision of the aperture F-stop display from two to three decimal places. This improvement helps users better visualize and control the aperture settings when working with very small values.<p>The fix is mathematically sound and preserves the physical accuracy of the DoF effect while making it more robust against edge cases. By preventing the denominator from reaching zero or negative values, the shader maintains consistent behavior across the entire range of user-configurable parameters.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[User sets small focal_distance] --> B[focus - f becomes <= 0]
</span><span>    B --> C[candidate_coc becomes non-positive]
</span><span>    C --> D[clamp() sets CoC to 0.0]
</span><span>    D --> E[DoF effect disappears]
</span><span>    
</span><span>    F[Fix: Add EPSILON constant] --> G[Use max(focus - f, EPSILON)]
</span><span>    G --> H[Denominator always positive]
</span><span>    H --> I[CoC calculation stable]
</span><span>    I --> J[DoF effect preserved]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-post-process-src-dof-dof-wgsl><code>crates/bevy_post_process/src/dof/dof.wgsl</code></h3><p>This is the core shader file where the Depth of Field effect is implemented. The changes ensure numerical stability in the circle of confusion calculation.<p><strong>Key modifications:</strong><pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Before:
</span><span>let candidate_coc = scale * abs(depth - focus) / (depth * (focus - f));
</span><span>
</span><span>// After:
</span><span>const EPSILON: f32 = 1.19209290e-07;
</span><span>let candidate_coc = scale * abs(depth - focus) / (depth * max(focus - f, EPSILON));
</span></code></pre><p>The addition of the <code>EPSILON</code> constant and the use of <code>max()</code> function prevent division by zero or negative values, which was causing the DoF effect to disappear at small focal distances.<h3 id=examples-3d-depth-of-field-rs><code>examples/3d/depth_of_field.rs</code></h3><p>This example file demonstrates the Depth of Field effect. The change improves the display precision of aperture values.<p><strong>Key modification:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#86b300>"Aperture F-stops: f/{:.2} (Press Left/Right to change)"
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:  
</span><span style=color:#86b300>"Aperture F-stops: f/{:.3} (Press Left/Right to change)"
</span></code></pre><p>This minor change from <code>{:.2}</code> to <code>{:.3}</code> formatting provides better visual feedback when users adjust aperture settings with small values.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Circle_of_confusion target=_blank>Circle of Confusion in Computer Graphics</a><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Machine_epsilon target=_blank>Floating Point Precision and Machine Epsilon</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/books/introduction/features/post-processing/ target=_blank>Bevy Post-Processing Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Depth_of_field target=_blank>Depth of Field Physics</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-11/pr_21816.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>