<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21853 fix: return current hit for DragDrop event
        
    </title><meta content="#21853 fix: return current hit for DragDrop event" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-11/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-11-25</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-11/pr-21853-zh-cn-20251125>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>fix: return current hit for DragDrop event<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: fix: return current hit for DragDrop event<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21853<li><strong>Author</strong>: moe-moe-pupil<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, D-Straightforward, S-Needs-Review, A-Picking<li><strong>Created</strong>: 2025-11-15T23:29:28Z<li><strong>Merged</strong>: 2025-11-25T02:26:39Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>previously, the hit field in DragDrop event is the clone of the DragEnter one.<li>Fixes #21849.</ul><h2 id=solution>Solution</h2><ul><li>Describe the solution used to achieve the objective above. <ul><li>use the hit from hover_map rather than the hit in state.dragging_over</ul></ul><h2 id=testing>Testing</h2><ul><li>Did you test these changes? If so, how? <ul><li>yes, tested this simple demo and examples/picking/debug_picking.rs and ui_drag_and_drop.rs on my mac.</ul><li>Are there any parts that need more testing? <ul><li>no, i think it’s enough.</ul><li>How can other people (reviewers) test your changes? Is there anything specific they need to know? <ul><li>i pasted the code for testing at the bottom</ul><li>If relevant, what platforms did you test these changes on, and are there any important ones you can’t test? <ul><li>mac, but it doesnt matter</ul></ul><hr><h2 id=showcase>Showcase</h2><p>https://github.com/user-attachments/assets/ff35a03d-00a0-41b8-952f-3f2e77530d5a<p>https://github.com/user-attachments/assets/a7aa5172-f89c-4010-a153-b90171621204<details><summary>Click to view showcase</summary> <pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>use </span><span>bevy</span><span style=color:#ed9366>::</span><span>{
</span><span>    prelude</span><span style=color:#ed9366>::*</span><span style=color:#61676ccc>,
</span><span>    window</span><span style=color:#ed9366>::</span><span>WindowMode</span><span style=color:#61676ccc>,
</span><span>}</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component)]
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>Area</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component)]
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>ExampleButton</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component)]
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>GhostElement</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Component)]
</span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>Element</span><span style=color:#61676ccc>;
</span><span>
</span><span>
</span><span style=color:#fa6e32>const </span><span style=color:#ff8f40>AREA_SIZE</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32 </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>500.0</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>const </span><span style=color:#ff8f40>BUTTON_SIZE</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>i32 </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>50</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>const </span><span style=color:#ff8f40>ELEMENT_SIZE</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>f32 </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>25.0</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>bevy_main</span><span>]
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>main</span><span>() </span><span style=color:#61676ccc>-></span><span> AppExit {
</span><span>    App</span><span style=color:#ed9366>::</span><span>new()
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>add_plugins</span><span>((
</span><span>            DefaultPlugins
</span><span>                </span><span style=color:#ed9366>.</span><span style=color:#f07171>set</span><span>(WindowPlugin {
</span><span>                    primary_window</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(Window {
</span><span>                        mode</span><span style=color:#61676ccc>: </span><span>WindowMode</span><span style=color:#ed9366>::</span><span>BorderlessFullscreen(MonitorSelection</span><span style=color:#ed9366>::</span><span>Primary)</span><span style=color:#61676ccc>,
</span><span>                        </span><span style=color:#ed9366>..</span><span style=color:#f07171>default</span><span>()
</span><span>                    })</span><span style=color:#61676ccc>,
</span><span>                    </span><span style=color:#ed9366>..</span><span style=color:#f07171>default</span><span>()
</span><span>                })</span><span style=color:#61676ccc>,
</span><span>            MeshPickingPlugin</span><span style=color:#61676ccc>,
</span><span>        ))
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>add_systems</span><span>(Startup</span><span style=color:#61676ccc>,</span><span> setup)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>run</span><span>()
</span><span>}
</span><span>
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>setup</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>meshes</span><span style=color:#61676ccc>: </span><span>ResMut&LTAssets&LTMesh>>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>materials</span><span style=color:#61676ccc>: </span><span>ResMut&LTAssets&LTColorMaterial>>,
</span><span>) {
</span><span>    commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>(Camera2d)</span><span style=color:#61676ccc>;
</span><span>
</span><span>    commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((
</span><span>        Node {
</span><span>            width</span><span style=color:#61676ccc>: </span><span style=color:#f07171>percent</span><span>(</span><span style=color:#ff8f40>100</span><span>)</span><span style=color:#61676ccc>,
</span><span>            height</span><span style=color:#61676ccc>: </span><span style=color:#f07171>percent</span><span>(</span><span style=color:#ff8f40>100</span><span>)</span><span style=color:#61676ccc>,
</span><span>            align_items</span><span style=color:#61676ccc>: </span><span>AlignItems</span><span style=color:#ed9366>::</span><span>Center</span><span style=color:#61676ccc>,
</span><span>            justify_content</span><span style=color:#61676ccc>: </span><span>JustifyContent</span><span style=color:#ed9366>::</span><span>Start</span><span style=color:#61676ccc>,
</span><span>            </span><span style=color:#ed9366>..</span><span style=color:#f07171>default</span><span>()
</span><span>        }</span><span style=color:#61676ccc>,
</span><span>        Pickable</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>IGNORE</span><span style=color:#61676ccc>,
</span><span>    ))
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>with_children</span><span>(|</span><span style=color:#ff8f40>parent</span><span>| {
</span><span>            parent</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((
</span><span>                ExampleButton</span><span style=color:#61676ccc>,
</span><span>                Button</span><span style=color:#61676ccc>,
</span><span>                Node {
</span><span>                    width</span><span style=color:#61676ccc>: </span><span style=color:#f07171>px</span><span>(</span><span style=color:#ff8f40>BUTTON_SIZE</span><span>)</span><span style=color:#61676ccc>,
</span><span>                    height</span><span style=color:#61676ccc>: </span><span style=color:#f07171>px</span><span>(</span><span style=color:#ff8f40>BUTTON_SIZE</span><span>)</span><span style=color:#61676ccc>,
</span><span>                    margin</span><span style=color:#61676ccc>: </span><span>UiRect</span><span style=color:#ed9366>::</span><span>all(</span><span style=color:#f07171>px</span><span>(</span><span style=color:#ff8f40>10</span><span>))</span><span style=color:#61676ccc>,
</span><span>                    border_radius</span><span style=color:#61676ccc>: </span><span>BorderRadius</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>MAX</span><span style=color:#61676ccc>,
</span><span>                    </span><span style=color:#ed9366>..</span><span style=color:#f07171>default</span><span>()
</span><span>                }</span><span style=color:#61676ccc>,
</span><span>                BackgroundColor(Color</span><span style=color:#ed9366>::</span><span>srgb(</span><span style=color:#ff8f40>1.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.0</span><span>))</span><span style=color:#61676ccc>,
</span><span>            ))
</span><span>                </span><span style=color:#ed9366>.</span><span style=color:#f07171>observe</span><span>(|</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>event</span><span style=color:#61676ccc>: </span><span>On&LTPointer&LTDragStart>></span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>button_color</span><span style=color:#61676ccc>: </span><span>Single<</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> BackgroundColor, With&LTExampleButton>>| {
</span><span>                    button_color</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0 </span><span style=color:#ed9366>= </span><span>Color</span><span style=color:#ed9366>::</span><span>srgb(</span><span style=color:#ff8f40>1.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.5</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.0</span><span>)</span><span style=color:#61676ccc>;
</span><span>                    event</span><span style=color:#ed9366>.</span><span style=color:#f07171>propagate</span><span>(</span><span style=color:#ff8f40>false</span><span>)</span><span style=color:#61676ccc>;
</span><span>                })
</span><span>                </span><span style=color:#ed9366>.</span><span style=color:#f07171>observe</span><span>(|</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>event</span><span style=color:#61676ccc>: </span><span>On&LTPointer&LTDragEnd>></span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>button_color</span><span style=color:#61676ccc>: </span><span>Single<</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> BackgroundColor, With&LTExampleButton>>| {
</span><span>                    button_color</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0 </span><span style=color:#ed9366>= </span><span>Color</span><span style=color:#ed9366>::</span><span>srgb(</span><span style=color:#ff8f40>1.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.0</span><span>)</span><span style=color:#61676ccc>;
</span><span>                    event</span><span style=color:#ed9366>.</span><span style=color:#f07171>propagate</span><span>(</span><span style=color:#ff8f40>false</span><span>)</span><span style=color:#61676ccc>;
</span><span>                })</span><span style=color:#61676ccc>;
</span><span>        })</span><span style=color:#61676ccc>;
</span><span>
</span><span>
</span><span>    commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((
</span><span>        Area</span><span style=color:#61676ccc>,
</span><span>        Mesh2d(meshes</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(Rectangle</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ff8f40>AREA_SIZE</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>AREA_SIZE</span><span>)))</span><span style=color:#61676ccc>,
</span><span>        MeshMaterial2d(materials</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(Color</span><span style=color:#ed9366>::</span><span>srgb(</span><span style=color:#ff8f40>0.1</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.4</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.1</span><span>)))</span><span style=color:#61676ccc>,
</span><span>        Transform</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>IDENTITY</span><span style=color:#61676ccc>,
</span><span>    ))
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>observe</span><span>(on_enter)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>observe</span><span>(on_over)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>observe</span><span>(on_drop)
</span><span>        </span><span style=color:#ed9366>.</span><span style=color:#f07171>observe</span><span>(on_leave)</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span>
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>on_enter</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>event</span><span style=color:#61676ccc>: </span><span>On&LTPointer&LTDragEnter>>,
</span><span>    </span><span style=color:#ff8f40>button</span><span style=color:#61676ccc>: </span><span>Single&LTEntity, With&LTExampleButton>>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>meshes</span><span style=color:#61676ccc>: </span><span>ResMut&LTAssets&LTMesh>>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>materials</span><span style=color:#61676ccc>: </span><span>ResMut&LTAssets&LTColorMaterial>>,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>if</span><span> event</span><span style=color:#ed9366>.</span><span>dragged </span><span style=color:#ed9366>== *</span><span>button {
</span><span>        </span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(position) </span><span style=color:#ed9366>=</span><span> event</span><span style=color:#ed9366>.</span><span>hit</span><span style=color:#ed9366>.</span><span>position </span><span style=color:#fa6e32>else </span><span>{ </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>; </span><span>}</span><span style=color:#61676ccc>;
</span><span>        commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((
</span><span>            GhostElement</span><span style=color:#61676ccc>,
</span><span>            Mesh2d(meshes</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(Circle</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ff8f40>ELEMENT_SIZE</span><span>)))</span><span style=color:#61676ccc>,
</span><span>            MeshMaterial2d(materials</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(Color</span><span style=color:#ed9366>::</span><span>srgba(</span><span style=color:#ff8f40>1.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>1.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.6</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.5</span><span>)))</span><span style=color:#61676ccc>,
</span><span>            Transform</span><span style=color:#ed9366>::</span><span>from_translation(position)</span><span style=color:#61676ccc>,
</span><span>            Pickable</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>IGNORE</span><span style=color:#61676ccc>,
</span><span>        ))</span><span style=color:#61676ccc>;
</span><span>        event</span><span style=color:#ed9366>.</span><span style=color:#f07171>propagate</span><span>(</span><span style=color:#ff8f40>false</span><span>)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span><span>
</span><span>
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>on_over</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>event</span><span style=color:#61676ccc>: </span><span>On&LTPointer&LTDragOver>>,
</span><span>    </span><span style=color:#ff8f40>button</span><span style=color:#61676ccc>: </span><span>Single&LTEntity, With&LTExampleButton>>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>ghost_element_transform</span><span style=color:#61676ccc>: </span><span>Single<</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> Transform, With&LTGhostElement>>,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>if</span><span> event</span><span style=color:#ed9366>.</span><span>dragged </span><span style=color:#ed9366>== *</span><span>button {
</span><span>        </span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(position) </span><span style=color:#ed9366>=</span><span> event</span><span style=color:#ed9366>.</span><span>hit</span><span style=color:#ed9366>.</span><span>position </span><span style=color:#fa6e32>else </span><span>{ </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>; </span><span>}</span><span style=color:#61676ccc>;
</span><span>        ghost_element_transform</span><span style=color:#ed9366>.</span><span>translation </span><span style=color:#ed9366>=</span><span> position</span><span style=color:#61676ccc>;
</span><span>        event</span><span style=color:#ed9366>.</span><span style=color:#f07171>propagate</span><span>(</span><span style=color:#ff8f40>false</span><span>)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span><span>
</span><span> </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>on_drop</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>event</span><span style=color:#61676ccc>: </span><span>On&LTPointer&LTDragDrop>>,
</span><span>    </span><span style=color:#ff8f40>button</span><span style=color:#61676ccc>: </span><span>Single&LTEntity, With&LTExampleButton>>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands,
</span><span>    </span><span style=color:#ff8f40>ghost_element</span><span style=color:#61676ccc>: </span><span>Single&LTEntity, With&LTGhostElement>>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>meshes</span><span style=color:#61676ccc>: </span><span>ResMut&LTAssets&LTMesh>>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>materials</span><span style=color:#61676ccc>: </span><span>ResMut&LTAssets&LTColorMaterial>>,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>if</span><span> event</span><span style=color:#ed9366>.</span><span>dropped </span><span style=color:#ed9366>== *</span><span>button {
</span><span>        </span><span style=color:#f07171>println!</span><span>(</span><span style=color:#86b300>"</span><span style=color:#ff8f40>{:?}</span><span style=color:#86b300>"</span><span style=color:#61676ccc>,</span><span> event)</span><span style=color:#61676ccc>;
</span><span>        commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(</span><span style=color:#ed9366>*</span><span>ghost_element)</span><span style=color:#ed9366>.</span><span style=color:#f07171>despawn</span><span>()</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(position) </span><span style=color:#ed9366>=</span><span> event</span><span style=color:#ed9366>.</span><span>hit</span><span style=color:#ed9366>.</span><span>position </span><span style=color:#fa6e32>else </span><span>{ </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>; </span><span>}</span><span style=color:#61676ccc>;
</span><span>        commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((
</span><span>            Element</span><span style=color:#61676ccc>,
</span><span>            Mesh2d(meshes</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(Circle</span><span style=color:#ed9366>::</span><span>new(</span><span style=color:#ff8f40>ELEMENT_SIZE</span><span>)))</span><span style=color:#61676ccc>,
</span><span>            MeshMaterial2d(materials</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(Color</span><span style=color:#ed9366>::</span><span>srgb(</span><span style=color:#ff8f40>1.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>1.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.6</span><span>)))</span><span style=color:#61676ccc>,
</span><span>            Transform</span><span style=color:#ed9366>::</span><span>from_translation(position)</span><span style=color:#61676ccc>,
</span><span>            Pickable</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>IGNORE</span><span style=color:#61676ccc>,
</span><span>        ))</span><span style=color:#61676ccc>;
</span><span>        event</span><span style=color:#ed9366>.</span><span style=color:#f07171>propagate</span><span>(</span><span style=color:#ff8f40>false</span><span>)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>on_leave</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>event</span><span style=color:#61676ccc>: </span><span>On&LTPointer&LTDragLeave>>,
</span><span>    </span><span style=color:#ff8f40>button</span><span style=color:#61676ccc>: </span><span>Single&LTEntity, With&LTExampleButton>>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands,
</span><span>    </span><span style=color:#ff8f40>ghost_element</span><span style=color:#61676ccc>: </span><span>Single&LTEntity, With&LTGhostElement>>,
</span><span>) {
</span><span>    </span><span style=color:#fa6e32>if</span><span> event</span><span style=color:#ed9366>.</span><span>dragged </span><span style=color:#ed9366>== *</span><span>button {
</span><span>        commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>entity</span><span>(</span><span style=color:#ed9366>*</span><span>ghost_element)</span><span style=color:#ed9366>.</span><span style=color:#f07171>despawn</span><span>()</span><span style=color:#61676ccc>;
</span><span>        event</span><span style=color:#ed9366>.</span><span style=color:#f07171>propagate</span><span>(</span><span style=color:#ff8f40>false</span><span>)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre></details><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This pull request addresses a subtle but important bug in Bevy’s drag-and-drop system. The issue was in how the <code>DragDrop</code> event handled hit position data - it was incorrectly using stale position information from when the drag operation first entered the target, rather than the current position when the drop actually occurred.<p>The problem manifested in drag-and-drop operations where developers needed precise positioning for dropped elements. When a user dragged an item over a drop target and then moved the cursor within that target before releasing, the drop position would be calculated based on the initial entry point rather than the final position. This created a jarring user experience where dropped items would appear in unexpected locations.<p>The root cause was in the event handling logic within the <code>pointer_events</code> system. When processing drag operations, the system maintained a <code>dragging_over</code> state that tracked which entities were being dragged over. However, this state wasn’t being updated with current hit position data during drag movement - it only contained the initial hit data from when the drag first entered each target.<p>The solution was straightforward but crucial: during the <code>DragOver</code> event processing, the system now updates the stored hit data in the <code>dragging_over</code> state with the current hit information from the <code>hover_map</code>. This ensures that when a <code>DragDrop</code> event is eventually fired, it contains the most recent and accurate position data.<p>Here’s the key change in context:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// In the DragOver event handling section
</span><span style=color:#fa6e32>for </span><span>(hovered_entity</span><span style=color:#61676ccc>,</span><span> hit) </span><span style=color:#ed9366>in</span><span> hover_map
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>()
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>flat_map</span><span>(|</span><span style=color:#ff8f40>h</span><span>| h</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>map</span><span>(|(</span><span style=color:#ff8f40>entity</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>data</span><span>)| (</span><span style=color:#ed9366>*</span><span>entity</span><span style=color:#61676ccc>,</span><span> data</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_owned</span><span>())))
</span><span>    </span><span style=color:#ed9366>.</span><span style=color:#f07171>filter</span><span>(|(</span><span style=color:#ff8f40>hovered_entity</span><span style=color:#61676ccc>,</span><span> _)| </span><span style=color:#ed9366>*</span><span>hovered_entity </span><span style=color:#ed9366>!= *</span><span>drag_target)
</span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// This line was added to fix the bug:
</span><span>    </span><span style=color:#ed9366>*</span><span>state</span><span style=color:#ed9366>.</span><span>dragging_over</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_mut</span><span>(</span><span style=color:#ed9366>&</span><span>hovered_entity)</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>() </span><span style=color:#ed9366>=</span><span> hit</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#fa6e32>let</span><span> drag_over_event </span><span style=color:#ed9366>= </span><span>Pointer</span><span style=color:#ed9366>::</span><span>new(
</span><span>        pointer_id</span><span style=color:#61676ccc>,
</span><span>        location</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#61676ccc>,
</span><span>        hit</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#61676ccc>,
</span><span>        PointerButton</span><span style=color:#ed9366>::</span><span>Primary</span><span style=color:#61676ccc>,
</span><span>        PointerEvent</span><span style=color:#ed9366>::</span><span>DragOver {
</span><span>            dragger</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>*</span><span>drag_target</span><span style=color:#61676ccc>,
</span><span>        }</span><span style=color:#61676ccc>,
</span><span>    )</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... rest of event processing
</span><span>}
</span></code></pre><p>This single-line change ensures that the hit data stored in <code>state.dragging_over</code> is continuously updated during drag operations, making the final <code>DragDrop</code> event reflect the actual drop position rather than the initial entry position.<p>The fix is particularly elegant because it doesn’t require changing the overall architecture or adding complex new systems. It simply ensures that existing state tracking is kept current throughout the drag operation. This approach minimizes the risk of introducing new bugs while solving the core positioning issue.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Pointer Movement] --> B[Hover Map Updates]
</span><span>    B --> C[DragOver Event Processing]
</span><span>    C --> D[Update dragging_over state]
</span><span>    D --> E[Store current hit data]
</span><span>    E --> F[DragDrop Event Fired]
</span><span>    F --> G[Use updated hit data]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><ul><li><code>crates/bevy_picking/src/events.rs</code> (+1/-0)</ul><p>This file contains the core event handling logic for pointer interactions in Bevy’s picking system. The change adds a single line that updates the <code>dragging_over</code> state with current hit data during drag operations.<p><strong>Key Modification:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before: The dragging_over state retained initial hit data from DragEnter
</span><span style=color:#abb0b6;font-style:italic>// After: The dragging_over state is updated with current hit data during DragOver
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Added line in the DragOver event handling loop:
</span><span style=color:#ed9366>*</span><span>state</span><span style=color:#ed9366>.</span><span>dragging_over</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_mut</span><span>(</span><span style=color:#ed9366>&</span><span>hovered_entity)</span><span style=color:#ed9366>.</span><span style=color:#f07171>unwrap</span><span>() </span><span style=color:#ed9366>=</span><span> hit</span><span style=color:#ed9366>.</span><span style=color:#f07171>clone</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><p>This change ensures that when a <code>DragDrop</code> event is later processed, it uses the most recent hit position data rather than the initial position from when the drag operation first entered the target.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_picking/latest/bevy_picking/ target=_blank>Bevy Picking Documentation</a> - Official documentation for Bevy’s picking system<li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/programming/events.html target=_blank>Drag and Drop Events in Bevy</a> - General information about event handling in Bevy<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/issues/21849 target=_blank>Issue #21849</a> - The original bug report that this PR fixes</ul><h1 id=full-code-diff>Full Code Diff</h1><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_picking/src/events.rs b/crates/bevy_picking/src/events.rs
</span><span>index 1e3ec18f38851..6e25bd235c891 100644
</span><span style=color:#c594c5>--- a/crates/bevy_picking/src/events.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_picking/src/events.rs
</span><span style=color:#c594c5>@@ -766,6 +766,7 @@ </span><span style=color:#399ee6>pub fn pointer_events(
</span><span>                             .flat_map(|h| h.iter().map(|(entity, data)| (*entity, data.to_owned())))
</span><span>                             .filter(|(hovered_entity, _)| *hovered_entity != *drag_target)
</span><span>                         {
</span><span style=color:#86b300>+                            *state.dragging_over.get_mut(&hovered_entity).unwrap() = hit.clone();
</span><span>                             let drag_over_event = Pointer::new(
</span><span>                                 pointer_id,
</span><span>                                 location.clone(),
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-11/pr_21853.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>