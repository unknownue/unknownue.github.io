<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21823 Improve `ThinSlicePtr` API
        
    </title><meta content="#21823 Improve `ThinSlicePtr` API" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-11/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-11-28</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-11/pr-21823-zh-cn-20251128>中文</a></div></div><div class=pr-content><h1 id=improve-thinsliceptr-api>Improve <code>ThinSlicePtr</code> API</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Improve <code>ThinSlicePtr</code> API<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21823<li><strong>Author</strong>: BD103<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Docs, C-Code-Quality, S-Ready-For-Final-Review, M-Migration-Guide, A-Pointers, D-Straightforward, D-Unsafe<li><strong>Created</strong>: 2025-11-13T02:10:27Z<li><strong>Merged</strong>: 2025-11-28T08:30:42Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Although unsafe, <code>ThinSlicePtr::get()</code> doesn’t signal that it doesn’t perform bounds checking unless you are familiar with the API.<li><code>ThinSlicePtr::get()</code> takes <code>self</code>, not <code>&self</code>, meaning it consumes the <code>ThinSlicePtr</code> each time <code>get()</code> is called. This does not match the behavior of <a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/stable/std/primitive.slice.html#method.get target=_blank><code>slice.get()</code></a>, which takes <code>&self</code>. <ul><li>This small issue was hidden by the fact that <code>ThinSlicePtr</code> implements <code>Copy</code>. This isn’t a large issue because it all compiles down to the same machine code, but there’s no point to <code>get()</code> requiring <code>self</code>.</ul><li><code>ThinSlicePtr</code> could use better documentation, and could be improved a little in some areas.</ul><h2 id=solution>Solution</h2><ul><li>Rename <code>ThinSlicePtr::get()</code> to <code>get_unchecked()</code>, making the API mirror <a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/stable/std/primitive.slice.html#method.get_unchecked target=_blank><code>slice.get_unchecked()</code></a>. The old <code>get()</code> is kept as a deprecated method, to be removed in 1.19.0.<li>Make the new <code>slice.get_unchecked()</code> take <code>&self</code> rather than <code>self</code>.<li>Add more documentation and slightly re-arrange code, while maintaining original behavior.</ul><h2 id=testing>Testing</h2><ul><li>Any unintentional changes should be caught by the Rust Compiler and Miri!</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The <code>ThinSlicePtr</code> type in Bevy is a performance-optimized slice representation that strips out length information in release builds to reduce memory overhead. This optimization comes with a safety trade-off: without bounds checking, developers must ensure they don’t access out-of-bounds elements. The original API design had two main issues that this PR addresses.<p>First, the method <code>ThinSlicePtr::get()</code> was unsafe but didn’t clearly signal this in its name. Unlike Rust’s standard library which uses <code>get_unchecked()</code> for unsafe slice access, Bevy’s method was simply called <code>get()</code>. This created a potential footgun where developers might assume bounds checking was happening when it wasn’t.<p>Second, the method signature took <code>self</code> rather than <code>&self</code>, which was inconsistent with standard Rust slice APIs. While <code>ThinSlicePtr</code> implements <code>Copy</code>, making this mostly a compile-time concern, it created unnecessary API divergence from familiar patterns.<p>The solution implemented a straightforward refactor: rename <code>get()</code> to <code>get_unchecked()</code> and change the parameter from <code>self</code> to <code>&self</code>. This aligns the API with Rust conventions while maintaining the same performance characteristics. The old method was kept as deprecated to provide a migration path.<p>The implementation required updates across the Bevy codebase where <code>ThinSlicePtr::get()</code> was used. In the ECS system, multiple query implementations were updated to use the new <code>get_unchecked()</code> method. These changes are in performance-critical paths where the bounds checking is already handled by higher-level logic, making the unsafe access appropriate.<p>The PR also significantly improved documentation for <code>ThinSlicePtr</code>, adding comprehensive examples and safety explanations. The new documentation clarifies that the type only performs bounds checking in debug builds, and that callers are responsible for ensuring index validity in release builds.<p>From an engineering perspective, this change demonstrates good API design principles: consistency with established conventions, clear signaling of unsafe operations, and maintaining backward compatibility through deprecation cycles. The changes are minimal but impactful, improving both code safety and developer experience.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[ThinSlicePtr] --> B[get_unchecked]
</span><span>    A --> C[get (deprecated)]
</span><span>    B --> D[&self parameter]
</span><span>    C --> E[self parameter]
</span><span>    D --> F[Unsafe access]
</span><span>    E --> F
</span><span>    F --> G[Performance optimized]
</span><span>    G --> H[No bounds checking in release]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ptr-src-lib-rs-48-11><code>crates/bevy_ptr/src/lib.rs</code> (+48/-11)</h3><p>This file contains the core implementation changes for <code>ThinSlicePtr</code>. The modifications improve API clarity and documentation while maintaining the same unsafe access behavior.<p><strong>Key changes:</strong><ul><li>Added comprehensive documentation with examples<li>Renamed <code>get()</code> to <code>get_unchecked()</code><li>Changed parameter from <code>self</code> to <code>&self</code><li>Added deprecated <code>get()</code> method for backward compatibility<li>Improved code organization and safety comments</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub unsafe fn </span><span style=color:#f29718>get</span><span>(</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>index</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'a</span><span> T {
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(debug_assertions)]
</span><span>    </span><span style=color:#f07171>debug_assert!</span><span>(index </span><span style=color:#ed9366>< </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>len)</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#fa6e32>let</span><span> ptr </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>ptr</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_ptr</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>unsafe </span><span>{ </span><span style=color:#ed9366>&*</span><span>ptr</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(index) }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub unsafe fn </span><span style=color:#f29718>get_unchecked</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>index</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'a</span><span> T {
</span><span>    </span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>cfg</span><span>(debug_assertions)]
</span><span>    </span><span style=color:#f07171>assert!</span><span>(index </span><span style=color:#ed9366>< </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>len</span><span style=color:#61676ccc>, </span><span style=color:#86b300>"tried to index out-of-bounds of a slice"</span><span>)</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#fa6e32>unsafe </span><span>{ </span><span style=color:#ed9366>&*</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>ptr</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(index)</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_ptr</span><span>() }
</span><span>}
</span><span>
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>deprecated</span><span>(since </span><span style=color:#ed9366>= </span><span style=color:#86b300>"0.18.0"</span><span style=color:#61676ccc>,</span><span> note </span><span style=color:#ed9366>= </span><span style=color:#86b300>"use get_unchecked() instead"</span><span>)]
</span><span style=color:#fa6e32>pub unsafe fn </span><span style=color:#f29718>get</span><span>(</span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>index</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>'a</span><span> T {
</span><span>    </span><span style=color:#fa6e32>unsafe </span><span>{ </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>get_unchecked</span><span>(index) }
</span><span>}
</span></code></pre><h3 id=release-content-migration-guides-thin-slice-ptr-get-unchecked-md-21-0><code>release-content/migration-guides/thin_slice_ptr_get_unchecked.md</code> (+21/-0)</h3><p>This new file provides migration guidance for the API change, explaining how to update code from the old <code>get()</code> method to the new <code>get_unchecked()</code>.<pre class=language-markdown data-lang=markdown style=color:#61676c;background-color:#fafafa><code class=language-markdown data-lang=markdown><span style=color:#abb0b6;background-color:#61676c10;font-weight:700>---
</span><span>title: Rename </span><span style=color:#ed9366;background-color:#61676c10>`ThinSlicePtr::get()`</span><span> to </span><span style=color:#ed9366;background-color:#61676c10>`ThinSlicePtr::get_unchecked()`</span><span>
</span><span>pull_requests: [21823]
</span><span style=color:#fa6e32;font-weight:700>---
</span><span>
</span><span style=color:#ed9366;background-color:#61676c10>`ThinSlicePtr::get()`</span><span> has been deprecated in favor of the new </span><span style=color:#ed9366;background-color:#61676c10>`ThinSlicePtr::get_unchecked()`</span><span>
</span><span>method in order to more clearly signal that bounds checking is not performed. Beyond the name
</span><span>change, the only difference between these two methods is that </span><span style=color:#ed9366;background-color:#61676c10>`get_unchecked()`</span><span> takes </span><span style=color:#ed9366;background-color:#61676c10>`&self`</span><span> while
</span><span style=color:#ed9366;background-color:#61676c10>`get()`</span><span> takes </span><span style=color:#ed9366;background-color:#61676c10>`self`</span><span>. In order to migrate, simply rename all usages of </span><span style=color:#ed9366;background-color:#61676c10>`get()`</span><span> with
</span><span style=color:#ed9366;background-color:#61676c10>`get_unchecked()`</span><span>:
</span><span>
</span><span>```</span><span style=color:#ff8f40>rust
</span><span style=color:#fa6e32;background-color:#61676c07>let</span><span style=color:#61676c;background-color:#61676c07> slice</span><span style=color:#61676ccc;background-color:#61676c07>: </span><span style=color:#ed9366;background-color:#61676c07>&</span><span style=color:#61676c;background-color:#61676c07>[</span><span style=color:#fa6e32;background-color:#61676c07>u32</span><span style=color:#61676c;background-color:#61676c07>] </span><span style=color:#ed9366;background-color:#61676c07>= &</span><span style=color:#61676c;background-color:#61676c07>[</span><span style=color:#ff8f40;background-color:#61676c07>2</span><span style=color:#61676ccc;background-color:#61676c07>, </span><span style=color:#ff8f40;background-color:#61676c07>4</span><span style=color:#61676ccc;background-color:#61676c07>, </span><span style=color:#ff8f40;background-color:#61676c07>8</span><span style=color:#61676c;background-color:#61676c07>]</span><span style=color:#61676ccc;background-color:#61676c07>;
</span><span style=color:#fa6e32;background-color:#61676c07>let</span><span style=color:#61676c;background-color:#61676c07> thin_slice </span><span style=color:#ed9366;background-color:#61676c07>= </span><span style=color:#61676c;background-color:#61676c07>ThinSlicePtr</span><span style=color:#ed9366;background-color:#61676c07>::</span><span style=color:#61676c;background-color:#61676c07>from(slice)</span><span style=color:#61676ccc;background-color:#61676c07>;
</span><span style=color:#61676c;background-color:#61676c07>
</span><span style=color:#abb0b6;background-color:#61676c07;font-style:italic>// 0.17
</span><span style=color:#fa6e32;background-color:#61676c07>let</span><span style=color:#61676c;background-color:#61676c07> x </span><span style=color:#ed9366;background-color:#61676c07>= </span><span style=color:#fa6e32;background-color:#61676c07>unsafe </span><span style=color:#61676c;background-color:#61676c07>{ thin_slice</span><span style=color:#ed9366;background-color:#61676c07>.</span><span style=color:#f07171;background-color:#61676c07>get</span><span style=color:#61676c;background-color:#61676c07>(</span><span style=color:#ff8f40;background-color:#61676c07>0</span><span style=color:#61676c;background-color:#61676c07>) }</span><span style=color:#61676ccc;background-color:#61676c07>;
</span><span style=color:#61676c;background-color:#61676c07>
</span><span style=color:#abb0b6;background-color:#61676c07;font-style:italic>// 0.18
</span><span style=color:#fa6e32;background-color:#61676c07>let</span><span style=color:#61676c;background-color:#61676c07> x </span><span style=color:#ed9366;background-color:#61676c07>= </span><span style=color:#fa6e32;background-color:#61676c07>unsafe </span><span style=color:#61676c;background-color:#61676c07>{ thin_slice</span><span style=color:#ed9366;background-color:#61676c07>.</span><span style=color:#f07171;background-color:#61676c07>get_unchecked</span><span style=color:#61676c;background-color:#61676c07>(</span><span style=color:#ff8f40;background-color:#61676c07>0</span><span style=color:#61676c;background-color:#61676c07>) }</span><span style=color:#61676ccc;background-color:#61676c07>;
</span></code></pre><pre style=color:#61676c;background-color:#fafafa><code><span>
</span><span>### `crates/bevy_ecs/src/query/fetch.rs` (+11/-9) and `crates/bevy_ecs/src/query/filter.rs` (+2/-2)
</span><span>
</span><span>These files contain updates to ECS query implementations that use `ThinSlicePtr`. The changes are mechanical replacements of `get()` with `get_unchecked()`.
</span><span>
</span><span>```rust
</span><span>// Example from fetch.rs - before:
</span><span>let item = unsafe { table.get(table_row.index()) };
</span><span>
</span><span>// After:
</span><span>let item = unsafe { table.get_unchecked(table_row.index()) };
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/stable/std/primitive.slice.html#method.get_unchecked target=_blank>Rust Standard Library: slice::get_unchecked</a> - The standard library method this PR aligns with<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/blob/main/UNSAFE.md target=_blank>Bevy Engine: Unsafe Code Guidelines</a> - Bevy’s approach to unsafe code<li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/nomicon/ target=_blank>Rustonomicon</a> - Comprehensive guide to unsafe Rust programming</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-11/pr_21823.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>