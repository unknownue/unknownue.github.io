<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21964 Preallocate more things
        
    </title><meta content="#21964 Preallocate more things" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-11/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-11-29</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-11/pr-21964-zh-cn-20251129>中文</a></div></div><div class=pr-content><h1 id=preallocate-more-things>Preallocate more things</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Preallocate more things<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21964<li><strong>Author</strong>: ItsDoot<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-ECS, C-Performance, S-Ready-For-Final-Review, D-Straightforward<li><strong>Created</strong>: 2025-11-28T05:09:34Z<li><strong>Merged</strong>: 2025-11-29T00:17:02Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Part of #20115</ul><p>We should try to minimize allocations where its easy to do so.<h2 id=solution>Solution</h2><p>Pre-allocate things upfront where we know their exact resulting size.<h2 id=testing>Testing</h2><p>It’d probably be good to benchmark to see how much (if any) this helps.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a common performance optimization opportunity in Bevy’s ECS scheduling system: reducing unnecessary memory allocations during graph construction. The core issue was that several graph operations were using default constructors that start with minimal capacity, requiring frequent reallocations as nodes and edges are added.<p>The solution follows a straightforward principle: when the final size of a data structure is known in advance, pre-allocate the required capacity upfront. This avoids the performance cost of multiple reallocations and copying operations that occur when containers grow beyond their initial capacity.<p>In the DAG analysis system, the changes focus on graph construction during topological sorting and transitive operations. Previously, graphs were initialized with default capacity, but now they’re created with exact capacity based on known node and edge counts. This is particularly important for the transitive reduction and closure operations, which can involve complex graph manipulations.<p>The graph flattening operations in <code>DagGroups</code> received significant attention. When expanding edges between key and value nodes, the code now pre-calculates the exact number of edges that will be added. For example, when expanding edges between two key nodes, the number of resulting edges equals the product of the sizes of both key groups. By reserving this capacity upfront, we avoid multiple reallocations during the nested loops that create these edges.<p>The PR also adds new API methods to the graph data structure itself. The <code>reserve_nodes</code> and <code>reserve_edges</code> methods expose the underlying capacity management, allowing callers to optimize graph construction when they know the expected size in advance.<p>In the schedule graph building process, the changes target edge creation operations. When connecting nodes in dependency chains or handling node removal with neighbor reconnection, the code now calculates the exact number of edges that will be created and reserves capacity before entering the nested loops. This is especially important for operations that create edges between all combinations of two node sets, where the number of edges grows quadratically.<p>The engineering approach here is conservative and focused - these changes don’t alter the algorithms or data structures, but simply optimize their memory allocation patterns. This makes the changes low-risk while providing potential performance benefits, particularly for large schedules with many systems and complex dependencies.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[DAG Analysis] --> B[Graph Construction]
</span><span>    C[DagGroups Flattening] --> D[Edge Expansion]
</span><span>    E[Schedule Graph] --> F[Dependency Management]
</span><span>    B --> G[Capacity Pre-allocation]
</span><span>    D --> G
</span><span>    F --> G
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ecs-src-schedule-graph-dag-rs-25-7><code>crates/bevy_ecs/src/schedule/graph/dag.rs</code> (+25/-7)</h3><p>This file contains the core DAG analysis and manipulation logic. The changes focus on pre-allocating graph capacity for topological sorting and edge expansion operations.<p><strong>Key changes:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let mut</span><span> topsorted </span><span style=color:#ed9366>= </span><span>DiGraph</span><span style=color:#ed9366>::</span><span>&LTN></span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let mut</span><span> topsorted </span><span style=color:#ed9366>= </span><span>DiGraph</span><span style=color:#ed9366>::</span><span>&LTN></span><span style=color:#ed9366>::</span><span>with_capacity(topological_order</span><span style=color:#ed9366>.</span><span style=color:#f07171>len</span><span>()</span><span style=color:#61676ccc>,</span><span> graph</span><span style=color:#ed9366>.</span><span style=color:#f07171>edge_count</span><span>())</span><span style=color:#61676ccc>;
</span></code></pre><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>for </span><span style=color:#ed9366>&</span><span>lhs </span><span style=color:#ed9366>in </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#ed9366>&</span><span>lhs_key)</span><span style=color:#ed9366>.</span><span style=color:#f07171>into_iter</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>flatten</span><span>() {
</span><span>    </span><span style=color:#fa6e32>for </span><span style=color:#ed9366>&</span><span>rhs </span><span style=color:#ed9366>in </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#ed9366>&</span><span>rhs_key)</span><span style=color:#ed9366>.</span><span style=color:#f07171>into_iter</span><span>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>flatten</span><span>() {
</span><span>        flattened</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_edge</span><span>(lhs</span><span style=color:#61676ccc>,</span><span> rhs)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(lhs_group) </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#ed9366>&</span><span>lhs_key) </span><span style=color:#fa6e32>else </span><span>{ </span><span style=color:#fa6e32>continue </span><span>}</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(rhs_group) </span><span style=color:#ed9366>= </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(</span><span style=color:#ed9366>&</span><span>rhs_key) </span><span style=color:#fa6e32>else </span><span>{ </span><span style=color:#fa6e32>continue </span><span>}</span><span style=color:#61676ccc>;
</span><span>flattened</span><span style=color:#ed9366>.</span><span style=color:#f07171>reserve_edges</span><span>(lhs_group</span><span style=color:#ed9366>.</span><span style=color:#f07171>len</span><span>() </span><span style=color:#ed9366>*</span><span> rhs_group</span><span style=color:#ed9366>.</span><span style=color:#f07171>len</span><span>())</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>for </span><span style=color:#ed9366>&</span><span>lhs </span><span style=color:#ed9366>in</span><span> lhs_group {
</span><span>    </span><span style=color:#fa6e32>for </span><span style=color:#ed9366>&</span><span>rhs </span><span style=color:#ed9366>in</span><span> rhs_group {
</span><span>        flattened</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_edge</span><span>(lhs</span><span style=color:#61676ccc>,</span><span> rhs)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><h3 id=crates-bevy-ecs-src-schedule-graph-graph-map-rs-13-1><code>crates/bevy_ecs/src/schedule/graph/graph_map.rs</code> (+13/-1)</h3><p>This file defines the graph data structure. The changes add capacity reservation methods and use them in graph operations.<p><strong>Key changes:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// New methods added:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>reserve_nodes</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>additional</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize</span><span>) {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>nodes</span><span style=color:#ed9366>.</span><span style=color:#f07171>reserve</span><span>(additional)</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>reserve_edges</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>additional</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>usize</span><span>) {
</span><span>    </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>edges</span><span style=color:#ed9366>.</span><span style=color:#f07171>reserve</span><span>(additional)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>let mut</span><span> subgraph </span><span style=color:#ed9366>= </span><span>DiGraph</span><span style=color:#ed9366>::</span><span>&LTN></span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>let mut</span><span> subgraph </span><span style=color:#ed9366>= </span><span>DiGraph</span><span style=color:#ed9366>::</span><span>&LTN></span><span style=color:#ed9366>::</span><span>with_capacity(scc</span><span style=color:#ed9366>.</span><span style=color:#f07171>len</span><span>()</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-ecs-src-schedule-schedule-rs-6-0><code>crates/bevy_ecs/src/schedule/schedule.rs</code> (+6/-0)</h3><p>This file handles schedule graph construction. The changes pre-allocate edge capacity for dependency and hierarchy operations.<p><strong>Key changes:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added capacity reservation before nested loops:
</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>dependency</span><span style=color:#ed9366>.</span><span style=color:#f07171>reserve_edges</span><span>(previous_nodes</span><span style=color:#ed9366>.</span><span style=color:#f07171>len</span><span>() </span><span style=color:#ed9366>*</span><span> current_nodes</span><span style=color:#ed9366>.</span><span style=color:#f07171>len</span><span>())</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>for</span><span> previous_node </span><span style=color:#ed9366>in</span><span> previous_nodes {
</span><span>    </span><span style=color:#fa6e32>for</span><span> current_node </span><span style=color:#ed9366>in</span><span> current_nodes {
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>dependency</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_edge</span><span>(</span><span style=color:#ed9366>*</span><span>previous_node</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>*</span><span>current_node)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added for hierarchy operations:
</span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>hierarchy</span><span style=color:#ed9366>.</span><span style=color:#f07171>reserve_edges</span><span>(in_nodes</span><span style=color:#ed9366>.</span><span style=color:#f07171>len</span><span>() </span><span style=color:#ed9366>*</span><span> out_nodes</span><span style=color:#ed9366>.</span><span style=color:#f07171>len</span><span>())</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>for </span><span style=color:#ed9366>&</span><span>in_node </span><span style=color:#ed9366>in &</span><span>in_nodes {
</span><span>    </span><span style=color:#fa6e32>for </span><span style=color:#ed9366>&</span><span>out_node </span><span style=color:#ed9366>in &</span><span>out_nodes {
</span><span>        </span><span style=color:#55b4d4;font-style:italic>self</span><span style=color:#ed9366>.</span><span>hierarchy</span><span style=color:#ed9366>.</span><span style=color:#f07171>add_edge</span><span>(in_node</span><span style=color:#61676ccc>,</span><span> out_node)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/std/vec/struct.Vec.html#method.with_capacity target=_blank>Rust Vec::with_capacity documentation</a><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/ecs/#systems-and-schedules target=_blank>Bevy ECS Scheduling</a><li><a rel="noopener nofollow noreferrer" href=https://gameprogrammingpatterns.com/performance-patterns.html target=_blank>Performance optimization patterns in game engines</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/petgraph/petgraph target=_blank>Graph algorithms in Rust</a> - The graph library that inspired Bevy’s graph implementation</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-11/pr_21964.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>