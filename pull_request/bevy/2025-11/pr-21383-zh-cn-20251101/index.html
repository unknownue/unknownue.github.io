<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21383 Atmosphere occlusion and PBR shading
        
    </title><meta content="#21383 Atmosphere occlusion and PBR shading" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-11/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-11-01</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2025-11/pr-21383-en-20251101>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Atmosphere occlusion and PBR shading<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21383<li><strong>Author</strong>: mate-h<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Feature, A-Rendering, S-Ready-For-Final-Review, M-Release-Note<li><strong>Created</strong>: 2025-10-04T17:58:55Z<li><strong>Merged</strong>: 2025-11-01T21:47:56Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=mu-biao>目标</h1><ul><li>通过大气层遮挡方向光<li>从方向光到达物体的光线值更加物理准确<li>通过额外的 FogVolume 层支持通过大气层的体积阴影<li>战略方向：使用 FogVolume 并扩展该实现以进行阴影采样，因为它已经使用了管道专门化<li>目前保持大气层管道不变，不包含阴影采样代码，因为这些效果仅在大尺度下才有意义。大气层的阴影采样可以在后续的 PR 中为行星环、太空中的物体和其他大尺度对象实现</ul><h2 id=jie-jue-fang-an>解决方案</h2><ul><li>将透射率 LUT 绑定到核心 3D 网格 PBR 着色器<li>通过大气介质的透射率对到达点 P 的入射光 L 进行着色<li>对体积雾应用相同的效果<li>确保新的 Atmosphere 管道键与延迟渲染一起工作<li>更新示例以包括水面和屏幕空间反射。从 GLB 地形资源中移除水面（少量资源变动！）</ul><h2 id=ce-shi>测试</h2><pre class=language-bash data-lang=bash style=color:#61676c;background-color:#fafafa><code class=language-bash data-lang=bash><span style=color:#f29718>cargo</span><span> run</span><span style=color:#ff8f40> --example</span><span> atmosphere
</span><span style=color:#abb0b6;font-style:italic># 或者
</span><span style=color:#f29718>cargo</span><span> run</span><span style=color:#ff8f40> --example</span><span> atmosphere</span><span style=color:#ff8f40> --features</span><span style=color:#ed9366>=</span><span>free_camera
</span></code></pre><hr><h2 id=zhan-shi>展示</h2><img alt="Screenshot 2025-10-22 at 9 50 27 PM" height=721 src=https://github.com/user-attachments/assets/f91ec8ba-a4ee-4bd2-b205-5158193466b9 width=1275><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>这个 PR 解决了 Bevy 渲染系统中一个重要的物理准确性问题：大气层对光线的遮挡效应。在之前的实现中，方向光（如太阳光）会直接照射到场景中的物体，而不考虑光线穿过大气层时的衰减和散射效应。<p><strong>问题与背景</strong><p>在真实的物理世界中，太阳光穿过大气层时会经历瑞利散射和米氏散射，导致光线强度衰减和颜色变化。特别是在日出和日落时，太阳光需要穿过更厚的大气层，呈现出红色或橙色的色调。之前的 Bevy 大气系统虽然能够渲染天空，但没有将这些物理效应应用到场景中的物体光照上。<p><strong>解决方案方法</strong><p>开发者采用了基于 Bruneton 大气模型的预计算透射率查找表（LUT）方法。核心思路是：<ol><li>预计算大气透射率 LUT，存储不同高度和角度下光线的透射率<li>在 PBR 光照计算中采样这个 LUT，根据光线穿过大气层的路径长度来衰减光照强度<li>对体积雾系统应用相同的物理模型，确保一致性</ol><p><strong>技术实现细节</strong><p>实现的关键是在现有的渲染管线中集成大气透射率计算。这需要：<ul><li>在网格视图绑定中添加大气相关的纹理和缓冲区绑定<li>修改 PBR 光照着色器，在方向光计算中加入大气透射率采样<li>扩展体积雾着色器，应用相同的物理模型<li>确保所有渲染路径（前向、延迟）都支持大气效果</ul><p>一个重要的技术决策是重用现有的 FogVolume 系统架构，因为它在管线专门化方面已经提供了良好的基础。这种策略避免了重复造轮子，也使得后续添加更复杂的阴影采样功能更加容易。<p><strong>性能考虑</strong><p>由于使用了预计算的 LUT，运行时性能开销很小。透射率查询只是额外的纹理采样操作，在现代 GPU 上成本很低。这种实现保持了实时渲染的性能要求，同时显著提升了视觉真实性。<p><strong>架构影响</strong><p>这个改动影响了 Bevy 渲染管线的多个层级：<ul><li>增加了新的 MeshPipelineKey::ATMOSPHERE 标志<li>扩展了网格视图绑定布局以包含大气资源<li>修改了核心 PBR 光照计算<li>更新了体积雾渲染</ul><p>这种集成确保了大气效果能够无缝地与其他渲染特性（如屏幕空间反射、环境光遮蔽等）协同工作。<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TB
</span><span>    A[Atmosphere System] --> B[Transmittance LUT]
</span><span>    B --> C[PBR Lighting Shader]
</span><span>    B --> D[Volumetric Fog Shader]
</span><span>    A --> E[Atmosphere Buffer]
</span><span>    E --> C
</span><span>    E --> D
</span><span>    F[Directional Light] --> C
</span><span>    F --> D
</span><span>    C --> G[Final Pixel Color]
</span><span>    D --> G
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=examples-3d-atmosphere-rs-205-23><code>examples/3d/atmosphere.rs</code> (+205/-23)</h3><p>这个示例文件进行了重大扩展，展示了新的大气遮挡功能：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 添加了水面材质和屏幕空间反射
</span><span>commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((
</span><span>    Mesh3d(meshes</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(Plane3d</span><span style=color:#ed9366>::</span><span>new(Vec3</span><span style=color:#ed9366>::</span><span>Y</span><span style=color:#61676ccc>, </span><span>Vec2</span><span style=color:#ed9366>::</span><span>splat(</span><span style=color:#ff8f40>1.0</span><span>))))</span><span style=color:#61676ccc>,
</span><span>    MeshMaterial3d(water_materials</span><span style=color:#ed9366>.</span><span style=color:#f07171>add</span><span>(ExtendedMaterial {
</span><span>        base</span><span style=color:#61676ccc>:</span><span> StandardMaterial {
</span><span>            base_color</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>BLACK</span><span style=color:#ed9366>.</span><span style=color:#f07171>into</span><span>()</span><span style=color:#61676ccc>,
</span><span>            perceptual_roughness</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>0.0</span><span style=color:#61676ccc>,
</span><span>            </span><span style=color:#ed9366>..</span><span style=color:#f07171>default</span><span>()
</span><span>        }</span><span style=color:#61676ccc>,
</span><span>        extension</span><span style=color:#61676ccc>:</span><span> Water {
</span><span>            normals</span><span style=color:#61676ccc>:</span><span> asset_server</span><span style=color:#ed9366>.</span><span>load_with_settings</span><span style=color:#ed9366>::</span><span>&LTImage, ImageLoaderSettings>(
</span><span>                </span><span style=color:#86b300>"textures/water_normals.png"</span><span style=color:#61676ccc>,
</span><span>                |</span><span style=color:#ff8f40>settings</span><span>| {
</span><span>                    settings</span><span style=color:#ed9366>.</span><span>is_srgb </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>false</span><span style=color:#61676ccc>;
</span><span>                    settings</span><span style=color:#ed9366>.</span><span>sampler </span><span style=color:#ed9366>= </span><span>ImageSampler</span><span style=color:#ed9366>::</span><span>Descriptor(ImageSamplerDescriptor {
</span><span>                        address_mode_u</span><span style=color:#61676ccc>: </span><span>ImageAddressMode</span><span style=color:#ed9366>::</span><span>Repeat</span><span style=color:#61676ccc>,
</span><span>                        address_mode_v</span><span style=color:#61676ccc>: </span><span>ImageAddressMode</span><span style=color:#ed9366>::</span><span>Repeat</span><span style=color:#61676ccc>,
</span><span>                        mag_filter</span><span style=color:#61676ccc>: </span><span>ImageFilterMode</span><span style=color:#ed9366>::</span><span>Linear</span><span style=color:#61676ccc>,
</span><span>                        min_filter</span><span style=color:#61676ccc>: </span><span>ImageFilterMode</span><span style=color:#ed9366>::</span><span>Linear</span><span style=color:#61676ccc>,
</span><span>                        </span><span style=color:#ed9366>..</span><span style=color:#f07171>default</span><span>()
</span><span>                    })</span><span style=color:#61676ccc>;
</span><span>                }</span><span style=color:#61676ccc>,
</span><span>            )</span><span style=color:#61676ccc>,
</span><span>            settings</span><span style=color:#61676ccc>:</span><span> WaterSettings {
</span><span>                octave_vectors</span><span style=color:#61676ccc>: </span><span>[
</span><span>                    </span><span style=color:#f07171>vec4</span><span>(</span><span style=color:#ff8f40>0.080</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.059</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.073</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>-</span><span style=color:#ff8f40>0.062</span><span>)</span><span style=color:#61676ccc>,
</span><span>                    </span><span style=color:#f07171>vec4</span><span>(</span><span style=color:#ff8f40>0.153</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.138</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>-</span><span style=color:#ff8f40>0.149</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>-</span><span style=color:#ff8f40>0.195</span><span>)</span><span style=color:#61676ccc>,
</span><span>                ]</span><span style=color:#61676ccc>,
</span><span>                octave_scales</span><span style=color:#61676ccc>: </span><span style=color:#f07171>vec4</span><span>(</span><span style=color:#ff8f40>1.0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>2.1</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>7.9</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>14.9</span><span>) </span><span style=color:#ed9366>* </span><span style=color:#ff8f40>500.0</span><span style=color:#61676ccc>,
</span><span>                octave_strengths</span><span style=color:#61676ccc>: </span><span style=color:#f07171>vec4</span><span>(</span><span style=color:#ff8f40>0.16</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.18</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.093</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.044</span><span>) </span><span style=color:#ed9366>* </span><span style=color:#ff8f40>0.2</span><span style=color:#61676ccc>,
</span><span>            }</span><span style=color:#61676ccc>,
</span><span>        }</span><span style=color:#61676ccc>,
</span><span>    }))</span><span style=color:#61676ccc>,
</span><span>    Transform</span><span style=color:#ed9366>::</span><span>from_scale(Vec3</span><span style=color:#ed9366>::</span><span>splat(</span><span style=color:#ff8f40>100.0</span><span>))</span><span style=color:#61676ccc>,
</span><span>))</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-pbr-src-render-mesh-view-bindings-rs-53-3><code>crates/bevy_pbr/src/render/mesh_view_bindings.rs</code> (+53/-3)</h3><p>扩展了网格视图绑定以支持大气数据：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 在大气启用时添加绑定
</span><span style=color:#fa6e32>if</span><span> layout_key</span><span style=color:#ed9366>.</span><span style=color:#f07171>contains</span><span>(MeshPipelineViewLayoutKey</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ATMOSPHERE</span><span>) {
</span><span>    entries </span><span style=color:#ed9366>=</span><span> entries</span><span style=color:#ed9366>.</span><span style=color:#f07171>extend_with_indices</span><span>((
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// transmittance LUT
</span><span>        (
</span><span>            </span><span style=color:#ff8f40>29</span><span style=color:#61676ccc>,
</span><span>            </span><span style=color:#f07171>texture_2d</span><span>(TextureSampleType</span><span style=color:#ed9366>::</span><span>Float { filterable</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>true </span><span>})</span><span style=color:#61676ccc>,
</span><span>        )</span><span style=color:#61676ccc>,
</span><span>        (</span><span style=color:#ff8f40>30</span><span style=color:#61676ccc>, </span><span style=color:#f07171>sampler</span><span>(SamplerBindingType</span><span style=color:#ed9366>::</span><span>Filtering))</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// atmosphere data buffer
</span><span>        (</span><span style=color:#ff8f40>31</span><span style=color:#61676ccc>, </span><span>storage_buffer_read_only</span><span style=color:#ed9366>::</span><span>&LTAtmosphereData>(</span><span style=color:#ff8f40>false</span><span>))</span><span style=color:#61676ccc>,
</span><span>    ))</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=crates-bevy-pbr-src-volumetric-fog-volumetric-fog-wgsl-38-5><code>crates/bevy_pbr/src/volumetric_fog/volumetric_fog.wgsl</code> (+38/-5)</h3><p>在体积雾着色器中集成了大气透射率：<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>#ifdef ATMOSPHERE
</span><span>// attenuate by atmospheric scattering
</span><span>let P = P_world + depth_offset;
</span><span>let P_scaled = P * vec3(atmosphere_data.settings.scene_units_to_m);
</span><span>let O = vec3(0.0, atmosphere_data.atmosphere.bottom_radius, 0.0);
</span><span>let P_as = P_scaled + O;
</span><span>let r = length(P_as);
</span><span>let local_up = normalize(P_as);
</span><span>let mu_light = dot(L, local_up);
</span><span>
</span><span>let transmittance = sample_transmittance_lut(r, mu_light);
</span><span>let sun_visibility = calculate_visible_sun_ratio(atmosphere_data.atmosphere, r, mu_light, (*light).sun_disk_angular_size);
</span><span>light_factors_per_step *= transmittance * sun_visibility;
</span><span>#endif
</span></code></pre><h3 id=crates-bevy-pbr-src-atmosphere-resources-rs-42-0><code>crates/bevy_pbr/src/atmosphere/resources.rs</code> (+42/-0)</h3><p>添加了大气数据缓冲区的管理：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(ShaderType)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>repr</span><span>(C)]
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>AtmosphereData </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>atmosphere</span><span style=color:#61676ccc>:</span><span> GpuAtmosphere,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>settings</span><span style=color:#61676ccc>:</span><span> GpuAtmosphereSettings,
</span><span>}
</span><span>
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>init_atmosphere_buffer</span><span>(</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands) {
</span><span>    commands</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_resource</span><span>(AtmosphereBuffer {
</span><span>        buffer</span><span style=color:#61676ccc>: </span><span>StorageBuffer</span><span style=color:#ed9366>::</span><span>from(AtmosphereData {
</span><span>            atmosphere</span><span style=color:#61676ccc>:</span><span> GpuAtmosphere {
</span><span>                ground_albedo</span><span style=color:#61676ccc>: </span><span>Vec3</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>ZERO</span><span style=color:#61676ccc>,
</span><span>                bottom_radius</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>0.0</span><span style=color:#61676ccc>,
</span><span>                top_radius</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>0.0</span><span style=color:#61676ccc>,
</span><span>            }</span><span style=color:#61676ccc>,
</span><span>            settings</span><span style=color:#61676ccc>: </span><span>GpuAtmosphereSettings</span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#61676ccc>,
</span><span>        })</span><span style=color:#61676ccc>,
</span><span>    })</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=crates-bevy-pbr-src-render-pbr-lighting-wgsl-32-1><code>crates/bevy_pbr/src/render/pbr_lighting.wgsl</code> (+32/-1)</h3><p>在 PBR 光照计算中集成了大气透射率：<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>#ifdef ATMOSPHERE
</span><span>let P = (*input).P;
</span><span>let atmosphere = view_bindings::atmosphere_data.atmosphere;
</span><span>let O = vec3(0.0, atmosphere.bottom_radius, 0.0);
</span><span>let P_scaled = P * vec3(view_bindings::atmosphere_data.settings.scene_units_to_m);
</span><span>let P_as = P_scaled + O;
</span><span>let r = length(P_as);
</span><span>let local_up = normalize(P_as);
</span><span>let mu_light = dot(L, local_up);
</span><span>
</span><span>// Sample atmosphere
</span><span>let transmittance = sample_transmittance_lut(r, mu_light);
</span><span>let sun_visibility = calculate_visible_sun_ratio(atmosphere, r, mu_light, (*light).sun_disk_angular_size);
</span><span>
</span><span>// Apply atmospheric effects
</span><span>color *= transmittance * sun_visibility;
</span><span>#endif
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://hal.inria.fr/inria-00288758/document target=_blank>Bruneton and Neyret 的预计算大气散射论文</a> - 这个 PR 实现的大气模型的基础<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/books/render/atmosphere/ target=_blank>Bevy 大气系统文档</a> - Bevy 官方文档中的大气渲染章节<li><a rel="noopener nofollow noreferrer" href=https://advances.realtimerendering.com/s2015/The%20Real-time%20Volumetric%20Cloudscapes%20of%20Horizon%20-%20Zero%20Dawn%20-%20ARTR.pdf target=_blank>实时渲染中的体积效果</a> - 关于实时体积渲染的深入讨论<li><a rel="noopener nofollow noreferrer" href=https://gpuweb.github.io/gpuweb/wgsl/ target=_blank>WGSL 着色语言规范</a> - 这个 PR 中使用的着色语言</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-11/pr_21383.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>