<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21962 Make items public that are necessary to add custom prepasses in application code
        
    </title><meta content="#21962 Make items public that are necessary to add custom prepasses in application code" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-11/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-11-28</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-11/pr-21962-zh-cn-20251128>中文</a></div></div><div class=pr-content><h1 id=title-make-items-public-that-are-necessary-to-add-custom-prepasses-in-application-code>Title: Make items public that are necessary to add custom prepasses in application code</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Make items public that are necessary to add custom prepasses in application code<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21962<li><strong>Author</strong>: pcwalton<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-11-28T00:31:23Z<li><strong>Merged</strong>: 2025-11-28T08:03:37Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><p>Currently, custom prepasses can’t be easily added outside the <code>bevy_pbr</code> crate for two reasons:<ol><li><p>The fields in <code>PrepassSpecializer</code> are private to the <code>bevy_pbr</code> crate, so a <code>PrepassSpecializer</code> can’t be constructed. Furthermore, the <code>PrepassSpecializer::specialize</code> method itself calls private APIs, so a developer can’t even copy and paste the <code>PrepassSpecializer</code> into application code.</p><li><p>The <code>set_mesh_motion_vector_flags</code> system is private, meaning that specialization systems for custom prepasses can’t be ordered after it. This is a problem because those specialization systems may need to read the motion vector flags that that system sets.</p></ol><p>This commit changes the fields in <code>PrepassSpecializer</code> to be public and also changes the <code>set_mesh_motion_vector_flags</code> system to be public.<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a straightforward but important limitation in Bevy’s prepass system architecture. The core issue was that developers working outside the <code>bevy_pbr</code> crate couldn’t implement custom prepasses due to overly restrictive visibility modifiers on key components.<p>The problem manifested in two specific areas. First, the <code>PrepassPipelineSpecializer</code> struct had its fields marked as <code>pub(crate)</code>, making them inaccessible to application code. This meant external developers couldn’t instantiate this struct, which is essential for creating custom prepass pipelines. Even if someone attempted to copy the implementation, they would hit further roadblocks because the <code>specialize</code> method relied on additional private APIs.<p>Second, the <code>set_mesh_motion_vector_flags</code> system function was also marked as <code>pub(crate)</code>. This created ordering constraints for custom prepass systems that needed to read motion vector flags set by this system. Without public access, developers couldn’t properly sequence their custom systems in relation to this core functionality.<p>The solution implemented here is minimal and surgical - it simply changes visibility modifiers from <code>pub(crate)</code> to <code>pub</code> in two locations. This approach maintains all existing functionality while opening up the necessary extension points for external development. The changes don’t alter any logic or behavior; they only adjust access control to enable broader usage.<p>From an architectural perspective, this change aligns with Bevy’s philosophy of being extensible and modular. By making these components public, the engine acknowledges that prepass functionality shouldn’t be locked within the core rendering crate. This allows for experimentation and customization at the application level without requiring modifications to the engine itself.<p>The implementation required no complex refactoring or architectural changes. The modifications are purely about API surface area, demonstrating how thoughtful visibility design can significantly impact a framework’s extensibility. This pattern of identifying and exposing necessary extension points is common in well-designed engine architectures.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Application Code] --> B[Custom Prepass Systems]
</span><span>    B --> C[PrepassPipelineSpecializer]
</span><span>    B --> D[set_mesh_motion_vector_flags]
</span><span>    C --> E[Prepass Pipeline]
</span><span>    D --> F[Motion Vector Flags]
</span><span>    E --> G[Rendering]
</span><span>    F --> G
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-pbr-src-prepass-mod-rs><code>crates/bevy_pbr/src/prepass/mod.rs</code></h3><p>This file contains the core prepass pipeline specialization logic. The change makes the <code>PrepassPipelineSpecializer</code> struct’s fields publicly accessible.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>PrepassPipelineSpecializer </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) pipeline</span><span style=color:#61676ccc>:</span><span> PrepassPipeline,
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) properties</span><span style=color:#61676ccc>: </span><span>Arc&LTMaterialProperties>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>PrepassPipelineSpecializer </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>pipeline</span><span style=color:#61676ccc>:</span><span> PrepassPipeline,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>properties</span><span style=color:#61676ccc>: </span><span>Arc&LTMaterialProperties>,
</span><span>}
</span></code></pre><h3 id=crates-bevy-pbr-src-render-mesh-rs><code>crates/bevy_pbr/src/render/mesh.rs</code></h3><p>This file handles mesh rendering functionality. The change makes the motion vector flag system publicly accessible.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>set_mesh_motion_vector_flags</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>render_mesh_instances</span><span style=color:#61676ccc>: </span><span>ResMut&LTRenderMeshInstances>,
</span><span>    </span><span style=color:#ff8f40>skin_uniforms</span><span style=color:#61676ccc>: </span><span>Res&LTSkinUniforms>,
</span><span>    </span><span style=color:#ff8f40>morph_indices</span><span style=color:#61676ccc>: </span><span>Res&LTMorphIndices>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span>pub fn set_mesh_motion_vector_flags(
</span><span>    </span><span style=color:#ff8f40>mut render_mesh_instances</span><span>: </span><span style=color:#ff8f40>ResMut</span><span><</span><span style=color:#ff8f40>RenderMeshInstances</span><span>></span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#ff8f40>skin_uniforms</span><span>: </span><span style=color:#ff8f40>Res</span><span><</span><span style=color:#ff8f40>SkinUniforms</span><span>></span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#ff8f40>morph_indices</span><span>: </span><span style=color:#ff8f40>Res</span><span><</span><span style=color:#ff8f40>MorphIndices</span><span>></span><span style=color:#61676ccc>,
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/core/prepass/index.html target=_blank>Bevy Prepass Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/reference/visibility-and-privacy.html target=_blank>Rust Visibility and Privacy</a><li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/programming/system-order.html target=_blank>Bevy ECS System Ordering</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-11/pr_21962.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>