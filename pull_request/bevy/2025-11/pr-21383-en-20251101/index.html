<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21383 Atmosphere occlusion and PBR shading
        
    </title><meta content="#21383 Atmosphere occlusion and PBR shading" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-11/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-11-01</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-11/pr-21383-zh-cn-20251101>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>Atmosphere occlusion and PBR shading<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Atmosphere occlusion and PBR shading<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21383<li><strong>Author</strong>: mate-h<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Feature, A-Rendering, S-Ready-For-Final-Review, M-Release-Note<li><strong>Created</strong>: 2025-10-04T17:58:55Z<li><strong>Merged</strong>: 2025-11-01T21:47:56Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Occlude the directional lights by the atmosphere<li>More Physically accurate light values reaching the objects from directional lights<li>Support volumetric shadowing through the atmosphere with an additional layer of FogVolume<li>Strategic direction: use the FogVolume and expand on that implementation for shadow sampling Since it already uses pipeline specialization.<li>For now keep the atmosphere pipeline as is, free from shadow sampling code since these effects only matter at large scales. Shadow sampling for the atmosphere can be implemented in a later PR for planetary rings, objects in space, other large scale objects.</ul><h2 id=solution>Solution</h2><ul><li>Bind the transmittance LUT to the core 3d mesh PBR shader<li>tint the incoming light L to point P by the transmittance through the atmospheric medium<li>Apply the same effects to volumetric fog<li>Ensured that new new Atmosphere pipeline key works with deferred rendering<li>Updated example to include water plane and screen space reflections. Removed the water plane from the GLB terrain asset. (small asset churn!)</ul><h2 id=testing>Testing</h2><pre class=language-bash data-lang=bash style=color:#61676c;background-color:#fafafa><code class=language-bash data-lang=bash><span style=color:#f29718>cargo</span><span> run</span><span style=color:#ff8f40> --example</span><span> atmosphere
</span><span style=color:#abb0b6;font-style:italic># or
</span><span style=color:#f29718>cargo</span><span> run</span><span style=color:#ff8f40> --example</span><span> atmosphere</span><span style=color:#ff8f40> --features</span><span style=color:#ed9366>=</span><span>free_camera
</span></code></pre><hr><h2 id=showcase>Showcase</h2><img alt="Screenshot 2025-10-22 at 9 50 27 PM" height=721 src=https://github.com/user-attachments/assets/f91ec8ba-a4ee-4bd2-b205-5158193466b9 width=1275><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a fundamental limitation in Bevy’s atmospheric rendering system: the lack of proper atmospheric occlusion for directional lights. Previously, sunlight would pass through the atmosphere without being attenuated, resulting in unrealistic lighting that didn’t account for how atmospheric scattering affects light reaching objects in the scene.<p>The core problem was that while Bevy had atmospheric rendering for skyboxes, this atmospheric data wasn’t being used to modify how directional lights illuminated objects. This meant scenes lacked the realistic color shifts that occur when sunlight travels through different atmospheric densities - particularly the orange and red hues seen at sunrise and sunset.<p>The solution approach centered on integrating the existing atmospheric transmittance Look-Up Table (LUT) into the core PBR lighting calculations. The developer made a strategic decision to build upon the existing FogVolume infrastructure since it already used pipeline specialization, which would allow for a more maintainable architecture.<p>The implementation required changes across multiple rendering subsystems. First, the transmittance LUT needed to be bound to the mesh PBR shader so it could sample atmospheric transmittance data. Then, the directional light calculations were modified to tint incoming light based on the transmittance through the atmospheric medium at each point in the scene.<p>A key technical insight was that this same atmospheric occlusion logic needed to be applied to volumetric fog as well, ensuring consistent lighting behavior across different rendering features. The developer also ensured the new atmosphere pipeline key worked properly with deferred rendering, which required updating pipeline specialization logic in multiple locations.<p>The changes significantly improve physical accuracy by making directional light intensity and color vary based on atmospheric conditions and the sun’s position relative to objects in the scene. This creates more realistic outdoor lighting where objects appear properly illuminated by sunlight that has traveled through the atmosphere.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Atmosphere System] --> B[Transmittance LUT]
</span><span>    B --> C[PBR Lighting Shader]
</span><span>    B --> D[Volumetric Fog Shader]
</span><span>    C --> E[Directional Light Occlusion]
</span><span>    D --> F[Fog Atmospheric Effects]
</span><span>    E --> G[Final Scene Lighting]
</span><span>    F --> G
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-pbr-src-render-mesh-view-bindings-rs-53-3><code>crates/bevy_pbr/src/render/mesh_view_bindings.rs</code> (+53/-3)</h3><p>This file handles the binding of resources to shaders. The changes add support for binding atmospheric resources to the core mesh rendering pipeline.<p><strong>Key additions:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Atmosphere buffer binding
</span><span>(</span><span style=color:#ff8f40>31</span><span style=color:#61676ccc>, </span><span>storage_buffer_read_only</span><span style=color:#ed9366>::</span><span>&LTAtmosphereData>(</span><span style=color:#ff8f40>false</span><span>))</span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Transmittance LUT texture and sampler bindings
</span><span>(</span><span style=color:#ff8f40>29</span><span style=color:#61676ccc>, </span><span style=color:#f07171>texture_2d</span><span>(TextureSampleType</span><span style=color:#ed9366>::</span><span>Float { filterable</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>true </span><span>}))</span><span style=color:#61676ccc>,
</span><span>(</span><span style=color:#ff8f40>30</span><span style=color:#61676ccc>, </span><span style=color:#f07171>sampler</span><span>(SamplerBindingType</span><span style=color:#ed9366>::</span><span>Filtering))</span><span style=color:#61676ccc>,
</span></code></pre><h3 id=crates-bevy-pbr-src-render-pbr-lighting-wgsl-32-1><code>crates/bevy_pbr/src/render/pbr_lighting.wgsl</code> (+32/-1)</h3><p>This is the core PBR lighting shader where atmospheric occlusion is applied to directional lights.<p><strong>Key implementation:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#ed9366>#</span><span>ifdef </span><span style=color:#ff8f40>ATMOSPHERE
</span><span>    </span><span style=color:#fa6e32>let</span><span> P </span><span style=color:#ed9366>= </span><span>(</span><span style=color:#ed9366>*</span><span>input)</span><span style=color:#ed9366>.</span><span>P</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> atmosphere </span><span style=color:#ed9366>= </span><span>view_bindings</span><span style=color:#ed9366>::</span><span>atmosphere_data</span><span style=color:#ed9366>.</span><span>atmosphere</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> O </span><span style=color:#ed9366>= </span><span style=color:#f07171>vec3</span><span>(</span><span style=color:#ff8f40>0.0</span><span style=color:#61676ccc>,</span><span> atmosphere</span><span style=color:#ed9366>.</span><span>bottom_radius</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.0</span><span>)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> P_scaled </span><span style=color:#ed9366>=</span><span> P </span><span style=color:#ed9366>* </span><span style=color:#f07171>vec3</span><span>(view_bindings</span><span style=color:#ed9366>::</span><span>atmosphere_data</span><span style=color:#ed9366>.</span><span>settings</span><span style=color:#ed9366>.</span><span>scene_units_to_m)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> P_as </span><span style=color:#ed9366>=</span><span> P_scaled </span><span style=color:#ed9366>+</span><span> O</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> r </span><span style=color:#ed9366>= </span><span style=color:#f07171>length</span><span>(P_as)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> local_up </span><span style=color:#ed9366>= </span><span style=color:#f07171>normalize</span><span>(P_as)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> mu_light </span><span style=color:#ed9366>= </span><span style=color:#f07171>dot</span><span>(L</span><span style=color:#61676ccc>,</span><span> local_up)</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Sample atmosphere
</span><span>    </span><span style=color:#fa6e32>let</span><span> transmittance </span><span style=color:#ed9366>= </span><span style=color:#f07171>sample_transmittance_lut</span><span>(r</span><span style=color:#61676ccc>,</span><span> mu_light)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> sun_visibility </span><span style=color:#ed9366>= </span><span style=color:#f07171>calculate_visible_sun_ratio</span><span>(atmosphere</span><span style=color:#61676ccc>,</span><span> r</span><span style=color:#61676ccc>,</span><span> mu_light</span><span style=color:#61676ccc>, </span><span>(</span><span style=color:#ed9366>*</span><span>light)</span><span style=color:#ed9366>.</span><span>sun_disk_angular_size)</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Apply atmospheric effects
</span><span>    color </span><span style=color:#ed9366>*=</span><span> transmittance </span><span style=color:#ed9366>*</span><span> sun_visibility</span><span style=color:#61676ccc>;
</span><span style=color:#ed9366>#</span><span>endif
</span></code></pre><h3 id=crates-bevy-pbr-src-volumetric-fog-volumetric-fog-wgsl-38-5><code>crates/bevy_pbr/src/volumetric_fog/volumetric_fog.wgsl</code> (+38/-5)</h3><p>This file applies the same atmospheric occlusion to volumetric fog, ensuring consistent lighting.<p><strong>Key changes:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#ed9366>#</span><span>ifdef </span><span style=color:#ff8f40>ATMOSPHERE
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// attenuate by atmospheric scattering
</span><span>    </span><span style=color:#fa6e32>let</span><span> P </span><span style=color:#ed9366>=</span><span> P_world </span><span style=color:#ed9366>+</span><span> depth_offset</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> P_scaled </span><span style=color:#ed9366>=</span><span> P </span><span style=color:#ed9366>* </span><span style=color:#f07171>vec3</span><span>(atmosphere_data</span><span style=color:#ed9366>.</span><span>settings</span><span style=color:#ed9366>.</span><span>scene_units_to_m)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> O </span><span style=color:#ed9366>= </span><span style=color:#f07171>vec3</span><span>(</span><span style=color:#ff8f40>0.0</span><span style=color:#61676ccc>,</span><span> atmosphere_data</span><span style=color:#ed9366>.</span><span>atmosphere</span><span style=color:#ed9366>.</span><span>bottom_radius</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0.0</span><span>)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> P_as </span><span style=color:#ed9366>=</span><span> P_scaled </span><span style=color:#ed9366>+</span><span> O</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> r </span><span style=color:#ed9366>= </span><span style=color:#f07171>length</span><span>(P_as)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> local_up </span><span style=color:#ed9366>= </span><span style=color:#f07171>normalize</span><span>(P_as)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> mu_light </span><span style=color:#ed9366>= </span><span style=color:#f07171>dot</span><span>(L</span><span style=color:#61676ccc>,</span><span> local_up)</span><span style=color:#61676ccc>;
</span><span>    
</span><span>    </span><span style=color:#fa6e32>let</span><span> transmittance </span><span style=color:#ed9366>= </span><span style=color:#f07171>sample_transmittance_lut</span><span>(r</span><span style=color:#61676ccc>,</span><span> mu_light)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> sun_visibility </span><span style=color:#ed9366>= </span><span style=color:#f07171>calculate_visible_sun_ratio</span><span>(atmosphere_data</span><span style=color:#ed9366>.</span><span>atmosphere</span><span style=color:#61676ccc>,</span><span> r</span><span style=color:#61676ccc>,</span><span> mu_light</span><span style=color:#61676ccc>, </span><span>(</span><span style=color:#ed9366>*</span><span>light)</span><span style=color:#ed9366>.</span><span>sun_disk_angular_size)</span><span style=color:#61676ccc>;
</span><span>    light_factors_per_step </span><span style=color:#ed9366>*=</span><span> transmittance </span><span style=color:#ed9366>*</span><span> sun_visibility</span><span style=color:#61676ccc>;
</span><span style=color:#ed9366>#</span><span>endif
</span></code></pre><h3 id=crates-bevy-pbr-src-atmosphere-resources-rs-42-0><code>crates/bevy_pbr/src/atmosphere/resources.rs</code> (+42/-0)</h3><p>This file adds the infrastructure for managing atmosphere data buffers.<p><strong>Key additions:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(ShaderType)]
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>repr</span><span>(C)]
</span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>AtmosphereData </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub </span><span>atmosphere</span><span style=color:#61676ccc>:</span><span> GpuAtmosphere,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>settings</span><span style=color:#61676ccc>:</span><span> GpuAtmosphereSettings,
</span><span>}
</span><span>
</span><span style=color:#61676ccc>#</span><span>[</span><span style=color:#f29718>derive</span><span>(Resource)]
</span><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>AtmosphereBuffer </span><span>{
</span><span>    </span><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) buffer</span><span style=color:#61676ccc>: </span><span>StorageBuffer&LTAtmosphereData>,
</span><span>}
</span></code></pre><h3 id=examples-3d-atmosphere-rs-205-23><code>examples/3d/atmosphere.rs</code> (+205/-23)</h3><p>The example was significantly enhanced to showcase the new atmospheric occlusion features with improved visuals and controls.<p><strong>Key improvements:</strong><ul><li>Added water plane with animated ripples<li>Added screen space reflections<li>Added interactive controls for atmosphere rendering modes<li>Added pause/resume functionality for sun motion<li>Added exposure controls</ul><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/books/reference/pbr target=_blank>Bevy PBR Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://developer.nvidia.com/gpugems/gpugems2/part-ii-shading-lighting-and-shadows/chapter-16-accurate-atmospheric-scattering target=_blank>Atmospheric Scattering Theory</a><li><a rel="noopener nofollow noreferrer" href=https://www.alexandre-pestana.com/volumetric-lights/ target=_blank>Volumetric Rendering Techniques</a><li><a rel="noopener nofollow noreferrer" href=https://hal.inria.fr/inria-00288758/document target=_blank>Bruneton and Neyret Precomputed Atmospheric Scattering Paper</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-11/pr_21383.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>