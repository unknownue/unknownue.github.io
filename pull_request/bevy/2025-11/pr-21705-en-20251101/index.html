<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21705 Make it easier to write tests involving fixed timesteps
        
    </title><meta content="#21705 Make it easier to write tests involving fixed timesteps" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-11/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-11-01</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-11/pr-21705-zh-cn-20251101>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Make it easier to write tests involving fixed timesteps<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21705<li><strong>Author</strong>: janhohenheim<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Usability, S-Ready-For-Final-Review, A-Time, D-Straightforward<li><strong>Created</strong>: 2025-10-31T19:39:23Z<li><strong>Merged</strong>: 2025-11-01T19:20:41Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>For running tests involving fixed timesteps, I want to advance the time so that every call to <code>app.update()</code> triggers a fixed update<li>Right now, the most precise way to do that to my knowledge is<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_resource</span><span>(TimeUpdateStrategy</span><span style=color:#ed9366>::</span><span>ManualDuration(Time</span><span style=color:#ed9366>::</span><span>&LTFixed></span><span style=color:#ed9366>::</span><span>default()</span><span style=color:#ed9366>.</span><span style=color:#f07171>timestep</span><span>()))
</span></code></pre><li>But this is a bit clumsy, and also doesn’t work when the fixed timestep isn’t at the default. Some more boilerplate would be needed in the test setup to deal with that:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_resource</span><span>(TimeUpdateStrategy</span><span style=color:#ed9366>::</span><span>ManualDuration(app</span><span style=color:#ed9366>.</span><span style=color:#f07171>world</span><span>()</span><span style=color:#ed9366>.</span><span>resource</span><span style=color:#ed9366>::</span><span>&LTTime&LTFixed>>()</span><span style=color:#ed9366>.</span><span style=color:#f07171>timestep</span><span>()))
</span></code></pre><li>Good luck adapting this for the case when the fixed timestep ever changes at runtime lol</ul><h2 id=solution>Solution</h2><ul><li>Create an alternative strategy called <code>TimeUpdateStrategy::FixedTimesteps</code> that advances time by the fixed timestep automatically:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Now `app.update()` will run the fixed loop exactly once!
</span><span>app</span><span style=color:#ed9366>.</span><span style=color:#f07171>insert_resource</span><span>(TimeUpdateStrategy</span><span style=color:#ed9366>::</span><span>FixedTimesteps(</span><span style=color:#ff8f40>1</span><span>))
</span></code></pre></ul><h2 id=testing>Testing</h2><ul><li>None, as this is trivial</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>The problem started with testing fixed timestep systems in Bevy. When writing tests for game logic that depends on fixed updates, developers need precise control over how time advances between <code>app.update()</code> calls. The goal was to ensure each call to <code>app.update()</code> would trigger exactly one fixed update, which requires advancing time by exactly the fixed timestep duration.<p>The existing approach using <code>TimeUpdateStrategy::ManualDuration</code> had several practical issues. First, it required manually calculating the timestep duration, which was verbose and error-prone. Second, it didn’t adapt to changes in the fixed timestep configuration - if a test changed the timestep value, the manual duration calculation would be incorrect. Third, the boilerplate code made tests harder to read and maintain.<p>The solution introduced a new <code>TimeUpdateStrategy::FixedTimesteps</code> variant that directly addresses these issues. Instead of requiring manual duration calculations, this new strategy automatically uses the current fixed timestep from the <code>Time&LTFixed></code> resource and multiplies it by a factor. This means developers can simply specify how many fixed timesteps they want to advance per frame update.<p>The implementation required two key changes. First, the enum definition was extended with the new variant. Second, the time system was modified to handle this new case by accessing the fixed time resource and multiplying its timestep by the specified factor. This approach maintains consistency with the existing time update architecture while providing a much cleaner API for testing.<p>From a technical perspective, this change demonstrates good API design principles. It solves the immediate testing pain point while being flexible enough to handle multiple timesteps per update. The factor parameter allows tests to simulate scenarios where multiple fixed updates occur in a single frame, which is common in real-world game scenarios when frame times exceed the fixed timestep.<p>The impact is significant for developers writing tests involving fixed timesteps. Test setup code becomes more readable and less error-prone. The new approach automatically adapts to changes in fixed timestep configuration, making tests more robust. This is particularly valuable for test suites that need to verify behavior under different timestep configurations.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[TimeUpdateStrategy Enum] --> B[ManualInstant]
</span><span>    A --> C[ManualDuration]
</span><span>    A --> D[FixedTimesteps]
</span><span>    E[Time&LTFixed> Resource] --> D
</span><span>    D --> F[time_system]
</span><span>    F --> G[Advances Time by timestep * factor]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-time-src-lib-rs-7-0><code>crates/bevy_time/src/lib.rs</code> (+7/-0)</h3><p>This file contains the core changes that implement the new fixed timestep strategy.<p><strong>Key modifications:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added new enum variant
</span><span style=color:#fa6e32>pub enum </span><span style=color:#399ee6>TimeUpdateStrategy </span><span>{
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... existing variants ...
</span><span>    </span><span style=color:#abb0b6;font-style:italic>/// [`Time`] will be incremented by the fixed timestep each frame, multiplied by the specified factor `n`.
</span><span>    </span><span style=color:#abb0b6;font-style:italic>/// This means that a call to [`App::update`] will always run the fixed loop exactly n times.
</span><span>    FixedTimesteps(</span><span style=color:#fa6e32>u32</span><span>)</span><span style=color:#61676ccc>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Modified time_system to handle the new variant
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>time_system</span><span>(
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>real_time</span><span style=color:#61676ccc>: </span><span>ResMut&LTTime&LTReal>>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>virtual_time</span><span style=color:#61676ccc>: </span><span>ResMut&LTTime&LTVirtual>>,
</span><span>    </span><span style=color:#ff8f40>fixed_time</span><span style=color:#61676ccc>: </span><span>Res&LTTime&LTFixed>>,  </span><span style=color:#abb0b6;font-style:italic>// Added this parameter
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>time</span><span style=color:#61676ccc>: </span><span>ResMut&LTTime>,
</span><span>    </span><span style=color:#ff8f40>update_strategy</span><span style=color:#61676ccc>: </span><span>Res&LTTimeUpdateStrategy>,
</span><span>    #[cfg(</span><span style=color:#ff8f40>feature</span><span> = "</span><span style=color:#ff8f40>std</span><span>")] </span><span style=color:#ff8f40>time_recv</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTRes&LTTimeReceiver>>,
</span><span>) {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// ... existing logic ...
</span><span>    
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Added this match arm
</span><span>    TimeUpdateStrategy</span><span style=color:#ed9366>::</span><span>FixedTimesteps(factor) </span><span style=color:#ed9366>=> </span><span>{
</span><span>        real_time</span><span style=color:#ed9366>.</span><span style=color:#f07171>update_with_duration</span><span>(fixed_time</span><span style=color:#ed9366>.</span><span style=color:#f07171>timestep</span><span>() </span><span style=color:#ed9366>* *</span><span>factor)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>}
</span></code></pre><p>The changes add a new variant to the <code>TimeUpdateStrategy</code> enum and modify the <code>time_system</code> to handle this case by accessing the fixed time resource and using its timestep multiplied by the specified factor.<h3 id=crates-bevy-time-src-fixed-rs-1-1><code>crates/bevy_time/src/fixed.rs</code> (+1/-1)</h3><p>This file contains a minor whitespace cleanup that doesn’t affect functionality.<p><strong>Change:</strong><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#abb0b6;font-style:italic>///     
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#abb0b6;font-style:italic>///
</span></code></pre><p>This is purely a documentation formatting fix that removes trailing whitespace.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_time/latest/bevy_time/ target=_blank>Bevy Time Documentation</a> - Official documentation for Bevy’s time systems<li><a rel="noopener nofollow noreferrer" href=https://gafferongames.com/post/fix_your_timestep/ target=_blank>Fixed Timestep Pattern</a> - Classic article on fixed timestep implementation patterns<li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/programming/testing.html target=_blank>Bevy Testing Guide</a> - General testing patterns in Bevy</ul><h1 id=full-code-diff>Full Code Diff</h1><p>diff –git a/crates/bevy_time/src/fixed.rs b/crates/bevy_time/src/fixed.rs index f1c67ea4a0ca9..13f1590b33a95 100644 — a/crates/bevy_time/src/fixed.rs +++ b/crates/bevy_time/src/fixed.rs @@ -10,7 +10,7 @@ use crate::{time::Time, virt::Virtual}; /// /// A specialization of the [<code>Time</code>] structure. <strong>For method documentation, see /// [<code>Time&LTFixed>#impl-Time&LTFixed></code>].</strong> -///<br> +/// /// It is automatically inserted as a resource by /// <a href=crate::TimePlugin><code>TimePlugin</code></a> and updated based on /// <a href=https://unknownue.github.io/pull_request/bevy/2025-11/pr-21705-en-20251101/Virtual><code>Time&LTVirtual></code></a>. The fixed clock is automatically set as the diff –git a/crates/bevy_time/src/lib.rs b/crates/bevy_time/src/lib.rs index 3d515597ac6e8..d4c8d67806a37 100644 — a/crates/bevy_time/src/lib.rs +++ b/crates/bevy_time/src/lib.rs @@ -118,6 +118,9 @@ pub enum TimeUpdateStrategy { ManualInstant(Instant), /// [<code>Time</code>] will be incremented by the specified [<code>Duration</code>] each frame. ManualDuration(Duration),<ul><li>/// [<code>Time</code>] will be incremented by the fixed timestep each frame, multiplied by the specified factor <code>n</code>.<li>/// This means that a call to [<code>App::update</code>] will always run the fixed loop exactly n times.<li>FixedTimesteps(u32), }</ul><p>/// Channel resource used to receive time from the render world. @@ -144,6 +147,7 @@ pub fn create_time_channels() -> (TimeSender, TimeReceiver) { pub fn time_system( mut real_time: ResMut&LTTime<real>>, mut virtual_time: ResMut&LTTime<virtual>>, <ul><li><p>fixed_time: Res&LTTime<fixed>>, mut time: ResMut<time>, update_strategy: Res<timeupdatestrategy>, #[cfg(feature = “std”)] time_recv: Option&LTRes<timereceiver>>, @@ -175,6 +179,9 @@ pub fn time_system( } TimeUpdateStrategy::ManualInstant(instant) => real_time.update_with_instant(*instant), TimeUpdateStrategy::ManualDuration(duration) => real_time.update_with_duration(*duration), <li><pre style=color:#61676c;background-color:#fafafa><code><span>   TimeUpdateStrategy::FixedTimesteps(factor) => {
</span></code></pre></li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>       real_time.update_with_duration(fixed_time.timestep() * *factor);
</span></code></pre></li> <li><pre style=color:#61676c;background-color:#fafafa><code><span>   }
</span></code></pre> <p>}</p> <p>update_virtual_time(&mut time, &mut virtual_time, &real_time);</p></li>    <div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-11/pr_21705.patch id=patch-info style=display:none></div>  <div class=bottom-spacer></div> 