<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21810 Solari: More reactive world cache
        
    </title><meta content="#21810 Solari: More reactive world cache" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-11/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-11-25</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-11/pr-21810-zh-cn-20251125>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>Solari: More reactive world cache<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Solari: More reactive world cache<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21810<li><strong>Author</strong>: JMS55<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-Rendering, S-Ready-For-Final-Review, C-Refinement<li><strong>Created</strong>: 2025-11-11T22:23:06Z<li><strong>Merged</strong>: 2025-11-25T01:12:50Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><p>Thanks to Guillaume Boissé, the world cache is both more stable in static scenarios, and more reactive in dynamic scenarios!<p>https://bsky.app/profile/gboisse.bsky.social/post/3m5blga3ftk2a<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a fundamental challenge in real-time global illumination: balancing temporal stability against responsiveness to lighting changes. The world cache system in Bevy’s Solari renderer needed to handle both static scenes where lighting remains constant and dynamic scenarios where lighting changes rapidly.<p>The core problem was that the existing implementation used a fixed temporal accumulation approach. It would blend new lighting samples with previous frames using a simple average based on <code>WORLD_CACHE_MAX_TEMPORAL_SAMPLES</code>. While this provided good stability for static scenes, it was too slow to respond when lighting conditions changed dramatically, such as when lights are turned on/off or objects move.<p>The solution introduces an adaptive temporal blending mechanism that monitors luminance changes and adjusts the blending rate accordingly. When lighting is stable, the system maintains high temporal accumulation for noise reduction. When significant lighting changes are detected, it rapidly adapts by reducing the effective sample count, allowing the cache to converge to the new lighting state much faster.<p>The implementation centers around tracking luminance deltas - the changes in brightness between frames. A new <code>world_cache_luminance_deltas</code> buffer was added to store these values for each cache cell. During the update phase, the system calculates the relative luminance change and uses it to compute an adaptive blend factor:<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>let alpha = abs(luminance_delta) / max(luminance(old_radiance.rgb), 0.001);
</span><span>let max_sample_count = mix(WORLD_CACHE_MAX_TEMPORAL_SAMPLES, 1.0, pow(saturate(alpha), 1.0 / 8.0));
</span><span>let blend_amount = 1.0 / min(sample_count, max_sample_count);
</span></code></pre><p>This approach provides the best of both worlds: when luminance changes are small (static scenes), it uses the full temporal accumulation up to the new maximum of 32 samples. When changes are large, it reduces the effective sample count toward 1, making the cache much more responsive.<p>The luminance delta itself is also smoothed over time using an exponential moving average with an 1/8 blend factor, preventing the system from overreacting to transient changes while still tracking persistent lighting shifts.<p>From an architectural perspective, the changes required adding a new storage buffer for luminance deltas and updating multiple shader stages to incorporate this new data. The binding indices were adjusted throughout the pipeline to accommodate the new buffer, and the compaction stage was updated to properly reset luminance deltas when cells are removed.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph LR
</span><span>    A[World Cache System] --> B[Luminance Delta Tracking]
</span><span>    B --> C[Adaptive Blending Logic]
</span><span>    C --> D[Static Scene Optimization]
</span><span>    C --> E[Dynamic Scene Responsiveness]
</span><span>    D --> F[Increased Temporal Samples 10→32]
</span><span>    E --> G[Reduced Effective Samples]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-solari-src-realtime-world-cache-update-wgsl-10-1><code>crates/bevy_solari/src/realtime/world_cache_update.wgsl</code> (+10/-1)</h3><p>This file contains the core adaptive blending logic that makes the world cache responsive to lighting changes.<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Key addition: luminance-based adaptive blending
</span><span>let alpha = abs(luminance_delta) / max(luminance(old_radiance.rgb), 0.001);
</span><span>let max_sample_count = mix(WORLD_CACHE_MAX_TEMPORAL_SAMPLES, 1.0, pow(saturate(alpha), 1.0 / 8.0));
</span><span>let blend_amount = 1.0 / min(sample_count, max_sample_count);
</span><span>
</span><span>let blended_radiance = mix(old_radiance.rgb, new_radiance, blend_amount);
</span><span>let blended_luminance_delta = mix(luminance_delta, luminance(blended_radiance) - luminance(old_radiance.rgb), 1.0 / 8.0);
</span></code></pre><h3 id=crates-bevy-solari-src-realtime-world-cache-query-wgsl-7-6><code>crates/bevy_solari/src/realtime/world_cache_query.wgsl</code> (+7/-6)</h3><p>Updated binding indices and increased maximum temporal samples for better static scene performance.<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>// Increased from 10 to 32 for better static scene quality
</span><span>const WORLD_CACHE_MAX_TEMPORAL_SAMPLES: f32 = 32.0;
</span><span>
</span><span>// Updated bindings to accommodate new luminance_deltas buffer
</span><span>@group(1) @binding(18) var&LTstorage, read_write> world_cache_luminance_deltas: array&LTf32, #{WORLD_CACHE_SIZE}>;
</span></code></pre><h3 id=crates-bevy-solari-src-realtime-world-cache-compact-wgsl-12-1><code>crates/bevy_solari/src/realtime/world_cache_compact.wgsl</code> (+12/-1)</h3><p>Added cleanup for the new luminance deltas buffer when cells are removed.<pre class=language-wgsl data-lang=wgsl style=color:#61676c;background-color:#fafafa><code class=language-wgsl data-lang=wgsl><span>fn decay_world_cache(@builtin(global_invocation_id) global_id: vec3&LTu32>) {
</span><span>    if life == 0u {
</span><span>        world_cache_checksums[global_id.x] = WORLD_CACHE_EMPTY_CELL;
</span><span>        world_cache_radiance[global_id.x] = vec4(0.0);
</span><span>        world_cache_luminance_deltas[global_id.x] = 0.0;  // New cleanup
</span><span>    }
</span><span>}
</span></code></pre><h3 id=crates-bevy-solari-src-realtime-prepare-rs-9-0><code>crates/bevy_solari/src/realtime/prepare.rs</code> (+9/-0)</h3><p>Added buffer creation for the new luminance deltas storage buffer.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>let</span><span> world_cache_luminance_deltas </span><span style=color:#ed9366>=</span><span> render_device</span><span style=color:#ed9366>.</span><span style=color:#f07171>create_buffer</span><span>(</span><span style=color:#ed9366>&</span><span>BufferDescriptor {
</span><span>    label</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Some</span><span>(</span><span style=color:#86b300>"solari_lighting_world_cache_luminance_deltas"</span><span>)</span><span style=color:#61676ccc>,
</span><span>    size</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>WORLD_CACHE_SIZE </span><span style=color:#ed9366>* </span><span>size_of</span><span style=color:#ed9366>::</span><span><</span><span style=color:#fa6e32>f32</span><span>>() </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>u64</span><span style=color:#61676ccc>,
</span><span>    usage</span><span style=color:#61676ccc>: </span><span>BufferUsages</span><span style=color:#ed9366>::</span><span style=color:#ff8f40>STORAGE</span><span style=color:#61676ccc>,
</span><span>    mapped_at_creation</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>false</span><span style=color:#61676ccc>,
</span><span>})</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-solari-src-realtime-node-rs-2-0><code>crates/bevy_solari/src/realtime/node.rs</code> (+2/-0)</h3><p>Updated the node to include the new buffer in its binding set.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Added to the binding list
</span><span>s</span><span style=color:#ed9366>.</span><span>world_cache_luminance_deltas</span><span style=color:#ed9366>.</span><span style=color:#f07171>as_entire_binding</span><span>()</span><span style=color:#61676ccc>,
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bsky.app/profile/gboisse.bsky.social/post/3m5blga3ftk2a target=_blank>Original inspiration from Guillaume Boissé</a><li>Temporal anti-aliasing and accumulation techniques in real-time rendering<li>Exponential moving averages for signal smoothing<li>Luminance calculations and their applications in graphics programming</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-11/pr_21810.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>