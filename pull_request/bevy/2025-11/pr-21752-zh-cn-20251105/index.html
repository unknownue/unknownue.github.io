<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21752 Fix dragging bug in drag_to_scroll example
        
    </title><meta content="#21752 Fix dragging bug in drag_to_scroll example" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-11/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-11-05</span><div class=language-switcher><a class=lang-link data-lang=en href=/pull_request/bevy/2025-11/pr-21752-en-20251105>English</a> / <span class="lang-link active" data-lang=zh-cn>中文</span></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Fix dragging bug in drag_to_scroll example<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21752<li><strong>Author</strong>: rudderbucky<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Bug, C-Examples, A-UI, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-11-05T13:49:27Z<li><strong>Merged</strong>: 2025-11-05T19:26:21Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=mu-biao>目标</h1><p>修复 #21675。问题在于拖拽开始的位置从未被保存，因此每次新的拖拽都会强制将网格重置到初始位置。<p>原始的实体层次结构包含一个 <code>ScrollableNode</code>，它有一个子节点（网格父节点），该子节点本身又有一系列子节点（网格瓦片）。只有网格节点具有 <code>Pickable</code> 组件。<p>原始代码中存在几个问题：<ul><li>由于网格瓦片设置了 <code>should_block_lower = false</code> 和 <code>is_hoverable = true</code>，它们会允许拖拽事件传播到网格父节点。由于网格父节点没有 <code>Pickable</code> 组件，它会阻止进一步传播但不会触发滚动事件。这导致 <code>ScrollableNode</code> 观察到两个滚动事件。<li>然而，这两个事件都不是 <code>ScrollableNode</code> 实体本身，因此两个事件都无法通过原始代码第59行的检查（<code>drag_start.entity != drag_start.original_event_target()</code>）。</ul><h2 id=jie-jue-fang-an>解决方案</h2><p>我尝试修复这两个问题：<ul><li>为网格父节点添加 <code>Pickable</code> 组件，设置 <code>should_block_lower = true</code> 和 <code>is_hoverable = false</code>。这样它既不会触发事件也不会进一步传播。这确保了只有一个滚动事件通过。<li>移除第59行的实体检查，因为它不再必要。</ul><h2 id=ce-shi>测试</h2><p>在 macOS 上测试，似乎工作正常。<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>这个PR解决了一个在Bevy引擎UI示例中的拖拽滚动bug。问题的核心在于事件传播机制和实体层次结构之间的不匹配。<p><strong>问题背景</strong> 在原始的 <code>drag_to_scroll</code> 示例中，开发者遇到了一个令人困惑的行为：每次开始拖拽时，网格都会重置到初始位置，而不是从当前位置继续滚动。通过分析问题 #21675，作者发现根本原因在于拖拽开始位置的计算逻辑存在问题。<p><strong>技术分析</strong> 问题的技术根源在于Bevy的事件系统和UI实体层次结构的交互方式。在原始实现中：<ul><li><code>ScrollableNode</code>（可滚动节点）包含一个网格父节点<li>网格父节点包含多个网格瓦片子节点<li>只有网格瓦片具有 <code>Pickable</code> 组件，用于处理交互</ul><p>由于网格瓦片配置为 <code>should_block_lower = false</code> 和 <code>is_hoverable = true</code>，当用户拖拽时：<ol><li>拖拽事件首先在网格瓦片上触发<li>由于 <code>should_block_lower = false</code>，事件传播到网格父节点<li>网格父节点没有 <code>Pickable</code> 组件，但会阻止事件进一步传播<li>这导致系统观察到两个不同的拖拽事件</ol><p>更关键的是，原始代码中的检查逻辑：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>if</span><span> drag_start</span><span style=color:#ed9366>.</span><span>entity </span><span style=color:#ed9366>!=</span><span> drag_start</span><span style=color:#ed9366>.</span><span style=color:#f07171>original_event_target</span><span>() {
</span><span>    </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>这个检查阻止了正确的滚动位置更新，因为事件目标实体与期望的实体不匹配。<p><strong>解决方案实现</strong> 作者采用了双重修复策略来解决这个问题：<p>首先，在网格父节点上添加了适当的 <code>Pickable</code> 组件：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((
</span><span>    Node {
</span><span>        display</span><span style=color:#61676ccc>: </span><span>Display</span><span style=color:#ed9366>::</span><span>Grid</span><span style=color:#61676ccc>,
</span><span>        grid_template_rows</span><span style=color:#61676ccc>: </span><span>RepeatedGridTrack</span><span style=color:#ed9366>::</span><span>px(w </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>i32</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>100.</span><span>)</span><span style=color:#61676ccc>,
</span><span>        grid_template_columns</span><span style=color:#61676ccc>: </span><span>RepeatedGridTrack</span><span style=color:#ed9366>::</span><span>px(h </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>i32</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>100.</span><span>)</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#ed9366>..</span><span style=color:#f07171>default</span><span>()
</span><span>    }</span><span style=color:#61676ccc>,
</span><span>    Pickable {
</span><span>        is_hoverable</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>false</span><span style=color:#61676ccc>,
</span><span>        should_block_lower</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>true</span><span style=color:#61676ccc>,
</span><span>    }
</span><span>))
</span></code></pre><p>这个配置确保：<ul><li><code>is_hoverable: false</code> - 网格父节点不会干扰悬停检测<li><code>should_block_lower: true</code> - 事件在网格父节点处被正确处理，不会产生重复事件</ul><p>其次，移除了有问题的实体检查：<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 移除的代码：
</span><span style=color:#abb0b6;font-style:italic>// if drag_start.entity != drag_start.original_event_target() {
</span><span style=color:#abb0b6;font-style:italic>//     return;
</span><span style=color:#abb0b6;font-style:italic>// }
</span></code></pre><p><strong>技术洞察</strong> 这个修复展示了Bevy事件系统中一个重要概念：事件传播链的管理。通过正确配置 <code>Pickable</code> 组件的属性，开发者可以精确控制事件如何在UI层次结构中传播。<p>关键的技术要点：<ol><li><strong>事件传播控制</strong>：<code>should_block_lower</code> 控制事件是否继续向下传播<li><strong>悬停行为</strong>：<code>is_hoverable</code> 决定组件是否参与悬停检测<li><strong>实体层次关系</strong>：在复杂的UI结构中，需要仔细考虑事件目标和实体关系</ol><p><strong>影响评估</strong> 这个修复虽然只涉及示例代码，但具有重要的教育价值：<ul><li>为其他开发者展示了正确处理UI拖拽事件的方法<li>演示了如何调试和修复事件传播问题<li>提供了配置 <code>Pickable</code> 组件的最佳实践</ul><p>修复后，拖拽滚动行为变得平滑和可预测，从用户体验角度提供了显著的改进。<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TB
</span><span>    A[ScrollableNode] --> B[Grid Parent Node]
</span><span>    B --> C[Grid Tile 1]
</span><span>    B --> D[Grid Tile 2]
</span><span>    B --> E[Grid Tile N]
</span><span>    
</span><span>    style A fill:#e1f5fe
</span><span>    style B fill:#f3e5f5
</span><span>    style C fill:#f1f8e9
</span><span>    style D fill:#f1f8e9
</span><span>    style E fill:#f1f8e9
</span></code></pre><p><strong>图例说明</strong>：<ul><li><strong>蓝色</strong>：ScrollableNode - 处理滚动的根节点<li><strong>紫色</strong>：Grid Parent Node - 新增Pickable组件的网格父节点<li><strong>绿色</strong>：Grid Tiles - 原有的可交互网格瓦片</ul><h2 id=key-files-changed>Key Files Changed</h2><h3 id=examples-ui-drag-to-scroll-rs-13-10><code>examples/ui/drag_to_scroll.rs</code> (+13/-10)</h3><p>这个文件包含了修复拖拽滚动bug的所有关键修改。<p><strong>主要修改</strong>：<ol><li><strong>移除实体检查逻辑</strong>：</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 移除的代码：
</span><span style=color:#abb0b6;font-style:italic>// if drag_start.entity != drag_start.original_event_target() {
</span><span style=color:#abb0b6;font-style:italic>//     return;
</span><span style=color:#abb0b6;font-style:italic>// }
</span></code></pre><p>这个检查原本用于防止错误的事件处理，但由于事件传播机制的问题，它实际上阻止了正确的滚动位置更新。<ol start=2><li><strong>为网格父节点添加Pickable组件</strong>：</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 修改前：
</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>(Node {
</span><span>    display</span><span style=color:#61676ccc>: </span><span>Display</span><span style=color:#ed9366>::</span><span>Grid</span><span style=color:#61676ccc>,
</span><span>    grid_template_rows</span><span style=color:#61676ccc>: </span><span>RepeatedGridTrack</span><span style=color:#ed9366>::</span><span>px(w </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>i32</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>100.</span><span>)</span><span style=color:#61676ccc>,
</span><span>    grid_template_columns</span><span style=color:#61676ccc>: </span><span>RepeatedGridTrack</span><span style=color:#ed9366>::</span><span>px(h </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>i32</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>100.</span><span>)</span><span style=color:#61676ccc>,
</span><span>    </span><span style=color:#ed9366>..</span><span style=color:#f07171>default</span><span>()
</span><span>})
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 修改后：
</span><span style=color:#ed9366>.</span><span style=color:#f07171>spawn</span><span>((
</span><span>    Node {
</span><span>        display</span><span style=color:#61676ccc>: </span><span>Display</span><span style=color:#ed9366>::</span><span>Grid</span><span style=color:#61676ccc>,
</span><span>        grid_template_rows</span><span style=color:#61676ccc>: </span><span>RepeatedGridTrack</span><span style=color:#ed9366>::</span><span>px(w </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>i32</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>100.</span><span>)</span><span style=color:#61676ccc>,
</span><span>        grid_template_columns</span><span style=color:#61676ccc>: </span><span>RepeatedGridTrack</span><span style=color:#ed9366>::</span><span>px(h </span><span style=color:#ed9366>as </span><span style=color:#fa6e32>i32</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>100.</span><span>)</span><span style=color:#61676ccc>,
</span><span>        </span><span style=color:#ed9366>..</span><span style=color:#f07171>default</span><span>()
</span><span>    }</span><span style=color:#61676ccc>,
</span><span>    Pickable {
</span><span>        is_hoverable</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>false</span><span style=color:#61676ccc>,
</span><span>        should_block_lower</span><span style=color:#61676ccc>: </span><span style=color:#ff8f40>true</span><span style=color:#61676ccc>,
</span><span>    }
</span><span>))
</span></code></pre><p>这个修改确保了事件在网格父节点层面被正确处理，避免了重复的事件传播。<ol start=3><li><strong>更新事件监听器签名</strong>：</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// 修改前：
</span><span style=color:#ed9366>|</span><span>drag_start</span><span style=color:#61676ccc>: </span><span>On&LTPointer&LTDragStart>></span><span style=color:#61676ccc>,
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 修改后：
</span><span style=color:#ed9366>|_</span><span style=color:#61676ccc>: </span><span>On&LTPointer&LTDragStart>></span><span style=color:#61676ccc>,
</span></code></pre><p>由于不再需要检查drag_start的具体属性，参数被简化。<h2 id=further-reading>Further Reading</h2><p>对于想要深入了解相关概念的开发者，建议参考：<ol><li><p><strong>Bevy官方文档</strong>：</p> <ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/books/introduction/ui target=_blank>Bevy UI 系统</a> - 了解Bevy的UI架构<li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/books/introduction/events target=_blank>事件系统</a> - 掌握Bevy事件处理机制</ul><li><p><strong>Pickable组件文档</strong>：</p> <ul><li><code>Pickable</code> 组件的详细属性和行为说明</ul><li><p><strong>相关PR和Issue</strong>：</p> <ul><li>原始问题 #21675<li>其他UI交互相关的PR和示例</ul></ol><h1 id=full-code-diff>Full Code Diff</h1><pre style=color:#61676c;background-color:#fafafa><code><span>diff --git a/examples/ui/drag_to_scroll.rs b/examples/ui/drag_to_scroll.rs
</span><span>index 7de099e02602a..54a63a442cfd6 100644
</span><span>--- a/examples/ui/drag_to_scroll.rs
</span><span>+++ b/examples/ui/drag_to_scroll.rs
</span><span>@@ -51,14 +51,11 @@ fn setup(mut commands: Commands) {
</span><span>             },
</span><span>         )
</span><span>         .observe(
</span><span>-            |drag_start: On&LTPointer&LTDragStart>>,
</span><span>+            |_: On&LTPointer&LTDragStart>>,
</span><span>              mut scroll_position_query: Query<
</span><span>                 (&ComputedNode, &mut ScrollStart),
</span><span>                 With&LTScrollableNode>,
</span><span>             >| {
</span><span>-                if drag_start.entity != drag_start.original_event_target() {
</span><span>-                    return;
</span><span>-                }
</span><span>                 if let Ok((computed_node, mut start)) = scroll_position_query.single_mut() {
</span><span>                     start.0 = computed_node.scroll_position * computed_node.inverse_scale_factor;
</span><span>                 }
</span><span>@@ -66,12 +63,18 @@ fn setup(mut commands: Commands) {
</span><span>         )
</span><span>         .with_children(|commands| {
</span><span>             commands
</span><span>-                .spawn(Node {
</span><span>-                    display: Display::Grid,
</span><span>-                    grid_template_rows: RepeatedGridTrack::px(w as i32, 100.),
</span><span>-                    grid_template_columns: RepeatedGridTrack::px(h as i32, 100.),
</span><span>-                    ..default()
</span><span>-                })
</span><span>+                .spawn((
</span><span>+                    Node {
</span><span>+                        display: Display::Grid,
</span><span>+                        grid_template_rows: RepeatedGridTrack::px(w as i32, 100.),
</span><span>+                        grid_template_columns: RepeatedGridTrack::px(h as i32, 100.),
</span><span>+                        ..default()
</span><span>+                    },
</span><span>+                    Pickable {
</span><span>+                        is_hoverable: false,
</span><span>+                        should_block_lower: true,
</span><span>+                    }
</span><span>+                ))
</span><span>                 .with_children(|commands| {
</span><span>                     for y in 0..h {
</span><span>                         for x in 0..w {
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-11/pr_21752.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>