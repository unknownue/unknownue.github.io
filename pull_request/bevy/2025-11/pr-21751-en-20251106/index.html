<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21751 Shortcircuit `SceneInstanceReady` on models that do not have `ColorOverride`
        
    </title><meta content="#21751 Shortcircuit `SceneInstanceReady` on models that do not have `ColorOverride`" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-11/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-11-06</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-11/pr-21751-zh-cn-20251106>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Shortcircuit <code>SceneInstanceReady</code> on models that do not have <code>ColorOverride</code><li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21751<li><strong>Author</strong>: hukasu<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: C-Examples, A-Assets, C-Code-Quality, S-Ready-For-Final-Review<li><strong>Created</strong>: 2025-11-05T12:24:46Z<li><strong>Merged</strong>: 2025-11-06T18:49:09Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><p>The <code>edit_material_on_gltf</code> example was iterating over all materials of a Gltf even when it did not have <code>ColorOverride</code>.<h2 id=solution>Solution</h2><p>Shortcircuit observer if scene does not have <code>ColorOverride</code><h2 id=testing>Testing</h2><p>Ran the example<h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a performance issue in the <code>edit_material_on_gltf</code> example where unnecessary processing was occurring. The problem was straightforward: when a scene instance became ready, the system would iterate through all descendant entities and their materials, even when there was no color override to apply.<p>The core issue was in the control flow. The original implementation checked for the <code>ColorOverride</code> component inside the loop that iterated over scene descendants, after already performing several other checks and operations. This meant that even when no color override was present, the system would still:<ol><li>Iterate through all descendant entities<li>Check each entity for material components<li>Validate material names<li>Only then skip the actual color modification</ol><p>The solution implemented a short-circuit pattern by moving the <code>ColorOverride</code> check to the very beginning of the system function. Now, when a <code>SceneInstanceReady</code> event fires, the system immediately checks if the scene entity has a <code>ColorOverride</code> component. If it doesn’t, the function returns early, avoiding all the expensive descendant iteration and material checking.<p>This change demonstrates a common optimization pattern in ECS systems: placing the most restrictive conditions first to minimize unnecessary work. The performance improvement scales with scene complexity - larger scenes with more entities and materials benefit more from this optimization.<p>The implementation also improved code clarity by adding better documentation. The comments now clearly explain that the system only modifies materials named “LeatherPartsMat” and explicitly mentions the short-circuiting behavior when no <code>ColorOverride</code> is present.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[SceneInstanceReady Event] --> B{Has ColorOverride?}
</span><span>    B -->|No| C[Return Early]
</span><span>    B -->|Yes| D[Iterate Descendants]
</span><span>    D --> E{Has Material Components?}
</span><span>    E -->|Yes| F{Material Name = LeatherPartsMat?}
</span><span>    F -->|Yes| G[Apply Color Override]
</span><span>    F -->|No| H[Continue]
</span><span>    E -->|No| H
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><p><strong>File:</strong> <code>examples/gltf/edit_material_on_gltf.rs</code> (+12/-5)<p>This is the only file modified in the PR. The changes focus on optimizing the material modification system and improving documentation.<h3 id=key-changes>Key Changes:</h3><ol><li><strong>Documentation Improvements:</strong></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#abb0b6;font-style:italic>/// This is added to a [`SceneRoot`] and will cause the [`StandardMaterial::base_color`]
</span><span style=color:#abb0b6;font-style:italic>/// of all materials to be overwritten
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#abb0b6;font-style:italic>/// This is added to a [`SceneRoot`] and will cause the [`StandardMaterial::base_color`]
</span><span style=color:#abb0b6;font-style:italic>/// of materials with [`GltfMaterialName`] equal to `LeatherPartsMat`.
</span></code></pre><ol start=2><li><strong>Early Return Implementation:</strong></ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>change_material</span><span>(
</span><span>    </span><span style=color:#ff8f40>scene_ready</span><span style=color:#61676ccc>: </span><span>On&LTSceneInstanceReady>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands,
</span><span>    </span><span style=color:#ff8f40>children</span><span style=color:#61676ccc>: </span><span>Query<</span><span style=color:#ed9366>&</span><span>Children>,
</span><span>    </span><span style=color:#ff8f40>color_override</span><span style=color:#61676ccc>: </span><span>Query<</span><span style=color:#ed9366>&</span><span>ColorOverride>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>materials</span><span style=color:#61676ccc>: </span><span>Query<(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span>Handle&LTStandardMaterial>, </span><span style=color:#ed9366>&</span><span>GltfMaterialName)>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>asset_materials</span><span style=color:#61676ccc>: </span><span>ResMut&LTAssets&LTStandardMaterial>>,
</span><span>) {
</span><span>    </span><span style=color:#f07171>info!</span><span>(</span><span style=color:#86b300>"processing Scene Entity: {}"</span><span style=color:#61676ccc>,</span><span> scene_ready</span><span style=color:#ed9366>.</span><span>entity)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Iterate over all children recursively
</span><span>    </span><span style=color:#fa6e32>for</span><span> descendant </span><span style=color:#ed9366>in</span><span> children</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter_descendants</span><span>(scene_ready</span><span style=color:#ed9366>.</span><span>entity) {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ... material checking logic ...
</span><span>        </span><span style=color:#fa6e32>match</span><span> material_name</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0.</span><span style=color:#f07171>as_str</span><span>() {
</span><span>            </span><span style=color:#86b300>"LeatherPartsMat" </span><span style=color:#ed9366>=> </span><span>{
</span><span>                </span><span style=color:#abb0b6;font-style:italic>// ColorOverride check was inside the match arm
</span><span>                </span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(color_override) </span><span style=color:#ed9366>=</span><span> color_override</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(scene_ready</span><span style=color:#ed9366>.</span><span>entity) </span><span style=color:#fa6e32>else </span><span>{
</span><span>                    </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>                }</span><span style=color:#61676ccc>;
</span><span>                </span><span style=color:#abb0b6;font-style:italic>// ... color modification logic ...
</span><span>            }
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>change_material</span><span>(
</span><span>    </span><span style=color:#ff8f40>scene_ready</span><span style=color:#61676ccc>: </span><span>On&LTSceneInstanceReady>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>commands</span><span style=color:#61676ccc>:</span><span> Commands,
</span><span>    </span><span style=color:#ff8f40>children</span><span style=color:#61676ccc>: </span><span>Query<</span><span style=color:#ed9366>&</span><span>Children>,
</span><span>    </span><span style=color:#ff8f40>color_override</span><span style=color:#61676ccc>: </span><span>Query<</span><span style=color:#ed9366>&</span><span>ColorOverride>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>materials</span><span style=color:#61676ccc>: </span><span>Query<(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span>Handle&LTStandardMaterial>, </span><span style=color:#ed9366>&</span><span>GltfMaterialName)>,
</span><span>    </span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>asset_materials</span><span style=color:#61676ccc>: </span><span>ResMut&LTAssets&LTStandardMaterial>>,
</span><span>) {
</span><span>    </span><span style=color:#f07171>info!</span><span>(</span><span style=color:#86b300>"processing Scene Entity: {}"</span><span style=color:#61676ccc>,</span><span> scene_ready</span><span style=color:#ed9366>.</span><span>entity)</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Get the `ColorOverride` of the entity, if it does not have a color override, return
</span><span>    </span><span style=color:#fa6e32>let </span><span style=color:#55b4d4;font-style:italic>Ok</span><span>(color_override) </span><span style=color:#ed9366>=</span><span> color_override</span><span style=color:#ed9366>.</span><span style=color:#f07171>get</span><span>(scene_ready</span><span style=color:#ed9366>.</span><span>entity) </span><span style=color:#fa6e32>else </span><span>{
</span><span>        </span><span style=color:#f07171>info!</span><span>(</span><span style=color:#86b300>"{} does not have a color override"</span><span style=color:#61676ccc>,</span><span> scene_ready</span><span style=color:#ed9366>.</span><span>entity)</span><span style=color:#61676ccc>;
</span><span>        </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span>    }</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Rest of the iteration logic remains but now only runs when needed
</span><span>    </span><span style=color:#fa6e32>for</span><span> descendant </span><span style=color:#ed9366>in</span><span> children</span><span style=color:#ed9366>.</span><span style=color:#f07171>iter_descendants</span><span>(scene_ready</span><span style=color:#ed9366>.</span><span>entity) {
</span><span>        </span><span style=color:#abb0b6;font-style:italic>// ... material checking logic ...
</span><span>        </span><span style=color:#fa6e32>match</span><span> material_name</span><span style=color:#ed9366>.</span><span style=color:#ff8f40>0.</span><span style=color:#f07171>as_str</span><span>() {
</span><span>            </span><span style=color:#86b300>"LeatherPartsMat" </span><span style=color:#ed9366>=> </span><span>{
</span><span>                </span><span style=color:#abb0b6;font-style:italic>// ColorOverride is now available from the early check
</span><span>                </span><span style=color:#abb0b6;font-style:italic>// ... color modification logic using color_override ...
</span><span>            }
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre><p>The key insight here is moving the <code>ColorOverride</code> query check outside the loop, which transforms an O(n) operation (where n is the number of descendants) into an O(1) check for the common case where no color override is present.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/programming/system-params.html target=_blank>Bevy ECS System Optimization Patterns</a><li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy/latest/bevy/ecs/system/struct.Query.html target=_blank>Bevy Query Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/programming/system-commands.html#early-return target=_blank>Early Return Pattern in Systems</a></ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-11/pr_21751.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>