<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #19363 enable same state transitions
        
    </title><meta content="#19363 enable same state transitions" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-11/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-11-12</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-11/pr-19363-zh-cn-20251112>中文</a></div></div><div class=pr-content><h1 id=title>Title</h1><p>enable same state transitions<h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: enable same state transitions<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/19363<li><strong>Author</strong>: mockersf<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: S-Ready-For-Final-Review, M-Migration-Guide, X-Contentious, A-States<li><strong>Created</strong>: 2025-05-25T22:01:41Z<li><strong>Merged</strong>: 2025-11-09T18:18:33Z<li><strong>Merged By</strong>: alice-i-cecile</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>Same state transitions have their uses but are not currently possible</ul><h2 id=solution>Solution</h2><ul><li>Add a <code>set_forced</code> method on <code>NextState</code> that will trigger <code>OnEnter</code> and <code>OnExit</code><li>Rerun state transitions when <code>set_forced</code> has been used<li>Rerun them is <code>set</code> is called <em>after</em> <code>set_forced</code> with the same state</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><h3 id=the-problem-and-context>The Problem and Context</h3><p>In Bevy’s state management system, state transitions were designed to only trigger <code>OnEnter</code> and <code>OnExit</code> schedules when moving between different states. This was an intentional optimization to avoid unnecessary system runs when the state didn’t actually change. However, this design prevented legitimate use cases where developers needed to re-run state transition logic even when remaining in the same state.<p>Common scenarios where same-state transitions are useful include:<ul><li>Resetting a game level while staying in the same gameplay state<li>Reinitializing UI components without changing the overall UI state<li>Reloading configuration or assets associated with a particular state</ul><p>The existing <code>NextState::set()</code> method would silently ignore requests to transition to the current state, making these use cases impossible to implement cleanly.<h3 id=the-solution-approach>The Solution Approach</h3><p>The developer approached this problem by introducing a new forced transition mechanism that preserves the existing optimization by default while providing an escape hatch for when same-state transitions are needed. The key insight was to distinguish between “optimized” transitions (the default behavior) and “forced” transitions (the new capability).<p>Rather than modifying the existing <code>set()</code> method’s behavior, which could break existing code, the solution introduced a new <code>set_forced()</code> method that explicitly opts into same-state transitions. This maintains backward compatibility while enabling the new functionality.<h3 id=the-implementation>The Implementation</h3><p>The implementation required changes across multiple layers of the state system:<ol><li><strong>Extended NextState Enum</strong>: Added a new <code>ForcedPending</code> variant alongside the existing <code>Pending</code> variant:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub enum </span><span style=color:#399ee6>NextState</span><span>&LTS: FreelyMutableState> {
</span><span>    Unchanged</span><span style=color:#61676ccc>,
</span><span>    Pending(S)</span><span style=color:#61676ccc>,
</span><span>    ForcedPending(S)</span><span style=color:#61676ccc>,
</span><span>}
</span></code></pre><ol start=2><li><strong>New Public API</strong>: Added the <code>set_forced()</code> method that creates forced transitions:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>set_forced</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>state</span><span style=color:#61676ccc>:</span><span> S) {
</span><span>    </span><span style=color:#ed9366>*</span><span style=color:#55b4d4;font-style:italic>self </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>ForcedPending(state)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><ol start=3><li><strong>Enhanced Transition Logic</strong>: Modified the state transition system to track whether a transition was forced and respect this flag throughout the transition pipeline:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub</span><span>(</span><span style=color:#fa6e32>crate</span><span>) </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>take_next_state</span><span>&LTS</span><span style=color:#61676ccc>:</span><span> FreelyMutableState>(
</span><span>    </span><span style=color:#ff8f40>next_state</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTResMut&LTNextState&LTS>>>,
</span><span>) </span><span style=color:#61676ccc>-> </span><span style=color:#55b4d4;font-style:italic>Option</span><span><(S, </span><span style=color:#fa6e32>bool</span><span>)> {
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Returns both the state and whether it was forced
</span><span>}
</span></code></pre><ol start=4><li><strong>Updated Event System</strong>: Extended <code>StateTransitionEvent</code> to include a <code>same_state_enforced</code> field, allowing downstream systems to react differently to forced transitions:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>pub struct </span><span style=color:#399ee6>StateTransitionEvent</span><span>&LTS</span><span style=color:#61676ccc>:</span><span> States> {
</span><span>    </span><span style=color:#fa6e32>pub </span><span>exited</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTS>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>entered</span><span style=color:#61676ccc>: </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTS>,
</span><span>    </span><span style=color:#fa6e32>pub </span><span>same_state_enforced</span><span style=color:#61676ccc>: </span><span style=color:#fa6e32>bool</span><span>,
</span><span>}
</span></code></pre><ol start=5><li><strong>Modified Schedule Execution</strong>: Updated the <code>run_enter</code> and <code>run_exit</code> systems to check the forced flag before skipping same-state transitions:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>if</span><span> transition</span><span style=color:#ed9366>.</span><span>entered </span><span style=color:#ed9366>==</span><span> transition</span><span style=color:#ed9366>.</span><span>exited </span><span style=color:#ed9366>&& !</span><span>transition</span><span style=color:#ed9366>.</span><span>same_state_enforced {
</span><span>    </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=technical-insights>Technical Insights</h3><p>The implementation demonstrates several important software engineering principles:<p><strong>Backward Compatibility</strong>: By introducing a new method rather than changing existing behavior, the change is non-breaking. Existing code using <code>set()</code> continues to work exactly as before.<p><strong>Explicit vs Implicit</strong>: The design forces developers to explicitly opt into same-state transitions using <code>set_forced()</code>, making the intent clear in the code and preventing accidental performance regressions.<p><strong>Data Flow Preservation</strong>: The solution maintains the existing data flow patterns by simply extending them with additional context (the forced flag) rather than restructuring the entire system.<p><strong>Comprehensive Coverage</strong>: The changes propagate the forced flag through all the different state management patterns in Bevy, including <code>StateSet</code>, <code>FreelyMutableState</code>, and the various state transition systems.<h3 id=the-impact>The Impact</h3><p>This change enables several previously impossible patterns:<ul><li><strong>State Reset</strong>: Games can now completely reset a level or scene while remaining in the same gameplay state<li><strong>Hot Reloading</strong>: Development tools can force state systems to reinitialize when assets or configurations change<li><strong>Debug Utilities</strong>: Developers can manually trigger state transition logic for testing and debugging purposes</ul><p>The performance characteristics remain optimal by default - regular <code>set()</code> calls continue to skip unnecessary transitions, while <code>set_forced()</code> provides the escape hatch when needed.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[NextState::set] --> B[Pending State]
</span><span>    C[NextState::set_forced] --> D[ForcedPending State]
</span><span>    B --> E[take_next_state returns state, false]
</span><span>    D --> F[take_next_state returns state, true]
</span><span>    E --> G[internal_apply_state_transition]
</span><span>    F --> G
</span><span>    G --> H[StateTransitionEvent with same_state_enforced]
</span><span>    H --> I[run_enter/run_exit systems]
</span><span>    I --> J{Check same_state_enforced}
</span><span>    J -->|true| K[Run schedules]
</span><span>    J -->|false| L[Skip if same state]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-state-src-state-resources-rs-26-3><code>crates/bevy_state/src/state/resources.rs</code> (+26/-3)</h3><p>This file contains the core <code>NextState</code> resource implementation.<p><strong>Key Changes:</strong><ul><li>Added <code>ForcedPending</code> variant to the <code>NextState</code> enum<li>Implemented <code>set_forced()</code> method<li>Modified <code>take_next_state()</code> to return both state and forced flag</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>pub enum </span><span style=color:#399ee6>NextState</span><span>&LTS: FreelyMutableState> {
</span><span>    Unchanged</span><span style=color:#61676ccc>,
</span><span>    Pending(S)</span><span style=color:#61676ccc>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>pub enum </span><span style=color:#399ee6>NextState</span><span>&LTS: FreelyMutableState> {
</span><span>    Unchanged</span><span style=color:#61676ccc>,
</span><span>    Pending(S)</span><span style=color:#61676ccc>,
</span><span>    ForcedPending(S)</span><span style=color:#61676ccc>,
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// New method:
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>set_forced</span><span>(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ff8f40>self</span><span>, </span><span style=color:#ff8f40>state</span><span style=color:#61676ccc>:</span><span> S) {
</span><span>    </span><span style=color:#ed9366>*</span><span style=color:#55b4d4;font-style:italic>self </span><span style=color:#ed9366>= </span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>::</span><span>ForcedPending(state)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=crates-bevy-state-src-state-transitions-rs-8-2><code>crates/bevy_state/src/state/transitions.rs</code> (+8/-2)</h3><p>This file handles the actual state transition logic.<p><strong>Key Changes:</strong><ul><li>Added <code>same_state_enforced</code> field to <code>StateTransitionEvent</code><li>Modified transition logic to respect the forced flag<li>Updated <code>run_enter</code> and <code>run_exit</code> systems to check forced transitions</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>if</span><span> transition</span><span style=color:#ed9366>.</span><span>entered </span><span style=color:#ed9366>==</span><span> transition</span><span style=color:#ed9366>.</span><span>exited {
</span><span>    </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>if</span><span> transition</span><span style=color:#ed9366>.</span><span>entered </span><span style=color:#ed9366>==</span><span> transition</span><span style=color:#ed9366>.</span><span>exited </span><span style=color:#ed9366>&& !</span><span>transition</span><span style=color:#ed9366>.</span><span>same_state_enforced {
</span><span>    </span><span style=color:#fa6e32>return</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=crates-bevy-state-src-state-state-set-rs-36-7><code>crates/bevy_state/src/state/state_set.rs</code> (+36/-7)</h3><p>This file handles state sets and their transitions.<p><strong>Key Changes:</strong><ul><li>Updated multiple state transition functions to pass through the forced flag<li>Modified macro-generated code to handle forced transitions</ul><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Example of updated function call:
</span><span style=color:#f07171>internal_apply_state_transition</span><span>(
</span><span>    event</span><span style=color:#61676ccc>,
</span><span>    commands</span><span style=color:#61676ccc>, 
</span><span>    current_state_res</span><span style=color:#61676ccc>,
</span><span>    new_state</span><span style=color:#61676ccc>,
</span><span>    same_state_enforced</span><span style=color:#61676ccc>,  </span><span style=color:#abb0b6;font-style:italic>// New parameter
</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=release-content-migration-guides-same-state-transitions-md-13-0><code>release-content/migration-guides/same_state_transitions.md</code> (+13/-0)</h3><p><strong>Key Changes:</strong><ul><li>Added comprehensive migration guide<li>Provided clear code examples showing before/after usage</ul><pre class=language-markdown data-lang=markdown style=color:#61676c;background-color:#fafafa><code class=language-markdown data-lang=markdown><span>It is now possible to change to the same state, triggering state transitions.
</span><span>
</span><span>```</span><span style=color:#ff8f40>rust
</span><span style=color:#abb0b6;background-color:#61676c07;font-style:italic>// Before: did nothing if the state was already `State::Menu`
</span><span style=color:#61676c;background-color:#61676c07>next_state</span><span style=color:#ed9366;background-color:#61676c07>.</span><span style=color:#f07171;background-color:#61676c07>set</span><span style=color:#61676c;background-color:#61676c07>(State</span><span style=color:#ed9366;background-color:#61676c07>::</span><span style=color:#61676c;background-color:#61676c07>Menu)</span><span style=color:#61676ccc;background-color:#61676c07>;
</span><span style=color:#abb0b6;background-color:#61676c07;font-style:italic>// After: trigger state transitions even if the state is already `State::Menu`
</span><span style=color:#61676c;background-color:#61676c07>next_state</span><span style=color:#ed9366;background-color:#61676c07>.</span><span style=color:#f07171;background-color:#61676c07>set_forced</span><span style=color:#61676c;background-color:#61676c07>(State</span><span style=color:#ed9366;background-color:#61676c07>::</span><span style=color:#61676c;background-color:#61676c07>Menu)</span><span style=color:#61676ccc;background-color:#61676c07>;
</span></code></pre><pre style=color:#61676c;background-color:#fafafa><code><span>
</span><span>### `crates/bevy_dev_tools/src/states.rs` (+9/-2)
</span><span>**Key Changes:**
</span><span>- Updated debug logging to include the forced transition flag
</span><span>- Enhanced transition event formatting
</span><span>
</span><span>```rust
</span><span>// Updated logging to show forced transitions:
</span><span>info!(
</span><span>    "{} transition: {:?} => {:?} | same state enforced: {:?}",
</span><span>    name, exited, entered, same_state_enforced
</span><span>);
</span></code></pre><h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://bevyengine.org/learn/quick-start/states/ target=_blank>Bevy States Documentation</a><li><a rel="noopener nofollow noreferrer" href=https://bevy-cheatbook.github.io/programming/states.html target=_blank>State Transition Systems in Bevy</a><li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/discussions/3406 target=_blank>Entity Component System Patterns</a></ul><h1 id=full-code-diff>Full Code Diff</h1><p><em>(Note: This is a subset of the most relevant changes)</em><pre class=language-diff data-lang=diff style=color:#61676c;background-color:#fafafa><code class=language-diff data-lang=diff><span>diff --git a/crates/bevy_state/src/state/resources.rs b/crates/bevy_state/src/state/resources.rs
</span><span>index 4bbe6d1b1f24e..0f5f0246289c7 100644
</span><span style=color:#c594c5>--- a/crates/bevy_state/src/state/resources.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_state/src/state/resources.rs
</span><span style=color:#c594c5>@@ -127,12 +127,31 @@ </span><span style=color:#399ee6>pub enum NextState&LTS: FreelyMutableState> {
</span><span>     Unchanged,
</span><span>     /// There is a pending transition for state `S`
</span><span>     Pending(S),
</span><span style=color:#86b300>+    /// There is a pending transition for state `S`
</span><span style=color:#86b300>+    ///
</span><span style=color:#86b300>+    /// This will trigger state transitions schedules even if the target state is the same as the current one.
</span><span style=color:#86b300>+    ForcedPending(S),
</span><span> }
</span><span> 
</span><span> impl&LTS: FreelyMutableState> NextState&LTS> {
</span><span>     /// Tentatively set a pending state transition to `Some(state)`.
</span><span style=color:#86b300>+    ///
</span><span style=color:#86b300>+    /// If `state` is the same as the current state, this will *not* trigger state
</span><span style=color:#86b300>+    /// transition [`OnEnter`](crate::state::OnEnter) and [`OnExit`](crate::state::OnExit) schedules.
</span><span style=color:#86b300>+    ///
</span><span style=color:#86b300>+    /// If [`set_forced`](Self::set_forced) has already been called in the same frame with the same state, its behavior is kept.
</span><span>     pub fn set(&mut self, state: S) {
</span><span style=color:#f07171>-        *self = Self::Pending(state);
</span><span style=color:#86b300>+        if !matches!(self, Self::ForcedPending(s) if s == &state) {
</span><span style=color:#86b300>+            *self = Self::Pending(state);
</span><span style=color:#86b300>+        }
</span><span style=color:#86b300>+    }
</span><span style=color:#86b300>+
</span><span style=color:#86b300>+    /// Tentatively set a pending state transition to `Some(state)`.
</span><span style=color:#86b300>+    ///
</span><span style=color:#86b300>+    /// If `state` is the same as the current state, this will trigger state
</span><span style=color:#86b300>+    /// transition [`OnEnter`](crate::state::OnEnter) and [`OnExit`](crate::state::OnExit) schedules.
</span><span style=color:#86b300>+    pub fn set_forced(&mut self, state: S) {
</span><span style=color:#86b300>+        *self = Self::ForcedPending(state);
</span><span>     }
</span><span> 
</span><span>     /// Remove any pending changes to [`State&LTS>`]
</span><span style=color:#c594c5>@@ -143,13 +162,17 @@ </span><span style=color:#399ee6>impl&LTS: FreelyMutableState> NextState&LTS> {
</span><span> 
</span><span> pub(crate) fn take_next_state&LTS: FreelyMutableState>(
</span><span>     next_state: Option&LTResMut&LTNextState&LTS>>>,
</span><span style=color:#f07171>-) -> Option&LTS> {
</span><span style=color:#86b300>+) -> Option<(S, bool)> {
</span><span>     let mut next_state = next_state?;
</span><span> 
</span><span>     match core::mem::take(next_state.bypass_change_detection()) {
</span><span>         NextState::Pending(x) => {
</span><span>             next_state.set_changed();
</span><span style=color:#f07171>-            Some(x)
</span><span style=color:#86b300>+            Some((x, false))
</span><span style=color:#86b300>+        }
</span><span style=color:#86b300>+        NextState::ForcedPending(x) => {
</span><span style=color:#86b300>+            next_state.set_changed();
</span><span style=color:#86b300>+            Some((x, true))
</span><span>         }
</span><span>         NextState::Unchanged => None,
</span><span>     }
</span><span>diff --git a/crates/bevy_state/src/state/transitions.rs b/crates/bevy_state/src/state/transitions.rs
</span><span>index c22ab855abf30..35d421bf0f711 100644
</span><span style=color:#c594c5>--- a/crates/bevy_state/src/state/transitions.rs
</span><span style=color:#c594c5>+++ b/crates/bevy_state/src/state/transitions.rs
</span><span style=color:#c594c5>@@ -67,6 +67,8 @@ </span><span style=color:#399ee6>pub struct StateTransitionEvent&LTS: States> {
</span><span>     pub exited: Option&LTS>,
</span><span>     /// The state being entered.
</span><span>     pub entered: Option&LTS>,
</span><span style=color:#86b300>+    /// Enforce this transition even if `exited` and `entered` are the same
</span><span style=color:#86b300>+    pub same_state_enforced: bool,
</span><span> }
</span><span> 
</span><span> /// Applies state transitions and runs transitions schedules in order.
</span><span style=color:#c594c5>@@ -135,6 +137,7 @@ </span><span style=color:#399ee6>pub(crate) fn internal_apply_state_transition&LTS: States>(
</span><span>     mut commands: Commands,
</span><span>     current_state: Option&LTResMut&LTState&LTS>>>,
</span><span>     new_state: Option&LTS>,
</span><span style=color:#86b300>+    same_state_enforced: bool,
</span><span> ) {
</span><span>     match new_state {
</span><span>         Some(entered) => {
</span><span style=color:#c594c5>@@ -153,6 +156,7 @@ </span><span style=color:#399ee6>pub(crate) fn internal_apply_state_transition&LTS: States>(
</span><span>                     event.write(StateTransitionEvent {
</span><span>                         exited: Some(exited.clone()),
</span><span>                         entered: Some(entered.clone()),
</span><span style=color:#86b300>+                        same_state_enforced,
</span><span>                     });
</span><span>                 }
</span><span>                 None => {
</span><span style=color:#c594c5>@@ -162,6 +166,7 @@ </span><span style=color:#399ee6>pub(crate) fn internal_apply_state_transition&LTS: States>(
</span><span>                     event.write(StateTransitionEvent {
</span><span>                         exited: None,
</span><span>                         entered: Some(entered.clone()),
</span><span style=color:#86b300>+                        same_state_enforced,
</span><span>                     });
</span><span>                 }
</span><span>             };
</span><span style=color:#c594c5>@@ -174,6 +179,7 @@ </span><span style=color:#399ee6>pub(crate) fn internal_apply_state_transition&LTS: States>(
</span><span>                 event.write(StateTransitionEvent {
</span><span>                     exited: Some(resource.get().clone()),
</span><span>                     entered: None,
</span><span style=color:#86b300>+                    same_state_enforced,
</span><span>                 });
</span><span>             }
</span><span>         }
</span><span style=color:#c594c5>@@ -217,7 +223,7 @@ </span><span style=color:#399ee6>pub(crate) fn run_enter&LTS: States>(
</span><span>     let Some(transition) = transition.0 else {
</span><span>         return;
</span><span>     };
</span><span style=color:#f07171>-    if transition.entered == transition.exited {
</span><span style=color:#86b300>+    if transition.entered == transition.exited && !transition.same_state_enforced {
</span><span>         return;
</span><span>     }
</span><span>     let Some(entered) = transition.entered else {
</span><span style=color:#c594c5>@@ -234,7 +240,7 @@ </span><span style=color:#399ee6>pub(crate) fn run_exit&LTS: States>(
</span><span>     let Some(transition) = transition.0 else {
</span><span>         return;
</span><span>     };
</span><span style=color:#f07171>-    if transition.entered == transition.exited {
</span><span style=color:#86b300>+    if transition.entered == transition.exited && !transition.same_state_enforced {
</span><span>         return;
</span><span>     }
</span><span>     let Some(exited) = transition.exited else {
</span></code></pre></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-11/pr_19363.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>