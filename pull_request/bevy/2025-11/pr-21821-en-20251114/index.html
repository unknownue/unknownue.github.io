<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://unknownue.github.io name=base><title>
         #21821 Change `Bundle::component_ids` to return an iterator
        
    </title><meta content="#21821 Change `Bundle::component_ids` to return an iterator" property=og:title><meta content="A personal blog built with Zola and Apollo theme" property=og:description><meta content="A personal blog built with Zola and Apollo theme" name=description><link href=/icons/favicon.png rel=icon type=image/png><link href=https://unknownue.github.io/fonts.css rel=stylesheet><script src=https://unknownue.github.io/js/codeblock.js></script><script src=https://unknownue.github.io/js/toc.js></script><script src=https://unknownue.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="Unknownue's Blog" href=https://unknownue.github.io/atom.xml rel=alternate type=application/atom+xml><link href=https://unknownue.github.io/theme/light.css rel=stylesheet><link href=https://unknownue.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://unknownue.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://unknownue.github.io/main.css media=screen rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js></script><script>// Initialize mermaid once DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({
                startOnLoad: false,
                theme: document.body && document.body.classList.contains('dark') ? 'dark' : 'default',
                securityLevel: 'loose',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    diagramMarginX: 50,
                    diagramMarginY: 10,
                    actorMargin: 50,
                    width: 150,
                    height: 65
                }
            });
        });</script><script src=https://unknownue.github.io/js/main.js></script><script defer src=https://unknownue.github.io/js/label-colors.js></script><link href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css rel=stylesheet><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js></script><script>// Ensure highlight.js is properly configured
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                hljs.configure({
                    languages: ['rust', 'javascript', 'python', 'cpp', 'go', 'typescript'],
                    ignoreUnescapedHTML: true
                });
                console.log('Highlight.js configured in header');
            }
        });</script><link href=https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js></script><script src=https://unknownue.github.io/js/syntax-highlight.js></script><script src=https://unknownue.github.io/js/diff-sidebar.js></script><script src="https://unknownue.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://unknownue.github.io>Unknownue's Blog</a><div class=socials><a class=social href=https://github.com/unknownue rel=me> <img alt=github src=https://unknownue.github.io/icons/social/github.svg> </a><a class=social href=https://github.com/unknownue/unknownue.github.io rel=me> <img alt=github-io src=https://unknownue.github.io/icons/social/rss.svg> </a></div></div><nav><a href=https://unknownue.github.io/posts style=margin-left:.25em>/posts</a><a href=https://unknownue.github.io/projects style=margin-left:.25em>/projects</a><a href=https://unknownue.github.io/about style=margin-left:.25em>/about</a><a href=https://unknownue.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://unknownue.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://unknownue.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://unknownue.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><div class=pull-request-page><article class=md-content-page style=display:none></article><div class=back-link><a href=/pull_request/bevy/2025-11/>← Back to Pull Requests</a></div><div class=pr-metadata><span class=pr-date>2025-11-14</span><div class=language-switcher><span class="lang-link active" data-lang=en>English</span> / <a class=lang-link data-lang=zh-cn href=/pull_request/bevy/2025-11/pr-21821-zh-cn-20251114>中文</a></div></div><div class=pr-content><h1 id=change-bundle-component-ids-to-return-an-iterator>Change <code>Bundle::component_ids</code> to return an iterator</h1><h2 id=basic-information>Basic Information</h2><ul><li><strong>Title</strong>: Change <code>Bundle::component_ids</code> to return an iterator<li><strong>PR Link</strong>: https://github.com/bevyengine/bevy/pull/21821<li><strong>Author</strong>: hymm<li><strong>Status</strong>: MERGED<li><strong>Labels</strong>: A-ECS, C-Code-Quality, C-Usability, S-Ready-For-Final-Review, X-Uncontroversial, D-Macros<li><strong>Created</strong>: 2025-11-13T00:08:42Z<li><strong>Merged</strong>: 2025-11-13T23:23:03Z<li><strong>Merged By</strong>: mockersf</ul><h2 id=description-translation>Description Translation</h2><h1 id=objective>Objective</h1><ul><li>As part of #21780, I need a way to iterate over the component ids of a bundle for <code>Entity*Except</code> conflict checking without allocating. Pulled this out as it changes some unrelated code too.</ul><h2 id=solution>Solution</h2><ul><li>Change <code>Bundle::component_ids</code> and <code>Bundle::get_component_ids</code> to return an iterator instead of taking a closure. In theory I would expect this to compile to the same asm. I would also argue that using an iterator is a more natural api for this than the closure. It probably took a closure before because expressing that the iterator doesn’t capture the <code>&mut ComponentRegistrator</code> lifetime wasn’t possible without the <code>use</code> syntax.<li>Removed some #[allow(deprecated)] in the Bundle macro that was missed.</ul><h2 id=testing>Testing</h2><ul><li>Checked the asm for <code>hook_on_add</code> in the observers example for to confirm it was still the same. This is a pretty simple example though, so not sure how good of a check this is.<li>None of the code touched are in any hot paths, but ran the spawn and insert benches. Any changes seem to be in the noise.</ul><h2 id=the-story-of-this-pull-request>The Story of This Pull Request</h2><p>This PR addresses a specific performance optimization need that arose during the development of Entity*Except conflict checking in PR #21780. The core problem was straightforward: the existing <code>Bundle::component_ids</code> method required allocation when collecting component IDs, which wasn’t ideal for performance-critical code paths.<p>The original implementation used a closure-based approach where component IDs were passed to a callback function. While functional, this pattern often forced callers to allocate vectors to collect the results. The developer recognized that switching to an iterator-based API would provide more flexibility, potentially eliminating allocations while maintaining the same underlying performance characteristics.<p>The implementation involved changing the <code>Bundle</code> trait’s method signatures across the entire codebase. The key insight was that by returning iterators instead of using callbacks, consumers could choose whether to collect results into a vector or process them lazily. This was particularly valuable for the Entity*Except conflict checking use case, where the component IDs only needed to be checked for existence rather than stored.<p>One notable technical challenge was handling lifetime constraints. The original closure-based approach implicitly captured the lifetime of the <code>ComponentsRegistrator</code>, but with iterators, this needed to be made explicit. The solution used Rust’s <code>use</code> syntax in the return type to specify which generic parameters the iterator depends on, without capturing the mutable reference lifetime.<p>The changes were systematically applied across multiple implementation layers:<ul><li>The core <code>Bundle</code> trait definition<li>Manual implementations for components and tuples<li>The derive macro for automatically implementing <code>Bundle</code><li>All consumer code throughout the ECS system</ul><p>Performance validation was conducted through both micro-benchmarks and assembly inspection. The developer confirmed that the generated assembly for the observers example remained identical, suggesting no performance regression. Broader benchmarks on spawn and insert operations showed only noise-level differences, indicating the changes didn’t negatively impact performance.<p>The migration was comprehensive, including the addition of a migration guide to help users update their code. The guide provided clear before-and-after examples for both implementors and consumers of the <code>Bundle</code> trait.<h2 id=visual-representation>Visual Representation</h2><pre class=language-mermaid data-lang=mermaid style=color:#61676c;background-color:#fafafa><code class=language-mermaid data-lang=mermaid><span>graph TD
</span><span>    A[Bundle Trait] --> B[Component Implementations]
</span><span>    A --> C[Tuple Implementations]
</span><span>    A --> D[Macro-Generated Implementations]
</span><span>    B --> E[Consumer Code]
</span><span>    C --> E
</span><span>    D --> E
</span><span>    E --> F[Entity*Except Conflict Checking]
</span><span>    E --> G[Bundle Info Registration]
</span><span>    E --> H[Observer Systems]
</span></code></pre><h2 id=key-files-changed>Key Files Changed</h2><h3 id=crates-bevy-ecs-src-bundle-mod-rs><code>crates/bevy_ecs/src/bundle/mod.rs</code></h3><p>This file contains the core <code>Bundle</code> trait definition. The method signatures were changed from closure-based to iterator-based.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>component_ids</span><span>(</span><span style=color:#ff8f40>components</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> ComponentsRegistrator, </span><span style=color:#ff8f40>ids</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> impl FnMut(</span><span style=color:#ff8f40>ComponentId</span><span>))</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>get_component_ids</span><span>(</span><span style=color:#ff8f40>components</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>Components, </span><span style=color:#ff8f40>ids</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> impl FnMut(</span><span style=color:#ff8f40>Option</span><span><</span><span style=color:#ff8f40>ComponentId</span><span>>))</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>component_ids</span><span>(</span><span style=color:#ff8f40>components</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> ComponentsRegistrator) </span><span style=color:#61676ccc>-></span><span> impl </span><span style=color:#55b4d4;font-style:italic>Iterator</span><span>&LTItem = ComponentId> </span><span style=color:#ed9366>+ </span><span style=color:#fa6e32>use</span><span style=color:#ed9366><</span><span style=color:#fa6e32>Self</span><span style=color:#ed9366>></span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>get_component_ids</span><span>(</span><span style=color:#ff8f40>components</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span>Components) </span><span style=color:#61676ccc>-></span><span> impl </span><span style=color:#55b4d4;font-style:italic>Iterator</span><span>&LTItem = </span><span style=color:#55b4d4;font-style:italic>Option</span><span>&LTComponentId>></span><span style=color:#61676ccc>;
</span></code></pre><h3 id=crates-bevy-ecs-src-bundle-impls-rs><code>crates/bevy_ecs/src/bundle/impls.rs</code></h3><p>Contains implementations of <code>Bundle</code> for individual components and tuples. The implementations were updated to use iterator combinators.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Component implementation:
</span><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>component_ids</span><span>(</span><span style=color:#ff8f40>components</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> ComponentsRegistrator, </span><span style=color:#ff8f40>ids</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> impl FnMut(</span><span style=color:#ff8f40>ComponentId</span><span>)) {
</span><span>    </span><span style=color:#f07171>ids</span><span>(components</span><span style=color:#ed9366>.</span><span>register_component</span><span style=color:#ed9366>::</span><span>&LTC>())</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>component_ids</span><span>(</span><span style=color:#ff8f40>components</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> ComponentsRegistrator) </span><span style=color:#61676ccc>-></span><span> impl </span><span style=color:#55b4d4;font-style:italic>Iterator</span><span>&LTItem = ComponentId> </span><span style=color:#ed9366>+ </span><span style=color:#fa6e32>use</span><span style=color:#ed9366><</span><span>C</span><span style=color:#ed9366>> </span><span>{
</span><span>    iter</span><span style=color:#ed9366>::</span><span>once(components</span><span style=color:#ed9366>.</span><span>register_component</span><span style=color:#ed9366>::</span><span>&LTC>())
</span><span>}
</span></code></pre><h3 id=crates-bevy-ecs-macros-src-lib-rs><code>crates/bevy_ecs/macros/src/lib.rs</code></h3><p>The derive macro for <code>Bundle</code> was updated to generate iterator-based implementations instead of closure-based ones.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span style=color:#fa6e32>unsafe impl </span><span>#</span><span style=color:#399ee6>impl_generics</span><span> #</span><span style=color:#399ee6>ecs_path</span><span>::</span><span style=color:#399ee6>bundle</span><span>::</span><span style=color:#399ee6>Bundle for</span><span> #</span><span style=color:#399ee6>struct_name</span><span> #</span><span style=color:#399ee6>ty_generics</span><span> #</span><span style=color:#399ee6>where_clause </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>component_ids</span><span>(</span><span style=color:#ff8f40>components</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> #ecs_path</span><span style=color:#ed9366>::</span><span>component</span><span style=color:#ed9366>::</span><span>ComponentsRegistrator, </span><span style=color:#ff8f40>ids</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> impl FnMut(#</span><span style=color:#ff8f40>ecs_path</span><span>::</span><span style=color:#ff8f40>component</span><span>::</span><span style=color:#ff8f40>ComponentId</span><span>)) {
</span><span>        </span><span style=color:#ed9366>#</span><span>(</span><span style=color:#ed9366><#</span><span>active_field_types </span><span style=color:#ed9366>as #</span><span>ecs_path</span><span style=color:#ed9366>::</span><span>bundle</span><span style=color:#ed9366>::</span><span>Bundle</span><span style=color:#ed9366>>::</span><span>component_ids(components</span><span style=color:#61676ccc>,</span><span> ids)</span><span style=color:#61676ccc>;</span><span>)</span><span style=color:#ed9366>*
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>unsafe impl </span><span>#</span><span style=color:#399ee6>impl_generics</span><span> #</span><span style=color:#399ee6>ecs_path</span><span>::</span><span style=color:#399ee6>bundle</span><span>::</span><span style=color:#399ee6>Bundle for</span><span> #</span><span style=color:#399ee6>struct_name</span><span> #</span><span style=color:#399ee6>ty_generics</span><span> #</span><span style=color:#399ee6>where_clause </span><span>{
</span><span>    </span><span style=color:#fa6e32>fn </span><span style=color:#f29718>component_ids</span><span>(</span><span style=color:#ff8f40>components</span><span style=color:#61676ccc>: </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> #ecs_path</span><span style=color:#ed9366>::</span><span>component</span><span style=color:#ed9366>::</span><span>ComponentsRegistrator) </span><span style=color:#61676ccc>-></span><span> impl </span><span style=color:#55b4d4;font-style:italic>Iterator</span><span>&LTItem = </span><span style=color:#f51818>#</span><span>ecs_path</span><span style=color:#ed9366>::</span><span>component</span><span style=color:#ed9366>::</span><span>ComponentId</span><span style=color:#ed9366>> + </span><span style=color:#fa6e32>use</span><span style=color:#ed9366><#</span><span>(</span><span style=color:#ed9366>#</span><span>generics_ty_list</span><span style=color:#61676ccc>,</span><span>)</span><span style=color:#ed9366>*> </span><span>{
</span><span>        core</span><span style=color:#ed9366>::</span><span>iter</span><span style=color:#ed9366>::</span><span>empty()</span><span style=color:#ed9366>#</span><span>(</span><span style=color:#ed9366>.</span><span style=color:#f07171>chain</span><span>(</span><span style=color:#ed9366><#</span><span>active_field_types </span><span style=color:#ed9366>as #</span><span>ecs_path</span><span style=color:#ed9366>::</span><span>bundle</span><span style=color:#ed9366>::</span><span>Bundle</span><span style=color:#ed9366>>::</span><span>component_ids(components)))</span><span style=color:#ed9366>*
</span><span>    }
</span><span>}
</span></code></pre><h3 id=crates-bevy-ecs-src-query-fetch-rs><code>crates/bevy_ecs/src/query/fetch.rs</code></h3><p>Consumer code was updated to use the new iterator API, often eliminating intermediate allocations.<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#abb0b6;font-style:italic>// Before:
</span><span>B</span><span style=color:#ed9366>::</span><span>component_ids(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>components_registrator</span><span>()</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut </span><span style=color:#ed9366>|</span><span>id</span><span style=color:#ed9366>| </span><span>{
</span><span>    access</span><span style=color:#ed9366>.</span><span style=color:#f07171>remove_component_read</span><span>(id)</span><span style=color:#61676ccc>;
</span><span>})</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// After:
</span><span style=color:#fa6e32>for</span><span> id </span><span style=color:#ed9366>in </span><span>B</span><span style=color:#ed9366>::</span><span>component_ids(</span><span style=color:#ed9366>&</span><span style=color:#fa6e32>mut</span><span> world</span><span style=color:#ed9366>.</span><span style=color:#f07171>components_registrator</span><span>()) {
</span><span>    access</span><span style=color:#ed9366>.</span><span style=color:#f07171>remove_component_read</span><span>(id)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=release-content-migration-guides-bundle-component-ids-md><code>release-content/migration-guides/bundle_component_ids.md</code></h3><p>A new migration guide was added to help users transition from the old closure-based API to the new iterator-based API.<h2 id=further-reading>Further Reading</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://doc.rust-lang.org/std/iter/trait.Iterator.html target=_blank>Rust Iterator Documentation</a> - Comprehensive guide to Rust’s iterator pattern<li><a rel="noopener nofollow noreferrer" href=https://docs.rs/bevy_ecs/latest/bevy_ecs/bundle/trait.Bundle.html target=_blank>Bevy ECS Bundle Documentation</a> - Official documentation for the Bundle trait<li><a rel="noopener nofollow noreferrer" href=https://github.com/rust-lang/rust/issues/100013 target=_blank>Rust <code>use</code> in return position</a> - Discussion about the <code>use</code> syntax in return types<li><a rel="noopener nofollow noreferrer" href=https://github.com/bevyengine/bevy/pull/21780 target=_blank>PR #21780</a> - The original PR that motivated this change</ul></div><div data-is-md-page=true data-patch-exists=true data-patch-path=/pull_request/bevy/2025-11/pr_21821.patch id=patch-info style=display:none></div><div class=bottom-spacer></div></div></div>