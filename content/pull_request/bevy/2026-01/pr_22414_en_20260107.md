+++
title = "#22414 Add warning log for sprite picking failure on compressed textures"
date = "2026-01-07T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = true

[taxonomies]
list_display = ["show"]

[extra]
current_language = "en"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2026-01/pr-22414-en-20260107" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2026-01/pr-22414-zh-cn-20260107" }}
labels = ["C-Usability", "A-Picking"]
+++

# Title
## Add warning log for sprite picking failure on compressed textures

## Basic Information
- **Title**: Add warning log for sprite picking failure on compressed textures
- **PR Link**: https://github.com/bevyengine/bevy/pull/22414
- **Author**: mirsella
- **Status**: MERGED
- **Labels**: C-Usability, S-Ready-For-Final-Review, A-Picking
- **Created**: 2026-01-07T09:49:02Z
- **Merged**: 2026-01-07T20:52:09Z
- **Merged By**: alice-i-cecile

## Description Translation

# Objective

fixes https://github.com/bevyengine/bevy/issues/22413
from this issue:
> currently, with SpritePickingMode::AlphaThreshold sprite picking silently fail on image format like bc7, uastc, etc, since its not possible to get the pixel alpha value at a specific location, as the image is compressed in memory. currently the code break the loop and silently skip picking for the sprite.
https://github.com/bevyengine/bevy/pull/20574 made it not panic anymore

its very hard to debug why a sprite picking doesn't work when encountering this issue, i think a warn is really useful.

## Solution

add a warn! log

## Testing

tested on my own project

is the log message adapted ?

thanks

## The Story of This Pull Request

The issue originated from a developer trying to use sprite picking with compressed texture formats. When `SpritePickingMode::AlphaThreshold` is configured, the system needs to sample individual pixels to check their alpha values against a threshold. This works fine for uncompressed formats, but fails silently for compressed formats like BC7 and UASTC because these formats cannot be directly sampled at the pixel level - they're stored in memory in a compressed block format that requires decoding before individual pixel access is possible.

Prior to PR #20574, this situation would cause a panic. That earlier PR changed the behavior to silently skip picking by breaking out of the loop without any indication, which fixed the crash but created a new problem: developers had no way to know why their sprite picking wasn't working. The silent failure made debugging difficult because there was no feedback in the console or logs.

The solution implemented in this PR is straightforward but important: add a warning log when the system encounters a compressed texture format that prevents pixel sampling. The key insight here is that the `TextureAccessError` enum has a specific variant `UnsupportedTextureFormat` that gets returned when `get_color_at()` is called on a compressed texture. By pattern matching on this specific error type, the code can provide targeted feedback to developers.

The warning message serves three purposes:
1. It clearly identifies which entity is affected
2. It specifies the problematic texture format
3. It suggests a practical workaround: switching to `SpritePickingMode::BoundingBox`

This change follows the principle of "fail noisily" - when something goes wrong in a way that's expected (not a bug, but a limitation of the system), provide clear feedback to the developer about what happened and why. This is especially important for game engines where developers may be loading various texture formats without realizing the implications for different systems.

The implementation required adding a new dependency (`bevy_log`) to the `bevy_sprite` crate, which is a small but necessary change since logging functionality wasn't previously available in this module. The warning is emitted only when the specific unsupported format error occurs, not for other texture access errors, which maintains the existing behavior for other failure modes.

## Visual Representation

```mermaid
graph TD
    A[SpritePickingMode::AlphaThreshold] --> B{Try get_color_at()}
    B -->|Success| C[Check alpha threshold]
    B -->|Error: UnsupportedTextureFormat| D[Emit Warning Log]
    D --> E[Skip picking for this sprite]
    E --> F[Suggest BoundingBox mode]
    B -->|Other Error| G[Silently skip]
    
    style D fill:#f9f,stroke:#333,stroke-width:2px
```

## Key Files Changed

### `crates/bevy_sprite/Cargo.toml` (+1/-0)
**Change**: Added `bevy_log` as a dependency
**Why**: Needed for the `warn!` macro to emit warning logs from the sprite picking module

```toml
# File: crates/bevy_sprite/Cargo.toml
# Addition at line 31:
bevy_log = { path = "../bevy_log", version = "0.18.0-dev" }
```

### `crates/bevy_sprite/src/picking_backend.rs` (+16/-5)
**Change**: Modified the sprite picking function to emit a warning when encountering compressed textures

The key change is in how the `image.get_color_at()` call is handled. Previously it used `let Ok(color) = ... else { break ... }` which would silently skip any error. Now it uses pattern matching to specifically handle the `UnsupportedTextureFormat` error variant and emit a helpful warning.

```rust
// File: crates/bevy_sprite/src/picking_backend.rs
// Before (simplified):
let Ok(color) = image.get_color_at(
    cursor_pixel_space.x as u32,
    cursor_pixel_space.y as u32,
) else {
    // We don't know how to interpret the pixel.
    break 'valid_pixel false;
};

// After:
let color = match image.get_color_at(
    cursor_pixel_space.x as u32,
    cursor_pixel_space.y as u32,
) {
    Ok(color) => color,
    Err(TextureAccessError::UnsupportedTextureFormat(format)) => {
        warn!(
            "Failed to get pixel color for sprite picking on entity {:?}: unsupported texture format {:?}. \
            This is often caused by the use of a compressed texture format. \
            Consider using `SpritePickingMode::BoundingBox`.",
            entity,
            format
        );
        break 'valid_pixel false;
    }
    Err(_) => break 'valid_pixel false,
};
```

**Imports**: The file also added two new imports:
- `bevy_image::TextureAccessError` to pattern match on the specific error type
- `bevy_log::warn` to emit the warning log

## Further Reading

1. **Bevy Picking System Documentation**: For understanding the overall picking architecture in Bevy
2. **Texture Compression Formats**: Information about BC7, UASTC, and other GPU texture formats and their limitations
3. **Error Handling Patterns in Rust**: Best practices for matching on specific error variants versus using generic error handling
4. **Bevy Logging System**: How to use different log levels (info, warn, error) effectively in Bevy applications