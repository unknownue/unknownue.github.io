+++
title = "#22356 Fix panic in mesh picking when a mesh is `RENDER_WORLD` only"
date = "2026-01-05T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = false

[extra]
current_language = "zh-cn"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2026-01/pr-22356-en-20260105" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2026-01/pr-22356-zh-cn-20260105" }}
+++

# Title

## 基本信息
- **标题**: Fix panic in mesh picking when a mesh is `RENDER_WORLD` only
- **PR 链接**: https://github.com/bevyengine/bevy/pull/22356
- **作者**: greeble-dev
- **状态**: 已合并
- **标签**: C-Bug, P-Crash, S-Ready-For-Final-Review, P-Regression, A-Picking
- **创建时间**: 2026-01-02T15:24:22Z
- **合并时间**: 2026-01-05T02:31:22Z
- **合并者**: alice-i-cecile

## 描述翻译
### 目标
修复一个在网格拾取（mesh picking）中，当网格仅用于 `RenderAssetUsages::RENDER_WORLD` 时出现的恐慌（panic）。此问题在 https://github.com/bevyengine/bevy/issues/22206 中被报告，尽管该 issue 描述了一个更广泛的问题，因此并未完全被此 PR 解决。这个问题是在 https://github.com/bevyengine/bevy/pull/21732 中被引入的。

### 解决方案
将访问网格（mesh）的方法改为使用不会引发恐慌的 `try_` 变体。这意味着被提取的网格（extracted meshes）会像之前一样被静默忽略。

我还快速扫描了一下，看看是否能发现其他可能有同样问题的引擎crate——没有发现，但很容易漏掉。

### 测试
通过修改 `mesh_picking` 示例进行测试：
```diff
+    let mut p = Mesh::from(Cuboid::default());
+    p.asset_usage = bevy_asset::RenderAssetUsages::RENDER_WORLD;
     let shapes = [
-        meshes.add(Cuboid::default()),
+        meshes.add(p),
```

## 该 Pull Request 的故事

这个 PR 的故事始于一个由用户报告的恐慌。在 Bevy 的 `picking`（拾取）系统中，当一个网格的 `asset_usage` 被设置为 `RenderAssetUsages::RENDER_WORLD` 时，尝试通过射线投射来拾取该物体会导致程序崩溃。

问题的根源在于数据流和生命周期的不匹配。Bevy 使用一个提取（extraction）阶段来将 ECS 数据准备到渲染世界。`RENDER_WORLD` 标志指示一个资产（asset）只应在渲染世界中使用，而提取系统不会处理此类资产。这意味着，对于仅标记为 `RENDER_WORLD` 的网格，其顶点数据、索引等属性在拾取系统运行的主世界中是缺失的。

问题是由 PR #21732 引入的，该 PR 优化了网格拾取的性能。作为优化的一部分，代码更改了访问网格属性的方式，从使用 `try_` 方法（返回 `Option`）改为使用直接方法（返回 `Result`，并在出错时 `panic`）。这种改变在网格数据存在时是有效的，但对于 `RENDER_WORLD` 网格，`Mesh` 内部的属性存储是空的，导致对 `.attribute()` 和 `.indices()` 的调用失败并引发恐慌。

开发者 `greeble-dev` 的解决方案直接而有效：回退到使用安全的 `try_` 系列方法。这包括：
1.  `try_attribute()` 替代 `attribute()`
2.  `try_indices()` 替代 `indices()`
这些方法在数据缺失时会返回 `None`，而不是恐慌。在拾取的上下文中，如果无法获取到网格的几何数据，那么正确的行为就是无法与该网格相交，因此返回 `None` 是完全合适的。

这种修复在逻辑上保持了与之前行为的一致性。在引入回归的 PR 之前，代码本就使用 `try_attribute`，数据缺失会导致静默忽略。现在的修复只是恢复了这种健壮的行为。

从工程角度看，这个修复突出了几个关键点：
- **防御性编程**：在处理来自外部或复杂管线（如资产流）的数据时，应优先使用不会崩溃的 API。
- **回归测试的重要性**：这个 bug 是在一次性能优化后引入的，强调了在修改看似无关的代码路径（如从 `try_` 改为直接访问）后进行全面测试的重要性。
- **API 设计的清晰性**：`try_` 前缀明确表明了该方法可能失败，引导开发者进行适当的错误处理。

这个更改的影响是局部的，仅限于 `bevy_picking` crate 中的网格射线相交逻辑。它修复了特定情况下的崩溃，使系统恢复到稳定状态。然而，正如 PR 描述中指出的，相关的 issue (#22206) 讨论了关于 `RENDER_WORLD` 资产与拾取系统集成的更广泛的设计问题，这个 PR 并未解决那些更高层次的问题。

最终，这个 PR 被合并，快速修复了一个具体的、会引发崩溃的回归问题。它提醒我们，即使在追求性能优化时，也必须保持代码的健壮性，并仔细考虑所有数据路径。

## 可视化表示

```mermaid
graph TD
    A[主世界 Mesh 资产<br/>asset_usage: RENDER_WORLD] --> B{提取阶段};
    B -->|跳过提取| C[渲染世界];
    B -->|无数据传递| D[主世界 Mesh 数据存储];
    E[Picking 系统] --> F{访问 Mesh 数据};
    F -->|使用 .attribute()/.indices()| G[数据缺失，引发 PANIC];
    F -->|使用 .try_...()| H[返回 None，安全跳过];
    D -.-> F;
```

## 关键文件更改

### `crates/bevy_picking/src/mesh_picking/ray_cast/intersections.rs` (+9/-4)

这是此 PR 中唯一修改的文件。修改集中在 `ray_intersection_over_mesh` 函数中，该函数负责计算一条射线与给定网格的相交情况。

**更改内容及原因**：
修改将访问 `Mesh` 资源属性的方法从会 panic 的版本替换为其对应的 `try_` 版本。这确保了当网格数据（如顶点位置、法线、UV、索引）因 `RENDER_WORLD` 标记而缺失时，函数能够优雅地失败（返回 `None`）而不是导致程序崩溃。

**关键代码片段**：

```rust
// 文件：crates/bevy_picking/src/mesh_picking/ray_cast/intersections.rs
// 修改前 (会panic):
let positions = mesh.attribute(Mesh::ATTRIBUTE_POSITION)?.as_float3()?;
let normals = mesh
    .attribute(Mesh::ATTRIBUTE_NORMAL)
    .and_then(|normal_values| normal_values.as_float3());
let uvs = mesh
    .attribute(Mesh::ATTRIBUTE_UV_0)
    .and_then(|uvs| match uvs { /* ... */ });
match mesh.indices() {
    Some(Indices::U16(indices)) => { /* ... */ }
    // ...
}

// 修改后 (安全，使用 try_):
let positions = mesh
    .try_attribute(Mesh::ATTRIBUTE_POSITION) // 使用 try_attribute
    .ok()? // 如果为 None，则提前返回 None
    .as_float3()?;
let normals = mesh
    .try_attribute(Mesh::ATTRIBUTE_NORMAL) // 使用 try_attribute
    .ok() // 将 Result 转为 Option
    .and_then(|normal_values| normal_values.as_float3());
let uvs = mesh
    .try_attribute(Mesh::ATTRIBUTE_UV_0) // 使用 try_attribute
    .ok()
    .and_then(|uvs| match uvs { /* ... */ });
match mesh.try_indices().ok() { // 使用 try_indices
    Some(Indices::U16(indices)) => { /* ... */ }
    // ...
}
```

## 延伸阅读

- **[Issue #22206: Mesh Picking fails for meshes with `RenderAssetUsages::RENDER_WORLD`](https://github.com/bevyengine/bevy/issues/22206)**：报告此问题的原始 issue，包含更广泛的讨论。
- **[PR #21732: Optimize meshlet binning and use improved binning algorithm](https://github.com/bevyengine/bevy/pull/21732)**：引入了此回归的 PR，了解变更的上下文。
- **[Bevy 文档: Mesh](https://docs.rs/bevy_render/latest/bevy_render/mesh/struct.Mesh.html)**：关于 `Mesh` 结构体及其方法的官方文档，包括 `try_attribute` 和 `try_indices`。
- **[Bevy 文档: RenderAssetUsages](https://docs.rs/bevy_asset/latest/bevy_asset/enum.RenderAssetUsages.html)**：关于资产使用标志的说明。
- **[Bevy Picking 插件](https://github.com/bevyengine/bevy/tree/main/crates/bevy_picking)**：了解 Bevy 拾取系统的整体架构。