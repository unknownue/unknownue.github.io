+++
title = "#22653 Make safety comments on unsafe traits internal comments"
date = "2026-01-27T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = false

[extra]
current_language = "zh-cn"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2026-01/pr-22653-en-20260127" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2026-01/pr-22653-zh-cn-20260127" }}
+++

# Make safety comments on unsafe traits internal comments

## Basic Information
- **标题**: Make safety comments on unsafe traits internal comments
- **PR 链接**: https://github.com/bevyengine/bevy/pull/22653
- **作者**: hymm
- **状态**: 已合并
- **标签**: A-ECS, C-Code-Quality, S-Ready-For-Final-Review, X-Contentious
- **创建时间**: 2026-01-22T20:01:00Z
- **合并时间**: 2026-01-27T06:44:28Z
- **合并者**: alice-i-cecile

## 描述翻译

### 目标
- 不安全特性实现的`安全注释`不应该成为公共文档的一部分，因为这些注释是用于 Bevy 开发人员解释为什么实现该特性是安全的。

### 解决方案
- 将它们转换为常规文档注释（从 `///` 改为 `//`）

---

## 这个拉取请求的故事

这个 PR 解决了一个关于 Rust 文档注释的特定约定问题。在 Bevy 的 ECS 系统中，许多核心特性（如 `WorldQuery`、`QueryData`、`QueryFilter` 等）被标记为 `unsafe`。实现这些特性需要开发者提供安全保证，因此在实现中通常会有解释为什么实现是安全的注释。

### 问题和背景

问题在于这些安全注释使用了 `///`（文档注释），这使它们成为生成的公共 API 文档的一部分。然而，这些注释实际上是为 Bevy 内部开发者（或那些可能查看源代码的贡献者）编写的，而不是为最终用户准备的。最终用户使用 ECS API 时不需要关心 `WorldQuery` 实现的安全保证细节，他们需要的是如何使用这些功能的文档。

将安全注释保留在公共文档中会导致：
1. 文档变得杂乱，包含了用户不需要关心的内部实现细节
2. 可能混淆用户，让他们认为这些是实现细节的重要部分
3. 不符合 Rust 文档的最佳实践，即公共文档应该专注于如何使用 API

### 解决方案方法

解决方案简单直接：将所有不安全特性实现中的 `/// SAFETY:` 注释改为 `// SAFETY:` 注释。这保持了代码中的安全理由（这对代码审查和未来的维护很重要），但将其从公共文档中移除。

### 实施细节

这个更改是机械性的，但影响广泛。它涉及了 11 个文件，主要是 ECS 系统中的核心特性实现。让我们看看具体的更改模式：

**在 `crates/bevy_ecs/src/query/fetch.rs` 中：**
```rust
// 之前：
/// SAFETY: `update_component_access` does nothing.
/// This is sound because `fetch` does not access components.
unsafe impl WorldQuery for Entity {
    // 实现...
}

// 之后：
// SAFETY: `update_component_access` does nothing.
// This is sound because `fetch` does not access components.
unsafe impl WorldQuery for Entity {
    // 实现...
}
```

**在 `crates/bevy_ecs/src/query/filter.rs` 中：**
```rust
// 之前：
/// SAFETY:
/// `update_component_access` does not add any accesses.
/// This is sound because [`QueryFilter::filter_fetch`] does not access any components.
unsafe impl<T: Component> WorldQuery for With<T> {
    // 实现...
}

// 之后：
// SAFETY:
// `update_component_access` does not add any accesses.
// This is sound because [`QueryFilter::filter_fetch`] does not access any components.
unsafe impl<T: Component> WorldQuery for With<T> {
    // 实现...
}
```

### 技术见解

这个 PR 涉及了几个重要的技术概念：

1. **Rust 的安全注释约定**：在 Rust 中，`unsafe` 块和实现需要开发者解释为什么代码是安全的。这是 Rust 安全模型的核心部分，允许在不安全的边界处记录安全假设。

2. **Rust 的文档注释系统**：`///` 注释会出现在 `rustdoc` 生成的文档中，而 `//` 注释则不会。这个区别对于控制公共 API 文档的内容非常重要。

3. **ECS 系统的安全边界**：Bevy 的 ECS 系统广泛使用 `unsafe` 特性来提供高性能的组件访问。每个不安全特性的实现都需要仔细验证以确保内存安全和线程安全。

这个更改不涉及任何功能修改，纯粹是文档约定。它保持了代码库中的安全推理（这对维护很重要），但清理了公共文档。

### 影响

这个 PR 的主要影响是：
1. **更清晰的公共文档**：用户不再在 API 文档中看到内部安全细节
2. **保持代码可维护性**：安全注释仍然存在于源代码中，供开发者和审查者查看
3. **符合 Rust 最佳实践**：公共文档专注于如何使用 API，而不是内部实现细节

值得注意的是，这个更改也影响了派生宏生成的代码。在 `crates/bevy_ecs/macros/src/query_data.rs` 中，宏生成的安全注释也从 `///` 改为了 `//`，确保了一致性。

---

## 可视化表示

```mermaid
graph TD
    A[不安全特性实现] --> B{安全注释类型}
    B -->|公共文档注释| C[/// SAFETY: ...]
    B -->|内部注释| D[// SAFETY: ...]
    C --> E[出现在 rustdoc 输出中]
    D --> F[仅出现在源代码中]
    E --> G[用户看到内部细节]
    F --> H[用户看到干净的 API 文档]
```

---

## 关键文件变更

### 1. `crates/bevy_ecs/src/query/fetch.rs` (+98/-98)
**变更描述**：这是变化最大的文件，包含了 ECS 查询系统中许多核心特性的实现。所有的 `/// SAFETY:` 注释都被改为了 `// SAFETY:`。

**关键代码片段**：
```rust
// 示例变更：
// SAFETY: `Self` is the same as `Self::ReadOnly`
unsafe impl QueryData for Entity {
    const IS_READ_ONLY: bool = true;
    const IS_ARCHETYPAL: bool = true;
    type ReadOnly = Self;
}
```

### 2. `crates/bevy_ecs/src/query/filter.rs` (+30/-30)
**变更描述**：包含查询过滤器的安全实现注释更改。

**关键代码片段**：
```rust
// SAFETY:
// `update_component_access` does not add any accesses.
// This is sound because [`QueryFilter::filter_fetch`] does not access any components.
unsafe impl<T: Component> WorldQuery for With<T> {
    type Fetch<'w> = ();
    type State = ComponentId;
}
```

### 3. `crates/bevy_ecs/src/query/world_query.rs` (+5/-5)
**变更描述**：包含元组世界查询实现的安全注释更改。

**关键代码片段**：
```rust
// SAFETY:
// `fetch` accesses are the conjunction of the subqueries' accesses
// This is sound because `update_component_access` adds accesses according to the implementations of all the subqueries.
unsafe impl<$($name: WorldQuery),*> WorldQuery for ($($name,)*) {
    type Fetch<'w> = ($($name::Fetch<'w>,)*);
    type State = ($($name::State,)*);
}
```

### 4. `crates/bevy_ecs/src/query/mod.rs` (+4/-4)
**变更描述**：包含查询模块中测试代码的安全注释更改。

### 5. `crates/bevy_render/src/sync_world.rs` (+4/-4)
**变更描述**：包含渲染实体世界查询实现的安全注释更改。

**关键代码片段**：
```rust
// SAFETY: defers completely to `&RenderEntity` implementation,
// and then only modifies the output safely.
unsafe impl WorldQuery for RenderEntity {
    type Fetch<'w> = <&'static RenderEntity as WorldQuery>::Fetch<'w>;
    type State = <&'static RenderEntity as WorldQuery>::State;
}
```

---

## 进一步阅读

1. **Rust 不安全代码指南**：https://doc.rust-lang.org/nomicon/
2. **Rust 文档注释**：https://doc.rust-lang.org/rust-by-example/meta/doc.html
3. **Bevy ECS 文档**：https://bevyengine.org/learn/book/ecs/
4. **Rust 安全与不安全边界**：https://doc.rust-lang.org/book/ch19-01-unsafe-rust.html