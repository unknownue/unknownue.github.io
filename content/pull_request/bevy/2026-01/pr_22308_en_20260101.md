+++
title = "#22308 Update cosmic-text to 0.16"
date = "2026-01-01T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = true

[taxonomies]
list_display = ["show"]

[extra]
current_language = "en"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2026-01/pr-22308-en-20260101" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2026-01/pr-22308-zh-cn-20260101" }}
labels = ["C-Bug", "A-Text", "D-Straightforward", "M-Deliberate-Rendering-Change"]
+++

# Title

## Basic Information
- **Title**: Update cosmic-text to 0.16
- **PR Link**: https://github.com/bevyengine/bevy/pull/22308
- **Author**: ickshonpe
- **Status**: MERGED
- **Labels**: C-Bug, S-Ready-For-Final-Review, A-Text, D-Straightforward, M-Deliberate-Rendering-Change
- **Created**: 2025-12-29T23:05:41Z
- **Merged**: 2026-01-01T04:06:28Z
- **Merged By**: alice-i-cecile

## Description Translation
**Objective**

Update the Cosmic Text dependency to 0.16.

Fixes #22191

**Solution**

There aren't any breaking changes with Cosmic Text version 0.16, but it does add font-hinting support. This is controlled in Bevy with a new component `FontHinting`. The `Text` component, which is normally used with physical pixel aligned text, now requires `FontHinting::Enabled`, and `Text2d`, which normally isn't pixel aligned, now requires `FontHinting::Disabled`. Hinting needs to be set per text block, not per text span entity, so it wouldn't be appropriate to add it as a field on `TextFont`.

**Testing**

`testbed_ui`'s text scene in main with cosmic-text 15:
<img width="1924" height="1127" alt="cosmic-15" src="https://github.com/user-attachments/assets/0ee44e38-07b0-411b-9102-b7d28de0ffcd" />

The font names are meant to be rendered in their corresponding fonts but, as you can see, some names are rendered using the incorrect font. This is due to the ascii fastpath bug in cosmic-text 15, which is fixed in 16.

`testbed_ui`'s text scene on this branch with cosmic-text 16:
<img width="1924" height="1127" alt="cosmic-16" src="https://github.com/user-attachments/assets/549f9a21-e24d-422d-a9e2-eac902b2e054" />

Now each font's name is rendered using the correct font.

## The Story of This Pull Request

This pull request addresses two related issues: updating the cosmic-text dependency to version 0.16 to fix a font rendering bug, and integrating the new font hinting feature introduced in that version. The problem was that cosmic-text 0.15 contained an ASCII fastpath bug that caused incorrect font selection in certain scenarios, particularly noticeable in test scenes where font names should render using their corresponding fonts.

The approach taken is straightforward: update the dependency and expose the new font hinting capability through a new Bevy component. Font hinting is a technique that adjusts glyph outlines to align with pixel grids, improving readability on lower-resolution displays. The cosmic-text 0.16 library introduces this feature, and Bevy needs to provide a way to control it.

The implementation required changes across multiple text-rendering systems. The core addition is the `FontHinting` component, an enum with `Disabled` and `Enabled` variants that maps directly to cosmic-text's `Hinting` enum. This component is added as a required component for both UI text (`Text`) and 2D sprite text (`Text2d`) entities, with different default values based on their typical use cases.

For UI text, which is usually pixel-aligned in screen space, hinting is enabled by default (`FontHinting::Enabled`). For 2D sprite text, which often undergoes transformations and may not align to the pixel grid, hinting is disabled by default (`FontHinting::Disabled`). This distinction is important because enabling hinting on non-pixel-aligned text can cause visual artifacts.

The hinting setting needs to be applied at the text block level rather than per text span because it affects the entire text layout process. This is why it's implemented as a component on the text entity rather than a field on `TextFont`. The text pipeline functions that create text layouts and measurements now accept a `hinting` parameter, which is passed through to the cosmic-text buffer's `set_hinting` method.

The changes are minimal and focused. In the text pipeline, when processing text layout, the hinting setting is applied to the cosmic-text buffer before shaping and layout occur. The systems that handle text updates now also check if the `FontHinting` component has changed to trigger re-layout when necessary.

The impact is twofold: the ASCII fastpath bug is fixed, ensuring correct font selection, and users now have control over font hinting behavior. The implementation maintains backward compatibility by providing sensible defaults for different text types.

## Visual Representation

```mermaid
graph TD
    A[cosmic-text 0.16] --> B[Adds font hinting feature]
    B --> C[New FontHinting component]
    C --> D[UI Text: Enabled by default]
    C --> E[Text2d: Disabled by default]
    D --> F[Text pipeline applies hinting]
    E --> F
    F --> G[cosmic-text buffer.set_hinting()]
    H[Fixes ASCII fastpath bug] --> I[Correct font rendering]
```

## Key Files Changed

### `crates/bevy_text/src/text.rs` (+22/-0)
This file adds the new `FontHinting` component enum and its conversion to cosmic-text's `Hinting` type.

```rust
#[derive(Component, Debug, Copy, Clone, Default, Reflect, PartialEq)]
#[reflect(Component, Default, Debug, Clone, PartialEq)]
/// Font hinting strategy.
///
/// <https://docs.rs/cosmic-text/latest/cosmic_text/enum.Hinting.html>
pub enum FontHinting {
    #[default]
    /// Glyphs will have subpixel coordinates.
    Disabled,
    /// Glyphs will be snapped to integral coordinates in the X-axis during layout.
    Enabled,
}

impl From<FontHinting> for cosmic_text::Hinting {
    fn from(value: FontHinting) -> Self {
        match value {
            FontHinting::Disabled => cosmic_text::Hinting::Disabled,
            FontHinting::Enabled => cosmic_text::Hinting::Enabled,
        }
    }
}
```

### `crates/bevy_ui/src/widget/text.rs` (+11/-5)
Adds `FontHinting` as a required component for UI text with `Enabled` as the default, and updates the measurement system to check for hinting changes.

```rust
#[bundle]
pub struct TextBundle {
    // ... other components
    // Enable hinting as UI text is normally pixel-aligned.
    FontHinting::Enabled
)}

// In measure_text_system:
if hinting.is_changed() {
    // Trigger re-measurement
}

// Pass hinting to create_text_measure:
let measure = text_pipeline.create_text_measure(
    // ... other parameters
    *hinting,
);
```

### `crates/bevy_sprite/src/text2d.rs` (+10/-5)
Adds `FontHinting` as a required component for Text2d with `Disabled` as the default, and updates the layout system to check for hinting changes.

```rust
#[bundle]
pub struct Text2dBundle {
    // ... other components
    // Disable hinting as `Text2d` text is not always pixel-aligned
    FontHinting::Disabled
)}

// In update_text2d_layout system:
let text_changed = /* ... */ || hinting.is_changed();

// Pass hinting to create_text_layout:
text_pipeline.create_text_layout(
    // ... other parameters  
    *hinting,
)
```

### `crates/bevy_text/src/pipeline.rs` (+9/-4)
Updates the text pipeline functions to accept and apply the hinting parameter to the cosmic-text buffer.

```rust
pub fn create_text_layout(
    // ... other parameters
    hinting: FontHinting,
) -> Result<(), TextError> {
    // ...
    
    // Set the metrics hinting strategy
    buffer.set_hinting(font_system, hinting.into());
    
    // ...
}

// Similar change in create_text_measure function
```

### `crates/bevy_text/Cargo.toml` (+1/-1)
Updates the cosmic-text dependency version from 0.15 to 0.16.

```toml
cosmic-text = { version = "0.16", features = ["shape-run-cache"] }
```

### `crates/bevy_text/src/lib.rs` (+2/-2)
Exports `FontHinting` in the public prelude for accessibility.

```rust
pub mod prelude {
    #[doc(hidden)]
    pub use crate::{
        Font, FontHinting, FontWeight, /* ... */
    };
}
```

## Further Reading

1. **cosmic-text documentation**: https://docs.rs/cosmic-text/latest/cosmic_text/
2. **Font hinting explained**: https://en.wikipedia.org/wiki/Font_hinting
3. **Bevy Text documentation**: https://docs.rs/bevy_text/latest/bevy_text/
4. **ASCII fastpath bug discussion**: The cosmic-text 0.16 release notes likely detail the fix for this rendering issue