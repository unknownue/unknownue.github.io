+++
title = "#22386 Fix font ID leak in `TextPipeline"
date = "2026-01-07T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = false

[extra]
current_language = "zh-cn"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2026-01/pr-22386-en-20260107" }, "zh-cn" = { name = "ä¸­æ–‡", url = "/pull_request/bevy/2026-01/pr-22386-zh-cn-20260107" }}
+++

# Fix font ID leak in `TextPipeline`

## åŸºæœ¬ä¿¡æ¯
- **æ ‡é¢˜**: Fix font ID leak in `TextPipeline`
- **PRé“¾æ¥**: https://github.com/bevyengine/bevy/pull/22386
- **ä½œè€…**: ickshonpe
- **çŠ¶æ€**: MERGED
- **æ ‡ç­¾**: C-Bug, S-Ready-For-Final-Review, P-Regression, P-Critical, M-Migration-Guide, A-Text, D-Straightforward
- **åˆ›å»ºæ—¶é—´**: 2026-01-05T12:52:31Z
- **åˆå¹¶æ—¶é—´**: 2026-01-07T23:09:55Z
- **åˆå¹¶è€…**: alice-i-cecile

## æè¿°ç¿»è¯‘
### ç›®æ ‡
#22156 å¼•å…¥äº†ä¸€ä¸ªå†…å­˜æ³„æ¼ ğŸ˜“ã€‚æ¯æ¬¡åœ¨ `TextPipeline::update_buffer` ä¸­æ›´æ–°å¸¦æœ‰å­—ä½“å¥æŸ„å­—ä½“æºçš„æ–‡æœ¬æ®µæ—¶ï¼Œéƒ½ä¼šåœ¨cosmic textçš„FontDbä¸­æ·»åŠ ä¸€ä¸ªå…·æœ‰æ–°å­—ä½“IDçš„æ–°å­—ä½“ã€‚

ä¿®å¤ #22419

### è§£å†³æ–¹æ¡ˆ
ä»TextPipelineä¸­ç§»é™¤å­—ä½“åŠ è½½å’Œèµ„äº§IDå…³è”ã€‚ç›¸åï¼Œåœ¨åŠ è½½åå°†å­—ä½“ç³»åˆ—åç§°æ·»åŠ åˆ°`Font`èµ„äº§ä¸­ã€‚ç„¶å`update_buffer`å°±å¯ä»¥ç›´æ¥ä½¿ç”¨èµ„äº§ä¸­çš„ç³»åˆ—åç§°ã€‚

### æµ‹è¯•
å°†æ­¤ç³»ç»Ÿæ·»åŠ åˆ°`text`ç¤ºä¾‹ï¼ˆæˆ–ä»»ä½•å…·æœ‰æ›´æ–°æ–‡æœ¬çš„bevyåº”ç”¨ç¨‹åºï¼‰ä¸­ï¼š
```rust
            .add_systems(Update, |font_system: Res<CosmicFontSystem>| {
                println!("fonts: {}", font_system.db().len());
            })
```
ä½ åº”è¯¥ä¼šè§‚å¯Ÿåˆ°è®¡æ•°éšç€æ¯æ¬¡æ–‡æœ¬æ›´æ–°è€Œå¢åŠ ã€‚ä½¿ç”¨æ­¤PRåï¼Œè®¡æ•°åº”è¯¥ä¿æŒç¨³å®šã€‚

## è¿™ä¸ªPRçš„æ•…äº‹

### é—®é¢˜å’ŒèƒŒæ™¯
è¿™ä¸ªPRè§£å†³äº†ä¸€ä¸ªç”±#22156å¼•å…¥çš„ä¸¥é‡å›å½’é”™è¯¯â€”â€”å†…å­˜æ³„æ¼ã€‚é—®é¢˜çš„æ ¸å¿ƒåœ¨äºæ–‡æœ¬ç®¡é“çš„å­—ä½“IDç®¡ç†ã€‚åœ¨ä¹‹å‰çš„å®ç°ä¸­ï¼Œæ¯å½“ä½¿ç”¨å­—ä½“å¥æŸ„æ›´æ–°æ–‡æœ¬æ—¶ï¼Œ`TextPipeline::update_buffer`éƒ½ä¼šå‘cosmic textçš„FontDbæ·»åŠ æ–°çš„å­—ä½“IDï¼Œè€Œä¹‹å‰çš„å­—ä½“IDæ²¡æœ‰è¢«ç§»é™¤ã€‚è¿™å¯¼è‡´FontDbä¸­çš„å­—ä½“æ•°é‡æŒç»­å¢é•¿ï¼Œæœ€ç»ˆå¯èƒ½å¯¼è‡´å†…å­˜è€—å°½ã€‚

è¿™ä¸ªé—®é¢˜è¢«æ ‡è®°ä¸ºP-Criticalï¼ˆä¸¥é‡ï¼‰å’ŒP-Regressionï¼ˆå›å½’ï¼‰ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªæ–°å¼•å…¥çš„é”™è¯¯ä¸”å½±å“ä¸¥é‡ã€‚ä½œè€…ickshonpeå‘ç°äº†è¿™ä¸ªé—®é¢˜ï¼Œå¹¶æä¾›äº†ä¿®å¤æ–¹æ¡ˆã€‚

### è§£å†³æ–¹æ¡ˆæ–¹æ³•
åŸæ¥çš„è®¾è®¡å­˜åœ¨ä¸€ä¸ªæ¶æ„é—®é¢˜ï¼š`TextPipeline`è´Ÿè´£ç®¡ç†å­—ä½“IDçš„æ˜ å°„å’Œå­—ä½“çš„é‡å¤åŠ è½½ã€‚æ¯æ¬¡æ–‡æœ¬æ›´æ–°æ—¶ï¼Œå¦‚æœä½¿ç”¨å­—ä½“å¥æŸ„ï¼Œç³»ç»Ÿéƒ½ä¼šï¼š
1. ä»å­—ä½“èµ„äº§åŠ è½½å­—ä½“æ•°æ®
2. å°†å­—ä½“æ·»åŠ åˆ°FontDbï¼ˆç”Ÿæˆæ–°çš„IDï¼‰
3. è®°å½•èµ„äº§IDåˆ°å­—ä½“IDçš„æ˜ å°„

è¿™ç§æ–¹æ³•å¯¼è‡´äº†é‡å¤çš„å­—ä½“åŠ è½½å’ŒIDåˆ†é…ã€‚æ–°çš„æ–¹æ¡ˆé‡æ–°è®¾è®¡äº†è´£ä»»åˆ†é…ï¼š
- **å­—ä½“åŠ è½½**ï¼šç§»åˆ°å­—ä½“èµ„äº§åŠ è½½æ—¶æ‰§è¡Œ
- **å­—ä½“ä¿¡æ¯å­˜å‚¨**ï¼šå°†å­—ä½“ç³»åˆ—åç§°å­˜å‚¨åœ¨å­—ä½“èµ„äº§ä¸­
- **æ–‡æœ¬å¸ƒå±€**ï¼šç›´æ¥ä»å­—ä½“èµ„äº§è·å–ç³»åˆ—åç§°ï¼Œä¸å†é‡å¤åŠ è½½å­—ä½“

è¿™ç§åˆ†ç¦»ä½¿å¾—å­—ä½“ç®¡ç†æ›´åŠ æ¸…æ™°ï¼Œé¿å…äº†é‡å¤æ“ä½œã€‚

### å®ç°ç»†èŠ‚
å®ç°çš„å…³é”®ä¿®æ”¹åŒ…æ‹¬ä¸‰ä¸ªéƒ¨åˆ†ï¼š

**1. æ‰©å±•Fontç»“æ„ä½“**
åœ¨`Font`èµ„äº§ä¸­æ·»åŠ `family_name`å­—æ®µï¼Œç”¨äºå­˜å‚¨ä»å­—ä½“æ–‡ä»¶ä¸­æå–çš„å­—ä½“ç³»åˆ—åç§°ã€‚è¿™ä¸ªå­—æ®µåœ¨å­—ä½“åŠ è½½åˆ°FontDbæ—¶è¢«å¡«å……ã€‚

**2. é‡æ„å­—ä½“åŠ è½½ç³»ç»Ÿ**
åœ¨`load_font_assets_into_fontdb_system`ä¸­ï¼Œå½“å­—ä½“èµ„äº§è¢«åŠ è½½æ—¶ï¼Œæˆ‘ä»¬å°†å…¶æ·»åŠ åˆ°cosmic textçš„FontDbä¸­ï¼ŒåŒæ—¶ä»åŠ è½½çš„å­—ä½“ä¸­æå–ç³»åˆ—åç§°ï¼š

```rust
font.family_name = font_system
    .db()
    .face(*font.ids.last().unwrap())
    .unwrap()
    .families[0]
    .0
    .as_str()
    .into();
```

**3. ç®€åŒ–TextPipeline**
`TextPipeline`ç§»é™¤äº†ç®¡ç†å­—ä½“IDæ˜ å°„çš„å¤æ‚é€»è¾‘ï¼Œ`update_buffer`æ–¹æ³•ç°åœ¨ç›´æ¥ä½¿ç”¨å­—ä½“èµ„äº§ä¸­çš„ç³»åˆ—åç§°ï¼š

```rust
let family_name: SmolStr = match &text_font.font {
    FontSource::Handle(handle) => {
        fonts
            .get(handle.id())
            .ok_or(TextError::NoSuchFont)?
            .family_name
            .clone()
    }
    FontSource::Family(family) => family.clone(),
};
```

### æŠ€æœ¯æ´å¯Ÿ
è¿™ä¸ªä¿®å¤å±•ç¤ºäº†å‡ ä¸ªé‡è¦çš„è½¯ä»¶å·¥ç¨‹åŸåˆ™ï¼š

1. **å…³æ³¨ç‚¹åˆ†ç¦»**ï¼šå°†å­—ä½“åŠ è½½çš„è´£ä»»ä»æ–‡æœ¬å¸ƒå±€ä¸­åˆ†ç¦»å‡ºæ¥ã€‚å­—ä½“åŠ è½½ç°åœ¨æ˜¯èµ„äº§ç®¡ç†çš„ä¸€éƒ¨åˆ†ï¼Œè€Œæ–‡æœ¬å¸ƒå±€åªå…³å¿ƒå¦‚ä½•ä½¿ç”¨å·²åŠ è½½çš„å­—ä½“ã€‚

2. **é¿å…é‡å¤å·¥ä½œ**ï¼šä¹‹å‰çš„å®ç°åœ¨æ¯æ¬¡æ–‡æœ¬æ›´æ–°æ—¶éƒ½é‡æ–°åŠ è½½å­—ä½“ï¼Œè¿™æ˜¯ä½æ•ˆä¸”å®¹æ˜“å‡ºé”™çš„ã€‚æ–°çš„è®¾è®¡ç¡®ä¿å­—ä½“åªåŠ è½½ä¸€æ¬¡ã€‚

3. **æ­£ç¡®ä½¿ç”¨èµ„äº§ç³»ç»Ÿ**ï¼šBevyçš„èµ„äº§ç³»ç»Ÿè®¾è®¡ç”¨äºç®¡ç†èµ„æºçš„ç”Ÿå‘½å‘¨æœŸï¼Œå°†å­—ä½“ä¿¡æ¯å­˜å‚¨åœ¨èµ„äº§ä¸­è®©ç³»ç»Ÿèƒ½å¤Ÿæ­£ç¡®åœ°ç®¡ç†è¿™äº›èµ„æºã€‚

4. **å‘åå…¼å®¹æ€§**ï¼šè™½ç„¶ç§»é™¤äº†å…¬å…±APIï¼ˆ`map_handle_to_font_id`å’Œ`get_font_id`ï¼‰ï¼Œä½†æä¾›äº†è¿ç§»æŒ‡å—ï¼ŒæŒ‡å¯¼ç”¨æˆ·å¦‚ä½•é€šè¿‡å­—ä½“èµ„äº§è·å–ç›¸åŒçš„ä¿¡æ¯ã€‚

### å½±å“
è¿™ä¸ªä¿®å¤å¸¦æ¥äº†ä»¥ä¸‹å…·ä½“æ”¹è¿›ï¼š

1. **å†…å­˜æ³„æ¼ä¿®å¤**ï¼šFontDbä¸­çš„å­—ä½“æ•°é‡ä¸å†æ— é™åˆ¶å¢é•¿ï¼Œè§£å†³äº†å†…å­˜æ³„æ¼é—®é¢˜ã€‚

2. **æ€§èƒ½æå‡**ï¼šé¿å…äº†æ¯æ¬¡æ–‡æœ¬æ›´æ–°æ—¶çš„å­—ä½“é‡å¤åŠ è½½ã€‚

3. **ä»£ç ç®€åŒ–**ï¼šç§»é™¤äº†`TextPipeline`ä¸­å¤æ‚çš„æ˜ å°„ç®¡ç†é€»è¾‘ï¼Œä½¿ä»£ç æ›´å®¹æ˜“ç†è§£å’Œç»´æŠ¤ã€‚

4. **æ¶æ„æ”¹è¿›**ï¼šæ›´æ¸…æ™°åœ°åˆ†ç¦»äº†å­—ä½“åŠ è½½å’Œæ–‡æœ¬å¸ƒå±€çš„è´£ä»»ã€‚

æµ‹è¯•ç³»ç»Ÿæ˜¾ç¤ºäº†ä¿®å¤çš„æ•ˆæœï¼šåœ¨ä¿®å¤å‰ï¼Œæ¯æ¬¡æ–‡æœ¬æ›´æ–°éƒ½ä¼šå¢åŠ FontDbä¸­çš„å­—ä½“æ•°é‡ï¼›ä¿®å¤åï¼Œå­—ä½“æ•°é‡ä¿æŒç¨³å®šã€‚

## å¯è§†åŒ–è¡¨ç¤º
```mermaid
graph TD
    A[Font Asset Loading] -->|Store| B[Font Asset with family_name]
    B -->|Retrieve| C[TextPipeline]
    D[Cosmic FontDb] -->|Load once| A
    C -->|Use family_name| E[Text Layout]
```

## å…³é”®æ–‡ä»¶æ›´æ”¹

### 1. `crates/bevy_text/src/font.rs`
- **æ›´æ”¹æè¿°**ï¼šåœ¨`Font`ç»“æ„ä½“ä¸­æ·»åŠ `family_name`å­—æ®µï¼Œå¹¶åœ¨å­—ä½“åŠ è½½æ—¶ä»cosmic textçš„FontDbä¸­æå–å­—ä½“ç³»åˆ—åç§°ã€‚
- **ä»£ç ç‰‡æ®µ**ï¼š
```rust
// æ·»åŠ çš„å­—æ®µ
pub struct Font {
    pub data: Arc<Vec<u8>>,
    pub ids: SmallVec<[ID; 8]>,
    pub family_name: SmolStr,  // æ–°å¢å­—æ®µ
}

// åœ¨åŠ è½½ç³»ç»Ÿï¿½ï¿½ï¿½è®¾ç½®family_name
font.family_name = font_system
    .db()
    .face(*font.ids.last().unwrap())
    .unwrap()
    .families[0]
    .0
    .as_str()
    .into();
```

### 2. `crates/bevy_text/src/pipeline.rs`
- **æ›´æ”¹æè¿°**ï¼šç§»é™¤`map_handle_to_font_id`å­—æ®µå’Œ`get_font_id`æ–¹æ³•ï¼Œç®€åŒ–`update_buffer`æ–¹æ³•ã€‚
- **ä»£ç ç‰‡æ®µ**ï¼š
```rust
// ä¹‹å‰ï¼šç»´æŠ¤å¤æ‚çš„æ˜ å°„
pub map_handle_to_font_id: HashMap<AssetId<Font>, (ID, Arc<str>)>,

// ä¹‹åï¼šç›´æ¥ä½¿ç”¨å­—ä½“èµ„äº§ä¸­çš„family_name
let family_name: SmolStr = match &text_font.font {
    FontSource::Handle(handle) => {
        fonts
            .get(handle.id())
            .ok_or(TextError::NoSuchFont)?
            .family_name
            .clone()
    }
    FontSource::Family(family) => family.clone(),
};
```

### 3. `crates/bevy_sprite/src/text2d.rs`
- **æ›´æ”¹æè¿°**ï¼šæ›´æ–°æµ‹è¯•ä»£ç ä»¥é€‚é…æ–°çš„è®¾è®¡ï¼Œæ‰‹åŠ¨è®¾ç½®å­—ä½“å®¶æ—åç§°ã€‚
- **ä»£ç ç‰‡æ®µ**ï¼š
```rust
let font = fonts.get_mut(bevy_asset::AssetId::default()).unwrap();
font.family_name = "Fira Mono".into();
let data = font.data.as_ref().clone();

app.world_mut()
    .resource_mut::<CosmicFontSystem>()
    .db_mut()
    .load_font_data(data);
```

### 4. `release-content/migration-guides/map_handle_to_font_id-and-get_font_id-removed-from-TextPipeline.md`
- **æ›´æ”¹æè¿°**ï¼šæ–°å¢è¿ç§»æŒ‡å—ï¼Œè¯´æ˜ç§»é™¤çš„APIå’Œæ›¿ä»£æ–¹æ¡ˆã€‚
- **å†…å®¹**ï¼š
```markdown
---
title: "`map_handle_to_font_id` and `get_font_id` have been removed from `TextPipeline`"
pull_requests: [22385]
---

`map_handle_to_font_id`å’Œ`get_font_id`å·²ä»`TextPipeline`ä¸­ç§»é™¤ã€‚

å¯ä»¥ä»`Font`èµ„äº§æœ¬èº«æ£€ç´¢å…¶`ID`å’Œç³»åˆ—åç§°ã€‚
```

## è¿›ä¸€æ­¥é˜…è¯»
- [cosmic_text crate](https://crates.io/crates/cosmic-text)ï¼šBevyä½¿ç”¨çš„æ–‡æœ¬å¸ƒå±€å¼•æ“
- [Bevy Assets ç³»ç»Ÿ](https://bevyengine.org/learn/book/features/assets/)ï¼šäº†è§£Bevyçš„èµ„äº§ç®¡ç†æœºåˆ¶
- [å†…å­˜æ³„æ¼æ£€æµ‹æ¨¡å¼](https://en.wikipedia.org/wiki/Memory_leak)ï¼šå­¦ä¹ å¦‚ä½•è¯†åˆ«å’Œä¿®å¤å†…å­˜æ³„æ¼
- [å…³æ³¨ç‚¹åˆ†ç¦»åŸåˆ™](https://en.wikipedia.org/wiki/Separation_of_concerns)ï¼šè½¯ä»¶æ¶æ„ä¸­çš„é‡è¦è®¾è®¡åŸåˆ™