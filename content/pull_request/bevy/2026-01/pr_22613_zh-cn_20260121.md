+++
title = "#22613 Bump the accesskit group with 2 updates"
date = "2026-01-21T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = false

[extra]
current_language = "zh-cn"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2026-01/pr-22613-en-20260121" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2026-01/pr-22613-zh-cn-20260121" }}
+++

# Title: Bump the accesskit group with 2 updates

## Basic Information
- **标题 (Title)**: Bump the accesskit group with 2 updates
- **PR 链接 (PR Link)**: https://github.com/bevyengine/bevy/pull/22613
- **作者 (Author)**: mnmaita
- **状态 (Status)**: 已合并 (MERGED)
- **标签 (Labels)**: C-Dependencies, A-Accessibility, S-Ready-For-Final-Review, D-Straightforward
- **创建时间 (Created)**: 2026-01-20T23:23:45Z
- **合并时间 (Merged)**: 2026-01-21T17:55:13Z
- **合并者 (Merged By)**: alice-i-cecile

## Description Translation
**目标 (Objective)**
- 关闭 (Closes) #22540。

**解决方案 (Solution)**
- 将 `accesskit` 更新至 0.23.0。
- 将 `accesskit_winit` 更新至 0.31.0。
- 处理了不兼容的变更 (多棵树支持)。

**测试 (Testing)**
- 通过了 CI 检查。

## The Story of This Pull Request

这个 Pull Request 的故事始于一个常规但重要的维护任务：更新依赖库。具体来说，项目依赖的 `accesskit` 及其平台集成库 `accesskit_winit` 发布了新版本。`accesskit` 是一个为应用程序提供辅助功能 (Accessibility, 如屏幕阅读器支持) API 的 Rust 库。

为什么需要更新？直接原因是问题 #22540 被创建来追踪这个更新需求。保持依赖项处于较新版本通常是好的实践，可以获取错误修复、性能改进和新功能。但更重要的是，新版本可能包含了对安全性、稳定性或兼容性至关重要的补丁。在这个案例中，`accesskit` 从 0.22 升级到 0.23，`accesskit_winit` 从 0.30 升级到 0.31。根据语义化版本控制 (SemVer)，主版本号 (0.x) 不变但次版本号增加，可能引入向后不兼容的 API 变更，这通常需要开发者对代码进行相应调整。

开发者面临的挑战是适配这些不兼容变更。PR 描述中提到“Addressed breaking changes (multiple tree support)”，这表明新版本的 `accesskit` API 发生了变化，核心变化是支持多棵辅助功能树 (multiple accessibility trees)。在之前的 API 中，可能隐含地只处理一棵树。为了明确支持多棵树，库的 `TreeUpdate` 结构体需要包含一个 `tree_id` 字段来标识是哪一棵树在更新。

解决方案非常直接。开发者需要做两件事：1) 在所有相关的 `Cargo.toml` 文件中更新版本号；2) 在代码中适配新的 API。从实现来看，更新版本号是机械性的，但需要确保所有引用这些 crate 的模块都同步更新，以避免版本冲突。Bevy 引擎是模块化的，因此 `accesskit` 被多个内部 crate 使用，包括 `bevy_a11y` (a11y 是 accessibility 的缩写)、`bevy_ui`、`bevy_winit` 等。开发者正确地更新了所有 6 个相关 `Cargo.toml` 文件中的版本字符串。

代码适配的核心在于 `crates/bevy_winit/src/accessibility.rs` 文件。这里定义了一个 `AccessKitState` 结构体，它负责管理辅助功能树并与 `winit` 窗口系统交互。关键的改动是构造 `TreeUpdate` 对象的地方。在新 API 下，创建 `TreeUpdate` 时必须指定 `tree_id` 字段。开发者通过引入 `TreeId` 类型并为其设置默认值 `TreeId::ROOT` 来适配这个变化。

```rust
// 文件: crates/bevy_winit/src/accessibility.rs
// 修改前（部分代码示意）：
// 在 `update_adapter` 函数中构建 TreeUpdate
TreeUpdate {
    nodes: to_update,
    tree: None,
    // 缺少 tree_id 字段
    focus: NodeId(...),
}

// 在 `new_window_tree_update` 函数中也是类似情况。
```

```rust
// 文件: crates/bevy_winit/src/accessibility.rs
// 修改后：
// 首先需要在文件顶部导入 TreeId
use accesskit::{..., TreeId, ...};

// 然后在构建 TreeUpdate 的两个地方都添加了 tree_id 字段
// 例如在 `update_adapter` 函数中：
TreeUpdate {
    nodes: to_update,
    tree: None,
    tree_id: TreeId::ROOT, // 新增行
    focus: NodeId(...),
}
```
这个改动虽然小，但至关重要。它确保了 Bevy 在更新到新版 `accesskit` 后，构建的辅助功能树更新数据结构是完整的，从而维持了应用程序对屏幕阅读器等辅助技术的支持。

从工程角度看，这是一个典型的依赖升级工作流：识别需要更新的库，更新版本号，阅读更新日志或测试以发现破坏性变更，然后进行必要的代码调整。这个 PR 的标签 `D-Straightforward` 和 `S-Ready-For-Final-Review` 准确地反映了其性质：变更直接明了，范围清晰，经过 CI 测试后即可合并。

最终，这个 PR 被成功合并，完成了依赖项更新，修复了相关 issue，并使 Bevy 引擎的辅助功能支持建立在更新、更稳定的库版本之上。

## Visual Representation

以下 Mermaid 图展示了此 PR 中更新的主要组件及其依赖关系：
```mermaid
graph TD
    subgraph “外部依赖 (External Dependencies)”
        AK[accesskit 0.23.0]
        AKW[accesskit_winit 0.31.0]
    end

    subgraph “Bevy 核心模块 (Bevy Core Modules)”
        A11Y[bevy_a11y]
        UI[bevy_ui]
        WIDGETS[bevy_ui_widgets]
        WINIT[bevy_winit]
        FEATHERS[bevy_feathers]
        WORKSPACE[工作区根目录<br/>(Workspace Root)]
    end

    AK --> A11Y
    AK --> UI
    AK --> WIDGETS
    AK --> FEATHERS

    AK --> WINIT
    AKW --> WINIT

    WINIT --> WORKSPACE
    A11Y --> WORKSPACE
    UI --> WORKSPACE
    WIDGETS --> WORKSPACE
    FEATHERS --> WORKSPACE
```
图中显示了更新后的 `accesskit` 和 `accesskit_winit` 如何被 Bevy 的不同内部模块所依赖。`bevy_winit` 模块同时依赖这两个外部库，因为它负责窗口系统集成。

## Key Files Changed

以下是此 PR 中更改的关键文件：

1. **`crates/bevy_winit/src/accessibility.rs`** (+3/-1)
   - **描述 (Description)**: 这是适配 `accesskit` API 破坏性变更的核心代码文件。主要修改是处理 `TreeUpdate` 结构体新增的 `tree_id` 字段。
   - **代码片段 (Code Snippet)**:
```rust
// 修改前（相关行）：
use accesskit::{
    ActionHandler, ActionRequest, ActivationHandler, DeactivationHandler, Node, NodeId, Role, Tree,
    TreeUpdate,
};

// 在 `new_window_tree_update` 和 `update_adapter` 函数中构建 TreeUpdate 时没有 `tree_id` 字段。
```
```rust
// 修改后：
use accesskit::{
    ActionHandler, ActionRequest, ActivationHandler, DeactivationHandler, Node, NodeId, Role, Tree,
    TreeId, TreeUpdate, // 新增了 TreeId 导入
};

// 在 `new_window_tree_update` 函数中：
    TreeUpdate {
        nodes: vec![(accesskit_window_id, root)],
        tree: Some(tree),
        tree_id: TreeId::ROOT, // 新增行
        focus: accesskit_window_id,
    }

// 在 `update_adapter` 函数中：
    TreeUpdate {
        nodes: to_update,
        tree: None,
        tree_id: TreeId::ROOT, // 新增行
        focus: NodeId(focus.0.unwrap_or(primary_window_id).to_bits()),
    }
```
   - **关联性 (Relation)**: 这些修改直接对应 PR 解决方案中提到的“处理破坏性变更（多棵树支持）”，是本次更新的技术核心。

2. **`crates/bevy_winit/Cargo.toml`** (+2/-2)
   - **描述 (Description)**: 更新了 `bevy_winit` 模块所依赖的 `accesskit` 和 `accesskit_winit` 的版本。
   - **代码片段 (Code Snippet)**:
```toml
# 修改前：
accesskit_winit = { version = "0.30", ... }
accesskit = "0.22"
```
```toml
# 修改后：
accesskit_winit = { version = "0.31", ... } # 0.30 -> 0.31
accesskit = "0.23" # 0.22 -> 0.23
```
   - **关联性 (Relation)**: 这是版本更新的起点之一，`bevy_winit` 是连接窗口系统与辅助功能的主要模块。

3. **`Cargo.toml`** (工作区根目录) (+1/-1)
   - **描述 (Description)**: 更新了工作区根目录下 `accesskit` 的版本，这会影响工作区级别的依赖解析。
   - **代码片段 (Code Snippet)**:
```toml
# 修改前：
accesskit = "0.22"
```
```toml
# 修改后：
accesskit = "0.23"
```
   - **关联性 (Relation)**: 确保整个工作区使用统一的新版本。

4. **`crates/bevy_a11y/Cargo.toml`, `crates/bevy_ui/Cargo.toml`, `crates/bevy_ui_widgets/Cargo.toml`, `crates/bevy_feathers/Cargo.toml`** (各文件+1/-1)
   - **描述 (Description)**: 这些是其他内部模块的清单文件，它们也直接依赖 `accesskit`，需要同步更新版本以避免冲突。
   - **关联性 (Relation)**: 这体现了维护一个大型 Rust 工作区时依赖管理的一致性要求。必须更新所有使用该依赖的模块。

## Further Reading

- **`accesskit` 仓库与发布说明 (accesskit Repository & Release Notes)**: 要了解 0.23.0 版本具体引入了哪些变更（尤其是多棵树支持），最好的方式是查看其官方仓库的发布说明或提交历史。
- **语义化版本控制 (Semantic Versioning - SemVer)**: 理解 SemVer 规则（https://semver.org/）有助于预测依赖更新可能带来的影响，以及为什么 0.22 到 0.23 可能需要代码适配。
- **Rust 中的辅助功能 (Accessibility in Rust)**: 对于想深入了解如何在 Rust 应用中实现辅助功能的开发者，可以研究 `accesskit` 库的文档和示例。