+++
title = "#20708 use affine not mat4 inverse in light probes"
date = "2025-08-24T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = false

[extra]
current_language = "zh-cn"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-08/pr-20708-en-20250824" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-08/pr-20708-zh-cn-20250824" }}
labels = ["A-Rendering"]
+++

# Title
use affine not mat4 inverse in light probes

## Basic Information
- **Title**: use affine not mat4 inverse in light probes
- **PR Link**: https://github.com/bevyengine/bevy/pull/20708
- **Author**: atlv24
- **Status**: MERGED
- **Labels**: A-Rendering, S-Ready-For-Final-Review
- **Created**: 2025-08-22T08:16:30Z
- **Merged**: 2025-08-24T21:19:39Z
- **Merged By**: alice-i-cecile

## Description Translation
# Objective

- 保持仿射变换以获得更好的逆矩阵性能

## Solution

- 

## Testing

- 反射探针示例

## The Story of This Pull Request

这个 PR 解决了一个渲染性能优化问题。在 Bevy 的 PBR 渲染系统中，光照探针（light probes）使用变换矩阵来计算世界空间和探针空间之间的坐标转换。之前的实现使用完整的 4x4 矩阵（Mat4）进行逆变换计算，这在计算上比较昂贵且可能存在数值精度问题。

光照探针的变换本质上是仿射变换（Affine3A），只包含旋转、平移和缩放，不包含投影成分。使用专门的仿射变换类型进行逆变换计算更加高效和数值稳定，因为仿射变换的逆矩阵计算比通用 4x4 矩阵的逆更简单快速。

开发者将 `LightProbeInfo` 结构体中的 `light_from_world` 字段从 `Mat4` 类型改为 `Affine3A` 类型，这更准确地表示了该变换的数学性质。相应的计算也改为使用 `light_probe_transform.affine().inverse()` 而不是 `light_probe_transform.to_matrix().inverse()`。

在准备光照探针数据用于 GPU 渲染时，代码需要将仿射变换转换回 4x4 矩阵并进行转置，以适应 GPU 的内存布局要求。这里通过 `Mat4::from(light_probe.light_from_world).transpose()` 实现，保持了与之前兼容的数据格式。

这种优化减少了矩阵逆运算的计算开销，提高了渲染性能，同时保持了相同的功能。由于光照探针在实时渲染中可能大量使用，这种微优化在整体性能上会产生可观的累积效果。

## Visual Representation

```mermaid
graph LR
    A[LightProbe Transform] --> B[Affine3A inverse]
    B --> C[GPU Data Preparation]
    C --> D[Render Light Probes]
```

## Key Files Changed

**文件**: `crates/bevy_pbr/src/light_probe/mod.rs`

**变更描述**: 将光照探针的逆矩阵计算从通用 4x4 矩阵改为专门的仿射变换类型，提高计算效率和数值稳定性。

**关键代码变更**:
```rust
// 之前:
light_from_world: Mat4,

// 之后:
light_from_world: Affine3A,
```

```rust
// 之前:
light_from_world: light_probe_transform.to_matrix().inverse(),

// 之后:
light_from_world: light_probe_transform.affine().inverse(),
```

```rust
// 之前:
let light_from_world_transposed = light_probe.light_from_world.transpose();

// 之后:
let light_from_world_transposed = Mat4::from(light_probe.light_from_world).transpose();
```

## Further Reading

- [Affine Transformations - Wikipedia](https://en.wikipedia.org/wiki/Affine_transformation)
- [Bevy Transform Documentation](https://docs.rs/bevy/latest/bevy/transform/components/struct.Transform.html)
- [Computer Graphics: Principles and Practice - 关于仿射变换和矩阵优化的章节]