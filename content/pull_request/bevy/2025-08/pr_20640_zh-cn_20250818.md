+++
title = "#20640 pin CI to macos 14 until iOS example is updated and fix `invalid_params` tests"
date = "2025-08-18T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = false

[extra]
current_language = "zh-cn"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-08/pr-20640-en-20250818" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-08/pr-20640-zh-cn-20250818" }}
+++

# PR分析报告：pin CI to macos 14 until iOS example is updated and fix `invalid_params` tests

## 基本信息
- **标题**: pin CI to macos 14 until iOS example is updated and fix `invalid_params` tests
- **PR链接**: https://github.com/bevyengine/bevy/pull/20640
- **作者**: mockersf
- **状态**: 已合并
- **标签**: A-Build-System, S-Ready-For-Final-Review, P-Critical
- **创建时间**: 2025-08-18T18:41:24Z
- **合并时间**: 2025-08-18T20:34:57Z
- **合并者**: alice-i-cecile

## 描述翻译
**目标**  
- GitHub 刚刚将 Bevy 仓库的 CI 镜像更新为 macos-15  
- 这导致 iOS 构建失败，因为我们使用的 SDK 不再可用  
- 同时关闭 #20629  

**解决方案**  
- 在更新 iOS 示例前，将 CI 固定到 macos-14  

## 这个PR的故事

### 问题和背景
GitHub 最近将其默认的 macOS CI runner 从 macOS 14 升级到 macOS 15，这个变更直接影响了 Bevy 的 iOS 构建流程。iOS 开发依赖于特定的 SDK 和工具链，这些组件在 macOS 15 环境中不再可用，导致 CI 流水线中的 iOS 构建任务失败。这个问题被归类为 P-Critical（关键优先级），因为它阻塞了正常的开发工作流和合并流程。同时，开发团队还发现两个与参数验证相关的测试用例（`invalid_params` tests）存在脆弱性问题，这些测试对错误消息字符串进行了精确匹配，导致在环境变化时容易失败。

### 解决方案方法
作者采用了双重解决方案：  
1. 将所有 macOS CI runner 显式固定到 `macos-14`，绕过 macOS 15 的兼容性问题  
2. 重构脆弱的测试用例，使其验证错误消息的核心内容而非完整字符串  

这种方法避免了立即进行大规模的 iOS 示例更新，同时保持了 CI 的可靠性。测试修复则采用最小化变更原则，只调整断言逻辑而不修改生产代码。

### 实现细节
#### CI 配置修复
所有 GitHub Actions 工作流文件中引用 `macos-latest` 的地方都被替换为 `macos-14`：

```diff
# .github/workflows/example-run.yml
-    runs-on: macos-latest
+    runs-on: macos-14

# .github/workflows/update-caches.yml
-          - os: macos-latest
+          - os: macos-14

# .github/workflows/validation-jobs.yml
-    runs-on: macos-latest
+    runs-on: macos-14
```

这些变更确保 CI 任务继续使用 macOS 14 环境，其中 iOS SDK 仍然可用。在 `send-screenshots-to-pixeleagle.yml` 中还修复了一个 shell 变量引用问题：

```diff
-          metadata='{"os":"${{ inputs.os }}", "commit": "${{ inputs.commit }}", "branch": "$branch"}'
+          metadata='{"os":"${{ inputs.os }}", "commit": "${{ inputs.commit }}", "branch": "'$branch'"}'
```

这个修复确保 `$branch` 变量被正确展开，而不是作为字面字符串处理。

#### 测试用例修复
在 `system.rs` 和 `system_registry.rs` 中，作者重构了测试断言逻辑：

```rust
// crates/bevy_ecs/src/system/system.rs
-        let expected = "Parameter `Res<T>` failed validation: Resource does not exist\n";
-        assert!(result.unwrap_err().to_string().contains(expected));
+        let expected = "Resource does not exist";
+        let actual = result.unwrap_err().to_string();
+        assert!(
+            actual.contains(expected),
+            "Expected error message to contain `{}` but got `{}`",
+            expected,
+            actual
+        );
```

变更前，测试要求错误消息完全匹配包含前缀的完整字符串。变更后，测试只验证错误消息中是否包含关键短语 "Resource does not exist"，同时添加了诊断输出以便失败时调试。这种修改使测试对消息格式变化更具弹性，同时保持核心验证逻辑不变。

### 技术洞察
1. **CI 环境固定**：使用特定版本标签（如 `macos-14`）而非 `latest` 可避免上游环境变更导致的突发构建失败  
2. **测试健壮性**：验证错误消息的子串而非完整字符串可减少测试脆弱性，同时保持核心语义验证  
3. **最小变更原则**：所有修改都局限在必要范围内，没有引入不必要的重构或架构变更  

### 影响
1. 立即恢复 iOS 相关 CI 任务的正常运作  
2. 消除两个测试用例的环境敏感性，提高测试套件可靠性  
3. 关闭相关 issue #20629，解决已知问题  
4. 为 iOS 示例更新争取时间窗口，避免仓促修复  

## 关键文件变更
1. **`.github/workflows/example-run.yml`**  
   修复 macOS runner 版本  
   ```diff
   -    runs-on: macos-latest
   +    runs-on: macos-14
   ```

2. **`.github/workflows/send-screenshots-to-pixeleagle.yml`**  
   修复变量展开问题并更新 runner  
   ```diff
   -          metadata='{"os":"${{ inputs.os }}", "commit": "${{ inputs.commit }}", "branch": "$branch"}'
   +          metadata='{"os":"${{ inputs.os }}", "commit": "${{ inputs.commit }}", "branch": "'$branch'"}'
   ```

3. **`.github/workflows/update-caches.yml`**  
   更新缓存任务的运行环境  
   ```diff
   -          - os: macos-latest
   +          - os: macos-14
   ```

4. **`.github/workflows/validation-jobs.yml`**  
   修复 iOS 验证任务的环境  
   ```diff
   -    runs-on: macos-latest
   +    runs-on: macos-14
   ```

5. **`crates/bevy_ecs/src/system/system.rs`**  
   重构测试断言逻辑  
   ```diff
   -        let expected = "Parameter `Res<T>` failed validation: Resource does not exist\n";
   -        assert!(result.unwrap_err().to_string().contains(expected));
   +        let expected = "Resource does not exist";
   +        let actual = result.unwrap_err().to_string();
   +        assert!(
   +            actual.contains(expected),
   +            "Expected error message to contain `{}` but got `{}`",
   +            expected,
   +            actual
   +        );
   ```

6. **`crates/bevy_ecs/src/system/system_registry.rs`**  
   应用相同的测试修复模式  
   ```diff
   -        let expected = "System returned error: Parameter `Res<T>` failed validation: Resource does not exist\n";
   -        assert!(result.unwrap_err().to_string().contains(expected));
   +        let expected = "Resource does not exist";
   +        let actual = result.unwrap_err().to_string();
   +        assert!(
   +            actual.contains(expected),
   +            "Expected error message to contain `{}` but got `{}`",
   +            expected,
   +            actual
   +        );
   ```

## 进一步阅读
1. [GitHub Actions 运行器镜像文档](https://docs.github.com/en/actions/using-github-hosted-runners/about-github-hosted-runners)  
2. [编写健壮测试的最佳实践](https://softwareengineering.stackexchange.com/questions/234024/how-to-write-unit-tests-that-dont-break-when-refactoring)  
3. [Bevy ECS 系统参数验证机制](https://bevyengine.org/learn/book/getting-started/ecs/#system-parameters)