+++
title = "#20625 bevy_reflect gating / better compile error message"
date = "2025-08-17T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = true

[taxonomies]
list_display = ["show"]

[extra]
current_language = "en"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-08/pr-20625-en-20250817" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-08/pr-20625-zh-cn-20250817" }}
labels = ["C-Docs", "D-Trivial", "C-Code-Quality"]
+++

## bevy_reflect gating / better compile error message

### Basic Information
- **Title**: bevy_reflect gating / better compile error message
- **PR Link**: https://github.com/bevyengine/bevy/pull/20625
- **Author**: mockersf
- **Status**: MERGED
- **Labels**: C-Docs, D-Trivial, C-Code-Quality, S-Ready-For-Final-Review
- **Created**: 2025-08-17T19:33:07Z
- **Merged**: 2025-08-17T22:32:31Z
- **Merged By**: alice-i-cecile

### Description Translation
# Objective

- next batch of compile issues
- I think that's the last for now... until we add more

## Solution

- gate bevy_reflect properly in bevy_window
- improve compile error when auto_register is enabled but not "*_inventory" or "*_static" is. Error is currently:
```
error[E0425]: cannot find function `register_types` in module `crate::__macro_exports::auto_register`
   --> crates/bevy_reflect/src/type_registry.rs:158:48
    |
158 |         crate::__macro_exports::auto_register::register_types(self);
    |                                                ^^^^^^^^^^^^^^ not found in `crate::__macro_exports::auto_register`
```

### The Story of This Pull Request

#### The Problem and Context
This PR addresses two distinct but related compilation issues in the Bevy engine. First, in `bevy_window`, the reflection system (`bevy_reflect`) wasn't properly feature-gated. When users disabled `bevy_reflect`, compilation would fail because reflection-specific attributes and derives were still present in cursor-related code. 

Second, in `bevy_reflect` itself, when users enabled the `auto_register` feature but didn't select either the `auto_register_inventory` or `auto_register_static` backend, they encountered an obscure compilation error about a missing `register_types` function. The error didn't explain that the problem was caused by missing backend selection, leading to confusion and wasted debugging time.

#### The Solution Approach
The solution involved two complementary fixes:

1. **Feature Gating**: For `bevy_window`, we needed to conditionally include reflection-related code only when the `bevy_reflect` feature is enabled. This required converting `#[derive(Reflect)]` and `#[reflect(...)]` attributes to use Rust's `cfg_attr` conditional compilation.

2. **Compile-Time Error Improvement**: For `bevy_reflect`, we added a compile-time error that explicitly informs users they must select a backend when using `auto_register`. This replaces the obscure missing-function error with clear guidance.

#### The Implementation
In `bevy_window`, we refactored the cursor-related structs to use conditional compilation for reflection features. For example, in `custom_cursor.rs`, we transformed:

```rust
#[derive(Debug, Clone, Default, Reflect, PartialEq, Eq, Hash)]
#[reflect(Debug, Default, Hash, PartialEq, Clone)]
pub struct CustomCursorImage { ... }
```
into:
```rust
#[derive(Debug, Clone, Default, PartialEq, Eq, Hash)]
#[cfg_attr(
    feature = "bevy_reflect",
    derive(Reflect),
    reflect(Debug, Default, Hash, PartialEq, Clone)
)]
pub struct CustomCursorImage { ... }
```
This pattern ensures the `Reflect` derive and attributes only appear when the `bevy_reflect` feature is active.

For the `bevy_reflect` issue, we added explicit error handling in `lib.rs`:
```rust
#[cfg(all(
    not(feature = "auto_register_inventory"),
    not(feature = "auto_register_static")
))]
compile_error!(
    "Choosing a backend is required for automatic reflect registration. Please enable either the \"auto_register_inventory\" or the \"auto_register_static\" feature."
);
```
This proactively checks feature configuration during compilation and provides actionable guidance if backend features are missing.

#### Technical Insights
The key technical elements here are:
1. **Conditional Compilation**: Using `cfg_attr` allows clean feature gating without duplicating struct definitions or complicating module structures. This pattern is preferable to `#[cfg]` on separate implementations when maintaining a single struct definition.

2. **Compile-Time Validation**: The `compile_error!` macro is an underutilized but powerful tool for validating feature configurations at compile time rather than through documentation or runtime checks.

3. **Reflection System Design**: This change reinforces that Bevy's reflection system requires explicit backend selection when using automatic registration, preventing "magic" behavior that fails silently.

#### The Impact
These changes:
1. Fix compilation errors when `bevy_reflect` is disabled in `bevy_window`
2. Replace an obscure error with clear guidance when reflection backends are misconfigured
3. Maintain feature parity while improving configuration resilience
4. Reduce support burden by preventing common configuration mistakes

The changes are localized and don't affect runtime behavior, making them low-risk quality-of-life improvements.

### Key Files Changed

#### 1. `crates/bevy_window/src/cursor/custom_cursor.rs` (+20/-6)
Fixed reflection feature gating for cursor types.

**Before:**
```rust
#[derive(Debug, Clone, Default, Reflect, PartialEq, Eq, Hash)]
#[reflect(Debug, Default, Hash, PartialEq, Clone)]
pub struct CustomCursorImage { ... }

#[derive(Debug, Clone, Default, Reflect, PartialEq, Eq, Hash)]
#[reflect(Debug, Default, Hash, PartialEq, Clone)]
pub struct CustomCursorUrl { ... }

#[derive(Debug, Clone, Reflect, PartialEq, Eq, Hash)]
#[reflect(Clone, PartialEq, Hash)]
pub enum CustomCursor { ... }
```

**After:**
```rust
#[derive(Debug, Clone, Default, PartialEq, Eq, Hash)]
#[cfg_attr(
    feature = "bevy_reflect",
    derive(Reflect),
    reflect(Debug, Default, Hash, PartialEq, Clone)
)]
pub struct CustomCursorImage { ... }

#[derive(Debug, Clone, Default, PartialEq, Eq, Hash)]
#[cfg_attr(
    feature = "bevy_reflect",
    derive(Reflect),
    reflect(Debug, Default, Hash, PartialEq, Clone)
)]
pub struct CustomCursorUrl { ... }

#[derive(Debug, Clone, PartialEq, Eq, Hash)]
#[cfg_attr(
    feature = "bevy_reflect",
    derive(Reflect),
    reflect(Clone, PartialEq, Hash)
)]
pub enum CustomCursor { ... }
```

#### 2. `crates/bevy_window/src/cursor/mod.rs` (+8/-2)
Fixed reflection feature gating for `CursorIcon`.

**Before:**
```rust
#[derive(Component, Debug, Clone, Reflect, PartialEq, Eq)]
#[reflect(Component, Debug, Default, PartialEq, Clone)]
pub enum CursorIcon { ... }
```

**After:**
```rust
#[derive(Component, Debug, Clone, PartialEq, Eq)]
#[cfg_attr(
    feature = "bevy_reflect",
    derive(Reflect),
    reflect(Component, Debug, Default, PartialEq, Clone)
)]
pub enum CursorIcon { ... }
```

#### 3. `crates/bevy_reflect/src/lib.rs` (+8/-0)
Added compile-time error for missing backend.

**Added:**
```rust
#[cfg(all(
    not(feature = "auto_register_inventory"),
    not(feature = "auto_register_static")
))]
compile_error!(
    "Choosing a backend is required for automatic reflect registration. Please enable either the \"auto_register_inventory\" or the \"auto_register_static\" feature."
);
```

### Further Reading
1. [Rust Conditional Compilation](https://doc.rust-lang.org/reference/conditional-compilation.html)
2. [Bevy Reflection System](https://github.com/bevyengine/bevy/tree/main/crates/bevy_reflect)
3. [Rust compile_error! Macro](https://doc.rust-lang.org/std/macro.compile_error.html)
4. [Feature Gating Best Practices](https://doc.rust-lang.org/cargo/reference/features.html)