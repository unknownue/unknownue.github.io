+++
title = "#20574 remove panic in TextureFormatPixelInfo::pixel_info"
date = "2025-08-24T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = false

[extra]
current_language = "zh-cn"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-08/pr-20574-en-20250824" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-08/pr-20574-zh-cn-20250824" }}
labels = ["C-Bug", "A-Rendering", "D-Straightforward", "A-Picking"]
+++

# Title
remove panic in TextureFormatPixelInfo::pixel_info

## Basic Information
- **Title**: remove panic in TextureFormatPixelInfo::pixel_info
- **PR Link**: https://github.com/bevyengine/bevy/pull/20574
- **Author**: mirsella
- **Status**: MERGED
- **Labels**: C-Bug, A-Rendering, S-Ready-For-Final-Review, M-Needs-Migration-Guide, D-Straightforward, A-Picking
- **Created**: 2025-08-14T15:49:30Z
- **Merged**: 2025-08-24T21:11:18Z
- **Merged By**: alice-i-cecile

## Description Translation
# Objective

修复 #20365

## Solution

TextureFormatPixelInfo::pixel_info 现在返回 Result 而不是 panic

可能需要一个特定于此情况的自定义错误，而不是使用 `TextureAccessError` 的其他变体

## Testing

在我的游戏上运行测试，使用 mesh、sprite、ui 等所有功能似乎都正常。

**但是**这是我第一次贡献此类代码，我对渲染及其在 bevy 中的集成了解不多。**请像我一无所知一样审查此代码**。特别是我不知道这些更改在其他地方是否会产生一些不必要的后果。

剩下的问题是，也许我们应该添加一些 `warn!`？至少在 picking 中。
目前在 sprite picking 后端，如果无法访问像素数据（以确定 alpha 是否大于阈值），则跳过该实体。也许至少在这里添加一个 `warn!`？

（我认为不应该跳过，而应该视为有效：我宁愿让一个 sprite 的整个大小都被拾取，而不是完全无法工作。也许每个实体需要一个 SpritePickingSettings？）

## The Story of This Pull Request

这个 PR 解决了一个关键问题：当尝试获取压缩纹理格式的像素大小时，代码会直接 panic。这是一个典型的错误处理改进案例，将运行时崩溃转换为可控的错误处理。

问题的核心在于 `TextureFormatPixelInfo::pixel_info` 方法。在之前的实现中，当遇到压缩纹理格式（如 BC 系列、ETC2 等）时，该方法会直接 panic，因为这些格式没有明确定义的像素大小概念。压缩纹理使用块(block)而不是像素(pixel)作为基本单位，这使得传统的像素大小计算不适用。

开发者采用的解决方案是将方法的返回类型从 `usize` 改为 `Result<usize, TextureAccessError>`。这样，当遇到不支持的纹理格式时，方法可以返回一个明确的错误而不是崩溃。这个改变影响了整个代码库中所有使用此方法的地方，需要进行系统性的更新。

实现过程中，开发者创建了一个新的错误变体 `TextureAccessError::UnsupportedTextureFormat` 来处理这种情况。这个错误包含了具体的纹理格式信息，便于调试和错误报告。

技术洞察方面，这个改变体现了 Rust 的错误处理哲学：使用类型系统来强制处理可能的错误情况，而不是依赖运行时检查或 panic。这种模式在系统编程中特别重要，因为纹理格式的支持情况可能在运行时变化，且不同的硬件平台可能支持不同的格式集。

这个改变的影响是显著的：它消除了一个潜在的崩溃点，使代码更加健壮。现在，当遇到不支持的纹理格式时，调用者可以选择适当的错误处理策略，如回退到默认值、记录警告或提供用户友好的错误消息。

## Visual Representation

```mermaid
graph TD
    A[TextureFormatPixelInfo trait] --> B[pixel_size method]
    B --> C{Format supported?}
    C -->|Yes| D[Return Ok(size)]
    C -->|No| E[Return Err(UnsupportedTextureFormat)]
    
    F[Image processing] --> B
    G[Rendering pipeline] --> B
    H[Sprite system] --> B
    I[Texture atlas] --> B
```

## Key Files Changed

### `crates/bevy_image/src/image.rs` (+83/-60)
这是最核心的修改文件，定义了 `TextureFormatPixelInfo` trait 和其实现。

**主要变更：**
- 修改了 `pixel_size` 方法的签名，从返回 `usize` 改为返回 `Result<usize, TextureAccessError>`
- 在所有调用此方法的地方添加了错误处理
- 更新了相关的调试断言和数据处理逻辑

```rust
// Before:
fn pixel_size(&self) -> usize {
    let info = self;
    match info.block_dimensions() {
        (1, 1) => info.block_copy_size(None).unwrap() as usize,
        _ => panic!("Using pixel_size for compressed textures is invalid"),
    }
}

// After:
fn pixel_size(&self) -> Result<usize, TextureAccessError> {
    let info = self;
    match info.block_dimensions() {
        (1, 1) => Ok(info.block_copy_size(None).unwrap() as usize),
        _ => Err(TextureAccessError::UnsupportedTextureFormat(*self)),
    }
}
```

### `crates/bevy_render/src/gpu_readback.rs` (+17/-14)
处理 GPU 数据回读的逻辑，需要适应新的错误处理模式。

```rust
// 修改后的代码片段：
if let Some(gpu_image) = gpu_images.get(image)
    && let Ok(pixel_size) = gpu_image.texture_format.pixel_size()
{
    // 使用 pixel_size 进行后续处理
}
```

### `crates/bevy_pbr/src/render/mesh.rs` (+12/-11)
PBR 渲染管道的网格处理部分，更新了纹理上传逻辑。

```rust
// 添加了错误检查：
if let Ok(format_size) = image.texture_descriptor.format.pixel_size() {
    render_queue.write_texture(
        // ... 参数使用 format_size
    );
}
```

### `crates/bevy_sprite_render/src/mesh2d/mesh.rs` (+12/-11) 和 `crates/bevy_sprite_render/src/render/mod.rs` (+12/-11)
2D 精灵渲染系统的相关修改，模式与其他渲染组件类似。

## Further Reading

- [Rust Result 类型文档](https://doc.rust-lang.org/std/result/)
- [Bevy 纹理格式文档](https://docs.rs/bevy_render/latest/bevy_render/texture/enum.TextureFormat.html)
- [错误处理最佳实践](https://doc.rust-lang.org/book/ch09-00-error-handling.html)
- [WGSL 纹理格式规范](https://www.w3.org/TR/WGSL/#texture-formats)

# Full Code Diff
[完整代码差异见原始 PR]