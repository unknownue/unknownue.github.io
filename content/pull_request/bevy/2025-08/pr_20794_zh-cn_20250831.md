+++
title = "#20794 Add `vulkan-portability` to fix compiling with `--all-features"
date = "2025-08-31T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = false

[extra]
current_language = "zh-cn"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-08/pr-20794-en-20250831" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-08/pr-20794-zh-cn-20250831" }}
+++

# Add `vulkan-portability` to fix compiling with `--all-features`

## 基本信息
- **标题**: Add `vulkan-portability` to fix compiling with `--all-features`
- **PR 链接**: https://github.com/bevyengine/bevy/pull/20794
- **作者**: tychedelia
- **状态**: 已合并
- **标签**: D-Trivial, A-Rendering, S-Needs-Review
- **创建时间**: 2025-08-30T04:17:00Z
- **合并时间**: 2025-08-31T16:26:59Z
- **合并者**: mockersf

## 描述翻译
#20565 在 macOS 上破坏了使用 `--all-features` 的编译。添加 `vulkan-portability` 特性到 `bevy_render`，这是在 macOS 上使用 wgpu 编译 Vulkan 所必需的。

## 本次 Pull Request 的故事

这个 PR 解决了一个直接的构建问题：在 macOS 平台上使用 `--all-features` 标志编译 Bevy 时出现的编译失败。问题源于 PR #20565 引入的更改，该更改可能添加了对 Vulkan 功能的依赖，但没有包含必要的特性标志来确保在 macOS 上的兼容性。

macOS 系统本身不支持 Vulkan，但可以通过 MoltenVK 等兼容层实现 Vulkan 功能。wgpu 库通过 `vulkan-portability` 特性来启用这种支持。当开发者使用 `--all-features` 标志时，Cargo 会尝试启用所有定义的特性，包括 Vulkan 相关的特性，但由于缺少 `vulkan-portability` 特性，导致编译失败。

解决方案很简单：在 `bevy_render` 的 Cargo.toml 中添加 `vulkan-portability` 特性，该特性映射到 wgpu 的相应特性。这样，当启用所有特性时，macOS 上的 Vulkan 支持所需的依赖项会被正确包含。

这个更改体现了 Cargo 特性传播的重要模式。Bevy 作为上层框架，需要正确传递底层依赖（如 wgpu）的特性标志，确保构建系统的完整性。这种模式在大型 Rust 项目中很常见，其中特性需要从根 crate 通过中间层传递到底层依赖。

从技术角度看，这个修复展示了特性映射的标准做法：
```toml
vulkan-portability = ["wgpu/vulkan-portability"]
```

这行配置表示当 Bevy 的 `vulkan-portability` 特性被启用时，它会启用 wgpu 依赖的 `vulkan-portability` 特性。这种间接性允许 Bevy 控制底层依赖的特性暴露，同时保持清晰的抽象边界。

这个更改虽然很小，但对构建系统的稳定性很重要。它确保了跨平台的一致性，使开发者能够在所有支持的平台上使用 `--all-features` 标志而不遇到编译错误。

## 可视化表示

```mermaid
graph LR
    A[bevy_render] --> B[wgpu]
    B --> C[MoltenVK]
    A -- vulkan-portability feature --> B -- vulkan-portability feature --> C
```

## 关键文件更改

**文件**: `crates/bevy_render/Cargo.toml`

**更改描述**: 添加了 `vulkan-portability` 特性，该特性启用 wgpu 的相应特性，以支持在 macOS 上通过 MoltenVK 使用 Vulkan。

**代码变更**:
```toml
# 在 [features] 部分添加了以下行：
vulkan-portability = ["wgpu/vulkan-portability"]
```

这个更改确保了当使用 `--all-features` 标志时，在 macOS 上编译 Vulkan 相关代码所需的依赖项会被正确包含。

## 扩展阅读

- [Cargo 特性文档](https://doc.rust-lang.org/cargo/reference/features.html)
- [wgpu 的 Vulkan 可移植性支持](https://wgpu.rs/#vulkan-portability)
- [MoltenVK 项目](https://moltengl.com/moltenvk/)
- [Bevy 图形后端指南](https://bevyengine.org/learn/books/bevy-graphics-backends/)