+++
title = "#20426 Trim dependencies."
date = "2025-08-06T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = false

[extra]
current_language = "zh-cn"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-08/pr-20426-en-20250806" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-08/pr-20426-zh-cn-20250806" }}
labels = ["C-Dependencies", "C-Code-Quality", "D-Straightforward"]
+++

# Trim dependencies

## Basic Information
- **Title**: Trim dependencies.
- **PR Link**: https://github.com/bevyengine/bevy/pull/20426
- **Author**: nnethercote
- **Status**: MERGED
- **Labels**: C-Dependencies, C-Code-Quality, S-Ready-For-Final-Review, X-Uncontroversial, D-Straightforward
- **Created**: 2025-08-05T06:06:38Z
- **Merged**: 2025-08-06T09:04:39Z
- **Merged By**: alice-i-cecile

## Description Translation
# 目标

移除不需要的依赖项。

## 解决方案

使用 `cargo-shear`、`cargo-machete` 和 `cargo-udeps` 进行识别。它们都执行相同的任务（识别未使用的依赖项），效果都一般（存在大量假阴性和假阳性），但三者结合使用可以获得有用的结果。

## 测试

- 我通过在每个受影响的 crate 中 grep 已移除依赖项的名称来双重检查所有移除项，确保没有剩余的使用。我认为它们都是安全的。
- 运行 `cargo run -p ci`

## The Story of This Pull Request

### 问题识别
在大型 Rust 项目如 Bevy 中，随着时间推移，依赖项会累积不必要的包。这些未使用的依赖会增加编译时间、二进制大小和潜在的安全风险。PR #20426 的目标是系统性地识别并移除这些冗余依赖，保持项目的轻量和高效。

### 工具选择与方法
作者采用三重工具策略：
1. `cargo-shear`：检测未使用的依赖
2. `cargo-machete`：扫描未使用的依赖声明
3. `cargo-udeps`：查找未使用的开发依赖

由于每个工具都有局限性（假阳性和假阴性），作者组合使用它们相互验证。这种方法提高了结果的可靠性，但最终仍需手动验证每个移除项。

### 手动验证过程
为确保安全性，作者对每个被移除的依赖执行了以下操作：
1. 在整个 crate 中搜索依赖名称
2. 检查所有导入、宏和特性标志
3. 确认没有残留引用
4. 运行 CI 测试 (`cargo run -p ci`) 验证构建完整性

### 具体依赖移除分析
移除操作集中在六个 Cargo.toml 文件中，影响多种类型的依赖：

**根目录依赖清理**:
```diff
- hyper = { version = "1", features = ["server", "http1"] }
- http-body-util = "0.1"
- macro_rules_attribute = "0.2"
```
这些网络相关的依赖可能来自旧功能或原型代码，当前代码库已不再需要。

**基准测试优化**:
```diff
- bevy_utils = { path = "../crates/bevy_utils" }
```
基准测试不再需要 utils 模块提供的辅助功能，简化了测试环境。

**平台特定调整**:
```diff
-[target.'cfg(target_os = "linux")'.dev-dependencies]
-bevy_winit = { path = "../crates/bevy_winit", features = ["x11"] }
```
由于基准测试不实际创建窗口，Linux 专用的 winit 依赖被移除。

**渲染模块精简**:
```diff
- codespan-reporting = "0.12.0"
```
该错误报告库在渲染流程中已不再使用。

**文本模块调整**:
```diff
- unicode-bidi = "0.3.13"
```
双向文本支持库被移除，表明当前文本处理流程已简化或改用其他方案。

**WASM 目标优化**:
```diff
- crossbeam-channel = "0.5"
```
WebAssembly 环境移除了不必要的线程通道库，适应 wasm 的单线程模型。

### 技术决策与考量
1. **安全第一**：每个移除项都经过 grep 验证，避免破坏性更改
2. **工具互补**：结合多个检测工具弥补各自缺陷
3. **范围控制**：仅移除明确未使用的依赖，保守处理边界情况
4. **CI 验证**：通过标准测试管道确认无回归问题

### 影响与收益
1. **构建性能**：减少不必要的依赖缩短了干净构建时间
2. **二进制大小**：减小最终二进制文件的体积
3. **安全面**：减少潜在漏洞的攻击面
4. **维护性**：简化依赖树使未来升级更易管理
5. **编译检查**：消除未使用依赖的编译警告

## Key Files Changed

### Cargo.toml
移除三个主依赖和三个开发依赖：
```diff
- hyper = { version = "1", features = ["server", "http1"] }
- http-body-util = "0.1"
- macro_rules_attribute = "0.2"
[target.'cfg(not(target_family = "wasm"))'.dev-dependencies]
- smol = "2"
- smol-macros = "0.1"
- smol-hyper = "0.1"
```

### benches/Cargo.toml
简化基准测试依赖：
```diff
- bevy_utils = { path = "../crates/bevy_utils" }
-[target.'cfg(target_os = "linux")'.dev-dependencies]
- bevy_winit = { path = "../crates/bevy_winit", features = ["x11"] }
```

### crates/bevy_render/Cargo.toml
移除渲染专用依赖：
```diff
- codespan-reporting = "0.12.0"
```

### crates/bevy_text/Cargo.toml
精简文本处理依赖：
```diff
- unicode-bidi = "0.3.13"
```

### crates/bevy_winit/Cargo.toml
优化 WASM 依赖：
```diff
- crossbeam-channel = "0.5"
```

### tools/example-showcase/Cargo.toml
清理工具依赖：
```diff
- ron = "0.10"
```

## Further Reading
1. `cargo-udeps` 官方文档: https://github.com/est31/cargo-udeps
2. Rust 依赖管理最佳实践: https://doc.rust-lang.org/cargo/guide/dependencies.html
3. 使用 `cargo tree` 分析依赖: https://doc.rust-lang.org/cargo/commands/cargo-tree.html
4. 依赖安全检查工具 `cargo-audit`: https://github.com/RustSec/cargo-audit