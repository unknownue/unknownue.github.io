+++
title = "#20710 use affine inverse in prepass"
date = "2025-08-23T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = true

[taxonomies]
list_display = ["show"]

[extra]
current_language = "en"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-08/pr-20710-en-20250823" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-08/pr-20710-zh-cn-20250823" }}
labels = ["A-Rendering"]
+++

# Title
use affine inverse in prepass

## Basic Information
- **Title**: use affine inverse in prepass
- **PR Link**: https://github.com/bevyengine/bevy/pull/20710
- **Author**: atlv24
- **Status**: MERGED
- **Labels**: A-Rendering, S-Needs-Review
- **Created**: 2025-08-22T08:33:42Z
- **Merged**: 2025-08-23T21:29:10Z
- **Merged By**: james7132

## Description Translation
# Objective

- yet again, use affine inverse where possible

## Solution

- yours truly

## Testing

- deferred rendering example

## The Story of This Pull Request

This PR addresses a performance optimization opportunity in Bevy's prepass rendering system. The core issue was that camera transformation matrices were being computed using less efficient mathematical operations than necessary.

In computer graphics, camera transformations are typically represented as affine transformations - these preserve parallel lines and include operations like translation, rotation, scaling, and shearing. Bevy's `Affine3A` type is specifically designed to handle these transformations more efficiently than general 4x4 matrices (`Mat4`).

The problem was in two functions in the prepass module: `update_previous_view_data` and `prepare_previous_view_uniforms`. Both were using `to_matrix()` to convert `Affine3A` transformations to `Mat4` before computing inverses, which is computationally expensive. Matrix inversion for 4x4 matrices has higher computational complexity than for affine transformations.

The solution replaces this pattern with more efficient operations:
1. Use `affine()` instead of `to_matrix()` to preserve the affine representation
2. Compute inverses using `Affine3A::inverse()` which is optimized for affine transformations
3. Convert to `Mat4` only when necessary for subsequent matrix operations

This change follows established patterns in the Bevy codebase for optimizing transformation calculations. The author recognized that this same optimization had been applied elsewhere and consistently applied it to the prepass system as well.

The implementation maintains mathematical correctness while improving performance. All transformation calculations produce identical results, but with better computational efficiency. This is particularly important for the prepass system which runs every frame and needs to handle camera transformations efficiently.

## Visual Representation

```mermaid
graph TD
    A[GlobalTransform] --> B[affine()]
    B --> C[Affine3A]
    C --> D[inverse()]
    D --> E[Affine3A]
    E --> F[Mat4::from()]
    F --> G[Mat4 for rendering]
```

## Key Files Changed

### `crates/bevy_pbr/src/prepass/mod.rs` (+7/-7)

This file contains the prepass rendering logic. The changes optimize camera transformation calculations by using affine inverses instead of matrix inverses.

**Key changes in `update_previous_view_data`:**
```rust
// Before:
let world_from_view = camera_transform.to_matrix();
let view_from_world = world_from_view.inverse();

// After:
let world_from_view = camera_transform.affine();
let view_from_world = Mat4::from(world_from_view.inverse());
```

**Key changes in `prepare_previous_view_uniforms`:**
```rust
// Before:
let world_from_view = camera.world_from_view.to_matrix();
let view_from_world = world_from_view.inverse();

// After:
let world_from_view = camera.world_from_view.affine();
let view_from_world = Mat4::from(world_from_view.inverse());
```

These changes replace expensive 4x4 matrix inversions with more efficient affine inversions, converting to Mat4 only when necessary for compatibility with other rendering components.

## Further Reading

- [Affine transformations in computer graphics](https://en.wikipedia.org/wiki/Affine_transformation)
- [Bevy's Affine3A documentation](https://docs.rs/bevy/latest/bevy/math/struct.Affine3A.html)
- [Matrix inversion computational complexity](https://en.wikipedia.org/wiki/Invertible_matrix#Methods_of_matrix_inversion)