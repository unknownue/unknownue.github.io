+++
title = "#20707 use affine not inverse in rangefinder"
date = "2025-08-22T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = false

[extra]
current_language = "zh-cn"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-08/pr-20707-en-20250822" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-08/pr-20707-zh-cn-20250822" }}
labels = ["A-Rendering"]
+++

# Title

## Basic Information
- **Title**: use affine not inverse in rangefinder
- **PR Link**: https://github.com/bevyengine/bevy/pull/20707
- **Author**: atlv24
- **Status**: MERGED
- **Labels**: A-Rendering, M-Needs-Migration-Guide
- **Created**: 2025-08-22T08:00:20Z
- **Merged**: 2025-08-22T21:33:11Z
- **Merged By**: james7132

## Description Translation
**目标 (Objective)**
- 在 rangefinder 中使用仿射变换 (affine) 而不是逆矩阵 (inverse)

**解决方案 (Solution)**
- 更改参数类型，在转换前提供仿射变换
- 添加迁移指南，以防有人正在使用该功能

**测试 (Testing)**
- 无

## The Story of This Pull Request

这个PR的核心问题是关于3D渲染中距离计算的性能优化。在Bevy的渲染系统中，`ViewRangefinder3d` 负责计算相机视图中物体的深度距离，用于确定绘制顺序。

**问题根源在于矩阵运算的效率**。原来的实现接受一个完整的4x4矩阵 (`Mat4`)，但实际只需要其中的仿射变换部分（旋转、缩放、平移）。完整的矩阵包含投影变换信息，而深度计算只需要仿射部分，这造成了不必要的计算开销。

开发者发现 `ViewRangefinder3d::from_world_from_view` 方法接收 `Mat4` 参数，但在内部立即调用 `inverse()` 方法进行求逆运算。对于完整的投影矩阵，求逆操作计算量较大，但实际上深度计算只需要仿射变换的逆。

**解决方案很直接**：将参数类型从 `Mat4` 改为 `Affine3A`。`Affine3A` 是Bevy数学库中专门表示仿射变换的结构，只包含旋转、缩放和平移信息，去掉了不必要的投影成分。

关键的技术洞察是：在3D渲染的深度排序中，我们只需要考虑物体的相对位置关系，而不需要完整的投影变换。仿射变换已经包含了所有必要的位置和方向信息。

**实现细节**：
1. 修改方法签名，接受 `Affine3A` 而不是 `Mat4`
2. 在内部将 `Affine3A` 转换为 `Mat4` 来提取特定的行数据
3. 更新调用处以提供仿射变换而不是完整矩阵

这个改变带来了明显的性能提升，因为：
- `Affine3A` 的逆运算比 `Mat4` 的逆运算更快
- 避免了不必要的投影变换计算
- 内存使用更高效（仿射变换数据量更小）

**迁移考虑**：由于这是一个公共API的破坏性变更，开发者添加了迁移指南，指导用户从使用 `GlobalTransform::to_matrix()` 改为使用 `GlobalTransform::affine()`。

这个优化体现了良好的API设计原则：提供最精确的数据类型来满足需求，避免不必要的通用性带来的性能开销。

## Visual Representation

```mermaid
graph TD
    A[ExtractedView.world_from_view] --> B[Affine3A.affine()]
    B --> C[ViewRangefinder3d.from_world_from_view]
    C --> D[Affine3A.inverse()]
    D --> E[Mat4.from() conversion]
    E --> F[Extract row data for depth calculation]
```

## Key Files Changed

### 1. `crates/bevy_render/src/render_phase/rangefinder.rs` (+5/-5)

**变更描述**：修改了ViewRangefinder3d的核心实现，将参数类型从Mat4改为Affine3A

```rust
// Before:
use bevy_math::{Mat4, Vec3, Vec4};

pub fn from_world_from_view(world_from_view: &Mat4) -> ViewRangefinder3d {
    let view_from_world = world_from_view.inverse();
    ViewRangefinder3d {
        view_from_world_row_2: view_from_world.row(2),
    }
}

// After:
use bevy_math::{Affine3A, Mat4, Vec3, Vec4};

pub fn from_world_from_view(world_from_view: &Affine3A) -> ViewRangefinder3d {
    let view_from_world = world_from_view.inverse();
    ViewRangefinder3d {
        view_from_world_row_2: Mat4::from(view_from_world).row(2),
    }
}
```

### 2. `crates/bevy_render/src/view/mod.rs` (+1/-1)

**变更描述**：更新调用处以提供仿射变换而不是完整矩阵

```rust
// Before:
pub fn rangefinder3d(&self) -> ViewRangefinder3d {
    ViewRangefinder3d::from_world_from_view(&self.world_from_view.to_matrix())
}

// After:
pub fn rangefinder3d(&self) -> ViewRangefinder3d {
    ViewRangefinder3d::from_world_from_view(&self.world_from_view.affine())
}
```

### 3. `release-content/migration-guides/rangefinder.md` (+6/-0)

**变更描述**：新增迁移指南文档

```markdown
---
title: "`ViewRangefinder3d::from_world_from_view` now takes `Affine3A` instead of `Mat4`"
pull_requests: [20707]
---

`ViewRangefinder3d::from_world_from_view` now takes `Affine3A` instead of `Mat4`. If you were supplying a `GlobalTransform::to_matrix()`, simply use `GlobalTransform::affine()` now. Performance will be better.
```

## Further Reading

1. **Bevy数学库文档**：了解Affine3A和Mat4的区别和使用场景
2. **计算机图形学中的仿射变换**：理解为什么在3D渲染中仿射变换足够用于深度计算
3. **性能优化模式**：学习如何通过选择合适的数据结构来优化性能
4. **API设计原则**：研究如何设计既高效又易用的公共接口