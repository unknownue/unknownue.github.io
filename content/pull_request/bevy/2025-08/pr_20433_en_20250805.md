+++
title = "#20433"
date = "2025-08-05T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = true

[taxonomies]
list_display = ["show"]

[extra]
current_language = "en"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-08/pr-20433-en-20250805" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-08/pr-20433-zh-cn-20250805" }}
+++

## Technical Analysis of PR #20433: Make `HierarchyPropagatePlugin` scheduling configurable

### The Story of This Pull Request

#### The Problem and Context
The `HierarchyPropagatePlugin` system in Bevy was hardcoded to run exclusively during the `Update` schedule. This created a significant limitation for users who needed to customize when propagation logic executes relative to other systems. The rigid scheduling constraint prevented users from:
1. Running propagation in alternative schedules like `PostUpdate`
2. Integrating propagation with custom schedules
3. Controlling execution order relative to other systems beyond what `Update` allowed

This became particularly problematic for users extending Bevy's UI system (like the `bevy_feathers` crate) who needed more control over when text color and font propagation occurred.

#### The Solution Approach
The solution modifies `HierarchyPropagatePlugin` to accept a configurable schedule during initialization. Key engineering decisions:
1. **Constructor pattern**: Replaced `Default` implementation with explicit `new()` constructor requiring schedule specification
2. **Type safety**: Used `Interned<dyn ScheduleLabel>` to safely handle schedule identifiers
3. **Backward compatibility**: Maintained existing behavior by requiring `Update` in existing usage sites
4. **Minimal API change**: Preserved all existing component interfaces (`Propagate`, `Inherited`, etc.)

The implementation avoids breaking changes by modifying initialization patterns rather than component APIs.

#### The Implementation
The core change transforms `HierarchyPropagatePlugin` from a zero-sized type to a struct storing schedule configuration:

```rust
// Before:
pub struct HierarchyPropagatePlugin<...>(PhantomData<...>);

// After:
pub struct HierarchyPropagatePlugin<...> {
    schedule: Interned<dyn ScheduleLabel>,
    _marker: PhantomData<...>,
}
```

The new constructor provides schedule configuration:
```rust
pub fn new(schedule: impl ScheduleLabel) -> Self {
    Self {
        schedule: schedule.intern(),
        _marker: PhantomData,
    }
}
```

In the plugin's `build` method, the hardcoded `Update` reference is replaced with the stored schedule:
```rust
// Before:
app.add_systems(Update, ...)

// After:
app.add_systems(self.schedule, ...)
```

#### Technical Insights
1. **ScheduleLabel Internment**: Using `schedule.intern()` converts the schedule into an efficiently comparable interned identifier
2. **PhantomData Preservation**: Maintains type parameter constraints without runtime overhead
3. **Relationship Preservation**: All propagation logic (child/parent relationships) remains unchanged
4. **Test Coverage**: All existing tests were updated to use the new constructor, verifying backward compatibility

#### The Impact
This change provides significant flexibility while maintaining existing behavior:
1. Users can now run propagation in any schedule
2. Enables better integration with custom engine architectures
3. Unlocks new use cases like deferred propagation
4. Maintains 100% backward compatibility via simple migration path (replace `default()` with `new(Update)`)

The change affected only initialization patterns - no modifications were required for systems using propagation components.

### Visual Representation

```mermaid
graph LR
    A[User Code] --> B[HierarchyPropagatePlugin::new()]
    B --> C[Custom Schedule]
    C --> D[Propagation Systems]
    D --> E[Component Propagation]
```

### Key Files Changed

1. **crates/bevy_app/src/propagate.rs**
   - Made scheduling configurable and removed hardcoded `Update` references
   
```rust
// Before:
app.add_systems(
    Update,
    ( ... )
);

// After:
app.add_systems(
    self.schedule,
    ( ... )
);
```

```rust
// Before:
pub struct HierarchyPropagatePlugin<...>(PhantomData<...>);

// After:
pub struct HierarchyPropagatePlugin<...> {
    schedule: Interned<dyn ScheduleLabel>,
    _marker: PhantomData<...>,
}
```

2. **crates/bevy_feathers/src/lib.rs**
   - Updated plugin initialization to use new constructor

```rust
// Before:
HierarchyPropagatePlugin::<TextColor, With<ThemedText>>::default()

// After:
HierarchyPropagatePlugin::<TextColor, With<ThemedText>>::new(Update)
```

### Further Reading
1. [Bevy Schedules Documentation](https://docs.rs/bevy_ecs/latest/bevy_ecs/schedule/index.html)
2. [Component Propagation Patterns](https://github.com/bevyengine/bevy/blob/main/docs/plugins.md)
3. [Interned Type Explanation](https://docs.rs/bevy_ecs/latest/bevy_ecs/intern/struct.Interned.html)