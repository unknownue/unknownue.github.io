+++
title = "#19798 Move bevy_mikktspace out of tree"
date = "2025-08-04T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = false

[extra]
current_language = "zh-cn"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-08/pr-19798-en-20250804" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-08/pr-19798-zh-cn-20250804" }}
+++

# PR 分析报告: Move bevy_mikktspace out of tree

## 基本信息
- **标题**: Move bevy_mikktspace out of tree
- **PR 链接**: https://github.com/bevyengine/bevy/pull/19798
- **作者**: atlv24
- **状态**: MERGED
- **标签**: A-Rendering, C-Dependencies, C-Code-Quality, S-Ready-For-Final-Review, A-Math, P-Unsound, X-Blessed, D-Unsafe
- **创建时间**: 2025-06-24T08:01:41Z
- **合并时间**: 2025-08-04T17:35:58Z
- **合并者**: alice-i-cecile

## 描述翻译
### Objective
- 通过合并 #9050 使 bevy_mikktspace 安全
- 不在主仓库中保留 C 代码

相关 issues 和 PRs:
- 关闭 #9050
- 关闭 #8429 
- 修复 #7372

### Solution
- 重新基于 main 分支变基
- 移除 glam 依赖，不再需要同步更新
- 使其独立: https://github.com/atlv24/bevy_mikktspace
- 转移到 bevy 组织

### Testing
- 由 Layl 创建的测试套件

## 这个 PR 的故事

### 问题和背景
`bevy_mikktspace` 是 Bevy 引擎中用于生成切线空间（tangent space）的库，实现 Mikkelsen 的切线空间算法。这个库有两个主要问题：
1. 安全性问题：原始实现包含不安全代码（unsafe code），可能引发未定义行为
2. 依赖管理问题：作为内联（in-tree）C 代码，增加了主仓库的维护负担

具体来说：
- 原始实现包含大量不安全代码（D-Unsafe 标签）
- 与主仓库绑定导致依赖冲突（特别是与 glam 数学库）
- 代码质量问题（C-Code-Quality 标签）

这些问题通过 #9050 和 #7372 等 issue 被追踪，影响了渲染管线的稳定性（A-Rendering 标签）。

### 解决方案
作者采取了以下方法：
1. **移除内联实现**：将 `bevy_mikktspace` 完全从主仓库移除
2. **创建独立库**：迁移到新仓库 [bevy_mikktspace](https://github.com/atlv24/bevy_mikktspace)
3. **解除依赖**：移除对 glam 的依赖，避免版本锁定问题
4. **API 改进**：重构接口提高安全性和可用性

关键决策点：
- 选择完全移除而非修补，简化维护
- 独立仓库允许独立版本管理和优化
- 移除 glam 依赖避免同步更新问题

### 实现细节
核心改动分为三部分：

**1. 依赖更新 (`crates/bevy_mesh/Cargo.toml`)**
```diff
- bevy_mikktspace = { path = "../bevy_mikktspace", version = "0.17.0-dev" }
+ bevy_mikktspace = { version = "0.17.0-dev" }
```
从路径依赖改为 crate 依赖，使用独立发布的版本。

**2. 接口适配 (`crates/bevy_mesh/src/mikktspace.rs`)**
```rust
// 修改前
fn set_tangent_encoded(&mut self, tangent: [f32; 4], face: usize, vert: usize) {
    self.tangents[idx] = tangent;
}

// 修改后
fn set_tangent(
    &mut self,
    tangent_space: Option<bevy_mikktspace::TangentSpace>,
    face: usize,
    vert: usize,
) {
    self.tangents[idx] = tangent_space.unwrap_or_default().tangent_encoded();
}
```
```rust
// 错误处理改进
- GenerateTangentsError::MikktspaceError,
+ GenerateTangentsError::MikktspaceError(#[from] bevy_mikktspace::GenerateTangentSpaceError),
```
接口变化反映独立库的 API 改进，错误处理更符合 Rust 习惯。

**3. 移除旧代码**
删除整个 `crates/bevy_mikktspace` 目录，包括：
- 1871 行生成的代码 (`src/generated.rs`)
- 测试和示例 (`tests/`, `examples/`)
- 许可证文件
- 资源文件 (`cube.obj`)

### 技术洞察
1. **安全性改进**：
   - 移除不安全代码（D-Unsafe 标签）
   - 使用 Option 和 Result 改进错误处理
   ```rust
   // 旧代码返回 bool 表示成功/失败
   let success = bevy_mikktspace::generate_tangents(&mut mikktspace_mesh);
   
   // 新代码使用 Result 传播错误
   bevy_mikktspace::generate_tangents(&mut mikktspace_mesh)?;
   ```

2. **依赖解耦**：
   - 移除 glam 依赖解决版本冲突问题
   - 独立仓库允许独立发布和版本管理

3. **API 设计**：
   - 更符合人体工学的接口设计
   - 更好的类型安全（TangentSpace 类型）

### 影响
1. **代码质量提升**：
   - 减少主仓库代码量（删除 >3000 行）
   - 消除不安全代码（P-Unsound 标签）

2. **维护性改进**：
   - 解耦数学库依赖
   - 独立问题追踪和版本管理

3. **开发者体验**：
   - 更清晰的错误处理
   - 简化 bevy_mesh 模块的职责

## 关键文件变更

### `crates/bevy_mesh/Cargo.toml`
```diff
- bevy_mikktspace = { path = "../bevy_mikktspace", version = "0.17.0-dev" }
+ bevy_mikktspace = { version = "0.17.0-dev" }
```
**变更原因**：  
将 bevy_mikktspace 从本地路径依赖改为 crate 依赖，使用独立发布的版本。

### `crates/bevy_mesh/src/mikktspace.rs`
```diff
- fn set_tangent_encoded(&mut self, tangent: [f32; 4], face: usize, vert: usize) {
-     self.tangents[idx] = tangent;
- }
+ fn set_tangent(
+     &mut self,
+     tangent_space: Option<bevy_mikktspace::TangentSpace>,
+     face: usize,
+     vert: usize,
+ ) {
+     self.tangents[idx] = tangent_space.unwrap_or_default().tangent_encoded();
+ }
```
**变更原因**：  
适配独立库的新 API，提供更安全的接口。

```diff
- let success = bevy_mikktspace::generate_tangents(&mut mikktspace_mesh);
- if !success {
-     return Err(GenerateTangentsError::MikktspaceError);
- }
+ bevy_mikktspace::generate_tangents(&mut mikktspace_mesh)?;
```
**变更原因**：  
使用 Rust 的错误传播替代布尔检查，改进错误处理。

### 删除文件
1. `crates/bevy_mikktspace/src/generated.rs` (-1871 行)  
   **原因**：Mikktspace 算法的核心实现，移至独立仓库

2. `crates/bevy_mikktspace/tests/regression_test.rs` (-887 行)  
   **原因**：回归测试，移至独立仓库

3. `crates/bevy_mikktspace/examples/generate.rs` (-266 行)  
   **原因**：示例代码，移至独立仓库

4. `crates/bevy_mikktspace/LICENSE-APACHE` (-176 行)  
   **原因**：许可证文件，移至独立仓库

5. `crates/bevy_mikktspace/examples/cube.obj` (-114 行)  
   **原因**：示例资源文件，移至独立仓库

## 进一步阅读
1. [Mikkelsen 切线空间算法论文](http://www.mikktspace.com/)  
2. [独立 bevy_mikktspace 仓库](https://github.com/bevyengine/bevy_mikktspace)  
3. [Rust 安全代码指南](https://doc.rust-lang.org/nomicon/)  
4. [Cargo 依赖管理文档](https://doc.rust-lang.org/cargo/reference/specifying-dependencies.html)