+++
title = "#20487 Use bevy::light in examples instead of bevy::pbr::light re-export"
date = "2025-08-10T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = false

[extra]
current_language = "zh-cn"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-08/pr-20487-en-20250810" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-08/pr-20487-zh-cn-20250810" }}
+++

### PR 分析报告：Use bevy::light in examples instead of bevy::pbr::light re-export

---

#### 基本信息
- **标题**: Use bevy::light in examples instead of bevy::pbr::light re-export
- **PR 链接**: https://github.com/bevyengine/bevy/pull/20487
- **作者**: atlv24
- **状态**: MERGED
- **标签**: A-Rendering, C-Code-Quality, S-Ready-For-Final-Review
- **创建时间**: 2025-08-10T05:02:47Z
- **合并时间**: 2025-08-10T05:43:22Z
- **合并人**: alice-i-cecile

#### 描述翻译
**目标**  
- 为移除重新导出（re-exports）做准备  

**解决方案**  
- 标题  

**测试**  
- `cargo check --examples --all-features`

---

### PR 技术分析

#### 问题背景
Bevy 引擎的渲染模块存在代码组织结构问题：光照相关的类型（如 `CascadeShadowConfigBuilder`, `NotShadowCaster` 等）通过 `bevy::pbr` 模块重新导出（re-export）。这种设计导致：
1. **模块边界模糊**：PBR（Physically Based Rendering）模块不应包含基础光照类型
2. **维护成本**：未来移除重新导出时会破坏现有示例代码
3. **使用混淆**：开发者可能误认为这些类型属于 PBR 子系统

此 PR 是长期重构的第一步，目标是将光照类型迁移到专属模块 `bevy::light`，为后续彻底移除重新导出做准备。

#### 解决方案
采用机械性替换策略：
1. **统一替换导入路径**：将示例中所有 `bevy::pbr::{light_type}` 替换为 `bevy::light::{light_type}`
2. **保持功能不变**：零逻辑修改，仅调整导入语句
3. **全面覆盖**：修改 32 个示例文件确保一致性

关键决策点：
- **不修改非示例代码**：避免破坏用户项目
- **最小化变更范围**：仅修改 `examples/` 目录
- **兼容性保证**：确保所有示例通过 `cargo check --examples --all-features`

#### 实现细节
以典型文件修改为例：

**文件**: `examples/3d/deferred_rendering.rs`  
**修改前**:
```rust
use bevy::{
    pbr::{
        CascadeShadowConfigBuilder, 
        NotShadowCaster,
        NotShadowReceiver
    }
}
```
**修改后**:
```rust
use bevy::{
    light::{
        CascadeShadowConfigBuilder, 
        NotShadowCaster,
        NotShadowReceiver
    }
}
```

技术要点：
1. **精准路径替换**：仅修改光照类型导入路径
   ```diff
   - use bevy::pbr::{CascadeShadowConfigBuilder, NotShadowCaster}
   + use bevy::light::{CascadeShadowConfigBuilder, NotShadowCaster}
   ```
2. **复杂导入拆分**：当 PBR 和光照类型混合导入时进行解耦  
   **文件**: `examples/3d/irradiance_volumes.rs`  
   ```diff
   - use bevy::pbr::{IrradianceVolume, NotShadowCaster}
   + use bevy::light::{IrradianceVolume, NotShadowCaster}
   - use bevy::pbr::{ExtendedMaterial, MaterialExtension}
   + use bevy::pbr::{ExtendedMaterial, MaterialExtension} // 保持原路径
   ```
3. **类型范围覆盖**：处理 15+ 种光照相关类型，包括：
   - `CascadeShadowConfigBuilder`
   - `DirectionalLightShadowMap`
   - `NotShadowCaster`
   - `VolumetricLight`
   - `ShadowFilteringMethod`

#### 技术洞察
1. **模块化设计原则**：
   - 分离核心光照概念与 PBR 实现
   - 建立清晰层级：`light` → `pbr`（光照驱动渲染）
2. **未来兼容性**：
   ```mermaid
   graph LR
   A[bevy::pbr] -- re-export --> B[光照类型]
   C[bevy::light] -- 标准路径 --> B
   D[示例代码] --> C
   ```
   当前 PR 将示例指向 `C`，为移除 `A→B` 的重新导出铺路
3. **重构策略**：
   - 机械替换 → 无风险破坏现有行为
   - 示例优先 → 提供迁移样板供用户参考
   - 原子提交 → 不混合功能修改

#### 影响分析
1. **正向影响**：
   - 消除 32 处技术债务
   - 降低后续 `bevy::pbr` 重构复杂度
   - 明确模块职责：`light`=基础光照，`pbr`=渲染实现
2. **用户影响**：
   - 示例代码展示标准用法，引导用户使用正确路径
   - 为未来废弃 `pbr` 重新导出提供过渡期
3. **性能**：零运行时影响（纯编译时修改）

#### 关键文件变更
1. **`examples/3d/deferred_rendering.rs`**  
   - **修改内容**：解耦光照与 PBR 类型导入  
   - **代码差异**：
     ```diff
     - use bevy::pbr::{CascadeShadowConfigBuilder, NotShadowCaster}
     + use bevy::light::{CascadeShadowConfigBuilder, NotShadowCaster}
     ```

2. **`examples/3d/meshlet.rs`**  
   - **修改内容**：分离实验性 meshlet 与基础光照  
   - **代码差异**：
     ```diff
     use bevy::{
     -   pbr::{MeshletPlugin, CascadeShadowConfigBuilder}
     +   light::{CascadeShadowConfigBuilder},
     +   pbr::experimental::meshlet::{MeshletPlugin}
     }
     ```

3. **`examples/3d/split_screen.rs`**  
   - **修改内容**：简化单用途导入  
   - **代码差异**：
     ```diff
     - use bevy::pbr::CascadeShadowConfigBuilder
     + use bevy::light::CascadeShadowConfigBuilder
     ```

---

### 延伸阅读
1. [Rust 模块系统最佳实践](https://doc.rust-lang.org/book/ch07-04-bringing-paths-into-scope-with-the-use-keyword.html)
2. [Bevy 渲染架构概览](https://bevyengine.org/learn/book/getting-started/rendering/)
3. [物理渲染 (PBR) 理论基础](https://learnopengl.com/PBR/Theory)

---
### 完整代码差异
```diff
diff --git a/examples/3d/deferred_rendering.rs b/examples/3d/deferred_rendering.rs
index 6f51cff8c20ec..fcd2d3af5e6a1 100644
--- a/examples/3d/deferred_rendering.rs
+++ b/examples/3d/deferred_rendering.rs
@@ -6,11 +6,11 @@ use bevy::{
     anti_aliasing::fxaa::Fxaa,
     core_pipeline::prepass::{DeferredPrepass, DepthPrepass, MotionVectorPrepass, NormalPrepass},
     image::ImageLoaderSettings,
-    math::ops,
-    pbr::{
-        CascadeShadowConfigBuilder, DefaultOpaqueRendererMethod, DirectionalLightShadowMap,
-        NotShadowCaster, NotShadowReceiver, OpaqueRendererMethod,
+    light::{
+        CascadeShadowConfigBuilder, DirectionalLightShadowMap, NotShadowCaster, NotShadowReceiver,
     },
+    math::ops,
+    pbr::{DefaultOpaqueRendererMethod, OpaqueRendererMethod},
     prelude::*,
 };
 
# ...（其余 31 个文件类似修改）...
```