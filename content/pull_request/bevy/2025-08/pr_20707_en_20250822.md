+++
title = "#20707 use affine not inverse in rangefinder"
date = "2025-08-22T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = true

[taxonomies]
list_display = ["show"]

[extra]
current_language = "en"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-08/pr-20707-en-20250822" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-08/pr-20707-zh-cn-20250822" }}
labels = ["A-Rendering"]
+++

# Title
Use affine not inverse in rangefinder

## Basic Information
- **Title**: use affine not inverse in rangefinder
- **PR Link**: https://github.com/bevyengine/bevy/pull/20707
- **Author**: atlv24
- **Status**: MERGED
- **Labels**: A-Rendering, M-Needs-Migration-Guide
- **Created**: 2025-08-22T08:00:20Z
- **Merged**: 2025-08-22T21:33:11Z
- **Merged By**: james7132

## Description Translation
# Objective

- use affine not inverse in rangefinder

## Solution

- change param type, supply affine before converting
- add migration guide in case anyone was using that

## Testing

- none

## The Story of This Pull Request

This PR addresses a performance optimization in Bevy's 3D rendering system by changing how the ViewRangefinder3d calculates depth values. The core issue was that the rangefinder was accepting a full 4x4 transformation matrix (Mat4) when it only needed the affine components for depth calculation.

In 3D rendering, the rangefinder determines the draw order of objects by calculating their distance from the camera. The original implementation took a Mat4 parameter and immediately inverted it to get the view-from-world matrix:

```rust
pub fn from_world_from_view(world_from_view: &Mat4) -> ViewRangefinder3d {
    let view_from_world = world_from_view.inverse();
    // ...
}
```

The problem with this approach is that inverting a full 4x4 matrix is computationally expensive compared to inverting an affine transformation (Affine3A). Since the rangefinder only needs the third row of the inverted matrix for depth calculation, using a full matrix inversion was unnecessarily costly.

The solution changes the parameter type from Mat4 to Affine3A and modifies the conversion logic:

```rust
pub fn from_world_from_view(world_from_view: &Affine3A) -> ViewRangefinder3d {
    let view_from_world = world_from_view.inverse();
    ViewRangefinder3d {
        view_from_world_row_2: Mat4::from(view_from_world).row(2),
    }
}
```

This change is mathematically equivalent but more efficient because:
1. Affine3A inversion is cheaper than Mat4 inversion
2. The conversion to Mat4 happens after inversion, only when needed for extracting the specific row

The PR also includes a migration guide since this changes a public API. The guide explains that users should now supply `GlobalTransform::affine()` instead of `GlobalTransform::to_matrix()`.

The changes are minimal but impactful - they reduce computational overhead in the rendering pipeline without altering the functional behavior. The tests were updated to use Affine3A but maintain the same assertions, ensuring backward compatibility.

## Visual Representation

```mermaid
graph TD
    A[ExtractedView] --> B[world_from_view.affine()]
    B --> C[ViewRangefinder3d::from_world_from_view]
    C --> D[Affine3A parameter]
    D --> E[Cheaper inversion]
    E --> F[Convert to Mat4 for row extraction]
```

## Key Files Changed

**File: crates/bevy_render/src/render_phase/rangefinder.rs**

Changes: Updated the parameter type from Mat4 to Affine3A and modified the matrix conversion logic.

```rust
// Before:
use bevy_math::{Mat4, Vec3, Vec4};
pub fn from_world_from_view(world_from_view: &Mat4) -> ViewRangefinder3d {
    let view_from_world = world_from_view.inverse();
    ViewRangefinder3d {
        view_from_world_row_2: view_from_world.row(2),
    }
}

// After:
use bevy_math::{Affine3A, Mat4, Vec3, Vec4};
pub fn from_world_from_view(world_from_view: &Affine3A) -> ViewRangefinder3d {
    let view_from_world = world_from_view.inverse();
    ViewRangefinder3d {
        view_from_world_row_2: Mat4::from(view_from_world).row(2),
    }
}
```

**File: crates/bevy_render/src/view/mod.rs**

Changes: Updated the call site to use the affine component instead of the full matrix.

```rust
// Before:
ViewRangefinder3d::from_world_from_view(&self.world_from_view.to_matrix())

// After:
ViewRangefinder3d::from_world_from_view(&self.world_from_view.affine())
```

**File: release-content/migration-guides/rangefinder.md**

Changes: Added migration guide for the API change.

```markdown
---
title: "`ViewRangefinder3d::from_world_from_view` now takes `Affine3A` instead of `Mat4`"
pull_requests: [20707]
---

`ViewRangefinder3d::from_world_from_view` now takes `Affine3A` instead of `Mat4`. If you were supplying a `GlobalTransform::to_matrix()`, simply use `GlobalTransform::affine()` now. Performance will be better.
```

## Further Reading

- [Bevy Affine3A documentation](https://docs.rs/bevy/latest/bevy/math/struct.Affine3A.html)
- [Computer Graphics: Affine vs Projective Transformations](https://en.wikipedia.org/wiki/Affine_transformation)
- [Matrix Inversion Complexity](https://en.wikipedia.org/wiki/Invertible_matrix#Methods_of_matrix_inversion)
- [Bevy Migration Guides](https://bevyengine.org/learn/migration-guides/)