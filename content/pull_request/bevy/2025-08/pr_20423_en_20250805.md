+++
title = "#20423 Improve `WithRelated` ergonomics"
date = "2025-08-05T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = true

[taxonomies]
list_display = ["show"]

[extra]
current_language = "en"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-08/pr-20423-en-20250805" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-08/pr-20423-zh-cn-20250805" }}
labels = ["D-Trivial", "A-ECS", "C-Usability", "D-Domain-Agnostic"]
+++

## Improve `WithRelated` ergonomics

### Basic Information
- **Title**: Improve `WithRelated` ergonomics
- **PR Link**: https://github.com/bevyengine/bevy/pull/20423
- **Author**: ItsDoot
- **Status**: MERGED
- **Labels**: D-Trivial, A-ECS, C-Usability, S-Ready-For-Final-Review, D-Domain-Agnostic
- **Created**: 2025-08-05T03:07:34Z
- **Merged**: 2025-08-05T05:27:02Z
- **Merged By**: james7132

### Description Translation
The original description is in English, so it's preserved exactly as-is:

**Objective**

Recommending users to use `WithRelated([child2, child3].into_iter())` feels a bit weird.

**Solution**

Add `WithRelated::new`, which uses `IntoIterator` to do the conversion more cleanly and succinctly. The old way is still left as an option for those wanting it.

**Testing**

Updated the test to use the `new` function.

### The Story of This Pull Request

The `WithRelated` component in Bevy's ECS system provides a way to attach existing entities as children when spawning new entities. Before this change, users needed to explicitly convert collections into iterators using `.into_iter()` when using `WithRelated`. This required writing:

```rust
WithRelated([child2, child3].into_iter())
```

This syntax felt cumbersome and required an extra method call that wasn't immediately obvious to new users. The explicit iterator conversion added visual noise and made the API less approachable.

The solution introduces a constructor function `WithRelated::new` that leverages Rust's `IntoIterator` trait. This allows users to pass any iterable collection directly without manual conversion. The new syntax becomes:

```rust
WithRelated::new([child2, child3])
```

The implementation adds a simple constructor to the `WithRelated` struct:
```rust
impl<I> WithRelated<I> {
    pub fn new(iter: impl IntoIterator<IntoIter = I>) -> Self {
        Self(iter.into_iter())
    }
}
```

This approach maintains full backwards compatibility since the original tuple constructor remains available. The `IntoIterator` bound ensures any collection type that can be converted to an iterator matching `I` works with the new constructor.

The changes required minimal adjustments:
1. Added the constructor method to `WithRelated`
2. Updated the documentation example to demonstrate the cleaner syntax
3. Modified the test case to use the new constructor

The ergonomic improvement reduces boilerplate while maintaining identical functionality. The change is localized to the `WithRelated` API surface and doesn't affect other ECS operations. By keeping the original constructor, existing codebases can migrate gradually without breaking changes.

### Key Files Changed

**crates/bevy_ecs/src/spawn.rs**  
Added a constructor to simplify `WithRelated` usage and updated documentation/test.

```rust
// Before:
pub struct WithRelated<I>(pub I);

// After:
pub struct WithRelated<I>(pub I);

impl<I> WithRelated<I> {
    /// Creates a new [`WithRelated`] from a collection of entities.
    pub fn new(iter: impl IntoIterator<IntoIter = I>) -> Self {
        Self(iter.into_iter())
    }
}
```

Documentation update:
```rust
// Before:
// WithRelated([child2, child3].into_iter()),

// After:
// WithRelated::new([child2, child3]),
```

Test update:
```rust
// Before:
Children::spawn(WithRelated([child1, child2].into_iter())),

// After:
Children::spawn(WithRelated::new([child1, child2])),
```

### Visual Representation
```mermaid
graph LR
    A[WithRelated] --> B[new constructor]
    B --> C[Accepts IntoIterator]
    C --> D[Creates WithRelated instance]
```

### Further Reading
- Rust's [IntoIterator trait](https://doc.rust-lang.org/std/iter/trait.IntoIterator.html) documentation
- Bevy's [Entity Relationships](https://bevyengine.org/learn/book/ecs/entity-relationships/) guide
- API Guidelines on [Constructor Names](https://rust-lang.github.io/api-guidelines/predictability.html#c-new)