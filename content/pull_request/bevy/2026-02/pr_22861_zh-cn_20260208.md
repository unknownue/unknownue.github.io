+++
title = "#22861 Add performance clarification to `Single`"
date = "2026-02-08T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = false

[extra]
current_language = "zh-cn"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2026-02/pr-22861-en-20260208" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2026-02/pr-22861-zh-cn-20260208" }}
labels = ["C-Docs", "D-Trivial", "A-ECS"]
+++

# Title

## Basic Information
- **Title**: Add performance clarification to `Single`
- **PR Link**: https://github.com/bevyengine/bevy/pull/22861
- **Author**: Saratii
- **Status**: MERGED
- **Labels**: C-Docs, D-Trivial, A-ECS, S-Ready-For-Final-Review
- **Created**: 2026-02-08T03:21:14Z
- **Merged**: 2026-02-08T19:03:34Z
- **Merged By**: alice-i-cecile

## Description Translation
许多用户会合理地假设 `Single` 比 `Query` 更快，因为它可以在找到匹配项后提前退出。
在查看了实现后，我发现它并没有被用作性能优化，相反，它的存在是为了执行额外的验证。

## 解决方案
添加文档说明，澄清 `Single` 是用于验证目的的，并且可能会产生轻微的开销，因为这一行为并不显而易见。

## The Story of This Pull Request

这个PR的核心是一个关于API预期的文档修正，旨在防止潜在的性能误用。

**问题与背景**：在Bevy的ECS中，`Query<&Component>`是一个常用的系统参数，用于查询所有匹配特定组件的实体。`Single<&Component>`也是一个系统参数，它确保查询结果有且只有一个匹配的实体，否则会导致恐慌（panic）。一个符合直觉的假设是，`Single`的实现可能会在找到第一个匹配项后提前终止查询，作为一种性能优化。毕竟，如果你只需要一个结果，为什么还要遍历剩余的实体呢？许多开发者正是基于这个假设选择使用`Single`，期望它能带来性能提升。

**解决方案与方法**：PR作者Saratii通过审查`Single`在`bevy_ecs`中的实际实现，发现这个假设是错误的。`Single`内部确实使用了`Query`，但它并没有实现任何“提前退出”的短路逻辑。它的主要设计目的是强制执行“唯一性”约束——这是一个数据完整性检查，而非性能优化。事实上，为了确保查询条件确实只匹配一个实体（如果匹配零个或多个则会panic），它可能需要遍历所有实体，这甚至可能引入轻微的开销。问题的关键在于，这种实现细节和设计意图并没有在API文档中明确说明，导致开发者的预期与实际情况不符。

**技术实现与细节**：这个PR的修改非常简洁，只涉及文档更新。在`Single`结构体的文档注释中增加了一行关键的说明。这行注释直接针对核心误解，明确指出`Single`不是一种搜索优化，而是一种带有轻微开销的验证工具。这个改动虽小，但价值在于将隐藏在代码实现中的设计决策提升到了API文档的层面，为使用者提供了准确的指引。

**技术洞察与影响**：这个PR揭示了一个重要的软件工程原则：API的命名和直觉行为应该与实现保持一致，如果不一致，必须有清晰的文档说明。`Single`这个名字可能暗示着“获取单个”，但它隐藏了“验证唯一性”这一更重要的责任。从性能角度来看，这个澄清防止了开发者为了追求并不存在的性能优势而错误地选择`Single`，从而可能无意中引入不必要的运行时检查开销。对于确实需要唯一实体的场景，开发者现在可以基于正确的信息做选择：是使用`Single`来获得严格的唯一性保证（并接受其开销），还是使用`Option<Single<...>>`来处理零或一个实体的场景，亦或是直接使用`Query`并进行手动的结果数量检查。

**总结**：这本质上是一个预防性的文档改进。它没有修改任何功能代码，但通过澄清一个关键的实现细节，提升了代码库的可理解性，并防止了基于错误假设的API误用。对于像Bevy这样的大型游戏引擎，清晰的文档对于维护一个健康的生态系统至关重要。

## Visual Representation

```mermaid
graph TD
    subgraph “查询工具对比”
        Q[Query] --> |遍历所有匹配实体| Q_Result[多个结果]
        S[Single] --> |内部使用 Query 遍历| AllEntities[所有实体]
        AllEntities --> |验证恰好匹配一个| S_Result[单个结果或 Panic]
        OS[Option<Single>] --> |处理 0 或 1 个结果| OS_Result[Some(T) 或 None]
    end
    
    subgraph “开发者预期 vs 实际”
        Exp[开发者预期: Single 提前退出] -.->|与实际不符| S
        Act[实际: Single 用于验证唯一性] --> S
    end

    style Exp fill:#f9f,stroke:#333,stroke-width:2px
    style Act fill:#ccf,stroke:#333,stroke-width:2px
```

## Key Files Changed

### `crates/bevy_ecs/src/system/query.rs`
**修改描述**：为 `Single` 结构体的文档添加了一行性能说明，澄清其设计目的并非性能优化，而是用于验证，且可能带来轻微开销。

**代码片段**：
```rust
// 修改位置在 Single 结构体的文档注释块内
// After (添加了一行):
///
/// Use [`Option<Single<D, F>>`] instead if zero or one matching entities can exist.
///
/// Note that [`Single`] is not used as a search optimization. It is used as a validation with slight overhead compared to [`Query`].
///
/// See [`Query`] for more details.
///
/// [System parameter]: crate::system::SystemParam
```

**与PR目的的关系**：这是本PR的唯一实质性改动。这行注释直接实现了PR的目标——澄清 `Single` 的性能特征和设计意图，防止开发者产生“它会更快”的误解。

## Further Reading
1.  **Bevy ECS `Query` 官方文档**: 理解 `Query` 和 `Single` 的基础用法。
    *   [Bevy Cheatbook - Queries](https://bevy-cheatbook.github.io/programming/queries.html)
2.  **Rust API 设计指南 - 关于“可预期性”**: 了解为何API的行为应当符合使用者直觉，或必须有明确文档说明。
    *   [Rust API Guidelines - Predictability](https://rust-lang.github.io/api-guidelines/predictability.html)
3.  **《代码大全》中关于“变量命名”的章节**: 深入理解命名如何影响开发者对代码行为的预期。`Single` 的命名是一个值得探讨的案例。

# Full Code Diff
diff --git a/crates/bevy_ecs/src/system/query.rs b/crates/bevy_ecs/src/system/query.rs
index c6293ede5c0b1..80e84dbc502c2 100644
--- a/crates/bevy_ecs/src/system/query.rs
+++ b/crates/bevy_ecs/src/system/query.rs
@@ -2730,6 +2730,8 @@ impl<'w, 'q, Q: QueryData, F: QueryFilter> From<&'q mut Query<'w, '_, Q, F>>
 ///
 /// Use [`Option<Single<D, F>>`] instead if zero or one matching entities can exist.
 ///
+/// Note that [`Single`] is not used as a search optimization. It is used as a validation with slight overhead compared to [`Query`].
+///
 /// See [`Query`] for more details.
 ///
 /// [System parameter]: crate::system::SystemParam