+++
title = "#22872 Release-0.18.1: Ensure other half `Gizmos` Observer Fix lands correctly in release branch"
date = "2026-02-09T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = true

[taxonomies]
list_display = ["show"]

[extra]
current_language = "en"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2026-02/pr-22872-en-20260209" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2026-02/pr-22872-zh-cn-20260209" }}
labels = ["A-Gizmos"]
+++

# Title

## Basic Information
- **Title**: Release-0.18.1: Ensure other half `Gizmos` Observer Fix lands correctly in release branch
- **PR Link**: https://github.com/bevyengine/bevy/pull/22872
- **Author**: kfc35
- **Status**: MERGED
- **Labels**: S-Ready-For-Final-Review, A-Gizmos
- **Created**: 2026-02-09T03:00:40Z
- **Merged**: 2026-02-09T22:35:05Z
- **Merged By**: alice-i-cecile

## Description
> [!IMPORTANT]
> This will be merged into the `release-0.18.1` branch, _not_ `main`

# Objective

- Ensure the missing part of #22800 (in the 0.18.1 milestone) that was merged as part of #22832 (in the 0.19.0 milestone) still lands in 0.18.1

## Solution

- Ensure `queue()` is implemented in the `SystemBuffer` `GizmoBuffer`, and that `apply()` delegates to `queue()`

The other half of the solution, #22800, is in the 0.18.1 milestone and will eventually get put into this branch whenever it is needed.

(The code in this PR used to be in #22800, but when #22832 was merged before it, the change became lost).

## The Story of This Pull Request

This PR addresses a specific problem that emerged during the release management process. The issue originated from a fix for the Gizmos system that was split across two different PRs targeting different release milestones. The complete fix involved changes to how the `GizmoBuffer` system buffer interacts with the Entity Component System (ECS) observer system.

The core problem was that when two related PRs were merged in a non-sequential order, part of the fix for the 0.18.1 release was lost. PR #22800 contained the complete fix for the Gizmos observer system in the 0.18.1 milestone, but before it could be merged, PR #22832 was merged into the 0.19.0 milestone branch. PR #22832 included the same code changes but targeted the newer 0.19.0 version. When #22800 was eventually merged, the overlapping code from #22832 wasn't included in the 0.18.1 branch because it had already been committed to the 0.19.0 branch.

The technical issue being fixed relates to how system buffers work with the ECS observer system. In Bevy's ECS, system buffers are used to collect data during system execution that needs to be applied to the world. The observer system introduced a new pattern where buffers should implement both `apply()` and `queue()` methods. The `queue()` method is used when working with a `DeferredWorld`, which is a special world context used by observers to safely queue changes without immediately applying them.

The solution implemented in this PR is straightforward: ensure that the `GizmoBuffer` properly implements the `SystemBuffer` trait by providing a `queue()` method and having the existing `apply()` method delegate to it. This follows the pattern established in other system buffers in the codebase and ensures compatibility with the observer system.

The changes are minimal but important:
1. Add the `DeferredWorld` import to the module
2. Modify the `apply()` method to call `queue()` with a converted world
3. Implement the `queue()` method with the same logic that was previously in `apply()`

This fix ensures that Gizmos work correctly with the observer system in the 0.18.1 release, maintaining backward compatibility while properly implementing the required system buffer interface.

## Visual Representation

```mermaid
graph TD
    A[System Execution] --> B[GizmoBuffer]
    B --> C{World Context}
    C -->|apply()| D[Immediate World]
    C -->|queue()| E[DeferredWorld]
    E --> F[Queued Changes]
    F --> G[Applied via Observer System]
    
    style B fill:#e1f5e1
    style E fill:#e1f5e1
```

## Key Files Changed

### `crates/bevy_gizmos/src/gizmos.rs` (+6/-2)

This file contains the implementation of the Gizmos system. The changes ensure that `GizmoBuffer` properly implements the `SystemBuffer` trait with both `apply()` and `queue()` methods.

**Key modifications:**

```rust
// Before the change, the SystemBuffer implementation for GizmoBuffer had:
fn apply(&mut self, _system_meta: &SystemMeta, world: &mut World) {
    let mut storage = world.resource_mut::<GizmoStorage<Config, Clear>>();
    storage.list_positions.append(&mut self.list_positions);
    storage.list_colors.append(&mut self.list_colors);
    // ... rest of the method
}

// After the change:
fn apply(&mut self, system_meta: &SystemMeta, world: &mut World) {
    self.queue(system_meta, world.into());
}

fn queue(&mut self, _system_meta: &SystemMeta, mut world: DeferredWorld) {
    let mut storage = world.resource_mut::<GizmoStorage<Config, Clear>>();
    storage.list_positions.append(&mut self.list_positions);
    storage.list_colors.append(&mut self.list_colors);
    // ... same logic as the old apply() method
}
```

The changes are:
1. Added `DeferredWorld` to the imports from `bevy_ecs::world`
2. Modified `apply()` to delegate to `queue()` by converting the `World` reference to a `DeferredWorld` using `world.into()`
3. Implemented `queue()` with the same logic that was previously in `apply()`

These changes ensure that `GizmoBuffer` properly supports the observer system pattern where buffers can queue changes for deferred application.

## Further Reading

1. **Bevy ECS System Buffers**: The official Bevy documentation on system parameters and buffers provides context for how system buffers work in the ECS.
2. **Observer Pattern in ECS**: Understanding the observer system in Bevy helps explain why the `queue()` method is necessary alongside `apply()`.
3. **Release Branch Management**: This PR serves as a case study in managing fixes across multiple release branches and avoiding code loss during parallel development.
4. **PR #22800 and #22832**: Reviewing the related PRs provides full context for the complete fix that was split across releases.