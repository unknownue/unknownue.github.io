+++
title = "#22908 Fix Image pixel access error propagation for compressed formats"
date = "2026-02-12T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = false

[extra]
current_language = "zh-cn"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2026-02/pr-22908-en-20260212" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2026-02/pr-22908-zh-cn-20260212" }}
labels = ["C-Bug", "A-Rendering", "M-Migration-Guide"]
+++

# Title

## Basic Information
- **Title**: Fix Image pixel access error propagation for compressed formats
- **PR Link**: https://github.com/bevyengine/bevy/pull/22908
- **Author**: mirsella
- **Status**: MERGED
- **Labels**: C-Bug, A-Rendering, S-Ready-For-Final-Review, M-Migration-Guide
- **Created**: 2026-02-11T14:07:34Z
- **Merged**: 2026-02-12T18:50:21Z
- **Merged By**: alice-i-cecile

## 描述翻译
这是对 #22414 的后续修复。

在我的评论 <https://github.com/bevyengine/bevy/pull/22414#issuecomment-2645849258> 中，我意识到 #22414 中添加的警告实际上永远不会触发，因为 `pixel_bytes` 和 `pixel_bytes_mut` 返回的是 `Option` 而不是 `Result`，这导致 `UnsupportedTextureFormat` 错误丢失并被转换为 `OutOfBounds`。

这次修改包括：
- `pixel_data_offset` 现在返回 `Result` 而不是 `Option`
- `pixel_bytes` 和 `pixel_bytes_mut` 现在返回 `Result` 而不是 `Option`
- 错误现在能够正确传播，使得 sprite picking 中的警告能够为压缩纹理正确触发
- 添加了回归测试 `compressed_texture_format_is_reported_correctly`
- 根据新的函数签名更新了 `examples/2d/cpu_draw.rs`

我应该删除这个回归测试吗？如果它没什么用的话。

谢谢

## 这个 Pull Request 的故事

这个 PR 源于一个错误诊断问题：在 Bevy 的渲染系统中，开发人员无法正确区分纹理访问失败的具体原因。问题核心在于压缩纹理格式的错误处理机制存在缺陷。

### 问题和背景

在先前的 PR #22414 中，开发人员添加了一个针对压缩纹理的警告机制，用于提示用户这类格式不支持直接的像素级访问。然而，作者 mirsella 在代码审查中发现，这个警告实际上永远不会触发，因为底层的错误传播机制存在缺陷。

根本问题在于 `Image::pixel_bytes()` 和 `Image::pixel_bytes_mut()` 方法返回的是 `Option<&[u8]>` 类型。当这些方法遇到不支持压缩纹理时，内部的 `pixel_size()` 方法会返回 `Err(UnsupportedTextureFormat)`，但调用 `ok()` 方法会将其转换为 `None`。同样，坐标越界访问也会返回 `None`。这导致调用者无法区分这两种不同的错误情况。

### 解决方案方法

开发人员采用了直接而有效的方法：将错误处理从 `Option` 转换为 `Result`，并完善错误类型。这样不仅修复了警告不触发的问题，还提供了更精确的错误信息。技术决策包括：

1. 将 `pixel_data_offset()`、`pixel_bytes()` 和 `pixel_bytes_mut()` 的返回类型从 `Option` 改为 `Result`
2. 扩展 `TextureAccessError` 枚举以包含 `Uninitialized` 状态
3. 更新所有调用这些方法的内部代码以正确处理 `Result` 类型
4. 添加专门的回归测试以确保压缩纹理错误被正确报告

### 实现细节

修改主要集中在 `crates/bevy_image/src/image.rs` 文件中。核心变化是函数签名和错误处理的改进。以 `pixel_data_offset()` 为例：

```rust
// 修改前（返回 Option，错误信息丢失）
pub fn pixel_data_offset(&self, coords: UVec3) -> Option<usize> {
    let pixel_size = self.texture_descriptor.format.pixel_size().ok()?;
    // ...
}

// 修改后（返回 Result，保留错误信息）
pub fn pixel_data_offset(&self, coords: UVec3) -> Result<usize, TextureAccessError> {
    let pixel_size = self.texture_descriptor.format.pixel_size()?;
    // ...
}
```

更重要的是，现在坐标越界访问会返回详细的 `TextureAccessError::OutOfBounds` 错误，包含具体的坐标信息：

```rust
if coords.x >= width || coords.y >= height || coords.z >= depth {
    return Err(TextureAccessError::OutOfBounds {
        x: coords.x,
        y: coords.y,
        z: coords.z,
    });
}
```

对于 `pixel_bytes()` 和 `pixel_bytes_mut()`，修改还包括正确处理图像数据未初始化的情况：

```rust
pub fn pixel_bytes(&self, coords: UVec3) -> Result<&[u8], TextureAccessError> {
    let len = self.texture_descriptor.format.pixel_size()?;
    let start = self.pixel_data_offset(coords)?;
    let Some(data) = self.data.as_ref() else {
        return Err(TextureAccessError::Uninitialized);
    };
    Ok(&data[start..(start + len)])
}
```

### 技术洞见

这个修改展示了错误处理设计的重要原则：使用 `Result` 而不是 `Option` 来提供更丰富的错误信息。在游戏引擎这种复杂的系统中，能够区分不同类型的失败情况对于调试和用户体验至关重要。

此外，这个 PR 还体现了向后兼容性考虑。由于函数签名改变，需要更新调用代码，开发人员为此创建了迁移指南 `image_pixel_bytes_result.md`，指导用户如何处理新的 `Result` 返回类型。

### 影响

这个修复解决了多个问题：
1. 压缩纹理的错误现在能够正确传播，使得 #22414 中添加的警告能够按预期工作
2. 开发人员现在能够区分不同类型的纹理访问错误（坐标越界、格式不支持、数据未初始化）
3. 提高了代码的健壮性和可调试性

从架构角度看，这个修改使 Bevy 的纹理系统更加符合 Rust 的错误处理最佳实践，为未来的扩展和维护提供了更好的基础。

## 可视化表示

```mermaid
graph TD
    A[调用者代码] --> B[Image::pixel_bytes()]
    B --> C[检查格式支持]
    C -->|压缩格式| D[返回 UnsupportedTextureFormat]
    C -->|支持格式| E[检查坐标边界]
    E -->|越界| F[返回 OutOfBounds]
    E -->|有效坐标| G[检查数据初始化]
    G -->|未初始化| H[返回 Uninitialized]
    G -->|已初始化| I[返回像素数据切片]
```

## 关键文件变更

### `crates/bevy_image/src/image.rs` (+63/-32)

主要修改了图像像素访问相关的 API，完善了错误处理机制。

关键修改包括：

1. **`pixel_data_offset()` 方法签名变更**：
```rust
// 修改前
pub fn pixel_data_offset(&self, coords: UVec3) -> Option<usize>

// 修改后  
pub fn pixel_data_offset(&self, coords: UVec3) -> Result<usize, TextureAccessError>
```

2. **`pixel_bytes()` 和 `pixel_bytes_mut()` 方法重构**：
```rust
// 修改前
pub fn pixel_bytes(&self, coords: UVec3) -> Option<&[u8]> {
    let len = self.texture_descriptor.format.pixel_size().ok()?;
    let data = self.data.as_ref()?;
    self.pixel_data_offset(coords)
        .map(|start| &data[start..(start + len)])
}

// 修改后
pub fn pixel_bytes(&self, coords: UVec3) -> Result<&[u8], TextureAccessError> {
    let len = self.texture_descriptor.format.pixel_size()?;
    let start = self.pixel_data_offset(coords)?;
    let Some(data) = self.data.as_ref() else {
        return Err(TextureAccessError::Uninitialized);
    };
    Ok(&data[start..(start + len)])
}
```

3. **错误枚举扩展**：
```rust
pub enum TextureAccessError {
    #[error("coordinates {x}, {y}, {z} are out of bounds")]
    OutOfBounds { x: u32, y: u32, z: u32 },
    #[error("unsupported texture format: {0:?}")]
    UnsupportedTextureFormat(TextureFormat),
    #[error("image data is not initialized")]  // 新增
    Uninitialized,
    #[error("attempt to access texture with different dimension")]
    WrongDimension,
}
```

4. **新增回归测试**：
```rust
#[test]
fn compressed_texture_format_is_reported_correctly() {
    // 验证压缩纹理格式会正确报告 UnsupportedTextureFormat 错误
    let mut image = Image::new_uninit(
        Extent3d { width: 4, height: 4, depth_or_array_layers: 1 },
        TextureDimension::D2,
        TextureFormat::Bc1RgbaUnorm,  // 压缩格式
        RenderAssetUsages::MAIN_WORLD,
    );
    
    assert!(matches!(
        image.get_color_at(0, 0),
        Err(TextureAccessError::UnsupportedTextureFormat(
            TextureFormat::Bc1RgbaUnorm
        ))
    ));
}
```

### `release-content/migration-guides/image_pixel_bytes_result.md` (+48/-0)

新增的迁移指南，帮助用户适应 API 变更：

```markdown
---
title: "`Image::pixel_bytes` and `Image::pixel_data_offset` now return `Result`"
pull_requests: [22908]
---

`Image::pixel_bytes`, `Image::pixel_bytes_mut`, and
`Image::pixel_data_offset` now return `Result<..., TextureAccessError>`.

Previously, these methods returned `Option` and would silently fail for
both out-of-bounds access and unsupported texture formats (such as
compressed textures). This caused error information to be lost, making it
impossible for callers to distinguish between these different failure
cases.

Now, these methods properly propagate `TextureAccessError`:
- `TextureAccessError::OutOfBounds` for coordinates outside the image bounds
- `TextureAccessError::UnsupportedTextureFormat` for compressed or unsupported texture formats
- `TextureAccessError::Uninitialized` if the image data is not initialized
```

## 进一步阅读

1. **Rust 错误处理最佳实践**: The Rust Programming Language 书中关于错误处理的章节，特别是 `Result` 和 `Option` 的区别和使用场景
2. **Bevy 渲染系统文档**: Bevy 官方文档中关于纹理和图像处理的部分
3. **游戏引擎中的纹理压缩**: 了解不同纹理压缩格式（如 BC1/BC2/BC3）的特点和限制
4. **API 设计模式**: 关于何时使用 `Result` 而非 `Option` 的设计决策指南