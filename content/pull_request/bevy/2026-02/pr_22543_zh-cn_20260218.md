+++
title = "#22543 Fix build-wasm-example with `--debug` arg"
date = "2026-02-18T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = false

[extra]
current_language = "zh-cn"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2026-02/pr-22543-en-20260218" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2026-02/pr-22543-zh-cn-20260218" }}
+++

# Fix build-wasm-example with `--debug` arg

## 基本信息
- **标题**: Fix build-wasm-example with `--debug` arg
- **PR链接**: https://github.com/bevyengine/bevy/pull/22543
- **作者**: beicause
- **状态**: 已合并
- **标签**: C-Bug, A-Build-System, O-Web, D-Straightforward, S-Needs-Review
- **创建时间**: 2026-01-16T08:09:14Z
- **合并时间**: 2026-02-18T12:50:53Z
- **合并者**: mockersf

## 描述翻译
使用 `--debug` 参数时，cargo 的 profile 是 `dev`。

## 本PR的故事

本次PR源于一个在Bevy的WebAssembly（Wasm）构建工具中发现的具体错误。`tools/build-wasm-example` 是一个用于构建和打包Wasm示例的脚本。当开发者尝试使用 `--debug` 标志运行此工具时，构建会失败。

问题的根源在于逻辑上的不一致。在Cargo的体系中，当你运行 `cargo build` 而不指定 `--release` 时，它使用默认的 `dev` profile，并且输出文件位于 `target/debug/` 目录下。然而，这个构建脚本的内部逻辑对此的认知存在偏差。

具体来看，在修复前的代码中：
```rust
let profile = if cli.debug {
    "debug" // 这里认为profile名称是"debug"
} else if cli.optimize_size {
    "wasm-release"
} else {
    "release"
};
```
当传入 `--debug` 标志时，脚本将 `profile` 变量设置为字符串 `"debug"`。接着，它使用这个 `profile` 变量来构造 `cargo build` 命令的 `--profile` 参数，并同样用它来定位最终生成的 `.wasm` 文件路径：`target/wasm32-unknown-unknown/{profile}/examples/...`。

但这里存在两个问题：
1.  作为 `--profile` 参数的值，Cargo不接受 `"debug"`。它接受的是 `"dev"` 来表示开发（调试）构建。
2.  更重要的是，即使我们纠正了第一个问题，将 `--profile` 设为 `"dev"`，Cargo的输出目录也仍然是 `target/wasm32-unknown-unknown/debug/`，而不是 `.../dev/`。这意味着脚本在后续查找 `.wasm` 文件时，会在一个不存在的目录里寻找，导致 `wasm-bindgen` 命令失败，因为输入文件找不到。

因此，解决方案需要澄清两个不同的概念：传递给Cargo的 **profile名称** 和Cargo输出结果所在的 **目录名称**。这两个值在 `release` 和 `wasm-release` 情况下是相同的，但在 `debug/dev` 情况下是不同的。

开发者采取的修复方法是同时定义这两个值，并为它们建立正确的映射关系：
```rust
let (profile, out_dir) = if cli.debug {
    ("dev", "debug") // Profile名称是"dev"，输出目录是"debug"
} else if cli.optimize_size {
    ("wasm-release", "wasm-release")
} else {
    ("release", "release")
};
```
现在，`profile` 变量（值为 `"dev"`）被正确地用于 `cargo build --profile` 参数，告诉Cargo使用开发配置进行构建。而 `out_dir` 变量（值为 `"debug"`）则被用于构建后续 `wasm-bindgen` 命令的输入文件路径，确保能找到Cargo实际输出的 `.wasm` 文件。

这是一个典型的针对构建脚本或工具的修复，它不涉及核心的游戏引擎逻辑，但对开发者的工作流程至关重要。它修正了脚本内部状态与外部工具（Cargo）实际行为之间不匹配的问题。修复本身是直接且精准的，通过引入一个变量来区分两个相关但不同的概念，从而解决了命令执行和文件查找两个环节的断链问题。

## 视觉呈现

```mermaid
graph TD
    A[用户执行<br>build-wasm-example --debug] --> B{脚本逻辑判断}
    
    B -- 修复前 --> C1[设置 profile = “debug”]
    C1 --> D1[构建命令: cargo build --profile debug]
    D1 --> E1[预期输出目录: target/.../debug/]
    E1 --> F1[文件查找路径使用 profile (“debug”)]
    F1 --> G1[❌ 失败: Cargo 不接受 --profile debug]
    
    B -- 修复后 --> C2[设置 (profile, out_dir) = (“dev”, “debug”)]
    C2 --> D2[构建命令: cargo build --profile dev]
    D2 --> E2[实际输出目录: target/.../debug/]
    E2 --> F2[文件查找路径使用 out_dir (“debug”)]
    F2 --> G2[✅ 成功: 命令正确，文件找到]
```

## 关键文件更改

- `tools/build-wasm-example/src/main.rs` (+5/-5)
    1.  **变更描述与原因**：修复了当使用 `--debug` 标志时，构建脚本中Cargo profile名称与输出目录名称不匹配的问题。原先错误地认为两者相同（都是“debug”），实际上Cargo的profile名为“dev”，但输出到“debug”目录。
    2.  **关键代码片段**：
        ```rust
        // 修复前：
        let profile = if cli.debug {
            "debug"
        } else if cli.optimize_size {
            "wasm-release"
        } else {
            "release"
        };

        // 在后续命令中使用 `{profile}`...
        ```

        ```rust
        // 修复后：
        let (profile, out_dir) = if cli.debug {
            ("dev", "debug")
        } else if cli.optimize_size {
            ("wasm-release", "wasm-release")
        } else {
            ("release", "release")
        };

        // 在构建命令中使用 `{profile}`...
        // 在文件路径中使用 `{out_dir}`...
        ```
    3.  **与PR整体目的的关系**：这是本次PR的唯一修改，直接解决了问题。它清晰地分离了“传递给Cargo的配置名称”和“Cargo输出文件的目录名”这两个概念，并为`debug`模式建立了正确的映射(`"dev"` -> `"debug"`)，从而确保了构建命令能正确执行且生成的文件能被找到。

## 延伸阅读

- **Cargo Profiles官方文档**：了解 `dev`, `release` 以及其他自定义profile的详细配置选项。
    - [https://doc.rust-lang.org/cargo/reference/profiles.html](https://doc.rust-lang.org/cargo/reference/profiles.html)
- **`wasm-bindgen` 项目**：了解如何将Rust代码编译为Wasm并生成JavaScript绑定。
    - [https://github.com/rustwasm/wasm-bindgen](https://github.com/rustwasm/wasm-bindgen)
- **Bevy WebAssembly 指南**：学习如何在Bevy游戏引擎中构建和运行WebAssembly应用。
    - [https://bevyengine.org/learn/quick-start/platforms/wasm/](https://bevyengine.org/learn/quick-start/platforms/wasm/)