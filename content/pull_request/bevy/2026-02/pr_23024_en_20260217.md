+++
title = "#23024 Fix `WGPU_SETTINGS_PRIO=\"webgl2\"` after atmosphere landed."
date = "2026-02-17T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = true

[taxonomies]
list_display = ["show"]

[extra]
current_language = "en"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2026-02/pr-23024-en-20260217" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2026-02/pr-23024-zh-cn-20260217" }}
labels = ["D-Trivial", "A-Rendering", "P-Crash", "A-Diagnostics"]
+++

# Fix `WGPU_SETTINGS_PRIO="webgl2"` after atmosphere landed

## Basic Information
- **Title**: Fix `WGPU_SETTINGS_PRIO="webgl2"` after atmosphere landed.
- **PR Link**: https://github.com/bevyengine/bevy/pull/23024
- **Author**: pcwalton
- **Status**: MERGED
- **Labels**: D-Trivial, A-Rendering, P-Crash, S-Ready-For-Final-Review, A-Diagnostics
- **Created**: 2026-02-17T22:39:23Z
- **Merged**: 2026-02-17T23:40:36Z
- **Merged By**: alice-i-cecile

## Description Translation
The atmosphere plugin only checks `RenderAdapter` to determine whether it's safe to run, not `RenderDevice`. As PR #18113 discovered, this causes `WGPU_SETTINGS_PRIO="webgl2"` to fail, because that environment variable only affects `RenderDevice`, not `RenderAdapter`. Like that PR, this PR fixes atmosphere to check `RenderDevice` in addition to `RenderAdapter`.

## The Story of This Pull Request

This PR addresses a specific bug where the atmosphere plugin fails to load when the `WGPU_SETTINGS_PRIO="webgl2"` environment variable is set. The root cause stems from a discrepancy between how different parts of the rendering system check for GPU capabilities.

When the atmosphere plugin initializes, it performs a capability check to ensure the GPU supports required features. The original implementation only checked the `RenderAdapter`, which represents the physical GPU hardware and its capabilities. However, the `WGPU_SETTINGS_PRIO="webgl2"` environment variable affects the `RenderDevice` - the logical device interface to the GPU - by limiting its capabilities to WebGL2 compatibility levels. This creates a situation where the `RenderAdapter` reports support for certain features, but the `RenderDevice` (constrained by the environment variable) doesn't actually provide them.

The issue manifests specifically with storage textures. The atmosphere plugin requires `max_storage_textures_per_shader_stage > 0`, but when `WGPU_SETTINGS_PRIO="webgl2"` is set, the device emulates WebGL2 constraints which typically don't include storage texture support. The original check only looked at adapter capabilities, so it would incorrectly assume the feature was available and attempt to use it, causing a crash.

This is actually a recurrence of a problem that was previously discovered and fixed in PR #18113 for other parts of the codebase. The same pattern needed to be applied to the atmosphere plugin. The fix is straightforward: in addition to checking the `RenderAdapter`, the plugin now also checks the `RenderDevice`'s capabilities.

The implementation adds a new check in the atmosphere plugin's `Plugin::build` method. After the existing adapter check, it retrieves the `RenderDevice` resource and checks if `max_storage_textures_per_shader_stage` is greater than 0. If not, it logs a warning and returns early without setting up the atmosphere rendering systems.

This approach ensures consistency with how other rendering features in Bevy handle capability checks. It's a defensive check that prevents trying to use features the current device configuration doesn't support, avoiding runtime crashes when the environment variable is set.

The fix is minimal and focused - it only adds the necessary device capability check without changing any other behavior. This maintains backward compatibility for all cases where the device actually supports the required features, while preventing crashes in the specific `WGPU_SETTINGS_PRIO="webgl2"` configuration.

## Visual Representation

```mermaid
graph TD
    A[AtmospherePlugin] --> B{Check RenderAdapter}
    B -->|Capabilities OK| C{Check RenderDevice}
    B -->|Missing features| D[Early return - skip setup]
    C -->|max_storage_textures_per_shader_stage > 0| E[Setup atmosphere systems]
    C -->|No storage texture support| D
    
    F[WGPU_SETTINGS_PRIO="webgl2"] --> G[Affects RenderDevice limits]
    G --> C
```

## Key Files Changed

### `crates/bevy_pbr/src/atmosphere/mod.rs` (+10/-0)

The change adds a capability check for the `RenderDevice` in addition to the existing `RenderAdapter` check. This ensures the atmosphere plugin properly respects the `WGPU_SETTINGS_PRIO="webgl2"` environment variable which affects device capabilities but not adapter capabilities.

**Key modifications:**
```rust
// Added import for RenderDevice
use bevy_render::{
    extract_component::UniformComponentPlugin,
    render_resource::{DownlevelFlags, ShaderType, SpecializedRenderPipelines},
    renderer::RenderDevice,  // <-- New import
    sync_component::SyncComponent,
    sync_world::RenderEntity,
    Extract, ExtractSchedule, RenderStartup,
};

// Added check in Plugin::build method
// Check the `RenderDevice` in addition to the `RenderAdapter`. The
// former takes the `WGPU_SETTINGS_PRIO` environment variable into
// account, and the latter doesn't.
let render_device = render_app.world().resource::<RenderDevice>();
if render_device.limits().max_storage_textures_per_shader_stage == 0 {
    warn!("AtmospherePlugin not loaded. GPU lacks support: `max_storage_textures_per_shader_stage` is 0");
    return;
}
```

The change adds a second capability check that examines the `RenderDevice`'s limits after the existing `RenderAdapter` check. This ensures that if the device (influenced by environment variables) doesn't support storage textures, the plugin will exit early with a warning instead of trying to use unsupported features.

## Further Reading

- [WebGPU Specification - Storage Textures](https://www.w3.org/TR/webgpu/#texture-format-capabilities) - Details on storage texture capabilities in WebGPU
- [Bevy PR #18113](https://github.com/bevyengine/bevy/pull/18113) - The original fix for similar issues in other parts of the codebase
- [wgpu Documentation on Limits](https://docs.rs/wgpu/latest/wgpu/struct.Limits.html) - Information about device limits and capabilities
- [Bevy Rendering Architecture](https://bevyengine.org/learn/quick-start/getting-started/rendering/) - Overview of Bevy's rendering system