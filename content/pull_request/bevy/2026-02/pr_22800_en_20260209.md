+++
title = "#22800 Fix Gizmos not drawing `On<Pointer<Drag>>`, Observers generally, and Triggered Systems"
date = "2026-02-09T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = true

[taxonomies]
list_display = ["show"]

[extra]
current_language = "en"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2026-02/pr-22800-en-20260209" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2026-02/pr-22800-zh-cn-20260209" }}
labels = ["C-Bug", "A-ECS", "A-Gizmos", "D-Straightforward"]
+++

# Title
## Basic Information
- **Title**: Fix Gizmos not drawing `On<Pointer<Drag>>`, Observers generally, and Triggered Systems
- **PR Link**: https://github.com/bevyengine/bevy/pull/22800
- **Author**: kfc35
- **Status**: MERGED
- **Labels**: C-Bug, A-ECS, S-Ready-For-Final-Review, A-Gizmos, D-Straightforward
- **Created**: 2026-02-04T02:42:02Z
- **Merged**: 2026-02-09T02:36:30Z
- **Merged By**: alice-i-cecile

## Description Translation
# Objective

- Fixes #22485 
- Fixes #14566 
- Fixes #19119 

## Solution

- Implement `queue()` for the `Gizmos` `SystemParam`.
- After much debugging, I discovered that the `Gizmos` system parameter never had `apply()` called on it when it was being used within an observer, which was why its internal `SystemBuffer` (`GizmoBuffer`) kept growing indefinitely. I saw that `SystemParam`'s also have a `queue()` function and was curious whether that was being called instead... and it was! So, I just implemented `queue()` in the same way that `apply()` was (after making sure it was OK to use a `DeferredWorld` in that way... and seems like it is OK?), and it solves the issue.
- Edit: I guess this problem has been described before in #14597 , where the solution described there as well is to implement `apply()`
- Disclaimer: Not an ECS master, so someone with ECS mastery can make sure what I wrote makes sense.

## Testing

The reproduction example in #22485 works now. A white square gizmo is drawn in the center if you drag inside the window.
I also tested against the examples in #14566 (both of them) and #19119 and the missing gizmos are drawn.

## The Story of This Pull Request

This pull request addresses a subtle bug in Bevy's ECS system where gizmos wouldn't render correctly when used within observers, triggered systems, or specific event handlers like `On<Pointer<Drag>>`. The issue manifested as gizmos not appearing at all in these contexts, which frustrated developers trying to use Bevy's debugging tools in reactive systems.

The root cause was discovered through systematic debugging: the `Gizmos` system parameter, which implements Bevy's `SystemParam` trait, was missing a critical piece of functionality. In Bevy's ECS architecture, system parameters have two main methods for managing their internal state: `apply()` and `queue()`. The `apply()` method is called in standard systems to flush buffered data to the world, while `queue()` serves a similar purpose but is specifically designed for use in observers and triggered systems where immediate world access isn't available.

The developer discovered that when gizmos were used within observers, the `apply()` method was never being called. Instead, the ECS scheduler was calling the `queue()` method, but the `Gizmos` parameter hadn't implemented it. This meant that the internal `GizmoBuffer` (a `SystemBuffer` that stores gizmo drawing commands) kept accumulating data without ever being flushed. The buffer would grow indefinitely, but the commands were never applied to the rendering system, resulting in invisible gizmos.

The solution was straightforward once the problem was understood: implement the missing `queue()` method. The implementation mirrors the existing `apply()` method but uses a `DeferredWorld` instead of direct world access. This is the standard pattern for system parameters that need to work in both regular systems and observers. The `queue()` method delegates to the underlying `GizmosState` type, which already had both `apply()` and `queue()` implementations available.

What's interesting about this fix is that it reveals an important aspect of Bevy's ECS design: system parameters must be carefully implemented to work across different execution contexts. The `SystemParam` trait provides both `apply()` and `queue()` methods for this reason, and parameters that don't implement both will fail silently in certain contexts. This bug had been reported multiple times over several months (#14566, #19119, #22485), indicating it was a persistent pain point for developers.

The implementation itself is minimal - just four lines of code that add the missing method. However, the debugging process required to identify the issue was non-trivial. The developer had to understand Bevy's ECS internals well enough to trace why gizmos weren't rendering and recognize that the missing `queue()` method was the culprit. This highlights the importance of comprehensive trait implementations in systems programming, where missing a single method can lead to subtle, context-dependent bugs.

The fix ensures that gizmos work consistently across all system types in Bevy, making the debugging tools more reliable. This is particularly important for reactive programming patterns using observers, which are becoming increasingly common in Bevy applications for handling events and state changes.

## Visual Representation

```mermaid
graph TD
    A[Observer System] --> B[calls queue() method]
    B --> C{Gizmos SystemParam}
    C -->|Missing queue()| D[Buffer accumulates, never flushes]
    C -->|With queue()| E[Buffer flushes correctly]
    D --> F[Gizmos not drawn]
    E --> G[Gizmos drawn correctly]
    
    H[Regular System] --> I[calls apply() method]
    I --> C
```

## Key Files Changed

### `crates/bevy_gizmos/src/gizmos.rs` (+4/-0)
This file contains the `Gizmos` system parameter implementation. The change adds the missing `queue()` method to ensure the parameter works correctly in observer contexts.

**Key Modification:**
```rust
// File: crates/bevy_gizmos/src/gizmos.rs
// Before (relevant section):
impl<Config: GizmoConfigGroup, Clear: 'static + Send + Sync> SystemParam for Gizmos<'_, '_, Config, Clear> {
    // ... existing apply() method ...
    
    // Missing queue() method caused issues in observers
}

// After:
impl<Config: GizmoConfigGroup, Clear: 'static + Send + Sync> SystemParam for Gizmos<'_, '_, Config, Clear> {
    // ... existing apply() method ...
    
    // Added queue() method for observer compatibility
    fn queue(state: &mut Self::State, system_meta: &SystemMeta, world: DeferredWorld) {
        GizmosState::<Config, Clear>::queue(&mut state.state, system_meta, world);
    }
    
    // ... rest of implementation ...
}
```

The change adds the `queue()` method implementation that delegates to the underlying `GizmosState::queue()` method. This ensures that when gizmos are used within observers or triggered systems, their drawing commands are properly queued and eventually flushed to the rendering system.

## Further Reading

1. **Bevy ECS SystemParam Documentation**: Understanding the `SystemParam` trait and its methods (`apply()`, `queue()`, etc.) is essential for working with Bevy's ECS system.
2. **Bevy Observers Guide**: The official Bevy documentation on observers and event-driven programming patterns.
3. **System Buffers in ECS**: How system buffers work and when they need to be flushed (related to `SystemBuffer` trait).
4. **Issue #14597**: The previous issue that described a similar problem and mentioned implementing `apply()` as a solution, providing additional context about this class of bugs.
5. **DeferredWorld in Bevy**: Understanding the `DeferredWorld` type and how it enables safe world access in specific ECS contexts.