+++
title = "#22941 Adding change_tick to deferred_world"
date = "2026-02-17T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = true

[taxonomies]
list_display = ["show"]

[extra]
current_language = "en"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2026-02/pr-22941-en-20260217" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2026-02/pr-22941-zh-cn-20260217" }}
labels = ["D-Trivial", "A-ECS", "C-Refinement"]
+++

# Title
Adding change_tick to deferred_world

## Basic Information
- **Title**: Adding change_tick to deferred_world
- **PR Link**: https://github.com/bevyengine/bevy/pull/22941
- **Author**: andristarr
- **Status**: MERGED
- **Labels**: D-Trivial, A-ECS, S-Ready-For-Final-Review, C-Refinement
- **Created**: 2026-02-13T11:21:01Z
- **Merged**: 2026-02-17T00:36:52Z
- **Merged By**: alice-i-cecile

## Description Translation

# Objective
Fixes #22788

## Solution

- Adding change_tick to deferred_world

## Testing

- Passes

---

## Showcase

- You can access change_tick to get `Tick` from deferred_world

## The Story of This Pull Request

This pull request addresses a specific API gap in Bevy's ECS (Entity Component System) by adding missing functionality to the `DeferredWorld` type. The issue was straightforward: users working with `DeferredWorld` needed access to the change tick for change detection purposes, but the API was incomplete.

The problem originated from a user report in issue #22788. When working with `DeferredWorld`, developers couldn't access the current change tick, which is essential for tracking when components have been modified. This limitation prevented certain patterns of change detection that were available when working directly with `World` or `UnsafeWorldCell`.

The solution implements a simple delegation pattern. The `DeferredWorld` struct already contains a reference to the underlying world as an `UnsafeWorldCell`. Since `UnsafeWorldCell` already has a `change_tick()` method, the implementation simply exposes this through `DeferredWorld`'s public API. This approach maintains consistency with the existing API design where `DeferredWorld` provides safe access to functionality available in the underlying unsafe world cell.

The implementation adds a single method to `DeferredWorld`:

```rust
/// Gets the current change tick of [`DeferredWorld`].
#[inline]
pub fn change_tick(&mut self) -> Tick {
    self.world.change_tick()
}
```

This method is marked with `#[inline]`, which is a common optimization in Bevy's ECS codebase for small, frequently called methods that should avoid function call overhead. The method signature takes `&mut self` because accessing the change tick requires mutable access to the world, consistent with how change detection works in Bevy's ECS.

The change is minimal but important because it completes the API surface. Without this method, users working with `DeferredWorld` would need to work around the limitation by converting back to the underlying world or unsafe cell, which defeats the purpose of the deferred world abstraction.

From an architectural perspective, this change demonstrates Bevy's commitment to providing consistent APIs across different world types. The `DeferredWorld` serves as a safe wrapper for deferred operations that can be batched and executed later, and having parity with other world types ensures developers can use the same patterns regardless of whether they're working in immediate or deferred contexts.

The testing approach is straightforward - the method delegates to existing tested functionality in `UnsafeWorldCell`, so no complex new tests were needed. The existing test suite continues to pass, confirming the change doesn't break existing behavior.

This PR represents a typical refinement in a mature codebase: identifying and filling small API gaps that affect developer ergonomics. While the change is technically simple, it improves the consistency and usability of the ECS system.

## Visual Representation

```mermaid
graph TD
    A[World] -->|provides| B[change_tick()]
    C[UnsafeWorldCell] -->|provides| D[change_tick()]
    E[DeferredWorld] -->|wraps| C
    E -->|now provides| F[change_tick() method]
    F -->|delegates to| D
```

## Key Files Changed

### `crates/bevy_ecs/src/world/deferred_world.rs`

This file contains the `DeferredWorld` struct and its implementation. The change adds a single method to expose the change tick functionality that was already available in the underlying `UnsafeWorldCell`.

**Key modifications:**

1. Added import for `Tick` type from the `change_detection` module
2. Added the `change_tick()` method to `DeferredWorld`'s implementation

```rust
// File: crates/bevy_ecs/src/world/deferred_world.rs
// Before (relevant excerpt):
use crate::{
    archetype::Archetype,
    change_detection::{MaybeLocation, MutUntyped},
    // ... other imports
};

// In the impl<'w> DeferredWorld<'w> block:
// No change_tick method existed

// After:
use crate::{
    archetype::Archetype,
    change_detection::{MaybeLocation, MutUntyped, Tick}, // Added Tick import
    // ... other imports
};

// In the impl<'w> DeferredWorld<'w> block, at the end:
/// Gets the current change tick of [`DeferredWorld`].
#[inline]
pub fn change_tick(&mut self) -> Tick {
    self.world.change_tick()
}
```

The change is minimal but important for API completeness. The method provides the same functionality as `World::change_tick()` and `UnsafeWorldCell::change_tick()`, maintaining consistency across the different world access patterns in Bevy's ECS.

## Further Reading

1. **Bevy ECS Change Detection Documentation**: Understanding how change ticks work in Bevy's ECS system
2. **Rust Inline Attribute**: Documentation on when and why to use `#[inline]` for performance optimization
3. **Entity Component System Patterns**: General patterns for ECS architectures and how deferred operations fit into game engine design
4. **Bevy's UnsafeWorldCell Documentation**: Understanding the safety guarantees and patterns for unsafe world access in Bevy

# Full Code Diff
diff --git a/crates/bevy_ecs/src/world/deferred_world.rs b/crates/bevy_ecs/src/world/deferred_world.rs
index e6fd07d0fad93..54ab26e6057d6 100644
--- a/crates/bevy_ecs/src/world/deferred_world.rs
+++ b/crates/bevy_ecs/src/world/deferred_world.rs
@@ -4,7 +4,7 @@ use bevy_utils::prelude::DebugName;
 
 use crate::{
     archetype::Archetype,
-    change_detection::{MaybeLocation, MutUntyped},
+    change_detection::{MaybeLocation, MutUntyped, Tick},
     component::{ComponentId, Mutable},
     entity::Entity,
     event::{EntityComponentsTrigger, Event, EventKey, Trigger},
@@ -823,4 +823,10 @@ impl<'w> DeferredWorld<'w> {
     pub fn as_unsafe_world_cell(&mut self) -> UnsafeWorldCell<'_> {
         self.world
     }
+
+    /// Gets the current change tick of [`DeferredWorld`].
+    #[inline]
+    pub fn change_tick(&mut self) -> Tick {
+        self.world.change_tick()
+    }
 }