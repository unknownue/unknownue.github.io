+++
title = "#22673 Adds tests for new `UiDebugOverlay` features into `testbed_ui`"
date = "2026-02-02T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = false

[extra]
current_language = "zh-cn"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2026-02/pr-22673-en-20260202" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2026-02/pr-22673-zh-cn-20260202" }}
labels = ["A-UI", "C-Testing", "D-Straightforward", "M-Deliberate-Rendering-Change"]
+++

# Title

## Basic Information
- **Title**: Adds tests for new `UiDebugOverlay` features into `testbed_ui`
- **PR Link**: https://github.com/bevyengine/bevy/pull/22673
- **Author**: kfc35
- **Status**: MERGED
- **Labels**: A-UI, S-Ready-For-Final-Review, C-Testing, D-Straightforward, M-Deliberate-Rendering-Change
- **Created**: 2026-01-23T21:28:52Z
- **Merged**: 2026-02-02T23:30:23Z
- **Merged By**: alice-i-cecile

## Description Translation
**目标 (Objective)**
- 将一些最近扩展的 UI 调试功能添加到测试平台 #21931

**解决方案 (Solution)**
在 `testbed/ui.rs` 中，添加第二行实体，用于演示：
1. 带有圆角的边框 (border)、内边距 (padding)、内容框 (content box) 轮廓
2. 垂直滚动条 (vertical scrollbar) 轮廓
3. 水平滚动条 (horizontal scrollbar) 轮廓
4. 双向滚动条 (bidirectional scrollbar) 轮廓

滚动条代码取自 `scroll.rs`，并尝试将其精简到能显示轮廓所需的最少代码（因此这些滚动条无法实际滚动）。

**测试 (Testing)**
运行 `cargo run --example testbed_ui --features="bevy_ui_debug” -- debugoutlines` 即可。

**展示 (Showcase)**
如果此截图/这些新测试用例暴露出任何非预期的 bug（例如：为什么左下角的内边距框的角也是圆角的，而只有右下角的边框半径被指定了？或者为什么双向滚动条会与文本重叠？），请创建 issue / 让我知道，以便我能创建 issue。

<details>
  <summary>截图 (Screenshot)</summary>

<img width="1282" height="747" alt="Screenshot 2026-01-23 at 6 50 18 PM" src="https://github.com/user-attachments/assets/a52fcec8-834c-46e9-b7a0-61c3e30cf730" />

</details>

## The Story of This Pull Request

在 PR #21931 中，Bevy 的 UI 调试覆盖层（`UiDebugOverlay`）增加了新的可视化功能，用于帮助开发者理解 UI 布局。具体来说，它增加了绘制边框框 (border box)、内边距框 (padding box)、内容框 (content box) 以及滚动条轮廓 (scrollbar outlines) 的能力。这对于调试复杂的 UI 布局、检查尺寸计算和视觉重叠问题非常有用。

然而，`testbed_ui` 示例程序，作为 UI 功能的集成测试和展示平台，并没有更新以包含这些新特性的演示用例。这带来两个问题：第一，开发者没有一个直观的地方来快速验证这些调试功能是否正常工作；第二，这些新功能本身缺乏一个可见的“冒烟测试”（smoke test），即一个能简单运行并展示其基本效果的集成点。

因此，这个 PR 的目标很明确：扩展 `testbed_ui` 示例中的 `debug_outlines` 场景，使其包含对新 `UiDebugOverlay` 功能的测试和展示。

开发者采取了一个直接且有效的解决方案。他们没有修改核心功能代码，而是在现有的测试框架内添加新的测试实体。他们修改了 `examples/testbed/ui.rs` 文件中 `debug_outlines` 模块的 `setup` 函数。

原本的场景只包含一行（高度为100%）的简单测试节点。为了容纳新的测试用例，他们首先将原来那行节点的高度从 `percent(100)` 改为 `percent(50)`。然后，他们在同一父节点下创建了第二个节点，这个新节点也占据 `percent(50)` 的高度，并设置 `top: percent(50)`，使其紧挨在第一个节点下方，从而将屏幕垂直分成两半，上部分展示原有功能，下部分展示新增功能。

新的测试用例被组织在这第二行中，使用 `SpaceAround` 对齐方式水平排列。具体添加了四个演示实体：

1.  **复杂边框/内边距演示**：创建一个具有不对称边框（`UiRect { top: px(10), bottom: px(20), left: px(30), right: px(40) }`）和内边距，且仅右下角有圆角（`BorderRadius::bottom_right(px(10))`）的节点。关键的是，为其设置了 `UiDebugOptions`，启用了 `outline_border_box`、`outline_padding_box` 和 `outline_content_box`，并将 `ignore_border_radius` 设为 `false`。这个用例旨在测试调试轮廓能否正确反映复杂的边框半径设置。

2.  **垂直滚动条轮廓**：创建一个固定高度、设置 `overflow: Overflow::scroll_y()` 和 `scrollbar_width` 的节点。为了模拟滚动内容，它使用 `Children::spawn(SpawnIter(...))` 动态生成了20个子文本项。一个重要的细节是它添加了 `ScrollPosition(Vec2::new(180., 180.))` 组件，这会将滚动位置预设在一个偏移量上，使得滚动条拇指（thumb）不会位于初始位置，从而可以更清楚地观察滚动条轮廓的绘制。其 `UiDebugOptions` 启用了 `outline_scrollbars`。

3.  **水平滚动条轮廓**：原理与垂直滚动条类似，但 `flex_direction` 设为 `Row`，`overflow` 设为 `scroll_x()`。这个用例没有预设 `ScrollPosition`，因此滚动条拇指会默认在起始位置。

4.  **双向滚动条轮廓**：这是最复杂的用例。节点同时启用垂直和水平滚动（`Overflow::scroll()`）。其内容是一个6x6的文本网格，通过嵌套的 `Children::spawn` 和 `SpawnIter` 生成。它也预设了 `ScrollPosition(Vec2::new(300., 0.))`，使水平滚动条拇指产生偏移，方便观察。

在实现中，开发者特意指出，这些滚动条是“非功能性”的（non-functional）。这意味着他们只复制了能触发滚动条轮廓渲染所必需的 UI 结构（节点、溢出设置、子项），但剥离了所有实际的交互逻辑（如处理输入事件来更新 `ScrollPosition`）。这完全符合测试场景的定位——我们只需要视觉验证，而不需要交互功能。

代码中一个值得注意的实践是，对于所有作为“内容”的子文本节点，都显式地将 `UiDebugOptions::enabled` 设为 `false`。这确保了调试轮廓只绘制在作为测试目标的父容器上，避免了子项不必要的轮廓线对视觉效果造成干扰，保持了测试的清晰性。

从工程角度看，这个 PR 是一个典型的“测试先行”或至少是“测试同步”的良好实践。当核心功能（`UiDebugOverlay`）扩展后，及时更新相关的集成测试示例，这为功能提供了即时验证，并作为面向其他开发者的使用文档。通过将测试用例集中在一个可运行的示例中，它极大地降低了未来开发者调试和贡献 UI 调试相关代码的门槛。

作者在 PR 描述中主动邀请审查者注意可能由新测试暴露出的视觉 Bug（例如圆角应用的错误、滚动条与内容的重叠），这体现了积极的协作态度和对测试价值的深刻理解——测试不仅用于验证正确性，也用于发现问题。

最终，这个简洁、专注的 PR 成功地丰富了 `testbed_ui` 的调试场景，为 Bevy UI 的调试工具链增加了一个实用的可视化验证环节。

## Visual Representation

这个 PR 主要修改了 `testbed_ui` 示例程序中一个特定场景的结构。下图展示了修改前后 `debug_outlines` 场景的 UI 节点层次结构变化：

```mermaid
graph TD
    subgraph “修改前：单行布局”
        A1[Root Node] --> B1[演示行 Row 1 height:100%]
        B1 --> C1[原有测试节点 1]
        B1 --> C2[原有测试节点 2]
        B1 --> C3[...]
    end

    subgraph “修改后：双行布局”
        A2[Root Node] --> B2[演示行 Row 1 height:50%]
        A2 --> B3[新增演示行 Row 2 height:50%, top:50%]

        B2 --> C4[原有测试节点 1]
        B2 --> C5[原有测试节点 2]
        B2 --> C6[...]

        B3 --> D1[复杂边框/内边距节点]
        B3 --> D2[垂直滚动条节点]
        B3 --> D3[水平滚动条节点]
        B3 --> D4[双向滚动条节点]
    end
```

## Key Files Changed

**`examples/testbed/ui.rs` (+165/-1)**
这是此 PR 修改的唯一文件。修改位于 `debug_outlines` 模块的 `setup` 函数中，目的是扩展该调试场景以包含对新 `UiDebugOverlay` 特性的测试。

1.  **修改目的**：将原来的全屏单行测试布局改为半屏，并在下方新增一行，用于放置四个新的 UI 调试功能测试用例。
2.  **关键修改代码**：
    ```rust
    // 修改点1：将第一行的高度从 100% 改为 50%
    // File: examples/testbed/ui.rs (在原有代码中)
    // Before:
    Node {
        width: percent(100),
        height: percent(100), // 修改前
        align_items: AlignItems::Center,
        justify_content: JustifyContent::SpaceAround,
        ..default()
    },

    // After:
    Node {
        width: percent(100),
        height: percent(50), // 修改后
        align_items: AlignItems::Center,
        justify_content: JustifyContent::SpaceAround,
        ..default()
    },

    // 修改点2：新增第二行节点和其所有子测试用例（代码较长，以下为结构示意）
    commands
        .spawn((
            Node {
                width: percent(100),
                height: percent(50),
                top: percent(50), // 关键：定位在50%顶部，即下半屏
                align_items: AlignItems::Center,
                justify_content: JustifyContent::SpaceAround,
                ..default()
            },
            DespawnOnExit(super::Scene::DebugOutlines),
        ))
        .with_children(|parent| {
            // 1. 复杂边框/内边距/内容框轮廓测试
            parent.spawn(( ... ));

            // 2. 垂直滚动条轮廓测试
            parent.spawn(( ... ));

            // 3. 水平滚动条轮廓测试
            parent.spawn(( ... ));

            // 4. 双向滚动条轮廓测试
            parent.spawn(( ... ));
        });
    ```
3.  **与PR目标的关系**：这些新增的节点分别配置了特定的 `UiDebugOptions`（如 `outline_border_box`, `outline_scrollbars` 等），直接对应了 PR #21931 中引入的新调试可视化功能。通过运行示例，开发者可以立即看到这些功能的渲染效果。

## Further Reading
1.  **PR #21931**: 此 PR 所测试的新功能的原始实现。阅读它可以了解 `UiDebugOverlay` 新增轮廓绘制功能的技术细节。
2.  **Bevy UI 文档**: 官方文档中关于 UI 组件（`Node`, `BorderRadius`, `Overflow`）和样式系统的部分。
3.  **Entity Component System (ECS) 模式**: 理解 Bevy 如何使用 `Commands`、`spawn`、`with_children` 以及组件（如 `UiDebugOptions`）来构建和配置 UI 实体。
4.  **测试驱动开发 (TDD) 与可视化测试**: 了解如何为图形用户界面创建有效的测试策略，包括像本例中的集成/展示型测试。