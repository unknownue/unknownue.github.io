+++
title = "#22952 Add PrepareResourcesBatchPhases RenderSystem set"
date = "2026-02-17T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = true

[taxonomies]
list_display = ["show"]

[extra]
current_language = "en"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2026-02/pr-22952-en-20260217" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2026-02/pr-22952-zh-cn-20260217" }}
labels = ["A-Rendering", "C-Code-Quality"]
+++

# Title

## Basic Information
- **Title**: Add PrepareResourcesBatchPhases RenderSystem set
- **PR Link**: https://github.com/bevyengine/bevy/pull/22952
- **Author**: atlv24
- **Status**: MERGED
- **Labels**: A-Rendering, C-Code-Quality, S-Ready-For-Final-Review
- **Created**: 2026-02-14T07:50:21Z
- **Merged**: 2026-02-17T01:26:14Z
- **Merged By**: alice-i-cecile

## Description Translation

# Objective

- reduce RenderApp ambiguities

## Solution

- give batch phases their own system set to order them after skin mesh preparation (which lives in PrepareResources, and matches the GetBatchData param query)
- also make atmosphere ordering a bit more specific

## Testing

- ran some examples. atmosphere looks good

## The Story of This Pull Request

The pull request addresses a specific ordering issue in Bevy's renderer related to system execution ambiguity. In Bevy's ECS architecture, systems can run in parallel unless explicitly ordered, and the render graph uses system sets to enforce execution order for critical rendering operations.

The core problem was that systems responsible for batch preparation were running in the same system set (`PrepareResources`) as skin mesh preparation systems. This created a potential ambiguity because both types of systems needed to access and modify similar resources, but batch preparation depends on skin mesh preparation completing first. Without explicit ordering, the systems could execute in any order, potentially causing incorrect batching results or runtime errors.

The solution introduces a new system set called `PrepareResourcesBatchPhases` that sits between `PrepareResources` and `PrepareResourcesCollectPhaseBuffers` in the execution order. This creates a clear pipeline:
1. First, standard resource preparation happens in `PrepareResources`
2. Then, batch phase preparation happens in the new `PrepareResourcesBatchPhases`
3. Finally, phase buffer collection happens in `PrepareResourcesCollectPhaseBuffers`

The implementation required three key changes. First, in `bevy_render/src/lib.rs`, the new system set was added to the `RenderSystems` enum with proper documentation explaining its purpose. The schedule configuration was updated to place this set in the correct position in the execution chain.

```rust
// Before:
pub enum RenderSystems {
    Prepare,
    PrepareResources,
    PrepareResourcesCollectPhaseBuffers,
    // ...
}

// After:
pub enum RenderSystems {
    Prepare,
    PrepareResources,
    PrepareResourcesBatchPhases,  // New
    PrepareResourcesCollectPhaseBuffers,  // Now explicitly runs after batch phases
    // ...
}
```

Second, in `bevy_render/src/render_phase/mod.rs`, two batch preparation systems were moved from `PrepareResources` to the new `PrepareResourcesBatchPhases` set. This ensures they run after skin mesh preparation but before buffer collection.

Third, the PR also fixes an ordering issue in the atmosphere system. The `prepare_atmosphere_uniforms` system was moved from running before `PrepareResources` to running in the `Prepare` set before `PrepareResources`. This makes the ordering more specific and logical within the render pipeline structure.

```rust
// Before:
prepare_atmosphere_uniforms
    .before(RenderSystems::PrepareResources)
    .after(RenderSystems::PrepareAssets),

// After:
prepare_atmosphere_uniforms
    .in_set(RenderSystems::Prepare)
    .before(RenderSystems::PrepareResources),
```

The technical insight here is that Bevy's renderer uses a carefully orchestrated sequence of system sets to ensure data dependencies are respected. Skin mesh preparation (which lives in `PrepareResources`) generates data that batch preparation systems need, so batch preparation must happen after it. By creating a dedicated system set for batch phases, the render graph now has explicit, unambiguous ordering for these critical operations.

The impact is improved system execution determinism and reduced risk of hard-to-debug rendering artifacts caused by system execution order ambiguities. The changes are minimal and focused, affecting only the scheduling logic without modifying the actual implementation of the systems themselves. This follows good engineering practice of solving ordering problems at the scheduling level rather than adding complex synchronization logic within systems.

## Visual Representation

```mermaid
graph TD
    A[Prepare] --> B[PrepareResources]
    B --> C[PrepareResourcesBatchPhases<br/>(New)]
    C --> D[PrepareResourcesCollectPhaseBuffers]
    D --> E[PrepareResourcesFlush]
    E --> F[PrepareBindGroups]
    
    G[prepare_atmosphere_uniforms] --> B
    subgraph "Atmosphere Systems"
        G
    end
    
    H[prepare_phase_for::<Opaque3d>] --> C
    I[prepare_phase_for::<AlphaMask3d>] --> C
    subgraph "Batch Preparation Systems"
        H
        I
    end
```

## Key Files Changed

### `crates/bevy_render/src/lib.rs` (+5/-2)

This file defines the `RenderSystems` enum and configures the render schedule. The changes add a new system set and update documentation.

**Key modifications:**
```rust
// Added new system set:
/// A sub-set within [`Prepare`](RenderSystems::Prepare) that creates batches for render phases.
PrepareResourcesBatchPhases,

// Updated documentation for existing system set:
/// A sub-set within [`Prepare`](RenderSystems::Prepare) to collect phase buffers after
/// [`PrepareResourcesBatchPhases`](RenderSystems::PrepareResourcesBatchPhases) has run.
PrepareResourcesCollectPhaseBuffers,
```

### `crates/bevy_render/src/render_phase/mod.rs` (+2/-2)

This file contains the batch preparation systems that were moved to the new system set.

**Key modifications:**
```rust
// Two systems changed from PrepareResources to PrepareResourcesBatchPhases:

// System 1 (line 1156):
-    .in_set(RenderSystems::PrepareResources),
+    .in_set(RenderSystems::PrepareResourcesBatchPhases),

// System 2 (line 1261):
-    .in_set(RenderSystems::PrepareResources),
+    .in_set(RenderSystems::PrepareResourcesBatchPhases),
```

### `crates/bevy_pbr/src/atmosphere/mod.rs` (+2/-2)

This file contains atmosphere rendering systems. One system's ordering was made more specific.

**Key modifications:**
```rust
// Changed ordering constraints:
-    prepare_atmosphere_uniforms
-        .before(RenderSystems::PrepareResources)
-        .after(RenderSystems::PrepareAssets),
+    prepare_atmosphere_uniforms
+        .in_set(RenderSystems::Prepare)
+        .before(RenderSystems::PrepareResources),
```

## Further Reading

- [Bevy System Sets Documentation](https://docs.rs/bevy/latest/bevy/ecs/schedule/trait.SystemSet.html)
- [Bevy Render Graph Architecture](https://bevyengine.org/learn/quick-start/rendering/)
- [ECS System Ordering Patterns](https://github.com/bevyengine/bevy/blob/main/docs/plugins_guidelines.md#system-ordering)
- [Bevy Render Phases and Batching](https://github.com/bevyengine/bevy/blob/main/crates/bevy_render/src/render_phase/mod.rs)