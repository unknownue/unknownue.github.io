+++
title = "#22911 `clear_all()` clears all (non-send data)"
date = "2026-02-17T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = false

[extra]
current_language = "zh-cn"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2026-02/pr-22911-en-20260217" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2026-02/pr-22911-zh-cn-20260217" }}
labels = ["D-Trivial", "A-ECS", "M-Migration-Guide"]
+++

# Title

## Basic Information
- **Title**: `clear_all()` clears all (non-send data)
- **PR Link**: https://github.com/bevyengine/bevy/pull/22911
- **Author**: Trashtalk217
- **Status**: MERGED
- **Labels**: D-Trivial, A-ECS, S-Ready-For-Final-Review, M-Migration-Guide
- **Created**: 2026-02-11T15:47:11Z
- **Merged**: 2026-02-17T00:17:53Z
- **Merged By**: alice-i-cecile

## Description Translation
### 目标
自从 #20934 之后，`World::clear_all` 和 `World::clear_all_entities` 的行为变得一致了。`World::clear_all` 过去用于清除所有资源（resources）和实体，但由于资源现在也是组件（components）了，`World::clear_all_entities` 也完成了这个工作。

### 解决方案
由于 `World::clear_all_non_send()` 没有被包含在 `World::clear_all` 中，我决定将其包含进来。

## The Story of This Pull Request

这个 PR 源于 Bevy ECS 内部一次重构后产生的一个微小的行为不一致问题。在 PR #20934 中，Bevy 将“资源”统一实现为一种特殊的“组件”。这个架构上的简化带来了很多好处，但也间接改变了某些 API 的边界和职责。

具体来说，在重构之前，`World::clear_all` 方法负责清除所有实体和资源。而 `World::clear_all_entities` 顾名思义，只清除实体。然而，当资源被实现为组件后，清除所有实体（`clear_all_entities`）的操作自然也会清除所有作为特殊实体存在的“资源”。这就导致 `clear_all` 和 `clear_all_entities` 的实际效果变得完全一致。此时，`World::clear_all` 方法名中的“all”就显得有些名不副实，因为它并没有清除另一类重要的数据：`non_send` 数据。

`non_send` 数据是 Bevy ECS 中一种特殊类型的数据，它被限制在创建它的线程上使用，通常用于封装那些非线程安全（non-Send）的外部 API 句柄，例如 OpenGL 上下文或某些原生 GUI 句柄。在 `World` 中，与常规资源和实体分开管理。因此，一个语义上表示“清除所有”的方法，理应包括这部分数据。

开发者 Trashtalk217 发现了这个不一致性。解决方法非常直接：在 `World::clear_all` 的实现中，除了调用 `clear_entities()`（现在已隐含清除资源），再追加调用 `clear_non_send()`。这样，`clear_all` 就真正履行了“清除所有”的职责，涵盖了实体、资源（作为组件的实体）以及非发送（non-send）数据。

这个改动在技术实现上很简单，只涉及几行代码。然而，它体现了良好的 API 设计原则：方法名应当准确反映其行为。修复后，`clear_all_entities`、`clear_all` 和 `clear_non_send` 三个方法的职责变得清晰且无重叠：
- `clear_all_entities`: 清除所有实体（包括作为资源存储的实体）。
- `clear_non_send`: 仅清除非发送数据。
- `clear_all`: 清除以上所有，即整个 `World` 的数据。

由于这是一个行为上的微小变化（对于原本就调用 `clear_non_send` 的用户无影响，对于只调用 `clear_all` 的用户则会多清除一项数据），它被标记为需要更新迁移指南（M-Migration-Guide）。相应的文档更新提醒用户注意 `World::clear_all` 行为的变化，避免在版本升级时因未清理的 `non_send` 数据而产生意外行为或资源泄漏。

## Visual Representation

```mermaid
graph TD
    subgraph “Before PR #22911”
        A[World::clear_all] --> B[World::clear_entities]
        B --> C[Clears Entities]
        B --> D[Clears Resources as Components]
        E[World::clear_all_entities] --> C
        F[World::clear_non_send] --> G[Clears Non-Send Data]
    end

    subgraph “After PR #22911”
        A2[World::clear_all] --> B2[World::clear_entities]
        A2 --> F2[World::clear_non_send]
        B2 --> C2[Clears Entities]
        B2 --> D2[Clears Resources as Components]
        F2 --> G2[Clears Non-Send Data]
        E2[World::clear_all_entities] --> C2
    end
```

## Key Files Changed

1.  **`crates/bevy_ecs/src/world/mod.rs` (+4/-5)**
    *   **描述**：这是核心的改动文件，更新了 `clear_all` 方法的文档注释和实现，以包含对 non-send 数据的清理。
    *   **关键修改**：
        *   **文档注释**：从之前强调 `clear_all` 与 `clear_entities` 的等同性，修改为清晰说明其清除所有实体、资源和 non-send 数据的职责。
        *   **方法实现**：在调用 `clear_entities()` 的基础上，增加了对 `clear_non_send()` 的调用。

        ```rust
        // File: crates/bevy_ecs/src/world/mod.rs
        // Before:
        /// Clears all entities and resources, invalidating all [`Entity`] and resource fetches
        /// such as [`Res`](crate::system::Res), [`ResMut`](crate::system::ResMut)
        ///
        /// Since resources are entities, this is identical to [`clear_entities`](Self::clear_entities).
        /// Non-send data is not cleared.
        pub fn clear_all(&mut self) {
            self.clear_entities();
        }

        // After:
        /// Clears all entities, resources, and non-send data.
        /// This invalidates all [`Entity`] and resource fetches such as [`Res`](crate::system::Res),
        /// [`ResMut`](crate::system::ResMut)
        pub fn clear_all(&mut self) {
            self.clear_entities();
            self.clear_non_send();
        }
        ```

2.  **`release-content/migration-guides/resources_as_components.md` (+1/-1)**
    *   **描述**：这是对应于将资源重构为组件（#20934）的迁移指南。此次 PR 在该指南中追加说明了 `World::clear_all` 行为的最新变化，确保用户从旧版本升级时能注意到这个差异。
    *   **关键修改**：
        *   在描述 `clear_entities` 行为变化的句子后，追加说明了 `clear_all` 行为的变化。

        ```markdown
        // File: release-content/migration-guides/resources_as_components.md
        // Before:
        Next, `World::clear_entities` now also clears all resources.

        // After:
        Next, `World::clear_entities` now also clears all resources, and `World::clear_all` now clears all entities, resources, and non-send data.
        ```

## Further Reading

1.  **Bevy 官方文档 - World**：了解 `World` 的核心概念以及 `clear_entities`, `clear_non_send` 等方法。
    *   [https://docs.rs/bevy_ecs/latest/bevy_ecs/world/struct.World.html](https://docs.rs/bevy_ecs/latest/bevy_ecs/world/struct.World.html)
2.  **Bevy 官方文档 - 系统参数（System Param）**：了解 `Res` 和 `ResMut` 等资源访问器是如何工作的。
    *   [https://docs.rs/bevy_ecs/latest/bevy_ecs/system/index.html](https://docs.rs/bevy_ecs/latest/bevy_ecs/system/index.html)
3.  **Rust 的 `Send` 和 `Sync` Trait**：理解线程安全以及 `non_send` 资源存在的必要性。
    *   [https://doc.rust-lang.org/std/marker/trait.Send.html](https://doc.rust-lang.org/std/marker/trait.Send.html)
    *   [https://doc.rust-lang.org/std/marker/trait.Sync.html](https://doc.rust-lang.org/std/marker/trait.Sync.html)
4.  **相关 PR #20934**：了解导致此次不一致性问题的根本性架构变更。
    *   [https://github.com/bevyengine/bevy/pull/20934](https://github.com/bevyengine/bevy/pull/20934)