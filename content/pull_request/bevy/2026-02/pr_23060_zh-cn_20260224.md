+++
title = "#23060 Add motion blur option to various stress tests"
date = "2026-02-24T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = false

[extra]
current_language = "zh-cn"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2026-02/pr-23060-en-20260224" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2026-02/pr-23060-zh-cn-20260224" }}
labels = ["A-Rendering", "C-Benchmarks", "D-Straightforward"]
+++

# Title: Add motion blur option to various stress tests

## Basic Information
- **Title**: Add motion blur option to various stress tests
- **PR Link**: https://github.com/bevyengine/bevy/pull/23060
- **Author**: greeble-dev
- **Status**: MERGED
- **Labels**: A-Rendering, S-Ready-For-Final-Review, C-Benchmarks, D-Straightforward
- **Created**: 2026-02-19T18:22:15Z
- **Merged**: 2026-02-24T19:02:50Z
- **Merged By**: alice-i-cecile

## Description Translation
### 目标
为多个压力测试添加运动模糊选项。这对于基准测试很有用，同时也有助于 bug 复现——没有太多例子使用了运动模糊。特别是，我希望用这个功能来复现一个运动模糊与变形目标(morph targets)相关的疑似 bug。

### 解决方案
为 `many_foxes`、`many_morph_targets` 和 `many_cubes` 添加一个可选的 `--motion-blur` 参数。

我对这种复制粘贴的方式不太满意。也许应该为压力测试提供一些共享的工具函数。

### 测试
在 Native/Win10/Nvidia/Vulkan 环境下进行了测试。

```sh
cargo run --example many_foxes -- --motion-blur
cargo run --example many_morph_targets -- --motion-blur
cargo run --example many_many_cubes -- --motion-blur
```

## The Story of This Pull Request

这个 PR 源于一个实际的开发和调试需求。Bevy 引擎拥有多个用于性能评估和极限测试的压力测试示例（stress tests），例如 `many_foxes`、`many_morph_targets` 和 `many_cubes`。这些示例通常用于基准测试（benchmarking）和暴露渲染管线在极端负载下的问题。然而，这些测试中缺少对运动模糊（Motion Blur）这一常见后处理效果的覆盖。

运动模糊是一个计算密集型的效果，其性能表现和在复杂场景下的行为是开发者关心的重点。更重要的是，作者 `greeble-dev` 在描述中提到，他怀疑存在一个与 **运动模糊和变形目标(morph targets)** 相关的 bug。变形目标是用于实现网格动画（如面部表情）的技术。为了有效地复现、调试和验证针对此类 bug 的修复，需要一个能够方便地启用运动模糊的高负载测试环境。现有的压力测试缺乏这个选项，因此创建了此 PR。

解决方案直接且实用：为这三个压力测试示例添加一个命令行开关 `--motion-blur`。实现上，每个示例都遵循了相同的模式。首先，扩展用于解析命令行参数的 `Args` 结构体，添加一个布尔类型的 `motion_blur` 字段，并使用 `argh` crate 的 `#[argh(switch)]` 属性将其标记为开关参数。

```rust
// many_cubes.rs 中的新增字段
/// whether to enable motion blur.
#[argh(switch)]
motion_blur: bool,
```

随后，在设置场景的 `setup` 函数中，检查这个参数。如果 `motion_blur` 为真，则在创建相机实体时，除了基本的 `Camera3d` 和 `Transform` 组件外，额外插入 `MotionBlur` 组件。这里有一个关键的技术细节：为了在测试中让运动模糊效果清晰可见，作者有意将 `shutter_angle` 设置为一个不现实的较大值（3.0 弧度），而不是默认值。这确保了即使在测试中，模糊效果也会非常明显，便于观察和验证。

```rust
// 向相机实体添加 MotionBlur 组件的通用模式
if args.motion_blur {
    camera.insert((
        MotionBlur {
            // 使用不现实的大快门角度，使运动模糊清晰可见。
            shutter_angle: 3.0,
            ..Default::default()
        },
        // MSAA 与 MotionBlur 在 WebGL 上不兼容。
        #[cfg(all(feature = "webgl2", target_arch = "wasm32", not(feature = "webgpu")))]
        Msaa::Off,
    ));
}
```

实现中还考虑到了平台兼容性问题。代码注释明确指出，在 WebGL 后端上，多重采样抗锯齿 (MSAA) 与运动模糊不兼容。因此，通过条件编译 (`#[cfg(...)]`)，在定位到 WebGL 平台时，同时将相机的 `Msaa` 设置为 `Off`。这体现了对 Bevy 不同渲染后端特性的细致处理。

这个 PR 的改动虽然简单，但非常有效。它填补了压力测试套件中的一个功能缺口，使得性能分析和特定 bug 的复现变得更加容易。作者在 PR 描述末尾也提到了一个重要的工程观察点：他对三个文件中几乎相同的代码感到“不太满意”，并指出“或许应该为压力测试提供一些共享的工具函数”。这实际上指出了项目演进中一个常见的问题——在快速迭代和添加功能时，容易产生代码重复；而随着代码库成熟，将这些重复逻辑重构为共享工具或公共模式会成为一项值得进行的技术债偿还工作。本次实现选择了最简单直接的方案，快速满足了需求，将重构的考量留给了未来。

总之，这个 PR 是一个典型的“实用主义”补丁。它没有引入复杂的架构变更，而是通过最小化的、模式一致的改动，扩展了现有测试工具的能力，直接支持了引擎开发和问题排查中的实际需求。

## Visual Representation

```mermaid
graph TD
    subgraph "用户输入"
        A[命令行参数 --motion-blur]
    end

    subgraph "示例应用 (e.g., many_cubes)"
        B[Args 结构体解析参数]
        C[setup 系统]
        D[Camera 实体]
    end

    subgraph “条件添加的组件”
        E[MotionBlur<br/>shutter_angle: 3.0]
        F[Msaa::Off<br/>仅限 WebGL 平台]
    end

    A --> B
    B -- motion_blur: bool --> C
    C -- 如果为 true --> D
    C --> E
    C --> F
    E --> D
    F --> D
```

## Key Files Changed

本 PR 修改了三个压力测试示例文件，为其添加了相同的 `--motion-blur` 命令行选项支持。

1.  **文件**: `examples/stress_tests/many_cubes.rs`
    - **修改描述**: 在 `Args` 结构体中添加 `motion_blur` 布尔开关，并在场景设置函数中根据该开关为相机添加 `MotionBlur` 组件。这是三个文件中改动量最大的一个，因为它原本的 `Args` 结构体更复杂。
    - **关键代码片段**:
        ```rust
        // 在 Args 结构体中添加：
        /// whether to enable motion blur.
        #[argh(switch)]
        motion_blur: bool,

        // 在 setup 函数中，创建相机命令后添加：
        if args.motion_blur {
            camera.insert((
                MotionBlur {
                    // Use an unrealistically large shutter angle so that motion blur is clearly visible.
                    shutter_angle: 3.0,
                    ..Default::default()
                },
                // MSAA and MotionBlur are not compatible on WebGL.
                #[cfg(all(
                    feature = "webgl2",
                    target_arch = "wasm32",
                    not(feature = "webgpu")
                ))]
                Msaa::Off,
            ));
        }
        ```

2.  **文件**: `examples/stress_tests/many_foxes.rs`
    - **修改描述**: 与 `many_cubes` 类似，添加参数和组件。区别在于它通过 `insert_resource` 将解析后的 `Args` 作为资源插入，然后在 `setup` 函数中通过 `Res<Args>` 来获取。
    - **关键代码片段**:
        ```rust
        // main 函数中：
        .insert_resource(args) // 新增

        // setup 函数签名新增参数：
        args: Res<Args>, // 新增

        // 创建相机实体和添加 MotionBlur 的逻辑与 many_cubes 相同。
        ```

3.  **文件**: `examples/stress_tests/many_morph_targets.rs`
    - **修改描述**: 修改模式与 `many_foxes` 完全相同，在 `Args` 中添加开关，在 `setup` 中为相机添加组件。
    - **关键代码片段**:
        ```rust
        // 在 Args 结构体中添加：
        /// enable motion blur
        #[argh(switch)]
        motion_blur: bool,

        // 在 setup 函数中创建相机后添加的代码块，与另外两个文件一致。
        ```

这三个文件的修改共同实现了 PR 的目标：为关键的压力测试启用可配置的运动模糊，服务于性能基准测试和特定的 bug 调查（尤其是 `many_morph_targets` 所针对的变形目标场景）。

## Further Reading

1.  **Bevy 官方文档 - 运动模糊**：深入了解 `MotionBlur` 组件的配置选项、工作原理及其在渲染管线中的位置。
2.  **图形学概念 - 运动模糊**：学习运动模糊在计算机图形学中的基本原理，包括基于速度向量(Velocity Buffer)的实现方法。
3.  **Bevy 性能测试与剖析**：了解如何利用这些压力测试示例进行引擎性能剖析和优化。
4.  **条件编译 (`#[cfg]`) 在 Rust 中的使用**：掌握如何根据目标平台、特性等条件包含或排除代码，这对于处理跨平台兼容性（如本 PR 中的 WebGL 限制）至关重要。
5.  **`argh` 命令行解析库**：学习这个轻量级库的用法，它是 Bevy 示例中常用的参数解析工具。