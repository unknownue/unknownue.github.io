+++
title = "#22926 Fix clippy issues with `bevy_platform::dirs` on Windows"
date = "2026-02-12T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = true

[taxonomies]
list_display = ["show"]

[extra]
current_language = "en"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2026-02/pr-22926-en-20260212" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2026-02/pr-22926-zh-cn-20260212" }}
labels = ["D-Trivial", "O-Windows", "C-Code-Quality", "A-Utils"]
+++

# Title

## Basic Information
- **Title**: Fix clippy issues with `bevy_platform::dirs` on Windows
- **PR Link**: https://github.com/bevyengine/bevy/pull/22926
- **Author**: greeble-dev
- **Status**: MERGED
- **Labels**: D-Trivial, O-Windows, C-Code-Quality, S-Ready-For-Final-Review, A-Utils
- **Created**: 2026-02-12T11:22:48Z
- **Merged**: 2026-02-12T18:13:14Z
- **Merged By**: mockersf

## Description Translation
Fixes clippy issues that were introduced by #22891 and only occur on Windows.

Tested on Win10 by hacking the `hello_world` example to print `preferences_dir()`.

## The Story of This Pull Request

This pull request addresses a specific issue with Clippy lint warnings that emerged after a previous change to the Bevy engine's platform abstraction layer. The problem was isolated to the Windows implementation and represented a straightforward fix that aligns with Rust best practices for unsafe code handling.

The context begins with PR #22891, which introduced changes to the `bevy_platform` crate. This crate serves as a platform abstraction layer, providing consistent APIs across different operating systems. During the development of that PR, the Windows-specific directory handling code was modified, and in doing so, it introduced two Clippy lint warnings that only manifested on Windows builds. These warnings weren't breaking the compilation - the code was functionally correct - but they represented style and safety guideline violations that the Clippy tool rightfully flagged.

The specific warnings centered around two issues. First, the code was using `#[allow(unsafe_code)]` attribute, which is a blanket allowance for unsafe code in the function. Clippy recommends using the more specific `#[expect]` attribute when possible, which not only silences the warning but also documents why the unsafe code is necessary and tracks when the warning might become unnecessary in the future. Second, the code was importing and using `std::ffi::c_void` and `std::ptr::null_mut()` from the standard library when it should have been using their `core` equivalents. This is important because `bevy_platform` is a `no_std` crate, meaning it doesn't have access to the full standard library - only the core library and alloc crate.

The developer approached this with a minimal, targeted fix. They updated the attribute from `#[allow(unsafe_code)]` to `#[expect(unsafe_code, reason = "Uses unsafe Windows API functions")]`. This change provides better documentation about why unsafe code is necessary in this context - specifically because the function calls Windows API functions that require unsafe blocks. The `expect` attribute tells Clippy that this unsafe code is expected and intentional, and includes a reason that helps other developers understand why the unsafe code exists.

The second part of the fix addressed the import issues. The code was updated to use `core::ffi::c_void` instead of `std::ffi::c_void`, and `core::ptr::null_mut()` instead of `std::ptr::null_mut()`. Additionally, `slice` was imported from `alloc::slice` instead of `std::slice`. These changes ensure compatibility with the `no_std` environment while maintaining identical functionality. The `alloc` crate provides allocation-related types and functions without the full standard library, making it appropriate for this context.

From a technical perspective, this fix demonstrates an important pattern in Rust development: properly handling the transition between `std` and `no_std` contexts. When working with platform-specific code that interacts with operating system APIs, developers must be careful about their dependencies. The Windows API bindings (`windows-sys` crate) are designed to work in `no_std` environments, so the surrounding code should also avoid `std` dependencies unless absolutely necessary.

The implementation is technically sound because:
1. `core::ffi::c_void` is identical to `std::ffi::c_void` in a `no_std` context
2. `core::ptr::null_mut()` provides the same null pointer constant as `std::ptr::null_mut()`
3. `alloc::slice::from_raw_parts` functions identically to `std::slice::from_raw_parts`
4. The `expect` attribute provides better documentation than `allow` while achieving the same suppression effect

The impact of this change is primarily about code quality and maintainability. By fixing these Clippy warnings, the codebase maintains a cleaner lint profile, which makes it easier to spot actual problems in future development. The improved documentation through the `expect` attribute helps future maintainers understand why unsafe code is necessary in this location. The proper use of `core` and `alloc` instead of `std` ensures the crate remains properly `no_std` compatible, which is essential for its role as a platform abstraction layer.

One technical lesson from this PR is the importance of testing on all target platforms after making changes to platform-specific code. The original issue only manifested on Windows, so it could have been missed if testing was only done on other platforms. The author's testing approach - modifying the `hello_world` example to print the `preferences_dir()` output - was a practical way to verify the fix worked correctly without breaking functionality.

## Visual Representation

```mermaid
graph TD
    A[PR #22891 changes] --> B[Introduces Clippy warnings on Windows]
    B --> C[Developer identifies two issues]
    C --> D[Issue 1: #[allow] attribute]
    C --> E[Issue 2: std vs core/alloc imports]
    D --> F[Fix: Change to #[expect] with reason]
    E --> G[Fix: Import from core and alloc instead of std]
    F --> H[Cleaner code with better documentation]
    G --> I[Proper no_std compatibility]
    H --> J[Fixed Clippy issues on Windows]
    I --> J
```

## Key Files Changed

### `crates/bevy_platform/src/dirs/windows.rs` (+6/-5)

This file contains the Windows-specific implementation for retrieving application directory paths. The changes fix Clippy warnings by updating unsafe code attributes and standard library imports to be compatible with the crate's `no_std` environment.

**Key modifications:**

1. **Import updates for `no_std` compatibility**:
```rust
// Before:
extern crate windows_sys as windows;
use std::ffi::{c_void, OsString};
use std::os::windows::ffi::OsStringExt;
use std::path::PathBuf;
use std::slice;

// After:
extern crate windows_sys as windows;
use alloc::slice;
use core::ffi::c_void;
use std::ffi::OsString;
use std::os::windows::ffi::OsStringExt;
use std::path::PathBuf;
```

2. **Improved unsafe code documentation**:
```rust
// Before:
#[allow(unsafe_code)]

// After:
#[expect(unsafe_code, reason = "Uses unsafe Windows API functions")]
```

3. **Core library usage instead of std**:
```rust
// Before:
let mut path_ptr: windows::core::PWSTR = std::ptr::null_mut();
let result = Shell::SHGetKnownFolderPath(&folder_id, 0, std::ptr::null_mut(), &mut path_ptr);

// After:
let mut path_ptr: windows::core::PWSTR = core::ptr::null_mut();
let result = Shell::SHGetKnownFolderPath(&folder_id, 0, core::ptr::null_mut(), &mut path_ptr);
```

The changes ensure that the Windows directory handling code properly uses `core` and `alloc` crates instead of `std`, maintaining compatibility with the `no_std` environment while fixing Clippy warnings.

## Further Reading

1. **Rust `no_std` Programming**: The Rust Embedded Working Group's book on embedded Rust provides excellent coverage of `no_std` programming patterns: https://docs.rust-embedded.org/book/intro/no-std.html

2. **Clippy Lints**: Official documentation for Rust's Clippy linter, including the difference between `allow` and `expect` attributes: https://doc.rust-lang.org/clippy/

3. **Windows API in Rust**: The `windows-sys` crate documentation for working with Windows APIs in Rust: https://docs.rs/windows-sys/latest/windows_sys/

4. **Unsafe Code Guidelines**: Rust's official unsafe code guidelines document: https://rust-lang.github.io/unsafe-code-guidelines/

5. **Bevy Platform Abstraction**: Bevy's architecture documentation on platform abstraction layers: https://bevyengine.org/learn/book/getting-started/ecs/