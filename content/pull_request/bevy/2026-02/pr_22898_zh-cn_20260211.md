+++
title = "#22898 fix error message when resmut conflict with query"
date = "2026-02-11T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = false

[extra]
current_language = "zh-cn"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2026-02/pr-22898-en-20260211" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2026-02/pr-22898-zh-cn-20260211" }}
labels = ["A-ECS", "C-Usability"]
+++

# Title

## Basic Information
- **Title**: fix error message when resmut conflict with query
- **PR Link**: https://github.com/bevyengine/bevy/pull/22898
- **Author**: mockersf
- **Status**: MERGED
- **Labels**: A-ECS, C-Usability, S-Ready-For-Final-Review
- **Created**: 2026-02-11T02:40:16Z
- **Merged**: 2026-02-11T05:03:50Z
- **Merged By**: alice-i-cecile

## Description Translation
### 目标
- 自从 #20934 之后，res/resmut 可能会与查询（queries）发生冲突
- resmut 的错误信息中提到了 res

### 解决方案
- 修复它

## The Story of This Pull Request

这个PR的故事始于一个看似微小的、但却影响开发者体验的细节：一个误导性的错误信息。在Bevy的ECS（Entity Component System）中，系统(System)通过系统参数(SystemParam)来声明其需要访问的数据。常见的参数包括用于查询组件的`Query`，以及用于访问全局资源的`Res`（不可变借用）和`ResMut`（可变借用）。

问题出现在PR #20934合并之后。该PR引入的变更为`Res`和`ResMut`与`Query`之间的冲突检测带来了新的规则或场景。当系统参数之间存在访问冲突时（例如，一个系统试图同时以可变和不可变方式访问同一资源，或者访问规则违反了Bevy的安全保证），Bevy会在运行时进行断言(assert)，并抛出一个错误信息来帮助开发者定位问题。

然而，在冲突检测的断言逻辑中，有一个bug被引入了。具体来说，在`ResMut`这个系统参数的实现中，当它检测到与已有查询发生冲突时，它打印的错误信息模板字符串是错误的。它写道：
`“error[B0002]: Res<{}> in system {} conflicts...”`

这里的`Res<{}>`是一个硬编码的字符串字面量，它错误地声称冲突来自一个`Res`（不可变资源引用），而实际上触发这个错误的是`ResMut`（可变资源引用）。对于正在调试冲突的开发者来说，这个错误信息具有直接的误导性。如果开发者看到信息中提及`Res`，他们可能会去检查代码中所有使用`Res`的地方，而完全忽略了真正的“元凶”——那个使用了`ResMut`的参数。这会不必要地延长调试时间，降低开发体验。

这个问题的根源在于错误信息字符串的编写不够通用。在实现`ResMut`的`SystemParam` trait时，开发者直接复制了`Res`实现中的断言逻辑，包括错误信息，但却忘记将信息中的类型名从`Res`更新为`ResMut`。这是一个典型的复制-粘贴错误，在需要区分相似但不同组件的场景下很容易发生。

解决方案非常直接且聚焦：修复错误信息字符串。开发者`mockersf`提交的更改只包含一行代码。他将断言宏中的格式字符串从指向`Res`改为指向`ResMut`：
`“error[B0002]: ResMut<{}> in system {} conflicts...”`

这样，当`ResMut<T>`与查询发生冲突时，错误信息将准确报告`ResMut<T>`，立即引导开发者找到正确的代码位置。这个修复虽然从代码变更量上看极小（仅修改一个单词），但其价值在于维护了框架反馈的准确性和可信度。准确的错误信息对于任何框架的用户体验都至关重要，尤其是在处理并发访问和所有权规则这些Rust和ECS中的复杂概念时。

从技术洞察来看，这个PR凸显了几个要点：
1.  **错误信息的质量是API可用性的关键部分**。一个误导性的错误信息可能比没有信息更糟。
2.  **在复制相似组件的实现时需要格外小心**，尤其是那些包含硬编码标识符（如类型名）的部分。
3.  **测试应覆盖错误路径**。理想情况下，应该有测试确保`ResMut`冲突时抛出的错误信息包含“ResMut”而不是“Res”。这属于针对错误信息的单元测试或集成测试。

这个PR被迅速合并（在2个多小时内），并且被打上了`C-Usability`（可用性）和`A-ECS`的标签，这准确地反映了它的性质：一个针对ECS核心功能的、提升开发者可用性的小修复。它不改变任何功能逻辑，只修复了元数据（错误信息）的准确性，是框架成熟度过程中一次典型的“打磨”。

## Visual Representation

```mermaid
graph TD
    subgraph “SystemParam Trait 实现”
        Res[Res<T>] --> |实现| Res_Impl
        ResMut[ResMut<T>] --> |实现| ResMut_Impl
    end

    ResMut_Impl -->|包含| Assertion[冲突检测断言]
    Assertion -->|之前打印| WrongMsg[“错误信息: Res<T>”]
    Assertion -->|PR#22898修复后打印| CorrectMsg[“正确信息: ResMut<T>”]
    
    Conflict[查询冲突] -->|触发| Assertion
```

## Key Files Changed

**文件:** `crates/bevy_ecs/src/system/system_param.rs`

1.  **修改内容及原因**：修改了`ResMut`系统参数实现中，运行时冲突检测断言所打印的错误信息。将信息中错误的类型名`Res`更正为`ResMut`，使错误信息准确反映引发冲突的实际参数类型。
2.  **代码片段**:
    ```rust
    // 文件: crates/bevy_ecs/src/system/system_param.rs
    // 修改前（第881行附近）:
    assert!(component_access_set
        .get_conflicts_single(&filter)
        .is_empty(),
        "error[B0002]: Res<{}> in system {} conflicts with a previous query. Consider removing the duplicate access. See: https://bevy.org/learn/errors/b0002",
        DebugName::type_name::<T>(),
        system_meta.name
    );
    
    // 修改后:
    assert!(component_access_set
        .get_conflicts_single(&filter)
        .is_empty(),
        "error[B0002]: ResMut<{}> in system {} conflicts with a previous query. Consider removing the duplicate access. See: https://bevy.org/learn/errors/b0002",
        DebugName::type_name::<T>(),
        system_meta.name
    );
    // ^--- 唯一变化：将“Res<{}>”改为“ResMut<{}>”
    ```
3.  **与PR目标的关联**：这行修改直接实现了PR的目标——修复`ResMut`冲突时错误信息错误地提及`Res`的问题。

## Further Reading

1.  **Bevy 错误代码 B0002**: https://bevy.org/learn/errors/b0002 - 官方文档详细解释了资源访问冲突的原因和解决方案。
2.  **PR #20934**: 引发`Res`/`ResMut`与查询新冲突场景的原始PR。理解其变更可以提供本修复的完整背景。
3.  **Bevy ECS 系统参数(SystemParam)**: Bevy官方手册中关于`SystemParam` trait和`Res`/`ResMut`/`Query`等内置参数的解释，有助于理解这些抽象是如何工作的。