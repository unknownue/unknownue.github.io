+++
title = "#22844 remove Debug from material strings and add LoadContext to GltfExtensi…"
date = "2026-02-07T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = true

[taxonomies]
list_display = ["show"]

[extra]
current_language = "en"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2026-02/pr-22844-en-20260207" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2026-02/pr-22844-zh-cn-20260207" }}
labels = ["A-Rendering", "C-Examples", "A-glTF"]
+++

# Title
remove Debug from material strings and add LoadContext to GltfExtensi…

## Basic Information
- **Title**: remove Debug from material strings and add LoadContext to GltfExtensi…
- **PR Link**: https://github.com/bevyengine/bevy/pull/22844
- **Author**: ChristopherBiscardi
- **Status**: MERGED
- **Labels**: A-Rendering, C-Examples, S-Ready-For-Final-Review, A-glTF
- **Created**: 2026-02-07T03:19:01Z
- **Merged**: 2026-02-07T05:51:47Z
- **Merged By**: alice-i-cecile

## Description Translation

# Objective

https://github.com/bevyengine/bevy/pull/22569 included some regressions. At least some of them are due to the debug formatting in the asset names.

This results in asset names like: `"DefaultMaterial"#std`.

## Solution

Remove the debug formatting.

Additionally, enable the initialization of resources like the `StandardMaterial` built from a `GltfMaterial::default()` so that the asset loader will have access to them. Materials like this default material that don't exist will not call the `on_material` hook, and thus not be initialized to be referenced later.

## Testing

multi_asset_sync and hot_reloading are fixed by this.

<img width="3776" height="2096" alt="screenshot-2026-02-06-at-19 11 31@2x" src="https://github.com/user-attachments/assets/07a31bf9-4013-4e80-a285-9b078eb28875" />
<img width="3776" height="2096" alt="screenshot-2026-02-06-at-19 16 42@2x" src="https://github.com/user-attachments/assets/5f1c1848-9469-4108-9600-5115d71d7e4c" />

but anisotropy still looks wrong, so this is a fix for one issue and there appears to be more to do.

<img width="3776" height="2096" alt="screenshot-2026-02-06-at-19 17 20@2x" src="https://github.com/user-attachments/assets/70bd1fe2-39e4-439d-a88e-e34b39aa06a8" />

## The Story of This Pull Request

This PR addresses a regression introduced in a previous change (PR #22569) that affected how glTF materials are loaded and named. The core issue was that material asset names were being formatted using debug formatting (`{:?}`), which resulted in asset names containing quotation marks. For example, a material that should be named `DefaultMaterial#std` was instead being created as `"DefaultMaterial"#std`, breaking asset lookup and synchronization.

The problem manifested in two key scenarios: the `multi_asset_sync` example and hot reloading functionality. Both were failing because the asset system couldn't find materials with the incorrectly formatted names. The developer traced this back to the debug formatting and implemented a straightforward fix by switching from `{:?}` to `{}` for string formatting.

However, during the investigation, a related issue was discovered. The glTF loader system uses extension handlers to process different aspects of glTF files. The `GltfExtensionHandlerPbr` extension, responsible for PBR materials, was only creating material assets when the `on_material` hook was called. This hook is triggered for materials explicitly defined in the glTF file. But glTF files can have meshes without explicit materials, which should use a default material. Since the default material isn't explicitly defined in the file, the `on_material` hook wasn't being called for it, leaving the default material uninitialized and unavailable.

To solve this, the developer needed to extend the extension handler system. They modified the `GltfExtensionHandler` trait to pass the `LoadContext` to the `on_root` method, allowing extension handlers to add assets during the initial loading phase. Then, in the `GltfExtensionHandlerPbr` implementation, they added an `on_root` method that creates and registers the default material asset, ensuring it's available even when not explicitly defined in the glTF file.

The implementation changes are minimal but impactful. The string formatting fix is a one-character change in three places, replacing `{:?}` with `{}`. The addition of the `on_root` method with `LoadContext` required changes to the trait definition, its implementation in the glTF loader, and the addition of the method in the PBR extension handler.

The developer also simplified the code in the `on_material` method by switching from `labeled_asset_scope` to `add_labeled_asset`. This change is more direct and avoids the unnecessary complexity of the scope-based approach.

After these changes, the `multi_asset_sync` and hot reloading examples work correctly again, as shown in the provided screenshots. However, the developer notes that anisotropy still has issues, indicating that while this PR fixes the immediate problems, there may be additional regressions from PR #22569 that need to be addressed separately.

From an architectural perspective, this PR demonstrates the importance of consistent string formatting in asset systems and highlights how extension-based loading systems need to handle both explicit and implicit resources. The change to pass `LoadContext` to `on_root` gives extension handlers more flexibility during initialization, which could be useful for other extensions that need to create default resources.

## Visual Representation

```mermaid
graph TD
    A[GltfLoader] --> B[LoadContext]
    B --> C[GltfExtensionHandler trait]
    C --> D[GltfExtensionHandlerPbr]
    D --> E[on_root with LoadContext]
    D --> F[on_material]
    D --> G[on_spawn_mesh_and_material]
    E --> H[Creates default StandardMaterial]
    F --> I[Creates StandardMaterial from GltfMaterial]
    G --> J[Assigns material to entity]
    H --> K[Asset named "DefaultMaterial#std"]
    I --> L[Asset named "{material_label}#std"]
```

## Key Files Changed

### `crates/bevy_gltf/src/loader/extensions/mod.rs`

**Change**: Added `LoadContext` parameter to the `on_root` method of the `GltfExtensionHandler` trait.

**Why**: This allows extension handlers to access the `LoadContext` during the root processing phase, enabling them to add labeled assets like the default material.

```rust
// Before:
fn on_root(&mut self, gltf: &gltf::Gltf) {}

// After:
fn on_root(&mut self, load_context: &mut LoadContext<'_>, gltf: &gltf::Gltf) {}
```

### `crates/bevy_gltf/src/loader/mod.rs`

**Change**: Updated the call to `extension.on_root` to pass the `load_context` parameter.

**Why**: This ensures that the glTF loader provides the necessary `LoadContext` to extension handlers when calling their `on_root` method.

```rust
// Before:
for extension in extensions.iter_mut() {
    extension.on_root(&gltf);
}

// After:
for extension in extensions.iter_mut() {
    extension.on_root(load_context, &gltf);
}
```

### `crates/bevy_pbr/src/lib.rs`

**Change**: 
1. Fixed string formatting by replacing `{:?}` with `{}` in material label creation
2. Added `on_root` method to create the default material
3. Simplified asset creation by using `add_labeled_asset` instead of `labeled_asset_scope`

**Why**: These changes fix the asset naming issue and ensure the default material is always available, even when not explicitly defined in glTF files.

```rust
// Before (on_material method):
let std_label = format!("{:?}#std", material_label);

let _t = load_context.labeled_asset_scope::<_, ()>(std_label, |_load_context| {
    Ok(standard_material_from_gltf_material(material_asset))
});

// After (on_material method):
let std_label = format!("{}#std", material_label);

load_context.add_labeled_asset(
    std_label,
    standard_material_from_gltf_material(material_asset),
);

// New on_root method:
fn on_root(&mut self, load_context: &mut LoadContext<'_>, _gltf: &gltf::Gltf) {
    // create the `StandardMaterial` for the glTF `DefaultMaterial` so
    // it can be accessed when meshes don't have materials.
    let std_label = format!("{}#std", GltfAssetLabel::DefaultMaterial);

    load_context.add_labeled_asset(
        std_label,
        standard_material_from_gltf_material(&GltfMaterial::default()),
    );
}
```

## Further Reading

- [Rust Formatting Documentation](https://doc.rust-lang.org/std/fmt/index.html) - Details on the difference between `{}` (Display) and `{:?}` (Debug) formatting
- [Bevy Asset System](https://bevyengine.org/learn/quick-start/assets/) - Overview of how assets are loaded and managed in Bevy
- [glTF Specification](https://www.khronos.org/gltf/) - Official specification for the glTF file format
- [Bevy glTF Loading](https://github.com/bevyengine/bevy/tree/main/crates/bevy_gltf) - Source code for Bevy's glTF loader implementation