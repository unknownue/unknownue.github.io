+++
title = "#23088 unpin nightly in CI"
date = "2026-02-21T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = false

[extra]
current_language = "zh-cn"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2026-02/pr-23088-en-20260221" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2026-02/pr-23088-zh-cn-20260221" }}
+++

# Title

## 基本信息
- **标题**: unpin nightly in CI
- **PR链接**: https://github.com/bevyengine/bevy/pull/23088
- **作者**: mockersf
- **状态**: 已合并
- **标签**: D-Trivial, A-Build-System, S-Ready-For-Final-Review
- **创建时间**: 2026-02-20T23:56:38Z
- **合并时间**: 2026-02-21T09:48:43Z
- **合并者**: mockersf

## 描述翻译
还原 bevyengine/bevy#22927，该问题已在 nightly 版本中被修复。

## 这个PR的故事

这个PR处理的是一个在持续集成(CI)管道中管理Rust nightly工具链的常见问题。故事始于一个CI故障。Bevy项目的CI工作流使用Rust的nightly版本进行某些构建和测试任务。Nightly工具链是Rust每日构建的前沿版本，虽然能提供最新的功能和优化，但也不可避免地会引入不稳定性或回归问题（regressions）。

当CI因nightly工具链中的某个bug而开始失败时，开发团队采取的临时应对措施是提交了PR #22927。该PR没有试图修复底层问题（因为这可能存在于Rust编译器自身），而是采用了更直接的方法：将CI中使用的nightly工具链版本“固定”（pinned）到一个已知能正常工作的特定日期版本（`nightly-2026-02-11`）。这在短时间内有效地屏蔽了CI失败，确保了主分支的稳定性，为上游修复争取了时间。

现在，情况发生了变化。Rust nightly工具链中的bug已经被修复。因此，继续使用旧的、固定的nightly版本就失去了意义，反而会带来两个负面影响：
1.  项目无法受益于nightly版本中新的修复和改进。
2.  增加了维护负担，因为需要手动跟踪何时可以解除固定。

PR #23088的解决方案非常直接：撤销之前的临时措施。具体做法是将所有相关CI工作流文件中定义的`NIGHTLY_TOOLCHAIN`环境变量，从固定的日期版本改回通用的`nightly`标签。这个修改意味着CI将重新自动获取和使用最新的nightly构建。

这个修改虽然微小，但体现了良好的CI/CD实践。它展示了一个清晰的“问题-规避-修复-恢复”周期：
1.  **检测问题**：CI因外部依赖（nightly编译器）失败。
2.  **实施规避**：快速固定版本以恢复CI。
3.  **等待修复**：依赖上游（Rust项目）解决问题。
4.  **恢复原状**：确认修复后，立即移除临时规避措施。

从实现细节来看，修改涉及四个独立的GitHub Actions工作流文件：`ci.yml`、`docs.yml`、`update-caches.yml`和`validation-jobs.yml`。每个文件都包含一个用于配置nightly工具链的环境变量。这种在多个地方重复相同配置的做法，使得修复时需要同步修改多处，但也说明了项目在不同类型的CI任务（如常规测试、文档构建、缓存更新和平台验证）中保持工具链一致性的重要性。

这项更改的技术影响是立即可见的：合并后，所有后续的CI运行将自动拉取并使用最新的Rust nightly工具链。这减少了项目状态与最新Rust开发进展之间的“偏差”。从流程中学到的关键教训是，像固定工具链版本这样的临时解决方案应该附有清晰的上下文注释（正如代码中已有的注释所表明的），并且需要有一个明确的机制或责任人来跟踪和移除它们，防止其被遗忘而成为事实上的永久配置。

## 视觉表示

```mermaid
graph TD
    subgraph “GitHub Actions 工作流”
        A[ci.yml] --> T[使用 NIGHTLY_TOOLCHAIN]
        B[docs.yml] --> T
        C[update-caches.yml] --> T
        D[validation-jobs.yml] --> T
    end
    T --> E{Rust 工具链};
    E -->|之前| F[“nightly-2026-02-11 (固定)”];
    E -->|之后| G[nightly (最新)];
```

## 关键修改的文件

1.  **文件**: `.github/workflows/ci.yml`
    -   **修改描述**: 这是主要的CI工作流文件。修改将`NIGHTLY_TOOLCHAIN`环境变量从固定的日期版本恢复为通用的`nightly`标签，使CI重新使用最新的nightly工具链。
    -   **代码片段**:
        ```yaml
        # 修改前:
        # If nightly is breaking CI, modify this variable to target a specific nightly version.
        NIGHTLY_TOOLCHAIN: "nightly-2026-02-11"

        # 修改后:
        # If nightly is breaking CI, modify this variable to target a specific nightly version.
        NIGHTLY_TOOLCHAIN: nightly
        ```

2.  **文件**: `.github/workflows/docs.yml`
    -   **修改描述**: 用于构建文档的工作流。同样将工具链恢复为`nightly`，确保文档构建使用最新的Rust工具链，这可能影响rustdoc的输出或特性。
    -   **代码片段**:
        ```yaml
        # 修改前:
        NIGHTLY_TOOLCHAIN: "nightly-2026-02-11"
        # 修改后:
        NIGHTLY_TOOLCHAIN: nightly
        ```

3.  **文件**: `.github/workflows/update-caches.yml`
    -   **修改描述**: 用于更新依赖缓存的工作流。修改保证缓存基于最新的nightly工具链环境生成，提高后续CI任务的效率。
    -   **代码片段**:
        ```yaml
        # 修改前:
        NIGHTLY_TOOLCHAIN: "nightly-2026-02-11"
        # 修改后:
        NIGHTLY_TOOLCHAIN: nightly
        ```

4.  **文件**: `.github/workflows/validation-jobs.yml`
    -   **修改描述**: 包含针对特定平台（如iOS）的验证任务的工作流。确保这些平台特定的测试也使用修复后的最新nightly工具链。
    -   **代码片段**:
        ```yaml
        # 修改前:
        NIGHTLY_TOOLCHAIN: "nightly-2026-02-11"
        # 修改后:
        NIGHTLY_TOOLCHAIN: nightly
        ```

## 进一步阅读

*   Rust官方关于工具链管理的文档：[Rustup: Toolchain management](https://rust-lang.github.io/rustup/concepts/toolchains.html)
*   GitHub Actions 中环境变量的使用：[GitHub Docs: Using environment variables](https://docs.github.com/en/actions/writing-workflows/using-environment-variables)
*   关于在CI中管理不稳定的依赖项（如nightly编译器）的通用实践，可以参考持续交付（Continuous Delivery）相关的资料。