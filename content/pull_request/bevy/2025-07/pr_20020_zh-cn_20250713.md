+++
title = "#20020 Solari initial GI"
date = "2025-07-13T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = false

[extra]
current_language = "zh-cn"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-07/pr-20020-en-20250713" }, "zh-cn" = { name = "ä¸­æ–‡", url = "/pull_request/bevy/2025-07/pr-20020-zh-cn-20250713" }}
+++

# Solari initial GI

## åŸºæœ¬ä¿¡æ¯
- **æ ‡é¢˜**: Solari initial GI
- **PRé“¾æ¥**: https://github.com/bevyengine/bevy/pull/20020
- **ä½œè€…**: JMS55
- **çŠ¶æ€**: MERGED
- **æ ‡ç­¾**: C-Feature, A-Rendering, S-Ready-For-Final-Review, M-Needs-Release-Note
- **åˆ›å»ºæ—¶é—´**: 2025-07-07T20:59:24Z
- **åˆå¹¶æ—¶é—´**: 2025-07-13T17:42:51Z
- **åˆå¹¶è€…**: alice-i-cecile

## æè¿°ç¿»è¯‘
### ç›®æ ‡
- æ·»åŠ å•æ¬¡åå°„çš„RT GI

### è§£å†³æ–¹æ¡ˆ
- å®ç°äº†ä¸€ä¸ªéå¸¸åŸºç¡€çš„ReSTIR GIç‰ˆæœ¬ https://d1qx31qr3h6wln.cloudfront.net/publications/ReSTIR%20GI.pdf
- åŸºæœ¬ä¸Šæ˜¯ReSTIR DIä»£ç çš„è°ƒæ•´ï¼Œç”¨äºGI
- æ²¡æœ‰å®ç°æ›´å¤šçš„ç©ºé—´é‡‡æ ·ï¼Œä¹Ÿæ²¡æœ‰åšä»»ä½•æé«˜è´¨é‡çš„æ”¹è¿›
- å°šæœªå°è¯•ä¼˜åŒ–æ€§èƒ½ï¼ˆå®é™…ä¸Šå®ƒæ¯”DIæ›´å¿« ğŸ˜…ï¼‰
- æ²¡æœ‰èŠ±æ—¶é—´æ¸…ç†DI/GIä¹‹é—´çš„å…±äº«æŠ½è±¡

---

### å±•ç¤º
<img width="2564" height="1500" alt="image" src="https://github.com/user-attachments/assets/1ff7be1c-7d7d-4e53-8aa6-bcec1553db3f" />

## è¿™ä¸ªPull Requestçš„æ•…äº‹

### é—®é¢˜èƒŒæ™¯
Bevyçš„Solariå…‰çº¿è¿½è¸ªæ¨¡å—éœ€è¦æ·»åŠ å…¨å±€å…‰ç…§(GI)åŠŸèƒ½ã€‚ä¹‹å‰çš„å®ç°åªæ”¯æŒç›´æ¥å…‰ç…§(DI)ï¼Œç¼ºä¹å…¨å±€å…‰ç…§èƒ½åŠ›ä¼šé™åˆ¶åœºæ™¯çš„çœŸå®æ„Ÿå’Œå…‰ç…§å‡†ç¡®æ€§ã€‚ReSTIR GIç®—æ³•æ˜¯è§£å†³è¿™ä¸ªé—®é¢˜çš„åˆé€‚é€‰æ‹©ï¼Œå› ä¸ºå®ƒèƒ½é«˜æ•ˆåœ°å¤ç”¨å…‰çº¿æ ·æœ¬ï¼Œå‡å°‘å™ªå£°ã€‚

### è§£å†³æ–¹æ¡ˆé€‰æ‹©
å¼€å‘è€…é€‰æ‹©äº†ReSTIR GIç®—æ³•ä½œä¸ºåŸºç¡€å®ç°ï¼š
- å¤ç”¨ç°æœ‰çš„ReSTIR DIå®ç°æ¡†æ¶
- è°ƒæ•´é‡‡æ ·ç­–ç•¥ï¼šä»å…‰æºé‡‡æ ·æ”¹ä¸ºåŠçƒå‡åŒ€é‡‡æ ·
- æ‰©å±•Reservoiræ•°æ®ç»“æ„ä»¥å­˜å‚¨é¢å¤–çš„GIç›¸å…³ä¿¡æ¯
- æ·»åŠ æ–°çš„è®¡ç®—ç®¡çº¿å¤„ç†GIçš„æ—¶ç©ºé‡é‡‡æ ·

è¿™ç§æ–¹æ³•åˆ©ç”¨äº†ç°æœ‰DIå®ç°çš„éªŒè¯ä»£ç ï¼Œå¿«é€Ÿå®ç°äº†åŸºæœ¬åŠŸèƒ½ï¼Œä½†æš‚æ—¶ç‰ºç‰²äº†ä¼˜åŒ–å’Œä»£ç æŠ½è±¡ã€‚

### å®ç°ç»†èŠ‚
#### æ–°å¢GIç€è‰²å™¨
åˆ›å»ºäº†`restir_gi.wgsl`æ–‡ä»¶å®ç°æ ¸å¿ƒGIé€»è¾‘ï¼š
- åˆå§‹é‡‡æ ·ï¼šä»è¡¨é¢ç‚¹å‘åŠçƒå‘å°„å…‰çº¿ï¼Œæ”¶é›†é—´æ¥å…‰ç…§
- æ—¶é—´é‡é‡‡æ ·ï¼šå¤ç”¨å‰ä¸€å¸§çš„æœ‰æ•ˆæ ·æœ¬
- ç©ºé—´é‡é‡‡æ ·ï¼šä»é‚»è¿‘åƒç´ æ”¶é›†æ ·æœ¬
- å…‰ç…§è®¡ç®—ï¼šåˆå¹¶æ ·æœ¬å¹¶è®¡ç®—æœ€ç»ˆè´¡çŒ®

```wgsl
// åˆå§‹é‡‡æ ·å‡½æ•°
fn generate_initial_reservoir(world_position: vec3<f32>, world_normal: vec3<f32>, rng: ptr<function, u32>) -> Reservoir {
    let ray_direction = sample_uniform_hemisphere(world_normal, rng);
    let ray_hit = trace_ray(world_position, ray_direction, RAY_T_MIN, RAY_T_MAX, RAY_FLAG_NONE);
    // ...è§£æå‘½ä¸­ç‚¹å¹¶è®¡ç®—å…‰ç…§è´¡çŒ®
}
```

#### æ‰©å±•æ¸²æŸ“ç®¡çº¿
åœ¨`node.rs`ä¸­ï¼š
- æ·»åŠ äº†GIä¸“ç”¨çš„è®¡ç®—ç®¡çº¿
- ä¿®æ”¹äº†ç»‘å®šç»„ä»¥åŒ…å«GIçš„å­˜å‚¨ç¼“å†²åŒº
- åœ¨æ¸²æŸ“æµç¨‹ä¸­åŠ å…¥äº†GIå¤„ç†é˜¶æ®µ

```rust
// åœ¨æ¸²æŸ“æµç¨‹ä¸­æ·»åŠ GIå¤„ç†
pass.set_pipeline(gi_initial_and_temporal_pipeline);
pass.dispatch_workgroups(viewport.x.div_ceil(8), viewport.y.div_ceil(8), 1);

pass.set_pipeline(gi_spatial_and_shade_pipeline);
pass.dispatch_workgroups(viewport.x.div_ceil(8), viewport.y.div_ceil(8), 1);
```

#### èµ„æºå‡†å¤‡
åœ¨`prepare.rs`ä¸­ï¼š
- åˆ›å»ºäº†GIä¸“ç”¨çš„å­˜å‚¨ç¼“å†²åŒº
- ä¿®æ”¹äº†èµ„æºç»“æ„ä½“ä»¥åŒºåˆ†DIå’ŒGIèµ„æº
- æ ¹æ®GIéœ€æ±‚è°ƒæ•´äº†ç¼“å†²åŒºå¤§å°

```rust
// åˆ›å»ºGIç¼“å†²åŒº
let gi_reservoirs_a = render_device.create_buffer(&BufferDescriptor {
    label: Some("solari_lighting_gi_reservoirs_a"),
    size: (view_size.x * view_size.y) as u64 * GI_RESERVOIR_STRUCT_SIZE,
    usage: BufferUsages::STORAGE,
    mapped_at_creation: false,
});
```

#### DIæ”¹è¿›
åœ¨`restir_di.wgsl`ä¸­ï¼š
- å¢åŠ äº†é‡ç½®æ ‡å¿—å¤„ç†
- æ”¹è¿›äº†æ—¶é—´é‡æŠ•å½±çš„è¾¹ç•Œæ£€æŸ¥
- æ·»åŠ äº†æ›´è¯¦ç»†çš„æ³¨é‡Šè¯´æ˜é€»è¾‘

```wgsl
// æ”¹è¿›çš„æ—¶é—´é‡æŠ•å½±æ£€æŸ¥
if any(temporal_pixel_id_float < vec2(0.0)) || 
   any(temporal_pixel_id_float >= view.viewport.zw) || 
   bool(constants.reset) {
    return empty_reservoir();
}
```

### æŠ€æœ¯æŒ‘æˆ˜
1. **æ•°æ®ç»“æ„å·®å¼‚**ï¼šGIéœ€è¦å­˜å‚¨æ›´å¤šä¿¡æ¯ï¼ˆå‘½ä¸­ç‚¹ä½ç½®ã€æ³•çº¿ç­‰ï¼‰ï¼Œå¯¼è‡´Reservoirç»“æ„ä»32å­—èŠ‚å¢åŠ åˆ°48å­—èŠ‚
2. **é‡‡æ ·ç­–ç•¥å˜åŒ–**ï¼šç”¨åŠçƒå‡åŒ€é‡‡æ ·æ›¿ä»£å…‰æºé‡‡æ ·
3. **æƒé‡è®¡ç®—**ï¼šå¼•å…¥é›…å¯æ¯”è¡Œåˆ—å¼æ ¡æ­£ç©ºé—´é‡é‡‡æ ·æƒé‡
4. **èµ„æºç®¡ç†**ï¼šéœ€è¦åˆ›å»ºå’Œç»´æŠ¤é¢å¤–çš„GPUç¼“å†²åŒº

### å½±å“ä¸æœªæ¥å·¥ä½œ
è¿™ä¸ªPRä¸ºBevyæ·»åŠ äº†åŸºç¡€çš„å®æ—¶å…¨å±€å…‰ç…§èƒ½åŠ›ï¼š
- å®ç°äº†å•æ¬¡åå°„çš„é—´æ¥å…‰ç…§
- ä¸ç°æœ‰DIå®ç°ååŒå·¥ä½œ
- æ€§èƒ½æ„å¤–åœ°ä¼˜äºDIå®ç°ï¼ˆéœ€è¦è¿›ä¸€æ­¥åˆ†æåŸå› ï¼‰

å¾…æ”¹è¿›é¢†åŸŸï¼š
- å¢åŠ æ›´å¤šç©ºé—´é‡‡æ ·æå‡è´¨é‡
- ä¼˜åŒ–æ€§èƒ½ï¼ˆç‰¹åˆ«æ˜¯å†…å­˜å¸¦å®½ä½¿ç”¨ï¼‰
- é‡æ„å…±äº«DI/GIæŠ½è±¡
- æ”¯æŒé«˜å…‰å…¨å±€å…‰ç…§

## å¯è§†åŒ–ç»„ä»¶å…³ç³»
```mermaid
graph TD
    A[SolariLightingNode] --> B[DIåˆå§‹å’Œæ—¶é—´é€šé“]
    A --> C[DIç©ºé—´å’Œç€è‰²é€šé“]
    A --> D[GIåˆå§‹å’Œæ—¶é—´é€šé“]
    A --> E[GIç©ºé—´å’Œç€è‰²é€šé“]
    B --> F[restir_di.wgsl]
    C --> F
    D --> G[restir_gi.wgsl]
    E --> G
    F --> H[sampling.wgsl]
    G --> H
```

## å…³é”®æ–‡ä»¶å˜æ›´

1. **`crates/bevy_solari/src/realtime/restir_gi.wgsl`** (æ–°å¢)
   - å®ç°ReSTIR GIçš„æ ¸å¿ƒé€»è¾‘
   - æ·»åŠ GIä¸“ç”¨çš„Reservoirç»“æ„ï¼ˆ48å­—èŠ‚ï¼‰
   - å®ç°åˆå§‹é‡‡æ ·ã€æ—¶ç©ºé‡é‡‡æ ·å’Œç€è‰²é€»è¾‘

```wgsl
// GI Reservoirç»“æ„
struct Reservoir {
    sample_point_world_position: vec3<f32>,
    weight_sum: f32,
    radiance: vec3<f32>,
    confidence_weight: f32,
    sample_point_world_normal: vec3<f32>,
    unbiased_contribution_weight: f32,
}
```

2. **`crates/bevy_solari/src/realtime/node.rs`**
   - æ·»åŠ GIè®¡ç®—ç®¡çº¿
   - æ‰©å±•ç»‘å®šç»„ä»¥åŒ…å«GIèµ„æº
   - åœ¨æ¸²æŸ“æµç¨‹ä¸­é›†æˆGIå¤„ç†

```rust
// æ·»åŠ GIç®¡çº¿
let gi_initial_and_temporal_pipeline = pipeline_cache.queue_compute_pipeline(
    ComputePipelineDescriptor {
        label: Some("solari_lighting_gi_initial_and_temporal_pipeline".into()),
        shader: load_embedded_asset!(world, "restir_gi.wgsl"),
        // ...
    });
```

3. **`crates/bevy_solari/src/realtime/prepare.rs`**
   - åˆ›å»ºGIä¸“ç”¨å­˜å‚¨ç¼“å†²åŒº
   - ä¿®æ”¹èµ„æºç»“æ„ä½“åŒºåˆ†DI/GIèµ„æº

```rust
// èµ„æºç»“æ„ä½“æ›´æ–°
pub struct SolariLightingResources {
    pub di_reservoirs_a: Buffer,
    pub di_reservoirs_b: Buffer,
    pub gi_reservoirs_a: Buffer,
    pub gi_reservoirs_b: Buffer,
    // ...
}
```

4. **`crates/bevy_solari/src/realtime/restir_di.wgsl`**
   - æ”¹è¿›æ—¶é—´é‡æŠ•å½±é€»è¾‘
   - æ·»åŠ é‡ç½®æ ‡å¿—å¤„ç†
   - å¢åŠ ä»£ç æ³¨é‡Š

```wgsl
// æ·»åŠ é‡ç½®æ£€æŸ¥
if ... || bool(constants.reset) {
    return empty_reservoir();
}
```

5. **`crates/bevy_solari/src/scene/sampling.wgsl`**
   - æ·»åŠ åŠçƒå‡åŒ€é‡‡æ ·å‡½æ•°
   - æ‰©å±•å…‰ç…§é‡‡æ ·è¿”å›ç»“æ„
   - æ·»åŠ ç‚¹å¯¹ç‚¹å¯è§æ€§æ£€æµ‹

```wgsl
// åŠçƒå‡åŒ€é‡‡æ ·
fn sample_uniform_hemisphere(normal: vec3<f32>, rng: ptr<function, u32>) -> vec3<f32> {
    let cos_theta = rand_f(rng);
    let phi = PI_2 * rand_f(rng);
    // ...
}
```

## å»¶ä¼¸é˜…è¯»
1. [ReSTIR GIåŸå§‹è®ºæ–‡](https://d1qx31qr3h6wln.cloudfront.net/publications/ReSTIR%20GI.pdf) - ç®—æ³•ç†è®ºåŸºç¡€
2. [ReSTIRè¯¾ç¨‹ç¬”è®°](https://intro-to-restir.cwyman.org/presentations/2023ReSTIR_Course_Notes.pdf) - å®ç”¨å®ç°æŒ‡å—
3. [Bevy Solariç¤ºä¾‹](https://github.com/bevyengine/bevy/tree/main/examples/3d/solari) - å®é™…ä½¿ç”¨æ¡ˆä¾‹
4. [å…¨å±€å…‰ç…§æŠ€æœ¯æ¦‚è§ˆ](https://developer.nvidia.com/rtx/global-illumination) - ä¸åŒGIæŠ€æœ¯æ¯”è¾ƒ