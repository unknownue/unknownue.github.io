+++
title = "#20782 Compute light probe matrix earlier and cache in LightProbeInfo #20738"
date = "2025-09-11T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = true

[taxonomies]
list_display = ["show"]

[extra]
current_language = "en"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-09/pr-20782-en-20250911" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-09/pr-20782-zh-cn-20250911" }}
labels = ["A-Rendering", "C-Performance"]
+++

# Title
Compute light probe matrix earlier and cache in LightProbeInfo #20782

## Basic Information
- **Title**: Compute light probe matrix earlier and cache in LightProbeInfo #20738
- **PR Link**: https://github.com/bevyengine/bevy/pull/20782
- **Author**: jz009
- **Status**: MERGED
- **Labels**: A-Rendering, C-Performance, S-Ready-For-Final-Review
- **Created**: 2025-08-28T02:54:36Z
- **Merged**: 2025-09-11T19:40:28Z
- **Merged By**: alice-i-cecile

## Description Translation
# Objective
- Closes #20738
- Avoid multiple computations of the same matrix transpose

## Solution

- Compute the transpose when LightProbeInfo is created and reference it from there

## Testing
cargo run -p ci

## The Story of This Pull Request

The PR addresses a performance optimization in Bevy's light probe system. Light probes require transformation matrices to convert between world space and light probe space. The original implementation was computing the same matrix transpose operation multiple times, which is computationally expensive.

The core issue was in the light probe gathering process. When creating `RenderLightProbe` data for the GPU, the system was repeatedly computing the transpose of the inverse transform matrix. This happened for every light probe in every frame, resulting in unnecessary computational overhead.

The solution moves this expensive matrix operation earlier in the pipeline. Instead of computing the transpose during the render preparation phase, it's now computed once when the `LightProbeInfo` is created. The transposed matrix is stored directly in the `LightProbeInfo` struct, ready for reuse during rendering.

This change demonstrates a common optimization pattern: moving expensive computations from hot loops to initialization phases. By caching the result of the matrix operation, the system avoids redundant calculations while maintaining the same functional behavior.

The implementation required changing the data type of `light_from_world` from `Affine3A` to `[Vec4; 3]` to store the precomputed transpose. This aligns with how the data is ultimately used on the GPU side, where the matrix is stored in a compressed format using only three `Vec4` components instead of four.

## Visual Representation

```mermaid
graph LR
    A[LightProbe Creation] --> B[Compute Matrix Transpose]
    B --> C[Store in LightProbeInfo]
    C --> D[Render Preparation]
    D --> E[Reuse Precomputed Matrix]
```

## Key Files Changed

**File: `crates/bevy_pbr/src/light_probe/mod.rs`**

The main change involves restructuring how the light probe transformation matrix is handled:

1. **Modified LightProbeInfo struct** - Changed `light_from_world` from `Affine3A` to `[Vec4; 3]` to store the precomputed transpose:

```rust
// Before:
light_from_world: Affine3A,

// After:
light_from_world: [Vec4; 3],
```

2. **Updated LightProbeInfo creation** - Compute the transpose during initialization:

```rust
// Before:
light_from_world: light_probe_transform.affine().inverse(),

// After:
let light_from_world_transposed =
    Mat4::from(light_probe_transform.affine().inverse()).transpose();
light_from_world: [
    light_from_world_transposed.x_axis,
    light_from_world_transposed.y_axis,
    light_from_world_transposed.z_axis,
],
```

3. **Simplified render preparation** - Reuse the precomputed matrix instead of recalculating:

```rust
// Before:
let light_from_world_transposed = Mat4::from(light_probe.light_from_world).transpose();
self.render_light_probes.push(RenderLightProbe {
    light_from_world_transposed: [
        light_from_world_transposed.x_axis,
        light_from_world_transposed.y_axis,
        light_from_world_transposed.z_axis,
    ],
    // ...
});

// After:
self.render_light_probes.push(RenderLightProbe {
    light_from_world_transposed: light_probe.light_from_world,
    // ...
});
```

## Further Reading

- [Bevy Light Probes Documentation](https://bevyengine.org/learn/books/rendering/lighting/light-probes)
- [Matrix Transpose Optimization Techniques](https://en.wikipedia.org/wiki/Transpose)
- [Computer Graphics Transformation Matrices](https://learnopengl.com/Getting-started/Transformations)