+++
title = "#21070 Add StateScoped as deprecated type alias"
date = "2025-09-15T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = false

[extra]
current_language = "zh-cn"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-09/pr-21070-en-20250915" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-09/pr-21070-zh-cn-20250915" }}
+++

# Add StateScoped as deprecated type alias

## 基本信息
- **标题**: Add StateScoped as deprecated type alias
- **PR链接**: https://github.com/bevyengine/bevy/pull/21070
- **作者**: alice-i-cecile
- **状态**: 已合并
- **标签**: D-Trivial, C-Usability, S-Ready-For-Final-Review, A-States
- **创建时间**: 2025-09-15T22:42:17Z
- **合并时间**: 2025-09-15T23:25:56Z
- **合并者**: alice-i-cecile

## 描述翻译

### 目标
- 使迁移更容易。
- 修复 #21035。

### 解决方案
- 添加一个已弃用的类型别名来帮助重命名，而不是立即重命名。
- 记得在prelude中重新导出它以减少编译器错误。

## 这个PR的故事

这个PR解决了一个典型的API演进问题：当需要重命名一个类型时，如何确保现有代码能够平稳迁移而不立即破坏兼容性。

问题的核心在于Bevy状态管理系统中的`StateScoped`类型需要被重命名为`DespawnOnExit`。如果直接重命名，所有使用`StateScoped`的现有代码都会立即编译失败，这对于用户来说是一个不友好的破坏性变更。

开发者采取了标准的Rust弃用策略来解决这个问题。他们没有立即删除或重命名原有类型，而是创建了一个类型别名，将`StateScoped`标记为已弃用，同时指向新的`DespawnOnExit`类型。这样现有代码仍然可以编译，但会收到弃用警告，鼓励用户迁移到新的名称。

这种做法的工程价值在于：
1. **向后兼容性**：现有代码不会立即中断
2. **渐进式迁移**：用户可以在自己的时间表内进行迁移
3. **清晰的沟通**：通过弃用警告和文档说明变更原因

技术实现上，关键点包括：
- 使用Rust标准的`#[deprecated]`属性提供清晰的迁移指引
- 在prelude中重新导出弃用类型，确保导入路径保持不变
- 使用`#[expect(deprecated)]`抑制prelude内部的弃用警告

这种模式在Rust生态系统中很常见，特别是在大型项目如Bevy中，它平衡了API演进和用户体验的需求。开发者不需要立即修改所有代码，而是有一个过渡期来适应新的API名称。

从工程实践角度看，这是一个简单但重要的维护性变更，展示了良好的版本管理和用户关怀意识。

## 可视化表示

```mermaid
graph LR
    A[StateScoped] --> B[DespawnOnExit]
    C[用户代码] --> A
    C -.-> B
```

## 关键文件变更

### `crates/bevy_state/src/state_scoped.rs` (+4/-0)
添加了已弃用的类型别名，指向新名称：

```rust
/// A deprecated alias for [`DespawnOnExit`].
#[deprecated(since = "0.17.0", note = "use DespawnOnExit instead")]
pub type StateScoped<S> = DespawnOnExit<S>;
```

### `crates/bevy_state/src/lib.rs` (+7/-0)
在prelude中重新导出弃用类型，确保现有导入继续工作：

```rust
#[doc(hidden)]
#[expect(
    deprecated,
    reason = "Temporarily re-exporting deprecated type for transition"
)]
pub use crate::state_scoped::StateScoped;
```

## 进一步阅读

- [Rust #[deprecated] 属性文档](https://doc.rust-lang.org/reference/attributes/diagnostics.html#the-deprecated-attribute)
- [语义化版本控制(SemVer)](https://semver.org/)
- [Bevy状态管理指南](https://bevyengine.org/learn/books/state-management/)