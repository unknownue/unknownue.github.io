+++
title = "#21067 Run release exporter in ci"
date = "2025-09-15T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = true

[taxonomies]
list_display = ["show"]

[extra]
current_language = "en"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-09/pr-21067-en-20250915" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-09/pr-21067-zh-cn-20250915" }}
labels = ["C-Feature", "A-Build-System", "D-Straightforward"]
+++

# Run release exporter in ci

## Basic Information
- **Title**: Run release exporter in ci
- **PR Link**: https://github.com/bevyengine/bevy/pull/21067
- **Author**: mockersf
- **Status**: MERGED
- **Labels**: C-Feature, A-Build-System, S-Ready-For-Final-Review, D-Straightforward
- **Created**: 2025-09-15T21:06:09Z
- **Merged**: 2025-09-15T22:26:18Z
- **Merged By**: alice-i-cecile

## Description Translation
# Objective

- Fail PRs that add a release content that fails parsing

## Solution

- Add a check mode to the exporter tool
- Run it in CI

## Testing

- Should fail on this PR before https://github.com/bevyengine/bevy/pull/21065 is merged

## The Story of This Pull Request

The core problem this PR addresses is maintaining quality control over release content in the Bevy project. When developers add new release notes or migration guides, there's a risk that malformed content could slip through without proper validation. This could break the release process or cause issues for users trying to read the documentation.

The solution implemented here takes a practical approach by leveraging existing infrastructure. The team already had an export-content tool that parsed and processed release content, but it was only run manually. The key insight was to repurpose this tool for CI validation by adding a simple check mode that validates content without running the full export process.

The implementation follows a clean separation of concerns. First, the content loading logic was extracted from the App struct into a new Content struct with a load() method. This refactoring allows the same parsing logic to be used both by the interactive TUI application and the new CI validation mode.

```rust
// File: tools/export-content/src/app.rs
// Before:
impl App {
    pub fn new() -> Result<App> {
        let exe_dir = env::current_exe()?;
        let content_dir = exe_dir.parent().unwrap().join("content");
        // ... content loading logic embedded in App constructor
    }
}

// After:
pub struct Content {
    content_dir: PathBuf,
    migration_guides: Vec<Entry>,
    release_notes: Vec<Entry>,
}

impl Content {
    pub fn load() -> Result<Self> {
        let exe_dir = env::current_exe()?;
        let content_dir = exe_dir.parent().unwrap().join("content");
        // ... content loading logic now reusable
    }
}
```

The main entry point was then modified to support a --check flag that uses this new Content::load() method:

```rust
// File: tools/export-content/src/main.rs
// Added:
let check = std::env::args().any(|arg| arg == "--check");
if check {
    Content::load().unwrap();
    return Ok(());
}
```

Finally, the CI pipeline was updated with a new job that runs this check mode:

```yaml
# File: .github/workflows/ci.yml
# Added:
check-release-content:
  runs-on: ubuntu-latest
  timeout-minutes: 30
  steps:
    - uses: actions/checkout@v5
    - uses: dtolnay/rust-toolchain@stable
    - name: Check Release Content
      shell: bash
      run: |
        cargo run --package export-content -- --check
```

This approach is effective because it reuses the existing parsing logic exactly as it would be used in production, ensuring consistency between validation and actual usage. The check is fast and lightweight, making it suitable for CI runs where execution time matters.

The impact is straightforward but significant: any PR that introduces malformed release content will now fail CI immediately, preventing broken content from entering the codebase. This creates a safety net that helps maintain documentation quality without requiring manual review of every content change.

## Visual Representation

```mermaid
graph TD
    A[CI Pipeline] --> B[check-release-content Job]
    B --> C[Run export-content tool]
    C --> D[--check flag]
    D --> E[Content::load()]
    E --> F[Parse release notes]
    E --> G[Parse migration guides]
    F --> H[Validation Result]
    G --> H
    H --> I[CI Pass/Fail]
```

## Key Files Changed

1. `tools/export-content/src/app.rs` (+26/-5)
   - Extracted content loading logic from App into new Content struct
   - Added Content::load() method for reusable content validation
   - Changed path::PathBuf to PathBuf for consistency

```rust
// Key changes in app.rs
pub struct Content {
    content_dir: PathBuf,
    migration_guides: Vec<Entry>,
    release_notes: Vec<Entry>,
}

impl Content {
    pub fn load() -> Result<Self> {
        // Content loading logic now available independently
    }
}

impl App {
    pub fn new() -> Result<App> {
        let Content { content_dir, release_notes, migration_guides } = Content::load()?;
        // Use loaded content to initialize App
    }
}
```

2. `.github/workflows/ci.yml` (+11/-0)
   - Added new CI job for release content validation
   - Job runs the export-content tool with --check flag

```yaml
check-release-content:
  runs-on: ubuntu-latest
  timeout-minutes: 30
  steps:
    - uses: actions/checkout@v5
    - uses: dtolnay/rust-toolchain@stable
    - name: Check Release Content
      shell: bash
      run: |
        cargo run --package export-content -- --check
```

3. `tools/export-content/src/main.rs` (+8/-0)
   - Added --check flag support
   - Early return when in check mode after validating content

```rust
// Added to main.rs
let check = std::env::args().any(|arg| arg == "--check");
if check {
    Content::load().unwrap();
    return Ok(());
}
```

## Further Reading

- [GitHub Actions documentation](https://docs.github.com/en/actions)
- [Rust CLI application patterns](https://rust-cli.github.io/book/)
- [CI/CD best practices for documentation validation](https://diataxis.fr/continuous-integration/)
- [Bevy's content format specification](https://github.com/bevyengine/bevy/blob/main/content/README.md)