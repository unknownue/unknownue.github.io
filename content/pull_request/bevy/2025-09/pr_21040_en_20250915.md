+++
title = "#21040 fix(bevy_ptr): correct Debug impl for MovingPtr"
date = "2025-09-15T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = true

[taxonomies]
list_display = ["show"]

[extra]
current_language = "en"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-09/pr-21040-en-20250915" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-09/pr-21040-zh-cn-20250915" }}
labels = ["C-Bug", "D-Trivial", "C-Code-Quality", "A-Pointers"]
+++

# Title
fix(bevy_ptr): correct Debug impl for MovingPtr

## Basic Information
- **Title**: fix(bevy_ptr): correct Debug impl for MovingPtr
- **PR Link**: https://github.com/bevyengine/bevy/pull/21040
- **Author**: Mysvac
- **Status**: MERGED
- **Labels**: C-Bug, D-Trivial, C-Code-Quality, S-Ready-For-Final-Review, A-Pointers
- **Created**: 2025-09-14T21:50:07Z
- **Merged**: 2025-09-15T00:38:16Z
- **Merged By**: alice-i-cecile

## Description Translation
# Objective

1. Fix incorrect macro usage in Debug implementation.
2. (unimportant) Enforce consistent formatting for unsafe blocks.

## Solution

1.  I'm not sure why `$ptr` appeared in the `Debug` implementation for `MovingPtr`, as this isn't in a macro context.  I believe it was a mistake, so I changed `stringify!($ptr)` to `"MovingPtr"`.

2. If a function has no return value (returns `()`), the final statement should end with a semicolon. (At least maintain a consistent style.) Therefore, change `unsafe { ... };` and `unsafe { ... }` to the unified `unsafe { ...; }`.

## Testing

- `cargo test -p bevy_ptr` is passed.
- Several examples have been running normally.
- No more testing is needed.

## The Story of This Pull Request

This PR addresses two straightforward but important issues in Bevy's pointer handling utilities. The primary problem was a malformed Debug implementation for the `MovingPtr` type that would have produced incorrect output during debugging sessions. The secondary issue involved minor code style inconsistencies in unsafe block formatting.

The core problem manifested in the `Debug` trait implementation for `MovingPtr`, where the code incorrectly used `stringify!($ptr)` outside of a macro context. This macro invocation would have literally output "$ptr" instead of the intended type name "MovingPtr", making debug output confusing and unhelpful for developers. The fix was simple but critical - replacing the macro call with a direct string literal containing the correct type name.

Additionally, the PR enforced consistent formatting for unsafe blocks that don't return values. The changes ensure all such blocks end with a semicolon and are properly wrapped in braces, maintaining code consistency across the codebase. While this change doesn't affect functionality, it improves code readability and maintains Bevy's coding standards.

The implementation required minimal changes but demonstrates the importance of attention to detail in low-level code, especially when dealing with unsafe operations and debugging utilities. The fixes ensure that developers working with Bevy's pointer systems will have accurate debug information and consistent code formatting.

## Visual Representation

```mermaid
graph TD
    A[Debug Implementation Issue] --> B[Incorrect stringify! macro usage]
    B --> C[Fixed with literal "MovingPtr" string]
    D[Style Inconsistency] --> E[Unsafe block formatting variations]
    E --> F[Standardized with semicolons and braces]
```

## Key Files Changed

### `crates/bevy_ptr/src/lib.rs` (+8/-4)

This file contains Bevy's pointer utilities and safe wrappers around unsafe pointer operations. The changes fix a debug output issue and improve code consistency.

**Key changes:**

1. **Fixed Debug implementation for MovingPtr:**
```rust
// Before:
write!(f, "{}<Aligned>({:?})", stringify!($ptr), self.0)

// After:
write!(f, "MovingPtr<Aligned>({:?})", self.0)
```

2. **Consistent unsafe block formatting:**
```rust
// Before:
unsafe { ptr::drop_in_place(ptr) };

// After:
unsafe {
    ptr::drop_in_place(ptr);
}
```

These changes ensure proper debug output and maintain consistent code style in unsafe blocks, which is particularly important for code that involves manual memory management.

## Further Reading

- [Rust Debug trait documentation](https://doc.rust-lang.org/std/fmt/trait.Debug.html)
- [Rust unsafe blocks](https://doc.rust-lang.org/book/ch19-01-unsafe-rust.html)
- [Bevy Pointer Utilities](https://github.com/bevyengine/bevy/blob/main/crates/bevy_ptr/src/lib.rs)

# Full Code Diff
```diff
diff --git a/crates/bevy_ptr/src/lib.rs b/crates/bevy_ptr/src/lib.rs
index 1d6e43fcf1f9b..3a69d3c94b51f 100644
--- a/crates/bevy_ptr/src/lib.rs
+++ b/crates/bevy_ptr/src/lib.rs
@@ -105,7 +105,9 @@ impl IsAligned for Aligned {
         //  - The caller is required to ensure that `ptr` points must be valid for dropping.
         //  - The caller is required to ensure that the value `ptr` points must not be used after this function
         //    call.
-        unsafe { ptr::drop_in_place(ptr) };
+        unsafe {
+            ptr::drop_in_place(ptr);
+        }
     }
 }
 
@@ -145,7 +147,9 @@ impl IsAligned for Unaligned {
         //  - The caller is required to ensure that `ptr` points must be valid for dropping.
         //  - The caller is required to ensure that the value `ptr` points must not be used after this function
         //    call.
-        unsafe { drop(ptr.read_unaligned()) }
+        unsafe {
+            drop(ptr.read_unaligned());
+        }
     }
 }
 
@@ -734,14 +738,14 @@ impl<T, A: IsAligned> Pointer for MovingPtr<'_, T, A> {
 impl<T> Debug for MovingPtr<'_, T, Aligned> {
     #[inline]
     fn fmt(&self, f: &mut Formatter<'_>) -> fmt::Result {
-        write!(f, "{}<Aligned>({:?})", stringify!($ptr), self.0)
+        write!(f, "MovingPtr<Aligned>({:?})", self.0)
     }
 }
 
 impl<T> Debug for MovingPtr<'_, T, Unaligned> {
     #[inline]
     fn fmt(&self, f: &mut Formatter<'_>) -> fmt::Result {
-        write!(f, "{}<Unaligned>({:?})", stringify!($ptr), self.0)
+        write!(f, "MovingPtr<Unaligned>({:?})", self.0)
     }
 }
 
```