+++
title = "#21202 Fix chrome rendering bug"
date = "2025-09-26T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = false

[extra]
current_language = "zh-cn"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-09/pr-21202-en-20250926" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-09/pr-21202-zh-cn-20250926" }}
labels = ["C-Bug", "P-Regression"]
+++

# Fix chrome rendering bug

## Basic Information
- **Title**: Fix chrome rendering bug
- **PR Link**: https://github.com/bevyengine/bevy/pull/21202
- **Author**: atlv24
- **Status**: MERGED
- **Labels**: C-Bug, S-Ready-For-Final-Review, P-Regression
- **Created**: 2025-09-24T23:47:25Z
- **Merged**: 2025-09-26T04:09:10Z
- **Merged By**: alice-i-cecile

## Description Translation
# Objective

- 修复 Chrome 渲染 bug：
<img width="1755" height="985" alt="image" src="https://github.com/user-attachments/assets/6293a960-b8fa-460e-9d71-e7f2a9fb2d20" />

## Solution

- 回滚 #20313 的部分更改
- 我不清楚为什么这能修复问题，但 #20960 也遇到了同样的问题

## Testing

- 

## The Story of This Pull Request

这是一个典型的回归修复案例，展示了在图形编程中，看似简单的代码重构可能带来意想不到的兼容性问题。

**问题的发现**

开发者发现 Bevy 引擎在 Chrome 浏览器中出现了渲染异常。从提供的截图可以看到，渲染结果存在明显的视觉瑕疵。这个问题被标记为回归（P-Regression），意味着它是在之前的某个更改中引入的，而不是一直存在的缺陷。

**根本原因调查**

通过分析，开发者确定问题源于 PR #20313 的更改。该 PR 原本旨在重构坐标变换函数，将这些函数从 `view_transformations.wgsl` 移动到共享模块 `bevy_render::view` 中，以实现代码复用和一致性。

然而，这种重构在 Chrome 的 WebGPU 实现中导致了兼容性问题。虽然开发者明确表示不清楚具体的技术原因，但注意到 PR #20960 也遇到了相同的问题，这表明这是一个可复现的浏览器特定问题。

**解决方案：策略性回滚**

面对这种浏览器兼容性问题，开发者采取了最直接有效的解决方案：回滚有问题的更改。具体来说，他们：

1. 移除了对 `bevy_render::view` 模块的导入
2. 恢复了所有坐标变换函数的原始实现
3. 移除了之前添加的 DEPRECATED 注释

这种回滚不是简单的整体撤销，而是有针对性的恢复。所有函数都回到了直接使用矩阵乘法进行坐标变换的实现方式，而不是通过共享模块的抽象层。

**技术实现细节**

回滚后的函数实现更加直接和自包含。例如，`position_view_to_world` 函数从：

```wgsl
fn position_view_to_world(view_pos: vec3<f32>) -> vec3<f32> {
    return view::position_view_to_world(view_pos, view_bindings::view.world_from_view);
}
```

恢复为：

```wgsl
fn position_view_to_world(view_pos: vec3<f32>) -> vec3<f32> {
    let world_pos = view_bindings::view.world_from_view * vec4(view_pos, 1.0);
    return world_pos.xyz;
}
```

这种实现虽然代码重复度更高，但避免了模块导入可能带来的兼容性问题。

**工程权衡**

这个 PR 体现了软件工程中常见的权衡：代码复用性 vs 运行兼容性。虽然共享模块的抽象在理论上是更好的设计，但在实际的跨平台/跨浏览器环境中，有时需要优先保证功能的正确性。

**经验教训**

这个案例提醒我们：
1. 图形编程中的浏览器兼容性问题可能很微妙
2. 即使逻辑上正确的重构也可能引入运行时问题
3. 回归测试和跨浏览器测试的重要性
4. 有时候需要为了兼容性牺牲一些代码优雅性

## Visual Representation

```mermaid
graph LR
    A[Chrome 渲染异常] --> B[问题定位到 PR #20313]
    B --> C[回滚坐标变换函数实现]
    C --> D[移除模块导入依赖]
    D --> E[恢复直接矩阵运算]
    E --> F[Chrome 渲染正常]
```

## Key Files Changed

### `crates/bevy_pbr/src/render/view_transformations.wgsl` (+70/-55)

这个文件包含了所有坐标空间变换的 WGSL 函数。主要更改包括：

1. **移除模块导入**
```wgsl
// 移除的行
#import bevy_render::view
```

2. **恢复函数直接实现**
```wgsl
// 之前（使用共享模块）：
fn position_view_to_world(view_pos: vec3<f32>) -> vec3<f32> {
    return view::position_view_to_world(view_pos, view_bindings::view.world_from_view);
}

// 之后（直接实现）：
fn position_view_to_world(view_pos: vec3<f32>) -> vec3<f32> {
    let world_pos = view_bindings::view.world_from_view * vec4(view_pos, 1.0);
    return world_pos.xyz;
}
```

3. **移除弃用注释**
所有 `DEPRECATED: use bevy_render::view::...` 注释都被移除，因为这些函数不再被弃用。

这些更改确保了坐标变换函数在 Chrome 的 WebGPU 实现中能够正常工作，虽然牺牲了代码的抽象层次，但解决了实际的渲染问题。

## Further Reading

- [WebGPU 规范](https://www.w3.org/TR/webgpu/) - 了解 WebGPU 的技术细节
- [Bevy 引擎文档](https://bevyengine.org/learn/) - Bevy 游戏引擎的官方文档
- [WGSL 语言规范](https://www.w3.org/TR/WGSL/) - WebGPU Shading Language 的详细说明
- [图形编程中的坐标变换](https://learnopengl.com/Getting-started/Coordinate-Systems) - 理解不同的坐标空间和变换

# Full Code Diff
```diff
diff --git a/crates/bevy_pbr/src/render/view_transformations.wgsl b/crates/bevy_pbr/src/render/view_transformations.wgsl
index 4fe44d48dbd21..dfb4d6e96d03c 100644
--- a/crates/bevy_pbr/src/render/view_transformations.wgsl
+++ b/crates/bevy_pbr/src/render/view_transformations.wgsl
@@ -2,7 +2,6 @@
 
 #import bevy_pbr::mesh_view_bindings as view_bindings
 #import bevy_pbr::prepass_bindings
-#import bevy_render::view
 
 /// World space:
 /// +y is up
@@ -36,33 +35,33 @@
 // -----------------
 
 /// Convert a view space position to world space
-/// DEPRECATED: use bevy_render::view::position_view_to_world instead
 fn position_view_to_world(view_pos: vec3<f32>) -> vec3<f32> {
-    return view::position_view_to_world(view_pos, view_bindings::view.world_from_view);
+    let world_pos = view_bindings::view.world_from_view * vec4(view_pos, 1.0);
+    return world_pos.xyz;
 }
 
 /// Convert a clip space position to world space
-/// DEPRECATED: use bevy_render::view::position_clip_to_world instead
 fn position_clip_to_world(clip_pos: vec4<f32>) -> vec3<f32> {
-    return view::position_clip_to_world(clip_pos, view_bindings::view.world_from_clip);
+    let world_pos = view_bindings::view.world_from_clip * clip_pos;
+    return world_pos.xyz;
 }
 
 /// Convert a ndc space position to world space
-/// DEPRECATED: use bevy_render::view::position_ndc_to_world instead
 fn position_ndc_to_world(ndc_pos: vec3<f32>) -> vec3<f32> {
-    return view::position_ndc_to_world(ndc_pos, view_bindings::view.world_from_clip);
+    let world_pos = view_bindings::view.world_from_clip * vec4(ndc_pos, 1.0);
+    return world_pos.xyz / world_pos.w;
 }
 
 /// Convert a view space direction to world space
-/// DEPRECATED: use bevy_render::view::direction_view_to_world instead
 fn direction_view_to_world(view_dir: vec3<f32>) -> vec3<f32> {
-    return view::direction_view_to_world(view_dir, view_bindings::view.world_from_view);
+    let world_dir = view_bindings::view.world_from_view * vec4(view_dir, 0.0);
+    return world_dir.xyz;
 }
 
 /// Convert a clip space direction to world space
-/// DEPRECATED: use bevy_render::view::direction_clip_to_world instead
 fn direction_clip_to_world(clip_dir: vec4<f32>) -> vec3<f32> {
-    return view::direction_clip_to_world(clip_dir, view_bindings::view.world_from_clip);
+    let world_dir = view_bindings::view.world_from_clip * clip_dir;
+    return world_dir.xyz;
 }
 
 // -----------------
@@ -70,47 +69,49 @@ fn direction_clip_to_world(clip_dir: vec4<f32>) -> vec3<f32> {
 // -----------------
 
 /// Convert a world space position to view space
-/// DEPRECATED: use bevy_render::view::position_world_to_view instead
 fn position_world_to_view(world_pos: vec3<f32>) -> vec3<f32> {
-    return view::position_world_to_view(world_pos, view_bindings::view.view_from_world);
+    let view_pos = view_bindings::view.view_from_world * vec4(world_pos, 1.0);
+    return view_pos.xyz;
 }
 
 /// Convert a clip space position to view space
-/// DEPRECATED: use bevy_render::view::position_clip_to_view instead
 fn position_clip_to_view(clip_pos: vec4<f32>) -> vec3<f32> {
-    return view::position_clip_to_view(clip_pos, view_bindings::view.view_from_clip);
+    let view_pos = view_bindings::view.view_from_clip * clip_pos;
+    return view_pos.xyz;
 }
 
 /// Convert a ndc space position to view space
-/// DEPRECATED: use bevy_render::view::position_ndc_to_view instead
 fn position_ndc_to_view(ndc_pos: vec3<f32>) -> vec3<f32> {
-    return view::position_ndc_to_view(ndc_pos, view_bindings::view.view_from_clip);
+    let view_pos = view_bindings::view.view_from_clip * vec4(ndc_pos, 1.0);
+    return view_pos.xyz / view_pos.w;
 }
 
 /// Convert a world space direction to view space
-/// DEPRECATED: use bevy_render::view::direction_world_to_view instead
 fn direction_world_to_view(world_dir: vec3<f32>) -> vec3<f32> {
-    return view::direction_world_to_view(world_dir, view_bindings::view.view_from_world);
+    let view_dir = view_bindings::view.view_from_world * vec4(world_dir, 0.0);
+    return view_dir.xyz;
 }
 
 /// Convert a clip space direction to view space
-/// DEPRECATED: use bevy_render::view::direction_clip_to_view instead
 fn direction_clip_to_view(clip_dir: vec4<f32>) -> vec3<f32> {
-    return view::direction_clip_to_view(clip_dir, view_bindings::view.view_from_clip);
+    let view_dir = view_bindings::view.view_from_clip * clip_dir;
+    return view_dir.xyz;
 }
 
 // -----------------
 // TO PREV. VIEW ---
 // -----------------
 
-/// DEPRECATED: use bevy_render::view::position_world_to_view instead
 fn position_world_to_prev_view(world_pos: vec3<f32>) -> vec3<f32> {
-    return view::position_world_to_view(world_pos, prepass_bindings::previous_view_uniforms.view_from_world);
+    let view_pos = prepass_bindings::previous_view_uniforms.view_from_world *
+        vec4(world_pos, 1.0);
+    return view_pos.xyz;
 }
 
-/// DEPRECATED: use bevy_render::view::position_world_to_ndc instead
 fn position_world_to_prev_ndc(world_pos: vec3<f32>) -> vec3<f32> {
-    return view::position_world_to_ndc(world_pos, prepass_bindings::previous_view_uniforms.clip_from_world);
+    let ndc_pos = prepass_bindings::previous_view_uniforms.clip_from_world *
+        vec4(world_pos, 1.0);
+    return ndc_pos.xyz / ndc_pos.w;
 }
 
 // -----------------
@@ -118,27 +119,27 @@ fn position_world_to_prev_ndc(world_pos: vec3<f32>) -> vec3<f32> {
 // -----------------
 
 /// Convert a world space position to clip space
-/// DEPRECATED: use bevy_render::view::position_world_to_clip instead
 fn position_world_to_clip(world_pos: vec3<f32>) -> vec4<f32> {
-    return view::position_world_to_clip(world_pos, view_bindings::view.clip_from_world);
+    let clip_pos = view_bindings::view.clip_from_world * vec4(world_pos, 1.0);
+    return clip_pos;
 }
 
 /// Convert a view space position to clip space
-/// DEPRECATED: use bevy_render::view::position_view_to_clip instead
 fn position_view_to_clip(view_pos: vec3<f32>) -> vec4<f32> {
-    return view::position_view_to_clip(view_pos, view_bindings::view.clip_from_view);
+    let clip_pos = view_bindings::view.clip_from_view * vec4(view_pos, 1.0);
+    return clip_pos;
 }
 
 /// Convert a world space direction to clip space
-/// DEPRECATED: use bevy_render::view::direction_world_to_clip instead
 fn direction_world_to_clip(world_dir: vec3<f32>) -> vec4<f32> {
-    return view::direction_world_to_clip(world_dir, view_bindings::view.clip_from_world);
+    let clip_dir = view_bindings::view.clip_from_world * vec4(world_dir, 0.0);
+    return clip_dir;
 }
 
 /// Convert a view space direction to clip space
-/// DEPRECATED: use bevy_render::view::direction_view_to_clip instead
 fn direction_view_to_clip(view_dir: vec3<f32>) -> vec4<f32> {
-    return view::direction_view_to_clip(view_dir, view_bindings::view.clip_from_view);
+    let clip_dir = view_bindings::view.clip_from_view * vec4(view_dir, 0.0);
+    return clip_dir;
 }
 
 // -----------------
@@ -146,15 +147,15 @@ fn direction_view_to_clip(view_dir: vec3<f32>) -> vec4<f32> {
 // -----------------
 
 /// Convert a world space position to ndc space
-/// DEPRECATED: use bevy_render::view::position_world_to_ndc instead
 fn position_world_to_ndc(world_pos: vec3<f32>) -> vec3<f32> {
-    return view::position_world_to_ndc(world_pos, view_bindings::view.clip_from_world);
+    let ndc_pos = view_bindings::view.clip_from_world * vec4(world_pos, 1.0);
+    return ndc_pos.xyz / ndc_pos.w;
 }
 
 /// Convert a view space position to ndc space
-/// DEPRECATED: use bevy_render::view::position_view_to_ndc instead
 fn position_view_to_ndc(view_pos: vec3<f32>) -> vec3<f32> {
-    return view::position_view_to_ndc(view_pos, view_bindings::view.clip_from_view);
+    let ndc_pos = view_bindings::view.clip_from_view * vec4(view_pos, 1.0);
+    return ndc_pos.xyz / ndc_pos.w;
 }
 
 // -----------------
@@ -162,28 +163,47 @@ fn position_view_to_ndc(view_pos: vec3<f32>) -> vec3<f32> {
 // -----------------
 
 /// Retrieve the perspective camera near clipping plane
-/// DEPRECATED: use bevy_render::view::perspective_camera_near instead
 fn perspective_camera_near() -> f32 {
-    return view::perspective_camera_near(view_bindings::view.clip_from_view);
+    return view_bindings::view.clip_from_view[3][2];
 }
 
 /// Convert ndc depth to linear view z. 
 /// Note: Depth values in front of the camera will be negative as -z is forward
-/// DEPRECATED: use bevy_render::view::depth_ndc_to_view_z instead
 fn depth_ndc_to_view_z(ndc_depth: f32) -> f32 {
-    return view::depth_ndc_to_view_z(ndc_depth, view_bindings::view.clip_from_view, view_bindings::view.view_from_clip);
+#ifdef VIEW_PROJECTION_PERSPECTIVE
+    return -perspective_camera_near() / ndc_depth;
+#else ifdef VIEW_PROJECTION_ORTHOGRAPHIC
+    return -(view_bindings::view.clip_from_view[3][2] - ndc_depth) / view_bindings::view.clip_from_view[2][2];
+#else
+    let view_pos = view_bindings::view.view_from_clip * vec4(0.0, 0.0, ndc_depth, 1.0);
+    return view_pos.z / view_pos.w;
+#endif
 }
 
 /// Convert linear view z to ndc depth. 
 /// Note: View z input should be negative for values in front of the camera as -z is forward
-/// DEPRECATED: use bevy_render::view::view_z_to_depth_ndc instead
 fn view_z_to_depth_ndc(view_z: f32) -> f32 {
-    return view::view_z_to_depth_ndc(view_z, view_bindings::view.clip_from_view);
+#ifdef VIEW_PROJECTION_PERSPECTIVE
+    return -perspective_camera_near() / view_z;
+#else ifdef VIEW_PROJECTION_ORTHOGRAPHIC
+    return view_bindings::view.clip_from_view[3][2] + view_z * view_bindings::view.clip_from_view[2][2];
+#else
+    let ndc_pos = view_bindings::view.clip_from_view * vec4(0.0, 0.0, view_z, 1.0);
+    return ndc_pos.z / ndc_pos.w;
+#endif
 }
 
-/// DEPRECATED: use bevy_render::view::prev_view_z_to_depth_ndc instead
 fn prev_view_z_to_depth_ndc(view_z: f32) -> f32 {
-    return view::view_z_to_depth_ndc(view_z, prepass_bindings::previous_view_uniforms.clip_from_view);
+#ifdef VIEW_PROJECTION_PERSPECTIVE
+    return -perspective_camera_near() / view_z;
+#else ifdef VIEW_PROJECTION_ORTHOGRAPHIC
+    return prepass_bindings::previous_view_uniforms.clip_from_view[3][2] +
+        view_z * prepass_bindings::previous_view_uniforms.clip_from_view[2][2];
+#else
+    let ndc_pos = prepass_bindings::previous_view_uniforms.clip_from_view *
+        vec4(0.0, 0.0, view_z, 1.0);
+    return ndc_pos.z / ndc_pos.w;
+#endif
 }
 
 // -----------------
@@ -191,33 +211,28 @@ fn prev_view_z_to_depth_ndc(view_z: f32) -> f32 {
 // -----------------
 
 /// Convert ndc space xy coordinate [-1.0 .. 1.0] to uv [0.0 .. 1.0]
-/// DEPRECATED: use bevy_render::view::ndc_to_uv instead
 fn ndc_to_uv(ndc: vec2<f32>) -> vec2<f32> {
-    return view::ndc_to_uv(ndc);
+    return ndc * vec2(0.5, -0.5) + vec2(0.5);
 }
 
 /// Convert uv [0.0 .. 1.0] coordinate to ndc space xy [-1.0 .. 1.0]
-/// DEPRECATED: use bevy_render::view::uv_to_ndc instead
 fn uv_to_ndc(uv: vec2<f32>) -> vec2<f32> {
-    return view::uv_to_ndc(uv);
+    return uv * vec2(2.0, -2.0) + vec2(-1.0, 1.0);
 }
 
 /// returns the (0.0, 0.0) .. (1.0, 1.0) position within the viewport for the current render target
 /// [0 .. render target viewport size] eg. [(0.0, 0.0) .. (1280.0, 720.0)] to [(0.0, 0.0) .. (1.0, 1.0)]
-/// DEPRECATED: use bevy_render::view::frag_coord_to_uv instead
 fn frag_coord_to_uv(frag_coord: vec2<f32>) -> vec2<f32> {
-    return view::frag_coord_to_uv(frag_coord, view_bindings::view.viewport);
+    return (frag_coord - view_bindings::view.viewport.xy) / view_bindings::view.viewport.zw;
 }
 
 /// Convert frag coord to ndc
-/// DEPRECATED: use bevy_render::view::frag_coord_to_ndc instead
 fn frag_coord_to_ndc(frag_coord: vec4<f32>) -> vec3<f32> {
-    return view::frag_coord_to_ndc(frag_coord, view_bindings::view.viewport);
+    return vec3(uv_to_ndc(frag_coord_to_uv(frag_coord.xy)), frag_coord.z);
 }
 
 /// Convert ndc space xy coordinate [-1.0 .. 1.0] to [0 .. render target
 /// viewport size]
-/// DEPRECATED: use bevy_render::view::ndc_to_frag_coord instead
 fn ndc_to_frag_coord(ndc: vec2<f32>) -> vec2<f32> {
-    return view::ndc_to_frag_coord(ndc, view_bindings::view.viewport);
+    return ndc_to_uv(ndc) * view_bindings::view.viewport.zw;
 }
```