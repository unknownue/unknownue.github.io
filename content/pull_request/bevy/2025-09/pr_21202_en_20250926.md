+++
title = "#21202 Fix chrome rendering bug"
date = "2025-09-26T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = true

[taxonomies]
list_display = ["show"]

[extra]
current_language = "en"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-09/pr-21202-en-20250926" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-09/pr-21202-zh-cn-20250926" }}
labels = ["C-Bug", "P-Regression"]
+++

# Fix chrome rendering bug

## Basic Information
- **Title**: Fix chrome rendering bug
- **PR Link**: https://github.com/bevyengine/bevy/pull/21202
- **Author**: atlv24
- **Status**: MERGED
- **Labels**: C-Bug, S-Ready-For-Final-Review, P-Regression
- **Created**: 2025-09-24T23:47:25Z
- **Merged**: 2025-09-26T04:09:10Z
- **Merged By**: alice-i-cecile

## Description Translation

# Objective

- Fix chrome rendering bug:
<img width="1755" height="985" alt="image" src="https://github.com/user-attachments/assets/6293a960-b8fa-460e-9d71-e7f2a9fb2d20" />

## Solution

- Revert part of #20313
- I don't know why this fixes it, but #20960 also ran into it

## Testing

- 

## The Story of This Pull Request

This PR addresses a Chrome-specific rendering regression that was introduced by PR #20313. The issue manifested as visual artifacts or incorrect rendering in Chrome browsers, though the exact technical cause wasn't immediately clear to the developer.

The problem appeared to be related to how Chrome's WebGL implementation processed the coordinate transformation functions that had been centralized in PR #20313. In that previous PR, various coordinate transformation utilities were moved from the `view_transformations.wgsl` file to a shared `bevy_render::view` module to promote code reuse and maintainability.

The solution implemented here takes a pragmatic approach: reverting the coordinate transformation functions back to their original inline implementations within the `view_transformations.wgsl` file. This decision was made based on empirical evidence that the centralized approach caused rendering issues in Chrome, even though the developer acknowledged they didn't fully understand the underlying cause.

The regression label indicates this was a breaking change from previously working functionality. The fact that PR #20960 encountered similar issues suggests this wasn't an isolated problem but rather a systemic compatibility issue with Chrome's shader compilation or optimization pipeline.

From an engineering perspective, this represents a trade-off between code maintainability and browser compatibility. While centralizing transformation logic is generally good practice for reducing code duplication, browser-specific rendering quirks sometimes require pragmatic solutions that prioritize functionality over architectural purity.

## Visual Representation

```mermaid
graph LR
    A[PR #20313] --> B[Centralized Transform Functions]
    B --> C[Chrome Rendering Bug]
    C --> D[PR #21202]
    D --> E[Reverted to Inline Functions]
    E --> F[Fixed Chrome Rendering]
```

## Key Files Changed

### `crates/bevy_pbr/src/render/view_transformations.wgsl` (+70/-55)

This file contains coordinate transformation functions used in the rendering pipeline. The changes revert functions from using centralized imports back to inline matrix transformations.

**Key changes:**

1. Removed the centralized import and reverted to inline matrix operations:
```wgsl
// Before:
#import bevy_render::view

fn position_view_to_world(view_pos: vec3<f32>) -> vec3<f32> {
    return view::position_view_to_world(view_pos, view_bindings::view.world_from_view);
}

// After:
fn position_view_to_world(view_pos: vec3<f32>) -> vec3<f32> {
    let world_pos = view_bindings::view.world_from_view * vec4(view_pos, 1.0);
    return world_pos.xyz;
}
```

2. Multiple transformation functions were similarly reverted, including:
   - Coordinate space conversions (world, view, clip, NDC)
   - Depth transformation functions
   - UV coordinate conversions

3. The complex depth transformation functions were reverted to their original conditional implementations:
```wgsl
// Before:
fn depth_ndc_to_view_z(ndc_depth: f32) -> f32 {
    return view::depth_ndc_to_view_z(ndc_depth, view_bindings::view.clip_from_view, view_bindings::view.view_from_clip);
}

// After:
fn depth_ndc_to_view_z(ndc_depth: f32) -> f32 {
#ifdef VIEW_PROJECTION_PERSPECTIVE
    return -perspective_camera_near() / ndc_depth;
#else ifdef VIEW_PROJECTION_ORTHOGRAPHIC
    return -(view_bindings::view.clip_from_view[3][2] - ndc_depth) / view_bindings::view.clip_from_view[2][2];
#else
    let view_pos = view_bindings::view.view_from_clip * vec4(0.0, 0.0, ndc_depth, 1.0);
    return view_pos.z / view_pos.w;
#endif
}
```

These changes restore the original transformation logic that was known to work correctly across all target platforms, including Chrome.

## Further Reading

- PR #20313 - The original PR that introduced the centralized transformation functions
- PR #20960 - Another PR that encountered similar Chrome rendering issues
- WebGL Shader Compatibility - Documentation on browser-specific shader compilation differences
- WGSL Specification - The WebGPU Shading Language specification for understanding the transformation mathematics