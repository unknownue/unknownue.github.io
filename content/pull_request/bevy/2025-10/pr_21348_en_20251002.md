+++
title = "#21348 Solari: Fix world cache update using last frame's light tiles due to incorrect pass ordering"
date = "2025-10-02T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = true

[taxonomies]
list_display = ["show"]

[extra]
current_language = "en"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-10/pr-21348-en-20251002" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-10/pr-21348-zh-cn-20251002" }}
labels = ["C-Bug", "A-Rendering", "D-Straightforward"]
+++

# Title

## Basic Information
- **Title**: Solari: Fix world cache update using last frame's light tiles due to incorrect pass ordering
- **PR Link**: https://github.com/bevyengine/bevy/pull/21348
- **Author**: JMS55
- **Status**: MERGED
- **Labels**: C-Bug, A-Rendering, S-Ready-For-Final-Review, D-Straightforward
- **Created**: 2025-10-02T15:11:39Z
- **Merged**: 2025-10-02T17:06:12Z
- **Merged By**: alice-i-cecile

## Description Translation
Light tiles used to be generated _after_ the world cache update, despite the world cache update relying on them. This means that the world cache update used last frame's light tiles, which is fine for static lights, but completely wrong for dynamic lights and lead to missing GI contributions from dynamic lights.

Moving the presample light tile step to before the world cache update fixes this.

Can be tested by running the solari example, turning off the directional light so there's only the emissive robot light, enabling VISUALIZE_WORLD_CACHE, and then comparing before/after this PR.

## The Story of This Pull Request

This PR addresses a critical ordering bug in Bevy's Solari global illumination system. The core issue was straightforward but had significant consequences for dynamic lighting scenarios.

The problem stemmed from incorrect execution ordering in the rendering pipeline. The world cache update, which depends on current frame light tile data, was being executed before the light tiles were actually generated. This created a one-frame lag where the world cache would use outdated light information from the previous frame.

For static lights, this wasn't immediately apparent because light data remains consistent between frames. However, for dynamic lights - particularly emissive materials that change position or intensity - this caused missing or incorrect global illumination contributions. The world cache would be updated based on where lights were in the previous frame, not their current positions.

The solution was a simple but crucial reordering of operations. The presample_light_tiles_pipeline dispatch was moved from after the world cache update to before it. This ensures that when the world cache processes light contributions, it uses the current frame's light tile data rather than stale data from the previous frame.

The implementation change is minimal - just seven lines of code moved from one location to another - but it fundamentally fixes the temporal coherence of dynamic lighting in the Solari system. The fix maintains all existing functionality while correcting the temporal misalignment that was causing dynamic lighting artifacts.

From an architectural perspective, this highlights the importance of proper dependency ordering in GPU compute pipelines. Even when individual operations are correct, their execution order can create subtle but significant bugs. The fix demonstrates how careful consideration of data dependencies is crucial in real-time graphics programming.

The testing approach described - using the solari example with directional lights disabled and the emissive robot light enabled, combined with the VISUALIZE_WORLD_CACHE debug visualization - provides a clear way to verify the fix. This would show immediate visual differences between the broken and fixed versions, particularly as dynamic lights move through the scene.

## Visual Representation

```mermaid
graph LR
    A[Clear Light Tiles] --> B[Presample Light Tiles]
    B --> C[World Cache Update]
    C --> D[DI Initial & Temporal]
    
    style B fill:#9f9
    style C fill:#f99
```

The diagram shows the corrected execution flow, with the critical fix highlighted: light tile sampling now properly precedes world cache updates.

## Key Files Changed

### `crates/bevy_solari/src/realtime/node.rs` (+7/-7)

This file contains the core rendering node implementation for Solari's real-time global illumination. The changes fix the execution order of compute shader dispatches.

**Key Changes:**
The presample_light_tiles_pipeline dispatch was moved from after the world cache update to before it, ensuring the world cache uses current frame light data.

```rust
// Before (incorrect order):
// World cache update operations...
pass.set_bind_group(2, &bind_group_world_cache_active_cells_dispatch, &[]);
pass.set_pipeline(decay_world_cache_pipeline);
// ... more world cache operations

// Then light tile sampling (too late!)
pass.set_pipeline(presample_light_tiles_pipeline);
pass.set_push_constants(
    0,
    bytemuck::cast_slice(&[frame_index, solari_lighting.reset as u32]),
);
pass.dispatch_workgroups(LIGHT_TILE_BLOCKS as u32, 1, 1);

// After (correct order):
// Light tile sampling first
pass.set_pipeline(presample_light_tiles_pipeline);
pass.set_push_constants(
    0,
    bytemuck::cast_slice(&[frame_index, solari_lighting.reset as u32]),
);
pass.dispatch_workgroups(LIGHT_TILE_BLOCKS as u32, 1, 1);

// Then world cache update
pass.set_bind_group(2, &bind_group_world_cache_active_cells_dispatch, &[]);
pass.set_pipeline(decay_world_cache_pipeline);
// ... world cache operations continue
```

The code movement is straightforward but crucial - it ensures that light tile data is available when the world cache update runs, eliminating the one-frame lag that was causing dynamic lighting issues.

## Further Reading

- Bevy Solari Documentation: Overview of Bevy's real-time global illumination system
- GPU Compute Pipeline Ordering: Technical details on dependency management in compute shaders
- Temporal Coherence in Real-Time Rendering: Techniques for maintaining consistency across frames in dynamic lighting scenarios
- Global Illumination Fundamentals: Core concepts behind indirect lighting and light propagation