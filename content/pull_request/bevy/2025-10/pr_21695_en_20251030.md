+++
title = "#21695 Text2d underline shadows fix"
date = "2025-10-30T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = true

[taxonomies]
list_display = ["show"]

[extra]
current_language = "en"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-10/pr-21695-en-20251030" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-10/pr-21695-zh-cn-20251030" }}
labels = ["C-Bug", "D-Trivial", "A-Rendering", "A-Text"]
+++

# Text2d underline shadows fix

## Basic Information
- **Title**: Text2d underline shadows fix
- **PR Link**: https://github.com/bevyengine/bevy/pull/21695
- **Author**: ickshonpe
- **Status**: MERGED
- **Labels**: C-Bug, D-Trivial, A-Rendering, S-Ready-For-Final-Review, A-Text
- **Created**: 2025-10-30T13:31:22Z
- **Merged**: 2025-10-30T16:19:00Z
- **Merged By**: alice-i-cecile

## Description Translation
# Objective

Text2d underline shadow is being drawn using the strikethrough position and size values.  Draw it with the correct geometry.

## Solution

Use the underline values.

## The Story of This Pull Request

This pull request addresses a straightforward but important bug in Bevy's 2D text rendering system. The issue was in the text shadow rendering for underlined text, where the underline shadows were incorrectly using strikethrough geometry instead of underline geometry.

The problem occurred in the `extract_text2d_sprite` function within the text rendering pipeline. When the system encountered text with underlines and shadows enabled, it would extract sprite data for the underline shadow effect. However, the implementation was mistakenly using `strikethrough_position()` and `strikethrough_size()` methods to calculate the shadow's position and dimensions, when it should have been using the corresponding underline methods.

The fix is minimal but crucial for visual correctness. By changing two method calls from `strikethrough_position()` to `underline_position()` and from `strikethrough_size()` to `underline_size()`, the underline shadows now render with the proper positioning and sizing that matches the actual underline geometry.

This type of bug is particularly interesting because it reveals how text rendering systems handle different text decorations (underline, strikethrough, etc.) as separate geometric elements that need individual processing. The strikethrough and underline decorations typically have different vertical positions and thicknesses in typography - strikethroughs are usually centered through the text's x-height, while underlines sit at the baseline.

The implementation shows good software engineering practice in maintaining separate methods for different text decoration types, allowing for precise control over each decoration's rendering characteristics. The fix ensures visual consistency between the main underline and its shadow, which is essential for maintaining the intended visual hierarchy and readability in text rendering.

## Visual Representation

```mermaid
graph TD
    A[Text2D Rendering Pipeline] --> B[extract_text2d_sprite]
    B --> C{Has Underline?}
    C -->|Yes| D[Calculate Shadow Geometry]
    D --> E[Use underline_position()]
    D --> F[Use underline_size()]
    E --> G[Render Correct Underline Shadow]
    F --> G
```

## Key Files Changed

### `crates/bevy_sprite_render/src/text2d/mod.rs`
This file contains the core text extraction logic for 2D text rendering in Bevy. The changes fix a bug where underline shadows were using incorrect geometry calculations.

**Key modifications:**

```rust
// Before:
let offset = run.strikethrough_position() * Vec2::new(1., -1.);
// ...
custom_size: Some(run.strikethrough_size()),

// After:
let offset = run.underline_position() * Vec2::new(1., -1.);
// ...
custom_size: Some(run.underline_size()),
```

The changes are minimal but significant - they ensure that underline shadows use the correct positioning and sizing that matches the actual underline decoration rather than the strikethrough decoration. This maintains visual consistency in text rendering.

## Further Reading

- [Bevy Text Rendering Documentation](https://docs.rs/bevy/latest/bevy/text/index.html)
- [Typography Basics: Underline vs Strikethrough](https://practicaltypography.com/underline.html)
- [Bevy Sprite Rendering System](https://docs.rs/bevy/latest/bevy/sprite/index.html)

# Full Code Diff
```diff
diff --git a/crates/bevy_sprite_render/src/text2d/mod.rs b/crates/bevy_sprite_render/src/text2d/mod.rs
index 2cb857e502c48..e01faab25063a 100644
--- a/crates/bevy_sprite_render/src/text2d/mod.rs
+++ b/crates/bevy_sprite_render/src/text2d/mod.rs
@@ -189,7 +189,7 @@ pub fn extract_text2d_sprite(
 
                 if has_underline {
                     let render_entity = commands.spawn(TemporaryRenderEntity).id();
-                    let offset = run.strikethrough_position() * Vec2::new(1., -1.);
+                    let offset = run.underline_position() * Vec2::new(1., -1.);
                     let transform =
                         shadow_transform * GlobalTransform::from_translation(offset.extend(0.));
                     extracted_sprites.sprites.push(ExtractedSprite {
@@ -204,7 +204,7 @@ pub fn extract_text2d_sprite(
                             anchor: Vec2::ZERO,
                             rect: None,
                             scaling_mode: None,
-                            custom_size: Some(run.strikethrough_size()),
+                            custom_size: Some(run.underline_size()),
                         },
                     });
                 }
```