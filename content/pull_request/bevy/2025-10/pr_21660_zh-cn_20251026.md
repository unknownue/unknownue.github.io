+++
title = "#21660 Don't use `[!Default; 0]: Default` impl"
date = "2025-10-26T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = false

[extra]
current_language = "zh-cn"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-10/pr-21660-en-20251026" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-10/pr-21660-zh-cn-20251026" }}
labels = ["D-Trivial", "A-ECS", "C-Code-Quality", "P-High"]
+++

# Title

## Basic Information
- **Title**: Don't use `[!Default; 0]: Default` impl
- **PR Link**: https://github.com/bevyengine/bevy/pull/21660
- **Author**: WaffleLapkin
- **Status**: MERGED
- **Labels**: D-Trivial, A-ECS, C-Code-Quality, P-High, S-Ready-For-Final-Review
- **Created**: 2025-10-26T18:46:20Z
- **Merged**: 2025-10-26T21:05:25Z
- **Merged By**: alice-i-cecile

## Description Translation
# 目标

- 参考 https://github.com/rust-lang/rust/pull/145457，我们想要移除无条件的 `[T; 0]: Default` 实现。这将是一个破坏性变更，会影响 `bevy_ecs` 和（一个测试用例）`bevy_camera`。

## 解决方案

- 用 `[]` 替换 `<[T; 0]>::default()` 调用

## 测试

- 代码能够编译，`<[T; 0]>::default()` 等价于 `[]`，不需要额外的测试

## The Story of This Pull Request

这个PR解决了一个由Rust语言未来变更可能引发的兼容性问题。问题的根源在于Rust编译器团队计划移除对零长度数组的无条件`Default`实现（rust-lang/rust#145457），这个变更将会破坏Bevy引擎中依赖此特性的代码。

在Rust中，零长度数组`[T; 0]`目前有一个默认的`Default`实现，允许调用`<[T; 0]>::default()`来获取一个空数组。然而，这个实现并不是必要的，因为可以直接使用数组字面量`[]`来达到同样的效果。

开发者面临的问题是：如果Rust移除了这个默认实现，Bevy代码库中两处使用`<[T; 0]>::default()`的地方将会无法编译。这是一个前瞻性的修复，目的是在Rust的破坏性变更生效之前，让Bevy代码库保持兼容性。

解决方案非常直接：用等价的空数组字面量`[]`替换所有对`<[T; 0]>::default()`的调用。这种替换在功能上是完全等价的，因为两者都产生一个零长度的数组，但在实现方式上更加明确和简洁。

从技术角度来看，这个变更体现了良好的软件工程实践。它展示了如何通过简单的重构来避免未来可能出现的兼容性问题，同时也使代码更加清晰和自文档化。使用数组字面量`[]`比调用`default()`方法更直观，因为读者可以立即看出这是一个空数组，而不需要理解`Default` trait的细节。

这个PR的重要性体现在它的标签上：被标记为P-High（高优先级），因为这是一个预防性的兼容性修复，需要在Rust的变更生效前完成。同时，它也被归类为C-Code-Quality（代码质量改进），因为这种重构确实提高了代码的可读性。

## Visual Representation

```mermaid
graph TD
    A[Rust语言变更] --> B[移除[T; 0]: Default实现]
    B --> C[Bevy代码兼容性问题]
    C --> D[使用[]替换default()调用]
    D --> E[保持代码兼容性]
```

## Key Files Changed

### 1. `crates/bevy_camera/src/primitives.rs`

**变更描述**: 在测试用例中，将零长度数组的默认构造方式从方法调用改为字面量。

**代码变更**:
```rust
// 修改前:
assert_eq!(Aabb::enclosing(<[Vec3; 0]>::default()), None);

// 修改后:
assert_eq!(Aabb::enclosing([] as [Vec3; 0]), None);
```

这个变更是测试代码中的一个简单重构，将边界框(enclosing AABB)计算中对空数组的构造方式从方法调用改为类型标注的字面量。

### 2. `crates/bevy_ecs/src/entity/unique_array.rs`

**变更描述**: 在ECS模块中，修改零长度唯一实体数组的默认实现。

**代码变更**:
```rust
// 修改前:
impl<T: EntityEquivalent> Default for UniqueEntityEquivalentArray<T, 0> {
    fn default() -> Self {
        Self(Default::default())
    }
}

// 修改后:
impl<T: EntityEquivalent> Default for UniqueEntityEquivalentArray<T, 0> {
    fn default() -> Self {
        Self([])
    }
}
```

这个变更修改了`UniqueEntityEquivalentArray`类型对于零长度情况的`Default`实现。原来的实现依赖于内部数组的`Default`实现，现在直接使用空数组字面量。

## Further Reading

- [Rust PR #145457: Remove unconditional `[T; 0]: Default` impl](https://github.com/rust-lang/rust/pull/145457) - 引发这个变更的原始Rust PR
- [Rust数组文档](https://doc.rust-lang.org/std/primitive.array.html) - Rust数组类型的官方文档
- [Default trait文档](https://doc.rust-lang.org/std/default/trait.Default.html) - Rust Default trait的详细说明

# Full Code Diff
diff --git a/crates/bevy_camera/src/primitives.rs b/crates/bevy_camera/src/primitives.rs
index e7f7526dce6ac..9b1fc41c59c39 100644
--- a/crates/bevy_camera/src/primitives.rs
+++ b/crates/bevy_camera/src/primitives.rs
@@ -652,7 +652,7 @@ mod tests {
 
     #[test]
     fn aabb_enclosing() {
-        assert_eq!(Aabb::enclosing(<[Vec3; 0]>::default()), None);
+        assert_eq!(Aabb::enclosing([] as [Vec3; 0]), None);
         assert_eq!(
             Aabb::enclosing(vec![Vec3::ONE]).unwrap(),
             Aabb::from_min_max(Vec3::ONE, Vec3::ONE)
diff --git a/crates/bevy_ecs/src/entity/unique_array.rs b/crates/bevy_ecs/src/entity/unique_array.rs
index 71df33ec5f42c..db6b67bd7af95 100644
--- a/crates/bevy_ecs/src/entity/unique_array.rs
+++ b/crates/bevy_ecs/src/entity/unique_array.rs
@@ -157,7 +157,7 @@ impl<T: EntityEquivalent, const N: usize> DerefMut for UniqueEntityEquivalentArr
 
 impl<T: EntityEquivalent> Default for UniqueEntityEquivalentArray<T, 0> {
     fn default() -> Self {
-        Self(Default::default())
+        Self([])
     }
 }
