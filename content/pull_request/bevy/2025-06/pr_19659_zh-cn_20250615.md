+++
title = "#19659 Make sequential_dispersed fn constant"
date = "2025-06-15T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = false

[extra]
current_language = "zh-cn"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-06/pr-19659-en-20250615" }, "zh-cn" = { name = "ä¸­æ–‡", url = "/pull_request/bevy/2025-06/pr-19659-zh-cn-20250615" }}
labels = ["D-Trivial", "C-Usability", "A-Color"]
+++

# Make sequential_dispersed fn constant

## Basic Information
- **Title**: Make sequential_dispersed fn constant
- **PR Link**: https://github.com/bevyengine/bevy/pull/19659
- **Author**: alice-i-cecile
- **Status**: MERGED
- **Labels**: D-Trivial, C-Usability, S-Ready-For-Final-Review, A-Color
- **Created**: 2025-06-15T16:36:08Z
- **Merged**: 2025-06-15T17:22:22Z
- **Merged By**: alice-i-cecile

## Description Translation
# ç›®æ ‡

- ç”±äºæˆ‘ä»¬ç°åœ¨æœ‰äº†å¸¸é‡æµ®ç‚¹æ•°è¿ç®— (const_float_arithmetic)ï¼Œå°è¯•è®© `bevy_color` ä¸­æ›´å¤šçš„å‡½æ•°æˆä¸ºå¸¸é‡å‡½æ•°ã€‚

## è§£å†³æ–¹æ¡ˆ

ç”±äºæˆ‘ä»¬å¤§é‡ä½¿ç”¨ traitï¼Œå› æ­¤å¤±è´¥äº†ã€‚

ä¸è¿‡æˆ‘è¿˜æ˜¯æ‰¾åˆ°äº†è¿™äº›å‡½æ•°ï¼Œæ‰€ä»¥ä½ å¯ä»¥æœ‰ä¸€ä¸ªPR ğŸ™ƒ 

## The Story of This Pull Request

### é—®é¢˜å’ŒèƒŒæ™¯
åœ¨ Rust æ”¯æŒå¸¸é‡æµ®ç‚¹æ•°è¿ç®— (const float arithmetic) åï¼ŒBevy å›¢é˜Ÿå¸Œæœ›åˆ©ç”¨è¿™ä¸€ç‰¹æ€§å°† `bevy_color` æ¨¡å—ä¸­æ›´å¤šçš„å‡½æ•°è½¬ä¸ºå¸¸é‡å‡½æ•°ã€‚å¸¸é‡å‡½æ•°å¯ä»¥åœ¨ç¼–è¯‘æœŸæ‰§è¡Œè®¡ç®—ï¼Œæœ‰åˆ©äºæ€§èƒ½ä¼˜åŒ–å’Œå¸¸é‡åˆå§‹åŒ–ã€‚ç„¶è€Œï¼Œç”±äº `bevy_color` é‡åº¦ä¾èµ– trait ç³»ç»Ÿï¼Œå¤§éƒ¨åˆ†å‡½æ•°æ— æ³•ç›´æ¥è½¬ä¸ºå¸¸é‡å‡½æ•°ã€‚

å¼€å‘è€… alice-i-cecile åœ¨æ¢ç´¢è¿‡ç¨‹ä¸­å‘ç°ï¼Œ`Hsla`ã€`Lcha` å’Œ `Oklcha` ç»“æ„ä½“ä¸­çš„ `sequential_dispersed` å‡½æ•°å…·å¤‡æˆä¸ºå¸¸é‡å‡½æ•°çš„æ¡ä»¶ã€‚è¯¥å‡½æ•°ä½¿ç”¨é»„é‡‘åˆ†å‰²ç‡ç”Ÿæˆè§†è§‰ä¸Šå‡åŒ€åˆ†å¸ƒçš„è‰²ç›¸åºåˆ—ï¼Œå¸¸ç”¨äºåˆ›å»ºè°ƒè‰²æ¿ã€‚åŸå§‹å®ç°è™½ç„¶åªä½¿ç”¨åŸºæœ¬ç®—æœ¯è¿ç®—ï¼Œä½†ç¼ºå°‘ `const` å…³é”®å­—é™åˆ¶äº†å…¶åœ¨ç¼–è¯‘æœŸçš„ä½¿ç”¨åœºæ™¯ã€‚

### è§£å†³æ–¹æ¡ˆå’Œå®æ–½
è§£å†³æ–¹æ¡ˆç›´æ¥æ˜äº†ï¼šä¸º `sequential_dispersed` å‡½æ•°æ·»åŠ  `const` ä¿®é¥°ç¬¦ã€‚è¯¥å‡½æ•°å®ç°ä»…åŒ…å«å¸¸é‡è¡¨è¾¾å¼ï¼š
1. ä½¿ç”¨é¢„å®šä¹‰çš„é»„é‡‘åˆ†å‰²ç‡æ•´æ•°è¿‘ä¼¼å€¼ï¼š`FRAC_U32MAX_GOLDEN_RATIO = 2654435769`
2. æ‰§è¡Œæ•´æ•°ä¹˜æ³•å’Œå–æ¨¡è¿ç®—ï¼š`(index.wrapping_mul(FRAC_U32MAX_GOLDEN_RATIO) % u32::MAX`
3. å°†ç»“æœè½¬æ¢ä¸ºè§’åº¦å€¼ï¼š`RATIO_360 * hue`

è¿™äº›æ“ä½œåœ¨ç¼–è¯‘æœŸå‡å¯å®Œæˆï¼Œç¬¦åˆ Rust çš„å¸¸é‡å‡½æ•°è¦æ±‚ã€‚ä¿®æ”¹æ¶‰åŠä¸‰ä¸ªæ–‡ä»¶ä¸­çš„ç›¸åŒæ¨¡å¼ï¼š
- åœ¨å‡½æ•°ç­¾åå‰æ·»åŠ  `const` å…³é”®å­—
- ä¿æŒå†…éƒ¨é€»è¾‘å®Œå…¨ä¸å˜
- ç»´æŒæ‰€æœ‰æ³¨é‡Šå’Œå¸¸é‡å®šä¹‰

### æŠ€æœ¯è§è§£
1. **å¸¸é‡å‡½æ•°ä¼˜åŠ¿**ï¼šç¼–è¯‘æœŸæ‰§è¡Œé¿å…è¿è¡Œæ—¶è®¡ç®—å¼€é”€ï¼Œæ”¯æŒå¸¸é‡ä¸Šä¸‹æ–‡åˆå§‹åŒ–
2. **ç®—æ³•ç‰¹æ€§**ï¼šä½¿ç”¨é»„é‡‘åˆ†å‰²ç‡ (Î¦) ç¡®ä¿ç”Ÿæˆçš„è‰²ç›¸åœ¨è‰²ç¯ä¸Šå‡åŒ€åˆ†å¸ƒ
3. **æ•°å€¼å¤„ç†**ï¼š
   - `wrapping_mul` é¿å…æ•´æ•°æº¢å‡º panicï¼ˆåœ¨å¸¸é‡ä¸Šä¸‹æ–‡ä¸­å¿…é¡»å®‰å…¨ï¼‰
   - `u32::MAX as f32` æ˜¾å¼ç±»å‹è½¬æ¢ä¿æŒç²¾åº¦
4. **ç»´æŠ¤æ€§**ï¼šä¸‰ä¸ªé¢œè‰²ç©ºé—´çš„å®ç°ä¿æŒå®Œå…¨ä¸€è‡´çš„ä¿®æ”¹æ¨¡å¼

### å½±å“
1. **ä½¿ç”¨åœºæ™¯æ‰©å±•**ï¼šå¼€å‘è€…ç°åœ¨å¯åœ¨ç¼–è¯‘æœŸåˆå§‹åŒ–é¢œè‰²åºåˆ—ï¼š
   ```rust
   const PALETTE: [Hsla; 5] = [
       Hsla::sequential_dispersed(0),
       Hsla::sequential_dispersed(1),
       // ...
   ];
   ```
2. **é›¶è¿è¡Œæ—¶å¼€é”€**ï¼šè°ƒç”¨è¯¥å‡½æ•°æ—¶ç›´æ¥ä½¿ç”¨ç¼–è¯‘æœŸè®¡ç®—ç»“æœ
3. **åç»­ä¼˜åŒ–åŸºç¡€**ï¼šä¸ºå…¶ä»–é¢œè‰²å‡½æ•°è½¬ä¸ºå¸¸é‡æä¾›å‚è€ƒå®ç°
4. **æ— ç ´åæ€§å˜æ›´**ï¼šå‡½æ•°ç­¾åå…¼å®¹æ€§ä¿æŒï¼Œä¸å½±å“ç°æœ‰è°ƒç”¨æ–¹

## Visual Representation

```mermaid
graph TD
    PR[PR #19659] --> Hsla
    PR --> Lcha
    PR --> Oklcha
    Hsla -->|æ·»åŠ  const| sequential_dispersed
    Lcha -->|æ·»åŠ  const| sequential_dispersed
    Oklcha -->|æ·»åŠ  const| sequential_dispersed
```

## Key Files Changed

1. `crates/bevy_color/src/hsla.rs`
   - å˜æ›´ï¼šå°† `sequential_dispersed` è½¬ä¸ºå¸¸é‡å‡½æ•°
   - ä»£ç å·®å¼‚ï¼š
```diff
-    pub fn sequential_dispersed(index: u32) -> Self {
+    pub const fn sequential_dispersed(index: u32) -> Self {
         const FRAC_U32MAX_GOLDEN_RATIO: u32 = 2654435769; // (u32::MAX / Î¦) rounded up
         const RATIO_360: f32 = 360.0 / u32::MAX as f32;
```

2. `crates/bevy_color/src/lcha.rs`
   - å˜æ›´ï¼šç›¸åŒå‡½æ•°ç­¾åä¿®æ”¹
   - ä»£ç å·®å¼‚ï¼š
```diff
-    pub fn sequential_dispersed(index: u32) -> Self {
+    pub const fn sequential_dispersed(index: u32) -> Self {
         const FRAC_U32MAX_GOLDEN_RATIO: u32 = 2654435769; // (u32::MAX / Î¦) rounded up
         const RATIO_360: f32 = 360.0 / u32::MAX as f32;
```

3. `crates/bevy_color/src/oklcha.rs`
   - å˜æ›´ï¼šç›¸åŒå‡½æ•°ç­¾åä¿®æ”¹
   - ä»£ç å·®å¼‚ï¼š
```diff
-    pub fn sequential_dispersed(index: u32) -> Self {
+    pub const fn sequential_dispersed(index: u32) -> Self {
         const FRAC_U32MAX_GOLDEN_RATIO: u32 = 2654435769; // (u32::MAX / Î¦) rounded up
         const RATIO_360: f32 = 360.0 / u32::MAX as f32;
```

## Further Reading
1. [Rust å¸¸é‡å‡½æ•°æ–‡æ¡£](https://doc.rust-lang.org/reference/const_eval.html)
2. [Rust å¸¸é‡æµ®ç‚¹æ•°è¿ç®—æ¼”è¿›](https://github.com/rust-lang/rust/issues/57241)
3. [é»„é‡‘åˆ†å‰²ç‡åœ¨é¢œè‰²åˆ†å¸ƒçš„åº”ç”¨](https://en.wikipedia.org/wiki/Golden_ratio#Applications_and_observations)
4. [Bevy é¢œè‰²ç³»ç»Ÿæ¶æ„](https://bevyengine.org/learn/book/features/colors/)