+++
title = "#19619 Fixing running `ci` locally in MacOS"
date = "2025-06-13T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = false

[extra]
current_language = "zh-cn"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-06/pr-19619-en-20250613" }, "zh-cn" = { name = "ä¸­æ–‡", url = "/pull_request/bevy/2025-06/pr-19619-zh-cn-20250613" }}
+++

# Fixing running `ci` locally in MacOS

## Basic Information
- **Title**: Fixing running `ci` locally in MacOS
- **PR Link**: https://github.com/bevyengine/bevy/pull/19619
- **Author**: eckz
- **Status**: MERGED
- **Labels**: None
- **Created**: 2025-06-13T13:45:39Z
- **Merged**: 2025-06-13T15:10:45Z
- **Merged By**: mockersf

## Description Translation
# ç›®çš„ (Objective)

- åœ¨ MacOS ä¸Šè¿è¡Œ `cargo run --package ci` ç›®å‰åœ¨ `main` åˆ†æ”¯ä¸­æ— æ³•å·¥ä½œ
- å®ƒä¼šæ˜¾ç¤ºä¸€ä¸ªé”™è¯¯ï¼š`error: this lint expectation is unfulfilled`
- ä¿®å¤ #19583

## è§£å†³æ–¹æ¡ˆ (Solution)

- ç§»é™¤ä¸€ä¸ªå‡½æ•°ä¸Šä¸å¿…è¦çš„ `#[expect(clippy::large_enum_variant)]`

## æµ‹è¯• (Testing)

- `cargo run --package ci`: ğŸ‘

## The Story of This Pull Request

### é—®é¢˜èƒŒæ™¯
åœ¨ MacOS ç¯å¢ƒä¸­è¿è¡Œ Bevy çš„ CI è„šæœ¬ (`cargo run --package ci`) æ—¶ï¼Œå¼€å‘è€…ä¼šé‡åˆ°ä¸€ä¸ªç¼–è¯‘é”™è¯¯ï¼š`error: this lint expectation is unfulfilled`ã€‚è¿™ä¸ªé”™è¯¯å‘ç”Ÿåœ¨ `main` åˆ†æ”¯ä¸­ï¼Œå¯¼è‡´æœ¬åœ°å¼€å‘å·¥ä½œæµä¸­æ–­ã€‚å…·ä½“é—®é¢˜æ˜¯ Clippy çš„ `expect` å±æ€§æ£€æŸ¥å¤±è´¥ï¼Œè¯¥å±æ€§åŸæœ¬æœŸæœ›ä¸€ä¸ª lint è­¦å‘Šä¼šå‡ºç°ï¼Œä½†å®é™…ä¸Šè­¦å‘Šå¹¶æœªè§¦å‘ã€‚

### é—®é¢˜è¯Šæ–­
é—®é¢˜æ ¹æºåœ¨ `pipeline_cache.rs` æ–‡ä»¶ä¸­çš„ä¸€ä¸ªæ¡ä»¶ç¼–è¯‘å‡½æ•°ã€‚è¯¥å‡½æ•°ä½¿ç”¨äº† `#[expect(clippy::large_enum_variant)]` å±æ€§ï¼Œç›®çš„æ˜¯ä¸´æ—¶æŠ‘åˆ¶ Clippy çš„ `large_enum_variant` è­¦å‘Šã€‚ä½†ä»£ç å˜æ›´åï¼Œè¿™ä¸ª lint è­¦å‘Šä¸å†å‡ºç°ï¼Œå¯¼è‡´ Clippy çš„æœŸæœ›æ£€æŸ¥å¤±è´¥ï¼š
```rust
#[expect(
    clippy::large_enum_variant,
    reason = "See https://github.com/bevyengine/bevy/issues/19220"
)]
```
è¿™ç§æ¨¡å¼åœ¨ Rust å¼€å‘ä¸­å¸¸è§ï¼Œç”¨äºä¸´æ—¶å¤„ç†å·²çŸ¥ä½†å°šæœªä¿®å¤çš„ lint è­¦å‘Šã€‚ä½†å½“åº•å±‚ä»£ç å˜æ›´å¯¼è‡´è­¦å‘Šæ¶ˆå¤±æ—¶ï¼Œ`expect` å±æ€§åè€Œä¼šæˆä¸ºç¼–è¯‘éšœç¢ã€‚

### è§£å†³æ–¹æ¡ˆå®æ–½
è§£å†³æ–¹æ¡ˆç›´æ¥æ˜äº†ï¼šç§»é™¤ä¸å†éœ€è¦çš„ `expect` å±æ€§ã€‚è¯¥å±æ€§ä½äºç‰¹å®šå¹³å°çš„æ¡ä»¶ç¼–è¯‘å—å†…ï¼š
```rust
#[cfg(all(
    target_os = "macos",
    not(feature = "multi_threaded")
))]
```
ä¿®æ”¹åä»£ç ç®€åŒ–ä¸ºï¼š
```rust
#[cfg(all(
    target_os = "macos",
    not(feature = "multi_threaded")
))]
fn create_pipeline_task(
    task: impl Future<Output = Result<Pipeline, PipelineCacheError>> + Send + 'static,
    _sync: bool,
```

### æŠ€æœ¯æƒè¡¡
è€ƒè™‘è¿‡å…¶ä»–æ–¹æ¡ˆï¼š
1. **ä¿®æ”¹ lint è§„åˆ™**ï¼šå…¨å±€ç¦ç”¨è¯¥ lint å¯èƒ½æ©ç›–å…¶ä»–åœ°æ–¹çš„åˆæ³•é—®é¢˜
2. **é‡æ„ä»£ç **ï¼šè§£å†³æ½œåœ¨çš„ `large_enum_variant` é—®é¢˜æˆæœ¬è¾ƒé«˜
3. **ä¿ç•™å±æ€§ä½†æ»¡è¶³æœŸæœ›**ï¼šäººä¸ºå¼•å…¥è­¦å‘Šä¸åˆ‡å®é™…

ç§»é™¤å±æ€§æ˜¯æœ€ç›´æ¥ä¸”å®‰å…¨çš„æ–¹æ¡ˆï¼Œå› ä¸ºï¼š
- åŸå§‹é—®é¢˜ (#19220) å¯èƒ½å·²é€šè¿‡å…¶ä»–æ–¹å¼è§£å†³
- è¯¥å±æ€§ä»…å½±å“ç‰¹å®šå¹³å°é…ç½®
- ç§»é™¤éå¿…è¦å±æ€§ä¸ä¼šæ”¹å˜åŠŸèƒ½è¡Œä¸º

### éªŒè¯ä¸å½±å“
éªŒè¯æ–¹æ³•ç®€å•ç›´æ¥ï¼šåœ¨ MacOS ä¸Šé‡æ–°è¿è¡Œ `cargo run --package ci` ç¡®è®¤æˆåŠŸã€‚è¯¥ä¿®å¤ï¼š
1. æ¢å¤ MacOS å¼€å‘è€…çš„æœ¬åœ° CI åŠŸèƒ½
2. æ¶ˆé™¤è™šå‡ç¼–è¯‘é”™è¯¯
3. ä¿æŒå…¶ä»–å¹³å°è¡Œä¸ºä¸å˜
4. æ¸…ç†ä¸å†å¿…è¦çš„ä»£ç æ³¨è§£

### æŠ€æœ¯å¯ç¤º
è¯¥æ¡ˆä¾‹å±•ç¤ºäº† Rust lint ç³»ç»Ÿçš„äº¤äº’å¤æ‚æ€§ï¼š
- `expect` å±æ€§é€‚ç”¨äºä¸´æ—¶æŠ‘åˆ¶å·²çŸ¥è­¦å‘Š
- å½“è­¦å‘Šæ¶ˆå¤±æ—¶éœ€åŠæ—¶æ¸…ç†è¿™äº›å±æ€§
- æ¡ä»¶ç¼–è¯‘ä¼šå¢åŠ æ­¤ç±»é—®é¢˜çš„æ’æŸ¥éš¾åº¦
- CI è„šæœ¬åº”è¦†ç›–æ‰€æœ‰ç›®æ ‡å¹³å°é…ç½®

## Visual Representation

```mermaid
graph TD
    A[è¿è¡Œ ci è„šæœ¬] --> B{æ£€æµ‹å¹³å°}
    B -->|MacOS| C[æ‰§è¡Œæ¡ä»¶ç¼–è¯‘ä»£ç ]
    C --> D[æ£€æŸ¥ expect å±æ€§]
    D -->|å±æ€§æœªæ»¡è¶³| E[ç¼–è¯‘å¤±è´¥]
    F[ç§»é™¤ expect å±æ€§] --> G[ç¼–è¯‘æˆåŠŸ]
```

## Key Files Changed

### crates/bevy_render/src/render_resource/pipeline_cache.rs
- **ä¿®æ”¹åŸå› **ï¼šç§»é™¤å¯¼è‡´ Clippy æ£€æŸ¥å¤±è´¥çš„å†—ä½™å±æ€§
- **æŠ€æœ¯èƒŒæ™¯**ï¼šè¯¥æ–‡ä»¶ç®¡ç†æ¸²æŸ“ç®¡çº¿ç¼“å­˜ï¼Œæ¡ä»¶ç¼–è¯‘å—å¤„ç† MacOS ç‰¹å®šé€»è¾‘

```rust
// ä¿®æ”¹å‰:
#[cfg(all(
    target_os = "macos",
    not(feature = "multi_threaded")
))]
#[expect(
    clippy::large_enum_variant,
    reason = "See https://github.com/bevyengine/bevy/issues/19220"
)]
fn create_pipeline_task(
    task: impl Future<Output = Result<Pipeline, PipelineCacheError>> + Send + 'static,
    _sync: bool,

// ä¿®æ”¹å:
#[cfg(all(
    target_os = "macos",
    not(feature = "multi_threaded")
))]
fn create_pipeline_task(
    task: impl Future<Output = Result<Pipeline, PipelineCacheError>> + Send + 'static,
    _sync: bool,
```

## Further Reading
1. [Rust Clippy å®˜æ–¹æ–‡æ¡£](https://doc.rust-lang.org/stable/clippy/)
2. [expect å±æ€§å·¥ä½œæœºåˆ¶](https://doc.rust-lang.org/rustc/lints/levels.html#expect)
3. [æ¡ä»¶ç¼–è¯‘æŒ‡å—](https://doc.rust-lang.org/reference/conditional-compilation.html)