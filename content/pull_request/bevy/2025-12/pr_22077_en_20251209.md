+++
title = "#22077 Fix undefined behavior in screenshots on WASM"
date = "2025-12-09T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = true

[taxonomies]
list_display = ["show"]

[extra]
current_language = "en"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-12/pr-22077-en-20251209" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-12/pr-22077-zh-cn-20251209" }}
labels = ["C-Bug", "D-Trivial", "O-Web", "P-Unsound"]
+++

# Fix undefined behavior in screenshots on WASM

## Basic Information
- **Title**: Fix undefined behavior in screenshots on WASM
- **PR Link**: https://github.com/bevyengine/bevy/pull/22077
- **Author**: kristoff3r
- **Status**: MERGED
- **Labels**: C-Bug, D-Trivial, O-Web, P-Unsound, S-Needs-Review
- **Created**: 2025-12-09T16:02:44Z
- **Merged**: 2025-12-09T18:33:58Z
- **Merged By**: mockersf

## Description Translation
# Objective

Currently the screenshot example on https://bevy.org/examples/window/screenshot/ gives invalid PNG files when I tried it. Looking at them they have some of the right bytes, but also a bunch of garbage. The example works on native.

I narrowed it down to the one unsafe block in sight (thanks Rust!). I don't fully understand why the code stopped working or if it was ever valid, but in the meantime since it was written a safe API has been added, and using it made the problem go away.

## Solution

Bump `js-sys`, use the safe API.

## Testing

I ran the example with `bevy run --example screenshot web`

## The Story of This Pull Request

This PR addresses a specific WebAssembly issue where screenshot functionality was producing corrupted PNG files. The problem manifested when running the screenshot example on WASM targets, while native builds continued to work correctly. The developer investigating this issue took a systematic approach: they reproduced the problem, examined the corrupted output, and then methodically traced it to the only unsafe code block in the relevant code path.

The issue was in the WebAssembly-specific implementation of screenshot saving. The original code used `js_sys::Uint8Array::view()` to create a JavaScript `Uint8Array` that directly referenced Rust memory. This approach is inherently unsafe because it creates a view into Rust-managed memory that JavaScript can access. The problem arises from Rust's ownership model: once the Rust `Vec<u8>` containing the image data goes out of scope and is dropped, the JavaScript view becomes a dangling pointer, leading to undefined behavior when JavaScript tries to access that memory.

The developer discovered that since the original code was written, `js-sys` had added a safer alternative: `Uint8Array::new_from_slice()`. This method creates a copy of the data in JavaScript-managed memory instead of creating a view into Rust memory. While copying data has a performance cost, it eliminates the memory safety issues and ensures the screenshot functionality works reliably on WASM.

The fix was straightforward but important: update the `js-sys` dependency to a version that includes the safe API (0.3.83), then replace the unsafe `view()` call with the safe `new_from_slice()` method. This change demonstrates a common pattern in Rust WebAssembly development: prefer safe APIs that properly manage memory boundaries between Rust and JavaScript, even when they involve data copying.

The implementation highlights an important principle in systems programming: when working with foreign function interfaces or different memory spaces, explicit copying is often safer than sharing memory, especially when the lifetime of data is difficult to coordinate across language boundaries.

## Visual Representation

```mermaid
graph LR
    A[Rust Screenshot Code] --> B[Create PNG in Vec<u8>]
    B --> C[Old: Unsafe view() into Rust memory]
    B --> D[New: Safe copy to JS memory]
    C --> E[Corrupted PNG due to UB]
    D --> F[Valid PNG file]
```

## Key Files Changed

### `crates/bevy_render/Cargo.toml`
**Change**: Updated `js-sys` dependency from "0.3" to "0.3.83" for WASM targets.

**Why**: The newer version includes the `new_from_slice()` method which provides a safe alternative to the unsafe `view()` method used in the screenshot code.

```toml
# File: crates/bevy_render/Cargo.toml
# Before:
[target.'cfg(target_arch = "wasm32")'.dependencies]
js-sys = "0.3"

# After:
[target.'cfg(target_arch = "wasm32")'.dependencies]
js-sys = "0.3.83"
```

### `crates/bevy_render/src/view/window/screenshot.rs`
**Change**: Replaced unsafe `js_sys::Uint8Array::view()` with safe `js_sys::Uint8Array::new_from_slice()`.

**Why**: The `view()` method creates a JavaScript view into Rust memory, which becomes invalid when the Rust data is dropped, causing undefined behavior. The `new_from_slice()` method copies the data to JavaScript-managed memory, ensuring it remains valid.

```rust
// File: crates/bevy_render/src/view/window/screenshot.rs
// Before (unsafe):
let parts = js_sys::Array::of1(&unsafe {
    js_sys::Uint8Array::view(image_buffer.into_inner().as_bytes())
        .into()
});

// After (safe):
let parts = js_sys::Array::of1(
    &js_sys::Uint8Array::new_from_slice(
        image_buffer.into_inner().as_bytes(),
    )
    .into(),
);
```

**Technical Detail**: The key difference is memory management:
- `view()`: Creates a view without copying data. The JavaScript array references the Rust `Vec<u8>` memory directly.
- `new_from_slice()`: Copies the data from Rust memory to JavaScript memory, creating independent ownership.

## Further Reading

1. **Rust and WebAssembly Book**: https://rustwasm.github.io/docs/book/
2. **js-sys crate documentation**: https://docs.rs/js-sys/latest/js_sys/
3. **Rustonomicon - Working with Unsafe Code**: https://doc.rust-lang.org/nomicon/
4. **WebAssembly Memory Model**: https://webassembly.github.io/spec/core/syntax/modules.html#memories
5. **Bevy WebAssembly Guide**: https://github.com/bevyengine/bevy/blob/main/examples/README.md#wasm