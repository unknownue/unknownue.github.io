+++
title = "#20394 Alternative glTF coordinate conversion"
date = "2025-12-16T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = true

[taxonomies]
list_display = ["show"]

[extra]
current_language = "en"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-12/pr-20394-en-20251216" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-12/pr-20394-zh-cn-20251216" }}
labels = ["C-Bug", "M-Migration-Guide", "X-Blessed", "A-glTF"]
+++

# Title

## Basic Information
- **Title**: Alternative glTF coordinate conversion
- **PR Link**: https://github.com/bevyengine/bevy/pull/20394
- **Author**: greeble-dev
- **Status**: MERGED
- **Labels**: C-Bug, S-Ready-For-Review, M-Migration-Guide, X-Blessed, A-glTF
- **Created**: 2025-08-03T11:58:31Z
- **Merged**: 2025-12-16T00:58:04Z
- **Merged By**: cart

## Description

### Objective

Change glTF coordinate conversion to satisfy some common use cases while dodging the more controversial aspects. This fixes #20621, but at the cost of removing one feature.

### Summary

The Bevy glTF loader can optionally convert nodes and meshes from glTF's "+Z forward" semantics to Bevy's "-Z forward". But the current implementation [has issues](https://github.com/bevyengine/bevy/issues/20621), particularly with cameras and lights. It might also cause problems for users who want to re-orient the scene as a whole while preserving the original node semantics.

This PR replaces node conversion with a simpler correction to the scene root and mesh entities. The new approach satisfies many use cases and fixes the issues with cameras and lights. But it could be a regression for some users.

## The Story of This Pull Request

The glTF format uses different coordinate system semantics than Bevy. glTF's standard specifies "+Z forward, +Y up, right-handed", while Bevy uses "-Z forward, +Y up, right-handed". This mismatch creates a practical problem: when loading glTF assets into Bevy, objects face the wrong direction unless some conversion happens.

In Bevy 0.17, a solution was introduced via the `use_model_forward_direction` flag. When enabled, this would convert node transforms and mesh data from glTF's +Z forward to Bevy's -Z forward. The implementation worked by applying coordinate transformations to individual nodes in the hierarchy. However, this approach had several technical problems documented in issue #20621.

The core issue was that glTF cameras and lights already use -Z forward, matching Bevy's convention. When the conversion was applied to nodes, it would incorrectly rotate camera and light nodes, breaking their expected behavior. Additionally, the conversion logic became complex when dealing with animation tracks, child nodes of cameras/lights, and the rare case where a node could be both a mesh and a camera/light.

The developer faced a choice: either fix the complex node conversion logic with special cases for cameras and lights, or take a different architectural approach. They chose the latter, recognizing that most users simply want the overall scene to face the correct direction, not necessarily individual node transforms.

The solution was to move the conversion higher up in the hierarchy. Instead of converting every node, the PR applies corrective transforms at two strategic points:
1. **Scene root entity**: A rotation applied to the parent of all glTF root nodes
2. **Mesh primitive entities**: A rotation applied to individual mesh instances

This approach maintains the visual orientation while avoiding the complexity of node-by-node conversion. The mathematical transformation remains the same: a 180-degree rotation around the Y axis (represented by the quaternion `Quat::from_xyzw(0.0, 1.0, 0.0, 0.0)`), which converts +Z forward to -Z forward.

The implementation splits the previous single boolean flag into two separate options: `rotate_scene_entity` for scene conversion and `rotate_meshes` for mesh conversion. This provides users with more granular control. For example, someone might want scene orientation corrected but keep mesh assets in their original format, or vice versa.

One important technical detail is that the conversion is applied differently to different components:
- **Scene conversion**: Affects the scene root entity only, which indirectly affects all child nodes through transform inheritance
- **Mesh conversion**: Affects both the mesh asset data and the transform of mesh primitive entities

The change required updating how skinning works. For skinned meshes, the inverse bind matrices need to be multiplied by the conversion matrix to maintain proper skin deformation when mesh conversion is enabled. The PR handles this by applying the conversion matrix to the bind matrices during skin loading.

While this approach fixes camera and light issues and simplifies the code, it does remove node conversion as a feature. Users who relied on individual node transforms being converted to Bevy semantics will see different behavior. The migration guide addresses this by recommending that users enable both scene and mesh conversion for behavior closest to the previous version.

## Visual Representation

```mermaid
graph TD
    subgraph "Before PR"
        A[User Entity with SceneRoot] --> B[Scene Root Entity]
        B --> C[glTF Root Node Entity]
        C --> D[glTF Intermediate Node Entities]
        D --> E[glTF Mesh Node Entity]
        E --> F[Mesh Primitive Entities]
        
        style C stroke:#f66
        style D stroke:#f66
        style E stroke:#f66
    end
    
    subgraph "After PR"
        A2[User Entity with SceneRoot] --> B2[Scene Root Entity]
        B2 --> C2[glTF Root Node Entity]
        C2 --> D2[glTF Intermediate Node Entities]
        D2 --> E2[glTF Mesh Node Entity]
        E2 --> F2[Mesh Primitive Entities]
        
        style B2 stroke:#6f6
        style F2 stroke:#6f6
    end
    
    subgraph "Legend"
        G[Node Conversion]:::converted
        H[Scene/Mesh Correction]:::corrective
    end
    
    classDef converted fill:#fcc
    classDef corrective fill:#cfc
```

## Key Files Changed

### 1. `crates/bevy_gltf/src/convert_coordinates.rs` (+81/-46)

This file was completely restructured. The old conversion traits were removed and replaced with a `GltfConvertCoordinates` struct that provides separate options for scene and mesh conversion.

**Key changes:**
- Removed `ConvertCoordinates` and `ConvertCameraCoordinates` traits
- Added `GltfConvertCoordinates` struct with `rotate_scene_entity` and `rotate_meshes` fields
- Added methods to get conversion transforms for different contexts

```rust
// Before: Multiple traits for different conversions
pub(crate) trait ConvertCoordinates {
    fn convert_coordinates(self) -> Self;
}

pub(crate) trait ConvertCameraCoordinates {
    fn convert_camera_coordinates(self) -> Self;
}

// After: Single struct with clear options
pub struct GltfConvertCoordinates {
    pub rotate_scene_entity: bool,
    pub rotate_meshes: bool,
}

impl GltfConvertCoordinates {
    pub(crate) fn scene_conversion_transform(&self) -> Transform {
        if self.rotate_scene_entity {
            Self::CONVERSION_TRANSFORM
        } else {
            Transform::IDENTITY
        }
    }
    
    pub(crate) fn mesh_conversion_mat4(&self) -> Mat4 {
        if self.rotate_meshes {
            Self::conversion_mat4()
        } else {
            Mat4::IDENTITY
        }
    }
}
```

### 2. `crates/bevy_gltf/src/loader/mod.rs` (+37/-67)

This file contains the main loader logic changes. The conversion is now applied at the scene root and mesh primitive levels instead of per-node.

**Key changes:**
- Changed from per-node conversion to scene-level and mesh-level conversion
- Updated skin loading to apply mesh conversion to inverse bind matrices
- Removed coordinate conversion from animation tracks

```rust
// Before: Applying conversion to each node
let transform = node_transform(&node, convert_coordinates);

// After: No node conversion, just scene root conversion
let world_root_transform = convert_coordinates.scene_conversion_transform();
let world_root_id = world.spawn((world_root_transform, Visibility::default()));

// Mesh entity gets corrective transform
let mesh_entity_transform = convert_coordinates.mesh_conversion_transform_inverse();
let mut mesh_entity = parent.spawn((
    Mesh3d(load_context.get_label_handle(primitive_label.to_string())),
    mesh_entity_transform,
));
```

### 3. `release-content/migration-guides/gltf-coordinate-conversion.md` (+96/-0)

This new file provides a comprehensive migration guide explaining:
- The change from `use_model_forward_direction` to `convert_coordinates`
- How to achieve similar behavior with the new options
- Scenarios where behavior might differ

### 4. `crates/bevy_gltf/src/lib.rs` (+7/-17)

Updated the plugin configuration to use the new `GltfConvertCoordinates` struct.

```rust
// Before: Single boolean flag
pub struct GltfPlugin {
    pub use_model_forward_direction: bool,
}

// After: Struct with separate options
pub struct GltfPlugin {
    pub convert_coordinates: GltfConvertCoordinates,
}
```

### 5. `crates/bevy_gltf/src/loader/gltf_ext/scene.rs` (+3/-15)

Simplified the `node_transform` function by removing coordinate conversion logic.

```rust
// Before: Node transform with conversion parameter
pub(crate) fn node_transform(node: &Node, convert_coordinates: bool) -> Transform {
    // Complex logic with special cases for cameras/lights
}

// After: Simple transform extraction
pub(crate) fn node_transform(node: &Node) -> Transform {
    // Just extracts the transform without conversion
}
```

## Further Reading

1. [glTF Specification - Coordinate System](https://registry.khronos.org/glTF/specs/2.0/glTF-2.0.html#coordinate-system-and-units)
2. [Bevy Transform Documentation](https://docs.rs/bevy/latest/bevy/transform/components/struct.Transform.html)
3. [Issue #20621: glTF coordinate conversion bugs](https://github.com/bevyengine/bevy/issues/20621)
4. [Original coordinate conversion PR (#19633)](https://github.com/bevyengine/bevy/pull/19633)