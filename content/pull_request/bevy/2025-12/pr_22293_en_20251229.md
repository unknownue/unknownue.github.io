+++
title = "#22293 bevy_input_focus: don't add nothing when no input is enabled"
date = "2025-12-29T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = true

[taxonomies]
list_display = ["show"]

[extra]
current_language = "en"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-12/pr-22293-en-20251229" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-12/pr-22293-zh-cn-20251229" }}
labels = ["C-Bug", "A-Input", "D-Straightforward"]
+++

# Title

## Basic Information
- **Title**: bevy_input_focus: don't add nothing when no input is enabled
- **PR Link**: https://github.com/bevyengine/bevy/pull/22293
- **Author**: mockersf
- **Status**: MERGED
- **Labels**: C-Bug, A-Input, S-Ready-For-Final-Review, D-Straightforward
- **Created**: 2025-12-28T21:09:46Z
- **Merged**: 2025-12-29T20:02:52Z
- **Merged By**: mockersf

## Description Translation
### Objective

- `cargo build --no-default-features --features bevy_input_focus` fails:
```
   Compiling bevy_input_focus v0.18.0-dev (/home/runner/work/bevy-releasability/bevy-releasability/crates/bevy_input_focus)
error[E0599]: no method named `in_set` found for unit type `()` in the current scope
   --> crates/bevy_input_focus/src/lib.rs:236:22
    |
228 | /                 (
229 | |                     #[cfg(feature = "keyboard")]
230 | |                     dispatch_focused_input::<KeyboardInput>,
231 | |                     #[cfg(feature = "gamepad")]
...   |
236 | |                     .in_set(InputFocusSystems::Dispatch),
    | |_____________________-^^^^^^
    |
```
- Introduced in #22177

### Solution

- Don't add an empty system tuple when no input feature is enabled

## The Story of This Pull Request

This PR addresses a build failure that occurs when compiling the `bevy_input_focus` crate with specific feature configurations. The issue is a regression introduced in PR #22177, and it manifests when users build Bevy with the command `cargo build --no-default-features --features bevy_input_focus`. The error message indicates that the compiler cannot find the method `in_set` for the unit type `()`, which points to a problematic system tuple construction.

Looking at the code, the problem stems from how conditional compilation is handled when registering systems in the `InputDispatchPlugin`. In the Bevy engine, systems are often grouped into tuples and scheduled in specific system sets. When using Rust's `#[cfg(feature = "...")]` attributes to conditionally include systems based on enabled features, there's a subtle edge case: if none of the conditional features are enabled, the entire tuple becomes empty, resulting in the unit type `()`. The unit type doesn't have an `in_set` method, causing the compilation error.

The previous implementation used individual `#[cfg]` attributes on each system within the tuple. While this approach works when at least one feature is enabled, it fails when all features are disabled because it attempts to call `.in_set()` on an empty tuple. This scenario occurs when building with `--no-default-features`, which disables all default features, and then explicitly enabling only the `bevy_input_focus` feature without any of its optional input dependencies (keyboard, gamepad, or mouse).

The solution implemented in this PR is straightforward: wrap the entire `app.add_systems` call for the input dispatch systems in a conditional compilation block that checks if **any** of the input features are enabled. This approach ensures that the problematic empty tuple is never constructed in the first place when no input features are available. The code only attempts to register systems and call `.in_set()` when there's at least one system to register.

Additionally, the PR optimizes the import statements by conditionally importing `bevy_app::PreUpdate` only when it's actually needed. This minor change prevents an unused import warning when no input features are enabled, demonstrating attention to code cleanliness alongside fixing the main issue.

The fix demonstrates an important pattern in Rust when working with conditional compilation and system registration in Bevy: always consider the edge case where all conditional elements might be disabled, and structure the code to handle that case gracefully. Instead of trying to register an empty system tuple, it's better to skip the registration entirely when there are no systems to add.

## Visual Representation

```mermaid
graph TD
    A[InputDispatchPlugin.build()] --> B{Any input features enabled?}
    B -->|Yes| C[Create system tuple with enabled systems]
    C --> D[Register tuple with .in_set(InputFocusSystems::Dispatch)]
    B -->|No| E[Skip system registration entirely]
```

## Key Files Changed

### `crates/bevy_input_focus/src/lib.rs` (+18/-14)

This is the only file modified in the PR. The changes fix the build failure by conditionally including the system registration code only when at least one input feature is enabled.

**Key Changes:**

1. **Conditional import optimization:**
```rust
// Before:
use bevy_app::{App, Plugin, PostStartup, PreUpdate};

// After:
#[cfg(any(feature = "keyboard", feature = "gamepad", feature = "mouse"))]
use bevy_app::PreUpdate;
use bevy_app::{App, Plugin, PostStartup};
```

2. **Conditional system registration:**
```rust
// Before:
app.add_systems(
    PreUpdate,
    (
        #[cfg(feature = "keyboard")]
        dispatch_focused_input::<KeyboardInput>,
        #[cfg(feature = "gamepad")]
        dispatch_focused_input::<GamepadButtonChangedEvent>,
        #[cfg(feature = "mouse")]
        dispatch_focused_input::<MouseWheel>,
    )
        .in_set(InputFocusSystems::Dispatch),
);

// After:
#[cfg(any(feature = "keyboard", feature = "gamepad", feature = "mouse"))]
app.add_systems(
    PreUpdate,
    (
        #[cfg(feature = "keyboard")]
        dispatch_focused_input::<KeyboardInput>,
        #[cfg(feature = "gamepad")]
        dispatch_focused_input::<GamepadButtonChangedEvent>,
        #[cfg(feature = "mouse")]
        dispatch_focused_input::<MouseWheel>,
    )
        .in_set(InputFocusSystems::Dispatch),
);
```

The fix works by wrapping the entire `app.add_systems` call in a conditional compilation block that checks if any of the input features (`keyboard`, `gamepad`, or `mouse`) are enabled. This prevents the creation of an empty system tuple when none of these features are available, which was causing the compilation error.

## Further Reading

1. **Rust Conditional Compilation**: The Rust Book section on conditional compilation with `#[cfg]` attributes: https://doc.rust-lang.org/reference/conditional-compilation.html
2. **Bevy Systems and Schedules**: Bevy's official documentation on systems and scheduling: https://bevyengine.org/learn/quick-start/ecs/system/
3. **Bevy Input Handling**: Overview of Bevy's input handling system: https://bevyengine.org/learn/quick-start/input/
4. **Rust Feature Flags**: Cargo documentation on feature flags and conditional compilation: https://doc.rust-lang.org/cargo/reference/features.html
5. **Previous PR #22177**: The PR that introduced this regression, which added input focus functionality to Bevy.