+++
title = "#22157 Revert \"Fix: Clears directional navigation map between rebuilds"
date = "2025-12-17T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = true

[taxonomies]
list_display = ["show"]

[extra]
current_language = "en"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-12/pr-22157-en-20251217" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-12/pr-22157-zh-cn-20251217" }}
labels = ["C-Bug", "A-UI", "P-Regression"]
+++

# Title
Revert "Fix: Clears directional navigation map between rebuilds"

## Basic Information
- **Title**: Revert "Fix: Clears directional navigation map between rebuilds 
- **PR Link**: https://github.com/bevyengine/bevy/pull/22157
- **Author**: alice-i-cecile
- **Status**: MERGED
- **Labels**: C-Bug, A-UI, P-Regression, S-Needs-Review
- **Created**: 2025-12-17T00:23:13Z
- **Merged**: 2025-12-17T02:49:54Z
- **Merged By**: cart

## Description Translation
This reverts commit 545a97d67cdb87237e0bc5f02ecd17ec7e4b5c24, aka #22124.

# Objective

The cure was worse than the disease: losing manual edges is worse than being wrong with redraws.

Fixes #22136.

## Solution

 For now, we'll revert, then we'll look for a better solution. For now, users can get this behavior by manually calling [`clear`](https://docs.rs/bevy/latest/bevy/input_focus/directional_navigation/struct.DirectionalNavigationMap.html#method.clear).

Reopens #21949.

## The Story of This Pull Request

This PR is a straightforward revert of a previous change that introduced a regression. The core issue revolves around the management of a directional navigation map in Bevy's UI system. This map stores connections (edges) between UI elements to define navigation order, like moving focus from one button to another using arrow keys.

The original problem, reported in issue #21949, was that the navigation graph could retain stale edges after UI rebuilds. When entities were removed, their corresponding navigation edges weren't being cleaned up, which could lead to incorrect navigation behavior.

The attempted fix in PR #22124 was to clear the entire `DirectionalNavigationMap` before each automatic rebuild by calling its `clear()` method. This approach ensured that any edges from removed entities would be pruned. The change was minimal, adding just two lines to the `auto_rebuild_ui_navigation_graph` function:

```rust
// clear the old nav map between rebuilds to ensure any removed entities' edges are pruned
directional_nav_map.clear();
```

However, this solution had a significant unintended consequence: it also cleared all manually added edges. The UI navigation system supports both automatic edge generation and manual edge addition. Developers use manual edges to define custom navigation flows that the automatic algorithm might not capture correctly. Clearing the entire map on every rebuild meant that any manual configuration was lost, forcing developers to re-add their custom edges constantly. This regression was reported in issue #22136.

The developer faced a classic engineering trade-off. The initial fix solved the cleanup problem but broke an important feature. The decision was to revert the change because, in their assessment, "losing manual edges is worse than being wrong with redraws." The temporary performance or correctness issue from stale edges was deemed less severe than the broken functionality for developers who rely on manual navigation configuration.

The revert removes the `clear()` call, restoring the previous behavior where manual edges persist across rebuilds, but stale edges from removed entities may remain. As noted in the PR description, developers who need the clearing behavior can manually call `directional_nav_map.clear()` when appropriate for their use case.

This situation highlights a common challenge in systems that mix automatic and manual configuration. The automatic rebuild process needs to be aware of which parts of the data structure it owns versus which parts are user-managed. A more sophisticated solution would be required to only clear the automatically generated edges while preserving manual ones, likely involving tracking the origin of each edge. The PR author indicates they will "look for a better solution" after the revert, acknowledging that the current state is a temporary compromise.

## Visual Representation

```mermaid
graph TD
    A[Issue #21949: Stale navigation edges persist] --> B[PR #22124: Add clear() before rebuild]
    B --> C[Regression #22136: Manual edges are lost]
    C --> D[This PR #22157: Revert clear() call]
    D --> E[Restores manual edge persistence]
    D --> F[Reopens issue #21949]
    F --> G[Future: Need smarter edge management]
```

## Key Files Changed

- `crates/bevy_input_focus/src/directional_navigation.rs` (+0/-2)

This file contains the system that automatically rebuilds the UI navigation graph. The change removes two lines that were clearing the entire directional navigation map before each rebuild.

**Before the revert:**
```rust
// clear the old nav map between rebuilds to ensure any removed entities' edges are pruned
directional_nav_map.clear();
auto_generate_navigation_edges(&mut directional_nav_map, &nodes, &config);
```

**After the revert:**
```rust
auto_generate_navigation_edges(&mut directional_nav_map, &nodes, &config);
```

The removal of the `clear()` call means the `auto_generate_navigation_edges` function now operates on a map that may contain:
1. Previously automatically generated edges (some potentially stale)
2. Manually added edges (which should be preserved)

The automatic generation function will overwrite automatic edges but leave manual edges intact. However, the downside is that edges for removed entities won't be cleaned up unless the automatic regeneration happens to overwrite them.

## Further Reading

- [Bevy UI Navigation Documentation](https://docs.rs/bevy/latest/bevy/ui/focus/index.html) - Overview of Bevy's focus and navigation system
- [DirectionalNavigationMap API](https://docs.rs/bevy/latest/bevy/input_focus/directional_navigation/struct.DirectionalNavigationMap.html) - Details on the navigation map structure and methods
- [Issue #21949](https://github.com/bevyengine/bevy/issues/21949) - Original issue about stale navigation edges
- [Issue #22136](https://github.com/bevyengine/bevy/issues/22136) - Regression report about lost manual edges
- [PR #22124](https://github.com/bevyengine/bevy/pull/22124) - The original fix that introduced the `clear()` call