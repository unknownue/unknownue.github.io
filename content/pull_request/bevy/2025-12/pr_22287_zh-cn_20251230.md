+++
title = "#22287 Solari: Fix indirect shadows"
date = "2025-12-30T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = false

[extra]
current_language = "zh-cn"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-12/pr-22287-en-20251230" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-12/pr-22287-zh-cn-20251230" }}
+++

# Title: Solari: Fix indirect shadows

## 基本资料
- **标题**: Solari: Fix indirect shadows
- **PR链接**: https://github.com/bevyengine/bevy/pull/22287
- **作者**: JMS55
- **状态**: 已合并
- **标签**: A-Rendering, S-Ready-For-Review, C-Refinement
- **创建时间**: 2025-12-27T17:48:15Z
- **合并时间**: 2025-12-30T01:37:46Z
- **合并者**: alice-i-cecile

## 描述翻译
这是对resampling（重采样）所做的一系列与DI（直接光照）相同的更改，但现在应用于GI（全局光照）。

实际上，这相当于撤销了 https://github.com/bevyengine/bevy/pull/21919。

我之前遗漏的一点是，我将可见性测试应用到了储水器（reservoir）的辐射度（radiance）上，而不是UCW（Unbiased Contribution Weight，无偏贡献权重）上，这是错误的。

## 关于此PR的说明

本次PR的核心是修复了Solari渲染器中ReSTIR GI（一种高效的实时全局光照算法）在处理间接阴影时的一个错误。这个错误的本质是对算法的理论理解出现偏差，导致代码将可见性测试应用在了错误的计算环节上。

**问题与背景**
在之前的PR #21919中，开发者尝试对GI进行空间重采样（spatial resampling）优化。ReSTIR算法的核心是使用储水器采样（Reservoir Sampling）来复用邻近像素的光照信息。在进行空间重采样时（即`load_spatial_reservoir`函数），需要从邻近像素加载一个候选的储水器（reservoir），并评估它对本像素的贡献。这里有一个关键的步骤：需要检查从本像素表面点到候选采样点之间的可见性（visibility）。如果两点间被遮挡，那么这个候选样本就不能用于计算当前像素的间接光照。

问题在于，之前PR #21919在`load_spatial_reservoir`函数中错误地将可见性测试因子乘到了储水器存储的`radiance`（辐射度）值上。从算法原理上讲，储水器中存储的`radiance`应是一个与当前观察点无关的固有属性。可见性影响的是这个样本对最终像素贡献的“权重”，而不是样本自身的辐射值。具体来说，应该影响的是储水器的`unbiased_contribution_weight`（UCW，无偏贡献权重）。将这个因子错误地应用在`radiance`上，会导致后续的合并与权重计算基于被错误修正过的辐射值进行，从而破坏了ReSTIR算法的无偏性保证，产生了不正确的间接阴影效果。

**解决方案**
修复方法很直接：将可见性测试从错误的`radiance`乘算步骤中移除，并将其应用到正确的地方——即储水器合并后的`unbiased_contribution_weight`上。

首先，在`load_spatial_reservoir`函数中，移除了对`spatial_reservoir.radiance`乘算可见性的代码行。现在这个函数只是简单地加载邻居的储水器数据，不做修改。
```wgsl
// 修改前（错误）:
var spatial_reservoir = gi_reservoirs_b[spatial_pixel_index];
spatial_reservoir.radiance *= trace_point_visibility(world_position, spatial_reservoir.sample_point_world_position); // 错误地在这里应用

// 修改后（正确）:
let spatial_reservoir = gi_reservoirs_b[spatial_pixel_index]; // 直接加载，不修改radiance
```

然后，在`spatial_and_shade`函数的主流程中，当完成了本帧储水器（`input_reservoir`）与空间邻居储水器（`spatial.reservoir`）的合并，得到`combined_reservoir`之后，再对其`unbiased_contribution_weight`应用可见性测试。
```wgsl
// 新增的代码行:
combined_reservoir.unbiased_contribution_weight *= trace_point_visibility(surface.world_position, combined_reservoir.sample_point_world_position);
```
这个操作的位置被巧妙地放置在两个条件编译分支之间，这引出了本次修复的另一个重要方面：**权衡精度与稳定性**。

**实现细节与技术权衡**
开发者引入了条件编译选项 `BIASED_RESAMPLING` 来让用户选择不同的重采样策略，这体现了对渲染质量与性能/稳定性之间权衡的精细控制。
1.  **无偏路径 (`#ifndef BIASED_RESAMPLING`)**: 这是默认的、更精确的路径。它先将合并后的储水器写入缓冲区，然后对其权重应用可见性测试。这意味着后续的临时邻居（temporal neighbor）在加载此像素的储水器进行重采样时，使用的是**未经过可见性修正的权重**。这保证了算法在理论上的无偏性，但可能导致权重方差较大，从而在阴影边缘产生更多噪点或不稳定（闪烁）。
2.  **有偏路径 (`#ifdef BIASED_RESAMPLING`)**: 这是更稳定的路径。它先对合并后储水器的权重应用可见性测试，**然后再**将结果写入缓冲区。这意味着临时邻居加载到的已经是经过可见性修正的权重。这样做实际上将可见性信息“传播”给了邻居像素，使得阴影区域更加平滑、稳定，但代价是引入了偏差（bias）——阴影可能会比实际情况更“长”或更“软”，正如代码注释所写：“More stability, less accuracy (shadows extend further out than they should)”。

**影响与总结**
这个修复纠正了一个根本性的算法实现错误，使得ReSTIR GI能够产生物理上更准确的间接阴影。同时，通过提供`BIASED_RESAMPLING`选项，赋予了开发者在“精确但可能有噪点”和“稳定但略有偏差”的渲染结果之间进行选择的能力。这种选择在实时渲染中非常常见，是平衡视觉质量与性能/稳定性的实用手段。

从代码修改量来看，这是一个小而关键的修复。它凸显了在实现复杂的图形学论文算法时，对算法每个变量的物理意义和数学关系必须有极其精确的理解。一个看似简单的乘法操作放在错误的位置，就会导致整个光照计算结果的谬误。

## 视觉表示

```mermaid
graph TD
    subgraph “修复前（错误流程）”
        A[加载空间邻居储水器] --> B{应用可见性测试到 radiance};
        B --> C[合并储水器];
        C --> D[计算最终光照];
    end

    subgraph “修复后（正确流程）”
        E[加载空间邻居储水器] --> F[合并储水器];
        F --> G{应用可见性测试到 UCW};
        G --> H[写入储水器<br/>（无偏路径）];
        G --> I[写入储水器<br/>（有偏路径）];
        H --> J[计算最终光照];
        I --> J;
    end

    style B fill:#f99
    style G fill:#9f9
```

## 主要文件变更

**`crates/bevy_solari/src/realtime/restir_gi.wgsl` (+12/-5)**

这是本次PR唯一修改的文件，包含了修复间接阴影处理错误的全部逻辑。

1.  **变更描述**：修正了在空间重采样（`load_spatial_reservoir`）中错误应用可见性测试的问题，并将其移至正确的合并后处理阶段。同时引入了条件编译选项来控制可见性测试的应用时机，以在无偏（精确）和有偏（稳定）的重采样策略间进行选择。

2.  **关键代码片段**：

    **在 `load_spatial_reservoir` 函数中，移除错误操作：**
    ```wgsl
    // 之前:
    //        var spatial_reservoir = gi_reservoirs_b[spatial_pixel_index];
    //        spatial_reservoir.radiance *= trace_point_visibility(world_position, spatial_reservoir.sample_point_world_position);
    //        return NeighborInfo(spatial_reservoir, ...);

    // 之后:
            let spatial_reservoir = gi_reservoirs_b[spatial_pixel_index];
            return NeighborInfo(spatial_reservoir, spatial_surface.world_position, spatial_surface.world_normal, spatial_diffuse_brdf);
    ```
    *修改说明：不再修改加载出来的`spatial_reservoir`的`radiance`值。*

    **在 `spatial_and_shade` 函数中，在正确的位置应用可见性测试并添加策略选择：**
    ```wgsl
        var combined_reservoir = merge_result.merged_reservoir;

        // 更高精度，更低稳定性
    #ifndef BIASED_RESAMPLING
        gi_reservoirs_a[pixel_index] = combined_reservoir;
    #endif

        combined_reservoir.unbiased_contribution_weight *= trace_point_visibility(surface.world_position, combined_reservoir.sample_point_world_position);

        // 更高稳定性，更低精度（阴影会比实际延伸得更远）
    #ifdef BIASED_RESAMPLING
        gi_reservoirs_a[pixel_index] = combined_reservoir;
    #endif
    ```
    *修改说明：核心修复是将可见性乘算移到了`combined_reservoir.unbiased_contribution_weight`上。通过`#ifdef`控制储水器的写入时机，实现了两种重采样策略。*

3.  **与PR目标的关联**：这些修改直接解决了PR描述中指出的问题——将可见性测试从`radiance`错误地应用，更正为应用到`unbiased_contribution_weight`（UCW）上，从而修复了间接阴影的计算。

## 扩展阅读

*   **原始论文**: 《Spatiotemporal reservoir resampling for real-time ray tracing with dynamic direct lighting》(2020)。这是ReSTIR算法的奠基性论文，理解其中的储水器采样、权重合并（`CombineReservoirs`）以及无偏贡献权重（`W`）的概念是理解本PR修改的基础。
*   **Bevy PR #21919**: https://github.com/bevyengine/bevy/pull/21919。本PR撤销了此PR中的错误修改。对比阅读可以更清楚地理解错误是如何引入以及为何需要修复。
*   **Bevy Solari 模块文档**: 了解Bevy中Solari全局光照系统的整体架构和配置选项，有助于理解这个WGSL着色器在完整渲染管线中的作用。
*   **图形学中的偏差（Bias）与方差（Variance）**: 这是一个在实时渲染、特别是蒙特卡洛方法中永恒的主题。本PR中的`BIASED_RESAMPLING`选项正是这一权衡的具体体现。