+++
title = "#21237 Easy screenrecording plugin"
date = "2025-12-15T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = false

[extra]
current_language = "zh-cn"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-12/pr-21237-en-20251215" }, "zh-cn" = { name = "ä¸­æ–‡", url = "/pull_request/bevy/2025-12/pr-21237-zh-cn-20251215" }}
+++

# Easy screenrecording plugin

## åŸºæœ¬ä¿¡æ¯
- **æ ‡é¢˜**: Easy screenrecording plugin
- **PRé“¾æ¥**: https://github.com/bevyengine/bevy/pull/21237
- **ä½œè€…**: mockersf
- **çŠ¶æ€**: å·²åˆå¹¶
- **æ ‡ç­¾**: C-Feature, S-Ready-For-Final-Review, M-Release-Note, A-Dev-Tools
- **åˆ›å»ºæ—¶é—´**: 2025-09-27T01:53:38Z
- **åˆå¹¶æ—¶é—´**: 2025-12-15T01:23:05Z
- **åˆå¹¶è€…**: alice-i-cecile

## æè¿°ç¿»è¯‘

# ç›®æ ‡

- #21235çš„åç»­å·¥ä½œ
- æŸ¥çœ‹ https://github.com/mockersf/bevy/compare/easy-screenshots...mockersf:bevy:easy-screenrecording äº†è§£æ–°å¢å†…å®¹
- èƒ½å¤Ÿä»¥ä¸€è‡´çš„æ–¹å¼ä»Bevyå½•åˆ¶è§†é¢‘

## è§£å†³æ–¹æ¡ˆ

- åœ¨å¼€å‘å·¥å…·ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„ `EasyScreenRecordPlugin`

## æµ‹è¯•

- æ·»åŠ åˆ°ä»»ä½•ç¤ºä¾‹ä¸­
```
        .add_plugins(bevy::dev_tools::EasyScreenRecordPlugin::default())
```
- å¯ç”¨ `bevy_internal/screenrecording` åŠŸèƒ½è¿è¡Œç¤ºä¾‹
- æŒ‰ä¸‹ç©ºæ ¼é”®
- ç­‰å¾…...
- å†æ¬¡æŒ‰ä¸‹ç©ºæ ¼é”®
- å±å¹•å½•åˆ¶å®Œæˆï¼ğŸ‰
- å·®ä¸å¤š... ä½ ç°åœ¨æœ‰äº†ä¸€ä¸ªh264æ–‡ä»¶ã€‚VLCå¯ä»¥è¯»å–å®ƒä»¬ï¼Œä½†è¿™ä¸æ˜¯æœ€å‹å¥½çš„æ ¼å¼
- `ffmpeg` æ˜¯æˆ‘ä»¬çš„æœ‹å‹ï¼`for file in *.h264; do ffmpeg -i $file $file.mp4; done`
- ä½ ç°åœ¨æœ‰äº†ä¸€ä¸ªå¯ä»¥åˆ†äº«åˆ°ä»»ä½•åœ°æ–¹çš„.mp4æ–‡ä»¶ï¼

---

## å±•ç¤º

ç”±Bevyç›´æ¥å½•åˆ¶

https://github.com/user-attachments/assets/217f5093-9443-40e5-b2ce-33f65f6a56c6

## è¿™ä¸ªPull Requestçš„æ•…äº‹

è¿™ä¸ªPRè§£å†³äº†Bevyæ¸¸æˆä¸­éœ€è¦ç®€ä¾¿å½•åˆ¶è§†é¢‘çš„é—®é¢˜ã€‚å¼€å‘è€…ç»å¸¸éœ€è¦åˆ›å»ºæ¼”ç¤ºè§†é¢‘æˆ–è¥é”€ææ–™ï¼Œä½†ä¹‹å‰Bevyåªæä¾›äº†æˆªå›¾åŠŸèƒ½ï¼Œå½•åˆ¶è§†é¢‘éœ€è¦å¤–éƒ¨å·¥å…·æˆ–å¤æ‚çš„é›†æˆã€‚

### é—®é¢˜ä¸èƒŒæ™¯

Bevyä»0.11ç‰ˆæœ¬å¼€å§‹æ”¯æŒæˆªå›¾åŠŸèƒ½ï¼Œä½†è§†é¢‘å½•åˆ¶ä¸€ç›´æ˜¯ä¸€ä¸ªç¼ºå¤±çš„åŠŸèƒ½ã€‚ç”¨æˆ·éœ€è¦ä¾èµ–å¤–éƒ¨å±å¹•å½•åˆ¶è½¯ä»¶ï¼Œè¿™ä¼šå¯¼è‡´å‡ ä¸ªé—®é¢˜ï¼šå½•åˆ¶è´¨é‡ä¸ä¸€è‡´ã€å¯èƒ½å½±å“æ€§èƒ½ã€éœ€è¦é¢å¤–çš„é…ç½®æ­¥éª¤ï¼Œå¹¶ä¸”åœ¨ä¸åŒçš„å¼€å‘ç¯å¢ƒä¸­å¯èƒ½æœ‰å…¼å®¹æ€§é—®é¢˜ã€‚

PR #21235 ä¸ºæˆªå›¾åŠŸèƒ½æ·»åŠ äº†`EasyScreenshotPlugin`ï¼Œä¸ºè§†é¢‘å½•åˆ¶åŠŸèƒ½é“ºå¹³äº†é“è·¯ã€‚è¿™ä¸ªPRåœ¨æ­¤åŸºç¡€ä¸Šæ‰©å±•ï¼Œæä¾›ç±»ä¼¼çš„æ˜“ç”¨æ€§æ¥å½•åˆ¶è§†é¢‘ã€‚

### è§£å†³æ–¹æ¡ˆæ€è·¯

ä½œè€…é‡‡ç”¨äº†ä»¥ä¸‹æŠ€æœ¯æ–¹æ¡ˆï¼š
1. ä½¿ç”¨Bevyç°æœ‰çš„æˆªå›¾ç³»ç»Ÿä½œä¸ºè§†é¢‘å¸§çš„æ¥æº
2. ä½¿ç”¨x264ç¼–ç å™¨è¿›è¡Œé«˜æ•ˆçš„è§†é¢‘ç¼–ç 
3. å°†ç¼–ç æ“ä½œæ”¾åœ¨å•ç‹¬çº¿ç¨‹ä¸­ï¼Œé¿å…é˜»å¡æ¸¸æˆä¸»å¾ªç¯
4. æä¾›ç®€å•çš„APIï¼šæŒ‰ä¸‹ç©ºæ ¼é”®å¼€å§‹/åœæ­¢å½•åˆ¶

å…³é”®çš„å·¥ç¨‹å†³ç­–åŒ…æ‹¬ï¼š
- é€‰æ‹©h.264ä½œä¸ºç¼–ç æ ¼å¼ï¼Œå› ä¸ºå®ƒå…·æœ‰å¹¿æ³›çš„æ”¯æŒå’Œè‰¯å¥½çš„å‹ç¼©ç‡
- å°†ç¼–ç çº¿ç¨‹ä¸æ¸¸æˆçº¿ç¨‹åˆ†ç¦»ï¼Œç¡®ä¿å½•åˆ¶ä¸å½±å“æ¸¸æˆæ€§èƒ½
- ä½¿ç”¨æ¡ä»¶ç¼–è¯‘ï¼ˆ`#[cfg(feature = "screenrecording")]`ï¼‰å°†åŠŸèƒ½è®¾ä¸ºå¯é€‰ï¼Œé¿å…ä¸éœ€è¦æ­¤åŠŸèƒ½çš„ç”¨æˆ·å¢åŠ ä¾èµ–

### å®ç°ç»†èŠ‚

æ ¸å¿ƒå®ç°åœ¨`easy_screenshot.rs`æ–‡ä»¶ä¸­ï¼Œæ·»åŠ äº†`EasyScreenRecordPlugin`ç»“æ„ä½“ã€‚è¿™ä¸ªæ’ä»¶çš„ä¸»è¦å·¥ä½œæµç¨‹æ˜¯ï¼š

```rust
// å½“ç”¨æˆ·æŒ‰ä¸‹ç©ºæ ¼é”®æ—¶ï¼Œè§¦å‘å½•åˆ¶å¼€å§‹/åœæ­¢
.run_if(input_just_pressed(self.toggle))
```

å½•åˆ¶è¿‡ç¨‹ä½¿ç”¨å•ç‹¬çš„çº¿ç¨‹å¤„ç†ç¼–ç ï¼š

```rust
std::thread::spawn(move || {
    let mut encoder: Option<Encoder> = None;
    let mut setup = None;
    let mut file: Option<File> = None;
    // ... ç¼–ç é€»è¾‘
});
```

æ’ä»¶ä½¿ç”¨Bevyçš„æ¶ˆæ¯ç³»ç»Ÿï¼ˆ`MessageWriter`å’Œ`MessageReader`ï¼‰æ¥æ§åˆ¶å½•åˆ¶çŠ¶æ€ï¼š

```rust
enum RecordScreen {
    /// Starts screen recording
    Start,
    /// Stops screen recording
    Stop,
}
```

å¯¹äºæ¯ä¸€å¸§ï¼Œæ’ä»¶é€šè¿‡æˆªå›¾ç³»ç»Ÿè·å–å½“å‰å±å¹•å›¾åƒï¼Œç„¶åå‘é€åˆ°ç¼–ç çº¿ç¨‹ï¼š

```rust
commands.spawn(Screenshot::primary_window()).observe(
    move |screenshot_captured: On<ScreenshotCaptured>,
          mut virtual_time: ResMut<Time<bevy_time::Virtual>>,
          mut time: ResMut<Time<()>>| {
        let img = screenshot_captured.image.clone();
        tx.send(RecordCommand::Frame(img)).unwrap();
        virtual_time.advance_by(frame_time);
        *time = virtual_time.as_generic();
    },
);
```

ä¸€ä¸ªé‡è¦çš„æŠ€æœ¯ç»†èŠ‚æ˜¯æ—¶é—´æ§åˆ¶ï¼šå½•åˆ¶æ—¶éœ€è¦ç²¾ç¡®æ§åˆ¶å¸§ç‡ã€‚æ’ä»¶ä½¿ç”¨è™šæ‹Ÿæ—¶é—´ï¼ˆ`Virtual` timeï¼‰æ¥ç¡®ä¿å½•åˆ¶çš„å¸§ç‡ä¸€è‡´ï¼š

```rust
virtual_time.advance_by(frame_time);
*time = virtual_time.as_generic();
```

### æŠ€æœ¯æ´å¯Ÿ

è¿™ä¸ªå®ç°æœ‰å‡ ä¸ªå€¼å¾—æ³¨æ„çš„æŠ€æœ¯ç‚¹ï¼š

1. **çº¿ç¨‹å®‰å…¨çš„è®¾è®¡**ï¼šç¼–ç æ“ä½œåœ¨å•ç‹¬çº¿ç¨‹ä¸­è¿›è¡Œï¼Œé€šè¿‡channelï¼ˆé€šé“ï¼‰åœ¨ä¸»çº¿ç¨‹å’Œç¼–ç çº¿ç¨‹ä¹‹é—´é€šä¿¡ã€‚è¿™é¿å…äº†é˜»å¡æ¸¸æˆå¾ªç¯ã€‚

2. **æ¡ä»¶ç¼–è¯‘**ï¼šæ•´ä¸ªåŠŸèƒ½é€šè¿‡`#[cfg(feature = "screenrecording")]`å±æ€§ä¿æŠ¤ï¼Œç”¨æˆ·å¯ä»¥é€‰æ‹©æ˜¯å¦åŒ…å«æ­¤åŠŸèƒ½ï¼Œé¿å…ä¸å¿…è¦çš„ä¾èµ–ã€‚

3. **çµæ´»çš„é…ç½®**ï¼šæ’ä»¶æä¾›äº†å¤šä¸ªå¯é…ç½®é€‰é¡¹ï¼š
   ```rust
   pub struct EasyScreenRecordPlugin {
       pub toggle: KeyCode,      // è§¦å‘é”®
       pub preset: Preset,       // h264ç¼–ç é¢„è®¾
       pub tune: Tune,           // h264è°ƒä¼˜å‚æ•°
       pub frame_time: Duration, // ç›®æ ‡å¸§æ—¶é—´
   }
   ```

4. **ä¸ç°æœ‰ç³»ç»Ÿçš„é›†æˆ**ï¼šæ’ä»¶é‡ç”¨Bevyçš„æˆªå›¾ç³»ç»Ÿï¼ˆ`Screenshot`ç»„ä»¶å’Œ`ScreenshotCaptured`äº‹ä»¶ï¼‰ï¼Œè¿™å‡å°‘äº†ä»£ç é‡å¤å¹¶ç¡®ä¿ä¸ç°æœ‰åŠŸèƒ½çš„å…¼å®¹æ€§ã€‚

### å½±å“

è¿™ä¸ªPRä¸ºBevyç”Ÿæ€ç³»ç»Ÿå¸¦æ¥äº†å‡ ä¸ªé‡è¦æ”¹è¿›ï¼š

1. **å¼€å‘è€…ä½“éªŒæå‡**ï¼šå¼€å‘è€…ç°åœ¨å¯ä»¥è½»æ¾å½•åˆ¶é«˜è´¨é‡çš„æ¸¸æˆè§†é¢‘ï¼Œæ— éœ€å¤–éƒ¨å·¥å…·ã€‚
2. **ä¸€è‡´æ€§ä¿è¯**ï¼šç”±äºå½•åˆ¶ç›´æ¥åœ¨æ¸¸æˆå¼•æ“å†…éƒ¨è¿›è¡Œï¼Œå¯ä»¥ç¡®ä¿è§†é¢‘è´¨é‡çš„ä¸€è‡´æ€§å’Œå¯é‡å¤æ€§ã€‚
3. **æ€§èƒ½è€ƒè™‘**ï¼šç¼–ç åœ¨å•ç‹¬çº¿ç¨‹ä¸­è¿›è¡Œï¼Œæœ€å°åŒ–äº†å¯¹æ¸¸æˆæ€§èƒ½çš„å½±å“ã€‚
4. **æ‰©å±•æ€§**ï¼šè¿™ä¸ªå®ç°ä¸ºæœªæ¥çš„è§†é¢‘å½•åˆ¶åŠŸèƒ½æ‰©å±•å¥ å®šäº†åŸºç¡€ï¼Œå¦‚æ·»åŠ éŸ³é¢‘å½•åˆ¶ã€ä¸åŒç¼–ç æ ¼å¼æ”¯æŒç­‰ã€‚

è¿™ä¸ªPRæ˜¯Bevyå¼€å‘å·¥å…·é›†çš„é‡è¦è¡¥å……ï¼Œç‰¹åˆ«æ˜¯å¯¹äºé‚£äº›éœ€è¦åˆ›å»ºæ¼”ç¤ºã€æ•™ç¨‹æˆ–è¥é”€ææ–™çš„å¼€å‘è€…æ¥è¯´éå¸¸æœ‰ç”¨ã€‚

## å¯è§†åŒ–è¡¨ç¤º

```mermaid
graph TB
    A[EasyScreenRecordPlugin] --> B[æˆªå›¾ç³»ç»Ÿ]
    A --> C[ç¼–ç çº¿ç¨‹]
    A --> D[æ—¶é—´æ§åˆ¶ç³»ç»Ÿ]
    B --> E[è·å–å±å¹•å›¾åƒ]
    C --> F[x264ç¼–ç å™¨]
    C --> G[å†™å…¥H264æ–‡ä»¶]
    E --> C
    D --> H[æ§åˆ¶å¸§ç‡]
    F --> G
```

## å…³é”®æ–‡ä»¶å˜æ›´

### `crates/bevy_dev_tools/src/easy_screenshot.rs` (+192/-0)
è¿™ä¸ªæ–‡ä»¶æ·»åŠ äº†`EasyScreenRecordPlugin`çš„å®ç°ã€‚å…³é”®å˜åŒ–åŒ…æ‹¬ï¼š
1. æ–°çš„`EasyScreenRecordPlugin`ç»“æ„ä½“å’Œç›¸å…³ç±»å‹å®šä¹‰
2. ç¼–ç çº¿ç¨‹çš„å®ç°
3. ä¸Bevyç”Ÿæ€ç³»ç»Ÿçš„é›†æˆé€»è¾‘

```rust
// æ–°å¢ï¼šEasyScreenRecordPlugin ç»“æ„ä½“å®šä¹‰
pub struct EasyScreenRecordPlugin {
    pub toggle: KeyCode,
    pub preset: Preset,
    pub tune: Tune,
    pub frame_time: Duration,
}

// æ–°å¢ï¼šç¼–ç çº¿ç¨‹çš„æ ¸å¿ƒé€»è¾‘
std::thread::spawn(move || {
    let mut encoder: Option<Encoder> = None;
    let mut setup = None;
    let mut file: Option<File> = None;
    let mut frame = 0;
    loop {
        let Ok(next) = rx.recv() else {
            break;
        };
        match next {
            RecordCommand::Start(name, preset, tune) => {
                // å¼€å§‹å½•åˆ¶
            }
            // ... å…¶ä»–å‘½ä»¤å¤„ç†
        }
    }
});
```

### `release-content/release-notes/easy_marketing_material.md` (+9/-0)
æ–°å¢çš„å‘å¸ƒè¯´æ˜æ–‡æ¡£ï¼Œè¯´æ˜äº†è¿™ä¸ªåŠŸèƒ½çš„ä½¿ç”¨æ–¹æ³•å’Œç›®çš„ã€‚

### `.github/actions/install-linux-deps/action.yml` (+5/-0)
æ›´æ–°äº†CIé…ç½®ï¼Œæ·»åŠ x264ä¾èµ–å®‰è£…ï¼š
```yaml
x264:
  description: Install x264 (libx264-dev)
  required: false
  default: "false"
```

### `crates/bevy_dev_tools/Cargo.toml` (+3/-0)
æ·»åŠ äº†x264ä¾èµ–å’Œscreenrecordingç‰¹æ€§ï¼š
```toml
[features]
bevy_ci_testing = ["serde", "ron"]
+screenrecording = ["x264"]

[dependencies]
+x264 = { version = "0.5.0", optional = true }
```

### `.github/workflows/ci.yml` (+2/-0)
åœ¨CIå·¥ä½œä¸­å¯ç”¨äº†x264ä¾èµ–ï¼š
```yaml
- name: Install dependencies (Linux)
  uses: ./.github/actions/install-linux-deps
  with:
    wayland: true
    xkb: true
+   x264: true
```

## è¿›ä¸€æ­¥é˜…è¯»

1. **H.264ç¼–ç æ ‡å‡†**: äº†è§£è¿™ä¸ªå¹¿æ³›ä½¿ç”¨çš„è§†é¢‘ç¼–ç æ ‡å‡†
2. **Bevyæˆªå›¾ç³»ç»Ÿ**: é˜…è¯»Bevyå®˜æ–¹æ–‡æ¡£ä¸­å…³äº`Screenshot`ç»„ä»¶å’Œ`ScreenshotCaptured`äº‹ä»¶çš„éƒ¨åˆ†
3. **Rustä¸­çš„çº¿ç¨‹é€šä¿¡**: å­¦ä¹ `std::sync::mpsc::channel`çš„ä½¿ç”¨å’Œå¤šçº¿ç¨‹ç¼–ç¨‹æœ€ä½³å®è·µ
4. **Bevyæ’ä»¶ç³»ç»Ÿ**: ç†è§£å¦‚ä½•åˆ›å»ºå’Œé…ç½®Bevyæ’ä»¶
5. **FFmpegå·¥å…·**: äº†è§£å¦‚ä½•ä½¿ç”¨FFmpegè½¬æ¢è§†é¢‘æ ¼å¼ï¼Œå¦‚å°†H.264è½¬æ¢ä¸ºMP4