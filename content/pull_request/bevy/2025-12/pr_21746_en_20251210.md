+++
title = "#21746 Upgrade to wgpu 27 and associated crates"
date = "2025-12-10T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = true

[taxonomies]
list_display = ["show"]

[extra]
current_language = "en"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-12/pr-21746-en-20251210" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-12/pr-21746-zh-cn-20251210" }}
labels = ["A-Rendering", "C-Dependencies", "X-Contentious"]
+++

# Title: Upgrade to wgpu 27 and associated crates

## Basic Information
- **Title**: Upgrade to wgpu 27 and associated crates
- **PR Link**: https://github.com/bevyengine/bevy/pull/21746
- **Author**: JMS55
- **Status**: MERGED
- **Labels**: A-Rendering, C-Dependencies, S-Ready-For-Final-Review, X-Contentious
- **Created**: 2025-11-05T02:01:39Z
- **Merged**: 2025-12-10T07:51:33Z
- **Merged By**: mockersf

## Description Translation
Supersedes https://github.com/bevyengine/bevy/pull/21725.

## The Story of This Pull Request

The PR begins with a straightforward but significant task: updating Bevy's core graphics dependencies from wgpu 26 to wgpu 27. While version bumps are common, this particular upgrade introduces several breaking API changes that require careful attention throughout the rendering stack. The author, JMS55, addresses these changes systematically, focusing on maintaining functionality while adapting to the new API surface.

The core challenge is that wgpu 27 introduces API changes that affect multiple areas of Bevy's rendering system. These changes aren't just cosmetic—they touch fundamental operations like buffer mapping, shader module creation, and device limits configuration. The implementation needs to handle these breaking changes while preserving existing behavior.

One significant change involves how Bevy handles device polling for buffer operations. In wgpu 26, the code used `PollType::Wait`, but wgpu 27 introduces a new method-based approach. This change appears in two locations: Tracy GPU profiling and headless rendering examples. The migration is straightforward but requires attention to detail:

```rust
// Before (wgpu 26):
device.poll(PollType::Wait)

// After (wgpu 27):
device.poll(PollType::wait_indefinitely())
```

Another important change affects the dynamic uniform buffer writer system. The wgpu 27 API removes lifetime parameters from `QueueWriteBufferView`, which simplifies the code by eliminating lifetime management complexity. The implementation adapts by removing the lifetime parameter from `DynamicUniformBufferWriter` and its associated wrapper:

```rust
// Before (wgpu 26):
pub struct DynamicUniformBufferWriter<'a, T> {
    buffer: encase::DynamicUniformBuffer<QueueWriteBufferViewWrapper<'a>>,
    _marker: PhantomData<fn() -> T>,
}

// After (wgpu 27):
pub struct DynamicUniformBufferWriter<T> {
    buffer: encase::DynamicUniformBuffer<QueueWriteBufferViewWrapper>,
    _marker: PhantomData<fn() -> T>,
}
```

The shader compilation system also sees changes, particularly around SPIR-V passthrough functionality. Wgpu 27 renames the feature flag and modifies the descriptor structure for creating shader modules. This requires updating the feature check and the method call:

```rust
// Before (wgpu 26):
if device.features().contains(wgpu::Features::SPIRV_SHADER_PASSTHROUGH) {
    unsafe {
        self.device.create_shader_module_passthrough(
            wgpu::ShaderModuleDescriptorPassthrough::SpirV(
                wgpu::ShaderModuleDescriptorSpirV {
                    label: desc.label,
                    source: source.clone(),
                },
            ),
        )
    }
}

// After (wgpu 27):
if device.features().contains(wgpu::Features::EXPERIMENTAL_PASSTHROUGH_SHADERS) {
    unsafe {
        self.device.create_shader_module_passthrough(
            wgpu::ShaderModuleDescriptorPassthrough {
                label: desc.label,
                spirv: Some(source.clone()),
                ..Default::default()
            },
        )
    }
}
```

The renderer initialization process expands to include new wgpu 27 capabilities. Several new limits are introduced for features like acceleration structures, mesh shaders, and multiview rendering. These limits need to be properly constrained against the adapter's reported capabilities:

```rust
max_acceleration_structures_per_shader_stage: limits
    .max_acceleration_structures_per_shader_stage
    .min(constrained_limits.max_acceleration_structures_per_shader_stage),
max_task_workgroup_total_count: limits
    .max_task_workgroup_total_count
    .min(constrained_limits.max_task_workgroup_total_count),
// ... additional new limits
```

Interestingly, the PR also removes the requirement for the `MULTI_DRAW_INDIRECT` feature in GPU preprocessing. This suggests that either the feature became default in wgpu 27 or the preprocessing system was refined to work without it. The change simplifies the feature requirement check:

```rust
// Before (wgpu 26):
let culling_feature_support = device.features().contains(
    Features::INDIRECT_FIRST_INSTANCE
        | Features::MULTI_DRAW_INDIRECT
        | Features::PUSH_CONSTANTS,
);

// After (wgpu 27):
let culling_feature_support = device
    .features()
    .contains(Features::INDIRECT_FIRST_INSTANCE | Features::PUSH_CONSTANTS);
```

The dependency updates are comprehensive, touching multiple crates throughout the Bevy ecosystem. Each crate that depends on wgpu-types or related graphics libraries needs its version updated. This includes not just the core rendering crates but also peripheral systems like anti-aliasing, cameras, meshes, sprites, and text rendering.

One notable change in the solari crate (ray tracing) removes the requirement for `EXPERIMENTAL_RAY_TRACING_ACCELERATION_STRUCTURE`. This suggests that wgpu 27 might have changed how ray tracing acceleration structures are handled or that the feature was consolidated into other flags.

The implementation includes proper handling of experimental features through an unsafe call to `wgpu::ExperimentalFeatures::enabled()`, with a TODO comment noting the need for proper safety considerations. This demonstrates a pragmatic approach to adopting new wgpu features while acknowledging the need for future safety review.

Throughout the changes, the author maintains consistency in error handling and follows established patterns for device feature checking and limit configuration. The PR successfully navigates the breaking changes in wgpu 27 while preserving Bevy's rendering functionality, setting the foundation for future graphics features and performance improvements.

## Visual Representation

```mermaid
graph TD
    A[wgpu 26] --> B[API Changes]
    B --> C[Device Polling]
    B --> D[Buffer Writer Lifetimes]
    B --> E[Shader Module Creation]
    B --> F[Device Limits]
    B --> G[Feature Flags]
    C --> H[PollType.wait_indefinitely()]
    D --> I[Removed Lifetime Parameters]
    E --> J[New Descriptor Structure]
    F --> K[New Mesh/Acceleration Limits]
    G --> L[Updated Feature Names]
    H --> M[wgpu 27 Compatibility]
    I --> M
    J --> M
    K --> M
    L --> M
```

## Key Files Changed

### `crates/bevy_render/src/renderer/mod.rs` (+20/-1)
This file handles renderer initialization and needed updates for wgpu 27's expanded device limits and experimental features.

**Key Changes:**
- Added new wgpu 27 limits for acceleration structures, mesh shaders, and multiview rendering
- Enabled experimental features via unsafe API (with TODO for safety review)
- Updated DX12 backend options with new configuration parameters

```rust
// Added new device limits for wgpu 27
max_acceleration_structures_per_shader_stage: limits
    .max_acceleration_structures_per_shader_stage
    .min(constrained_limits.max_acceleration_structures_per_shader_stage),
max_task_workgroup_total_count: limits
    .max_task_workgroup_total_count
    .min(constrained_limits.max_task_workgroup_total_count),

// Added experimental features (with safety note)
// SAFETY: TODO, see https://github.com/bevyengine/bevy/issues/22082
experimental_features: unsafe { wgpu::ExperimentalFeatures::enabled() },
```

### `crates/bevy_render/src/render_resource/uniform_buffer.rs` (+8/-8)
Updated dynamic uniform buffer writer to work with wgpu 27's lifetime changes.

**Key Changes:**
- Removed lifetime parameter from `DynamicUniformBufferWriter`
- Simplified `QueueWriteBufferViewWrapper` structure
- Updated type signatures throughout the module

```rust
// Before:
pub struct DynamicUniformBufferWriter<'a, T> {
    buffer: encase::DynamicUniformBuffer<QueueWriteBufferViewWrapper<'a>>,
    _marker: PhantomData<fn() -> T>,
}

// After:
pub struct DynamicUniformBufferWriter<T> {
    buffer: encase::DynamicUniformBuffer<QueueWriteBufferViewWrapper>,
    _marker: PhantomData<fn() -> T>,
}
```

### `crates/bevy_render/src/renderer/render_device.rs` (+6/-7)
Updated shader module creation for wgpu 27's SPIR-V passthrough changes.

**Key Changes:**
- Changed feature flag from `SPIRV_SHADER_PASSTHROUGH` to `EXPERIMENTAL_PASSTHROUGH_SHADERS`
- Updated shader module descriptor structure to match new wgpu API

```rust
// Updated shader module creation for SPIR-V passthrough
unsafe {
    self.device.create_shader_module_passthrough(
        wgpu::ShaderModuleDescriptorPassthrough {
            label: desc.label,
            spirv: Some(source.clone()),
            ..Default::default()
        },
    )
}
```

### `crates/bevy_render/src/batching/gpu_preprocessing.rs` (+3/-5)
Simplified feature requirements for GPU preprocessing.

**Key Changes:**
- Removed `MULTI_DRAW_INDIRECT` from required features
- Maintained compatibility with existing preprocessing functionality

```rust
// Simplified feature check
let culling_feature_support = device
    .features()
    .contains(Features::INDIRECT_FIRST_INSTANCE | Features::PUSH_CONSTANTS);
```

### `crates/bevy_shader/Cargo.toml` (+4/-4)
Updated wgpu-types and naga dependencies to version 27.

**Key Changes:**
- Bumped `wgpu-types` from 26 to 27
- Bumped `naga` from 26 to 27
- Updated `naga_oil` to version 0.20

```toml
# Before:
wgpu-types = { version = "26", default-features = false }
naga = { version = "26", features = ["wgsl-in"] }
naga_oil = { version = "0.19", default-features = false }

# After:
wgpu-types = { version = "27", default-features = false }
naga = { version = "27", features = ["wgsl-in"] }
naga_oil = { version = "0.20", default-features = false }
```

## Further Reading

1. [wgpu 27.0 Release Notes](https://github.com/gfx-rs/wgpu/releases/tag/v27.0.0) - Detailed changelog and migration guide
2. [Bevy Render Architecture](https://bevyengine.org/learn/book/next/plugins/render/) - Understanding Bevy's rendering system
3. [WebGPU Specification](https://www.w3.org/TR/webgpu/) - Underlying standard that wgpu implements
4. [Naga Shader Translation](https://github.com/gfx-rs/naga) - Shader translation library used by wgpu
5. [GPU Buffer Management Patterns](https://sotrh.github.io/learn-wgpu/) - Best practices for GPU resource management

# Full Code Diff
*(Provided in the original request)*