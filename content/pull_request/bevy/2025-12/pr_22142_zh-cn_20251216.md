+++
title = "#22142 disable scraping examples in doc"
date = "2025-12-16T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = false

[extra]
current_language = "zh-cn"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-12/pr-22142-en-20251216" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-12/pr-22142-zh-cn-20251216" }}
+++

# Title

## 基本信息
- **标题**: disable scraping examples in doc
- **PR链接**: https://github.com/bevyengine/bevy/pull/22142
- **作者**: mockersf
- **状态**: 已合并
- **标签**: C-Bug, C-Docs, D-Trivial, A-Build-System, S-Ready-For-Final-Review
- **创建时间**: 2025-12-15T22:38:38Z
- **合并时间**: 2025-12-16T05:20:40Z
- **合并人**: alice-i-cecile

## 描述翻译
### Objective
- rustdoc 的示例抓取 (example scrapping) 功能过于不稳定，且经常引发 ICE（内部编译器错误）
- 修复 https://github.com/bevyengine/bevy/issues/21978

### Solution
- 停止使用该功能

## 这个PR的故事

这个PR源于一个实际的、反复出现的构建问题。Bevy项目的文档构建工作流（`.github/workflows/docs.yml`）以及其相关的Cargo配置（`Cargo.toml`）中启用了一个名为`-Zrustdoc-scrape-examples`的Rust不稳定功能。这个功能允许`rustdoc`在生成API文档时，自动扫描项目中的示例代码（`examples/`），并将相关的代码片段嵌入到对应API项的文档中。理论上，这能提升文档的实用性。

然而，在实践中，这个功能被证明是**不可靠的**。如PR描述和关联的Issue (#21978) 所指出的，它“过于不稳定，且经常引发ICE”。ICE是“Internal Compiler Error”的缩写，意味着Rust编译器自身遇到了一个致命错误并崩溃了。对于持续集成（CI）流水线来说，这是一个严重问题，因为它会导致文档构建作业随机失败，破坏工作流的稳定性，并给维护者带来修复非确定性失败的负担。

面对一个频繁导致构建中断的工具链功能，开发者做出的工程决策是直接而务实的：**停止使用它**。这个决策权衡了功能的益处（更好的文档）与其成本（CI的不可靠性）。在当前的开发阶段，保证构建的稳定性和开发者体验的流畅性，被认为比这个特定的、不稳定的文档增强功能更重要。

因此，解决方案是**从构建配置中移除启用该不稳定功能的参数**。具体来说，需要从两处删除`-Zrustdoc-scrape-examples`标志：
1.  **CI工作流** (`docs.yml`)：这是实际构建和发布文档的地方。不稳定标志在这里会导致CI失败。
2.  **Cargo.toml中的元数据**：`[package.metadata.docs.rs]`部分用于配置`docs.rs`网站的文档构建。移除这里的标志可以确保在`docs.rs`上发布的官方文档构建也保持稳定。

实现非常简单。在`docs.yml`中，构建`cargo doc`的命令移除了两个`-Zunstable-options`标志（其中一个与scrape-examples配对）。在`Cargo.toml`中，`cargo-args`数组直接移除了包含该标志的整个字符串项。这是一个典型的“减法优于加法”的修复——通过移除有问题的部分来恢复系统的稳定性。

这次更改的影响是直接的：Bevy的文档构建过程将不再尝试抓取示例，从而避免了由该不稳定功能引发的随机ICE错误。CI流水线将变得更加可靠。当然，代价是生成的API文档中将不会自动包含来自示例的代码片段。这是一个可以接受的折衷方案，尤其是考虑到该功能本身就处于不稳定状态，未来其接口和行为都可能发生变化。等到该功能在Rust中稳定下来后，项目可以重新评估是否再次启用它。

从工程角度看，这个PR是一个很好的例子，展示了如何管理对不稳定编译器/工具链功能的依赖。它强调了**CI稳定性**的重要性，以及当某个实验性功能带来的麻烦多于价值时，果断禁用它是一种合理的策略。

## 视觉呈现

```mermaid
graph TD
    subgraph “PR #22142: 修复文档构建不稳定性”
        A[问题: CI 因 rustdoc ICE 随机失败] --> B{根本原因}
        B --> C[不稳定功能: -Zrustdoc-scrape-examples]
        C --> D[解决方案: 移除该功能标志]
        D --> E[实施修改]
        E --> F[.github/workflows/docs.yml]
        E --> G[Cargo.toml]
        F --> H[结果: CI 文档构建恢复稳定]
        G --> H
    end
```

## 关键文件变更

### 1. `.github/workflows/docs.yml`
**变更描述**：修改了用于构建和发布文档的GitHub Actions工作流。移除了启用`rustdoc`“示例抓取”不稳定功能所需的命令行标志。
**关联目的**：这是修复CI构建随机失败的直接操作点。移除标志后，工作流中的`cargo doc`命令将不再使用该不稳定功能。

**代码片段**：
```yaml
# 文件: .github/workflows/docs.yml
# 修改前:
        run: |
          cargo doc \
            -Zunstable-options \
            -Zrustdoc-scrape-examples \
            --all-features \
            --workspace \
            --no-deps \

# 修改后:
        run: |
          cargo doc \
            --all-features \
            --workspace \
            --no-deps \
```

### 2. `Cargo.toml`
**变更描述**：更新了Cargo清单中用于配置`docs.rs`网站文档构建的元数据。移除了传递给`cargo`的、用于启用示例抓取功能的参数。
**关联目的**：确保在`docs.rs`（Rust生态系统的官方文档托管平台）上进行的自动文档构建也遵循同样的变更，保持构建环境的一致性并避免潜在的失败。

**代码片段**：
```toml
// 文件: Cargo.toml
// 修改前:
[[package.metadata.docs.rs]]
all-features = true
cargo-args = ["-Zunstable-options", "-Zrustdoc-scrape-examples"]

// 修改后:
[[package.metadata.docs.rs]]
all-features = true
// `cargo-args` 行已被移除
```

## 延伸阅读
*   **Rustdoc 示例抓取功能 (Rustdoc Scrape Examples)**: Rust官方文档中关于此不稳定功能的说明，解释了它的设计目的和工作原理。
*   **Rust 不稳定功能 (Unstable Features)**: 关于如何使用和管控Rust语言和编译器的不稳定（nightly-only）功能的指南。这对于理解`-Z`标志的含义至关重要。
*   **内部编译器错误 (ICE)**: Rust编译器的错误信息指南，解释了什么是ICE以及当遇到ICE时应该如何报告问题。