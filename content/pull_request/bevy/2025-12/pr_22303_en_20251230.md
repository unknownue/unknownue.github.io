+++
title = "#22303 bevy_render: dropped texture view is not Drop in wasm"
date = "2025-12-30T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = true

[taxonomies]
list_display = ["show"]

[extra]
current_language = "en"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-12/pr-22303-en-20251230" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-12/pr-22303-zh-cn-20251230" }}
labels = ["C-Bug", "A-Rendering", "C-Code-Quality", "O-Web"]
+++

# Title

## Basic Information
- **Title**: bevy_render: dropped texture view is not Drop in wasm
- **PR Link**: https://github.com/bevyengine/bevy/pull/22303
- **Author**: mockersf
- **Status**: MERGED
- **Labels**: C-Bug, A-Rendering, C-Code-Quality, O-Web, S-Ready-For-Review
- **Created**: 2025-12-29T18:22:12Z
- **Merged**: 2025-12-30T02:01:08Z
- **Merged By**: alice-i-cecile

## Description Translation
# Objective

- `cargo clippy --no-deps --package bevy_render --target wasm32-unknown-unknown` fails:
```
warning: call to `std::mem::drop` with a value that does not implement `Drop`. Dropping such a type only extends its contained lifetimes
   --> crates/bevy_render/src/view/window/mod.rs:416:13
    |
416 |             drop(window.swap_chain_texture_view.take());
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |
note: argument has type `std::option::Option<render_resource::texture::TextureView>`
   --> crates/bevy_render/src/view/window/mod.rs:416:18
    |
416 |             drop(window.swap_chain_texture_view.take());
    |                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    = help: for further information visit https://rust-lang.github.io/rust-clippy/rust-1.92.0/index.html#drop_non_drop
    = note: `#[warn(clippy::drop_non_drop)]` on by default

warning: `bevy_render` (lib) generated 1 warning
```

## Solution

- Expect the lint in wasm. It's not an actual problem, and special casing for wasm wouldn't be better

## The Story of This Pull Request

This PR addresses a straightforward but important issue with the Bevy rendering engine's WebAssembly target. During routine maintenance, the developer ran clippy with the wasm32 target and discovered a warning that prevented clean builds. The warning indicated that `TextureView` doesn't implement the `Drop` trait on WebAssembly, making the explicit `drop()` call unnecessary from a lint perspective.

The problem occurs in the window surface creation code. When Bevy needs to recreate swap chain surfaces, it properly cleans up the old textures by dropping them. The code uses `drop(window.swap_chain_texture.take())` followed by `drop(window.swap_chain_texture_view.take())`. On native platforms, these types implement `Drop` to properly release GPU resources. However, on WebAssembly, `TextureView` doesn't implement `Drop` because WebGPU resources in wasm are managed differently - they're automatically cleaned up by JavaScript's garbage collection.

From a technical standpoint, this isn't a bug in the runtime behavior. The `drop()` call on wasm essentially becomes a no-op that just extends the value's lifetime until the end of the scope. The code is still correct because:
1. The `take()` operation moves the value out of the `Option`, leaving `None` in its place
2. Calling `drop()` on the moved-out value ensures it's destroyed immediately (on native) or lets it go out of scope (on wasm)
3. The warning is purely a lint issue, not a functional problem

The developer considered several approaches to fix this. One option was to conditionally compile the `drop()` call only for non-wasm targets using `#[cfg(not(target_arch = "wasm32"))]`. Another was to use `let _ = window.swap_chain_texture_view.take();` instead of `drop()`. However, both approaches would make the code less consistent and potentially more confusing.

The chosen solution uses Rust's `cfg_attr` directive with `expect` to suppress the clippy warning specifically for wasm32 targets while keeping the code structure identical across all platforms. This approach maintains code consistency and readability while documenting why the warning is expected. The `expect` attribute is preferable to `allow` because it requires a reason and shows up in clippy output, making it clear this is an intentional suppression.

This fix demonstrates good Rust practice: when dealing with platform-specific differences, use attributes to handle lints rather than changing the code structure. The `cfg_attr` approach keeps the code visually identical across platforms, which helps maintainability. Future developers working on this code won't need to understand why wasm has different drop semantics - the attribute provides that documentation inline.

The implementation shows awareness of WebGPU's architectural differences between native and web targets. On native platforms, explicit resource management is required, while on the web, resources are managed by the browser's JavaScript runtime. This distinction is common in cross-platform graphics code and handling it gracefully is important for a game engine like Bevy that targets multiple platforms.

## Visual Representation

```mermaid
graph TD
    A[Window Surface Recreation] --> B[Drop swap_chain_texture]
    A --> C[Drop swap_chain_texture_view]
    C --> D{Native Platform?}
    D -->|Yes| E[TextureView implements Drop]
    D -->|No (Wasm)| F[TextureView doesn't implement Drop]
    F --> G[Clippy warns drop_non_drop]
    G --> H[Suppress with #[expect]]
```

## Key Files Changed

### `crates/bevy_render/src/view/window/mod.rs` (+4/-0)

This file contains the window surface management code for Bevy's renderer. The change adds a conditional attribute to suppress a clippy warning specifically for WebAssembly targets.

**Key modification:**

```rust
// Before the change:
drop(window.swap_chain_texture.take());
drop(window.swap_chain_texture_view.take());

// After the change:
drop(window.swap_chain_texture.take());
#[cfg_attr(
    target_arch = "wasm32",
    expect(clippy::drop_non_drop, reason = "texture views are not drop on wasm")
)]
drop(window.swap_chain_texture_view.take());
```

**Why this change was made:**
1. The `TextureView` type doesn't implement `Drop` on WebAssembly targets
2. The explicit `drop()` call is still semantically correct (it moves the value out of scope)
3. The warning was preventing clean clippy runs for wasm32 targets
4. The attribute approach maintains code consistency across platforms while documenting the platform-specific behavior

## Further Reading

1. [Rust Clippy: drop_non_drop](https://rust-lang.github.io/rust-clippy/rust-1.92.0/index.html#drop_non_drop) - Documentation for the specific clippy lint
2. [Rust Conditional Compilation](https://doc.rust-lang.org/reference/conditional-compilation.html) - How to use `cfg` and `cfg_attr` attributes
3. [WebGPU and WASM Resource Management](https://www.w3.org/TR/webgpu/) - WebGPU specification showing how resources are managed in web environments
4. [Bevy WebAssembly Support](https://bevyengine.org/learn/quick-start/getting-started/setup/#wasm-webassembly) - Bevy's documentation on WebAssembly target setup
5. [Rust's Drop Trait](https://doc.rust-lang.org/std/ops/trait.Drop.html) - Understanding how resource cleanup works in Rust