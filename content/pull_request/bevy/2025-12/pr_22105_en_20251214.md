+++
title = "#22105 Make it possible to statically construct gizmo buffers"
date = "2025-12-14T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = true

[taxonomies]
list_display = ["show"]

[extra]
current_language = "en"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-12/pr-22105-en-20251214" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-12/pr-22105-zh-cn-20251214" }}
labels = ["D-Trivial", "A-Gizmos"]
+++

# Make it possible to statically construct gizmo buffers

## Basic Information
- **Title**: Make it possible to statically construct gizmo buffers
- **PR Link**: https://github.com/bevyengine/bevy/pull/22105
- **Author**: atlv24
- **Status**: MERGED
- **Labels**: D-Trivial, S-Ready-For-Final-Review, A-Gizmos
- **Created**: 2025-12-13T09:32:13Z
- **Merged**: 2025-12-14T21:47:22Z
- **Merged By**: alice-i-cecile

## Description Translation

# Objective

- statically construct gizmo buffers for some shenanigans

## Solution

- expose a const constructor

## Testing

- 

## The Story of This Pull Request

This PR addresses a specific technical limitation in the Bevy engine's gizmo system. The developer needed to create `GizmoBuffer` instances at compile time using static/const contexts, but the struct only had a `Default` implementation that couldn't be used in const contexts due to its reliance on non-const operations.

The problem is straightforward: the `GizmoBuffer` struct, which stores geometric data for drawing debug visualizations (gizmos), could only be constructed using runtime initialization. This prevented developers from creating pre-initialized buffers in static or const contexts, which are useful for certain optimization patterns and advanced use cases.

The solution implements a clean, minimal approach: adding a `const fn new()` method to `GizmoBuffer`. This method returns an empty buffer with default settings, specifically setting `enabled: true` and initializing empty vectors for positions, colors, and indices. The existing `Default` implementation is then updated to delegate to this new constructor, maintaining consistency while adding the const capability.

From an implementation perspective, the changes are intentionally minimal. The new `const fn new()` method is defined in an `impl` block for `GizmoBuffer<Config, Clear>`, where both type parameters have appropriate bounds (`Config: GizmoConfigGroup` and `Clear: 'static + Send + Sync`). The constructor initializes all fields with their default values in a const-safe manner. Notably, `Vec::new()` is const in stable Rust, allowing this implementation.

The impact of this change is primarily in enabling new use patterns. Developers can now create `GizmoBuffer` instances in static or const contexts, which can be useful for scenarios where buffers need to be pre-initialized with known data or when working with compile-time evaluated data structures. This aligns with Rust's growing capabilities around const evaluation and compile-time initialization.

One technical consideration is that while the buffer itself can now be statically constructed, the vectors it contains are empty by default. For actual use, data would still need to be added at runtime. However, the ability to have the container itself be const is valuable for certain architectural patterns where the container structure needs to exist at compile time, even if its contents are populated later.

The change is backward compatible and doesn't affect existing code. The `Default` implementation now uses `GizmoBuffer::new()` internally, which means existing code using `GizmoBuffer::default()` or `Default::default()` will work exactly as before, just with the additional benefit of the new const constructor being available for specialized use cases.

## Visual Representation

```mermaid
graph TD
    A[GizmoBuffer struct] --> B[Default::default() method]
    A --> C[new() const constructor]
    B --> D[Uses new() internally]
    C --> E[Enables static/const construction]
    E --> F[Compile-time initialization]
```

## Key Files Changed

### `crates/bevy_gizmos/src/gizmos.rs` (+11/-0)

This file contains the `GizmoBuffer` struct definition and its implementations. The change adds a `const fn new()` constructor and updates the `Default` implementation to use it.

**Key modifications:**
```rust
// Before the Default implementation existed, but new() didn't exist

// After: The Default implementation delegates to new()
impl<Config, Clear> Default for GizmoBuffer<Config, Clear>
where
    Config: GizmoConfigGroup,
    Clear: 'static + Send + Sync,
{
    fn default() -> Self {
        GizmoBuffer::new()
    }
}

// After: New const constructor added
impl<Config, Clear> GizmoBuffer<Config, Clear>
where
    Config: GizmoConfigGroup,
    Clear: 'static + Send + Sync,
{
    /// Constructs an empty `GizmoBuffer`.
    pub const fn new() -> Self {
        GizmoBuffer {
            enabled: true,
            list_positions: Vec::new(),
            list_colors: Vec::new(),
            list_indices: Vec::new(),
            strip_positions: Vec::new(),
            strip_colors: Vec::new(),
        }
    }
}
```

The changes are minimal but significant:
1. The `Default` implementation now calls `GizmoBuffer::new()` instead of directly constructing the struct
2. A new `const fn new()` method is added that creates an empty `GizmoBuffer` with all vectors initialized to empty `Vec::new()` instances
3. The `const` qualifier enables this method to be used in compile-time contexts

## Further Reading

1. **Rust Const Functions**: The Rust Reference section on const functions explains what operations are allowed in const contexts: https://doc.rust-lang.org/reference/const_eval.html
2. **Bevy Gizmos Documentation**: The Bevy engine's gizmo system documentation provides context on how gizmo buffers are used: https://docs.rs/bevy_gizmos/latest/bevy_gizmos/
3. **Static Initialization Patterns**: For understanding why static/const construction is useful, see Rust patterns around lazy_static, OnceCell, and const initialization: https://doc.rust-lang.org/std/keyword.static.html

# Full Code Diff
```diff
diff --git a/crates/bevy_gizmos/src/gizmos.rs b/crates/bevy_gizmos/src/gizmos.rs
index 3d666cbbf51fe..074a9232e6b79 100644
--- a/crates/bevy_gizmos/src/gizmos.rs
+++ b/crates/bevy_gizmos/src/gizmos.rs
@@ -308,6 +308,17 @@ where
     Clear: 'static + Send + Sync,
 {
     fn default() -> Self {
+        GizmoBuffer::new()
+    }
+}
+
+impl<Config, Clear> GizmoBuffer<Config, Clear>
+where
+    Config: GizmoConfigGroup,
+    Clear: 'static + Send + Sync,
+{
+    /// Constructs an empty `GizmoBuffer`.
+    pub const fn new() -> Self {
         GizmoBuffer {
             enabled: true,
             list_positions: Vec::new(),
```