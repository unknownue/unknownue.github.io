+++
title = "#22092 Fix lints after Rust 1.92"
date = "2025-12-12T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = true

[taxonomies]
list_display = ["show"]

[extra]
current_language = "en"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-12/pr-22092-en-20251212" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-12/pr-22092-zh-cn-20251212" }}
labels = ["C-Code-Quality", "P-Critical", "A-Cross-Cutting"]
+++

# Title
## Basic Information
- **Title**: Fix lints after Rust 1.92
- **PR Link**: https://github.com/bevyengine/bevy/pull/22092
- **Author**: kristoff3r
- **Status**: MERGED
- **Labels**: C-Code-Quality, S-Ready-For-Final-Review, P-Critical, A-Cross-Cutting
- **Created**: 2025-12-11T23:04:54Z
- **Merged**: 2025-12-12T09:35:06Z
- **Merged By**: alice-i-cecile

## Description Translation
# Objective

CI is currently failing

## Solution

Fix the lints (and work around all the rustc lint bugs that are apparently included)

## The Story of This Pull Request

This PR addresses CI failures that occurred after updating to Rust 1.92. The core issue was that the new Rust version introduced several lint changes and compiler improvements that broke existing code and test expectations. The developer needed to fix these issues quickly to restore CI functionality, which is critical for ongoing development.

The problem manifested in multiple ways: new compiler warnings, changed error message formatting in UI tests, and stricter requirements around certain code patterns. This wasn't a simple matter of fixing one or two lint warnings - it required systematic changes across 29 files in the codebase, including core ECS modules, reflection systems, and testing infrastructure.

The solution approach was pragmatic: fix straightforward lint violations, update test expectations to match new compiler output, and work around known Rust compiler bugs using `#[expect]` attributes. This dual approach - fixing actual issues while acknowledging compiler limitations - was necessary to get CI passing without waiting for upstream Rust fixes.

One significant change involved UI test expectations. Rust 1.92 introduced improved error messages with better formatting and more helpful suggestions. For example, in the component hook relationship tests, the error messages now include `unsatisfied trait bound` annotations and additional help text showing where the problematic types are defined. The PR updates these `.stderr` files to match the new output format:

```rust
// Before Rust 1.92:
error[E0277]: the trait bound `FooTargetOfFail: Relationship` is not satisfied

// After Rust 1.92:
error[E0277]: the trait bound `FooTargetOfFail: bevy_ecs::relationship::Relationship` is not satisfied
help: the trait `bevy_ecs::relationship::Relationship` is not implemented for `FooTargetOfFail`
```

The PR also addressed a Rust compiler bug related to unused assignments in closures. In the reflection benchmarks, a closure was capturing a variable that appeared unused to the compiler, but the code was actually correct. Rather than restructuring the benchmark, the developer used `#[expect]` to suppress the warning while documenting the Rust issue:

```rust
#[expect(
    unused_assignments,
    reason = "rustc bug https://github.com/rust-lang/rust/issues/149889"
)]
let closure = move |a: i32| _capture += a;
```

Another pattern that needed fixing was the ordering of attributes and safety comments. Rust 1.92 became stricter about attribute placement, particularly with `#[expect]` attributes that reference unsafe code. The PR moved `#[expect]` attributes above the unsafe blocks they reference:

```rust
// Before:
// SAFETY: unique world access
#[expect(unsafe_code, reason = "Use of unsafe function")]

// After:
#[expect(unsafe_code, reason = "Use of unsafe function")]
// SAFETY: unique world access
```

The PR also included several code quality improvements unrelated to lints but discovered during the audit. For instance, in the render diagnostics system, the developer replaced verbose iterator patterns with more concise `rfind()` calls:

```rust
// Before:
let parent = self.open_spans.iter()
    .filter(|v| v.thread_id == thread_id)
    .next_back();

// After:
let parent = self.open_spans.iter().rfind(|v| v.thread_id == thread_id);
```

In the ECS system parameter macros, the PR fixed tuple initialization to avoid extra parentheses and added explicit `#[allow]` attributes for clippy warnings about unused unit types in zero-length tuples:

```rust
// Before macro fix:
($($param::init(world, system_meta),)*)  // Extra parentheses

// After macro fix:
($($param::init(world, system_meta),)*)  // Correct tuple syntax
```

The impact of these changes is primarily maintenance-focused: CI passes again, the codebase remains compatible with the latest Rust version, and several minor code quality issues were addressed. The PR demonstrates the practical reality of maintaining a large Rust project - compiler updates often require coordinated fixes across multiple subsystems, and sometimes workarounds are necessary for compiler bugs.

From an engineering perspective, this PR shows good judgment in balancing immediate fixes (to restore CI) with proper documentation of workarounds (linking to Rust issues). The changes are minimal and focused on the actual problems, avoiding unnecessary refactoring while still improving code where obvious improvements existed.

## Visual Representation

```mermaid
graph TD
    A[Rust 1.92 Update] --> B[CI Failing]
    B --> C{Lint Analysis}
    C --> D[Compiler Error Changes]
    C --> E[New Warnings]
    C --> F[Attribute Ordering]
    
    D --> G[Update .stderr Files]
    E --> H[Add #[expect] Attributes]
    F --> I[Reorder Attributes]
    
    G --> J[CI Passing]
    H --> J
    I --> J
```

## Key Files Changed

**1. `crates/bevy_ecs/compile_fail/tests/ui/deconstruct_moving_ptr.stderr` (+224/-0)**
This new file contains updated error messages for the deconstruct_moving_ptr UI test. Rust 1.92 changed how these errors are formatted, particularly for macro-generated code. The new output includes better error explanations and more helpful suggestions.

**2. `crates/bevy_ecs/compile_fail/tests/ui/component_hook_relationship.stderr` (+38/-18)**
The error messages for relationship trait bounds were significantly improved in Rust 1.92. The updated file reflects these changes, including better type paths and additional help text:

```rust
// Key changes in error formatting:
- error[E0277]: the trait bound `FooTargetOfFail: Relationship` is not satisfied
+ error[E0277]: the trait bound `FooTargetOfFail: bevy_ecs::relationship::Relationship` is not satisfied
+ help: the trait `bevy_ecs::relationship::Relationship` is not implemented for `FooTargetOfFail`
```

**3. `crates/bevy_ecs/compile_fail/tests/ui/component_hook_call_signature_mismatch.rs` and `.stderr`**
The test source was updated to prefix unused parameters with underscores to avoid warnings, and the expected error output was simplified since the unused variable warnings no longer appear:

```rust
// Before:
fn wrong_bazzing(path: &str) -> impl Fn(bevy_ecs::world::DeferredWorld) {
    |world| {}
}

// After:
fn wrong_bazzing(_path: &str) -> impl Fn(bevy_ecs::world::DeferredWorld) {
    |_world| {}
}
```

**4. `crates/bevy_ecs/src/system/exclusive_system_param.rs` and `system_param.rs`**
Fixed tuple initialization in system parameter macros and added explicit clippy allowances:

```rust
// Before in macro expansion:
(($($param::init(world, system_meta),)*))  // Double parentheses

// After in macro expansion:
($($param::init(world, system_meta),)*)    // Correct tuple syntax

// Added clippy allowance:
#[allow(clippy::unused_unit, reason = "Zero length tuple is unit.")]
```

**5. `benches/benches/bevy_reflect/function.rs`**
Added an `#[expect]` attribute to work around a Rust compiler bug with closure captures:

```rust
#[expect(
    unused_assignments,
    reason = "rustc bug https://github.com/rust-lang/rust/issues/149889"
)]
let closure = move |a: i32| _capture += a;
```

**6. `crates/bevy_render/src/diagnostic/internal.rs`**
Improved code quality by using `rfind()` instead of verbose iterator patterns:

```rust
// Before:
let parent = self.open_spans.iter()
    .filter(|v| v.thread_id == thread_id)
    .next_back();

// After:
let parent = self.open_spans.iter().rfind(|v| v.thread_id == thread_id);
```

## Further Reading

1. **Rust 1.92 Release Notes**: https://blog.rust-lang.org/2025/01/16/Rust-1.92.html
2. **Rust Compiler Bug #149889**: https://github.com/rust-lang/rust/issues/149889
3. **Rust Compiler Bug #147648**: https://github.com/rust-lang/rust/issues/147648
4. **Bevy CI/CD Documentation**: https://bevyengine.org/learn/book/contributing/ci/
5. **Rust UI Testing Guide**: https://rustc-dev-guide.rust-lang.org/tests/ui.html