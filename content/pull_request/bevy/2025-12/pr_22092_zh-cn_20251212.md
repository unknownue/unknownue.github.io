+++
title = "#22092 Fix lints after Rust 1.92"
date = "2025-12-12T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = false

[extra]
current_language = "zh-cn"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-12/pr-22092-en-20251212" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-12/pr-22092-zh-cn-20251212" }}
+++

# 标题
Fix lints after Rust 1.92

## 基本信息
- **标题**: Fix lints after Rust 1.92
- **PR 链接**: https://github.com/bevyengine/bevy/pull/22092
- **作者**: kristoff3r
- **状态**: 已合并
- **标签**: C-Code-Quality, S-Ready-For-Review, P-Critical, A-Cross-Cutting
- **创建时间**: 2025-12-11T23:04:54Z
- **合并时间**: 2025-12-12T09:35:06Z
- **合并者**: alice-i-cecile

## 描述翻译

# 目标
CI 目前正在失败

## 解决方案
修复代码检查问题（并绕过所有明显包含在内的 rustc 代码检查 bug）

## 这个 PR 的故事

这个故事开始于一个典型的开发场景：Rust 语言发布了 1.92 版本，带来了新的编译器和代码检查规则。当 Bevy 项目的持续集成（CI）系统升级到这个版本后，代码库中的一些警告和错误检查开始失败。这不是关于新功能的开发，而是维护工作——确保项目与最新的 Rust 工具链兼容。

这个问题很关键，因为 CI 失败意味着新的代码无法被安全地合并，开发流程被阻塞。作者必须处理两种类型的问题：Rust 1.92 引入的新代码检查规则触发的真实问题，以及新版本中可能存在的代码检查器 bug 导致的误报。

解决方案分为几个关键部分：

首先，更新了编译失败测试（compile_fail tests）的预期错误输出。这些测试用于验证特定的无效代码确实会产生预期的编译错误。当 Rust 1.92 改变了错误信息的格式或内容时，测试的期望输出（.stderr 文件）必须更新以匹配。例如，在 `crates/bevy_ecs/compile_fail/tests/ui/component_hook_call_signature_mismatch.rs` 中，为了消除 `unused_variables` 警告，测试代码本身被修改，将未使用的参数 `path` 和 `world` 前缀改为下划线（`_path`、`_world`）。这导致相应的错误输出文件不再包含这些警告信息。

其次，作者添加了 `#[expect(...)]` 属性来抑制特定的代码检查警告，同时注明这些抑制是出于解决 Rust 编译器 bug 的需要。例如，在 `benches/benches/bevy_reflect/function.rs` 中，一个 `unused_assignments` 警告被抑制，并附上了指向 Rust 问题跟踪器（issue #149889）的理由。这种方法比简单地忽略警告更可取，因为它记录了抑制的原因，便于未来追踪和清理。

在 `crates/bevy_asset/src/reflect.rs` 和 `crates/bevy_transform/src/systems.rs` 中，我们看到 `#[expect(unsafe_code, ...)]` 属性与 `// SAFETY:` 注释的位置被调整了。在 Rust 1.92 中，属性期望出现在它们所适用的代码块之前。这是一个细微但重要的格式变化，确保了代码的清晰性和工具的正确解析。

技术细节上，一些代码改进也被引入。在 `crates/bevy_render/src/diagnostic/internal.rs` 中，`.filter(...).next_back()` 被更简洁且等价的 `.rfind(...)` 替代。这是一种代码清理，利用了标准库中更直接的迭代器方法，提高了可读性。

此外，新添加了编译失败测试的期望输出文件，如 `bundle_on_drop_impl.stderr` 和 `deconstruct_moving_ptr.stderr`。这表明 Rust 1.92 可能改进了对某些错误情况的诊断，或者之前的测试覆盖不足，现在需要明确这些情况下的预期错误。

对于元组实现的系统参数，如 `crates/bevy_ecs/src/system/exclusive_system_param.rs` 和 `crates/bevy_ecs/src/system/system_param.rs`，我们看到了对零长度元组（即 unit 类型 `()`）的特殊处理，添加了 `#[allow(clippy::unused_unit, ...)]` 属性，并修正了初始化表达式的格式（从 `(($(...),*))` 改为 `($(...),*)`）。这确保了宏展开后的代码格式正确，避免潜在的警告。

最终，这些更改使得 Bevy 代码库能够通过 Rust 1.92 下的所有代码检查，CI 恢复绿色状态。这个过程展示了维护一个大型 Rust 项目时，跟上语言版本更新的典型工作：更新测试预期、抑制误报的警告、进行小的代码改进，并确保所有 unsafe 代码的注释符合最新的工具要求。

## 可视化表示

```mermaid
graph TD
    A[Rust 1.92 发布] --> B[CI 失败]
    B --> C{分析失败原因}
    C --> D[更新编译失败测试]
    C --> E[抑制误报警告]
    C --> F[代码改进]
    D --> G[.stderr 文件更新]
    E --> H[添加 #[expect] 属性]
    F --> I[使用 rfind 等改进]
    G --> J[CI 通过]
    H --> J
    I --> J
```

## 关键文件更改

1. **`crates/bevy_ecs/compile_fail/tests/ui/deconstruct_moving_ptr.stderr`** (+224/-0)
   - 新增了针对 `deconstruct_moving_ptr` 宏的编译错误测试期望输出。Rust 1.92 为各种错误情况（如重复绑定、类型不匹配、多次可变借用等）生成了更详细的错误信息。这个文件记录了所有这些新错误信息，确保测试能够验证宏在误用时产生正确的错误。

2. **`crates/bevy_ecs/compile_fail/tests/ui/component_hook_relationship.stderr`** (+38/-18)
   - 更新了关系（relationship）组件的错误信息。新版本的错误信息格式略有变化，例如，现在会明确指出未满足的特征边界（unsatisfied trait bound），并提供了更多帮助信息，指出哪个结构体未实现所需的 trait。

   示例更改：
   ```rust
   // 旧错误信息片段:
   error[E0277]: the trait bound `FooTargetOfFail: Relationship` is not satisfied
   
   // 新错误信息片段:
   error[E0277]: the trait bound `FooTargetOfFail: bevy_ecs::relationship::Relationship` is not satisfied
   help: the trait `bevy_ecs::relationship::Relationship` is not implemented for `FooTargetOfFail`
   ```

3. **`crates/bevy_ecs/compile_fail/tests/ui/component_hook_call_signature_mismatch.rs` 和 .stderr**
   - 修改了测试代码以消除未使用变量的警告，从而更新了错误输出，使其不再包含这些警告，只保留相关的类型错误。

   代码更改：
   ```rust
   // 之前:
   fn wrong_bazzing(path: &str) -> impl Fn(bevy_ecs::world::DeferredWorld) {
       |world| {}
   }
   
   // 之后:
   fn wrong_bazzing(_path: &str) -> impl Fn(bevy_ecs::world::DeferredWorld) {
       |_world| {}
   }
   ```

4. **`crates/bevy_ecs/compile_fail/tests/ui/bundle_on_drop_impl.stderr`** (+14/-0)
   - 新增了针对实现 `Drop` trait 的 bundle 的编译错误测试期望输出。该错误提示不能从实现了 `Drop` trait 的类型中移出值。

5. **`benches/benches/bevy_reflect/function.rs`**
   - 添加了 `#[expect(unused_assignments, ...)]` 来抑制一个由于 Rust bug 而产生的警告，并附上了指向该 bug 的 issue 链接。

   代码更改：
   ```rust
   #[expect(
       unused_assignments,
       reason = "rustc bug https://github.com/rust-lang/rust/issues/149889"
   )]
   let closure = move |a: i32| _capture += a;
   ```

## 扩展阅读

- [Rust 1.92.0 Release Notes](https://blog.rust-lang.org/2025/...): 了解此版本引入的新功能和变更。
- [Rust Compiler Error Index](https://doc.rust-lang.org/error_codes/): 了解各种错误代码的含义。
- [The `#[expect]` Attribute](https://doc.rust-lang.org/rustc/lints/levels.html#expect): 关于如何使用 `#[expect]` 有条件地抑制警告的文档。
- [Rust Issue #149889](https://github.com/rust-lang/rust/issues/149889): 本 PR 中提到的未使用赋值警告的 bug 报告。