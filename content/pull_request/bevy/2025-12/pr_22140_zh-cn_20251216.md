+++
title = "#22140 impl `Measured3d` for `ConicalFrustum`"
date = "2025-12-16T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = false

[extra]
current_language = "zh-cn"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-12/pr-22140-en-20251216" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-12/pr-22140-zh-cn-20251216" }}
labels = ["C-Usability", "A-Math", "D-Straightforward"]
+++

# Title

## Basic Information
- **Title**: impl `Measured3d` for `ConicalFrustum`
- **PR Link**: https://github.com/bevyengine/bevy/pull/22140
- **Author**: lynn-lumen
- **Status**: MERGED
- **Labels**: C-Usability, S-Ready-For-Final-Review, A-Math, X-Uncontroversial, D-Straightforward
- **Created**: 2025-12-15T22:25:24Z
- **Merged**: 2025-12-16T03:53:39Z
- **Merged By**: alice-i-cecile

## Description Translation
目标

- 为 `ConicalFrustum` 实现 `Measured3d` trait

## 解决方案

- 为 `ConicalFrustum` 实现了 `Measured3d` trait
- 添加了类似 `Cone` 中已有的辅助函数，例如 `frustum.slant_height()`

## 测试

- 包含该实现的测试

## The Story of This Pull Request

这个PR解决的问题很简单：`ConicalFrustum`（圆台）3D几何体缺少计算其几何属性的trait实现。在Bevy的数学库中，其他3D基本体如`Cone`（圆锥）、`Cylinder`（圆柱）等都已经实现了`Measured3d` trait，该trait提供了计算体积(`volume`)和表面积(`area`)的标准接口。`ConicalFrustum`作为核心几何体之一，缺少这些实现影响了API的一致性和可用性。

开发者采用了直接的解决方案：为`ConicalFrustum`添加必要的数学函数并实现`Measured3d` trait。实现过程中参考了类似几何体`Cone`的设计模式，确保API一致性。具体来说，除了实现trait要求的`volume()`和`area()`方法外，还添加了几个辅助计算函数，这些函数既支持主trait实现，也作为公共API暴露给使用者。

从技术实现看，圆台的体积计算使用了标准公式：V = (πh/3)(R² + r² + Rr)，其中R是底部半径，r是顶部半径，h是高度。表面积计算则是底部圆面积、顶部圆面积和侧面积（lateral area）之和。侧面积计算需要先得到斜高(slant height)，这是连接底部边缘到顶部边缘的直线段长度。

代码实现的关键在于正确实现这些数学计算，并遵循Bevy代码库的惯用模式。例如，为`slant_height()`添加了`#[doc(alias = "side_length")]`属性，为`lateral_area()`添加了`#[doc(alias = "side_area")]`属性，这有助于使用者通过不同术语找到相应方法，提高了API的可用性。

测试部分验证了所有新添加方法的正确性，使用了具体的数值进行断言。测试用例创建了一个底部半径2、顶部半径1、高度9的圆台，验证了各项计算结果。测试数据的精度选择合理，使用了足够的小数位数确保准确性。

这个PR的变更规模不大但意义明确：完善了3D几何体的API一致性。任何需要计算圆台体积或表面积的代码现在可以直接使用标准trait接口，而不是手动实现这些数学公式。这减少了代码重复和潜在的错误。

## Visual Representation

```mermaid
graph TD
    A[ConicalFrustum Struct] --> B[Measured3d Trait]
    A --> C[Helper Methods]
    B --> D[volume() method]
    B --> E[area() method]
    C --> F[bottom_base()]
    C --> G[top_base()]
    C --> H[slant_height()]
    C --> I[lateral_area()]
    C --> J[bottom_base_area()]
    C --> K[top_base_area()]
    D --> L[Uses helper methods]
    E --> L
```

## Key Files Changed

### `crates/bevy_math/src/primitives/dim3.rs` (+90/-0)

这个文件包含了`ConicalFrustum`结构体的定义以及相关的trait实现。PR添加了新的impl块来实现`Measured3d` trait和一些辅助方法。

**主要变更：**

1. **为`ConicalFrustum`添加了辅助方法：**

```rust
impl ConicalFrustum {
    /// Get the bottom base of the conical frustum as a [`Circle`]
    #[inline]
    pub const fn bottom_base(&self) -> Circle {
        Circle {
            radius: self.radius_bottom,
        }
    }

    /// Get the top base of the conical frustum as a [`Circle`]
    #[inline]
    pub const fn top_base(&self) -> Circle {
        Circle {
            radius: self.radius_top,
        }
    }

    /// Get the slant height of the conical frustum, the length of the line segment
    /// connecting a point on the base to the closest point on the top
    #[inline]
    #[doc(alias = "side_length")]
    pub fn slant_height(&self) -> f32 {
        ops::hypot(self.radius_bottom - self.radius_top, self.height)
    }

    /// Get the surface area of the side of the conical frustum,
    /// also known as the lateral area
    #[inline]
    #[doc(alias = "side_area")]
    pub fn lateral_area(&self) -> f32 {
        PI * (self.radius_bottom + self.radius_top) * self.slant_height()
    }

    /// Get the surface area of the bottom base of the conical frustum
    #[inline]
    pub fn bottom_base_area(&self) -> f32 {
        PI * self.radius_bottom.squared()
    }

    /// Get the surface area of the top base of the conical frustum
    #[inline]
    pub fn top_base_area(&self) -> f32 {
        PI * self.radius_top.squared()
    }
}
```

2. **实现了`Measured3d` trait：**

```rust
impl Measured3d for ConicalFrustum {
    #[inline]
    fn volume(&self) -> f32 {
        FRAC_PI_3
            * self.height
            * (self.radius_bottom * self.radius_bottom
                + self.radius_top * self.radius_top
                + self.radius_top * self.radius_bottom)
    }
    #[inline]
    fn area(&self) -> f32 {
        self.bottom_base_area() + self.top_base_area() + self.lateral_area()
    }
}
```

3. **添加了测试用例：**

```rust
#[test]
fn conical_frustum_math() {
    let frustum = ConicalFrustum {
        height: 9.0,
        radius_top: 1.0,
        radius_bottom: 2.0,
    };
    assert_eq!(
        frustum.bottom_base(),
        Circle { radius: 2.0 },
        "bottom base produces incorrect circle"
    );
    assert_eq!(
        frustum.top_base(),
        Circle { radius: 1.0 },
        "top base produces incorrect circle"
    );
    assert_eq!(frustum.slant_height(), 9.055386, "incorrect slant height");
    assert_eq!(frustum.lateral_area(), 85.345, "incorrect lateral area");
    assert_eq!(
        frustum.bottom_base_area(),
        12.566371,
        "incorrect bottom base area"
    );
    assert_eq!(frustum.top_base_area(), PI, "incorrect top base area");
    assert_eq!(frustum.area(), 101.05296, "incorrect surface area");
    assert_eq!(frustum.volume(), 65.97345, "incorrect volume");
}
```

## 进一步阅读

- [Bevy 数学库文档](https://docs.rs/bevy_math/latest/bevy_math/)
- [3D几何体基本体](https://en.wikipedia.org/wiki/Conical_frustum)
- [`Measured3d` trait的现有实现](https://github.com/bevyengine/bevy/blob/main/crates/bevy_math/src/measured3d.rs)