+++
title = "#21994 Update criterion requirement from 0.7.0 to 0.8.0"
date = "2025-12-01T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = false

[extra]
current_language = "zh-cn"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-12/pr-21994-en-20251201" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-12/pr-21994-zh-cn-20251201" }}
labels = ["C-Dependencies"]
+++

# Update criterion requirement from 0.7.0 to 0.8.0

## Basic Information
- **Title**: Update criterion requirement from 0.7.0 to 0.8.0
- **PR Link**: https://github.com/bevyengine/bevy/pull/21994
- **Author**: app/dependabot
- **Status**: MERGED
- **Labels**: C-Dependencies
- **Created**: 2025-12-01T06:35:18Z
- **Merged**: 2025-12-01T07:26:13Z
- **Merged By**: mockersf

## Description Translation
将基准测试库 (benchmarking library) [criterion](https://github.com/criterion-rs/criterion.rs) 的版本要求更新至允许使用最新版本。
<details>
<summary>更新日志</summary>
<p><em>来源自 <a href="https://github.com/criterion-rs/criterion.rs/blob/master/CHANGELOG.md">criterion 的更新日志</a>。</em></p>
<blockquote>
<h2><a href="https://github.com/criterion-rs/criterion.rs/compare/criterion-v0.7.0...criterion-v0.8.0">0.8.0</a> - 2025-11-29</h2>
<h3>破坏性变更</h3>
<ul>
<li>放弃对 async-std 的支持</li>
</ul>
<h3>变更</h3>
<ul>
<li>最低支持的 Rust 版本 (MSRV) 提升至 1.86，稳定版要求 1.91.1</li>
</ul>
<h3>新增</h3>
<ul>
<li>新增在摘要页面绘制吞吐量 (throughput) 的能力。</li>
<li>新增支持以元素 (elements) 和字节 (bytes) 为单位报告吞吐量 - <code>Throughput::ElementsAndBytes</code> 允许文本摘要同时以两种单位报告吞吐量。</li>
<li>新增基于 alloca 的内存布局随机化，以减轻内存效应对测量的影响。</li>
<li>在 criterion_group 宏的基准测试运行器中添加文档注释（消除 linter 警告）</li>
</ul>
<h3>修复</h3>
<ul>
<li>修复绘制 NaN 值的 bug</li>
</ul>
<h3>其他</h3>
<ul>
<li>在我们恢复文档发布之前，暂时移除主 API 文档链接。</li>
</ul>
<h2>[0.7.0] - 2025-07-25</h2>
<ul>
<li>调整 criterion-plot 的版本以对齐依赖项。</li>
</ul>
<h2>[0.6.0] - 2025-05-17</h2>
<h3>变更</h3>
<ul>
<li>最低支持的 Rust 版本 (MSRV) 提升至 1.80</li>
<li><code>real_blackbox</code> 特性不再有任何作用。Criterion 现在总是使用 <code>std::hint::black_box()</code>。
使用 <code>criterion::black_box()</code> 的用户应切换到 <code>std::hint::black_box()</code>。</li>
<li>取消对 <code>clap</code> 依赖的版本锁定。</li>
</ul>
<h3>修复</h3>
<ul>
<li>在使用某些过去会失败的 Windows 二进制文件/配置时，现在能正确检测到 gnuplot 版本</li>
</ul>
<h3>新增</h3>
<ul>
<li>使用 Tokio 进行异步基准测试现在可以通过 <code>tokio::runtime::Handle</code> 完成，而不仅仅是 <code>tokio::runtime::Runtime</code></li>
</ul>
<h2>[0.5.1] - 2023-05-26</h2>
<h3>修复</h3>
<ul>
<li>快速模式 (--quick) 在测量时间超过 5 秒且未使用 --noplot 时不再崩溃</li>
</ul>
<h2>[0.5.0] - 2023-05-23</h2>
<!-- raw HTML omitted -->
</blockquote>
<p>...（内容已截断）</p>
</details>
<details>
<summary>提交记录</summary>
<ul>
<li><a href="https://github.com/criterion-rs/criterion.rs/commit/b49ade728c064f49cb2a70b0368658a15cf21833"><code>b49ade7</code></a> chore: 发布 v0.8.0</li>
<li>完整的差异比较请查看 <a href="https://github.com/criterion-rs/criterion.rs/compare/criterion-plot-v0.7.0...criterion-v0.8.0">对比视图</a></li>
</ul>
</details>
<br />


只要你不自行修改此 PR，Dependabot 将为你解决任何冲突。你也可以通过评论 `@dependabot rebase` 来手动触发变基。

[//]: # (dependabot-automerge-start)
[//]: # (dependabot-automerge-end)

---

<details>
<summary>Dependabot 命令和选项</summary>
<br />

你可以通过评论此 PR 来触发 Dependabot 操作：
- `@dependabot rebase` 将变基此 PR
- `@dependabot recreate` 将重新创建此 PR，覆盖已对其进行的任何编辑
- `@dependabot merge` 将在 CI 通过后合并此 PR
- `@dependabot squash and merge` 将在 CI 通过后压缩合并此 PR
- `@dependabot cancel merge` 将取消之前请求的合并并阻止自动合并
- `@dependabot reopen` 将重新打开已关闭的此 PR
- `@dependabot close` 将关闭此 PR 并阻止 Dependabot 重新创建它。手动关闭也能达到相同效果
- `@dependabot show <dependency name> ignore conditions` 将显示指定依赖项的所有忽略条件
- `@dependabot ignore this major version` 将关闭此 PR 并阻止 Dependabot 为此主要版本创建更多 PR（除非你重新打开此 PR 或自行升级）
- `@dependabot ignore this minor version` 将关闭此 PR 并阻止 Dependabot 为此次要版本创建更多 PR（除非你重新打开此 PR 或自行升级）
- `@dependabot ignore this dependency` 将关闭此 PR 并阻止 Dependabot 为此依赖项创建更多 PR（除非你重新打开此 PR 或自行升级）

</details>

## The Story of This Pull Request

在持续集成的开发流程中，保持依赖项的及时更新至关重要，这能确保项目获得安全修复、性能改进和新功能。PR #21994 就是一个由自动化工具 Dependabot 发起的常规依赖维护任务。它的核心目标很明确：将 Rust 项目 Bevy 中使用的基准测试库 `criterion` 从版本 0.7.0 更新至最新的 0.8.0。

对于一个像 Bevy 这样的大型开源游戏引擎，基准测试是衡量性能变化、防止回归的关键工具。`criterion.rs` 是 Rust 生态系统中广泛使用的基准测试库，它提供了统计分析、HTML报告等高级功能。保持其最新版本意味着基准测试套件能利用库的最新改进，从而可能获得更准确的测量结果和更好的报告体验。

这次更新的触发点很简单：`criterion` 项目在 2025年11月29日发布了 0.8.0 版本。Dependabot 自动检测到 Bevy 项目的 `benches/Cargo.toml` 文件中的版本约束 (`version = "0.7.0"`) 低于可用的最新版本，于是自动创建了此 PR 提议进行升级。

在审查此类依赖更新时，工程师需要重点关注的是更新日志中列出的**破坏性变更 (Breaking Changes)**。对于 `criterion 0.8.0`，主要的变化是移除了对 `async-std` 异步运行时的支持。这是一个重要的技术细节。如果 Bevy 的基准测试代码中使用了 `criterion` 的 `async-std` 相关功能，那么这次更新就会导致编译失败。因此，维护者在合并前必须评估这个风险。

从 PR 被快速合并（创建约 50 分钟后）这一事实来看，可以推断出 Bevy 的基准测试很可能并未依赖 `async-std` 功能。它们可能主要使用标准的同步基准测试，或者使用的是 `tokio` 作为异步运行时（`criterion` 在 0.6.0 版本中增强了对 `tokio` 的支持）。这使得这次版本升级成为一个低风险的变更。

从技术实施角度看，这个 PR 的解决方案极其直接：修改 `Cargo.toml` 文件中的一行代码。这就是现代依赖管理的典型情况——复杂的升级工作往往由库的作者在语义化版本控制的规范下完成，而使用方只需要更新版本号即可。Cargo 会负责解析和下载正确的版本，并确保所有传递依赖的一致性。

除了移除 `async-std` 支持，`criterion 0.8.0` 还带来了一些积极的改进，例如“基于 alloca 的内存布局随机化以减轻内存效应对测量的影响”。这对于追求高精度基准测试的项目来说是有价值的，因为它有助于减少由内存访问模式不一致引入的测量噪声。此外，新版本还提升了最低支持的 Rust 版本 (MSRV) 至 1.86，这反过来也会推动 Bevy 项目本身的 MSRV 要求，确保整个工具链保持在一个较新的、得到良好支持的状态。

最终，维护者 `mockersf` 审查了变更，确认其兼容性后，执行了合并。这个 PR 的关闭完成了依赖更新周期中的一个标准步骤，确保了 Bevy 的基准测试基础设施建立在最新、最稳定的工具之上，同时也体现了在大型项目中利用自动化工具进行依赖维护的高效性。

## Visual Representation

```mermaid
graph TD
    A[Dependabot] --> B{检测到新版本<br/>criterion 0.8.0 发布}
    B --> C[创建 PR #21994]
    C --> D{维护者审查<br/>检查 Breaking Changes}
    D -->|无冲突| E[合并 PR]
    D -->|有冲突| F[需要手动调整代码]
    E --> G[benches/Cargo.toml 更新]
    G --> H[Bevy 基准测试使用新版本]
    
    subgraph “关键变更内容”
        I[移除 async-std 支持]
        J[内存布局随机化]
        K[提升 MSRV 至 1.86]
    end
    
    H -.-> I
    H -.-> J
    H -.-> K
```

## Key Files Changed

**`benches/Cargo.toml`**
这个文件是 Rust 项目中 `benches` 目录下的 Cargo 清单文件，专门用于管理基准测试的依赖和配置。
1.  **变更内容与原因**：将 `criterion` 依赖的版本号从 `0.7.0` 更新为 `0.8.0`。这是本次 PR 的唯一变更，目的是让 Bevy 的基准测试套件使用 `criterion` 库的最新主要版本，以获得新功能、性能改进和修复。
2.  **代码差异**：
    ```diff
    diff --git a/benches/Cargo.toml b/benches/Cargo.toml
    index f569def4edbfd..8940f1eed7105 100644
    --- a/benches/Cargo.toml
    +++ b/benches/Cargo.toml
    @@ -10,7 +10,7 @@ autobenches = false
     [dependencies]
     # The primary crate that runs and analyzes our benchmarks. This is a regular dependency because the
     # `bench!` macro refers to it in its documentation.
    -criterion = { version = "0.7.0", features = ["html_reports"] }
    +criterion = { version = "0.8.0", features = ["html_reports"] }
     
     [dev-dependencies]
     # Bevy crates
    ```
    注意代码中的注释说明了为何将 `criterion` 声明为常规依赖（`[dependencies]`）而非开发依赖（`[dev-dependencies]`）：因为项目内部使用的 `bench!` 宏在其文档中引用了 `criterion` 类型。这一配置在版本更新中保持不变。同时，启用的 `html_reports` 特性也得以保留，确保了基准测试后继续生成 HTML 格式的详细报告。
3.  **与 PR 目标的关系**：这个文件是本次更新的核心所在。版本字符串的修改直接实现了 PR 的目标——升级 `criterion` 依赖。

## Further Reading
-   **[criterion.rs GitHub Repository](https://github.com/criterion-rs/criterion.rs)**: `criterion` 库的官方代码库，可以查阅源码、详细文档和最新动态。
-   **[Semantic Versioning (SemVer)](https://semver.org/)**: 理解语义化版本控制对于解读依赖更新日志（尤其是 Major 版本升级）中的“破坏性变更”至关重要。
-   **[Dependabot Documentation](https://docs.github.com/en/code-security/dependabot)**: 了解如何在 GitHub 项目中配置和使用 Dependabot 来自动管理依赖项更新。
-   **[Cargo: The Rust Package Manager Book](https://doc.rust-lang.org/cargo/)**: 学习 Cargo.toml 文件的完整语法和依赖管理机制。

# Full Code Diff
diff --git a/benches/Cargo.toml b/benches/Cargo.toml
index f569def4edbfd..8940f1eed7105 100644
--- a/benches/Cargo.toml
+++ b/benches/Cargo.toml
@@ -10,7 +10,7 @@ autobenches = false
 [dependencies]
 # The primary crate that runs and analyzes our benchmarks. This is a regular dependency because the
 # `bench!` macro refers to it in its documentation.
-criterion = { version = "0.7.0", features = ["html_reports"] }
+criterion = { version = "0.8.0", features = ["html_reports"] }
 
 [dev-dependencies]
 # Bevy crates