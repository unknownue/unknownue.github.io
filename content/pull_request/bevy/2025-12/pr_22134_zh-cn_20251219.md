+++
title = "#22134 Move allow unsafe_op_in_unsafe_fn to module level in bevy_ecs"
date = "2025-12-19T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = false

[extra]
current_language = "zh-cn"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-12/pr-22134-en-20251219" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-12/pr-22134-zh-cn-20251219" }}
+++

# Title
## Move allow unsafe_op_in_unsafe_fn to module level in bevy_ecs

## 基本信息
- **标题**: Move allow unsafe_op_in_unsafe_fn to module level in bevy_ecs
- **PR 链接**: https://github.com/bevyengine/bevy/pull/22134
- **作者**: hymm
- **状态**: 已合并
- **标签**: A-ECS, C-Code-Quality, S-Ready-For-Final-Review, X-Contentious, D-Straightforward
- **创建时间**: 2025-12-15T20:17:02Z
- **合并时间**: 2025-12-19T01:56:14Z
- **合并者**: alice-i-cecile

## 描述翻译

### 目标
- 缩小 `expect unsafe_op_in_unsafe_fn` 属性的作用范围，以便我们能够逐步移除它们。

### 测试
- `cargo check` 没有显示任何警告。

## 本次 Pull Request 的故事

这个 PR 的核心是一个关于代码质量和安全性治理的战术性调整。它没有引入新功能或修复某个具体的运行时 Bug，而是针对 Rust 编译器的 `unsafe_op_in_unsafe_fn` lint 规则进行了一次作用域的精确化。

**问题与背景**
在 Rust 中，`unsafe` 关键字用于标记那些可能违反内存安全或其他安全约定的代码块。编译器提供了一个名为 `unsafe_op_in_unsafe_fn` 的 lint，用于检查在标记为 `unsafe fn` 的函数内部，是否所有潜在的不安全操作都被显式地包裹在 `unsafe` 块中。这是一个重要的安全护栏，它强制开发者明确指出函数中哪些具体行是安全假设的边界。然而，在 Bevy ECS 这个广泛使用 `unsafe` 代码以实现高性能的模块中，当时存在大量代码尚未遵守此规则。

为了解决这个问题并推进代码库的现代化，项目在 Issue #11590 中创建了一个跟踪任务。作为过渡策略，开发者们在根模块（`lib.rs`）中放置了一个 `#![expect(unsafe_op_in_unsafe_fn)]` 属性。`expect` 是 `allow` 的一个变体，它表示“我知道这里有警告，但我期望它存在，请暂时不要报错”。这相当于对整个 `bevy_ecs` 库暂时禁用了这条 lint 的检查。这种方法虽然避免了编译警告的干扰，但代价是失去了对库内所有不安全代码的精细监督。问题在于作用域过于宽泛，无法定位到具体哪些模块或函数还需要进一步清理。

**解决方案**
作者 `hymm` 采取的方案是“作用域下沉”。将原本在 `crates/bevy_ecs/src/lib.rs` 中的全局 `expect` 属性移除，然后将其精确地添加到那些确实包含大量 `unsafe` 代码、且尚未完全遵守 `unsafe_op_in_unsafe_fn` 规则的子模块中。这样做有多个好处：
1.  **精确化范围**：现在只有被标注的特定模块（如 `query`, `world`, `storage`）才被豁免检查，其他模块如果违反规则则会立即产生警告。
2.  **渐进式清理**：这为开发者提供了一个清晰的路线图。团队可以逐个模块地移除 `expect` 属性，并解决其中暴露出的具体警告，而无需一次性处理整个庞大的代码库。
3.  **提升代码审查清晰度**：在未来的 PR 中，如果修改了未被豁免的模块并引入了不规范的 `unsafe` 使用，CI 会立刻捕获并报告，有助于维护代码安全标准。

**具体实现**
从代码 diff 可以看出，修改主要分为两类：

1.  **模块级属性移动**：这是 PR 的主体。作者从 `lib.rs` 中删除了以下属性：
    ```rust
    #![expect(
        unsafe_op_in_unsafe_fn,
        reason = "See #11590. To be removed once all applicable unsafe code has an unsafe block with a safety comment."
    )]
    ```
    然后将其逐个添加到 7 个核心子模块的文件顶部：
    - `crates/bevy_ecs/src/bundle/mod.rs`
    - `crates/bevy_ecs/src/entity/clone_entities.rs`
    - `crates/bevy_ecs/src/query/mod.rs`
    - `crates/bevy_ecs/src/storage/mod.rs`
    - `crates/bevy_ecs/src/system/system_param.rs`
    - `crates/bevy_ecs/src/world/mod.rs`

    每个添加都附带了相同的 `reason`，指向跟踪 Issue #11590。

2.  **一处具体的 `unsafe` 块包装**：在 `multi_threaded.rs` 中，有一段与 `hotpatching` 特性相关的代码。原来它直接在 `unsafe fn` 内部调用了可能不安全的 `get_resource_ref` 方法。PR 将这部分逻辑明确地包裹进了一个 `unsafe` 块中，并添加了详细的 `Safety` 注释来解释为何此操作在当前上下文中是安全的（依赖于 `hotpatching` 特性仅用于开发环境这一前提）。这是一个“言行一致”的体现——在推动更严格 lint 的同时，立即修复了一个可以顺手处理的具体案例。
    ```rust
    // 修改前
    let hotpatch_tick = context
        .environment
        .world_cell
        .get_resource_ref::<HotPatchChanges>()
        .map(|r| r.last_changed())
        .unwrap_or_default();

    // 修改后
    let hotpatch_tick = unsafe {
        context
            .environment
            .world_cell
            .get_resource_ref::<HotPatchChanges>()
    }
    .map(|r| r.last_changed())
    .unwrap_or_default();
    ```

3.  **一处属性移除**：在 `combinator.rs` 中，一个内嵌的 `#![deny(unsafe_op_in_unsafe_fn)]` 被移除了。这很可能是因为该属性现在由新添加的父模块级 `expect` 属性管理，或者该函数内部的 `unsafe` 使用已经符合规范，不再需要局部的、更严格的 `deny`。

**技术洞察与影响**
这个 PR 展示了管理大型 Rust 代码库中技术债务的一种有效模式：使用编译器的 lint 系统作为强制性的“待办事项清单”。通过将全局性的抑制（`allow`/`expect`）分解为模块级的抑制，团队能够：
*   **降低认知负荷**：开发者可以专注于一个模块内的安全问题。
*   **实现可衡量的进展**：每清理完一个模块并移除其 `expect` 属性，就是一个明确的、可验证的进度。
*   **防止倒退**：未被豁免的模块受到持续监督，任何不符合安全约定的新代码都会立即被标记。

对于 Bevy ECS 而言，这个改动是向完全遵守 Rust 安全实践迈出的重要一步。它没有改变任何运行时行为，但显著提升了代码库的长期可维护性和安全性。`cargo check` 无警告的结果也表明，这次重构是干净、无副作用的。

**潜在收获**
从这个 PR 中，我们可以学到，处理大型代码库中的广泛警告或技术债务时，一个策略性的中间步骤（如模块级豁免）远比“全部修复”或“全部忽略”更为可行和有效。它平衡了开发速度与代码质量，并为未来的改进铺平了道路。

## 可视化表示

```mermaid
graph TD
    LibRs[lib.rs<br/>移除全局 expect 属性] --> Module1[bundle/mod.rs<br/>添加模块级 expect]
    LibRs --> Module2[query/mod.rs<br/>添加模块级 expect]
    LibRs --> Module3[storage/mod.rs<br/>添加模块级 expect]
    LibRs --> Module4[world/mod.rs<br/>添加模块级 expect]
    LibRs --> Module5[clone_entities.rs<br/>添加模块级 expect]
    LibRs --> Module6[system_param.rs<br/>添加模块级 expect]
    
    SubGraph[子模块修改]
        Module7[combinator.rs<br/>移除内部的 deny 属性]
        Module8[multi_threaded.rs<br/>用 unsafe 块包装代码<br/>并添加安全注释]
    end
    
    LibRs --> SubGraph
```

## 关键文件变更

### 1. `crates/bevy_ecs/src/lib.rs`
**变更描述**：移除了原本应用于整个库的 `unsafe_op_in_unsafe_fn` expect 属性，为将其下放到具体模块做准备。
```rust
// 修改前：
#![expect(
    unsafe_op_in_unsafe_fn,
    reason = "See #11590. To be removed once all applicable unsafe code has an unsafe block with a safety comment."
)]
#![doc = include_str!("../README.md")]

// 修改后：
#![doc = include_str!("../README.md")]
```

### 2. `crates/bevy_ecs/src/query/mod.rs`
**变更描述**：作为核心模块之一，被添加了模块级的 `expect` 属性，表明该模块内仍有大量 `unsafe` 代码需要逐步规范化。
```rust
// 修改后（在文件顶部添加）：
#![expect(
    unsafe_op_in_unsafe_fn,
    reason = "See #11590. To be removed once all applicable unsafe code has an unsafe block with a safety comment."
)]
```

### 3. `crates/bevy_ecs/src/schedule/executor/multi_threaded.rs`
**变更描述**：这是本次 PR 中除属性移动外，唯一的实质性代码修改。它将一段可能不安全的操作显式地包裹在 `unsafe` 块中，并添加了 Clippy 豁免注释和安全说明，为未来移除 `expect` 属性做准备。
```rust
// 修改前：
let hotpatch_tick = context
    .environment
    .world_cell
    .get_resource_ref::<HotPatchChanges>()
    .map(|r| r.last_changed())
    .unwrap_or_default();

// 修改后：
#[expect(
    clippy::undocumented_unsafe_blocks,
    reason = "This actually could result in UB if a system tries to mutate
    `HotPatchChanges`. We allow this as the resource only exists with the `hotpatching` feature.
    and `hotpatching` should never be enabled in release."
)]
let hotpatch_tick = unsafe {
    context
        .environment
        .world_cell
        .get_resource_ref::<HotPatchChanges>()
}
.map(|r| r.last_changed())
.unwrap_or_default();
```

### 4. `crates/bevy_ecs/src/system/combinator.rs`
**变更描述**：移除了一个函数内部局部的 `#![deny(unsafe_op_in_unsafe_fn)]` 属性。这可能是因为该属性与新的模块级策略冲突或已不再需要。
```rust
// 修改前（在函数内部）：
fn combine(...) -> ... {
    #![deny(unsafe_op_in_unsafe_fn)]
    // ... 函数体
}

// 修改后：
fn combine(...) -> ... {
    // ... 函数体（不再有 deny 属性）
}
```

## 扩展阅读
1.  **Rust 官方 unsafe 代码指南**: [The Rustonomicon](https://doc.rust-lang.org/nomicon/) - 深入理解 Rust 中 `unsafe` 的语义和安全编程的边界。
2.  **Rust Lint 列表**: [Rustc Lint List](https://doc.rust-lang.org/rustc/lints/index.html) - 查看所有编译器 lint 及其说明，包括 `unsafe_op_in_unsafe_fn`。
3.  **Bevy Issue #11590**: [Tracking: Unsafe code in `unsafe fn` without unsafe blocks](https://github.com/bevyengine/bevy/issues/11590) - 本次修改所追踪的原始 issue，了解更广泛的上下文和最终目标。
4.  **Rust 属性 `expect`**: [The `expect` attribute](https://doc.rust-lang.org/rustc/lints/levels.html#the-expect-attribute) - 了解 `expect` 与 `allow`、`warn`、`deny` 的区别及其用途。