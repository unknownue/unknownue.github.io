+++
title = "#22140 impl `Measured3d` for `ConicalFrustum`"
date = "2025-12-16T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = true

[taxonomies]
list_display = ["show"]

[extra]
current_language = "en"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-12/pr-22140-en-20251216" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-12/pr-22140-zh-cn-20251216" }}
labels = ["C-Usability", "A-Math", "D-Straightforward"]
+++

# Title

## Basic Information
- **Title**: impl `Measured3d` for `ConicalFrustum`
- **PR Link**: https://github.com/bevyengine/bevy/pull/22140
- **Author**: lynn-lumen
- **Status**: MERGED
- **Labels**: C-Usability, S-Ready-For-Final-Review, A-Math, X-Uncontroversial, D-Straightforward
- **Created**: 2025-12-15T22:25:24Z
- **Merged**: 2025-12-16T03:53:39Z
- **Merged By**: alice-i-cecile

## Description Translation

# Objective

- implement `Measured3d` for `ConicalFrustum`

## Solution

- implemented `Measured3d` for `ConicalFrustum`
- Added _helper_ functions like `frustum.slant_height()` similar to what is present for `Cone`

## Testing

- There is a test for the implementation


## The Story of This Pull Request

This PR addresses a consistency gap in Bevy's math primitives by implementing the `Measured3d` trait for the `ConicalFrustum` type. The `Measured3d` trait is a standard interface in Bevy's geometry system that provides methods for calculating volume and surface area of 3D shapes.

The `ConicalFrustum` struct had been missing this implementation, which created an inconsistency in the API. Other 3D primitives like `Cone`, `Sphere`, and `Cuboid` already had `Measured3d` implementations, making `ConicalFrustum` an outlier. Without this trait implementation, developers couldn't easily calculate basic geometric properties of conical frustums using the standard Bevy interface.

The implementation follows established patterns in the codebase. Looking at other implementations, particularly the `Cone` type, the developer identified the need for several helper methods to calculate the geometric properties required for the `Measured3d` trait. These helper methods serve two purposes: they break down complex calculations into manageable pieces, and they provide a public API for developers who need to access intermediate geometric values.

The key implementation decisions were:
1. Following the established pattern from the `Cone` implementation for consistency
2. Adding `#[inline]` attributes on all methods since they're simple calculations
3. Providing `#[doc(alias)]` attributes for alternative naming (like `side_length` for `slant_height`)
4. Using `PI` and `FRAC_PI_3` constants from the standard library for mathematical precision

The volume calculation for a conical frustum uses the standard formula: `(πh/3) * (R² + r² + Rr)` where `h` is the height, `R` is the bottom radius, and `r` is the top radius. The surface area calculation sums the areas of the two circular bases and the lateral (side) area.

The lateral area calculation requires the slant height, which is computed using the Pythagorean theorem: `√((R - r)² + h²)`. Once the slant height is known, the lateral surface area is `π(R + r) * slant_height`.

The implementation includes comprehensive testing with specific numeric values to ensure correctness. The test verifies all the helper methods as well as the `Measured3d` trait methods. This is important because geometric calculations can have subtle edge cases, especially with floating-point arithmetic.

From an engineering perspective, this change improves the completeness of Bevy's geometry API. Developers can now treat `ConicalFrustum` consistently with other 3D primitives when they need geometric measurements. The helper methods also provide additional utility beyond just the trait implementation, giving developers access to intermediate calculations they might need for other purposes.

The implementation is straightforward and follows established patterns, which explains why it was labeled as "D-Straightforward" and "X-Uncontroversial". The changes are additive and don't break existing functionality, making this a safe enhancement to the codebase.

## Visual Representation

```mermaid
graph TD
    A[ConicalFrustum struct] --> B[New helper methods]
    B --> C[Measured3d trait implementation]
    C --> D[volume() method]
    C --> E[area() method]
    B --> F[bottom_base()]
    B --> G[top_base()]
    B --> H[slant_height()]
    B --> I[lateral_area()]
    B --> J[bottom_base_area()]
    B --> K[top_base_area()]
```

## Key Files Changed

**crates/bevy_math/src/primitives/dim3.rs** (+90/-0)

This file contains the 3D geometric primitives in Bevy. The changes add a new implementation block for `ConicalFrustum` with helper methods and implement the `Measured3d` trait.

Before the PR, the `ConicalFrustum` struct only had basic fields and a `Default` implementation:

```rust
impl Default for ConicalFrustum {
    fn default() -> Self {
        Self {
            radius_top: 0.5,
            radius_bottom: 1.0,
            height: 1.0,
        }
    }
}
```

After the PR, the `ConicalFrustum` has a full suite of geometric calculation methods:

```rust
impl ConicalFrustum {
    /// Get the bottom base of the conical frustum as a [`Circle`]
    #[inline]
    pub const fn bottom_base(&self) -> Circle {
        Circle {
            radius: self.radius_bottom,
        }
    }

    /// Get the top base of the conical frustum as a [`Circle`]
    #[inline]
    pub const fn top_base(&self) -> Circle {
        Circle {
            radius: self.radius_top,
        }
    }

    /// Get the slant height of the conical frustum, the length of the line segment
    /// connecting a point on the base to the closest point on the top
    #[inline]
    #[doc(alias = "side_length")]
    pub fn slant_height(&self) -> f32 {
        ops::hypot(self.radius_bottom - self.radius_top, self.height)
    }

    /// Get the surface area of the side of the conical frustum,
    /// also known as the lateral area
    #[inline]
    #[doc(alias = "side_area")]
    pub fn lateral_area(&self) -> f32 {
        PI * (self.radius_bottom + self.radius_top) * self.slant_height()
    }

    /// Get the surface area of the bottom base of the conical frustum
    #[inline]
    pub fn bottom_base_area(&self) -> f32 {
        PI * self.radius_bottom.squared()
    }

    /// Get the surface area of the top base of the conical frustum
    #[inline]
    pub fn top_base_area(&self) -> f32 {
        PI * self.radius_top.squared()
    }
}

impl Measured3d for ConicalFrustum {
    #[inline]
    fn volume(&self) -> f32 {
        FRAC_PI_3
            * self.height
            * (self.radius_bottom * self.radius_bottom
                + self.radius_top * self.radius_top
                + self.radius_top * self.radius_bottom)
    }
    #[inline]
    fn area(&self) -> f32 {
        self.bottom_base_area() + self.top_base_area() + self.lateral_area()
    }
}
```

The PR also adds a comprehensive test:

```rust
#[test]
fn conical_frustum_math() {
    let frustum = ConicalFrustum {
        height: 9.0,
        radius_top: 1.0,
        radius_bottom: 2.0,
    };
    assert_eq!(
        frustum.bottom_base(),
        Circle { radius: 2.0 },
        "bottom base produces incorrect circle"
    );
    assert_eq!(
        frustum.top_base(),
        Circle { radius: 1.0 },
        "top base produces incorrect circle"
    );
    assert_eq!(frustum.slant_height(), 9.055386, "incorrect slant height");
    assert_eq!(frustum.lateral_area(), 85.345, "incorrect lateral area");
    assert_eq!(
        frustum.bottom_base_area(),
        12.566371,
        "incorrect bottom base area"
    );
    assert_eq!(frustum.top_base_area(), PI, "incorrect top base area");
    assert_eq!(frustum.area(), 101.05296, "incorrect surface area");
    assert_eq!(frustum.volume(), 65.97345, "incorrect volume");
}
```

## Further Reading

1. **Bevy Math Primitives Documentation**: For understanding the overall structure of geometric primitives in Bevy
2. **The `Measured3d` Trait**: To see how other 3D shapes implement this trait for consistency
3. **Geometric Formulas for Frustums**: Standard mathematical references for conical frustum volume and surface area calculations
4. **Rust Traits and Inlining**: Understanding when and why to use `#[inline]` attributes in trait implementations