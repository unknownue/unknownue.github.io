+++
title = "#21823 Improve `ThinSlicePtr` API"
date = "2025-11-28T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = true

[taxonomies]
list_display = ["show"]

[extra]
current_language = "en"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-11/pr-21823-en-20251128" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-11/pr-21823-zh-cn-20251128" }}
labels = ["C-Docs", "C-Code-Quality", "M-Migration-Guide", "A-Pointers", "D-Straightforward", "D-Unsafe"]
+++

# Improve `ThinSlicePtr` API

## Basic Information
- **Title**: Improve `ThinSlicePtr` API
- **PR Link**: https://github.com/bevyengine/bevy/pull/21823
- **Author**: BD103
- **Status**: MERGED
- **Labels**: C-Docs, C-Code-Quality, S-Ready-For-Final-Review, M-Migration-Guide, A-Pointers, D-Straightforward, D-Unsafe
- **Created**: 2025-11-13T02:10:27Z
- **Merged**: 2025-11-28T08:30:42Z
- **Merged By**: mockersf

## Description Translation
# Objective

- Although unsafe, `ThinSlicePtr::get()` doesn't signal that it doesn't perform bounds checking unless you are familiar with the API.
- `ThinSlicePtr::get()` takes `self`, not `&self`, meaning it consumes the `ThinSlicePtr` each time `get()` is called. This does not match the behavior of [`slice.get()`](https://doc.rust-lang.org/stable/std/primitive.slice.html#method.get), which takes `&self`.
  - This small issue was hidden by the fact that `ThinSlicePtr` implements `Copy`. This isn't a large issue because it all compiles down to the same machine code, but there's no point to `get()` requiring `self`.
- `ThinSlicePtr` could use better documentation, and could be improved a little in some areas.

## Solution

- Rename `ThinSlicePtr::get()` to `get_unchecked()`, making the API mirror [`slice.get_unchecked()`](https://doc.rust-lang.org/stable/std/primitive.slice.html#method.get_unchecked). The old `get()` is kept as a deprecated method, to be removed in 1.19.0.
- Make the new `slice.get_unchecked()` take `&self` rather than `self`.
- Add more documentation and slightly re-arrange code, while maintaining original behavior.

## Testing

- Any unintentional changes should be caught by the Rust Compiler and Miri!

## The Story of This Pull Request

The `ThinSlicePtr` type in Bevy is a performance-optimized slice representation that strips out length information in release builds to reduce memory overhead. This optimization comes with a safety trade-off: without bounds checking, developers must ensure they don't access out-of-bounds elements. The original API design had two main issues that this PR addresses.

First, the method `ThinSlicePtr::get()` was unsafe but didn't clearly signal this in its name. Unlike Rust's standard library which uses `get_unchecked()` for unsafe slice access, Bevy's method was simply called `get()`. This created a potential footgun where developers might assume bounds checking was happening when it wasn't.

Second, the method signature took `self` rather than `&self`, which was inconsistent with standard Rust slice APIs. While `ThinSlicePtr` implements `Copy`, making this mostly a compile-time concern, it created unnecessary API divergence from familiar patterns.

The solution implemented a straightforward refactor: rename `get()` to `get_unchecked()` and change the parameter from `self` to `&self`. This aligns the API with Rust conventions while maintaining the same performance characteristics. The old method was kept as deprecated to provide a migration path.

The implementation required updates across the Bevy codebase where `ThinSlicePtr::get()` was used. In the ECS system, multiple query implementations were updated to use the new `get_unchecked()` method. These changes are in performance-critical paths where the bounds checking is already handled by higher-level logic, making the unsafe access appropriate.

The PR also significantly improved documentation for `ThinSlicePtr`, adding comprehensive examples and safety explanations. The new documentation clarifies that the type only performs bounds checking in debug builds, and that callers are responsible for ensuring index validity in release builds.

From an engineering perspective, this change demonstrates good API design principles: consistency with established conventions, clear signaling of unsafe operations, and maintaining backward compatibility through deprecation cycles. The changes are minimal but impactful, improving both code safety and developer experience.

## Visual Representation

```mermaid
graph TD
    A[ThinSlicePtr] --> B[get_unchecked]
    A --> C[get (deprecated)]
    B --> D[&self parameter]
    C --> E[self parameter]
    D --> F[Unsafe access]
    E --> F
    F --> G[Performance optimized]
    G --> H[No bounds checking in release]
```

## Key Files Changed

### `crates/bevy_ptr/src/lib.rs` (+48/-11)

This file contains the core implementation changes for `ThinSlicePtr`. The modifications improve API clarity and documentation while maintaining the same unsafe access behavior.

**Key changes:**
- Added comprehensive documentation with examples
- Renamed `get()` to `get_unchecked()` 
- Changed parameter from `self` to `&self`
- Added deprecated `get()` method for backward compatibility
- Improved code organization and safety comments

```rust
// Before:
pub unsafe fn get(self, index: usize) -> &'a T {
    #[cfg(debug_assertions)]
    debug_assert!(index < self.len);

    let ptr = self.ptr.as_ptr();
    unsafe { &*ptr.add(index) }
}

// After:
pub unsafe fn get_unchecked(&self, index: usize) -> &'a T {
    #[cfg(debug_assertions)]
    assert!(index < self.len, "tried to index out-of-bounds of a slice");

    unsafe { &*self.ptr.add(index).as_ptr() }
}

#[deprecated(since = "0.18.0", note = "use get_unchecked() instead")]
pub unsafe fn get(self, index: usize) -> &'a T {
    unsafe { self.get_unchecked(index) }
}
```

### `release-content/migration-guides/thin_slice_ptr_get_unchecked.md` (+21/-0)

This new file provides migration guidance for the API change, explaining how to update code from the old `get()` method to the new `get_unchecked()`.

```markdown
---
title: Rename `ThinSlicePtr::get()` to `ThinSlicePtr::get_unchecked()`
pull_requests: [21823]
---

`ThinSlicePtr::get()` has been deprecated in favor of the new `ThinSlicePtr::get_unchecked()`
method in order to more clearly signal that bounds checking is not performed. Beyond the name
change, the only difference between these two methods is that `get_unchecked()` takes `&self` while
`get()` takes `self`. In order to migrate, simply rename all usages of `get()` with
`get_unchecked()`:

```rust
let slice: &[u32] = &[2, 4, 8];
let thin_slice = ThinSlicePtr::from(slice);

// 0.17
let x = unsafe { thin_slice.get(0) };

// 0.18
let x = unsafe { thin_slice.get_unchecked(0) };
```
```

### `crates/bevy_ecs/src/query/fetch.rs` (+11/-9) and `crates/bevy_ecs/src/query/filter.rs` (+2/-2)

These files contain updates to ECS query implementations that use `ThinSlicePtr`. The changes are mechanical replacements of `get()` with `get_unchecked()`.

```rust
// Example from fetch.rs - before:
let item = unsafe { table.get(table_row.index()) };

// After:
let item = unsafe { table.get_unchecked(table_row.index()) };
```

## Further Reading

- [Rust Standard Library: slice::get_unchecked](https://doc.rust-lang.org/stable/std/primitive.slice.html#method.get_unchecked) - The standard library method this PR aligns with
- [Bevy Engine: Unsafe Code Guidelines](https://github.com/bevyengine/bevy/blob/main/UNSAFE.md) - Bevy's approach to unsafe code
- [Rustonomicon](https://doc.rust-lang.org/nomicon/) - Comprehensive guide to unsafe Rust programming