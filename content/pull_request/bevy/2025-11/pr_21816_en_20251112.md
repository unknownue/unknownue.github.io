+++
title = "#21816 Prevent DoF effect disappearing at small `focus_distances`"
date = "2025-11-12T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = true

[taxonomies]
list_display = ["show"]

[extra]
current_language = "en"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-11/pr-21816-en-20251112" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-11/pr-21816-zh-cn-20251112" }}
labels = ["C-Bug", "A-Rendering"]
+++

# Prevent DoF effect disappearing at small `focus_distances`

## Basic Information
- **Title**: Prevent DoF effect disappearing at small `focus_distances`
- **PR Link**: https://github.com/bevyengine/bevy/pull/21816
- **Author**: Breakdown-Dog
- **Status**: MERGED
- **Labels**: C-Bug, A-Rendering, S-Needs-Review
- **Created**: 2025-11-12T14:29:44Z
- **Merged**: 2025-11-12T19:54:36Z
- **Merged By**: mockersf

## Description Translation

# Objective

- In the `depth_of_field` example, setting `focal_distance` to a small value (<= 0.02) causes the DoF effect to disappear unexpectedly.

<img width="1936" height="1129" alt="before" src="https://github.com/user-attachments/assets/ea12016e-b9d5-4232-b8e0-b354efdecaae" />

- I believe that a small focal_distance makes `(focus - f)` zero or negative. This leads to a non-positive candidate_coc, which is then clamped to 0.0, effectively disabling the DoF effect.

- Although the formula is physically accurate, we cannot assume users have a deep understanding of the depth of field effect. This will make them confused.

## Solution

- Use `max(focus - f, EPSILON)` to ensure the denominator is always positive.

- Now, the effect looks correct.

<img width="1938" height="1135" alt="later" src="https://github.com/user-attachments/assets/4462bc78-e5d1-4d74-a9c7-d69ed111b4c6" />

## Testing

- CI

---

## The Story of This Pull Request

This PR addresses a subtle but important issue in Bevy's Depth of Field (DoF) post-processing effect where the blur effect would unexpectedly disappear when users set very small focal distance values. The problem was rooted in the mathematical precision of the circle of confusion calculation within the shader code.

The core issue occurred in the DoF shader's `calculate_circle_of_confusion` function. When users set a focal distance of 0.02 or smaller, the term `(focus - f)` in the denominator could become zero or negative due to floating-point precision limitations. This caused the calculated `candidate_coc` value to become non-positive, which was then clamped to 0.0 by the subsequent `clamp()` call, effectively disabling the Depth of Field effect entirely.

The developer took a practical approach to solve this problem. Instead of requiring users to understand the complex physics behind depth of field calculations, they introduced a small epsilon value to ensure numerical stability. The solution adds a constant `EPSILON` set to `1.19209290e-07` (which is the machine epsilon for 32-bit floating point numbers) and modifies the denominator calculation to use `max(focus - f, EPSILON)`. This guarantees that the denominator remains positive even when `focus - f` approaches zero, preventing the circle of confusion from being clamped to zero.

The implementation demonstrates good software engineering practices. The epsilon value is defined as a named constant with a clear comment explaining its purpose: "used to ensure `depth * (focus - f)` is always a positive number". This makes the code more maintainable and the intent obvious to future developers.

An additional minor but thoughtful change was made to the example code - increasing the decimal precision of the aperture F-stop display from two to three decimal places. This improvement helps users better visualize and control the aperture settings when working with very small values.

The fix is mathematically sound and preserves the physical accuracy of the DoF effect while making it more robust against edge cases. By preventing the denominator from reaching zero or negative values, the shader maintains consistent behavior across the entire range of user-configurable parameters.

## Visual Representation

```mermaid
graph TD
    A[User sets small focal_distance] --> B[focus - f becomes <= 0]
    B --> C[candidate_coc becomes non-positive]
    C --> D[clamp() sets CoC to 0.0]
    D --> E[DoF effect disappears]
    
    F[Fix: Add EPSILON constant] --> G[Use max(focus - f, EPSILON)]
    G --> H[Denominator always positive]
    H --> I[CoC calculation stable]
    I --> J[DoF effect preserved]
```

## Key Files Changed

### `crates/bevy_post_process/src/dof/dof.wgsl`

This is the core shader file where the Depth of Field effect is implemented. The changes ensure numerical stability in the circle of confusion calculation.

**Key modifications:**
```wgsl
// Before:
let candidate_coc = scale * abs(depth - focus) / (depth * (focus - f));

// After:
const EPSILON: f32 = 1.19209290e-07;
let candidate_coc = scale * abs(depth - focus) / (depth * max(focus - f, EPSILON));
```

The addition of the `EPSILON` constant and the use of `max()` function prevent division by zero or negative values, which was causing the DoF effect to disappear at small focal distances.

### `examples/3d/depth_of_field.rs`

This example file demonstrates the Depth of Field effect. The change improves the display precision of aperture values.

**Key modification:**
```rust
// Before:
"Aperture F-stops: f/{:.2} (Press Left/Right to change)"

// After:  
"Aperture F-stops: f/{:.3} (Press Left/Right to change)"
```

This minor change from `{:.2}` to `{:.3}` formatting provides better visual feedback when users adjust aperture settings with small values.

## Further Reading

- [Circle of Confusion in Computer Graphics](https://en.wikipedia.org/wiki/Circle_of_confusion)
- [Floating Point Precision and Machine Epsilon](https://en.wikipedia.org/wiki/Machine_epsilon)
- [Bevy Post-Processing Documentation](https://bevyengine.org/learn/books/introduction/features/post-processing/)
- [Depth of Field Physics](https://en.wikipedia.org/wiki/Depth_of_field)