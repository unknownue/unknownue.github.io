+++
title = "#21713 Make `LoadContext::path` return an `AssetPath` instead of `std::path::Path`."
date = "2025-11-03T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = true

[taxonomies]
list_display = ["show"]

[extra]
current_language = "en"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-11/pr-21713-en-20251103" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-11/pr-21713-zh-cn-20251103" }}
labels = ["D-Trivial", "A-Assets", "C-Usability", "M-Migration-Guide"]
+++

# Title
Make `LoadContext::path` return an `AssetPath` instead of `std::path::Path`

## Basic Information
- **Title**: Make `LoadContext::path` return an `AssetPath` instead of `std::path::Path`.
- **PR Link**: https://github.com/bevyengine/bevy/pull/21713
- **Author**: andriyDev
- **Status**: MERGED
- **Labels**: D-Trivial, A-Assets, C-Usability, S-Ready-For-Final-Review, M-Migration-Guide
- **Created**: 2025-11-01T18:33:01Z
- **Merged**: 2025-11-03T19:08:09Z
- **Merged By**: alice-i-cecile

## Description Translation
# Objective

- In #21643, `LoadContext::path` was incorrectly being used to reference relative files. Since this was a `std::path::Path` instead of an `AssetPath`, it did not behave correctly in reference to custom asset sources.

## Solution

- Make `LoadContext::path` return an `AssetPath` and remove `LoadContext::asset_path`.

## The Story of This Pull Request

This PR addresses a fundamental issue in Bevy's asset loading system where the `LoadContext::path` method was returning a `std::path::Path` instead of an `AssetPath`. The problem surfaced in PR #21643 where developers were using this method to reference relative files, but it failed to work correctly with custom asset sources because `std::path::Path` lacks the context needed for proper asset resolution.

The core issue stems from the architectural mismatch between raw file system paths and Bevy's asset system. While `std::path::Path` represents a simple filesystem path, `AssetPath` encapsulates additional metadata and resolution logic needed for Bevy's asset pipeline, including support for custom asset sources and embedded assets.

The solution approach was straightforward but required careful implementation across multiple subsystems. The developer chose to:
1. Change the return type of `LoadContext::path` from `&Path` to `&AssetPath<'static>`
2. Remove the redundant `LoadContext::asset_path` method entirely
3. Update all call sites throughout the codebase to use the new API

This change represents a consolidation of the API surface while maintaining backward compatibility through careful migration. The implementation required updates across multiple asset loaders including image loading, shader compilation, GLTF model loading, and example code.

Key technical insights from this change:

1. **Asset Path Resolution**: The `AssetPath` type provides proper resolution for embedded assets and custom asset sources through methods like `resolve_embed()`, which `std::path::Path` cannot support.

2. **API Simplification**: By removing the duplicate `asset_path()` method, the API becomes more intuitive - there's now only one way to get the asset path from a load context.

3. **Cross-Platform Consistency**: The migration guide specifically mentions that `AssetPath` enforces cross-platform "slash" consistency, addressing issues like Windows path separators that were previously handled with manual string replacement.

The impact of this change is significant for asset loader developers. While the migration is technically straightforward (changing method calls), the behavioral difference is important: code that previously worked with simple filesystem paths now properly supports Bevy's complete asset system including custom sources and embedded assets.

## Visual Representation

```mermaid
graph TD
    A[LoadContext] --> B[path(): AssetPath]
    B --> C[Custom Asset Sources]
    B --> D[Embedded Assets]
    B --> E[Filesystem Paths]
    
    F[Old API] --> G[path(): Path]
    F --> H[asset_path(): AssetPath]
    
    style A fill:#e1f5fe
    style B fill:#c8e6c9
    style F fill:#ffcdd2
```

## Key Files Changed

### `crates/bevy_asset/src/loader.rs` (+10/-4)
This file contains the core `LoadContext` implementation where the API changes were made:

```rust
// Before:
pub fn path(&self) -> &Path {
    self.asset_path.path()
}

pub fn asset_path(&self) -> &AssetPath<'static> {
    &self.asset_path
}

// After:
pub fn path(&self) -> &AssetPath<'static> {
    &self.asset_path
}
```

The change consolidates the two methods into one, making `path()` return the more useful `AssetPath` directly.

### `crates/bevy_image/src/image_loader.rs` (+10/-4)
The image loader needed updates to handle the new return type:

```rust
// Before:
let ext = load_context.path().extension().unwrap().to_str().unwrap();

// After:
let ext = load_context
    .path()
    .path()
    .extension()
    .unwrap()
    .to_str()
    .unwrap();
```

When file system path operations are still needed, callers now access the underlying path via `asset_path.path()`.

### `crates/bevy_shader/src/shader.rs` (+9/-3)
Similar changes were needed in the shader loader:

```rust
// Before:
let ext = load_context.path().extension().unwrap().to_str().unwrap();
let path = load_context.asset_path().to_string();

// After:
let ext = load_context
    .path()
    .path()
    .extension()
    .unwrap()
    .to_str()
    .unwrap();
let path = load_context.path().to_string();
```

### `crates/bevy_gltf/src/loader/mod.rs` (+4/-4)
The GLTF loader updates demonstrate proper asset path resolution:

```rust
// Before:
let image_path = load_context
    .asset_path()
    .resolve_embed(uri)
    .expect("all URIs were already validated");

// After:
let image_path = load_context
    .path()
    .resolve_embed(uri)
    .expect("all URIs were already validated");
```

### `examples/asset/asset_decompression.rs` (+3/-3)
The example shows how to properly resolve embedded paths:

```rust
// Before:
let contained_path = compressed_path.join(uncompressed_file_name);

// After:
let contained_path = compressed_path
    .resolve_embed(uncompressed_file_name)
    .map_err(|_| GzAssetLoaderError::IndeterminateFilePath)?;
```

This change ensures the example works correctly with custom asset sources.

### `release-content/migration-guides/load_context_asset_path.md` (+14/-0)
The migration guide provides clear instructions:

```markdown
- `load_context.asset_path()` -> `load_context.path()`
- `load_context.path()` -> `load_context.asset_path().path()`
```

It also includes an important note about considering whether direct `Path` usage is appropriate given the limitations with custom asset sources.

## Further Reading

- [Bevy Asset System Documentation](https://docs.rs/bevy_asset/latest/bevy_asset/) - Comprehensive guide to Bevy's asset system
- [AssetPath API Documentation](https://docs.rs/bevy_asset/latest/bevy_asset/struct.AssetPath.html) - Details on AssetPath methods and capabilities
- [Custom Asset Sources](https://github.com/bevyengine/bevy/blob/main/examples/asset/custom_asset_source.rs) - Example of implementing custom asset sources
- [PR #21643](https://github.com/bevyengine/bevy/pull/21643) - The original PR that identified the issue

# Full Code Diff
*(Note: The full code diff was provided in the original request but is omitted here for brevity since the key changes are covered in the sections above.)*