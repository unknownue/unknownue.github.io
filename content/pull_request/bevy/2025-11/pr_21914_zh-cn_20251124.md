+++
title = "#21914 Update wesl requirement from 0.1.2 to 0.2.0"
date = "2025-11-24T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = false

[extra]
current_language = "zh-cn"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-11/pr-21914-en-20251124" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-11/pr-21914-zh-cn-20251124" }}
+++

# Title
Update wesl requirement from 0.1.2 to 0.2.0

## Basic Information
- **Title**: Update wesl requirement from 0.1.2 to 0.2.0
- **PR Link**: https://github.com/bevyengine/bevy/pull/21914
- **Author**: mnmaita
- **Status**: MERGED
- **Labels**: None
- **Created**: 2025-11-23T10:25:19Z
- **Merged**: 2025-11-24T08:36:46Z
- **Merged By**: mockersf

## Description Translation
# Objective

- 关闭 #20631

## Solution

- 修复了破坏性变更，以便能够升级到 `wesl` 0.2.0。

## Testing

- CI 检查。

## The Story of This Pull Request

这个PR的核心是一个依赖项升级任务。开发者需要将 `wesl` 依赖从 0.1.2 版本升级到 0.2.0 版本，以解决 issue #20631。依赖项升级在软件工程中是常见任务，但 minor 版本升级往往包含破坏性变更，需要相应的代码适配。

在分析代码变更时，可以看到这次升级主要涉及两个方面的修改。首先是版本号的直接更新，在 `Cargo.toml` 中将 `wesl` 的版本约束从 0.1.2 改为 0.2.0。这是依赖升级的标准操作。

更关键的是在 `shader_cache.rs` 文件中的API适配。`wesl` 0.2.0 版本对特性配置的API进行了重构。在旧版本中，特性配置是通过直接调用 `compiler_options.features.insert()` 方法来设置的：

```rust
// 旧代码
compiler_options.features.insert(key.clone(), *value);
```

而在新版本 0.2.0 中，特性配置被重新组织，现在需要通过 `features.flags` 字段来访问，并且值的类型也需要通过 `.into()` 进行转换：

```rust
// 新代码
compiler_options.features.flags.insert(key.clone(), (*value).into());
```

这个变更反映了 `wesl` 库在内部结构上的改进，将特性配置更加明确地分离到不同的类别中。`flags` 字段专门用于处理布尔类型的特性开关，而其他类型的特性配置可能有不同的存储位置。

值得注意的是，PR中特别处理了 `ShaderDefVal::Bool` 类型，而对于 `ShaderDefVal::Int` 和 `ShaderDefVal::UInt` 类型，代码保留了原有的调试日志输出，说明这些类型在WGSL中仍然不受支持。这种处理方式体现了向后兼容的考虑，确保现有功能不受影响。

从工程角度看，这次升级展示了处理依赖项破坏性变更的标准模式：首先更新版本号，然后根据新版本的API变化进行相应的代码适配。整个变更集非常精简，只涉及必要的修改，没有引入不必要的重构。

## Visual Representation

```mermaid
graph LR
    A[wesl 0.1.2] --> B[API Breaking Changes]
    B --> C[wesl 0.2.0]
    D[ShaderCache] --> E[Feature Configuration]
    E --> F[Old: features.insert()]
    E --> G[New: features.flags.insert()]
```

## Key Files Changed

### `crates/bevy_shader/Cargo.toml` (+1/-1)
**变更描述**: 更新 `wesl` 依赖版本号

```toml
# 变更前:
wesl = { version = "0.1.2", optional = true }

# 变更后:
wesl = { version = "0.2.0", optional = true }
```

### `crates/bevy_shader/src/shader_cache.rs` (+1/-1)
**变更描述**: 适配 `wesl` 0.2.0 的API破坏性变更

```rust
// 变更前:
compiler_options.features.insert(key.clone(), *value);

// 变更后:
compiler_options.features.flags.insert(key.clone(), (*value).into());
```

## Further Reading

- [Cargo SemVer Compatibility](https://doc.rust-lang.org/cargo/reference/semver.html) - Rust 包版本管理规范
- [WGSL Shader Language](https://gpuweb.github.io/gpuweb/wgsl/) - WebGPU Shading Language 规范
- [Rust Into Trait](https://doc.rust-lang.org/std/convert/trait.Into.html) - 类型转换trait文档

# Full Code Diff
```
diff --git a/crates/bevy_shader/Cargo.toml b/crates/bevy_shader/Cargo.toml
index 3ff64b04dd14f..9a14fc0184258 100644
--- a/crates/bevy_shader/Cargo.toml
+++ b/crates/bevy_shader/Cargo.toml
@@ -19,7 +19,7 @@ wgpu-types = { version = "26", default-features = false }
 naga = { version = "26", features = ["wgsl-in"] }
 serde = { version = "1", features = ["derive"] }
 thiserror = { version = "2", default-features = false }
-wesl = { version = "0.1.2", optional = true }
+wesl = { version = "0.2.0", optional = true }
 tracing = { version = "0.1", default-features = false, features = ["std"] }
 
 
diff --git a/crates/bevy_shader/src/shader_cache.rs b/crates/bevy_shader/src/shader_cache.rs
index c9f8c068bfb26..110573b46b795 100644
--- a/crates/bevy_shader/src/shader_cache.rs
+++ b/crates/bevy_shader/src/shader_cache.rs
@@ -221,7 +221,7 @@ impl<ShaderModule, RenderDevice> ShaderCache<ShaderModule, RenderDevice> {
                             for shader_def in shader_defs {
                                 match shader_def {
                                     ShaderDefVal::Bool(key, value) => {
-                                        compiler_options.features.insert(key.clone(), *value);
+                                        compiler_options.features.flags.insert(key.clone(), (*value).into());
                                     }
                                     _ => debug!(
                                         "ShaderDefVal::Int and ShaderDefVal::UInt are not supported in wesl",
```