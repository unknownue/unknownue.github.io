+++
title = "PR #18167"
date = "2025-03-06T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = false

[extra]
current_language = "zh-cn"
available_languages = {"zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-03/pr-18167-zh-cn-20250306-175358" }, "en" = { name = "English", url = "/pull_request/bevy/2025-03/pr-18167-en-20250306-175358" }}
+++

## 中文 (Chinese)

### 基本資訊
- **標題**: 回退「用環境貼圖光源替換環境光 (#17482)」
- **PR連結**: https://github.com/bevyengine/bevy/pull/18167
- **作者**: mockersf
- **狀態**: 已合併

### 描述翻譯
該PR回退了commit 0b5302d96a7ab6d2bff99c43232a1781a97d51c8，主要目的在於：
1. 修復 #18158 報告的問題
2. 重新審視 #17482 引入的渲染改動，因其合併過快導致部分問題未充分討論

### PR故事敘述
這個PR展現了遊戲引擎開發中常見的技術決策反轉。原始PR #17482嘗試用更先進的環境貼圖光(Environment Map Lights)完全取代傳統的環境光(Ambient Light)，但在實際應用中發現：

1. **相容性問題**：環境貼圖需要特定的GPU功能支援（如綁定陣列），導致在WebGL2/WebGPU等平台出現問題
2. **工作流破壞**：現有依賴環境光的場景需要全面修改，如：
```rust
// 原始環境光設置程式碼被移除
commands.insert_resource(AmbientLight {
    color: Color::WHITE,
    brightness: 1.0 / 5.0f32,
    ..default()
});
```
3. **渲染不一致**：部分材質系統（如lightmap）出現雙重光照計算的問題

開發團隊通過回退到已知穩定狀態，為後續更穩妥的改動創造了比較基準。關鍵技術點包括：

- 在WGSL著色器中恢復環境光計算邏輯：
```wgsl
// crates/bevy_pbr/src/render/pbr_ambient.wgsl
return (diffuse_ambient + specular_ambient * specular_occlusion) 
       * lights.ambient_color.rgb * occlusion;
```
- 重建AmbientLight元件系統：
```rust
// crates/bevy_pbr/src/light/ambient_light.rs
#[derive(Resource, Component, Clone, Debug, ExtractResource, ExtractComponent, Reflect)]
pub struct AmbientLight {
    pub affects_lightmapped_meshes: bool, // 新增控制項
}
```

### 關鍵文件變更
1. **crates/bevy_pbr/src/light_probe/environment_map.rs**
   - 移除82行環境貼圖實作
   - 保留基礎結構定義以備未來使用

2. **crates/bevy_pbr/src/light/mod.rs**
   ```rust
   // Before:
   // pub mod ambient_light; 被註解
   
   // After:
   pub mod ambient_light; // 重新啟用環境光模組
   ```

3. **examples/3d/auto_exposure.rs**
   ```rust
   // 恢復環境光設置
   commands.insert_resource(AmbientLight {
       brightness: light_consts::lux::DIRECT_SUNLIGHT,
       ..default()
   });
   ```

### 延伸閱讀
- [Bevy光照系統設計文件](https://bevyengine.org/learn/book/features/pbr/)
- [環境貼圖技術白皮書](https://www.khronos.org/opengl/wiki/GLSL_Shader)