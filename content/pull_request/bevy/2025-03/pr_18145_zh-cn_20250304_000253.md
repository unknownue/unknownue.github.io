+++
title = "PR #18145"
date = "2025-03-04T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = false

[extra]
current_language = "zh-cn"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-03/pr-18145-en-20250304-000253" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-03/pr-18145-zh-cn-20250304-000253" }}
+++

[Language: Français]

# Mise à jour de la dépendance ruzstd de 0.7.0 à 0.8.0

## Informations de base
- **Titre**: Update ruzstd requirement from 0.7.0 to 0.8.0
- **Lien PR**: https://github.com/bevyengine/bevy/pull/18145
- **Auteur**: mnmaita
- **Statut**: FUSIONNÉ
- **Créé le**: 2025-03-03T19:59:03Z
- **Fusionné le**: 2025-03-04T08:12:17Z
- **Fusionné par**: cart

## Traduction de la description
### Objectif
- Résout #18129

### Solution
- Mise à jour de la dépendance ruzstd de 0.7.0 à 0.8.0 et correction des imports.

## L'histoire de cette Pull Request

### Le problème et le contexte
Le traitement des textures KTX2 dans le moteur Bevy dépendait de ruzstd 0.7.0 pour la décompression Zstandard. Lorsque ruzstd a publié la version 0.8.0, cela a introduit des changements cassants dans la structure de son API, affectant le pipeline de chargement des textures de Bevy. Cela s'est manifesté par des erreurs de compilation (#18129) dues à des chemins de modules manquants, menaçant la capacité du moteur à traiter efficacement les textures GPU modernes.

### Le parcours du développeur
Le mainteneur mnmaita a fait face à un choix critique : figer la dépendance à une ancienne version ou s'adapter à la nouvelle structure d'API. Après avoir évalué le journal des modifications de ruzstd, il a reconnu que la mise à jour apportait des améliorations importantes de stabilité pour la décompression Zstandard - un composant crucial pour le traitement des textures de jeux nouvelle génération. La décision de mettre à jour plutôt que de contourner le problème démontre un engagement à maintenir les dépendances de Bevy à jour et sécurisées.

### L'implémentation
La solution a impliqué deux changements stratégiques. Premièrement, la mise à jour de la déclaration de dépendance dans Cargo.toml :

```toml
# Avant :
ruzstd = { version = "0.7.0", optional = true }

# Après :
ruzstd = { version = "0.8.0", optional = true }
```

Deuxièmement, l'ajustement du chemin d'import pour StreamingDecoder afin de correspondre à la nouvelle structure de modules de ruzstd :

```rust
// Avant :
use ruzstd::StreamingDecoder;

// Après :
use ruzstd::decoding::StreamingDecoder;
```

Ces changements ont permis de maintenir la logique de décompression existante tout en s'alignant sur la structure d'API améliorée de ruzstd.

### Insights techniques
La mise à jour a tiré parti de la nouvelle organisation modulaire de ruzstd qui sépare mieux les responsabilités dans le pipeline de décompression. Bien qu'apparemment simple, ce changement a assuré la compatibilité avec les futures fonctionnalités Zstandard et les correctifs de sécurité. L'implémentation KTX2 utilise la décompression en flux pour gérer efficacement les textures de grande taille :

```rust
let mut decoder = ruzstd::decoding::StreamingDecoder::new(&mut cursor)
    .map_err(|err| TextureError::SuperDecompressionError(err.to_string()))?;
```

Cette approche de streaming évite une utilisation excessive de la mémoire lors du traitement de textures haute résolution.

### L'impact
En mettant à jour vers ruzstd 0.8.0, Bevy a :
1. Résolu les erreurs de compilation immédiates
2. Gagné en performance de décompression Zstandard
3. Garanti la compatibilité avec les futures améliorations de ruzstd
4. Maintenu ses capacités de chargement transparent de textures KTX2

Ces changements illustrent l'importance d'une gestion proactive des dépendances dans les moteurs de jeu, où le traitement multimédia est critique pour la performance.

## Représentation visuelle

```
┌───────────────┐     ┌───────────────┐     ┌───────────────┐
│ Chargeur KTX2 │────>│ Décompresseur │────>│ Cache textures│
└───────────────┘     └───────────────┘     └───────────────┘
                          │
                          ▼
                    ┌───────────────┐
                    │ Upload GPU    │
                    └───────────────┘
```

## Fichiers clés modifiés

### `crates/bevy_image/Cargo.toml`
**Changement**: Mise à jour de la version de ruzstd de 0.7.0 à 0.8.0  
**Pourquoi**: Intégrer les dernières améliorations de décompression Zstandard  
```toml
# Avant :
ruzstd = { version = "0.7.0", optional = true }

# Après :
ruzstd = { version = "0.8.0", optional = true }
```

### `crates/bevy_image/src/ktx2.rs`
**Changement**: Ajustement du chemin d'import pour StreamingDecoder  
**Pourquoi**: ruzstd 0.8.0 a déplacé le décodeur dans une nouvelle structure modulaire  
```rust
// Avant :
use ruzstd::StreamingDecoder;

// Après :
use ruzstd::decoding::StreamingDecoder;
```

## Pour aller plus loin
- [Format de compression Zstandard](https://facebook.github.io/zstd/)
- [Spécification du format de texture KTX2](https://www.khronos.org/ktx/)
- [Journal des modifications de Ruzstd](https://github.com/KillingSpark/zstd-rs/blob/main/ruzstd/CHANGELOG.md)