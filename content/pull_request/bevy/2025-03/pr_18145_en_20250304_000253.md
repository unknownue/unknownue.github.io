+++
title = "PR #18145"
date = "2025-03-04T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = true

[taxonomies]
list_display = ["show"]

[extra]
current_language = "en"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-03/pr-18145-en-20250304-000253" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-03/pr-18145-zh-cn-20250304-000253" }}
+++

[Language: English]

# Update ruzstd requirement from 0.7.0 to 0.8.0

## Basic Information
- **Title**: Update ruzstd requirement from 0.7.0 to 0.8.0
- **PR Link**: https://github.com/bevyengine/bevy/pull/18145
- **Author**: mnmaita
- **Status**: MERGED
- **Created**: 2025-03-03T19:59:03Z
- **Merged**: 2025-03-04T08:12:17Z
- **Merged By**: cart

## Description Translation
### Objective
- Fixes #18129

### Solution
- Update ruzstd requirement from 0.7.0 to 0.8.0 and fixed imports.

## The Story of This Pull Request

### The Problem and Context
The Bevy engine's KTX2 texture handling relied on ruzstd 0.7.0 for Zstandard decompression. When ruzstd released version 0.8.0, it introduced breaking changes to its API structure that affected Bevy's texture loading pipeline. This manifested as compilation errors (#18129) due to missing module paths, threatening the engine's ability to process modern GPU textures efficiently.

### The Developer's Journey
Maintainer mnmaita faced a critical choice: either pin the dependency to an older version or adapt to the new API structure. After evaluating ruzstd's changelog, they recognized the update brought important stability improvements to Zstandard decompression - a crucial component for handling next-gen game textures. The decision to upgrade rather than work around it demonstrated a commitment to keeping Bevy's dependencies fresh and secure.

### The Implementation
The solution involved two strategic changes. First, updating the dependency declaration in Cargo.toml:

```toml
# Before:
ruzstd = { version = "0.7.0", optional = true }

# After:
ruzstd = { version = "0.8.0", optional = true }
```

Second, adjusting the import path in the KTX2 decoder to match ruzstd's reorganized modules:

```rust
// Before:
use ruzstd::StreamingDecoder;

// After:
use ruzstd::decoding::StreamingDecoder;
```

These changes maintained the existing decompression logic while aligning with ruzstd's improved API structure.

### Technical Insights
The update leveraged ruzstd's new module organization that better separates concerns in the decompression pipeline. While seemingly simple, this change ensured compatibility with future Zstandard features and security patches. The KTX2 implementation uses streaming decompression to handle large textures efficiently:

```rust
let mut decoder = ruzstd::decoding::StreamingDecoder::new(&mut cursor)
    .map_err(|err| TextureError::SuperDecompressionError(err.to_string()))?;
```

This streaming approach prevents excessive memory usage when processing high-resolution textures.

### The Impact
By updating to ruzstd 0.8.0, Bevy:
1. Resolved immediate compilation errors
2. Gained access to improved Zstandard decompression performance
3. Ensured compatibility with future ruzstd enhancements
4. Maintained seamless KTX2 texture loading capabilities

The changes exemplify the importance of proactive dependency management in game engines, where multimedia processing is performance-critical.

## Visual Representation

```
┌───────────────┐     ┌───────────────┐     ┌───────────────┐
│  KTX2 Loader  │────>│ Zstandard Dec │────>│ Texture Cache │
└───────────────┘     └───────────────┘     └───────────────┘
                          │
                          ▼
                    ┌───────────────┐
                    │ GPU Upload    │
                    └───────────────┘
```

## Key Files Changed

### `crates/bevy_image/Cargo.toml`
**What Changed**: Updated ruzstd version from 0.7.0 to 0.8.0  
**Why**: To incorporate latest Zstandard decompression improvements  
```toml
# Before:
ruzstd = { version = "0.7.0", optional = true }

# After:
ruzstd = { version = "0.8.0", optional = true }
```

### `crates/bevy_image/src/ktx2.rs`
**What Changed**: Adjusted import path for StreamingDecoder  
**Why**: ruzstd 0.8.0 moved the decoder to a new module structure  
```rust
// Before:
use ruzstd::StreamingDecoder;

// After:
use ruzstd::decoding::StreamingDecoder;
```

## Further Reading
- [Zstandard Compression Format](https://facebook.github.io/zstd/)
- [KTX2 Texture Format Specification](https://www.khronos.org/ktx/)
- [Ruzstd Changelog](https://github.com/KillingSpark/zstd-rs/blob/main/ruzstd/CHANGELOG.md)