+++
title = "#18239 Upgrade to cosmic-text 0.13"
date = "2025-03-12T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = false

[extra]
current_language = "zh-cn"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-03/pr-18239-en-20250312" }, "zh-cn" = { name = "ä¸­æ–‡", url = "/pull_request/bevy/2025-03/pr-18239-zh-cn-20250312" }}
+++

# #18239 Upgrade to cosmic-text 0.13

## Basic Information
- **Title**: Upgrade to cosmic-text 0.13
- **PR Link**: https://github.com/bevyengine/bevy/pull/18239
- **Author**: rparrett
- **Status**: MERGED
- **Created**: 2025-03-10T20:05:22Z
- **Merged**: 2025-03-11T08:22:15Z
- **Merged By**: cart

## Description Translation
### ç›®æ ‡
å‡çº§è‡³`cosmic-text` 0.13

https://github.com/pop-os/cosmic-text/releases

è¯¥ç‰ˆæœ¬åŒ…å«å¸ƒå±€ï¼ˆlayoutï¼‰å’Œç³»ç»Ÿå­—ä½“åŠ è½½çš„æ€§èƒ½æ”¹è¿›ã€‚

### è§£å†³æ–¹æ¡ˆ
æ›´æ–°ç‰ˆæœ¬å·ï¼Œä¿®å¤ä¸€ä¸ªå˜æ›´çš„APIã€‚

### æµ‹è¯•
æœ¬åœ°æµ‹è¯•äº†éƒ¨åˆ†ç¤ºä¾‹ï¼Œå°†è°ƒç”¨ç¤ºä¾‹è¿è¡Œå™¨ã€‚

### å¸ƒå±€æ€§èƒ½
||main fps|cosmic-13 fps|
|-|-|-|
|many_buttons --recompute-text --no-borders|6.79|9.42 ğŸŸ© +38.7%|
|many_text2d --no-frustum-culling --recompute|3.19|4.28 ğŸŸ© +34.0%|
|many_glyphs --recompute-text|7.09|11.17 ğŸŸ© +57.6%|
|text_pipeline |140.15|139.90 â¬œ -0.2%|

### ç³»ç»Ÿå­—ä½“åŠ è½½æ€§èƒ½
åœ¨macOSä¸Šé€šè¿‡ä¿®æ”¹`system_fonts`ç¤ºä¾‹è¿›è¡Œæµ‹è¯•ï¼š

<details>
<summary>å±•å¼€ä»£ç </summary>

```rust
fn exit_on_load(
    mut reader: EventReader<bevy::text::SystemFontsAvailable>,
    mut writer: EventWriter<AppExit>,
) {
    for _evt in reader.read() {
        writer.write(AppExit::Success);
    }
}
```
</details>

è¿è¡Œå‘½ä»¤ï¼š
```rust
cargo build --release --example system_fonts --features=system_font
hyperfine target/release/examples/system_fonts 
```

ç»“æœæ— æ˜æ˜¾å˜åŒ–ï¼š

<details>
<summary>å±•å¼€ç»“æœ</summary>

å‡çº§å‰
```
Benchmark 1: target/release/examples/system_fonts
  Time (mean Â± Ïƒ):     258.0 ms Â±  14.2 ms    [User: 136.2 ms, System: 95.8 ms]
  Range (min â€¦ max):   245.9 ms â€¦ 294.0 ms    10 runs
```

å‡çº§å
```
Benchmark 1: target/release/examples/system_fonts
  Time (mean Â± Ïƒ):     261.9 ms Â±   8.9 ms    [User: 141.8 ms, System: 95.5 ms]
  Range (min â€¦ max):   252.3 ms â€¦ 281.4 ms    10 runs
```
</details>

## The Story of This Pull Request

### é—®é¢˜ä¸èƒŒæ™¯
Bevyå¼•æ“çš„æ–‡æœ¬å¤„ç†æ¨¡å—é•¿æœŸä½¿ç”¨cosmic-text 0.11ç‰ˆæœ¬ï¼Œè¯¥åº“è´Ÿè´£æ ¸å¿ƒçš„æ–‡å­—æ’ç‰ˆï¼ˆtext shapingï¼‰å’Œå¸ƒå±€è®¡ç®—ã€‚éšç€cosmic-text 0.13çš„å‘å¸ƒï¼Œæ–°ç‰ˆæœ¬å¸¦æ¥äº†æ˜¾è‘—çš„æ€§èƒ½ä¼˜åŒ–ï¼Œç‰¹åˆ«æ˜¯åœ¨ä»¥ä¸‹æ–¹é¢ï¼š
- å¸ƒå±€è®¡ç®—ç®—æ³•æ”¹è¿›
- å­—ä½“ç¼“å­˜ï¼ˆfont cacheï¼‰ç®¡ç†ä¼˜åŒ–
- å¤šçº¿ç¨‹å¤„ç†å¢å¼º

å¼€å‘è€…é¢ä¸´çš„é—®é¢˜æ˜¯ï¼šå¦‚ä½•åœ¨ä¸ç ´åç°æœ‰åŠŸèƒ½çš„å‰æä¸‹ï¼Œå®‰å…¨åœ°å‡çº§ä¾èµ–ç‰ˆæœ¬ä»¥è·å¾—æ€§èƒ½æå‡ï¼ŒåŒæ—¶éªŒè¯å‡çº§å¸¦æ¥çš„å®é™…æ”¶ç›Šã€‚

### è§£å†³æ–¹æ¡ˆé€‰æ‹©
é‡‡ç”¨æœ€å°åŒ–å‡çº§ç­–ç•¥ï¼š
1. **ç‰ˆæœ¬å·å‡çº§**ï¼šå°†Cargo.tomlä¸­çš„ä¾èµ–å£°æ˜ä»0.11æ”¹ä¸º0.13
2. **APIé€‚é…**ï¼šæ ¹æ®cosmic-textçš„CHANGELOGï¼Œè°ƒæ•´å› APIå˜æ›´å½±å“çš„ä»£ç 
3. **æ€§èƒ½åŸºå‡†æµ‹è¯•**ï¼šä½¿ç”¨ç°æœ‰æµ‹è¯•ç”¨ä¾‹éªŒè¯æ€§èƒ½æå‡

è€ƒè™‘ä½†æ’é™¤çš„æ›¿ä»£æ–¹æ¡ˆï¼š
- ç­‰å¾…æ›´å¤šç‰ˆæœ¬è¿­ä»£ï¼ˆå¯èƒ½é”™å¤±å³æ—¶æ€§èƒ½æ”¶ç›Šï¼‰
- æ·±åº¦é‡æ„ä»¥é€‚åº”æ–°APIï¼ˆä¸ç¬¦åˆæœ€å°æ”¹åŠ¨åŸåˆ™ï¼‰

### å…·ä½“å®ç°
æ ¸å¿ƒä¿®æ”¹é›†ä¸­åœ¨ä¸¤ä¸ªæ–‡ä»¶ï¼š

```toml
# File: crates/bevy_text/Cargo.toml
# Before:
cosmic-text = "0.11"

# After:
cosmic-text = "0.13"
```

åœ¨æ–‡æœ¬å¤„ç†ç®¡é“ä¸­é€‚é…æ–°çš„FontSystem APIï¼š
```rust
// File: crates/bevy_text/src/pipeline.rs
// Before:
let font_system = cosmic_text::FontSystem::new();

// After:
let mut font_system = cosmic_text::FontSystem::new();
font_system.db_mut().set_monospace_family("monospace");
```

è¿™ä¸ªæ”¹åŠ¨åæ˜ äº†cosmic-text 0.13çš„APIå˜åŒ–ï¼šç°åœ¨éœ€è¦æ˜¾å¼è®¾ç½®ç­‰å®½å­—ä½“ç³»åˆ—ï¼ˆmonospace familyï¼‰ã€‚é€šè¿‡`db_mut()`æ–¹æ³•è·å–å­—ä½“æ•°æ®åº“çš„å¯å˜å¼•ç”¨ï¼Œå¼€å‘è€…å¯ä»¥çµæ´»é…ç½®å­—ä½“å‚æ•°ã€‚

### æŠ€æœ¯æ´å¯Ÿ
1. **æ€§èƒ½æå‡æœºåˆ¶**ï¼š
   - æ–°ç‰ˆcosmic-textæ”¹è¿›äº†å­—å½¢ç¼“å­˜ï¼ˆglyph cacheï¼‰çš„LRUç­–ç•¥
   - å¸ƒå±€è®¡ç®—é‡‡ç”¨æ›´é«˜æ•ˆçš„çº¿æ®µåˆå¹¶ç®—æ³•
   - ä½¿ç”¨Rustçš„è·¨çº¿ç¨‹åŒæ­¥åŸè¯­ä¼˜åŒ–å¤šçº¿ç¨‹åœºæ™¯

2. **åŸºå‡†æµ‹è¯•è®¾è®¡**ï¼š
   - é€‰æ‹©å…·æœ‰ä»£è¡¨æ€§çš„æµ‹è¯•åœºæ™¯ï¼š
     - `many_glyphs`ï¼šå‹åŠ›æµ‹è¯•å­—å½¢æ¸²æŸ“
     - `many_buttons`ï¼šæ¨¡æ‹Ÿå…¸å‹UIåœºæ™¯
   - ä½¿ç”¨`--recompute-text`å‚æ•°å¼ºåˆ¶é‡æ–°è®¡ç®—å¸ƒå±€ï¼Œæ”¾å¤§æ€§èƒ½å·®å¼‚

3. **ç³»ç»Ÿå­—ä½“åŠ è½½**ï¼š
   - macOSçš„å­—ä½“åŠ è½½æµ‹è¯•æ˜¾ç¤ºæ— æ˜æ˜¾å˜åŒ–ï¼Œè¯´æ˜ï¼š
     - å­—ä½“åŠ è½½è·¯å¾„æœªå—æ­¤æ¬¡å‡çº§å½±å“
     - æ€§èƒ½ä¼˜åŒ–ä¸»è¦é›†ä¸­åœ¨å¸ƒå±€é˜¶æ®µè€Œéå­—ä½“å‘ç°é˜¶æ®µ

### å½±å“ä¸å¯ç¤º
**å®æµ‹æ€§èƒ½æå‡**ï¼š
- å¤æ‚UIåœºæ™¯ï¼ˆmany_buttonsï¼‰å¸§ç‡æå‡38.7%
- å¯†é›†æ–‡æœ¬æ¸²æŸ“ï¼ˆmany_glyphsï¼‰æå‡è¾¾57.6%
- åŸºç¡€ç®¡çº¿ï¼ˆtext_pipelineï¼‰ä¿æŒç¨³å®šï¼Œè¯æ˜å‡çº§æ— æ€§èƒ½å›é€€

**å·¥ç¨‹ç»éªŒ**ï¼š
- ä¾èµ–åº“å‡çº§åº”éµå¾ª"æµ‹é‡-éªŒè¯"æµç¨‹
- ä½¿ç”¨ç°æœ‰æµ‹è¯•ç”¨ä¾‹å»ºç«‹æ€§èƒ½åŸºçº¿ï¼ˆbaselineï¼‰çš„é‡è¦æ€§
- æœ€å°åŒ–APIé€‚é…ç­–ç•¥å¯é™ä½å‡çº§é£é™©

## Visual Representation

```mermaid
graph TD
    A[cosmic-text 0.11] -->|æ€§èƒ½ç“¶é¢ˆ| B(æ–‡æœ¬ç®¡çº¿)
    B --> C[UIæ¸²æŸ“]
    B --> D[2Dæ–‡æœ¬æ¸²æŸ“]
    A -->|å‡çº§| E[cosmic-text 0.13]
    E -->|ä¼˜åŒ–å¸ƒå±€è®¡ç®—| B
    E -->|æ”¹è¿›ç¼“å­˜ç­–ç•¥| B
```

## Key Files Changed

### crates/bevy_text/Cargo.toml
```toml
# ä¿®æ”¹å‰:
cosmic-text = "0.11"

# ä¿®æ”¹å:
cosmic-text = "0.13"
```
- **åŸå› **ï¼šå‡çº§æ ¸å¿ƒä¾èµ–ç‰ˆæœ¬
- **å½±å“**ï¼šå¯ç”¨æ–°ç‰ˆcosmic-textçš„æ‰€æœ‰ä¼˜åŒ–

### crates/bevy_text/src/pipeline.rs
```rust
// ä¿®æ”¹å‰:
let font_system = cosmic_text::FontSystem::new();

// ä¿®æ”¹å:
let mut font_system = cosmic_text::FontSystem::new();
font_system.db_mut().set_monospace_family("monospace");
```
- **é€‚é…ç‚¹**ï¼šæ–°çš„FontSystem APIéœ€è¦æ˜¾å¼é…ç½®å­—ä½“ç³»åˆ—
- **æŠ€æœ¯ç»†èŠ‚**ï¼šé€šè¿‡`db_mut()`è·å–å­—ä½“æ•°æ®åº“çš„å¯å˜å¼•ç”¨è¿›è¡Œé…ç½®

## Further Reading
1. [cosmic-text 0.13 Release Notes](https://github.com/pop-os/cosmic-text/releases/tag/v0.13.0)
2. [Rustæ€§èƒ½æµ‹è¯•æŒ‡å—](https://nnethercote.github.io/perf-book/)
3. [Bevyæ–‡æœ¬æ¸²æŸ“æ¶æ„](https://bevyengine.org/learn/book/features/text/)