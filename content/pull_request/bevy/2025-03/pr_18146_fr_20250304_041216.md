+++
title = "PR #18146"
date = "2025-03-04T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = false

[extra]
current_language = "fr"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-03/pr-18146-en-20250304-041216" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-03/pr-18146-zh-cn-20250304-041216" }, "fr" = { name = "Français", url = "/pull_request/bevy/2025-03/pr-18146-fr-20250304-041216" }}
+++

## Français

### L'histoire de cette Pull Request

#### Le problème et son contexte
L'exemple distant de Bevy utilisait ureq 2.10.1 pour la communication HTTP, mais la dette technique s'accumulait avec les changements cassants des nouvelles versions d'ureq. La mise à jour est devenue cruciale pour bénéficier des améliorations de sécurité et de performance d'ureq 3.x. Le défi principal était de préserver la fonctionnalité BRP (Bevy Remote Protocol) dans l'exemple client-serveur pendant la migration.

#### Le parcours du développeur
Suite au problème #18131 soulignant la dépendance obsolète, les mainteneurs ont priorisé la mise à jour. L'analyse du guide de migration d'ureq a révélé des changements majeurs dans la gestion d'erreurs. Plusieurs options ont été envisagées :
1. Mise à jour simple avec corrections guidées par le compilateur
2. Utilisation d'un client HTTP alternatif (reqwest)
3. Création de wrappers personnalisés pour la gestion d'erreurs

La première approche a été retenue pour respecter la philosophie minimaliste de Bevy. La clé a été de comprendre le nouveau système de gestion d'erreurs via des Result explicites dans ureq 3.

#### Implémentation
Le changement principal se trouve dans `client.rs` où se fait la communication HTTP. Le code original utilisait la gestion d'erreurs implicite d'ureq 2 :

```rust
let res = ureq::post(&url)
    .send_json(req)?
    .body_mut()
    .read_json::<serde_json::Value>()?;
```

La version 3.x nécessite une gestion explicite via le type Response :

```rust
let response = ureq::post(&url)
    .send_json(req)
    .map_err(|e| anyhow::anyhow!("Échec de la requête : {}", e))?;

let res = response.into_json::<serde_json::Value>()?;
```

Ces modifications :
1. Séparent les erreurs réseau du parsing des réponses
2. Utilisent la conversion native d'erreurs d'ureq
3. Conservent le comportement externe via une meilleure propagation d'erreurs

#### Insights techniques
Cette migration démontre :
1. **Évolution de la gestion d'erreurs** : Le système explicite d'ureq 3 impose des modèles de propagation plus robustes
2. **Utilisation du système de types** : `into_json()` remplace la lecture manuelle avec des garanties de type plus fortes
3. **Impact minimal** : Malgré un changement majeur, seulement 3 lignes modifiées

#### Impact
Cette mise à jour :
- Améliore le diagnostic des erreurs réseau
- Réduit les risques de panics dans le code réseau
- Aligne Bevy avec les bonnes pratiques modernes de Rust
- Prépare le terrain pour des améliorations futures utilisant les fonctionnalités d'ureq 3

### Représentation visuelle

```
┌─────────────┐     ┌─────────────┐     ┌──────────────┐
│  Cargo.toml │───> │ ureq 3.0.8  │───> │ Client HTTP  │
└─────────────┘     └─────────────┘     └──────────────┘
                          │
                          ▼
                    ┌──────────────┐
                    │ Protocole BRP│
                    └──────────────┘
```

### Fichiers clés modifiés

1. **Cargo.toml**
```toml
# Avant :
ureq = { version = "2.10.1", features = ["json"] }

# Après :
ureq = { version = "3.0.8", features = ["json"] }
```

2. **examples/remote/client.rs**
```rust
// Avant :
let res = ureq::post(&url)
    .send_json(req)?
    .body_mut()
    .read_json::<serde_json::Value>()?;

// Après :
let response = ureq::post(&url)
    .send_json(req)
    .map_err(|e| anyhow::anyhow!("Échec de la requête : {}", e))?;

let res = response.into_json::<serde_json::Value>()?;
```

### Pour aller plus loin
- [Guide de migration ureq 2.x vers 3.x](https://github.com/algesten/ureq/blob/main/CHANGELOG.md)
- [Bonnes pratiques de gestion d'erreurs en Rust](https://doc.rust-lang.org/book/ch09-00-error-handling.html)
- [Architecture réseau de Bevy](https://bevyengine.org/learn/book/getting-started/resources/#networking)