+++
title = "PR #18146"
date = "2025-03-04T00:00:00"
draft = false
template = "pull_request_page.html"
in_search_index = true

[taxonomies]
list_display = ["show"]

[extra]
current_language = "en"
available_languages = {"en" = { name = "English", url = "/pull_request/bevy/2025-03/pr-18146-en-20250304-041216" }, "zh-cn" = { name = "中文", url = "/pull_request/bevy/2025-03/pr-18146-zh-cn-20250304-041216" }, "fr" = { name = "Français", url = "/pull_request/bevy/2025-03/pr-18146-fr-20250304-041216" }}
+++

## English

### The Story of This Pull Request

#### The Problem and Context
The Bevy engine's remote example relied on ureq 2.10.1 for HTTP communication, but technical debt accumulated as newer ureq versions introduced breaking changes. This became critical when security updates and performance improvements in ureq 3.x became essential for maintaining a modern networking stack. The immediate challenge was upgrading while preserving BRP (Bevy Remote Protocol) functionality in the client-server example.

#### The Developer's Journey
Maintainers recognized the urgency after issue #18131 highlighted the outdated dependency. The upgrade path required navigating ureq's migration guide, particularly changes to error handling and response processing. Several approaches were considered:
1. Straightforward version bump with compiler-driven fixes
2. Alternative HTTP clients (reqwest)
3. Custom error handling wrappers

The first approach prevailed due to ureq's lightweight nature aligning with Bevy's philosophy. The key insight came from understanding ureq 3's enhanced error handling through proper Result returns instead of panic-on-error behavior.

#### The Implementation
The crux of the solution lived in `client.rs` where HTTP communication occurs. Original code used ureq 2's implicit error handling:

```rust
let res = ureq::post(&url)
    .send_json(req)?
    .body_mut()
    .read_json::<serde_json::Value>()?;
```

The updated version 3.x required explicit error handling through the `Response` type:

```rust
let response = ureq::post(&url)
    .send_json(req)
    .map_err(|e| anyhow::anyhow!("Request failed: {}", e))?;

let res = response.into_json::<serde_json::Value>()?;
```

This change:
1. Separated network errors from response parsing
2. Used ureq's native error conversion
3. Maintained the same external behavior through improved error propagation

#### Technical Insights
The migration demonstrated:
1. **Error Handling Evolution**: ureq 3's explicit error handling forced more robust error propagation patterns
2. **Type System Leverage**: `into_json()` replaced manual body reading with stronger type guarantees
3. **Minimal Surface Impact**: Despite major version change, only 3 lines required modification

#### The Impact
This update:
- Improved network error diagnostics
- Reduced potential for panics in networking code
- Aligned Bevy with modern Rust error handling practices
- Paved the way for future networking improvements using ureq 3 features

### Visual Representation

```
┌─────────────┐     ┌─────────────┐     ┌──────────────┐
│  Cargo.toml │───> │ ureq 3.0.8  │───> │ HTTP Client  │
└─────────────┘     └─────────────┘     └──────────────┘
                          │
                          ▼
                    ┌──────────────┐
                    │ BRP Protocol │
                    └──────────────┘
```

### Key Files Changed

1. **Cargo.toml**
```toml
# Before:
ureq = { version = "2.10.1", features = ["json"] }

# After:
ureq = { version = "3.0.8", features = ["json"] }
```

2. **examples/remote/client.rs**
```rust
// Before:
let res = ureq::post(&url)
    .send_json(req)?
    .body_mut()
    .read_json::<serde_json::Value>()?;

// After:
let response = ureq::post(&url)
    .send_json(req)
    .map_err(|e| anyhow::anyhow!("Request failed: {}", e))?;

let res = response.into_json::<serde_json::Value>()?;
```

### Further Reading
- [ureq Migration Guide 2.x to 3.x](https://github.com/algesten/ureq/blob/main/CHANGELOG.md)
- [Rust Error Handling Best Practices](https://doc.rust-lang.org/book/ch09-00-error-handling.html)
- [Bevy Networking Architecture](https://bevyengine.org/learn/book/getting-started/resources/#networking)